<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp â€” Child Books</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    body { font-family: 'Comic Sans MS', cursive, sans-serif; background: linear-gradient(135deg,#fdf2f8,#e0f2fe); margin:0; padding:0; color:#1f2937; }
    .hero { background: linear-gradient(90deg,#f97316,#ec4899); color:white; padding:30px 20px; text-align:center; border-radius:0 0 20px 20px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .book-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:20px; padding:20px; }
    .book-card { background:white; border-radius:16px; padding:12px; box-shadow:0 6px 12px rgba(0,0,0,0.1); text-align:center; transition:transform 0.3s; }
    .book-card:hover { transform:scale(1.05); }
    .book-thumbnail { width:100%; height:160px; object-fit:cover; border-radius:12px; margin-bottom:12px; }
    .read-btn { background:#10b981; color:white; padding:8px 14px; border-radius:12px; transition:background 0.3s; }
    .read-btn:hover { background:#059669; }
    .loading, .no-books { text-align:center; margin:40px 0; font-size:18px; color:#6b7280; }
    .back-btn { position:fixed; top:20px; left:20px; background:#3b82f6; color:white; padding:10px 16px; border-radius:999px; text-decoration:none; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
    .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:2000; }
    .modal.hidden { display:none; }
    .modal-content { background:white; border-radius:12px; width:90%; max-width:1000px; height:90vh; display:flex; flex-direction:column; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #e5e7eb; }
    .close-btn { background:#ef4444; color:white; border:none; padding:6px 12px; border-radius:12px; cursor:pointer; }
    .modal-pdf-frame { flex:1; border:none; border-radius:0 0 12px 12px; }
  </style>
</head>
<body>
  <a href="parent.html" class="back-btn"><i class="fas fa-arrow-left mr-2"></i> Back</a>

  <div class="hero">
    <h1 class="text-3xl font-bold mb-2" id="heroTitle">My Books</h1>
    <p class="text-lg opacity-90" id="heroSubtitle">Enjoy reading your class books ðŸŽ‰</p>
  </div>

  <div id="booksGrid" class="book-grid"></div>
  <div id="loading" class="loading">Loading books...</div>
  <div id="noBooks" class="no-books hidden"><i class="fas fa-book-open text-4xl mb-4 block"></i>No books yet, check back later!</div>

  <!-- Modal -->
  <div id="pdfModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle" class="text-xl font-semibold"></h2>
        <button id="closeModal" class="close-btn"><i class="fas fa-times"></i></button>
      </div>
      <iframe id="modalPdfFrame" class="modal-pdf-frame"></iframe>
    </div>
  </div>

  <script>
    // âœ… Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    // âœ… Get child + class from URL
    const params = new URLSearchParams(window.location.search);
    const className = params.get("class"); // e.g. "Baby Class"
    const childName = params.get("child"); // e.g. "Mboni"

    if (childName) {
      document.getElementById("heroTitle").textContent = `${childName}'s Books`;
    }
    if (className) {
      document.getElementById("heroSubtitle").textContent = `Class: ${className}`;
    }

    const booksGrid = document.getElementById("booksGrid");
    const loading = document.getElementById("loading");
    const noBooks = document.getElementById("noBooks");

    // âœ… Fetch books for the given class
    function fetchBooks() {
      if (!className) {
        alert("Class not found. Please go back.");
        return;
      }
      loading.classList.remove("hidden");
      db.ref(`class_books/${className}`).on("value", snap => {
        loading.classList.add("hidden");
        booksGrid.innerHTML = "";
        const books = snap.val() || {};
        const entries = Object.entries(books);
        if (entries.length === 0) {
          noBooks.classList.remove("hidden");
          return;
        }
        noBooks.classList.add("hidden");

        entries.forEach(([id, b]) => {
          const thumb = b.url ? b.url.replace("/upload/", "/upload/fl_sanitize,pg_1,f_jpg/") : "https://via.placeholder.com/200x160.png?text=Book";
          const card = document.createElement("div");
          card.className = "book-card";
          card.innerHTML = `
            <img src="${thumb}" alt="${b.title}" class="book-thumbnail">
            <h3 class="text-lg font-semibold">${b.title || "Untitled Book"}</h3>
            <p class="text-sm text-gray-600">${b.subject || ""}</p>
            <button class="read-btn" data-url="${b.url}" data-title="${b.title}">Read</button>
          `;
          booksGrid.appendChild(card);
        });

        // open in modal
        document.querySelectorAll(".read-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const url = btn.getAttribute("data-url");
            const title = btn.getAttribute("data-title");
            document.getElementById("pdfModal").classList.remove("hidden");
            document.getElementById("modalTitle").textContent = title;
            document.getElementById("modalPdfFrame").src =
              `https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(url)}`;
          });
        });
      });
    }

    document.getElementById("closeModal").addEventListener("click", () => {
      document.getElementById("pdfModal").classList.add("hidden");
      document.getElementById("modalPdfFrame").src = "";
    });

    fetchBooks();
  </script>
</body>
</html>
