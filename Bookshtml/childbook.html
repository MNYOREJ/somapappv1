<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp â€” Kids Library</title>

  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase CDN SDKs (compat v9.6.10) - same as your classbook -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    /* Kid-friendly visuals */
    :root{
      --primary:#ff7ab6; /* pink */
      --accent:#6ee7b7;  /* mint */
      --sun:#ffd166;     /* yellow */
      --bg1: linear-gradient(135deg,#e0f7ff,#fff0f6);
    }
    html,body { height:100%; }
    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      background: var(--bg1);
      color: #0f172a;
    }

    /* floating playful shapes */
    .play-shape {
      position: absolute;
      border-radius: 999px;
      opacity: .95;
      filter: drop-shadow(0 8px 20px rgba(0,0,0,0.08));
      z-index: 0;
      transform: rotate(10deg);
    }
    .play-1 { width:160px; height:160px; background: radial-gradient(circle at 30% 30%, #ffd166, #ff7ab6); top: -40px; left: -30px; }
    .play-2 { width:120px; height:120px; background: radial-gradient(circle at 70% 30%, #6ee7b7, #2dd4bf); top: 20px; right: -40px; }
    .play-3 { width:80px; height:80px; background: radial-gradient(circle,#93c5fd,#7c3aed); bottom: -20px; left: 20%; }

    .hero {
      position: relative;
      padding: 34px 20px;
      border-radius: 0 0 28px 28px;
      z-index: 1;
      text-align: center;
      color: #04203a;
      box-shadow: 0 8px 24px rgba(2,6,23,0.06);
      background: linear-gradient(90deg,#fff7ed,#ecfeff);
    }

    .kid-name { font-size: 1.9rem; font-weight: 800; letter-spacing: -0.5px; }
    .kid-sub { font-size: 1.05rem; margin-top: 6px; color: #334155; opacity: .9; }

    .content { padding: 18px; margin-top: 18px; max-width: 1100px; margin-left:auto; margin-right:auto; z-index:2; position:relative; }
    .book-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap: 20px;
    }

    .book-card {
      background: linear-gradient(180deg, #ffffff, #fffbf7);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.06);
      text-align: center;
      transition: transform .18s ease, box-shadow .18s ease;
      min-height: 340px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:space-between;
    }
    .book-card:active, .book-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(15,23,42,0.12); cursor: pointer; }

    .book-thumbnail {
      width:100%;
      height:220px;
      object-fit:cover;
      border-radius: 12px;
      display:block;
      box-shadow: 0 6px 14px rgba(2,6,23,.06);
    }

    .book-title { font-weight:700; font-size:1.05rem; margin-top:10px; color:#0f172a; }
    .book-subject { font-size:.95rem; color:#475569; opacity:.9; margin-bottom:8px; }
    .button-row { display:flex; gap:10px; width:100%; margin-top:8px; }

    .read-btn, .listen-btn {
      flex:1;
      min-height:48px; /* big touch target */
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      font-size:0.98rem;
      border:none;
    }
    .read-btn { background: linear-gradient(90deg,#7c3aed,#06b6d4); color:white; }
    .listen-btn { background: linear-gradient(90deg,#ffd166,#ff7ab6); color:#04203a; }

    .search-wrap { max-width:720px; margin: 12px auto 0; display:flex; gap:10px; align-items:center; }
    .search-input {
      flex:1; padding:12px 14px; border-radius:12px; border:1px solid rgba(15,23,42,0.06);
      font-size:1rem; outline:none;
    }
    .no-books { text-align:center; padding:40px; color:#475569; font-weight:600; border-radius:12px; background:rgba(15,23,42,0.02); }

    /* Modal (reader) */
    .modal { position: fixed; inset:0; background: rgba(2,6,23,0.55); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal.hidden { display:none; }
    .modal-card { width:95%; max-width:1200px; height:90vh; background:white; border-radius:14px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 20px 60px rgba(2,6,23,0.5); }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #f1f5f9; }
    .modal-iframe { flex:1; border:none; width:100%; height:100%; }
    .control-btn { padding:8px 12px; border-radius:10px; font-weight:700; }

    /* spinner */
    .spinner { border:4px solid #f3f3f3; border-top: 4px solid #06b6d4; border-radius:50%; width:40px; height:40px; animation:spin 1.6s linear infinite; margin:0 auto; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* small responsive tweak */
    @media (max-width:640px){
      .book-thumbnail { height:160px; }
      .kid-name { font-size:1.6rem; }
    }
  </style>
</head>
<body>
  <!-- Playful shapes -->
  <div class="play-shape play-1" aria-hidden="true"></div>
  <div class="play-shape play-2" aria-hidden="true"></div>
  <div class="play-shape play-3" aria-hidden="true"></div>

  <!-- Top Hero -->
  <div class="hero">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; max-width:1100px; margin:0 auto;">
      <div style="text-align:left;">
        <div class="kid-name" id="kidName">Hello, Little Learner ðŸ‘‹</div>
        <div class="kid-sub" id="kidSub">Your books will appear here</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <a id="backBtn" href="../parent.html" class="px-4 py-2 rounded-full bg-white shadow-sm text-sm font-semibold hover:shadow-md" style="text-decoration:none;color:#0f172a;">
          <i class="fas fa-arrow-left mr-2"></i> Back
        </a>
        <button id="speakWelcome" class="px-4 py-2 rounded-full bg-gradient-to-r from-indigo-600 to-cyan-400 text-white font-bold">Say Hello</button>
      </div>
    </div>

    <!-- Search -->
    <div class="search-wrap" style="margin-top:14px;">
      <input id="searchInput" class="search-input" placeholder="Search books by title or subject (try: story, maths, animals)" aria-label="Search books">
      <select id="gradeFilter" class="search-input" style="max-width:180px;">
        <option value="">All classes</option>
        <option value="Baby">Baby</option>
        <option value="Kindergarten">Kindergarten</option>
        <option value="Class 1">Class 1</option>
        <option value="Class 2">Class 2</option>
        <option value="Class 3">Class 3</option>
      </select>
    </div>
  </div>

  <!-- Main content -->
  <div class="content" role="main">
    <div id="booksGrid" class="book-grid" aria-live="polite"></div>

    <div id="loading" class="mt-8 text-center">
      <div class="spinner"></div>
      <div style="margin-top:8px; color:#475569; font-weight:700;">Loading books for your child...</div>
    </div>

    <div id="noBooks" class="no-books hidden" role="status" aria-hidden="true">
      <i class="fas fa-book-open" style="font-size:40px;color:#06b6d4;"></i>
      <div style="margin-top:10px;">No books found for this class yet â€” check back soon!</div>
    </div>

    <div class="mt-6" id="notesArea" aria-hidden="true"></div>
  </div>

  <!-- Reader Modal -->
  <div id="readerModal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="Book reader">
      <div class="modal-header">
        <div style="display:flex; gap:12px; align-items:center;">
          <h3 id="modalTitle" style="font-weight:800; font-size:1.05rem;"></h3>
          <small id="modalInfo" style="color:#475569;"></small>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="zoomIn" class="control-btn bg-indigo-600 text-white rounded-md">Zoom +</button>
          <button id="zoomOut" class="control-btn bg-indigo-600 text-white rounded-md">Zoom -</button>
          <button id="closeReader" class="control-btn bg-red-500 text-white rounded-md"><i class="fas fa-times"></i> Close</button>
        </div>
      </div>

      <!-- Sandbox iframe to reduce toolbar/download options (not a full DRM) -->
      <iframe id="readerFrame" class="modal-iframe" src="" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>
  </div>

  <script>
    /**********************
     * Firebase config (copied from your working classbook)
     * If you later move to a production project, keep secrets on server side.
     **********************/
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM elements
    const kidNameEl = document.getElementById('kidName');
    const kidSubEl = document.getElementById('kidSub');
    const booksGrid = document.getElementById('booksGrid');
    const loadingEl = document.getElementById('loading');
    const noBooksEl = document.getElementById('noBooks');
    const searchInput = document.getElementById('searchInput');
    const gradeFilter = document.getElementById('gradeFilter');
    const readerModal = document.getElementById('readerModal');
    const readerFrame = document.getElementById('readerFrame');
    const modalTitle = document.getElementById('modalTitle');
    const modalInfo = document.getElementById('modalInfo');

    // Local state
    let allBooks = []; // array of [id, bookObj]
    let displayedBooks = [];
    let zoomLevel = 1;

    // Small utility to sanitize firebase keys from email
    function userKeyFromEmail(email){ return email.replace(/\./g,'_'); }

    // Auth and startup
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = '../login.html';
        return;
      }
      const uKey = userKeyFromEmail(user.email);
      try {
        const snap = await db.ref(`users/${uKey}`).once('value');
        const userData = snap.val() || {};

        // Determine selected child ID/class:
        // 1. URL param ?childId=...
        // 2. localStorage.selectedChildId
        // 3. userData.selectedChild (object) or userData.children (first child)
        // 4. fallback: userData.child (single)
        const urlParams = new URLSearchParams(window.location.search);
        const childIdParam = urlParams.get('childId');
        let selectedChild = null;

        if (childIdParam && userData.children && userData.children[childIdParam]) {
          selectedChild = Object.assign({ id: childIdParam }, userData.children[childIdParam]);
        } else if (localStorage.getItem('selectedChildId') && userData.children && userData.children[localStorage.getItem('selectedChildId')]) {
          const cid = localStorage.getItem('selectedChildId');
          selectedChild = Object.assign({ id: cid }, userData.children[cid]);
        } else if (userData.selectedChild && userData.selectedChild.class) {
          selectedChild = Object.assign({ id: 'selectedChild' }, userData.selectedChild);
        } else if (userData.children) {
          // pick first child object
          const firstKey = Object.keys(userData.children)[0];
          selectedChild = Object.assign({ id: firstKey }, userData.children[firstKey]);
        } else if (userData.child && userData.child.class) {
          selectedChild = Object.assign({ id: 'child', ...userData.child });
        } else {
          // No identifiable child: show message and stop
          kidNameEl.textContent = 'No child selected';
          kidSubEl.textContent = 'Please go to your Parent dashboard and choose a child.';
          loadingEl.classList.add('hidden');
          noBooksEl.classList.remove('hidden');
          return;
        }

        // Save selection in localStorage for quick navigation later
        if (selectedChild.id) localStorage.setItem('selectedChildId', selectedChild.id);

        // Show child info
        const childDisplayName = selectedChild.name || 'Your Child';
        const childClass = (selectedChild.class || selectedChild.grade || selectedChild.level || '').trim();

        kidNameEl.textContent = `${childDisplayName} ðŸ“š`;
        kidSubEl.textContent = childClass ? `${childClass} books â€” enjoy reading!` : 'No class found for this child.';

        // Fetch books for this child's class (same approach as classbook.html)
        if (!childClass) {
          loadingEl.classList.add('hidden');
          noBooksEl.classList.remove('hidden');
          return;
        }
        fetchBooksForClass(childClass);

      } catch (err) {
        console.error('User data read error:', err);
        alert('Error loading user data: ' + err.message);
      }
    });

    // FETCH BOOKS
    function fetchBooksForClass(className) {
      loadingEl.classList.remove('hidden');
      noBooksEl.classList.add('hidden');
      booksGrid.innerHTML = '';
      allBooks = [];

      const classPath = `class_books/${encodeURIComponent(className)}`;
      // Realtime listener to stay updated
      db.ref(classPath).on('value', snap => {
        loadingEl.classList.add('hidden');
        booksGrid.innerHTML = '';
        const booksObj = snap.val() || {};
        allBooks = Object.entries(booksObj);
        if (allBooks.length === 0) {
          noBooksEl.classList.remove('hidden');
          displayedBooks = [];
          return;
        }
        noBooksEl.classList.add('hidden');
        renderBooks(allBooks);
      }, err => {
        console.error('Firebase read error:', err);
        loadingEl.classList.add('hidden');
        noBooksEl.classList.remove('hidden');
        noBooksEl.textContent = 'Error loading books. Contact admin.';
      });

      // Search & filter handling
      searchInput.addEventListener('input', () => applySearchAndFilter());
      gradeFilter.addEventListener('change', () => applySearchAndFilter());
    }

    // Apply search and filter to allBooks and call renderBooks
    function applySearchAndFilter() {
      const q = searchInput.value.toLowerCase().trim();
      const grade = gradeFilter.value;
      const filtered = allBooks.filter(([id, b]) => {
        const title = (b.title || '').toLowerCase();
        const subject = (b.subject || '').toLowerCase();
        const matchesQ = q === '' || title.includes(q) || subject.includes(q);
        const matchesGrade = !grade || (b.forClass && b.forClass === grade) || (b.class && b.class === grade);
        return matchesQ && matchesGrade;
      });
      booksGrid.innerHTML = '';
      if (filtered.length === 0) {
        noBooksEl.classList.remove('hidden');
      } else {
        noBooksEl.classList.add('hidden');
        renderBooks(filtered);
      }
    }

    // Render function (creates big cards for kids)
    function renderBooks(bookEntries) {
      booksGrid.innerHTML = '';
      displayedBooks = bookEntries;

      bookEntries.forEach(([id, b]) => {
        // Cloudinary thumbnail transform pattern (safe conversion to JPEG first page preview)
        let thumbnailUrl = (b.url || '').replace('/upload/', '/upload/fl_sanitize,pg_1,f_jpg,w_640/');

        // Fallback thumbnail if missing
        if (!thumbnailUrl || thumbnailUrl.trim() === '') {
          thumbnailUrl = 'https://res.cloudinary.com/demo/image/upload/w_640,h_400,c_fill,q_auto:good/sample.jpg';
        }

        const card = document.createElement('div');
        card.className = 'book-card';
        card.innerHTML = `
          <img class="book-thumbnail" src="${thumbnailUrl}" alt="${escapeHtml(b.title || 'Book thumbnail')}" loading="lazy">
          <div style="width:100%; text-align:left; padding-top:8px;">
            <div class="book-title">${escapeHtml(b.title || 'Untitled')}</div>
            <div class="book-subject">${escapeHtml(b.subject || (b.category || 'Story'))}</div>
          </div>
          <div class="button-row" aria-hidden="false">
            <button class="read-btn" data-url="${encodeURIComponent(b.url || '')}" data-id="${id}" data-title="${escapeHtml(b.title || '')}" title="Open book">
              <i class="fas fa-book-open"></i> Read
            </button>
            <button class="listen-btn" data-title="${escapeHtml(b.title || '')}" title="Listen to the title">
              <i class="fas fa-volume-up"></i> Listen
            </button>
          </div>
        `;
        booksGrid.appendChild(card);
      });

      // attach events
      document.querySelectorAll('.read-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const rawUrl = decodeURIComponent(btn.getAttribute('data-url') || '');
          openReader(rawUrl, btn.getAttribute('data-title') || '');
        });
      });
      document.querySelectorAll('.listen-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const title = btn.getAttribute('data-title') || '';
          speakText(title ? `Title: ${title}` : 'Book');
        });
      });
    }

    // Reader modal open
    function openReader(pdfUrl, title='Book') {
      if (!pdfUrl) {
        alert('Book URL not available.');
        return;
      }
      modalTitle.textContent = title;
      modalInfo.textContent = 'Reader';
      // Use Google Docs viewer as proxy to embed PDF more reliably in browsers
      const proxy = `https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(pdfUrl)}`;
      // Set iframe src (iframe has sandbox to reduce some default browser toolbar options)
      readerFrame.src = proxy;
      readerModal.classList.remove('hidden');
      readerModal.setAttribute('aria-hidden','false');
      zoomLevel = 1;
      readerFrame.style.transform = `scale(${zoomLevel})`;
    }

    // Modal controls
    document.getElementById('closeReader').addEventListener('click', closeReader);
    document.getElementById('zoomIn').addEventListener('click', () => {
      zoomLevel += 0.2;
      readerFrame.style.transform = `scale(${zoomLevel})`;
    });
    document.getElementById('zoomOut').addEventListener('click', () => {
      if (zoomLevel > 0.6) { zoomLevel -= 0.2; readerFrame.style.transform = `scale(${zoomLevel})`; }
    });

    function closeReader() {
      readerModal.classList.add('hidden');
      readerModal.setAttribute('aria-hidden','true');
      readerFrame.src = '';
      zoomLevel = 1;
    }

    // Utility: text-to-speech for kids (listening helper)
    function speakText(text) {
      if (!('speechSynthesis' in window)) {
        alert('Speech is not supported in this browser.');
        return;
      }
      const msg = new SpeechSynthesisUtterance();
      msg.text = text;
      msg.lang = 'en-GB'; // you can change to en-US or local lang later
      msg.rate = 0.95;
      msg.pitch = 1.05;
      window.speechSynthesis.cancel(); // stop previous
      window.speechSynthesis.speak(msg);
    }

    // small welcome voice button
    document.getElementById('speakWelcome').addEventListener('click', () => {
      const text = kidNameEl.textContent + '. ' + kidSubEl.textContent + '. Tap any book to read.';
      speakText(text);
    });

    // disable printing and context menu to reduce casual downloading
    document.addEventListener('keydown', function(e){
      if (e.ctrlKey && (e.key === 'p' || e.key === 's')) {
        e.preventDefault();
        alert('Printing and saving are disabled to protect copyrighted books.');
      }
    });
    document.addEventListener('contextmenu', e => e.preventDefault());

    // small helper to escape HTML strings (safe insertion)
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Accessibility: close modal with ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (!readerModal.classList.contains('hidden')) closeReader();
      }
    });

    // small UX: if a parent page clicked a left-icon to open this page, they may pass childId in URL.
    // Example of how parent.html should link to childbook:
    // <a href="childbook.html?childId=CHILD_ID">Books</a>
    //
    // Or parent.js can set localStorage.setItem('selectedChildId', childId) before navigation.
    //
    // Security note (important):
    // - Cloudinary credentials (API secret) MUST NOT be placed in this client file.
    // - If you need to restrict access to PDF URLs, serve signed/temporary URLs from your server.
  </script>
</body>
</html>