<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp ‚Äî Magical Books Library</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Firebase CDN SDKs (compat v9.6.10) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    /* Dynamic styles - will be updated based on user type */
    body { 
      font-family: 'Inter', sans-serif; 
      margin: 0; 
      padding: 0; 
      transition: background 0.5s ease;
    }
    
    /* Parent/Child Mode - Bright, Fun, Energetic! */
    body.child-mode { 
      font-family: 'Comic Sans MS', 'Segoe UI', 'Inter', sans-serif;
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 25%, #FCD34D 50%, #FBBF24 75%, #F59E0B 100%);
      color: #78350F;
    }
    body.child-mode .hero { 
      background: linear-gradient(135deg, #EC4899 0%, #F43F5E 25%, #F97316 50%, #FB923C 75%, #FBBF24 100%);
      color: white;
      padding: 60px 20px;
      text-align: center;
      border-radius: 0 0 40px 40px;
      box-shadow: 0 10px 25px rgba(236, 72, 153, 0.3);
      animation: heroGlow 3s infinite alternate;
      position: relative;
      overflow: hidden;
    }
    body.child-mode .hero::before {
      content: "‚ú®";
      position: absolute;
      font-size: 3rem;
      top: 10px;
      left: 5%;
      animation: float 3s infinite ease-in-out;
    }
    body.child-mode .hero::after {
      content: "üåü";
      position: absolute;
      font-size: 3rem;
      top: 10px;
      right: 5%;
      animation: float 3s infinite ease-in-out 0.5s;
    }
    @keyframes heroGlow { 
      0% { box-shadow: 0 10px 25px rgba(236, 72, 153, 0.3); } 
      100% { box-shadow: 0 15px 35px rgba(251, 146, 60, 0.5); } 
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(10deg); }
    }
    body.child-mode .book-card { 
      background: linear-gradient(135deg, #FFFFFF 0%, #FEE2E2 50%, #FECACA 100%);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 20px rgba(251, 191, 36, 0.2);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 3px solid #FBBF24;
      position: relative;
    }
    body.child-mode .book-card::before {
      content: "üìö";
      position: absolute;
      top: -15px;
      right: -10px;
      font-size: 2rem;
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.2) rotate(15deg); }
    }
    body.child-mode .book-card:hover { 
      transform: translateY(-12px) scale(1.03);
      box-shadow: 0 20px 40px rgba(236, 72, 153, 0.4);
      border-color: #EC4899;
    }
    body.child-mode .book-thumbnail {
      border: 4px solid #FBBF24;
      border-radius: 16px;
      box-shadow: 0 6px 15px rgba(251, 146, 60, 0.3);
    }
    body.child-mode .read-btn {
      background: linear-gradient(135deg, #14B8A6 0%, #06B6D4 50%, #0EA5E9 100%);
      color: white;
      padding: 14px 28px;
      border-radius: 50px;
      font-weight: bold;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(20, 184, 166, 0.4);
    }
    body.child-mode .read-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 10px 25px rgba(14, 165, 233, 0.6);
    }
    body.child-mode .forecast {
      background: linear-gradient(135deg, #A5F3FC 0%, #67E8F9 50%, #22D3EE 100%);
      border-radius: 24px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(34, 211, 238, 0.3);
      border: 3px solid #06B6D4;
    }
    body.child-mode .back-btn {
      background: linear-gradient(135deg, #10B981 0%, #14B8A6 100%);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    body.child-mode .spinner {
      border: 6px solid #FEF3C7;
      border-top: 6px solid #EC4899;
    }
    body.child-mode .notification-item {
      background: linear-gradient(135deg, #FFFFFF 0%, #FEF3C7 100%);
      border: 2px solid #FBBF24;
      border-radius: 16px;
    }
    body.child-mode .modal-content {
      background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 50%, #FED7AA 100%);
      border: 4px solid #FB923C;
    }
    body.child-mode .modal-header {
      background: linear-gradient(135deg, #EC4899 0%, #F97316 100%);
      border-bottom: 3px solid #FBBF24;
    }
    body.child-mode .modal-controls {
      background: #FDE68A;
      border-bottom: 3px solid #FBBF24;
    }

    /* Teacher Mode - Professional & Clean */
    body.teacher-mode { 
      background: linear-gradient(135deg, #E0F2FE, #F0F9FF);
      color: #1F2937;
    }
    body.teacher-mode .hero { 
      background: linear-gradient(90deg, #4F46E5, #7C3AED);
      color: white;
      padding: 40px 20px;
      text-align: center;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    body.teacher-mode .book-card { 
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.05);
      transition: transform 0.3s;
    }
    body.teacher-mode .book-card:hover { 
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    body.teacher-mode .book-thumbnail {
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    body.teacher-mode .read-btn {
      background: #6366F1;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.2s;
      border: none;
      cursor: pointer;
    }
    body.teacher-mode .read-btn:hover {
      background: #4F46E5;
    }
    body.teacher-mode .forecast {
      background: #F9FAFB;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    body.teacher-mode .back-btn {
      background: #0EA5E9;
    }
    body.teacher-mode .spinner {
      border: 4px solid #F3F3F3;
      border-top: 4px solid #3498DB;
    }
    body.teacher-mode .notification-item {
      background: white;
      border-radius: 8px;
    }
    body.teacher-mode .modal-content {
      background: white;
    }
    body.teacher-mode .modal-header {
      background: #4F46E5;
      border-bottom: 1px solid #E5E7EB;
    }
    body.teacher-mode .modal-controls {
      background: #F3F4F6;
      border-bottom: 1px solid #E5E7EB;
    }

    /* Common Styles */
    .search-bar { max-width: 700px; margin: 25px auto; }
    .search-bar input {
      width: 100%;
      padding: 16px 24px;
      border-radius: 50px;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 1.05rem;
      outline: none;
      transition: all 0.3s ease;
    }
    .search-bar input:focus {
      background: rgba(255,255,255,0.3);
      border-color: white;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
    }
    .search-bar input::placeholder { color: rgba(255,255,255,0.8); }
    
    .book-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
      gap: 32px; 
      padding: 30px; 
    }
    .book-thumbnail { 
      width: 100%; 
      height: 220px; 
      object-fit: cover; 
      margin-bottom: 16px;
    }
    .book-thumbnail[alt]:not([alt=""]) { text-indent: -9999px; overflow: hidden; }
    
    .back-btn { 
      position: fixed; 
      top: 25px; 
      left: 25px; 
      color: white; 
      padding: 14px 28px; 
      border-radius: 50px; 
      z-index: 1000; 
      text-decoration: none; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .back-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    
    .content { padding: 25px 25px 25px 100px; }
    .no-books { 
      text-align: center; 
      font-size: 22px; 
      margin: 50px 0;
      padding: 40px;
    }
    .notification-item { 
      padding: 18px; 
      margin-bottom: 16px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .loading { 
      text-align: center; 
      font-size: 18px; 
      margin: 50px 0; 
    }
    .spinner { 
      border-radius: 50%; 
      width: 50px; 
      height: 50px; 
      animation: spin 1.2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    .modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.85); 
      z-index: 2000; 
      display: flex; 
      justify-content: center; 
      align-items: center;
      backdrop-filter: blur(5px);
    }
    .modal.hidden { display: none; }
    .modal-content { 
      border-radius: 20px; 
      width: 95%; 
      max-width: 1400px; 
      height: 95vh; 
      display: flex; 
      flex-direction: column; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    .modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 20px 30px;
      color: white;
    }
    .close-btn { 
      background: #EF4444; 
      color: white; 
      padding: 12px 20px; 
      border-radius: 50px; 
      border: none; 
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .close-btn:hover { 
      background: #DC2626;
      transform: scale(1.05);
    }
    .modal-controls { 
      padding: 16px 30px; 
      display: flex; 
      gap: 12px;
    }
    .modal-controls button {
      padding: 12px 24px;
      border-radius: 50px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .modal-controls button:hover {
      transform: scale(1.05);
    }
    .modal-pdf-frame { 
      flex: 1; 
      width: 100%; 
      border: none;
    }
    
    .hidden { display: none !important; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .book-grid { 
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        gap: 20px;
        padding: 20px;
      }
      .content { padding: 20px; }
      .back-btn { top: 15px; left: 15px; padding: 10px 20px; }
    }
  </style>
</head>
<body>
  <a href="#" id="backBtn" class="back-btn"><i class="fas fa-arrow-left mr-2"></i> <span id="backText">Back</span></a>
  <div class="content">
    <div class="hero">
      <h1 class="text-4xl font-bold mb-3" id="hero-title">Magical Books Library</h1>
      <p class="text-xl opacity-90 mb-5" id="hero-subtitle">Loading your amazing collection...</p>
      <div class="search-bar">
        <input id="searchInput" type="text" placeholder="Search for books by title or subject... üîç">
      </div>
    </div>
    <div class="max-w-7xl mx-auto px-4">
      <div id="booksGrid" class="book-grid"></div>
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p id="loadingText">Loading your books...</p>
      </div>
      <div id="noBooks" class="no-books hidden">
        <i class="fas fa-book-open text-5xl mb-5 block"></i>
        <span id="noBooksText">No books available yet. Check back soon!</span>
      </div>
    </div>
    <div class="forecast">
      <h2 class="text-2xl font-semibold mb-4" id="forecastTitle">Recent Updates & Notifications</h2>
      <div id="notificationsList"></div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();

    let userMode = 'child'; // 'child' or 'teacher'
    let className = '';
    let userKey = '';

    // Detect user type and initialize
    auth.onAuthStateChanged(async user => {
      if (user) {
        // Logged in - check if teacher
        userKey = user.email.replace(/\./g, '_');
        try {
          const snap = await db.ref(`users/${userKey}`).once('value');
          const data = snap.val();
          if (data && data.role === 'teacher' && data.class) {
            // TEACHER MODE
            userMode = 'teacher';
            className = data.class.trim();
            initializeTeacherMode();
            fetchBooks(className);
            fetchNotifications(userKey);
          } else {
            // Not a valid teacher, redirect
            alert('Invalid teacher access. Please contact admin.');
            window.location.href = '../index.html';
          }
        } catch (err) {
          console.error('User data error:', err);
          alert('Error: ' + err.message);
        }
      } else {
        // Not logged in - check for parent/child via localStorage
        const studentKey = localStorage.getItem('studentKey');
        if (!studentKey) {
          alert('Please sign in first.');
          window.location.href = '../index.html';
          return;
        }
        try {
          const snap = await db.ref(`students/${studentKey}`).once('value');
          const data = snap.val();
          if (!data || !data.classLevel) {
            alert('Invalid student access. Please sign in again.');
            localStorage.removeItem('studentKey');
            window.location.href = '../index.html';
            return;
          }
          // CHILD/PARENT MODE
          userMode = 'child';
          className = data.classLevel.trim();
          userKey = studentKey;
          initializeChildMode();
          fetchBooks(className);
          fetchNotifications(studentKey);
        } catch (err) {
          console.error('Student data error:', err);
          alert('Error: ' + err.message);
        }
      }
    });

    function initializeTeacherMode() {
      document.body.className = 'teacher-mode';
      document.getElementById('backBtn').href = '../staff.html';
      document.getElementById('backText').textContent = 'Back to Dashboard';
      document.getElementById('hero-title').textContent = `${className} Books`;
      document.getElementById('hero-subtitle').textContent = 'Explore and manage books for your class';
      document.getElementById('searchInput').placeholder = 'Search books by title or subject...';
      document.getElementById('loadingText').textContent = 'Loading your class books...';
      document.getElementById('noBooksText').textContent = 'No books available yet. Upload books to get started!';
      document.getElementById('forecastTitle').textContent = 'Upcoming Books & Notifications';
    }

    function initializeChildMode() {
      document.body.className = 'child-mode';
      document.getElementById('backBtn').href = '../parent.html';
      document.getElementById('backText').textContent = 'Back to My Dashboard';
      document.getElementById('hero-title').textContent = `${className} Magical Books! üéâ`;
      document.getElementById('hero-subtitle').textContent = 'Discover fun stories and learn amazing things just for your class!';
      document.getElementById('searchInput').placeholder = 'Search for magical books by title or subject... ‚ú®';
      document.getElementById('loadingText').innerHTML = 'Loading your magical books... üßô‚Äç‚ôÇÔ∏è‚ú®';
      document.getElementById('noBooksText').innerHTML = 'Oops! No books here yet.<br>Ask your teacher for more adventures! üöÄüìö';
      document.getElementById('forecastTitle').textContent = 'Upcoming Adventures & Messages üì¨';
    }

    function fetchBooks(className) {
      const booksGrid = document.getElementById('booksGrid');
      const noBooks = document.getElementById('noBooks');
      const loading = document.getElementById('loading');
      const searchInput = document.getElementById('searchInput');
      let allBooks = [];

      loading.classList.remove('hidden');
      const classPath = `class_books/${encodeURIComponent(className)}`;
      console.log('Fetching books from path:', classPath);
      
      db.ref(classPath).on('value', snap => {
        loading.classList.add('hidden');
        booksGrid.innerHTML = '';
        const books = snap.val() || {};
        console.log('Books data:', books);
        allBooks = Object.entries(books);
        
        if (allBooks.length === 0) {
          noBooks.classList.remove('hidden');
          return;
        }
        
        noBooks.classList.add('hidden');
        renderBooks(allBooks);
      }, err => {
        loading.classList.add('hidden');
        console.error('Firebase error:', err);
        alert('Firebase Error: ' + err.message + '\nPath: ' + classPath);
      });

      // Search functionality
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase().trim();
        const filtered = allBooks.filter(([id, b]) => 
          b.title.toLowerCase().includes(query) || b.subject.toLowerCase().includes(query)
        );
        booksGrid.innerHTML = '';
        if (filtered.length === 0) {
          noBooks.classList.remove('hidden');
        } else {
          noBooks.classList.add('hidden');
          renderBooks(filtered);
        }
      });
    }

    function renderBooks(bookEntries) {
      const booksGrid = document.getElementById('booksGrid');
      booksGrid.innerHTML = '';
      
      bookEntries.forEach(([id, b]) => {
        const thumbnailUrl = b.url.replace('/upload/', '/upload/fl_sanitize,pg_1,f_jpg/');
        const card = document.createElement('div');
        card.className = 'book-card';
        
        const buttonText = userMode === 'child' ? 'Open Adventure! üöÄ' : 'Read Book';
        const titleEmoji = userMode === 'child' ? ' üìñ' : '';
        
        card.innerHTML = `
          <img src="${thumbnailUrl}" alt="${b.title} thumbnail" class="book-thumbnail" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIyMCIgZmlsbD0iI0VFRSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Cb29rIENvdmVyPC90ZXh0Pjwvc3ZnPg=='">
          <h3 class="text-xl font-bold mt-3">${b.title}${titleEmoji}</h3>
          <p class="text-md mb-4 opacity-80">${b.subject}</p>
          <button class="read-btn" data-url="${b.url}" data-id="${id}" data-title="${b.title}">${buttonText}</button>
        `;
        booksGrid.appendChild(card);
      });

      // Add event listeners for read buttons
      document.querySelectorAll('.read-btn').forEach(button => {
        button.addEventListener('click', () => {
          const pdfUrl = button.getAttribute('data-url');
          const bookTitle = button.getAttribute('data-title');
          const proxyUrl = `https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(pdfUrl)}`;
          const modal = document.getElementById('pdfModal');
          const modalTitle = document.getElementById('modalTitle');
          const modalPdfFrame = document.getElementById('modalPdfFrame');

          modal.classList.remove('hidden');
          modalTitle.textContent = bookTitle;
          modalPdfFrame.src = proxyUrl;
        });
      });
    }

    // Modal controls
    let zoomLevel = 1;
    document.getElementById('zoomInModal').addEventListener('click', () => {
      zoomLevel += 0.2;
      document.getElementById('modalPdfFrame').style.transform = `scale(${zoomLevel})`;
    });
    document.getElementById('zoomOutModal').addEventListener('click', () => {
      if (zoomLevel > 0.5) {
        zoomLevel -= 0.2;
        document.getElementById('modalPdfFrame').style.transform = `scale(${zoomLevel})`;
      }
    });
    document.getElementById('closeModal').addEventListener('click', () => {
      const modal = document.getElementById('pdfModal');
      const modalPdfFrame = document.getElementById('modalPdfFrame');
      modal.classList.add('hidden');
      modalPdfFrame.src = '';
      zoomLevel = 1;
      modalPdfFrame.style.transform = 'scale(1)';
    });

    // Copyright protection
    document.addEventListener('keydown', e => {
      if (e.ctrlKey && (e.key === 'p' || e.key === 's')) {
        e.preventDefault();
        alert('Printing and saving disabled for copyright protection.');
      }
    });
    window.print = () => {
      alert('Printing disabled for copyright protection.');
    };
    document.addEventListener('contextmenu', e => e.preventDefault());

    function fetchNotifications(userKey) {
      const notificationsList = document.getElementById('notificationsList');
      db.ref(`notifications/${userKey}`).orderByChild('time').limitToLast(5).on('value', snap => {
        notificationsList.innerHTML = '';
        const notifs = snap.val() || {};
        
        if (Object.keys(notifs).length === 0) {
          const emptyMsg = userMode === 'child' 
            ? 'No new adventures yet. Check back for exciting updates! üéà‚ú®'
            : 'No recent notifications. Stay tuned for new books!';
          notificationsList.innerHTML = `<p class="opacity-70">${emptyMsg}</p>`;
          return;
        }
        
        Object.entries(notifs).reverse().forEach(([id, n]) => {
          if (n.type === 'new-book') {
            const notif = document.createElement('div');
            notif.className = 'notification-item';
            const label = userMode === 'child' ? 'New Adventure' : 'New Book';
            const emoji = userMode === 'child' ? ' üè∞‚ú®' : '';
            notif.innerHTML = `
              <p class="font-semibold"><strong>${label}:</strong> ${n.title}${emoji}</p>
              <p class="text-sm opacity-70 mt-1">${n.subject} for ${n.class}</p>
              <p class="text-xs opacity-60 mt-2">Added on ${new Date(n.time).toLocaleDateString()}</p>
            `;
            notificationsList.appendChild(notif);
          }
        });
      }, err => {
        console.error('Notifications error:', err);
        notificationsList.innerHTML = '<p class="opacity-70">Error loading notifications.</p>';
      });
    }
  </script>

  <!-- Modal for full-screen PDF -->
  <div id="pdfModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle" class="text-2xl font-bold"></h2>
        <button id="closeModal" class="close-btn"><i class="fas fa-times mr-2"></i> Close</button>
      </div>
      <div class="modal-controls">
        <button id="zoomInModal" style="background: #14B8A6; color: white;">
          <i class="fas fa-search-plus mr-2"></i> Zoom In
        </button>
        <button id="zoomOutModal" style="background: #06B6D4; color: white;">
          <i class="fas fa-search-minus mr-2"></i> Zoom Out
        </button>
      </div>
      <iframe id="modalPdfFrame" class="modal-pdf-frame" src="" frameborder="0"></iframe>
    </div>
  </div>
</body>
</html>
