<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Magical Books Library</title>
  
  <!-- Performance Optimization: Preconnect to external domains -->
  <link rel="preconnect" href="https://docs.google.com">
  <link rel="dns-prefetch" href="https://docs.google.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- PDF.js Library for secure PDF viewing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Firebase CDN SDKs (compat v9.6.10) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    /* Anti-Screenshot & Anti-Print Protection */
    @media print {
      body { display: none !important; }
      * { display: none !important; }
    }
    
    /* Prevent text selection and copying */
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    
    /* Protection Watermark Overlay */
    .protection-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 100px,
        rgba(0, 0, 0, 0.02) 100px,
        rgba(0, 0, 0, 0.02) 200px
      );
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .protection-overlay.active {
      opacity: 1;
    }
    
    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: 4rem;
      color: rgba(0, 0, 0, 0.05);
      font-weight: bold;
      pointer-events: none;
      z-index: 9998;
      white-space: nowrap;
    }
    
    /* Dynamic styles - will be updated based on user type */
    body { 
      font-family: 'Inter', sans-serif; 
      margin: 0; 
      padding: 0; 
      transition: background 0.5s ease;
    }
    
    /* Parent/Child Mode - Bright, Fun, Energetic! */
    body.child-mode { 
      font-family: 'Comic Sans MS', 'Segoe UI', 'Inter', sans-serif;
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 25%, #FCD34D 50%, #FBBF24 75%, #F59E0B 100%);
      color: #78350F;
    }
    body.child-mode .hero { 
      background: linear-gradient(135deg, #EC4899 0%, #F43F5E 25%, #F97316 50%, #FB923C 75%, #FBBF24 100%);
      color: white;
      padding: 60px 20px;
      text-align: center;
      border-radius: 0 0 40px 40px;
      box-shadow: 0 10px 25px rgba(236, 72, 153, 0.3);
      animation: heroGlow 3s infinite alternate;
      position: relative;
      overflow: hidden;
    }
    body.child-mode .hero::before {
      content: "✨";
      position: absolute;
      font-size: 3rem;
      top: 10px;
      left: 5%;
      animation: float 3s infinite ease-in-out;
    }
    body.child-mode .hero::after {
      content: "🌟";
      position: absolute;
      font-size: 3rem;
      top: 10px;
      right: 5%;
      animation: float 3s infinite ease-in-out 0.5s;
    }
    @keyframes heroGlow { 
      0% { box-shadow: 0 10px 25px rgba(236, 72, 153, 0.3); } 
      100% { box-shadow: 0 15px 35px rgba(251, 146, 60, 0.5); } 
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(10deg); }
    }
    body.child-mode .book-card { 
      background: linear-gradient(135deg, #FFFFFF 0%, #FEE2E2 50%, #FECACA 100%);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 20px rgba(251, 191, 36, 0.2);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 3px solid #FBBF24;
      position: relative;
    }
    body.child-mode .book-card::before {
      content: "📚";
      position: absolute;
      top: -15px;
      right: -10px;
      font-size: 2rem;
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.2) rotate(15deg); }
    }
    body.child-mode .book-card:hover { 
      transform: translateY(-12px) scale(1.03);
      box-shadow: 0 20px 40px rgba(236, 72, 153, 0.4);
      border-color: #EC4899;
    }
    body.child-mode .book-thumbnail {
      border: 4px solid #FBBF24;
      border-radius: 16px;
      box-shadow: 0 6px 15px rgba(251, 146, 60, 0.3);
    }
    body.child-mode .read-btn {
      background: linear-gradient(135deg, #14B8A6 0%, #06B6D4 50%, #0EA5E9 100%);
      color: white;
      padding: 14px 28px;
      border-radius: 50px;
      font-weight: bold;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(20, 184, 166, 0.4);
    }
    body.child-mode .read-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 10px 25px rgba(14, 165, 233, 0.6);
    }
    body.child-mode .forecast {
      background: linear-gradient(135deg, #A5F3FC 0%, #67E8F9 50%, #22D3EE 100%);
      border-radius: 24px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(34, 211, 238, 0.3);
      border: 3px solid #06B6D4;
    }
    body.child-mode .back-btn {
      background: linear-gradient(135deg, #10B981 0%, #14B8A6 100%);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    body.child-mode .spinner {
      border: 6px solid #FEF3C7;
      border-top: 6px solid #EC4899;
    }
    body.child-mode .notification-item {
      background: linear-gradient(135deg, #FFFFFF 0%, #FEF3C7 100%);
      border: 2px solid #FBBF24;
      border-radius: 16px;
    }
    body.child-mode .modal-content {
      background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 50%, #FED7AA 100%);
      border: 4px solid #FB923C;
    }
    body.child-mode .modal-header {
      background: linear-gradient(135deg, #EC4899 0%, #F97316 100%);
      border-bottom: 3px solid #FBBF24;
    }
    body.child-mode .modal-controls {
      background: #FDE68A;
      border-bottom: 3px solid #FBBF24;
    }

    /* Teacher Mode - Professional & Clean */
    body.teacher-mode { 
      background: linear-gradient(135deg, #E0F2FE, #F0F9FF);
      color: #1F2937;
    }
    body.teacher-mode .hero { 
      background: linear-gradient(90deg, #4F46E5, #7C3AED);
      color: white;
      padding: 40px 20px;
      text-align: center;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    body.teacher-mode .book-card { 
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.05);
      transition: transform 0.3s;
    }
    body.teacher-mode .book-card:hover { 
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    body.teacher-mode .book-thumbnail {
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    body.teacher-mode .read-btn {
      background: #6366F1;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.2s;
      border: none;
      cursor: pointer;
    }
    body.teacher-mode .read-btn:hover {
      background: #4F46E5;
    }
    body.teacher-mode .forecast {
      background: #F9FAFB;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    body.teacher-mode .back-btn {
      background: #0EA5E9;
    }
    body.teacher-mode .spinner {
      border: 4px solid #F3F3F3;
      border-top: 4px solid #3498DB;
    }
    body.teacher-mode .notification-item {
      background: white;
      border-radius: 8px;
    }
    body.teacher-mode .modal-content {
      background: white;
    }
    body.teacher-mode .modal-header {
      background: #4F46E5;
      border-bottom: 1px solid #E5E7EB;
    }
    body.teacher-mode .modal-controls {
      background: #F3F4F6;
      border-bottom: 1px solid #E5E7EB;
    }

    /* Common Styles */
    .search-bar { max-width: 700px; margin: 25px auto; }
    .search-bar input {
      width: 100%;
      padding: 16px 24px;
      border-radius: 50px;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 1.05rem;
      outline: none;
      transition: all 0.3s ease;
    }
    .search-bar input:focus {
      background: rgba(255,255,255,0.3);
      border-color: white;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
    }
    .search-bar input::placeholder { color: rgba(255,255,255,0.8); }
    
    .book-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
      gap: 32px; 
      padding: 30px; 
    }
    .book-thumbnail { 
      width: 100%; 
      height: 220px; 
      object-fit: cover; 
      margin-bottom: 16px;
    }
    .book-thumbnail[alt]:not([alt=""]) { text-indent: -9999px; overflow: hidden; }
    
    .back-btn { 
      position: fixed; 
      top: 25px; 
      left: 25px; 
      color: white; 
      padding: 14px 28px; 
      border-radius: 50px; 
      z-index: 1000; 
      text-decoration: none; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .back-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    
    .content { padding: 25px 25px 25px 100px; }
    .no-books { 
      text-align: center; 
      font-size: 22px; 
      margin: 50px 0;
      padding: 40px;
    }
    .notification-item { 
      padding: 18px; 
      margin-bottom: 16px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .loading { 
      text-align: center; 
      font-size: 18px; 
      margin: 50px 0; 
    }
    .spinner { 
      border-radius: 50%; 
      width: 50px; 
      height: 50px; 
      animation: spin 1.2s linear infinite; 
      margin: 0 auto 20px; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    .modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.85); 
      z-index: 2000; 
      display: flex; 
      justify-content: center; 
      align-items: center;
      backdrop-filter: blur(5px);
    }
    .modal.hidden { display: none; }
    .modal-content { 
      border-radius: 20px; 
      width: 95%; 
      max-width: 1400px; 
      height: 95vh; 
      display: flex; 
      flex-direction: column; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    .modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 20px 30px;
      color: white;
    }
    .close-btn { 
      background: #EF4444; 
      color: white; 
      padding: 12px 20px; 
      border-radius: 50px; 
      border: none; 
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .close-btn:hover { 
      background: #DC2626;
      transform: scale(1.05);
    }
    .modal-controls { 
      padding: 16px 30px; 
      display: flex; 
      gap: 12px;
    }
    .modal-controls button {
      padding: 12px 24px;
      border-radius: 50px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .modal-controls button:hover {
      transform: scale(1.05);
    }
    .modal-pdf-container {
      flex: 1;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: #2d2d2d;
      position: relative;
    }
    .modal-pdf-canvas-wrapper {
      width: 100%;
      height: 100%;
      overflow: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .modal-pdf-canvas {
      display: block;
      margin: 10px auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    
    .hidden { display: none !important; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .book-grid { 
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        gap: 20px;
        padding: 20px;
      }
      .content { padding: 20px; }
      .back-btn { top: 15px; left: 15px; padding: 10px 20px; }
    }
  </style>
</head>
<body>
  <!-- Protection Overlays -->
  <div class="protection-overlay" id="protectionOverlay"></div>
  <div class="watermark" id="watermark">SOMAP PROTECTED CONTENT</div>
  
  <a href="#" id="backBtn" class="back-btn"><i class="fas fa-arrow-left mr-2"></i> <span id="backText">Back</span></a>
  <div class="content">
    <div class="hero">
      <h1 class="text-4xl font-bold mb-3" id="hero-title">Magical Books Library</h1>
      <p class="text-xl opacity-90 mb-5" id="hero-subtitle">Loading your amazing collection...</p>
      <div class="search-bar">
        <input id="searchInput" type="text" placeholder="Search for books by title or subject... 🔍">
      </div>
    </div>
    <div class="max-w-7xl mx-auto px-4">
      <div id="booksGrid" class="book-grid"></div>
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p id="loadingText">Loading your books...</p>
      </div>
      <div id="noBooks" class="no-books hidden">
        <i class="fas fa-book-open text-5xl mb-5 block"></i>
        <span id="noBooksText">No books available yet. Check back soon!</span>
      </div>
    </div>
    <div class="forecast">
      <h2 class="text-2xl font-semibold mb-4" id="forecastTitle">Recent Updates & Notifications</h2>
      <div id="notificationsList"></div>
    </div>
  </div>

  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();

    let userMode = 'child'; // 'child' or 'teacher'
    let className = '';
    let userKey = '';

    // Detect user type and initialize
    auth.onAuthStateChanged(async user => {
      if (user) {
        // Logged in - check if teacher
        userKey = user.email.replace(/\./g, '_');
        try {
          const snap = await db.ref(`users/${userKey}`).once('value');
          const data = snap.val();
          if (data && data.role === 'teacher' && data.class) {
            // TEACHER MODE
            userMode = 'teacher';
            className = data.class.trim();
            initializeTeacherMode();
            fetchBooks(className);
            fetchNotifications(userKey);
          } else {
            // Not a valid teacher, redirect
            alert('Invalid teacher access. Please contact admin.');
            window.location.href = '../index.html';
          }
        } catch (err) {
          console.error('User data error:', err);
          alert('Error: ' + err.message);
        }
      } else {
        // Not logged in - check for parent/child via localStorage
        const studentKey = localStorage.getItem('studentKey');
        if (!studentKey) {
          alert('Please sign in first.');
          window.location.href = '../index.html';
          return;
        }
        try {
          const snap = await db.ref(`students/${studentKey}`).once('value');
          const data = snap.val();
          if (!data || !data.classLevel) {
            alert('Invalid student access. Please sign in again.');
            localStorage.removeItem('studentKey');
            window.location.href = '../index.html';
            return;
          }
          // CHILD/PARENT MODE
          userMode = 'child';
          className = data.classLevel.trim();
          userKey = studentKey;
          initializeChildMode();
          fetchBooks(className);
          fetchNotifications(studentKey);
        } catch (err) {
          console.error('Student data error:', err);
          alert('Error: ' + err.message);
        }
      }
    });

    function initializeTeacherMode() {
      document.body.className = 'teacher-mode';
      document.getElementById('backBtn').href = '../staff.html';
      document.getElementById('backText').textContent = 'Back to Dashboard';
      document.getElementById('hero-title').textContent = `${className} Books`;
      document.getElementById('hero-subtitle').textContent = 'Explore and manage books for your class';
      document.getElementById('searchInput').placeholder = 'Search books by title or subject...';
      document.getElementById('loadingText').textContent = 'Loading your class books...';
      document.getElementById('noBooksText').textContent = 'No books available yet. Upload books to get started!';
      document.getElementById('forecastTitle').textContent = 'Upcoming Books & Notifications';
    }

    function initializeChildMode() {
      document.body.className = 'child-mode';
      document.getElementById('backBtn').href = '../parent.html';
      document.getElementById('backText').textContent = 'Back to My Dashboard';
      document.getElementById('hero-title').textContent = `${className} Magical Books! 🎉`;
      document.getElementById('hero-subtitle').textContent = 'Discover fun stories and learn amazing things just for your class!';
      document.getElementById('searchInput').placeholder = 'Search for magical books by title or subject... ✨';
      document.getElementById('loadingText').innerHTML = 'Loading your magical books... 🧙‍♂️✨';
      document.getElementById('noBooksText').innerHTML = 'Oops! No books here yet.<br>Ask your teacher for more adventures! 🚀📚';
      document.getElementById('forecastTitle').textContent = 'Upcoming Adventures & Messages 📬';
    }

    // ========== OPTIMIZED FIREBASE LOADING ==========
    const booksCache = new Map();
    let searchDebounceTimer;
    
    function fetchBooks(className) {
      const booksGrid = document.getElementById('booksGrid');
      const noBooks = document.getElementById('noBooks');
      const loading = document.getElementById('loading');
      const searchInput = document.getElementById('searchInput');
      let allBooks = [];

      loading.classList.remove('hidden');
      const classPath = `class_books/${encodeURIComponent(className)}`;
      console.log('📚 Fetching books from:', classPath);
      
      // Check cache first for instant loading
      const cacheKey = `books_${className}`;
      if (booksCache.has(cacheKey)) {
        console.log('⚡ Loading from cache (instant!)');
        const cachedBooks = booksCache.get(cacheKey);
        allBooks = cachedBooks;
        loading.classList.add('hidden');
        noBooks.classList.add('hidden');
        renderBooks(allBooks);
      }
      
      // Optimized Firebase query with persistence
      db.ref(classPath).once('value').then(snap => {
        loading.classList.add('hidden');
        const books = snap.val() || {};
        console.log('✅ Books loaded:', Object.keys(books).length);
        allBooks = Object.entries(books);
        
        // Cache the results
        booksCache.set(cacheKey, allBooks);
        
        if (allBooks.length === 0) {
          noBooks.classList.remove('hidden');
          booksGrid.innerHTML = '';
          return;
        }
        
        noBooks.classList.add('hidden');
        renderBooks(allBooks);
        
        // Set up real-time listener for updates (after initial load)
        db.ref(classPath).on('value', snap => {
          const updatedBooks = snap.val() || {};
          const updatedEntries = Object.entries(updatedBooks);
          
          // Only update if data changed
          if (JSON.stringify(updatedEntries) !== JSON.stringify(allBooks)) {
            console.log('🔄 Books updated in real-time');
            allBooks = updatedEntries;
            booksCache.set(cacheKey, allBooks);
            renderBooks(allBooks);
          }
        });
      }).catch(err => {
        loading.classList.add('hidden');
        console.error('❌ Firebase error:', err);
        showProtectionAlert('Error loading books. Please refresh the page.');
      });

      // Optimized search with debouncing
      searchInput.addEventListener('input', () => {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
          const query = searchInput.value.toLowerCase().trim();
          
          if (query === '') {
            // Show all books
            booksGrid.innerHTML = '';
            noBooks.classList.add('hidden');
            renderBooks(allBooks);
            return;
          }
          
          const filtered = allBooks.filter(([id, b]) => 
            b.title.toLowerCase().includes(query) || 
            b.subject.toLowerCase().includes(query)
          );
          
          booksGrid.innerHTML = '';
          if (filtered.length === 0) {
            noBooks.classList.remove('hidden');
          } else {
            noBooks.classList.add('hidden');
            renderBooks(filtered);
          }
        }, 300); // Debounce for 300ms
      });
    }

    // ========== OPTIMIZED RENDERING WITH LAZY LOADING ==========
    function renderBooks(bookEntries) {
      const booksGrid = document.getElementById('booksGrid');
      booksGrid.innerHTML = '';
      
      // Create document fragment for better performance
      const fragment = document.createDocumentFragment();
      
      bookEntries.forEach(([id, b], index) => {
        const thumbnailUrl = b.url.replace('/upload/', '/upload/fl_sanitize,pg_1,f_jpg/');
        const card = document.createElement('div');
        card.className = 'book-card';
        
        const buttonText = userMode === 'child' ? 'Open Adventure! 🚀' : 'Read Book';
        const titleEmoji = userMode === 'child' ? ' 📖' : '';
        
        // Lazy loading for images - only load visible ones
        const imgPlaceholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIyMCIgZmlsbD0iI0U1RTdFQiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5Q0EzQUYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Mb2FkaW5nLi4uPC90ZXh0Pjwvc3ZnPg==';
        
        card.innerHTML = `
          <img data-src="${thumbnailUrl}" src="${imgPlaceholder}" alt="${b.title} thumbnail" class="book-thumbnail lazy-load" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIyMCIgZmlsbD0iI0VFRSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Cb29rIENvdmVyPC90ZXh0Pjwvc3ZnPg=='">
          <h3 class="text-xl font-bold mt-3">${escapeHtml(b.title)}${titleEmoji}</h3>
          <p class="text-md mb-4 opacity-80">${escapeHtml(b.subject)}</p>
          <button class="read-btn" data-url="${b.url}" data-id="${id}" data-title="${escapeHtml(b.title)}">${buttonText}</button>
        `;
        fragment.appendChild(card);
      });
      
      // Append all cards at once (better performance)
      booksGrid.appendChild(fragment);
      
      // Lazy load images using Intersection Observer
      lazyLoadImages();
      
      // Add event listeners for read buttons
      document.querySelectorAll('.read-btn').forEach(button => {
        button.addEventListener('click', async () => {
          const pdfUrl = button.getAttribute('data-url');
          const bookTitle = button.getAttribute('data-title');
          
          // Use PDF.js for secure, controlled PDF rendering
          // NO external viewers, NO pop-out buttons, FULL CONTROL
          const modal = document.getElementById('pdfModal');
          const modalTitle = document.getElementById('modalTitle');
          const pdfLoader = document.getElementById('pdfLoader');
          const pdfCanvasWrapper = document.getElementById('pdfCanvasWrapper');

          // Show modal with loader
          modal.classList.remove('hidden');
          modalTitle.textContent = bookTitle;
          pdfLoader.classList.remove('hidden');
          pdfCanvasWrapper.innerHTML = '';
          
          // Reset zoom and rotation
          zoomLevel = 1;
          rotationAngle = 0;
          
          console.log('📖 Loading book:', bookTitle);
          
          try {
            // Load PDF with PDF.js
            const loadingTask = pdfjsLib.getDocument(pdfUrl);
            const pdf = await loadingTask.promise;
            
            console.log('✅ PDF loaded successfully, pages:', pdf.numPages);
            
            // Render all pages
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const viewport = page.getViewport({ scale: 1.5 });
              
              // Create canvas for this page
              const canvas = document.createElement('canvas');
              canvas.className = 'modal-pdf-canvas';
              canvas.id = `pdf-page-${pageNum}`;
              const context = canvas.getContext('2d');
              canvas.height = viewport.height;
              canvas.width = viewport.width;
              
              pdfCanvasWrapper.appendChild(canvas);
              
              // Render page
              const renderContext = {
                canvasContext: context,
                viewport: viewport
              };
              await page.render(renderContext).promise;
            }
            
            pdfLoader.classList.add('hidden');
            
          } catch (error) {
            console.error('❌ Error loading PDF:', error);
            pdfLoader.classList.add('hidden');
            showProtectionAlert('Error loading book. Please try again.');
            pdfCanvasWrapper.innerHTML = '<p style="color: white; text-align: center; padding: 40px;">Failed to load PDF. Please try again.</p>';
          }
        });
      });
    }
    
    // Lazy loading for images
    function lazyLoadImages() {
      const images = document.querySelectorAll('img.lazy-load');
      
      if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              img.src = img.dataset.src;
              img.classList.remove('lazy-load');
              observer.unobserve(img);
            }
          });
        }, {
          rootMargin: '50px' // Start loading 50px before image is visible
        });
        
        images.forEach(img => imageObserver.observe(img));
      } else {
        // Fallback for older browsers
        images.forEach(img => {
          img.src = img.dataset.src;
          img.classList.remove('lazy-load');
        });
      }
    }
    
    // HTML escaping for security
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== MODAL CONTROLS WITH FULLSCREEN ==========
    let zoomLevel = 1;
    let rotationAngle = 0;
    
    // Fullscreen button
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      const modalContent = document.querySelector('.modal-content');
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      
      if (!document.fullscreenElement) {
        modalContent.requestFullscreen().then(() => {
          fullscreenBtn.innerHTML = '<i class="fas fa-compress mr-2"></i> Exit Full Screen';
        }).catch(err => {
          showProtectionAlert('Fullscreen request failed. Please try again.');
          console.error('Fullscreen error:', err);
        });
      } else {
        document.exitFullscreen().then(() => {
          fullscreenBtn.innerHTML = '<i class="fas fa-expand mr-2"></i> Full Screen';
        });
      }
    });
    
    // Listen for fullscreen changes
    document.addEventListener('fullscreenchange', () => {
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      if (!document.fullscreenElement) {
        fullscreenBtn.innerHTML = '<i class="fas fa-expand mr-2"></i> Full Screen';
      }
    });
    
    // Zoom In
    document.getElementById('zoomInModal').addEventListener('click', () => {
      if (zoomLevel < 3) {
        zoomLevel += 0.2;
        updateTransform();
      }
    });
    
    // Zoom Out
    document.getElementById('zoomOutModal').addEventListener('click', () => {
      if (zoomLevel > 0.5) {
        zoomLevel -= 0.2;
        updateTransform();
      }
    });
    
    // Rotate
    document.getElementById('rotateBtn').addEventListener('click', () => {
      rotationAngle = (rotationAngle + 90) % 360;
      updateTransform();
    });
    
    // Update transform with zoom and rotation
    function updateTransform() {
      const pdfCanvasWrapper = document.getElementById('pdfCanvasWrapper');
      if (pdfCanvasWrapper) {
        pdfCanvasWrapper.style.transform = `scale(${zoomLevel}) rotate(${rotationAngle}deg)`;
        pdfCanvasWrapper.style.transformOrigin = 'center center';
        pdfCanvasWrapper.style.transition = 'transform 0.3s ease';
      }
    }
    
    // Close modal
    document.getElementById('closeModal').addEventListener('click', () => {
      const modal = document.getElementById('pdfModal');
      const pdfCanvasWrapper = document.getElementById('pdfCanvasWrapper');
      
      // Exit fullscreen if active
      if (document.fullscreenElement) {
        document.exitFullscreen();
      }
      
      modal.classList.add('hidden');
      pdfCanvasWrapper.innerHTML = '';
      zoomLevel = 1;
      rotationAngle = 0;
      if (pdfCanvasWrapper) {
        pdfCanvasWrapper.style.transform = 'scale(1) rotate(0deg)';
      }
    });
    
    // ESC key to close modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('pdfModal');
        if (!modal.classList.contains('hidden')) {
          document.getElementById('closeModal').click();
        }
      }
    });

    // ========== COMPREHENSIVE PROTECTION SYSTEM ==========
    
    // 1. Prevent ALL keyboard shortcuts
    document.addEventListener('keydown', e => {
      // Print: Ctrl+P, Cmd+P
      if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('Printing is disabled for copyright protection.');
        return false;
      }
      
      // Save: Ctrl+S, Cmd+S
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('Saving is disabled for copyright protection.');
        return false;
      }
      
      // Screenshot: PrintScreen, Win+Shift+S, Cmd+Shift+4
      if (e.key === 'PrintScreen' || e.key === 'Print') {
        e.preventDefault();
        activateProtectionOverlay();
        showProtectionAlert('Screenshots are not allowed for copyright protection.');
        return false;
      }
      
      // Windows Snipping Tool: Win+Shift+S
      if (e.shiftKey && e.key === 'S' && (e.metaKey || e.key === 'Meta')) {
        e.preventDefault();
        activateProtectionOverlay();
        showProtectionAlert('Screen capture is disabled for copyright protection.');
        return false;
      }
      
      // DevTools: F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
      if (e.key === 'F12' || 
          ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
          ((e.ctrlKey || e.metaKey) && e.key === 'u')) {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('Developer tools are disabled.');
        return false;
      }
      
      // Copy: Ctrl+C, Cmd+C
      if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        e.preventDefault();
        showProtectionAlert('Copying is disabled for copyright protection.');
        return false;
      }
      
      // Select All: Ctrl+A, Cmd+A
      if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        e.preventDefault();
        return false;
      }
    }, true);
    
    // 2. Override print function completely
    window.print = function() {
      showProtectionAlert('Printing is disabled for copyright protection.');
      return false;
    };
    
    // 3. Prevent right-click context menu
    document.addEventListener('contextmenu', e => {
      e.preventDefault();
      showProtectionAlert('Right-click is disabled for copyright protection.');
      return false;
    }, true);
    
    // 4. Prevent drag and drop
    document.addEventListener('dragstart', e => {
      e.preventDefault();
      return false;
    }, true);
    
    // 5. Detect screenshot attempts (blur/focus method)
    let screenshotAttempts = 0;
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        screenshotAttempts++;
        activateProtectionOverlay();
        setTimeout(() => {
          if (screenshotAttempts > 0) {
            console.warn('Screenshot attempt detected');
          }
        }, 100);
      }
    });
    
    // 6. Detect DevTools opening
    let devtoolsOpen = false;
    const detectDevTools = () => {
      const threshold = 160;
      if (window.outerWidth - window.innerWidth > threshold || 
          window.outerHeight - window.innerHeight > threshold) {
        if (!devtoolsOpen) {
          devtoolsOpen = true;
          document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-size:2rem;text-align:center;padding:20px;">⚠️<br>Developer tools detected.<br>Access denied for security.</div>';
        }
      }
    };
    setInterval(detectDevTools, 1000);
    
    // 7. Protection overlay activation
    function activateProtectionOverlay() {
      const overlay = document.getElementById('protectionOverlay');
      overlay.classList.add('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 2000);
    }
    
    // 8. User-friendly protection alerts
    function showProtectionAlert(message) {
      const alertDiv = document.createElement('div');
      alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #EF4444, #DC2626);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease;
      `;
      alertDiv.innerHTML = `<i class="fas fa-shield-alt mr-2"></i>${message}`;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => alertDiv.remove(), 300);
      }, 3000);
    }
    
    // 9. Disable copy-paste
    document.addEventListener('copy', e => {
      e.preventDefault();
      showProtectionAlert('Copying is disabled for copyright protection.');
      return false;
    }, true);
    
    document.addEventListener('cut', e => {
      e.preventDefault();
      return false;
    }, true);
    
    // 10. Watermark with user info
    function updateWatermark() {
      const watermark = document.getElementById('watermark');
      const now = new Date().toLocaleString();
      watermark.textContent = `SOMAP © ${now}`;
    }
    updateWatermark();
    setInterval(updateWatermark, 30000); // Update every 30 seconds
    
    // 11. Add CSS animations for alerts
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    function fetchNotifications(userKey) {
      const notificationsList = document.getElementById('notificationsList');
      db.ref(`notifications/${userKey}`).orderByChild('time').limitToLast(5).on('value', snap => {
        notificationsList.innerHTML = '';
        const notifs = snap.val() || {};
        
        if (Object.keys(notifs).length === 0) {
          const emptyMsg = userMode === 'child' 
            ? 'No new adventures yet. Check back for exciting updates! 🎈✨'
            : 'No recent notifications. Stay tuned for new books!';
          notificationsList.innerHTML = `<p class="opacity-70">${emptyMsg}</p>`;
          return;
        }
        
        Object.entries(notifs).reverse().forEach(([id, n]) => {
          if (n.type === 'new-book') {
            const notif = document.createElement('div');
            notif.className = 'notification-item';
            const label = userMode === 'child' ? 'New Adventure' : 'New Book';
            const emoji = userMode === 'child' ? ' 🏰✨' : '';
            notif.innerHTML = `
              <p class="font-semibold"><strong>${label}:</strong> ${n.title}${emoji}</p>
              <p class="text-sm opacity-70 mt-1">${n.subject} for ${n.class}</p>
              <p class="text-xs opacity-60 mt-2">Added on ${new Date(n.time).toLocaleDateString()}</p>
            `;
            notificationsList.appendChild(notif);
          }
        });
      }, err => {
        console.error('Notifications error:', err);
        notificationsList.innerHTML = '<p class="opacity-70">Error loading notifications.</p>';
      });
    }
  </script>

  <!-- Modal for full-screen PDF -->
  <div id="pdfModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle" class="text-2xl font-bold"></h2>
        <button id="closeModal" class="close-btn"><i class="fas fa-times mr-2"></i> Close</button>
      </div>
      <div class="modal-controls">
        <button id="fullscreenBtn" style="background: #8B5CF6; color: white;">
          <i class="fas fa-expand mr-2"></i> Full Screen
        </button>
        <button id="zoomInModal" style="background: #14B8A6; color: white;">
          <i class="fas fa-search-plus mr-2"></i> Zoom In
        </button>
        <button id="zoomOutModal" style="background: #06B6D4; color: white;">
          <i class="fas fa-search-minus mr-2"></i> Zoom Out
        </button>
        <button id="rotateBtn" style="background: #F59E0B; color: white;">
          <i class="fas fa-sync-alt mr-2"></i> Rotate
        </button>
      </div>
      <div id="modalPdfContainer" class="modal-pdf-container">
        <div id="pdfCanvasWrapper" class="modal-pdf-canvas-wrapper"></div>
      </div>
      <div id="pdfLoader" class="hidden" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10;">
        <div class="spinner" style="margin: 0 auto 20px;"></div>
        <p style="font-size: 1.2rem; font-weight: 600; color: white;">Loading your book... 📚</p>
      </div>
    </div>
  </div>
</body>
</html>
