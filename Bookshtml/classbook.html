<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SoMAp â€” Magical Books Library</title>

  <!-- Perf hints -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase (compat 9.6.10) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    /* Lightweight styles + deterrents */
    @media print { body { display:none !important; } }
    * { user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; }
    body { font-family:Inter,system-ui,Arial; background:#f8fafc; }

    .book-grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:24px; padding:24px;
    }
    .book-card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,.04); }
    .book-thumbnail { width:100%; height:200px; object-fit:cover; border-radius:10px; display:block; }
    .read-btn { margin-top:10px; width:100%; background:#6366f1; color:#fff; border:none; border-radius:10px; padding:10px 14px; font-weight:700; }
    .read-btn:hover { filter:brightness(1.05); }

    .loading { text-align:center; margin:40px 0; color:#475569; }
    .spinner { width:38px; height:38px; border:3px solid #e5e7eb; border-top-color:#94a3b8; border-radius:50%; margin:0 auto 12px; animation:spin .9s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* Overlay viewer */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; z-index:60; }
    .modal.show { display:block; }
    .modal-content { position:absolute; inset:2.5%; background:#111827; border-radius:16px; display:flex; flex-direction:column; overflow:hidden; }
    .modal-header { display:flex; align-items:center; gap:10px; padding:12px 16px; color:#fff; background:#1f2937; }
    .modal-header h2 { font-weight:800; font-size:1rem; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .modal-controls { background:#111827; border-top:1px solid #374151; border-bottom:1px solid #374151; padding:8px 12px; display:flex; gap:8px; }
    .mc-btn {
      border:1px solid #374151; background:#1f2937; color:#fff; border-radius:10px; padding:9px 14px; font-weight:700;
    }
    .mc-btn:hover { filter:brightness(1.1); }
    .modal-viewer-container { position:relative; flex:1; background:#0b1220; overflow:auto; }
    .viewer-stage { min-width:100%; min-height:100%; display:grid; place-items:start center; }
    .viewer-el { transform-origin:center top; }
    .viewer-spinner { position:absolute; inset:0; display:grid; place-items:center; }
    .wm { position:absolute; inset:auto 16px 16px auto; color:rgba(255,255,255,.5); font-size:.8rem; z-index:50; pointer-events:none; }

    /* Watermark across the canvas (big) */
    .wm-big {
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; z-index:40;
      color:rgba(255,255,255,.06); font-weight:800; font-size:7vw; transform:rotate(-18deg);
    }
  </style>
</head>
<body>
  <!-- Top -->
  <header class="bg-white border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-bold">ðŸ“š Magical Books Library</h1>
      <a id="backBtn" href="../index.html" class="text-sm font-semibold text-indigo-600 hover:text-indigo-700">Back</a>
    </div>
  </header>

  <!-- Body -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="mb-4">
      <input id="searchInput" class="w-full border border-gray-300 rounded-xl px-4 py-3"
             placeholder="Search books by title or subjectâ€¦"/>
    </div>

    <div id="booksGrid" class="book-grid"></div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      Loading your booksâ€¦
    </div>

    <div id="noBooks" class="hidden text-center text-gray-500 my-10">
      <i class="fa fa-book-open text-5xl mb-4"></i>
      <div>No books available yet.</div>
    </div>
  </main>

  <!-- Overlay Viewer -->
  <div id="viewer" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle"></h2>
        <button id="closeBtn" class="mc-btn"><i class="fa fa-times mr-1"></i>Close</button>
      </div>

      <div class="modal-controls">
        <button id="fsBtn" class="mc-btn"><i class="fa fa-expand mr-1"></i>Full Screen</button>
        <button id="zinBtn" class="mc-btn"><i class="fa fa-search-plus mr-1"></i>Zoom In</button>
        <button id="zoutBtn" class="mc-btn"><i class="fa fa-search-minus mr-1"></i>Zoom Out</button>
        <button id="rotBtn" class="mc-btn"><i class="fa fa-rotate mr-1"></i>Rotate</button>
        <button id="fitBtn" class="mc-btn"><i class="fa fa-compress mr-1"></i>Reset</button>
        <div class="ml-auto text-white/70 font-semibold" id="zoomLabel">100%</div>
      </div>

      <div class="modal-viewer-container" id="viewerContainer">
        <div class="wm-big" id="wmBig">SoMAp</div>
        <div class="viewer-spinner" id="viewerSpinner" style="display:none">
          <div>
            <div class="spinner" style="margin:0 auto 10px;"></div>
            <div class="text-white text-sm font-semibold text-center">Loadingâ€¦</div>
          </div>
        </div>
        <div class="viewer-stage" id="viewerStage">
          <!-- Reused elements -->
          <iframe id="pdfEl" class="viewer-el" style="width:100%;height:100%;display:none;border:0;" allow="fullscreen"></iframe>
          <img id="imgEl" class="viewer-el" style="display:none;max-width:none;" alt="Book"/>
        </div>
        <div class="wm" id="wmSmall"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let userMode = 'child'; // 'child' | 'teacher'
    let className = '';
    let userKey = '';

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        userKey = user.email.replace(/\./g,'_');
        try {
          const snap = await db.ref(`users/${userKey}`).once('value');
          const u = snap.val();
          if (u && u.role === 'teacher' && u.class) {
            userMode = 'teacher';
            className = (u.class||'').trim();
            initTeacher();
            fetchBooks(className);
          } else {
            alert('Invalid teacher access'); location.href='../index.html';
          }
        } catch(e){ alert(e.message); }
      } else {
        const studentKey = localStorage.getItem('studentKey');
        if (!studentKey){ alert('Please sign in'); location.href='../index.html'; return; }
        try {
          const s = (await db.ref(`students/${studentKey}`).once('value')).val();
          if (!s || !s.classLevel){ localStorage.removeItem('studentKey'); location.href='../index.html'; return; }
          userMode = 'child'; className = (s.classLevel||'').trim(); userKey = studentKey;
          initChild(); fetchBooks(className);
        } catch(e){ alert(e.message); }
      }
    });

    function initTeacher(){
      document.getElementById('backBtn').href = '../staff.html';
    }
    function initChild(){
      document.getElementById('backBtn').href = '../parent.html';
    }

    // ---------- Data ----------
    const cache = new Map();
    const loadingEl = document.getElementById('loading');
    const noBooksEl = document.getElementById('noBooks');
    const grid = document.getElementById('booksGrid');
    const searchInput = document.getElementById('searchInput');

    function thumbFrom(url){
      // Small Cloudinary thumbnail if applicable (keeps fast)
      return /res\.cloudinary\.com/.test(url)
        ? url.replace('/upload/','/upload/fl_sanitize,pg_1,f_jpg,q_auto,w_360/')
        : url;
    }

    async function fetchBooks(cls){
      grid.innerHTML = '';
      loadingEl.classList.remove('hidden');
      noBooksEl.classList.add('hidden');

      const path = `class_books/${encodeURIComponent(cls)}`;
      const key = `books_${cls}`;
      if (cache.has(key)) { renderBooks(cache.get(key)); }

      try{
        const snap = await db.ref(path).once('value');
        const data = snap.val() || {};
        const entries = Object.entries(data);
        cache.set(key, entries);
        renderBooks(entries);
        db.ref(path).on('value', s=>{
          const d = s.val()||{};
          const e = Object.entries(d);
          if (JSON.stringify(e)!==JSON.stringify(cache.get(key))){
            cache.set(key,e); renderBooks(e);
          }
        });
      }catch(e){
        loadingEl.classList.add('hidden');
        alert('Error loading books: ' + e.message);
      }
    }

    function renderBooks(entries){
      loadingEl.classList.add('hidden');
      grid.innerHTML = '';
      if (!entries.length){ noBooksEl.classList.remove('hidden'); return; }
      noBooksEl.classList.add('hidden');

      // Build cards (no heavy loading yet)
      const frag = document.createDocumentFragment();
      entries.forEach(([id,b])=>{
        const card = document.createElement('div');
        card.className = 'book-card';
        const t = (b.title||'Untitled');
        const s = (b.subject||'');
        const imgUrl = thumbFrom(b.url||'');
        card.innerHTML = `
          <img class="book-thumbnail" loading="lazy" src="${imgUrl}" alt="${escapeHtml(t)} thumbnail" onerror="this.style.display='none'">
          <h3 class="mt-2 font-bold">${escapeHtml(t)}</h3>
          <div class="text-sm text-gray-500">${escapeHtml(s)}</div>
          <button class="read-btn" data-url="${b.url||''}" data-title="${escapeHtml(t)}">Read</button>
        `;
        frag.appendChild(card);
      });
      grid.appendChild(frag);

      grid.querySelectorAll('.read-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          openViewer(btn.getAttribute('data-url'), btn.getAttribute('data-title'));
        });
      });

      // Search
      searchInput.oninput = () => {
        const q = (searchInput.value||'').toLowerCase().trim();
        const filtered = (cache.get(`books_${className}`)||[]).filter(([id,b])=>{
          const t=(b.title||'').toLowerCase(); const s=(b.subject||'').toLowerCase();
          return t.includes(q)||s.includes(q);
        });
        renderBooks(filtered);
      };
    }

    function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }

    // ---------- Viewer ----------
    const viewer = document.getElementById('viewer');
    const viewerStage = document.getElementById('viewerStage');
    const viewerSpinner = document.getElementById('viewerSpinner');
    const pdfEl = document.getElementById('pdfEl');
    const imgEl = document.getElementById('imgEl');
    const titleEl = document.getElementById('modalTitle');
    const wmBig = document.getElementById('wmBig');
    const wmSmall = document.getElementById('wmSmall');

    const zoomLabel = document.getElementById('zoomLabel');
    const fsBtn = document.getElementById('fsBtn');
    const zinBtn = document.getElementById('zinBtn');
    const zoutBtn = document.getElementById('zoutBtn');
    const rotBtn = document.getElementById('rotBtn');
    const fitBtn = document.getElementById('fitBtn');
    const closeBtn = document.getElementById('closeBtn');

    let zoom = 1, rotation = 0, active = null; // 'pdf' | 'img'
    const ZMIN=0.5, ZMAX=3, ZSTEP=0.1;

    function buildReadOnlyViewerUrl(u){
      const url = decodeURIComponent(u||''); const isPdf = /\.pdf(\?|#|$)/i.test(url);
      if (!isPdf) return url;
      const sep = url.includes('?')?'&':'?';
      const hasHash = url.includes('#'); const hashSep = hasHash?'&':'#';
      const flags = 'toolbar=0&navpanes=0&scrollbar=0&view=FitH';
      return `${url}${sep}inline=1${hashSep}${flags}`;
    }

    function setLoading(on){
      viewerSpinner.style.display = on ? 'grid' : 'none';
      [fsBtn, zinBtn, zoutBtn, rotBtn, fitBtn, closeBtn].forEach(b=>{
        b.disabled = on; b.style.opacity = on? .5 : 1; b.style.cursor = on? 'not-allowed':'pointer';
      });
    }

    function applyTransform(){
      const t = `scale(${zoom}) rotate(${rotation}deg)`;
      const el = active==='img' ? imgEl : pdfEl;
      el.style.transformOrigin = 'center top';
      el.style.transform = t;
      zoomLabel.textContent = Math.round(zoom*100)+'%';
    }

    function resetView(){ zoom=1; rotation=0; applyTransform(); }

    function updateWatermark(){
      const now = new Date().toLocaleString();
      const who = userKey || 'SoMAp User';
      wmBig.textContent = `SoMAp â€” ${who}`;
      wmSmall.textContent = `SoMAp â€¢ ${who} â€¢ ${now}`;
    }

    function openViewer(rawUrl, title){
      const url = (rawUrl||'').trim(); if (!url) return;
      titleEl.textContent = title||'Book';
      viewer.classList.add('show'); setLoading(true); updateWatermark();

      // Clear previous
      imgEl.style.display='none'; imgEl.src='';
      pdfEl.style.display='none'; pdfEl.src='about:blank';
      resetView();

      if (/\.pdf(\?|#|$)/i.test(url)){
        active='pdf';
        const src = buildReadOnlyViewerUrl(url);
        pdfEl.onload = ()=> setLoading(false);
        // small trick to cancel old load then load fresh
        pdfEl.src = 'about:blank'; setTimeout(()=>{ pdfEl.src = src; pdfEl.style.display='block'; applyTransform(); },0);
      } else {
        active='img';
        imgEl.onload = ()=> setLoading(false);
        imgEl.onerror = ()=>{ setLoading(false); alert('Failed to load image'); };
        imgEl.src = url; imgEl.style.display='block'; applyTransform();
      }
    }

    function closeViewer(){
      viewer.classList.remove('show');
      if (document.fullscreenElement) document.exitFullscreen?.();
      pdfEl.src='about:blank'; imgEl.src='';
    }

    // Buttons
    fsBtn.onclick = () => {
      const el = document.querySelector('.modal-content');
      if (!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
    };
    zinBtn.onclick = () => { if (zoom<ZMAX){ zoom = +(Math.min(ZMAX, zoom+ZSTEP)).toFixed(2); applyTransform(); } };
    zoutBtn.onclick = () => { if (zoom>ZMIN){ zoom = +(Math.max(ZMIN, zoom-ZSTEP)).toFixed(2); applyTransform(); } };
    rotBtn.onclick = () => { rotation = (rotation+90)%360; applyTransform(); };
    fitBtn.onclick = () => resetView();
    closeBtn.onclick = () => closeViewer();

    // Keyboard shortcuts in viewer
    window.addEventListener('keydown', (e)=>{
      if (!viewer.classList.contains('show')) return;
      if (e.key==='Escape'){ closeViewer(); e.preventDefault(); }
      if (e.key==='+'||e.key==='='){ zinBtn.click(); e.preventDefault(); }
      if (e.key==='-'||e.key==='_'){ zoutBtn.click(); e.preventDefault(); }
      if (e.key.toLowerCase()==='r'){ rotBtn.click(); e.preventDefault(); }
      if (e.key.toLowerCase()==='f'){ fsBtn.click(); e.preventDefault(); }
      if (e.key==='0'){ fitBtn.click(); e.preventDefault(); }
    });

    // Wheel zoom with Ctrl
    document.getElementById('viewerContainer').addEventListener('wheel',(e)=>{
      if (!viewer.classList.contains('show')) return;
      if (e.ctrlKey){ e.preventDefault();
        const d = e.deltaY>0 ? -ZSTEP : ZSTEP;
        zoom = +(Math.min(ZMAX, Math.max(ZMIN, zoom+d))).toFixed(2); applyTransform();
      }
    }, {passive:false});

    // ---------- Deterrents (best-effort) ----------
    // Note: True screenshot blocking is not possible on the web.
    // We add watermark + disable print/context menu + hide PDF toolbar.
    window.print = function(){ alert('Printing is disabled.'); return false; };
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey||e.metaKey) && (e.key==='p'||e.key==='s')) { e.preventDefault(); alert('Blocked.'); }
    }, true);
    document.addEventListener('contextmenu', (e)=>{ e.preventDefault(); }, true);

    // ---------- End ----------
  </script>
</body>
</html>
