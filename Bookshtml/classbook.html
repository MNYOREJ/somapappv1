<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>SoMAp â€” Magical Books Library (Read-Only, In-Page)</title>

  <!-- Performance & DNS hints -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase (compat 9.6.10) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    /* ---------- Global + Basic Deterrents ---------- */
    @media print { body { display:none !important; } }
    * { user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; }
    html, body { height:100%; background:#f7fafc; font-family:Inter, system-ui, Arial; }
    ::-webkit-scrollbar { width:10px; height:10px }
    ::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:6px }
    ::-webkit-scrollbar-thumb:hover { background:#94a3b8 }

    /* ---------- Kids-friendly Cards (no rainbow) ---------- */
    .book-grid {
      display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr));
      gap:22px; padding:18px 18px 28px;
    }
    .book-card {
      border-radius:18px; padding:16px; border:1px solid #e5e7eb;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      background: linear-gradient(180deg,#ffffff 0%,#fbfdff 100%);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .book-card:hover { transform: translateY(-3px); box-shadow:0 10px 20px rgba(0,0,0,.08); }
    .tag {
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px; font-size:.75rem; font-weight:700;
    }
    .tag.blue { background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; }
    .tag.green{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .tag.orange{ background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }

    .book-thumbnail {
      width:100%; height:200px; object-fit:cover; border-radius:12px; display:block;
      border:1px solid #e5e7eb;
    }
    .read-btn {
      margin-top:12px; width:100%;
      background:#2563eb; color:#fff; border:none; border-radius:12px; padding:10px 14px;
      font-weight:800; letter-spacing:.2px;
    }
    .read-btn:hover { filter:brightness(1.06); }

    .loading { text-align:center; margin:40px 0; color:#475569; }
    .spinner { width:38px; height:38px; border:3px solid #e5e7eb; border-top-color:#94a3b8; border-radius:50%; margin:0 auto 12px; animation:spin .9s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ---------- Overlay Viewer (NO iframe) ---------- */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.78); display:none; z-index:80; }
    .modal.show { display:block; }
    .modal-content { position:absolute; inset:env(safe-area-inset-top,2.5%) 2.5% env(safe-area-inset-bottom,2.5%) 2.5%;
      background:#0b1220; border-radius:16px; display:flex; flex-direction:column; overflow:hidden; }
    .modal-header { display:flex; align-items:center; gap:10px; padding:12px 16px; color:#fff; background:#0f172a; border-bottom:1px solid #1f2937; }
    .modal-header h2 { font-weight:800; font-size:1rem; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .modal-controls { background:#0b1220; border-top:1px solid #1f2937; border-bottom:1px solid #1f2937; padding:10px 12px; display:flex; gap:8px; align-items:center }
    .mc-btn { border:1px solid #334155; background:#0f172a; color:#fff; border-radius:10px; padding:9px 14px; font-weight:800; }
    .mc-btn:hover { filter:brightness(1.12); }
    .zoom-label { color:#cbd5e1; font-weight:800; margin-left:auto }

    /* Pages area (continuous A4 scroll) */
    .pages-wrap { position:relative; flex:1; overflow:auto; background:radial-gradient(ellipse at top, #0b1220 0%, #0b1220 60%, #0a1120 100%); }
    .wm-big {
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; z-index:2;
      color:rgba(255,255,255,.05); font-weight:900; font-size:7vw; transform:rotate(-18deg);
    }
    .pages { position:relative; z-index:3; padding:32px 16px 60px; display:grid; justify-content:center; gap:22px; }

    .page {
      background:#fff; box-shadow: 0 10px 28px rgba(2,6,23,.45), 0 2px 6px rgba(2,6,23,.4);
      border-radius:12px; overflow:hidden; position:relative;
      border:1px solid #e5e7eb;
    }
    /* A4 ratio holder; canvas/image will fill it */
    .page-inner { width:100%; height:100%; display:grid; place-items:center; background:#fff; }

    /* Default phone widths: fit screen nicely; desktop gets bigger max */
    .pages { grid-template-columns:min(100%, 820px); }
    .page { width: min(100%, 820px); } /* ~ A4 at 96dpi scale on typical displays */
    .page .canvas,
    .page .img { width:100%; height:auto; display:block; }

    /* Zoom & rotate (CSS transforms; fast; no re-render) */
    .zoom-wrap { transform-origin:center top; transition: transform .2s ease; }

    /* Spinner overlay inside pages */
    .page .page-spinner {
      position:absolute; inset:0; display:grid; place-items:center; background:rgba(255,255,255,.85);
    }

    /* Small watermark at corner */
    .wm-small {
      position:fixed; right:14px; bottom:14px; z-index:100;
      color:#e2e8f0; font-size:.8rem; font-weight:800; text-shadow: 0 1px 2px rgba(0,0,0,.5);
      pointer-events:none;
    }

    /* Header + Search */
    .hero { background:#ffffff; border-bottom:1px solid #e2e8f0; }
    .search-input { width:100%; border:1px solid #e2e8f0; border-radius:12px; padding:12px 14px; font-weight:600; }

    /* Simple palette accents for cards */
    .accent-1 { background:linear-gradient(180deg,#eef2ff 0%,#e0e7ff 100%); border-color:#c7d2fe }
    .accent-2 { background:linear-gradient(180deg,#ecfeff 0%,#cffafe 100%); border-color:#a5f3fc }
    .accent-3 { background:linear-gradient(180deg,#fefce8 0%,#fef9c3 100%); border-color:#fde68a }
    .accent-4 { background:linear-gradient(180deg,#f0fdf4 0%,#dcfce7 100%); border-color:#bbf7d0 }
    .accent-5 { background:linear-gradient(180deg,#fff7ed 0%,#ffedd5 100%); border-color:#fed7aa }

    @keyframes pulseSoft { 0%,100%{ transform:scale(1)} 50%{ transform:scale(1.02)} }
    .pulse-soft { animation:pulseSoft 2.4s ease-in-out infinite }

  </style>
</head>
<body>
  <!-- Header -->
  <header class="hero">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <button id="backBtn" class="px-3 py-2 rounded-lg bg-slate-100 font-bold text-slate-700 border border-slate-200 hover:bg-slate-200">
        <i class="fa fa-arrow-left mr-2"></i>Back
      </button>
      <h1 class="text-lg sm:text-xl font-extrabold text-slate-800">ðŸ“š Magical Books Library</h1>
      <div class="ml-auto w-full sm:w-1/2">
        <input id="searchInput" class="search-input" placeholder="Search books by title or subjectâ€¦"/>
      </div>
    </div>
  </header>

  <!-- Grid -->
  <main class="max-w-6xl mx-auto px-4 py-5">
    <div id="booksGrid" class="book-grid"></div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      Loading your booksâ€¦
    </div>

    <div id="noBooks" class="hidden text-center text-gray-500 my-10">
      <i class="fa fa-book-open text-5xl mb-4"></i>
      <div>No books available yet.</div>
    </div>
  </main>

  <!-- READ-ONLY VIEWER (NO IFRAME, NO EXTERNAL OPEN) -->
  <div id="viewer" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle"></h2>
        <button id="closeBtn" class="mc-btn"><i class="fa fa-times mr-1"></i>Close</button>
      </div>

      <div class="modal-controls">
        <button id="fsBtn" class="mc-btn"><i class="fa fa-expand mr-1"></i>Full Screen</button>
        <button id="zinBtn" class="mc-btn"><i class="fa fa-search-plus mr-1"></i>Zoom In</button>
        <button id="zoutBtn" class="mc-btn"><i class="fa fa-search-minus mr-1"></i>Zoom Out</button>
        <button id="rotBtn" class="mc-btn"><i class="fa fa-rotate mr-1"></i>Rotate</button>
        <button id="fitBtn" class="mc-btn"><i class="fa fa-compress mr-1"></i>Reset</button>
        <div class="zoom-label" id="zoomLabel">100%</div>
      </div>

      <div id="pagesWrap" class="pages-wrap">
        <div class="wm-big" id="wmBig">SoMAp</div>
        <div class="wm-small" id="wmSmall"></div>
        <div id="zoomWrap" class="zoom-wrap">
          <div id="pages" class="pages"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       Firebase Auth + Data
       ========================= */
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let userMode = 'child'; // 'child' | 'teacher'
    let className = '';
    let userKey = '';

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        userKey = user.email.replace(/\./g,'_');
        try {
          const snap = await db.ref(`users/${userKey}`).once('value');
          const u = snap.val();
          if (u && u.role === 'teacher' && u.class) {
            userMode = 'teacher';
            className = (u.class||'').trim();
            document.getElementById('backBtn').onclick = ()=> location.href='../staff.html';
            fetchBooks(className);
          } else {
            alert('Invalid teacher access'); location.href='../index.html';
          }
        } catch(e){ alert(e.message); }
      } else {
        const studentKey = localStorage.getItem('studentKey');
        if (!studentKey){ alert('Please sign in'); location.href='../index.html'; return; }
        try {
          const s = (await db.ref(`students/${studentKey}`).once('value')).val();
          if (!s || !s.classLevel){ localStorage.removeItem('studentKey'); location.href='../index.html'; return; }
          userMode = 'child'; className = (s.classLevel||'').trim(); userKey = studentKey;
          document.getElementById('backBtn').onclick = ()=> location.href='../parent.html';
          fetchBooks(className);
        } catch(e){ alert(e.message); }
      }
    });

    /* =========================
       Books Grid
       ========================= */
    const cache = new Map();
    const loadingEl = document.getElementById('loading');
    const noBooksEl = document.getElementById('noBooks');
    const grid = document.getElementById('booksGrid');
    const searchInput = document.getElementById('searchInput');

    function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }

    function thumbFrom(url){
      // Cloudinary thumbnail if present
      return /res\.cloudinary\.com/.test(url)
        ? url.replace('/upload/','/upload/fl_sanitize,pg_1,f_jpg,q_auto,w_420/')
        : url;
    }

    async function fetchBooks(cls){
      grid.innerHTML = '';
      loadingEl.classList.remove('hidden');
      noBooksEl.classList.add('hidden');

      const path = `class_books/${encodeURIComponent(cls)}`;
      const key = `books_${cls}`;
      if (cache.has(key)) { renderBooks(cache.get(key)); }

      try{
        const snap = await db.ref(path).once('value');
        const data = snap.val() || {};
        const entries = Object.entries(data);
        cache.set(key, entries);
        renderBooks(entries);
        db.ref(path).on('value', s=>{
          const d = s.val()||{};
          const e = Object.entries(d);
          if (JSON.stringify(e)!==JSON.stringify(cache.get(key))){
            cache.set(key,e); renderBooks(e);
          }
        });
      }catch(e){
        loadingEl.classList.add('hidden');
        alert('Error loading books: ' + e.message);
      }
    }

    function renderBooks(entries){
      loadingEl.classList.add('hidden');
      grid.innerHTML = '';
      if (!entries.length){ noBooksEl.classList.remove('hidden'); return; }
      noBooksEl.classList.add('hidden');

      const accents = ['accent-1','accent-2','accent-3','accent-4','accent-5'];
      let i = 0;

      const frag = document.createDocumentFragment();
      entries.forEach(([id,b])=>{
        const card = document.createElement('div');
        card.className = `book-card ${accents[i%accents.length]} pulse-soft`;
        i++;

        const t = (b.title||'Untitled');
        const s = (b.subject||'');
        const imgUrl = thumbFrom(b.url||'');

        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <span class="tag blue"><i class="fa fa-book"></i> ${userMode==='child'?'For You':'Class Book'}</span>
            <span class="tag ${userMode==='child'?'green':'orange'}"><i class="fa fa-star"></i> ${userMode==='child'?'Fun':'Study'}</span>
          </div>
          <img class="book-thumbnail" loading="lazy" src="${imgUrl}" alt="${escapeHtml(t)} thumbnail" onerror="this.style.display='none'">
          <h3 class="mt-3 font-extrabold text-slate-800 text-lg">${escapeHtml(t)}</h3>
          <div class="text-sm text-slate-600">${escapeHtml(s)}</div>
          <button class="read-btn" data-url="${b.url||''}" data-title="${escapeHtml(t)}"><i class="fa fa-eye mr-2"></i>Read</button>
        `;
        frag.appendChild(card);
      });
      grid.appendChild(frag);

      grid.querySelectorAll('.read-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          openViewer(btn.getAttribute('data-url'), btn.getAttribute('data-title'));
        });
      });

      // Search
      searchInput.oninput = () => {
        const q = (searchInput.value||'').toLowerCase().trim();
        const filtered = (cache.get(`books_${className}`)||[]).filter(([id,b])=>{
          const t=(b.title||'').toLowerCase(); const s=(b.subject||'').toLowerCase();
          return t.includes(q)||s.includes(q);
        });
        renderBooks(filtered);
      };
    }

    /* =========================
       Read-only Viewer (No iframe)
       - Tries Cloudinary image pages (pg_1.jpg...)
       - Else uses PDF.js to render into <canvas> (in-page)
       ========================= */
    const viewer = document.getElementById('viewer');
    const titleEl = document.getElementById('modalTitle');
    const pagesWrap = document.getElementById('pagesWrap');
    const pages = document.getElementById('pages');
    const wmBig = document.getElementById('wmBig');
    const wmSmall = document.getElementById('wmSmall');
    const zoomWrap = document.getElementById('zoomWrap');

    const zoomLabel = document.getElementById('zoomLabel');
    const fsBtn = document.getElementById('fsBtn');
    const zinBtn = document.getElementById('zinBtn');
    const zoutBtn = document.getElementById('zoutBtn');
    const rotBtn = document.getElementById('rotBtn');
    const fitBtn = document.getElementById('fitBtn');
    const closeBtn = document.getElementById('closeBtn');

    let zoom = 1, rotation = 0;
    const ZMIN=0.6, ZMAX=2.2, ZSTEP=0.1;

    function setZoomRotate(){
      zoomWrap.style.transform = `scale(${zoom}) rotate(${rotation}deg)`;
      zoomLabel.textContent = Math.round(zoom*100)+'%';
    }
    function resetView(){ zoom=1; rotation=0; setZoomRotate(); }

    function updateWatermark(){
      const now = new Date().toLocaleString();
      const who = userKey || 'SoMAp User';
      wmBig.textContent = `SoMAp â€” ${who}`;
      wmSmall.textContent = `SoMAp â€¢ ${who} â€¢ ${now}`;
    }

    function isCloudinaryPdf(u){
      return /res\.cloudinary\.com/.test(u) && /\.pdf(\?|#|$)/i.test(u);
    }
    function isPdf(u){
      return /\.pdf(\?|#|$)/i.test(u);
    }

    function cloudinaryPageUrl(pdfUrl, pageIndex, width=1600){
      // turn â€¦/upload/.../file.pdf  -> â€¦/upload/pg_1,f_jpg,q_auto,w_1600/.../file.jpg
      // keep directory and public_id; this assumes unsigned delivery enabled for these transforms
      const parts = pdfUrl.split('/upload/');
      if (parts.length !== 2) return null;
      const prefix = parts[0] + '/upload/';
      const suffix = parts[1];
      const trans = `fl_sanitize,pg_${pageIndex},f_jpg,q_auto,w_${width}`;
      return prefix + trans + '/' + suffix.replace(/\.pdf(\?|#|$)/i, '.jpg$1');
    }

    function createPageShell(){
      const page = document.createElement('div');
      page.className = 'page';
      const inner = document.createElement('div');
      inner.className = 'page-inner';
      page.appendChild(inner);
      return {page, inner};
    }

    async function renderCloudinaryAsImages(basePdfUrl, title){
      // Progressive page loading; try sequential pages until a miss
      // Start with first 3 pages quickly, then lazy-load as you scroll
      pages.innerHTML = '';
      resetView(); updateWatermark();
      const MAX_PAGES_SOFT = 200; // hard cap
      let pageCountGuess = 0;
      const observer = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          if (entry.isIntersecting){
            const idx = +entry.target.getAttribute('data-page');
            loadCloudinaryPage(idx);
            observer.unobserve(entry.target);
          }
        })
      }, {root: pagesWrap, rootMargin: '600px'});

      // Create shells for first 12 to feel smooth; load 1..3 immediately
      for (let i=1;i<=12;i++){
        const {page, inner} = createPageShell();
        page.dataset.page = i;
        inner.innerHTML = `
          <div class="page-spinner">
            <div>
              <div class="spinner" style="margin:0 auto 10px"></div>
              <div class="text-slate-600 font-semibold">Loading page ${i}â€¦</div>
            </div>
          </div>`;
        pages.appendChild(page);
        if (i<=3) loadCloudinaryPage(i); else observer.observe(page);
      }

      async function loadCloudinaryPage(i){
        const pageEl = pages.querySelector(`.page[data-page="${i}"]`);
        if (!pageEl) return;
        const inner = pageEl.firstElementChild;
        // try large image; fallback smaller on error
        const tryUrls = [cloudinaryPageUrl(basePdfUrl,i,1600), cloudinaryPageUrl(basePdfUrl,i,1200), cloudinaryPageUrl(basePdfUrl,i,900)];
        let loaded=false;
        for (const u of tryUrls){
          if (!u) continue;
          try {
            const img = new Image();
            img.decoding = 'async';
            img.loading = 'lazy';
            img.className = 'img';
            img.style.display='block';
            img.style.width='100%';
            img.style.height='auto';
            await new Promise((res,rej)=>{
              img.onload = res;
              img.onerror = rej;
              img.src = u;
            });
            inner.innerHTML = '';
            inner.appendChild(img);
            loaded = true;
            pageCountGuess = Math.max(pageCountGuess, i);
            // Pre-create next shell if close to end
            if (i < MAX_PAGES_SOFT && !pages.querySelector(`.page[data-page="${i+1}"]`)) {
              const {page: p2, inner: in2} = createPageShell();
              p2.dataset.page = i+1;
              in2.innerHTML = `
                <div class="page-spinner">
                  <div>
                    <div class="spinner" style="margin:0 auto 10px"></div>
                    <div class="text-slate-600 font-semibold">Loading page ${i+1}â€¦</div>
                  </div>
                </div>`;
              pages.appendChild(p2);
              observer.observe(p2);
            }
            break;
          } catch(e){ /* try next size */ }
        }
        if (!loaded){
          // We assume previous page was last; remove further shells to stop 404 storms
          const toRemove = Array.from(pages.children).filter(el => +el.dataset.page > i);
          toRemove.forEach(el=> el.remove());
        }
      }
    }

    // Lazy loader for PDF.js (only if needed)
    let pdfjsReady = false;
    async function ensurePdfJs(){
      if (pdfjsReady) return;
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js');
      // eslint-disable-next-line no-undef
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      pdfjsReady = true;
    }
    function loadScript(src){
      return new Promise((res,rej)=>{
        const s = document.createElement('script');
        s.src = src; s.onload = res; s.onerror = ()=>rej(new Error('Failed load '+src));
        document.head.appendChild(s);
      });
    }

    async function renderWithPdfJs(pdfUrl, title){
      // Renders into canvases; still in-page; no iframe; no pdf link
      // eslint-disable-next-line no-undef
      const pdf = await pdfjsLib.getDocument({url: pdfUrl, withCredentials:false}).promise;
      const NUM = pdf.numPages;
      pages.innerHTML = '';
      resetView(); updateWatermark();

      // Render first 2 immediately, others lazily
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(async entry=>{
          if (entry.isIntersecting){
            const idx = +entry.target.getAttribute('data-page');
            await renderOne(idx);
            io.unobserve(entry.target);
          }
        });
      }, {root: pagesWrap, rootMargin: '600px'});

      for (let i=1;i<=NUM;i++){
        const {page, inner} = createPageShell();
        page.dataset.page = i;
        inner.innerHTML = `
          <div class="page-spinner">
            <div>
              <div class="spinner" style="margin:0 auto 10px"></div>
              <div class="text-slate-600 font-semibold">Loading page ${i}â€¦</div>
            </div>
          </div>`;
        pages.appendChild(page);
        if (i<=2) renderOne(i); else io.observe(page);
      }

      async function renderOne(i){
        const holder = pages.querySelector(`.page[data-page="${i}"] .page-inner`);
        if (!holder) return;
        try{
          const page = await pdf.getPage(i);
          // Choose a viewport close to A4 on typical screens; we can scale via CSS zoom
          const viewport = page.getViewport({scale: 1.3});
          const canvas = document.createElement('canvas');
          canvas.className = 'canvas';
          const ctx = canvas.getContext('2d', {alpha:false});
          canvas.width = Math.floor(viewport.width);
          canvas.height = Math.floor(viewport.height);
          await page.render({canvasContext: ctx, viewport}).promise;
          holder.innerHTML = '';
          holder.appendChild(canvas);
        }catch(e){
          holder.innerHTML = `<div class="p-8 text-center text-slate-600 font-bold">Failed to render page ${i}</div>`;
        }
      }
    }

    async function openViewer(rawUrl, title){
      const url = (rawUrl||'').trim(); if (!url) return;
      titleEl.textContent = title||'Book';
      viewer.classList.add('show');
      pages.innerHTML = ''; resetView(); updateWatermark();

      try{
        if (isCloudinaryPdf(url)) {
          await renderCloudinaryAsImages(url, title);
        } else if (isPdf(url)) {
          await ensurePdfJs();
          await renderWithPdfJs(url, title);
        } else {
          // Single image book
          pages.innerHTML = '';
          const {page, inner} = createPageShell();
          const img = new Image();
          img.decoding='async'; img.loading='eager';
          img.className='img';
          img.style.display='block'; img.style.width='100%'; img.style.height='auto';
          inner.appendChild(img); pages.appendChild(page);
          img.onload = ()=>{}; img.onerror = ()=>{ inner.innerHTML = `<div class="p-8 text-center text-slate-600 font-bold">Failed to load image</div>`; };
          img.src = url;
        }
      }catch(e){
        pages.innerHTML = `<div class="text-center text-slate-200 font-bold py-16">Could not open this book.</div>`;
      }
    }

    function closeViewer(){
      viewer.classList.remove('show');
      // clear pages for memory
      pages.innerHTML = '';
      if (document.fullscreenElement) document.exitFullscreen?.();
    }

    // Controls
    fsBtn.onclick = () => {
      const el = document.querySelector('.modal-content');
      if (!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
    };
    zinBtn.onclick = () => { zoom = +(Math.min(ZMAX, zoom+ZSTEP)).toFixed(2); setZoomRotate(); };
    zoutBtn.onclick = () => { zoom = +(Math.max(ZMIN, zoom-ZSTEP)).toFixed(2); setZoomRotate(); };
    rotBtn.onclick = () => { rotation = (rotation+90)%360; setZoomRotate(); };
    fitBtn.onclick = () => resetView();
    closeBtn.onclick = () => closeViewer();

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if (!viewer.classList.contains('show')) return;
      if (e.key==='Escape'){ closeViewer(); e.preventDefault(); }
      if (e.key==='+'||e.key==='='){ zinBtn.click(); e.preventDefault(); }
      if (e.key==='-'||e.key==='_'){ zoutBtn.click(); e.preventDefault(); }
      if (e.key.toLowerCase()==='r'){ rotBtn.click(); e.preventDefault(); }
      if (e.key.toLowerCase()==='f'){ fsBtn.click(); e.preventDefault(); }
      if (e.key==='0'){ fitBtn.click(); e.preventDefault(); }
    });

    // Trackpad zoom
    pagesWrap.addEventListener('wheel',(e)=>{
      if (!viewer.classList.contains('show')) return;
      if (e.ctrlKey){ e.preventDefault();
        const d = e.deltaY>0 ? -ZSTEP : ZSTEP;
        zoom = +(Math.min(ZMAX, Math.max(ZMIN, zoom+d))).toFixed(2); setZoomRotate();
      }
    }, {passive:false});

    /* =========================
       Deterrents & Watermark
       ========================= */
    window.print = function(){ alert('Printing is disabled.'); return false; };
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey||e.metaKey) && (e.key==='p'||e.key==='s')) { e.preventDefault(); alert('Blocked.'); }
    }, true);
    document.addEventListener('contextmenu', (e)=>{ e.preventDefault(); }, true);
    setInterval(()=>{ // refresh watermark time
      const now = new Date().toLocaleString();
      const who = userKey || 'SoMAp User';
      wmSmall.textContent = `SoMAp â€¢ ${who} â€¢ ${now}`;
    }, 30000);
  </script>
</body>
</html>
