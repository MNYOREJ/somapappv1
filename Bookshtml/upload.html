<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — MnyoreBooks Upload (Admin)</title>

  <style>
    :root{
      --bg:#f0f9ff; --card:#ffffff; --accent:#0ea5a4; --accent-2:#7c3aed;
      --muted:#6b7280; --success:#10b981; --danger:#ef4444;
      --joy-1: #ffedd5; --joy-2:#fff7ed; --joy-3:#eef2ff;
    }
    /* Reset & layout */
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:linear-gradient(180deg,#eef2ff, #f8fafc 40%); margin:0; padding:22px; color:#0f172a;}
    .container{max-width:1100px;margin:0 auto;}
    header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:20px;box-shadow:0 8px 30px rgba(124,58,237,0.12)}
    h1{margin:0;font-size:20px}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 12px 30px rgba(2,6,23,0.06);border:1px solid rgba(15,23,42,0.04)}
    label{display:block;font-size:13px;margin-bottom:8px;color:#0f172a}
    input[type="text"], select, .file-drop, textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #eef4fb;background:linear-gradient(180deg,#fff,#fbfdff);font-size:14px;box-sizing:border-box}
    .file-drop{min-height:120px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;text-align:center;cursor:pointer;border-style:dashed;border-color:rgba(14,165,164,0.12)}
    .row{display:flex;gap:12px}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;text-decoration:none;border:0;cursor:pointer;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:#0f172a;padding:9px 12px;border-radius:10px}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .progress{height:12px;background:#eef6f9;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,#ffd166,#f95d9b,#7c3aed);width:0%}
    .meta-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#f3f4f6;padding:6px 10px;border-radius:999px;font-size:12px;color:#111827}
    .success-box{border-left:4px solid var(--success);padding:10px;border-radius:8px;background:#f0fdf4;color:#064e3b;margin-top:12px;}
    .error-box{border-left:4px solid var(--danger);padding:10px;border-radius:8px;background:#fff1f2;color:#7f1d1d;margin-top:12px;}
    .info-row{display:flex;gap:8px;align-items:center}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--joy-3);font-weight:600;color:#3b82f6}
    .recent-list{max-height:260px;overflow:auto;margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .recent-item{padding:10px;border-radius:10px;background:linear-gradient(90deg,#ffffff,#fbfdff);border:1px solid #eef2f6;display:flex;align-items:center;justify-content:space-between}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}.container{padding:12px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">SoM</div>
      <div>
        <h1>Admin — Upload Book (MnyoreBooks)</h1>
        <p class="lead">Upload curriculum PDFs. Stored on Cloudinary, indexed in Firebase, and queued for auto-question generation. Teachers & parents will see books by class.</p>
      </div>
    </header>

    <div class="grid">
      <!-- MAIN CARD: Upload form -->
      <div class="card" id="mainCard">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
          <div class="info-row">
            <div class="tag">MnyoreBooks</div>
            <div class="small" style="margin-left:6px">Upload books & generate quizzes</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <div id="authArea" class="small muted">Sign-in required</div>
            <button id="signinBtn" class="btn-ghost" title="Sign in with Google">Sign in</button>
            <button id="signoutBtn" class="btn-ghost" style="display:none">Sign out</button>
          </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #eef2f7" />

        <h3 style="margin-top:0">1. Book details</h3>

        <div style="margin-top:8px">
          <label>Title</label>
          <input id="title" type="text" placeholder="e.g., Basic Mathematical Formulae (Class 3)" />

          <div class="row" style="margin-top:12px">
            <div style="flex:1">
              <label>Class</label>
              <select id="classSelect"></select>
            </div>

            <div style="width:220px">
              <label>Subject</label>
              <select id="subjectSelect"></select>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Edition / Year</label>
            <input id="edition" type="text" placeholder="e.g., 2025 (optional)" />
          </div>

          <div style="margin-top:12px">
            <label>Description (optional)</label>
            <textarea id="description" placeholder="Short notes for teachers/parents"></textarea>
          </div>
        </div>

        <hr style="margin:18px 0;border:none;border-top:1px solid #eef2f7" />

        <h3 style="margin-top:0">2. Choose PDF file</h3>

        <div class="file-drop" id="fileDrop">
          <div style="font-weight:700;color:var(--accent-2)">Drag & Drop PDF here</div>
          <div class="small">or click to browse — PDF only, max 50MB recommended</div>
          <input id="fileInput" type="file" accept="application/pdf" style="display:none" />
        </div>

        <div class="meta-row" id="selectedMeta" style="display:none;margin-top:10px">
          <div class="chip" id="fileName">Filename.pdf</div>
          <div class="chip" id="fileSize">0 MB</div>
          <div class="chip" id="fileType">PDF</div>
        </div>

        <div style="margin-top:12px">
          <label>Upload progress</label>
          <div class="progress"><i id="progressBar"></i></div>
        </div>

        <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
          <button class="btn" id="uploadBtn" disabled>Upload & Register Book</button>
          <button class="btn btn-ghost" id="clearBtn">Clear</button>
          <div style="margin-left:auto" class="muted">Logged as: <strong id="loggedEmail">not signed in</strong></div>
        </div>

        <div id="messages"></div>
      </div>

      <!-- SIDE CARD: Tools, Cloudinary, recent uploads -->
      <div class="card">
        <h3 style="margin-top:0">Admin Quick Tools</h3>

        <p class="small">Make sure your admin account (e.g., <code>socratesschool2020@gmail.com</code>) exists under <code>/users</code> with role &quot;admin&quot; in RTDB.</p>

        <div style="margin-top:12px">
          <label>Cloudinary settings</label>
          <input id="cloudName" type="text" placeholder="Cloud name (e.g., somap-cloud)" />
          <input id="uploadPreset" style="margin-top:8px" type="text" placeholder="Upload preset (unsigned)"/>
          <div class="small" style="margin-top:8px">Unsigned preset is easiest. For security create signed uploads later.</div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <div style="display:flex;gap:10px;flex-direction:column">
          <a class="btn btn-ghost" href="../dashboard.html" style="text-align:center">Go to Admin Dashboard</a>
          <a class="btn btn-ghost" href="list.html" style="text-align:center">Manage Books (list)</a>
          <a class="btn btn-ghost" href="../staff.html" style="text-align:center">Open Teacher Dashboard</a>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <h4 style="margin:8px 0 6px">Recent uploads</h4>
        <div class="recent-list" id="recentList"><div class="small muted">Loading…</div></div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <h4 style="margin:8px 0 6px">Notes</h4>
        <ul style="padding-left:18px;color:var(--muted);font-size:13px">
          <li>Uploads go to Cloudinary and metadata to Firebase Realtime DB under <code>/books</code>.</li>
          <li>After upload the parser webhook is called (if configured) to generate questions into <code>/questions/{bookId}</code>.</li>
          <li>Teachers will see new books filtered by their class in <code>staff.html</code>.</li>
        </ul>
      </div>
    </div>

    <footer>
      <div>SoMAp — MnyoreBooks • somapv2i.com</div>
      <div style="margin-top:6px">Created with ❤️ — press <strong>Sign in</strong> to begin</div>
    </footer>
  </div>

  <!-- your firebase.js should be present at ../firebase.js and initialize firebase app -->
  <script src="../firebase.js"></script>

  <script>
  (function(){
    // -------- CONFIG - set your webhook + api keys here ----------
    const PARSER_WEBHOOK = ""; // e.g. https://somap-parser.onrender.com/parse-book  (leave empty to skip)
    const PARSER_API_KEY = ""; // same key as configured in parser env
    const MAX_FILE_SIZE = 70 * 1024 * 1024; // 70MB limit

    // ---------- Class -> subjects mapping (your provided list, extended) ----------
    const SUBJECTS_BY_CLASS = {
      'Baby Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Pre-Unit': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Middle Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Class 1 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 1': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 2 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 2': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 3': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 4': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 5': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 6': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals'],
      'Class 7': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals']
    };

    // ---------- UI elements ----------
    const fileDrop = document.getElementById('fileDrop');
    const fileInput = document.getElementById('fileInput');
    const fileNameEl = document.getElementById('fileName');
    const fileSizeEl = document.getElementById('fileSize');
    const fileTypeEl = document.getElementById('fileType');
    const selectedMeta = document.getElementById('selectedMeta');
    const progressBar = document.getElementById('progressBar');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const messages = document.getElementById('messages');
    const cloudNameInput = document.getElementById('cloudName');
    const uploadPresetInput = document.getElementById('uploadPreset');
    const loggedEmail = document.getElementById('loggedEmail');
    const signinBtn = document.getElementById('signinBtn');
    const signoutBtn = document.getElementById('signoutBtn');
    const authArea = document.getElementById('authArea');
    const classSelect = document.getElementById('classSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const recentList = document.getElementById('recentList');

    let selectedFile = null;
    let currentUser = null;

    // ---------- helpers ----------
    function el(html){ const d=document.createElement('div'); d.innerHTML = html; return d.firstElementChild; }
    function showMessage(node){ messages.innerHTML=''; messages.appendChild(node); }
    function showSuccess(msg){ showMessage(el('<div class="success-box">'+msg+'</div>')); }
    function showError(msg){ showMessage(el('<div class="error-box">'+msg+'</div>')); }
    function setProgress(p){ progressBar.style.width = Math.max(0,Math.min(100,p)) + '%'; }
    function readableSize(bytes){ return (bytes/1024/1024).toFixed(2) + ' MB'; }

    // IMPORTANT: match your DB keys exactly: your DB uses e.g. "socratesschool2020@gmail_com"
    // that is: dot ('.') replaced with underscore '_' but the '@' remains.
    function normalizeEmailKey(email){
      if(!email) return '';
      return email.replace(/\./g, '_'); // DO NOT remove '@' since your DB keeps it
    }

    // populate class dropdown
    function populateClasses(){
      classSelect.innerHTML = '';
      const classes = Object.keys(SUBJECTS_BY_CLASS);
      classes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        classSelect.appendChild(opt);
      });
      // trigger initial populate for subject
      populateSubjects();
    }
    function populateSubjects(){
      const cls = classSelect.value;
      const subs = SUBJECTS_BY_CLASS[cls] || ['Other'];
      subjectSelect.innerHTML = '';
      subs.forEach(s => {
        const o = document.createElement('option'); o.value = s; o.textContent = s;
        subjectSelect.appendChild(o);
      });
    }
    classSelect.addEventListener('change', populateSubjects);

    // ---------- Drag & drop ----------
    fileDrop.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));
    ['dragenter','dragover'].forEach(ev=>fileDrop.addEventListener(ev,(e)=>{ e.preventDefault(); fileDrop.style.boxShadow='0 8px 24px rgba(124,58,237,0.12)'; }));
    ['dragleave','drop'].forEach(ev=>fileDrop.addEventListener(ev,(e)=>{ e.preventDefault(); fileDrop.style.boxShadow='none'; }));
    fileDrop.addEventListener('drop', (e)=> {
      const dt = e.dataTransfer;
      if(dt && dt.files) handleFiles(dt.files);
    });

    function handleFiles(files){
      if(!files || files.length===0) return;
      const f = files[0];
      if(!f.name.toLowerCase().endsWith('.pdf') && f.type !== 'application/pdf'){
        showError('Please choose a PDF file.');
        return;
      }
      if(f.size > MAX_FILE_SIZE){
        showError('File too large. Limit ' + readableSize(MAX_FILE_SIZE));
        return;
      }
      selectedFile = f;
      fileNameEl.textContent = f.name;
      fileSizeEl.textContent = readableSize(f.size);
      fileTypeEl.textContent = 'PDF';
      selectedMeta.style.display = 'flex';
      showMessage(el('<div class="small">Ready to upload. Fill details then click <strong>Upload & Register Book</strong>.</div>'));
    }

    // ---------- Firebase readiness & auth ----------
    function waitForFirebase(cb){
      if(typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0){
        cb(new Error('Firebase not loaded. Ensure ../firebase.js initializes Firebase.'));
        return;
      }
      cb(null);
    }

    waitForFirebase((err)=> {
      if(err){ showError(err.message); return; }
      // populate classes
      populateClasses();

      // try to prefill cloud settings from localStorage
      const cN = localStorage.getItem('cloudName'); const up = localStorage.getItem('uploadPreset');
      if(cN) cloudNameInput.value = cN;
      if(up) uploadPresetInput.value = up;

      // auth state listener
      firebase.auth().onAuthStateChanged(user => {
        if(!user){
          currentUser = null;
          loggedEmail.textContent = 'not signed in';
          authArea.innerHTML = 'Not signed in.';
          signinBtn.style.display = 'inline-block';
          signoutBtn.style.display = 'none';
          uploadBtn.disabled = true;
          return;
        }
        currentUser = user;
        loggedEmail.textContent = user.email;
        signinBtn.style.display = 'none';
        signoutBtn.style.display = 'inline-block';
        authArea.innerHTML = '<strong style="color:#0b5f5a">Signed in</strong>';

        // check role in RTDB
        const key = normalizeEmailKey(user.email);
        firebase.database().ref('users/'+key).once('value').then(snap=>{
          const data = snap.val();
          if(!data || data.role !== 'admin'){
            showError('Signed in but not an admin. Upload disabled for this account: ' + (user.email||''));
            uploadBtn.disabled = true;
            return;
          }
          showSuccess('Signed in as admin: ' + (user.email || ''));
          uploadBtn.disabled = false;
        }).catch(e=>{
          console.error(e);
          showError('Failed to read your role from Firebase. Check DB rules and connectivity.');
        });
      });

      // initialize recent uploads view
      renderRecentUploads();
    });

    // Sign-in / out handlers
    signinBtn.addEventListener('click', async ()=>{
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await firebase.auth().signInWithPopup(provider);
        // success will be handled by onAuthStateChanged
      }catch(e){
        console.error(e);
        showError('Sign-in failed: ' + (e.message||e));
      }
    });
    signoutBtn.addEventListener('click', async ()=>{
      try{ await firebase.auth().signOut(); showMessage(el('<div class="small">Signed out.</div>')); } catch(e){ console.error(e); showError('Sign out failed'); }
    });

    // ---------- Upload flow ----------
    uploadBtn.addEventListener('click', async function(){
      if(!currentUser){ showError('Not signed in. Please sign-in with admin Gmail.'); return; }
      if(!selectedFile){ showError('Please choose a PDF file first.'); return; }

      const title = document.getElementById('title').value.trim();
      const className = classSelect.value;
      const subject = subjectSelect.value;
      const edition = document.getElementById('edition').value.trim();
      const description = document.getElementById('description').value.trim();
      const cloudName = cloudNameInput.value.trim();
      const uploadPreset = uploadPresetInput.value.trim();

      if(!title) { showError('Please enter a book title.'); return; }
      if(!cloudName || !uploadPreset) { showError('Enter Cloudinary cloud name and upload preset in right column.'); return; }

      // store cloud settings locally
      localStorage.setItem('cloudName', cloudName);
      localStorage.setItem('uploadPreset', uploadPreset);

      uploadBtn.disabled = true; clearBtn.disabled = true;
      setProgress(0);
      showMessage(el('<div class="small">Uploading to Cloudinary…</div>'));

      try{
        // upload to Cloudinary (unsigned)
        const form = new FormData();
        form.append('file', selectedFile);
        form.append('upload_preset', uploadPreset);

        const cloudUrl = `https://api.cloudinary.com/v1_1/${encodeURIComponent(cloudName)}/auto/upload`;
        const xhr = new XMLHttpRequest();
        xhr.open('POST', cloudUrl, true);

        xhr.upload.onprogress = function(e){
          if(e.lengthComputable){
            setProgress(Math.round((e.loaded / e.total) * 100));
          }
        };

        const uploadResult = await new Promise((resolve,reject)=>{
          xhr.onload = function(){
            if(xhr.status >=200 && xhr.status < 300){
              try{ resolve(JSON.parse(xhr.responseText)); } catch(err){ reject(err); }
            } else { reject(new Error('Cloudinary upload failed: '+xhr.status+' '+xhr.statusText+' '+xhr.responseText)); }
          };
          xhr.onerror = ()=> reject(new Error('Network error during upload.'));
          xhr.send(form);
        });

        const secureUrl = uploadResult.secure_url || uploadResult.url;
        const publicId = uploadResult.public_id || '';
        if(!secureUrl) throw new Error('Cloudinary did not return secure_url.');

        setProgress(75);
        showMessage(el('<div class="small">Saving metadata to Firebase…</div>'));

        const bookMeta = {
          title, class: className, subject, edition: edition || '', description: description || '',
          url: secureUrl, cloudinary_public_id: publicId,
          uploadedBy: normalizeEmailKey(currentUser.email),
          uploadedByEmail: currentUser.email,
          uploadedAt: Date.now(),
          paid: 0, required: 0
        };

        // push to /books
        const newBookRef = await firebase.database().ref('books').push(bookMeta);
        const bookId = newBookRef.key;

        // notify teachers for that class (non-blocking)
        try{
          const usersSnap = await firebase.database().ref('users').once('value');
          const users = usersSnap.val() || {};
          const notified = [];
          Object.keys(users).forEach(k => {
            const u = users[k];
            if(u && u.role === 'teacher' && u.class && u.class === className){
              // push notification under /notifications/{teacherKey}
              firebase.database().ref(`notifications/${k}`).push({
                type: 'new-book',
                bookId,
                title,
                class: className,
                subject,
                time: Date.now()
              });
              notified.push(k);
            }
          });
          // also store notified list on book node
          await firebase.database().ref(`books/${bookId}/notifiedTo`).set(notified);
        }catch(notifyErr){
          console.warn('Notify teachers failed', notifyErr);
        }

        // trigger parser webhook (if configured)
        if(PARSER_WEBHOOK){
          try{
            await fetch(PARSER_WEBHOOK, {
              method: 'POST',
              headers: {'Content-Type':'application/json','x-api-key': PARSER_API_KEY || ''},
              body: JSON.stringify({bookId, cloudinaryUrl: secureUrl, metadata: bookMeta}),
              keepalive: true
            });
          }catch(parseErr){
            console.warn('Parser webhook error', parseErr);
            firebase.database().ref('book_parser_errors').push({bookId, error: (parseErr.message || ''+parseErr), time: Date.now()});
          }
        }

        setProgress(100);
        showSuccess(`Uploaded & registered book <strong>${title}</strong> for <strong>${className}</strong>. Book ID: <code>${bookId}</code>`);

        // reset form but keep cloud settings
        selectedFile = null; selectedMeta.style.display = 'none';
        document.getElementById('title').value = '';
        document.getElementById('edition').value = '';
        document.getElementById('description').value = '';

        // refresh recent list
        renderRecentUploads();

      }catch(err){
        console.error(err);
        showError('Upload failed: ' + (err.message || err));
      } finally {
        uploadBtn.disabled = false; clearBtn.disabled = false;
        setTimeout(()=> setProgress(0), 1200);
      }
    });

    // Clear
    clearBtn.addEventListener('click', ()=> {
      selectedFile = null; selectedMeta.style.display = 'none'; fileInput.value = '';
      messages.innerHTML = '';
      setProgress(0);
    });

    // recent uploads loader (simple)
    async function renderRecentUploads(){
      recentList.innerHTML = '<div class="small muted">Loading…</div>';
      try{
        const snap = await firebase.database().ref('books').orderByChild('uploadedAt').limitToLast(20).once('value');
        const books = snap.val() || {};
        recentList.innerHTML = '';
        const keys = Object.keys(books).reverse(); // most recent first
        if(keys.length === 0){
          recentList.innerHTML = '<div class="small muted">No uploads yet</div>';
          return;
        }
        keys.forEach(k => {
          const b = books[k];
          const item = document.createElement('div');
          item.className = 'recent-item';
          item.innerHTML = `<div style="max-width:70%"><strong style="font-size:14px">${b.title||'(untitled)'}</strong><div class="small muted">${b.class||''} • ${b.subject||''}</div></div>
            <div style="display:flex;gap:8px;align-items:center"><a class="btn btn-ghost" href="${b.url}" target="_blank">Open</a></div>`;
          recentList.appendChild(item);
        });
      }catch(e){
        console.error(e); recentList.innerHTML = '<div class="small muted">Failed to load recent uploads</div>';
      }
    }

    // Initialize UI
    populateClasses();
    renderRecentUploads();

    // expose a small debug helper: show firebase user in console
    window.somapDebug = { normalizeEmailKey, renderRecentUploads };

  })();
  </script>
</body>
</html>
