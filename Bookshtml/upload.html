<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — MnyoreBooks Upload (Admin)</title>

  <!-- Tailwind for quick, clean styling (no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase v9 compat SDKs (match your project) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <!-- Load your existing firebase.js (must be located at ../firebase.js relative to Bookshtml/) -->
  <script src="../firebase.js"></script>

  <style>
    html,body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,#eef2ff, #f8fafc 40%); margin:0; padding:28px; color:#07203b; }
    .card { background:white; border-radius:14px; padding:18px; box-shadow:0 12px 30px rgba(2,6,23,0.06); border:1px solid rgba(15,23,42,0.04); }
    .file-drop { min-height:120px; display:flex; gap:10px; align-items:center; justify-content:center; flex-direction:column; border:2px dashed rgba(124,58,237,0.12); border-radius:12px; cursor:pointer; background: linear-gradient(180deg,#fff,#fbfdff); }
    .muted { color:#6b7280; font-size:13px; }
    .small { font-size:12px; color:#6b7280; }
    .chip { background:#f3f4f6; padding:6px 8px; border-radius:999px; font-size:12px; color:#111827; display:inline-block; }
    .progress { height:12px; background:#eef6fb; border-radius:999px; overflow:hidden; }
    .progress > i { display:block; height:100%; background: linear-gradient(90deg,#ffd166,#f95d9b,#7c3aed); width:0%; transition: width 250ms ease; }
    .success-box { border-left:4px solid #10b981; padding:10px; border-radius:8px; background:#f0fdf4; color:#064e3b; }
    .error-box { border-left:4px solid #ef4444; padding:10px; border-radius:8px; background:#fff1f2; color:#7f1d1d; }
    @media (max-width: 980px) { .grid-cols-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto">
    <header style="display:flex;align-items:center;gap:14px;margin-bottom:18px;">
      <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#0ea5a4,#7c3aed);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:20px;box-shadow:0 8px 20px rgba(124,58,237,0.12);">SoM</div>
      <div>
        <h1 style="margin:0;font-size:20px;">Admin — Upload Book (MnyoreBooks)</h1>
        <p class="muted" style="margin:4px 0 0;">Upload PDFs here to Cloudinary. Metadata is saved to Firebase RTDB under <code>/books</code>. After upload the parser webhook is triggered (if configured).</p>
      </div>
    </header>

    <div class="grid grid-cols-2 gap-6">
      <!-- LEFT: Upload form -->
      <div class="card">
        <h3 style="margin:0 0 10px 0">1. Book details</h3>

        <div style="margin-top:10px">
          <label class="small">Title</label>
          <input id="title" type="text" placeholder="e.g., Basic Mathematical Formulae" class="w-full px-3 py-2 rounded-md border mt-1" />

          <div class="flex gap-3 mt-3">
            <div style="flex:1">
              <label class="small">Class</label>
              <select id="classSelect" class="w-full px-3 py-2 rounded-md border mt-1"></select>
            </div>

            <div style="width:210px">
              <label class="small">Subject</label>
              <select id="subjectSelect" class="w-full px-3 py-2 rounded-md border mt-1"></select>
            </div>
          </div>

          <div style="margin-top:12px">
            <label class="small">Edition / Year</label>
            <input id="edition" type="text" placeholder="e.g., 2025 (optional)" class="w-full px-3 py-2 rounded-md border mt-1" />
          </div>

          <div style="margin-top:12px">
            <label class="small">Description (optional)</label>
            <textarea id="description" placeholder="Short notes for teachers/parents" class="w-full px-3 py-2 rounded-md border mt-1"></textarea>
          </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #eef2f7" />

        <h3 style="margin:0 0 10px 0">2. Choose PDF file</h3>

        <div id="fileDrop" class="file-drop" title="Click or drag and drop PDF">
          <div style="font-weight:700;color:#7c3aed">Drag & Drop PDF here</div>
          <div class="small">or click to browse — PDF only, max 70MB recommended</div>
          <input id="fileInput" type="file" accept="application/pdf" style="display:none" />
        </div>

        <div id="selectedMeta" class="mt-3" style="display:none">
          <span class="chip" id="fileName">Filename.pdf</span>
          <span class="chip" id="fileSize">0 MB</span>
          <span class="chip" id="fileType">PDF</span>
        </div>

        <div style="margin-top:12px">
          <label class="small">Upload progress</label>
          <div class="progress mt-2"><i id="progressBar"></i></div>
        </div>

        <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
          <button id="uploadBtn" class="px-4 py-2 rounded-md font-bold text-white" style="background:linear-gradient(90deg,#0ea5a4,#7c3aed)" disabled>Upload & Register Book</button>
          <button id="clearBtn" class="px-3 py-2 rounded-md border">Clear</button>
          <div style="margin-left:auto" class="muted">Logged as: <strong id="loggedEmail">not signed in</strong></div>
        </div>

        <div id="messages" style="margin-top:12px"></div>

        <div style="margin-top:12px" class="small muted">Note: Signing is handled at app start. If you're logged in to the main app as admin you can upload here. If the page says "not signed in", go to the main dashboard and sign in first.</div>
      </div>

      <!-- RIGHT: Tools & Recent uploads -->
      <div class="card">
        <h3 style="margin:0 0 10px 0">Admin Quick Tools</h3>

        <p class="small">Cloudinary & parser settings — saved locally for convenience.</p>

        <div style="margin-top:10px">
          <label class="small">Cloudinary cloud name</label>
          <input id="cloudName" placeholder="e.g., somap-cloud" class="w-full px-3 py-2 rounded-md border mt-1" />

          <label class="small" style="margin-top:8px">Upload preset (unsigned)</label>
          <input id="uploadPreset" placeholder="unsigned_preset_name" class="w-full px-3 py-2 rounded-md border mt-1" />

          <label class="small" style="margin-top:8px">Parser webhook (optional)</label>
          <input id="parserWebhook" placeholder="https://your-parser.onrender.com/parse-book" class="w-full px-3 py-2 rounded-md border mt-1" />

          <label class="small" style="margin-top:8px">Parser API Key (optional)</label>
          <input id="parserApiKey" placeholder="secret-api-key" class="w-full px-3 py-2 rounded-md border mt-1" />
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <h4 style="margin:8px 0 6px">Recent uploads</h4>
        <div id="recentList" style="max-height:360px; overflow:auto; display:flex; flex-direction:column; gap:8px;">
          <div class="small muted">Loading…</div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <h4 style="margin:8px 0 6px">Notes</h4>
        <ul style="padding-left:18px;color:#6b7280;font-size:13px">
          <li>Uploads saved to <code>/books/{bookId}</code> and indexed by class under <code>/class_books/{class}/{bookId}</code>.</li>
          <li>Parser webhook is optional. If set, it will be called after a successful upload.</li>
          <li>Teachers are notified via <code>/notifications/{teacherKey}</code> if users have been configured with role "teacher".</li>
        </ul>
      </div>
    </div>

    <footer style="margin-top:18px;text-align:center;color:#6b7280;font-size:13px">SoMAp — MnyoreBooks • somapv2i.com</footer>
  </div>

  <script>
  (function(){
    /* ---------------- CONFIG ---------------- */
    const MAX_FILE_SIZE = 70 * 1024 * 1024; // 70MB
    // Default parser values (can be overwritten from right column inputs)
    let PARSER_WEBHOOK = "";
    let PARSER_API_KEY = "";

    /* ---------- SUBJECTS BY CLASS (your curriculum mapping) ---------- */
    const SUBJECTS_BY_CLASS = {
      'Baby Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Pre-Unit': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Middle Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Class 1 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 1': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 2 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 2': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 3': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 4': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 5': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 6': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals'],
      'Class 7': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals']
    };

    /* ---------- DOM ---------- */
    const fileDrop = document.getElementById('fileDrop');
    const fileInput = document.getElementById('fileInput');
    const fileNameEl = document.getElementById('fileName');
    const fileSizeEl = document.getElementById('fileSize');
    const fileTypeEl = document.getElementById('fileType');
    const selectedMeta = document.getElementById('selectedMeta');
    const progressBar = document.getElementById('progressBar');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const messages = document.getElementById('messages');
    const cloudNameInput = document.getElementById('cloudName');
    const uploadPresetInput = document.getElementById('uploadPreset');
    const parserWebhookInput = document.getElementById('parserWebhook');
    const parserApiKeyInput = document.getElementById('parserApiKey');
    const recentList = document.getElementById('recentList');

    const classSelect = document.getElementById('classSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const titleInput = document.getElementById('title');
    const editionInput = document.getElementById('edition');
    const descriptionInput = document.getElementById('description');
    const loggedEmail = document.getElementById('loggedEmail');

    let selectedFile = null;
    let currentUser = null;

    /* ---------- Helpers ---------- */
    function el(html){ const d=document.createElement('div'); d.innerHTML = html; return d.firstElementChild; }
    function showMessage(node){ messages.innerHTML = ''; messages.appendChild(node); }
    function showSuccess(msg){ showMessage(el('<div class="success-box">'+msg+'</div>')); }
    function showError(msg){ showMessage(el('<div class="error-box">'+msg+'</div>')); }
    function setProgress(p){ progressBar.style.width = Math.max(0,Math.min(100,p)) + '%'; }
    function readableSize(bytes){ return (bytes/1024/1024).toFixed(2) + ' MB'; }
    function normalizeEmailKey(email){ if(!email) return ''; return email.replace(/\./g,'_'); } // keep '@'

    /* ---------- Populate class & subject selects ---------- */
    function populateClasses(){
      classSelect.innerHTML = '';
      const classes = Object.keys(SUBJECTS_BY_CLASS);
      classes.forEach(c => {
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c;
        classSelect.appendChild(opt);
      });
      // initial populate subjects
      populateSubjects();
    }

    function populateSubjects(){
      const cls = classSelect.value;
      const subs = SUBJECTS_BY_CLASS[cls] || ['Other'];
      subjectSelect.innerHTML = '';
      subs.forEach(s => {
        const o = document.createElement('option'); o.value = s; o.textContent = s;
        subjectSelect.appendChild(o);
      });
    }
    classSelect.addEventListener('change', populateSubjects);

    /* ---------- Drag & Drop ---------- */
    fileDrop.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));
    ['dragenter','dragover'].forEach(ev=>fileDrop.addEventListener(ev,(e)=>{ e.preventDefault(); fileDrop.style.boxShadow='0 8px 24px rgba(124,58,237,0.12)'; }));
    ['dragleave','drop'].forEach(ev=>fileDrop.addEventListener(ev,(e)=>{ e.preventDefault(); fileDrop.style.boxShadow='none'; }));
    fileDrop.addEventListener('drop', (e)=> {
      const dt = e.dataTransfer;
      if(dt && dt.files) handleFiles(dt.files);
    });

    function handleFiles(files){
      if(!files || files.length===0) return;
      const f = files[0];
      if(!f.name.toLowerCase().endsWith('.pdf') && f.type !== 'application/pdf'){
        showError('Please upload a PDF file.');
        return;
      }
      if(f.size > MAX_FILE_SIZE){
        showError('File too large. Keep file under ' + readableSize(MAX_FILE_SIZE));
        return;
      }
      selectedFile = f;
      document.getElementById('fileName').textContent = f.name;
      document.getElementById('fileSize').textContent = readableSize(f.size);
      document.getElementById('fileType').textContent = 'PDF';
      selectedMeta.style.display = 'flex';
      showMessage(el('<div class="small">Ready to upload. Fill book details then click <strong>Upload & Register Book</strong>.</div>'));
    }

    /* ---------- Firebase readiness & role check ---------- */
    function waitForFirebase(cb){
      if(typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0){
        cb(new Error('Firebase not loaded. Ensure ../firebase.js initializes Firebase (compat).'));
        return;
      }
      // Also verify db handle exists
      if(!window.db || !window.storage){
        // If your firebase.js doesn't expose window.db/window.storage, fallback to compat calls
        try { window.db = firebase.database(); window.storage = firebase.storage(); } catch(e){ /* ignore */ }
      }
      cb(null);
    }

    waitForFirebase((err)=>{
      if(err){ showError(err.message); disableAll(); return; }
      // populate classes/subjects
      populateClasses();
      // restore local cloud settings
      const cN = localStorage.getItem('cloudName'); const up = localStorage.getItem('uploadPreset');
      const ph = localStorage.getItem('parserWebhook'); const pak = localStorage.getItem('parserApiKey');
      if(cN) cloudNameInput.value = cN;
      if(up) uploadPresetInput.value = up;
      if(ph) parserWebhookInput.value = ph;
      if(pak) parserApiKeyInput.value = pak;
      PARSER_WEBHOOK = parserWebhookInput.value || "";
      PARSER_API_KEY = parserApiKeyInput.value || "";

      // auth state
      firebase.auth().onAuthStateChanged(user=>{
        if(!user){ currentUser = null; loggedEmail.textContent = 'not signed in'; disableAll(); return; }
        currentUser = user;
        loggedEmail.textContent = user.email;
        // check admin role in RTDB
        const key = normalizeEmailKey(user.email);
        firebase.database().ref('users/'+key).once('value').then(snap=>{
          const data = snap.val();
          if(!data || data.role !== 'admin'){
            showError('Signed in but not an admin. Upload disabled for ' + user.email);
            disableAll();
            return;
          }
          showSuccess('Signed in as admin: ' + user.email);
          enableUploadUI();
        }).catch(e=>{
          console.error(e);
          showError('Failed to read user role from database.');
          disableAll();
        });
      });

      // listen for changes in cloud/parser inputs
      cloudNameInput.addEventListener('change', ()=> localStorage.setItem('cloudName', cloudNameInput.value.trim()));
      uploadPresetInput.addEventListener('change', ()=> localStorage.setItem('uploadPreset', uploadPresetInput.value.trim()));
      parserWebhookInput.addEventListener('change', ()=> { localStorage.setItem('parserWebhook', parserWebhookInput.value.trim()); PARSER_WEBHOOK = parserWebhookInput.value.trim(); });
      parserApiKeyInput.addEventListener('change', ()=> { localStorage.setItem('parserApiKey', parserApiKeyInput.value.trim()); PARSER_API_KEY = parserApiKeyInput.value.trim(); });

      // initial recent list load
      renderRecentUploads();
    });

    function disableAll(){
      uploadBtn.disabled = true; clearBtn.disabled = false;
      // Keep inputs editable for admin to set cloud config even if not signed
      // but prevent upload until admin signs in
    }
    function enableUploadUI(){
      uploadBtn.disabled = false; clearBtn.disabled = false;
    }

    /* ---------- Upload flow ---------- */
    uploadBtn.addEventListener('click', async ()=>{
      if(!currentUser){ showError('Not signed in. Sign in from main app then return to upload page.'); return; }
      if(!selectedFile){ showError('Choose a PDF file first.'); return; }

      const title = titleInput.value.trim();
      const cls = classSelect.value;
      const subject = subjectSelect.value;
      const edition = editionInput.value.trim();
      const description = descriptionInput.value.trim();
      const cloudName = cloudNameInput.value.trim() || localStorage.getItem('cloudName') || "";
      const uploadPreset = uploadPresetInput.value.trim() || localStorage.getItem('uploadPreset') || "";

      if(!title){ showError('Please enter book title.'); return; }
      if(!cls){ showError('Please select class.'); return; }
      if(!subject){ showError('Please select subject.'); return; }
      if(!cloudName || !uploadPreset){ showError('Set Cloudinary cloud name and upload preset on the right.'); return; }

      // save settings locally
      localStorage.setItem('cloudName', cloudName);
      localStorage.setItem('uploadPreset', uploadPreset);

      // disable UI
      uploadBtn.disabled = true; clearBtn.disabled = true;
      setProgress(0);
      showMessage(el('<div class="small">Starting upload to Cloudinary…</div>'));

      try{
        // 1) Upload to Cloudinary unsigned
        const form = new FormData();
        form.append('file', selectedFile);
        form.append('upload_preset', uploadPreset);

        const cloudUrl = `https://api.cloudinary.com/v1_1/${encodeURIComponent(cloudName)}/auto/upload`;

        // XHR for progress
        const xhr = new XMLHttpRequest();
        xhr.open('POST', cloudUrl, true);

        xhr.upload.onprogress = function(e){
          if(e.lengthComputable){
            const percent = Math.round((e.loaded / e.total) * 100);
            setProgress(percent);
          }
        };

        const uploadResult = await new Promise((resolve,reject)=>{
          xhr.onload = function(){
            if(xhr.status >= 200 && xhr.status < 300){
              try{ resolve(JSON.parse(xhr.responseText)); } catch(err){ reject(err); }
            } else {
              reject(new Error('Cloudinary upload failed: ' + xhr.status + ' ' + xhr.statusText + ' — ' + xhr.responseText));
            }
          };
          xhr.onerror = function(){ reject(new Error('Network error during upload.')); };
          xhr.send(form);
        });

        const cloudData = uploadResult;
        const secureUrl = cloudData.secure_url || cloudData.url;
        const publicId = cloudData.public_id || '';

        if(!secureUrl) throw new Error('Cloudinary did not return a secure URL.');

        setProgress(70);
        showMessage(el('<div class="small">Saving metadata to Firebase…</div>'));

        // 2) Save metadata into RTDB under /books
        const bookMeta = {
          title: title,
          class: cls,
          subject: subject,
          edition: edition || '',
          description: description || '',
          url: secureUrl,
          cloudinary_public_id: publicId,
          uploadedBy: normalizeEmailKey(currentUser.email),
          uploadedByEmail: currentUser.email,
          uploadedAt: Date.now(),
          paid: 0,
          required: 0
        };

        const newBookRef = await firebase.database().ref('books').push(bookMeta);
        const bookId = newBookRef.key;

        // 3) Index by class for quick lookup by parent/staff pages
        try {
          await firebase.database().ref(`class_books/${encodeURIComponent(cls)}/${bookId}`).set({
            title: title,
            subject: subject,
            url: secureUrl,
            uploadedAt: Date.now()
          });
        } catch(err) {
          console.warn('Failed to index class_books', err);
        }

        // 4) Notify teachers for that class (if users exist)
        try {
          const usersSnap = await firebase.database().ref('users').once('value');
          const users = usersSnap.val() || {};
          const notified = [];
          for(const userKey of Object.keys(users)){
            const u = users[userKey];
            if(u && u.role === 'teacher' && u.class && u.class === cls){
              // push notification
              await firebase.database().ref(`notifications/${userKey}`).push({
                type: 'new-book',
                bookId,
                title,
                subject,
                class: cls,
                time: Date.now()
              });
              notified.push(userKey);
            }
          }
          // store notified list on book node
          await firebase.database().ref(`books/${bookId}/notifiedTo`).set(notified);
        } catch(notifyErr){
          console.warn('Failed to notify teachers', notifyErr);
        }

        // 5) Trigger parser webhook (non-blocking)
        PARSER_WEBHOOK = parserWebhookInput.value.trim() || PARSER_WEBHOOK;
        PARSER_API_KEY = parserApiKeyInput.value.trim() || PARSER_API_KEY;
        if(PARSER_WEBHOOK){
          try {
            await fetch(PARSER_WEBHOOK, {
              method: 'POST',
              headers: {'Content-Type':'application/json', 'x-api-key': PARSER_API_KEY || ''},
              body: JSON.stringify({ bookId, cloudinaryUrl: secureUrl, metadata: bookMeta }),
              keepalive: true
            });
          } catch(parserErr){
            // log parser trigger error to DB for manual retry
            console.warn('Parser webhook failed (non-fatal):', parserErr);
            await firebase.database().ref('book_parser_errors').push({ bookId, error: '' + (parserErr.message || parserErr), time: Date.now() });
          }
        }

        setProgress(100);
        showSuccess(`Uploaded & registered book: <strong>${title}</strong>. Available to <strong>${cls}</strong>. Book ID: <code>${bookId}</code>`);

        // Append quick actions below
        const actions = document.createElement('div');
        actions.style.marginTop = '10px';
        actions.innerHTML = `
          <div class="small">Actions</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <a class="chip" href="../Bookshtml/list.html?bookId=${bookId}" target="_blank">Manage Book</a>
            <a class="chip" href="../Bookshtml/staffbooks.html" target="_blank">Open Teacher Books</a>
            <a class="chip" href="../parent.html" target="_blank">Open Parent Dashboard</a>
            <button class="chip" id="rerun_${bookId}">Re-run parser</button>
          </div>
        `;
        messages.appendChild(actions);

        // attach re-run parser click
        const rerunBtn = document.getElementById(`rerun_${bookId}`);
        if(rerunBtn){
          rerunBtn.addEventListener('click', async ()=>{
            if(!PARSER_WEBHOOK){ showError('Parser webhook not configured.'); return; }
            try {
              await fetch(PARSER_WEBHOOK, {
                method:'POST',
                headers:{'Content-Type':'application/json','x-api-key':PARSER_API_KEY||''},
                body: JSON.stringify({ bookId, cloudinaryUrl: secureUrl, metadata: bookMeta })
              });
              showSuccess('Parser re-run requested.');
            } catch(e){ console.error(e); showError('Failed to request parser re-run.'); }
          });
        }

        // Reset form (keep cloud settings)
        selectedFile = null; selectedMeta.style.display = 'none';
        titleInput.value = ''; editionInput.value = ''; descriptionInput.value = '';
        fileInput.value = '';

        // refresh recent uploads
        renderRecentUploads();

      } catch(err){
        console.error(err);
        showError('Upload failed: ' + (err.message || err));
      } finally {
        uploadBtn.disabled = false; clearBtn.disabled = false;
        setTimeout(()=> setProgress(0), 1200);
      }
    });

    // Clear
    clearBtn.addEventListener('click', ()=> {
      selectedFile = null; selectedMeta.style.display = 'none'; fileInput.value = '';
      messages.innerHTML = ''; setProgress(0);
    });

    /* ---------- Recent uploads (live) ---------- */
    async function renderRecentUploads(){
      recentList.innerHTML = '<div class="small muted">Loading…</div>';
      try{
        const snap = await firebase.database().ref('books').orderByChild('uploadedAt').limitToLast(30).once('value');
        const books = snap.val() || {};
        recentList.innerHTML = '';
        const pairs = Object.entries(books).sort((a,b)=> (b[1].uploadedAt||0) - (a[1].uploadedAt||0));
        if(pairs.length === 0){ recentList.innerHTML = '<div class="small muted">No uploads yet</div>'; return; }
        pairs.forEach(([id,b])=>{
          const item = document.createElement('div');
          item.style.display = 'flex'; item.style.justifyContent='space-between'; item.style.alignItems='center';
          item.style.padding = '8px'; item.style.borderRadius = '8px'; item.style.background = '#fff';
          item.style.border = '1px solid #eef2f7';
          item.innerHTML = `<div style="max-width:70%"><strong>${b.title || '(untitled)'}</strong><div class="small muted">${b.class || ''} • ${b.subject || ''}</div></div>
            <div style="display:flex;gap:8px;align-items:center">
              <a class="chip" href="${b.url}" target="_blank">Open</a>
              <button class="chip" data-bookid="${id}" data-url="${b.url}">Details</button>
            </div>`;
          recentList.appendChild(item);

          // details pop
          const btn = item.querySelector('button[data-bookid]');
          btn.addEventListener('click', ()=> {
            alert(`Book ID: ${id}\nTitle: ${b.title}\nClass: ${b.class}\nSubject: ${b.subject}\nUploaded by: ${b.uploadedByEmail || b.uploadedBy}\nUploadedAt: ${new Date(b.uploadedAt||0).toLocaleString()}`);
          });
        });
      }catch(e){
        console.error(e);
        recentList.innerHTML = '<div class="small muted">Failed to load recent uploads</div>';
      }
    }

    /* ---------- expose debug helper ---------- */
    window.somapUploadDebug = {
      populateClasses, populateSubjects, renderRecentUploads, normalizeEmailKey
    };

  })();
  </script>
</body>
</html>
