<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — MnyoreBooks Upload (Admin)</title>

  <!-- Simple, cheerful CSS (no external CDN dependencies) -->
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --accent:#0ea5a4; --accent-2:#7c3aed;
      --muted:#6b7280; --success:#10b981; --danger:#ef4444;
    }
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#eef2ff, #f8fafc 40%); margin:0; padding:24px; color:#0f172a;}
    .container{max-width:980px; margin:0 auto;}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px;}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;box-shadow:0 6px 18px rgba(124,58,237,0.12);}
    h1{margin:0;font-size:20px;}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px;}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 24px rgba(2,6,23,0.06);border:1px solid rgba(15,23,42,0.03);}
    label{display:block;font-size:13px;margin-bottom:6px;color:#0f172a}
    input[type="text"], select, .file-drop{
      width:100%; padding:10px 12px;border-radius:8px;border:1px solid #e6eef6;background:linear-gradient(180deg,#fff,#fbfdff);font-size:14px;box-sizing:border-box;
    }
    textarea{width:100%;min-height:90px;padding:10px;border-radius:8px;border:1px solid #e6eef6;}
    .row{display:flex;gap:12px;}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:white;text-decoration:none;border:0;cursor:pointer;font-weight:600}
    .btn-ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:#0f172a}
    .muted{color:var(--muted);font-size:13px}
    .file-drop{min-height:120px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;text-align:center;cursor:pointer}
    .small{font-size:12px;color:var(--muted)}
    .progress{height:10px;background:#eef2f7;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
    .meta-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#f3f4f6;padding:6px 8px;border-radius:999px;font-size:12px;color:#111827}
    .success-box{border-left:4px solid var(--success);padding:10px;border-radius:8px;background:#f0fdf4;color:#064e3b;margin-top:12px;}
    .error-box{border-left:4px solid var(--danger);padding:10px;border-radius:8px;background:#fff1f2;color:#7f1d1d;margin-top:12px;}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    @media(max-width:920px){.grid{grid-template-columns:1fr;}.container{padding:0 12px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">SoM</div>
      <div>
        <h1>Admin — Upload Book (MnyoreBooks)</h1>
        <p class="lead">Upload PDFs here. They will be stored in Cloudinary, registered in Firebase, and automatically queued for question generation. Teachers will see the books for their class in <code>staff.html</code>.</p>
      </div>
    </header>

    <div class="grid">
      <!-- MAIN CARD: Upload form -->
      <div class="card" id="mainCard">
        <h3 style="margin-top:0">1. Book details</h3>

        <div style="margin-top:12px">
          <label>Title</label>
          <input id="title" type="text" placeholder="e.g., Basic Mathematical Formulae" />

          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1">
              <label>Class</label>
              <select id="classSelect">
                <!-- classes mapped from your project -->
                <option>Baby Class</option>
                <option>Pre-Unit</option>
                <option>Middle Class</option>
                <option>Class 1 AB</option>
                <option>Class 2 AB</option>
                <option>Class 3</option>
                <option>Class 4</option>
                <option>Class 5</option>
                <option>Class 6</option>
                <option>Class 7</option>
              </select>
            </div>

            <div style="width:160px">
              <label>Subject</label>
              <select id="subjectSelect">
                <option>Mathematics</option>
                <option>English</option>
                <option>Kiswahili</option>
                <option>Science</option>
                <option>Social Studies</option>
                <option>Arts</option>
                <option>Health</option>
                <option>Sports</option>
                <option>Other</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Edition / Year</label>
            <input id="edition" type="text" placeholder="e.g., 2025 (optional)" />
          </div>

          <div style="margin-top:12px">
            <label>Description (optional)</label>
            <textarea id="description" placeholder="Short description or notes for teachers/parents"></textarea>
          </div>
        </div>

        <hr style="margin:18px 0;border:none;border-top:1px solid #eef2f7" />

        <h3 style="margin-top:0">2. Choose PDF file</h3>

        <div class="file-drop" id="fileDrop">
          <div style="font-weight:700;color:var(--accent-2)">Drag & Drop PDF here</div>
          <div class="small">or click to browse — PDF only, max 50MB recommended</div>
          <input id="fileInput" type="file" accept="application/pdf" style="display:none" />
        </div>

        <div class="meta-row" id="selectedMeta" style="display:none">
          <div class="chip" id="fileName">Filename.pdf</div>
          <div class="chip" id="fileSize">0 MB</div>
          <div class="chip" id="fileType">PDF</div>
        </div>

        <div style="margin-top:12px">
          <label>Upload progress</label>
          <div class="progress"><i id="progressBar"></i></div>
        </div>

        <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
          <button class="btn" id="uploadBtn">Upload & Register Book</button>
          <button class="btn btn-ghost" id="clearBtn">Clear</button>
          <div style="margin-left:auto" class="muted">Logged as: <strong id="loggedEmail">not signed in</strong></div>
        </div>

        <div id="messages"></div>

      </div>

      <!-- SIDE CARD: Tips, settings, quick links -->
      <div class="card">
        <h3 style="margin-top:0">Admin Quick Tools</h3>

        <p class="small">Ensure you are signed-in as an admin Gmail listed under <code>/users</code> in Firebase.</p>

        <div style="margin-top:12px">
          <label>Cloudinary settings</label>
          <input id="cloudName" type="text" placeholder="Cloud name (e.g., somap-cloud)" />
          <input id="uploadPreset" style="margin-top:8px" type="text" placeholder="Upload preset (unsigned)"/>
          <div class="small" style="margin-top:8px">We support unsigned uploads for convenience. For better security, create a signed upload server later.</div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <div style="display:flex;gap:10px;flex-direction:column">
          <a class="btn btn-ghost" href="../dashboard.html" style="text-align:center">Go to Admin Dashboard</a>
          <a class="btn btn-ghost" href="list.html" style="text-align:center">Manage Books (list)</a>
          <a class="btn btn-ghost" href="../staff.html" style="text-align:center">Open Teacher Dashboard</a>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <h4 style="margin:8px 0 6px">Notes</h4>
        <ul style="padding-left:18px;color:var(--muted);font-size:13px">
          <li>Uploads go to Cloudinary and metadata to Firebase Realtime Database under <code>/books</code>.</li>
          <li>After an upload the parser webhook is called to generate questions automatically.</li>
          <li>Teachers will see new books immediately filtered by class.</li>
        </ul>
      </div>
    </div>

    <footer>
      <div>SoMAp — MnyoreBooks • somapv2i.com</div>
      <div style="margin-top:6px">Created with ❤️ — prepare Cloudinary + Firebase keys before use</div>
    </footer>
  </div>

  <!-- Firebase SDK & your firebase.js -->
  <!-- IMPORTANT: your firebase.js should initialize Firebase app and export firebase namespace (as your project currently does). -->
  <script src="../firebase.js"></script>

  <script>
  /******************************************************************
   * Upload page script
   * - Cloudinary unsigned browser upload
   * - Save metadata into Firebase Realtime Database (/books)
   * - Trigger parser webhook with API key (placeholder)
   * - Only available to admin role users
   ******************************************************************/
  (function(){
    // ---------- CONFIG ----------

    // Parser webhook - replace with your deployed microservice URL
    const PARSER_WEBHOOK = "https://your-parser-service.example.com/parse-book"; // <-- replace

    // Optional: API key header for parser service
    const PARSER_API_KEY = "REPLACE_WITH_PARSER_API_KEY";

    // Max allowed file size (bytes) - 60 MB
    const MAX_FILE_SIZE = 60 * 1024 * 1024;

    // Elements
    const fileDrop = document.getElementById('fileDrop');
    const fileInput = document.getElementById('fileInput');
    const fileNameEl = document.getElementById('fileName');
    const fileSizeEl = document.getElementById('fileSize');
    const fileTypeEl = document.getElementById('fileType');
    const selectedMeta = document.getElementById('selectedMeta');
    const progressBar = document.getElementById('progressBar');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const messages = document.getElementById('messages');
    const cloudNameInput = document.getElementById('cloudName');
    const uploadPresetInput = document.getElementById('uploadPreset');
    const loggedEmail = document.getElementById('loggedEmail');

    let selectedFile = null;
    let currentUser = null;
    let cloudinarySettings = { cloudName: '', uploadPreset: '' };

    // ---------- Utils ----------
    function el(html){ const d=document.createElement('div'); d.innerHTML=html; return d.firstElementChild; }
    function showMessage(node){ messages.innerHTML = ''; messages.appendChild(node); }
    function showSuccess(msg){ showMessage(el('<div class="success-box">'+msg+'</div>')); }
    function showError(msg){ showMessage(el('<div class="error-box">'+msg+'</div>')); }
    function setProgress(p){ progressBar.style.width = Math.max(0,Math.min(100,p)) + '%'; }

    function normalizeEmailKey(email){
      // Matches your DB keys like "socratesschool2020@gmail_com"
      // Approach: remove '@' and replace '.' with '_'
      if(!email) return '';
      return email.replace(/@/g,'').replace(/\./g,'_');
    }

    // ---------- Drag & Drop handling ----------
    fileDrop.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));
    ['dragenter','dragover'].forEach(ev=>fileDrop.addEventListener(ev,(e)=>{e.preventDefault(); fileDrop.style.boxShadow='0 6px 20px rgba(14,165,164,0.12)'}));
    ['dragleave','drop'].forEach(ev=>fileDrop.addEventListener(ev,(e)=>{e.preventDefault(); fileDrop.style.boxShadow='none'}));
    fileDrop.addEventListener('drop', (e)=> {
      const dt = e.dataTransfer;
      if(dt && dt.files) handleFiles(dt.files);
    });

    function handleFiles(files){
      if(!files || files.length === 0) return;
      const f = files[0];
      if(f.type !== 'application/pdf' && !f.name.endsWith('.pdf')){
        showError('Please upload a PDF file.');
        return;
      }
      if(f.size > MAX_FILE_SIZE){
        showError('File too large. Please keep file under 60 MB.');
        return;
      }
      selectedFile = f;
      fileNameEl.textContent = f.name;
      fileSizeEl.textContent = (f.size/1024/1024).toFixed(2) + ' MB';
      fileTypeEl.textContent = 'PDF';
      selectedMeta.style.display = 'flex';
      showMessage(el('<div class="small">Ready to upload. Fill book details then click <strong>Upload & Register Book</strong>.</div>'));
    }

    // ---------- Firebase auth & role check ----------
    // Wait until firebase is loaded
    function waitForFirebaseReady(cb){
      if(typeof firebase === 'undefined'){
        console.error('firebase.js not found or not loaded.');
        cb(new Error('Firebase not loaded'));
        return;
      }
      if(firebase.apps && firebase.apps.length > 0){
        return cb(null);
      }
      // If firebase.js does not auto-initialize, you should initialize it there.
      // For safety, wait briefly.
      setTimeout(()=> {
        if(firebase.apps && firebase.apps.length > 0) cb(null); else cb(new Error('Firebase not initialized'));
      }, 250);
    }

    waitForFirebaseReady((err)=>{
      if(err){ showError('Firebase not initialized. Ensure firebase.js exists and initializes the app.'); console.error(err); return; }
      // Observe auth state
      firebase.auth().onAuthStateChanged(user=>{
        if(!user){
          loggedEmail.textContent = 'not signed in';
          showError('Please sign in with an admin account (Gmail) to upload books.');
          return;
        }
        currentUser = user;
        loggedEmail.textContent = user.email;
        // verify role in RTDB
        const key = normalizeEmailKey(user.email);
        firebase.database().ref('users/'+key).once('value').then(snap=>{
          const data = snap.val();
          if(!data || data.role !== 'admin'){
            showError('You are not an admin. Upload disabled.');
            uploadBtn.disabled = true;
            return;
          }
          // admin OK
          showSuccess('Signed in as admin. You can upload books.');
          uploadBtn.disabled = false;

          // Pre-fill cloud name if stored locally
          const cN = localStorage.getItem('cloudName');
          const up = localStorage.getItem('uploadPreset');
          if(cN) cloudNameInput.value = cN;
          if(up) uploadPresetInput.value = up;
        }).catch(e=>{
          console.error(e);
          showError('Failed to read user role from database. Check connection and rules.');
        });
      });
    });

    // ---------- Upload flow ----------
    uploadBtn.addEventListener('click', async function(){
      // Basic validations
      if(!currentUser) { showError('Not signed in.'); return; }
      if(!selectedFile){ showError('Choose a PDF file first.'); return; }

      const title = document.getElementById('title').value.trim();
      const className = document.getElementById('classSelect').value;
      const subject = document.getElementById('subjectSelect').value;
      const edition = document.getElementById('edition').value.trim();
      const description = document.getElementById('description').value.trim();
      const cloudName = cloudNameInput.value.trim();
      const uploadPreset = uploadPresetInput.value.trim();

      if(!title){ showError('Please enter a book title.'); return; }
      if(!cloudName || !uploadPreset){ showError('Set Cloudinary cloud name and upload preset in the right column.'); return; }

      // Save cloud settings locally (so admin doesn't retype)
      localStorage.setItem('cloudName', cloudName);
      localStorage.setItem('uploadPreset', uploadPreset);

      // Disable UI while uploading
      uploadBtn.disabled = true;
      clearBtn.disabled = true;
      setProgress(0);
      showMessage(el('<div class="small">Starting upload to Cloudinary…</div>'));

      try{
        // 1) Upload file to Cloudinary (unsigned)
        const form = new FormData();
        form.append('file', selectedFile);
        form.append('upload_preset', uploadPreset);

        const cloudUrl = `https://api.cloudinary.com/v1_1/${encodeURIComponent(cloudName)}/auto/upload`;

        const xhr = new XMLHttpRequest();
        xhr.open('POST', cloudUrl, true);

        xhr.upload.onprogress = function(e){
          if(e.lengthComputable){
            const percent = Math.round((e.loaded / e.total) * 100);
            setProgress(percent);
          }
        };

        const uploadResult = await new Promise((resolve, reject) => {
          xhr.onload = function(){
            if(xhr.status >= 200 && xhr.status < 300){
              try{
                const res = JSON.parse(xhr.responseText);
                resolve(res);
              }catch(err){ reject(err); }
            } else {
              reject(new Error('Cloudinary upload failed: ' + xhr.status + ' ' + xhr.statusText + ' — ' + xhr.responseText));
            }
          };
          xhr.onerror = function(){ reject(new Error('Network error during upload.')); };
          xhr.send(form);
        });

        // 2) Cloudinary returned result
        const cloudData = uploadResult;
        const secureUrl = cloudData.secure_url || cloudData.url;
        const publicId = cloudData.public_id || '';

        if(!secureUrl) throw new Error('No secure URL from Cloudinary.');

        setProgress(70);
        showMessage(el('<div class="small">Saving metadata to Firebase…</div>'));

        // 3) Save metadata to Firebase Realtime Database under /books
        const bookMeta = {
          title: title,
          class: className,
          subject: subject,
          edition: edition || '',
          description: description || '',
          url: secureUrl,
          cloudinary_public_id: publicId,
          uploadedBy: normalizeEmailKey(currentUser.email),
          uploadedByEmail: currentUser.email,
          uploadedAt: Date.now(),
          paid: 0,
          required: 0
        };

        // Push new book
        const newBookRef = await firebase.database().ref('books').push(bookMeta);
        const bookId = newBookRef.key;

        setProgress(85);
        showMessage(el('<div class="small">Notifying parser service to generate questions…</div>'));

        // 4) Trigger parser webhook (optional) - safe best-effort; failure does not break upload
        try{
          const payload = { bookId: bookId, cloudinaryUrl: secureUrl, metadata: bookMeta };
          await fetch(PARSER_WEBHOOK, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': PARSER_API_KEY
            },
            body: JSON.stringify(payload),
            keepalive: true
          });
        }catch(parseErr){
          // Log parser trigger failure to a DB node for manual retry
          console.warn('Parser webhook failed (non-fatal):', parseErr);
          firebase.database().ref('book_parser_errors').push({ bookId: bookId, error: ''+parseErr, time: Date.now() });
        }

        setProgress(100);
        showSuccess(`Uploaded & registered book: <strong>${title}</strong>. It is now available to teachers for <strong>${className}</strong>. Book ID: <code>${bookId}</code>`);

        // show quick actions
        const actions = document.createElement('div');
        actions.style.marginTop = '10px';
        actions.innerHTML = `
          <div class="small">Actions</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <a class="btn btn-ghost" href="../Bookshtml/list.html?bookId=${bookId}" target="_blank">Manage Book</a>
            <a class="btn" href="../Bookshtml/staffbooks.html" target="_blank">Open Teacher Books</a>
            <a class="btn btn-ghost" href="../parent.html" target="_blank">Open Parent Dashboard</a>
          </div>
        `;
        messages.appendChild(actions);

        // Reset form but keep cloud settings
        selectedFile = null;
        selectedMeta.style.display = 'none';
        document.getElementById('title').value = '';
        document.getElementById('edition').value = '';
        document.getElementById('description').value = '';

      }catch(err){
        console.error(err);
        showError('Upload failed: ' + (err.message || err));
      } finally {
        uploadBtn.disabled = false;
        clearBtn.disabled = false;
        setTimeout(()=> setProgress(0), 1200);
      }
    });

    // Clear button
    clearBtn.addEventListener('click', ()=>{
      selectedFile = null;
      selectedMeta.style.display = 'none';
      fileInput.value = '';
      setProgress(0);
      messages.innerHTML = '';
    });

  })();
  </script>
</body>
</html>
