<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — MnyoreBooks Upload (Admin)</title>

  <!-- Tailwind for quick, clean styling (no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase v9 compat SDKs (match your project) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <!-- Load your existing firebase.js (must be located at ../firebase.js relative to Bookshtml/) -->
  <script src="../firebase.js"></script>

  <style>
    :root{
      --bg-1: #f0f9ff;
      --card: #ffffff;
      --accent-1: #7c3aed;
      --accent-2: #0ea5a4;
      --muted: #6b7280;
      --glass: rgba(255,255,255,0.7);
    }
    html,body{height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 300px at 10% 10%, rgba(124,58,237,0.06), transparent 10%),
                  linear-gradient(180deg,#eef2ff, #f8fafc 40%);
      margin:0;padding:28px;color:#07203b;
    }
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 12px 30px rgba(2,6,23,0.06);border:1px solid rgba(15,23,42,0.04)}
    .file-drop{min-height:120px;display:flex;gap:10px;align-items:center;justify-content:center;flex-direction:column;border:2px dashed rgba(124,58,237,0.12);border-radius:12px;cursor:pointer;background:linear-gradient(180deg,#fff,#fbfdff)}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .chip{background:#f3f4f6;padding:6px 8px;border-radius:999px;font-size:12px;color:#111827;display:inline-block}
    .progress{height:12px;background:#eef6fb;border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,#ffd166,#f95d9b,#7c3aed);width:0%;transition:width 250ms ease}
    .success-box{border-left:4px solid #10b981;padding:10px;border-radius:8px;background:#f0fdf4;color:#064e3b}
    .error-box{border-left:4px solid #ef4444;padding:10px;border-radius:8px;background:#fff1f2;color:#7f1d1d}
    .muted-italic{color:var(--muted);font-style:italic}
    @media(max-width:1000px){.layout-grid{grid-template-columns:1fr!important}}
  </style>
</head>
<body>
  <div class="max-w-7xl mx-auto">
    <header class="flex items-center gap-6 mb-6">
      <div class="rounded-lg w-16 h-16 flex items-center justify-center text-white" style="background:linear-gradient(135deg,var(--accent-2),var(--accent-1));font-weight:800;font-size:22px;box-shadow:0 8px 20px rgba(124,58,237,0.12)">SoM</div>
      <div>
        <h1 style="margin:0;font-size:22px">Admin — Upload Book (MnyoreBooks)</h1>
        <p class="muted" style="margin-top:6px">Upload PDFs to Cloudinary. Metadata saved to Firebase RTDB <code>/books</code>. Parser webhook (optional) will auto-generate questions. This page expects you're already signed into the main app once.</p>
      </div>
    </header>

    <div class="grid layout-grid" style="grid-template-columns: 1fr 420px; gap:20px;">
      <!-- LEFT: Upload card -->
      <section class="card">
        <h2 class="text-lg font-semibold mb-3">1. Book details</h2>

        <div class="space-y-3">
          <div>
            <label class="small">Title</label>
            <input id="title" type="text" placeholder="Basic Mathematical Formulae" class="w-full px-3 py-2 rounded-md border mt-1" />
          </div>

          <div class="flex gap-3">
            <div style="flex:1">
              <label class="small">Class</label>
              <select id="classSelect" class="w-full px-3 py-2 rounded-md border mt-1"></select>
            </div>

            <div style="width:220px">
              <label class="small">Subject</label>
              <select id="subjectSelect" class="w-full px-3 py-2 rounded-md border mt-1"></select>
            </div>
          </div>

          <div>
            <label class="small">Edition / Year</label>
            <input id="edition" type="text" placeholder="e.g., 2025 (optional)" class="w-full px-3 py-2 rounded-md border mt-1" />
          </div>

          <div>
            <label class="small">Description (optional)</label>
            <textarea id="description" placeholder="Short notes for teachers/parents" class="w-full px-3 py-2 rounded-md border mt-1"></textarea>
          </div>
        </div>

        <hr class="my-4" />

        <h2 class="text-lg font-semibold mb-3">2. Choose PDF file</h2>

        <div id="fileDrop" class="file-drop" title="Click or drag and drop a PDF">
          <div style="font-weight:700;color:var(--accent-1)">Drag & Drop PDF here</div>
          <div class="small">or click to browse — PDF only, max 9.5MB recommended</div>
          <input id="fileInput" type="file" accept="application/pdf" style="display:none" />
        </div>

        <div id="selectedMeta" class="mt-3" style="display:none">
          <span class="chip" id="fileName">Filename.pdf</span>
          <span class="chip" id="fileSize">0 MB</span>
          <span class="chip" id="fileType">PDF</span>
        </div>

        <div class="mt-4">
          <label class="small">Upload progress</label>
          <div class="progress mt-2"><i id="progressBar"></i></div>
        </div>

        <div class="flex items-center gap-3 mt-4">
          <button id="uploadBtn" class="px-4 py-2 rounded-md font-bold text-white" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1))" disabled>
            <i class="fas fa-cloud-upload-alt mr-2"></i> Upload & Register Book
          </button>

          <button id="clearBtn" class="px-3 py-2 rounded-md border">Clear</button>

          <div style="margin-left:auto" class="muted">Logged as: <strong id="loggedEmail">not signed in</strong></div>
        </div>

        <div id="messages" class="mt-4"></div>

        <div class="mt-4 small muted">Note: Signing is handled at app start. If this page says "not signed in" please sign in via the main dashboard and return here. Upload requires admin role.</div>
      </section>

      <!-- RIGHT: settings and recent uploads -->
      <aside class="card">
        <h3 class="text-lg font-semibold mb-2">Admin Quick Tools</h3>
        <p class="small muted mb-3">Configure Cloudinary unsigned preset and optional parser webhook (saved locally).</p>

        <div class="space-y-3">
          <div>
            <label class="small">Cloudinary cloud name</label>
            <input id="cloudName" placeholder="dg7vnrkgd" class="w-full px-3 py-2 rounded-md border mt-1" />
            <div class="small muted-italic mt-1">Your Cloudinary cloud name (pre-filled). No secrets here.</div>
          </div>

          <div>
            <label class="small">Upload preset (unsigned)</label>
            <input id="uploadPreset" placeholder="books_unsigned" class="w-full px-3 py-2 rounded-md border mt-1" />
            <div class="small muted-italic mt-1">Create this preset in Cloudinary → Settings → Upload → Upload presets → Unsigned.</div>
          </div>

          <div>
            <label class="small">Parser webhook (optional)</label>
            <input id="parserWebhook" placeholder="https://your-parser.onrender.com/parse-book" class="w-full px-3 py-2 rounded-md border mt-1" />
            <div class="small muted-italic mt-1">If you have a parser microservice, paste its URL here. It will receive POSTs after upload.</div>
          </div>

          <div>
            <label class="small">Parser API Key (optional)</label>
            <input id="parserApiKey" placeholder="secret-api-key (server-side only)" class="w-full px-3 py-2 rounded-md border mt-1" />
            <div class="small muted-italic mt-1">Optional header x-api-key for your parser.</div>
          </div>
        </div>

        <hr class="my-4" />

        <h4 class="text-md font-semibold mb-2">Recent uploads</h4>
        <div id="recentList" style="max-height:360px;overflow:auto;display:flex;flex-direction:column;gap:8px;">
          <div class="small muted">Loading…</div>
        </div>

        <hr class="my-4" />

        <h4 class="text-md font-semibold mb-2">Quick notes</h4>
        <ul style="padding-left:16px;color:var(--muted);font-size:13px">
          <li>Files are uploaded via unsigned Cloudinary preset — <strong>no API secret</strong> in the browser.</li>
          <li>Metadata stored at <code>/books/{bookId}</code>. Books are indexed at <code>/class_books/{class}/{bookId}</code>.</li>
          <li>Teachers are notified under <code>/notifications/{teacherKey}</code> where <code>/users/{key}.role==="teacher"</code>.</li>
        </ul>
      </aside>
    </div>

    <footer class="mt-6 muted">SoMAp — MnyoreBooks • somapv2i.com</footer>
  </div>

  <!-- SCRIPT: logic & interactions -->
  <script>
  (function(){
    /* ---------------- CONFIG ---------------- */
    const MAX_FILE_SIZE = 70 * 1024 * 1024; // 70 MB
    const DEFAULT_CLOUD_NAME = 'dg7vnrkgd'; // your cloud name (public)
    const DEFAULT_UPLOAD_PRESET = 'books_unsigned'; // recommended unsigned preset name
    let PARSER_WEBHOOK = '';
    let PARSER_API_KEY = '';

    /* ---------- SUBJECTS BY CLASS ---------- */
    const SUBJECTS_BY_CLASS = {
      'Baby Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Pre-Unit': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Middle Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Class 1 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 1': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 2 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 2': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 3': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 4': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 5': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 6': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals'],
      'Class 7': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals']
    };

    /* ---------- DOM ---------- */
    const fileDrop = document.getElementById('fileDrop');
    const fileInput = document.getElementById('fileInput');
    const fileNameEl = document.getElementById('fileName');
    const fileSizeEl = document.getElementById('fileSize');
    const fileTypeEl = document.getElementById('fileType');
    const selectedMeta = document.getElementById('selectedMeta');
    const progressBar = document.getElementById('progressBar');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const messages = document.getElementById('messages');
    const cloudNameInput = document.getElementById('cloudName');
    const uploadPresetInput = document.getElementById('uploadPreset');
    const parserWebhookInput = document.getElementById('parserWebhook');
    const parserApiKeyInput = document.getElementById('parserApiKey');
    const recentList = document.getElementById('recentList');

    const classSelect = document.getElementById('classSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const titleInput = document.getElementById('title');
    const editionInput = document.getElementById('edition');
    const descriptionInput = document.getElementById('description');
    const loggedEmail = document.getElementById('loggedEmail');

    let selectedFile = null;
    let currentUser = null;

    /* ---------- helpers ---------- */
    function el(html){ const d=document.createElement('div'); d.innerHTML=html; return d.firstElementChild; }
    function showMessage(node){ messages.innerHTML=''; messages.appendChild(node); }
    function showSuccess(msg){ showMessage(el('<div class="success-box">'+msg+'</div>')); }
    function showError(msg){ showMessage(el('<div class="error-box">'+msg+'</div>')); }
    function setProgress(p){ progressBar.style.width = Math.max(0,Math.min(100,p)) + '%'; }
    function readableSize(bytes){ return (bytes/1024/1024).toFixed(2) + ' MB'; }
    function normalizeEmailKey(email){ if(!email) return ''; return email.replace(/\./g,'_'); } // matches your DB keys

    /* ---------- UI init ---------- */
    function populateClasses(){
      classSelect.innerHTML = '';
      const classes = Object.keys(SUBJECTS_BY_CLASS);
      classes.forEach(c=>{
        const o = document.createElement('option'); o.value = c; o.textContent = c; classSelect.appendChild(o);
      });
      populateSubjects();
    }
    function populateSubjects(){
      const cls = classSelect.value;
      const subs = SUBJECTS_BY_CLASS[cls] || ['Other'];
      subjectSelect.innerHTML = '';
      subs.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; subjectSelect.appendChild(o); });
    }
    classSelect.addEventListener('change', populateSubjects);

    /* ---------- drag & drop ---------- */
    fileDrop.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));
    ['dragenter','dragover'].forEach(ev=>fileDrop.addEventListener(ev,(e)=>{ e.preventDefault(); fileDrop.style.boxShadow='0 8px 24px rgba(124,58,237,0.12)'; }));
    ['dragleave','drop'].forEach(ev=>fileDrop.addEventListener(ev,(e)=>{ e.preventDefault(); fileDrop.style.boxShadow='none'; }));
    fileDrop.addEventListener('drop', (e)=> { const dt=e.dataTransfer; if(dt && dt.files) handleFiles(dt.files); });

    function handleFiles(files){
      if(!files || files.length===0) return;
      const f = files[0];
      if(!f.name.toLowerCase().endsWith('.pdf') && f.type !== 'application/pdf'){ showError('Please upload a PDF file.'); return; }
      if(f.size > MAX_FILE_SIZE){ showError('File too large. Keep file under ' + readableSize(MAX_FILE_SIZE)); return; }
      selectedFile = f;
      fileNameEl.textContent = f.name;
      fileSizeEl.textContent = readableSize(f.size);
      fileTypeEl.textContent = 'PDF';
      selectedMeta.style.display = 'flex';
      showMessage(el('<div class="small">Ready to upload. Fill book details then click <strong>Upload & Register Book</strong>.</div>'));
    }

    /* ---------- Firebase readiness & role check ---------- */
    function waitForFirebase(cb){
      if(typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0){
        cb(new Error('Firebase not loaded. Ensure ../firebase.js initializes Firebase (compat).'));
        return;
      }
      // ensure db/storage exist (firebase.js should export window.db/window.storage but fallback)
      if(!window.db || !window.storage){
        try { window.db = firebase.database(); window.storage = firebase.storage(); } catch(e){ /* ignore */ }
      }
      cb(null);
    }

    waitForFirebase((err)=>{
      if(err){ showError(err.message); disableAll(); return; }
      // UI setup
      populateClasses();
      // read saved cloud settings
      const cN = localStorage.getItem('cloudName') || DEFAULT_CLOUD_NAME;
      const up = localStorage.getItem('uploadPreset') || DEFAULT_UPLOAD_PRESET;
      const ph = localStorage.getItem('parserWebhook') || '';
      const pak = localStorage.getItem('parserApiKey') || '';
      cloudNameInput.value = cN; uploadPresetInput.value = up;
      parserWebhookInput.value = ph; parserApiKeyInput.value = pak;
      PARSER_WEBHOOK = ph; PARSER_API_KEY = pak;

      // auth state
      firebase.auth().onAuthStateChanged(user=>{
        if(!user){ currentUser=null; loggedEmail.textContent='not signed in'; disableAll(); return; }
        currentUser=user;
        loggedEmail.textContent = user.email;
        // check role
        const key = normalizeEmailKey(user.email);
        firebase.database().ref('users/'+key).once('value').then(snap=>{
          const data = snap.val();
          if(!data || data.role !== 'admin'){ showError('Signed in but not an admin. Upload disabled for ' + user.email); disableAll(); return; }
          showSuccess('Signed in as admin: '+user.email);
          enableUploadUI();
        }).catch(e=>{
          console.error(e);
          showError('Failed to read user role from database.');
          disableAll();
        });
      });

      // save settings to localStorage when changed
      cloudNameInput.addEventListener('change', ()=> localStorage.setItem('cloudName', cloudNameInput.value.trim()));
      uploadPresetInput.addEventListener('change', ()=> localStorage.setItem('uploadPreset', uploadPresetInput.value.trim()));
      parserWebhookInput.addEventListener('change', ()=> { localStorage.setItem('parserWebhook', parserWebhookInput.value.trim()); PARSER_WEBHOOK = parserWebhookInput.value.trim(); });
      parserApiKeyInput.addEventListener('change', ()=> { localStorage.setItem('parserApiKey', parserApiKeyInput.value.trim()); PARSER_API_KEY = parserApiKeyInput.value.trim(); });

      // initial load recent uploads
      renderRecentUploads();
    });

    function disableAll(){ uploadBtn.disabled = true; clearBtn.disabled = false; }
    function enableUploadUI(){ uploadBtn.disabled = false; clearBtn.disabled = false; }

    /* ---------- Upload flow ---------- */
    uploadBtn.addEventListener('click', async ()=>{
      if(!currentUser){ showError('Not signed in. Sign in from main app then return to upload page.'); return; }
      if(!selectedFile){ showError('Choose a PDF file first.'); return; }

      const title = titleInput.value.trim();
      const cls = classSelect.value;
      const subject = subjectSelect.value;
      const edition = editionInput.value.trim();
      const description = descriptionInput.value.trim();
      const cloudName = (cloudNameInput.value.trim() || localStorage.getItem('cloudName') || DEFAULT_CLOUD_NAME).trim();
      const uploadPreset = (uploadPresetInput.value.trim() || localStorage.getItem('uploadPreset') || DEFAULT_UPLOAD_PRESET).trim();

      if(!title){ showError('Please enter book title.'); return; }
      if(!cls){ showError('Please select class.'); return; }
      if(!subject){ showError('Please select subject.'); return; }
      if(!cloudName || !uploadPreset){ showError('Set Cloudinary cloud name and upload preset on the right.'); return; }

      // save settings locally
      localStorage.setItem('cloudName', cloudName);
      localStorage.setItem('uploadPreset', uploadPreset);

      // UI lock
      uploadBtn.disabled = true; clearBtn.disabled = true;
      setProgress(0);
      showMessage(el('<div class="small">Starting upload to Cloudinary…</div>'));

      try{
        // Upload to Cloudinary (unsigned) via XHR for progress
        const formData = new FormData();
        formData.append("file", selectedFile);
        formData.append("upload_preset", uploadPreset);
        // optional: folder
        // formData.append('folder', `books/${cls.replace(/\s+/g,'_')}`);

        const cloudUrl = `https://api.cloudinary.com/v1_1/${encodeURIComponent(cloudName)}/raw/upload`;
        const xhr = new XMLHttpRequest();
        xhr.open('POST', cloudUrl, true);

        xhr.upload.onprogress = function(e){
          if(e.lengthComputable){ const percent = Math.round((e.loaded / e.total) * 100); setProgress(percent); }
        };

        const uploadResult = await new Promise((resolve,reject)=>{
          xhr.onload = function(){
            if(xhr.status >=200 && xhr.status < 300){
              try{ resolve(JSON.parse(xhr.responseText)); } catch(err){ reject(err); }
            } else {
              reject(new Error('Cloudinary upload failed: ' + xhr.status + ' ' + xhr.statusText + ' — ' + xhr.responseText));
            }
          };
          xhr.onerror = function(){ reject(new Error('Network error during upload.')); };
          xhr.send(formData);
        });

        const cloudData = uploadResult;
        const secureUrl = cloudData.secure_url || cloudData.url;
        const publicId = cloudData.public_id || '';

        if(!secureUrl) throw new Error('Cloudinary did not return a secure URL.');

        setProgress(70);
        showMessage(el('<div class="small">Saving metadata to Firebase…</div>'));

        // Build metadata
        const bookMeta = {
          title: title,
          class: cls,
          subject: subject,
          edition: edition || '',
          description: description || '',
          url: secureUrl,
          cloudinary_public_id: publicId,
          uploadedBy: normalizeEmailKey(currentUser.email),
          uploadedByEmail: currentUser.email,
          uploadedAt: Date.now(),
          paid: 0,
          required: 0
        };

        // Write to /books
        const newBookRef = await firebase.database().ref('books').push(bookMeta);
        const bookId = newBookRef.key;

        // Index by class for quick retrieval
        try {
          await firebase.database().ref(`class_books/${encodeURIComponent(cls)}/${bookId}`).set({
            title, subject, url: secureUrl, uploadedAt: Date.now()
          });
        } catch(err){
          console.warn('Failed to index class_books', err);
        }

        // Try to attach book to students in common nodes (best-effort)
        try {
          // check common paths where student records might exist
          const candidatePaths = ['students','children','kids','pupils','users'];
          const addedToStudents = [];
          for(const path of candidatePaths){
            const snap = await firebase.database().ref(path).once('value');
            if(!snap.exists()) continue;
            const all = snap.val() || {};
            // For nodes that are user records, check role==='student' or class match
            for(const k of Object.keys(all)){
              const rec = all[k];
              // skip if not an object
              if(!rec || typeof rec !== 'object') continue;
              // common shapes: {class: 'Class 2', parentPhone: '...', names: 'A B'}
              if(rec.class && rec.class === cls){
                // attach pointer under student_books/<student_key>/<bookId> = true
                try {
                  await firebase.database().ref(`student_books/${k}/${bookId}`).set({ title, subject, url: secureUrl, time: Date.now() });
                  addedToStudents.push(k);
                } catch(e){ /* continue */ }
              } else if(rec.role && rec.role === 'student' && rec.class && rec.class === cls){
                try {
                  await firebase.database().ref(`student_books/${k}/${bookId}`).set({ title, subject, url: secureUrl, time: Date.now() });
                  addedToStudents.push(k);
                } catch(e){ /* continue */ }
              }
            }
          }
          if(addedToStudents.length > 0){
            // write notified list on book node
            await firebase.database().ref(`books/${bookId}/studentsAttached`).set(addedToStudents);
          }
        } catch(e){
          console.warn('Student-attachment pass failed (non-fatal)', e);
        }

        // Notify teachers of this class
        try {
          const usersSnap = await firebase.database().ref('users').once('value');
          const users = usersSnap.val() || {};
          const notified = [];
          for(const userKey of Object.keys(users)){
            const u = users[userKey];
            if(u && u.role === 'teacher' && u.class && u.class === cls){
              await firebase.database().ref(`notifications/${userKey}`).push({
                type:'new-book', bookId, title, subject, class:cls, time: Date.now()
              });
              notified.push(userKey);
            }
          }
          // store notified list
          await firebase.database().ref(`books/${bookId}/notifiedTo`).set(notified);
        } catch(e){
          console.warn('Failed to notify teachers', e);
        }

        // Trigger parser webhook (non-blocking)
        PARSER_WEBHOOK = parserWebhookInput.value.trim() || PARSER_WEBHOOK;
        PARSER_API_KEY = parserApiKeyInput.value.trim() || PARSER_API_KEY;
        if(PARSER_WEBHOOK){
          try {
            await fetch(PARSER_WEBHOOK, {
              method:'POST',
              headers:{ 'Content-Type':'application/json', 'x-api-key': PARSER_API_KEY || '' },
              body: JSON.stringify({ bookId, cloudinaryUrl: secureUrl, metadata: bookMeta }),
              keepalive: true
            });
          } catch(parserErr){
            console.warn('Parser webhook failed (non-fatal):', parserErr);
            await firebase.database().ref('book_parser_errors').push({ bookId, error: '' + (parserErr.message || parserErr), time: Date.now() });
          }
        } else {
          // Fallback: create a small demo quiz (useful to show parents/teachers immediately)
          try {
            const demoQuestions = generateDemoQuestions(title, subject);
            await firebase.database().ref(`questions/${bookId}`).set({ autoGenerated: true, items: demoQuestions, createdAt: Date.now() });
          } catch(e){
            console.warn('Demo question generation failed', e);
          }
        }

        setProgress(100);
        showSuccess(`Uploaded & registered book: <strong>${title}</strong>. Available to <strong>${cls}</strong>. Book ID: <code>${bookId}</code>`);

        // Quick actions UI
        const actions = document.createElement('div');
        actions.style.marginTop = '10px';
        actions.innerHTML = `
          <div class="small">Actions</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <a class="chip" href="../Bookshtml/list.html?bookId=${bookId}" target="_blank">Manage Book</a>
            <a class="chip" href="../Bookshtml/staffbooks.html" target="_blank">Open Teacher Books</a>
            <a class="chip" href="../parent.html" target="_blank">Open Parent Dashboard</a>
            <button class="chip" id="rerun_${bookId}">Re-run parser</button>
          </div>
        `;
        messages.appendChild(actions);

        const rerunBtn = document.getElementById(`rerun_${bookId}`);
        if(rerunBtn){
          rerunBtn.addEventListener('click', async ()=>{
            if(!PARSER_WEBHOOK){ showError('Parser webhook not configured.'); return; }
            try {
              await fetch(PARSER_WEBHOOK, {
                method:'POST',
                headers:{ 'Content-Type':'application/json', 'x-api-key': PARSER_API_KEY || '' },
                body: JSON.stringify({ bookId, cloudinaryUrl: secureUrl, metadata: bookMeta })
              });
              showSuccess('Parser re-run requested.');
            } catch(e){ console.error(e); showError('Failed to request parser re-run.'); }
          });
        }

        // Reset form (keep cloud settings)
        selectedFile=null; selectedMeta.style.display='none';
        titleInput.value = ''; editionInput.value = ''; descriptionInput.value = ''; fileInput.value = '';

        // refresh list
        renderRecentUploads();

      } catch(err){
        console.error(err);
        showError('Upload failed: ' + (err.message || err));
      } finally {
        uploadBtn.disabled=false; clearBtn.disabled=false;
        setTimeout(()=> setProgress(0), 1200);
      }
    });

    // Clear button
    clearBtn.addEventListener('click', ()=> {
      selectedFile=null; selectedMeta.style.display='none'; fileInput.value=''; messages.innerHTML=''; setProgress(0);
    });

    /* ---------- Recent uploads ---------- */
    async function renderRecentUploads(){
      recentList.innerHTML = '<div class="small muted">Loading…</div>';
      try {
        const snap = await firebase.database().ref('books').orderByChild('uploadedAt').limitToLast(40).once('value');
        const books = snap.val() || {};
        recentList.innerHTML = '';
        const items = Object.entries(books).sort((a,b)=> (b[1].uploadedAt||0) - (a[1].uploadedAt||0));
        if(items.length===0){ recentList.innerHTML='<div class="small muted">No uploads yet</div>'; return; }
        items.forEach(([id,b])=>{
          const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
          row.style.padding='8px'; row.style.borderRadius='8px'; row.style.background='#fff'; row.style.border='1px solid #eef2f7';
          row.innerHTML = `<div style="max-width:70%"><strong>${escapeHtml(b.title || '(untitled)')}</strong><div class="small muted">${escapeHtml(b.class||'')} • ${escapeHtml(b.subject||'')}</div></div>
            <div style="display:flex;gap:8px;align-items:center">
              <a class="chip" href="${b.url}" target="_blank">Open</a>
              <button class="chip" data-bookid="${id}" data-url="${b.url}">Details</button>
            </div>`;
          recentList.appendChild(row);
          const btn = row.querySelector('button[data-bookid]');
          btn.addEventListener('click', ()=> {
            alert(`Book ID: ${id}\nTitle: ${b.title}\nClass: ${b.class}\nSubject: ${b.subject}\nUploaded by: ${b.uploadedByEmail || b.uploadedBy}\nUploadedAt: ${new Date(b.uploadedAt||0).toLocaleString()}`);
          });
        });
      } catch(e){
        console.error(e);
        recentList.innerHTML = '<div class="small muted">Failed to load recent uploads</div>';
      }
    }

    /* ---------- Demo question generator (fallback) ---------- */
    function generateDemoQuestions(title, subject){
      // Simple placeholder quiz generator — NOT a real parser.
      // It creates 5 friendly MCQs to demo the flow.
      const base = `From the book "${title}" (${subject})`;
      const qs = [
        { q: `${base}: Which subject is this book about?`, type:'mcq', options:[subject, 'Math','English','Science'], answer: subject },
        { q: `${base}: Who should use this book?`, type:'mcq', options:['Teachers','Students','Parents','All of the above'], answer:'Students' },
        { q: `${base}: This is a(n) _____ resource.`, type:'mcq', options:['Textbook','Movie','Game','App'], answer:'Textbook' },
        { q: `${base}: Choose the correct statement.`, type:'mcq', options:['It helps learning','It is a movie','It is a restaurant menu','It is a map'], answer:'It helps learning' },
        { q: `${base}: Recommend one activity after reading this book.`, type:'short', answer:'Discuss and practice exercises' }
      ];
      return qs;
    }

    /* ---------- Utility ---------- */
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ---------- Debug helpers (exposed) ---------- */
    window.somapUploadDebug = {
      populateClasses, populateSubjects, renderRecentUploads, normalizeEmailKey, generateDemoQuestions
    };

  })();
  </script>
</body>
</html>