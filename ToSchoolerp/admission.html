<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp — Admissions</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: Inter, system-ui, Arial; background:#f8fafc; color:#0f172a; }
    .modal { display:none; position:fixed; inset:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { position:relative; background:#fff; margin:0 auto; padding:20px; border-radius:10px; width:95%; max-width:920px; height:90vh; overflow-y:auto; margin-top:20px; }
    .close { position:absolute; top:10px; right:16px; font-size:24px; cursor:pointer; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border:1px solid #e6e9ef; text-align:left; font-size:13px; }
    thead th { background:#eef2ff; color:#0b69ff; }
    .hidden { display:none !important; }
    .block { display:block !important; }
    .student-card { background:#fff; border:1px solid #e6e9ef; border-radius:8px; padding:10px; margin-bottom:10px; }
    .hint { font-size:12px; color:#6b7280; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:.5rem .85rem; border-radius:.5rem; }
  </style>
</head>
<body class="bg-gray-50 p-4">

  <!-- Back to Dashboard -->
  <div class="mb-4">
    <a href="../schoolerp.html" class="text-indigo-600 hover:underline flex items-center gap-2 mb-4">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Admissions Content -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="space-y-4">
      <div>
        <h3 class="font-medium text-gray-800">New Applications</h3>
        <p class="text-sm text-gray-500 mb-3">Review and process new student applications.</p>
        <div class="flex justify-between">
          <span class="text-sm font-medium text-green-600">12 new applications</span>
          <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
        </div>
      </div>

      <div>
        <h3 class="font-medium text-gray-800">Quick Admission</h3>
        <p class="text-sm text-gray-500 mb-3">Register a new student directly.</p>
        <button id="openRegistrationModal" class="w-full md:w-1/2 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition cursor-pointer">
          Create New Admission
        </button>
        <p class="hint mt-2">Admission number auto-fills when the form opens.</p>
      </div>

      <div>
        <h3 class="font-medium text-gray-800">Transfer Requests</h3>
        <p class="text-sm text-gray-500 mb-2">Students requesting transfer in/out</p>
        <div class="flex justify-between">
          <span class="text-sm font-medium text-yellow-600">3 pending requests</span>
          <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Registration Modal -->
  <div id="registrationModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span id="closeModal" class="close" title="Close">&times;</span>
     <h2 id="modalTitle" class="text-2xl font-semibold text-indigo-600 mb-4">Student Registration</h2>

      <form id="registrationForm" enctype="multipart/form-data" novalidate class="space-y-4">
          <input type="hidden" id="recordKey" name="recordKey" />
        <!-- BASIC INFO -->
        <div class="section">
          <h3 class="font-semibold">Basic Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="firstName" class="block text-sm text-gray-600">First Name *</label>
              <input type="text" id="firstName" name="firstName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="middleName" class="block text-sm text-gray-600">Middle Name</label>
              <input type="text" id="middleName" name="middleName" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="lastName" class="block text-sm text-gray-600">Last Name *</label>
              <input type="text" id="lastName" name="lastName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="gender" class="block text-sm text-gray-600">Gender *</label>
              <select id="gender" name="gender" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select gender</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label for="dob" class="block text-sm text-gray-600">Date of Birth *</label>
              <input type="date" id="dob" name="dob" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="admissionNumber" class="block text-sm text-gray-600">Admission Number (Auto-generated)</label>
              <input type="text" id="admissionNumber" name="admissionNumber" readonly class="border p-2 rounded w-full bg-gray-100"/>
            </div>
            <div>
              <label for="feePerYear" class="block text-sm text-gray-600">Fee Per Year (Tsh) *</label>
              <input type="number" id="feePerYear" name="feePerYear" placeholder="e.g., 600000" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="paymentPlan" class="block text-sm text-gray-600">Payment Plan *</label>
              <select id="paymentPlan" name="paymentPlan" required class="border p-2 rounded w-full">
                <option value="">-- Select Payment Plan --</option>
                <option value="monthly">Monthly (Jan–Oct)</option>
                <option value="6-instalments">6 Instalments</option>
                <option value="2-instalments">2 Instalments</option>
                <option value="yearly">Full Year at Once</option>
                <option value="other">Other (as agreed)</option>
              </select>
            </div>
            <div>
              <label for="pupilId" class="block text-sm text-gray-600">Pupil’s ID</label>
              <input type="text" id="pupilId" name="pupilId" placeholder="Pupil's ID" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="birthCertNumber" class="block text-sm text-gray-600">Birth Certificate Number</label>
              <input type="text" id="birthCertNumber" name="birthCertNumber" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="religion" class="block text-sm text-gray-600">Religion</label>
              <input type="text" id="religion" name="religion" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="tribe" class="block text-sm text-gray-600">Tribe / Ethnicity</label>
              <input type="text" id="tribe" name="tribe" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- SCHOOL INFO -->
        <div class="section">
          <h3 class="font-semibold">School Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="schoolName" class="block text-sm text-gray-600">School Name *</label>
              <input type="text" id="schoolName" name="schoolName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="classLevel" class="block text-sm text-gray-600">Class Level *</label>
              <select id="classLevel" name="classLevel" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select class</option>
                <option>Baby Class</option>
                <option>Class 1</option>
                <option>Class 2</option>
                <option>Class 3</option>
                <option>Class 4</option>
                <option>Class 5</option>
                <option>Class 6</option>
                <option>Class 7</option>
              </select>
            </div>
            <div>
              <label for="stream" class="block text-sm text-gray-600">Stream</label>
              <input type="text" id="stream" name="stream" placeholder="e.g., 4B" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="academicYear" class="block text-sm text-gray-600">Current Academic Year *</label>
              <input type="text" id="academicYear" name="academicYear" placeholder="e.g., 2025" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="academicTrack" class="block text-sm text-gray-600">Academic Track</label>
              <input type="text" id="academicTrack" name="academicTrack" placeholder="e.g., NECTA / SFNA" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="boardingStatus" class="block text-sm text-gray-600">Boarding or Day Scholar *</label>
              <select id="boardingStatus" name="boardingStatus" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select status</option>
                <option>Boarding</option>
                <option>Day Scholar</option>
              </select>
            </div>
            <div>
              <label for="shiftedFrom" class="block text-sm text-gray-600">Shifted From (for transfer-ins)</label>
              <input type="text" id="shiftedFrom" name="shiftedFrom" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- PARENT/GUARDIAN -->
        <div class="section">
          <h3 class="font-semibold">Parent / Guardian Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="primaryParentName" class="block text-sm text-gray-600">Primary Parent Name *</label>
              <input type="text" id="primaryParentName" name="primaryParentName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="primaryParentContact" class="block text-sm text-gray-600">Primary Parent Contact *</label>
              <input type="text" id="primaryParentContact" name="primaryParentContact" placeholder="+255 7xx xxx xxx" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="secondaryGuardian" class="block text-sm text-gray-600">Secondary Guardian (if any)</label>
              <input type="text" id="secondaryGuardian" name="secondaryGuardian" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="relationshipToStudent" class="block text-sm text-gray-600">Relationship to Student</label>
              <input type="text" id="relationshipToStudent" name="relationshipToStudent" class="border p-2 rounded w-full"/>
            </div>
            <div class="md:col-span-2">
              <label for="residentialAddress" class="block text-sm text-gray-600">Residential Address *</label>
              <textarea id="residentialAddress" name="residentialAddress" required class="border p-2 rounded w-full h-20"></textarea>
            </div>
            <div class="md:col-span-2">
              <label for="employmentStatus" class="block text-sm text-gray-600">Employment Status (if needed)</label>
              <input type="text" id="employmentStatus" name="employmentStatus" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- FILES -->
        <div class="section">
          <h3 class="font-semibold">Photos & Attachments</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="passportPhoto" class="block text-sm text-gray-600">Passport Photo Upload *</label>
              <input type="file" id="passportPhoto" name="passportPhoto" accept="image/*" class="border p-2 rounded w-full"/>
<div id="passportPreview" class="mt-2 hint"></div>
            </div>
            <div>
              <label for="birthCertUpload" class="block text-sm text-gray-600">Birth Certificate Upload *</label>
              <input type="file" id="birthCertUpload" name="birthCertUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
<div id="birthCertPreview" class="mt-2 hint"></div>
            </div>
            <div>
              <label for="reportCardUpload" class="block text-sm text-gray-600">Report Card (First Term, Ongoing) *</label>
              <input type="file" id="reportCardUpload" name="reportCardUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
<div id="reportCardPreview" class="mt-2 hint"></div>
            <div>
              <label for="joiningLetterUpload" class="block text-sm text-gray-600">Joining or Transfer Letter (PDF/Image) *</label>
              <input type="file" id="joiningLetterUpload" name="joiningLetterUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
<div id="joiningLetterPreview" class="mt-2 hint"></div>
            </div>
            <div class="md:col-span-2">
              <label for="medicalDocsUpload" class="block text-sm text-gray-600">Medical Documents (if applicable)</label>
              <input type="file" id="medicalDocsUpload" name="medicalDocsUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
<div id="medicalDocsPreview" class="mt-2 hint"></div>
            </div>
          </div>
        </div>

        <div class="flex gap-2">
  <button type="submit" id="registerBtn" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
    Register Student
  </button>
  <button type="button" id="cancelEditBtn" class="flex-1 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 hidden">
    Cancel
  </button>
</div>

      <!-- Quick search (live) -->
      <div class="mt-8">
        <h3 class="font-semibold">Search Students</h3>
        <input type="text" id="search-box" placeholder="Search by name or ID" class="border p-2 rounded w-64 mt-2"/>
        <div id="student-list" class="mt-4"></div>
      </div>
    </div>
  </div>

  <!-- Third-party libraries (CSV + PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDKs (compat) + your config -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase.js"></script> <!-- Adjusted path to firebase.js in root -->
  <!-- Cloudinary Upload Library -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

  <!-- Admissions Logic -->
 <!-- Admissions Logic (extended with Edit functionality) -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('admission.editable.html loaded'); // Debug log to confirm script execution

    // ---- Modal open/close ----
    const openModalBtn = document.getElementById('openRegistrationModal');
    const closeModalBtn = document.getElementById('closeModal');
    const modal = document.getElementById('registrationModal');
    const form = document.getElementById('registrationForm');
    const registerBtn = document.getElementById('registerBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const modalTitle = document.getElementById('modalTitle');

    // Debug: Check if elements are found
    if (!openModalBtn) console.error('openRegistrationModal button not found');
    if (!modal) console.error('registrationModal not found');
    if (!closeModalBtn) console.error('closeModal button not found');
    if (!form) console.error('registrationForm not found');
    if (!registerBtn) console.error('registerBtn not found');

    let editingKey = null;      // when set -> form is in EDIT mode
    let editingStudent = null;  // currently loaded student object (for keeping old URLs)

    if (openModalBtn && modal) {
      openModalBtn.addEventListener('click', function() {
        console.log('Create New Admission button clicked'); // Debug log
        clearForm();
        document.getElementById('admissionNumber').value = `AUTO-${Date.now()}`;
        openModal();
      });
    }

    if (closeModalBtn) closeModalBtn.addEventListener('click', closeRegistrationModal);
    if (modal) {
      window.addEventListener('click', (e) => {
        if (e.target === modal) closeRegistrationModal();
      });
    }

    function openModal() {
      modal.style.display = 'block';
      checkFormValidity();
    }

    function clearForm() {
      form.reset();
      editingKey = null;
      editingStudent = null;
      document.getElementById('recordKey').value = '';
      modalTitle.textContent = 'Student Registration';
      registerBtn.textContent = 'Register Student';
      cancelEditBtn.classList.add('hidden');
      // clear previews
      ['passportPreview','birthCertPreview','reportCardPreview','joiningLetterPreview','medicalDocsPreview'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
      });
    }

    function closeRegistrationModal() {
      console.log('Closing modal'); // Debug log
      if (modal) modal.style.display = 'none';
      clearForm();
      if (registerBtn) registerBtn.disabled = true;
    }

    // ---- Resolve Firebase handles gracefully ----
    const db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
    const storage = window.storage || (window.firebase && firebase.storage ? firebase.storage() : null);

    if (!db) {
      console.error('Firebase Realtime Database not available. Ensure ../firebase.js and Firebase SDKs are loaded.');
    }
    if (!storage) {
      console.warn('Firebase Storage not available. File uploads will be skipped.');
    }

    // ---- Required fields -> enable/disable register ----
    const requiredFields = [
      'firstName', 'lastName', 'gender', 'dob',
      'schoolName', 'classLevel', 'academicYear', 'boardingStatus',
      'primaryParentName', 'primaryParentContact', 'residentialAddress',
      'feePerYear', 'paymentPlan'
    ];
    const requiredFiles = ['passportPhoto', 'birthCertUpload', 'reportCardUpload', 'joiningLetterUpload'];

    function checkFormValidity() {
      const fieldsOk = requiredFields.every(id => {
        const el = document.getElementById(id);
        return el && String(el.value || '').trim() !== '';
      });
      // When editing, files are OPTIONAL. When creating new, files are required.
      const filesOk = editingKey ? true : requiredFiles.every(id => {
        const el = document.getElementById(id);
        return el && el.files && el.files.length > 0;
      });
      if (registerBtn) {
        registerBtn.disabled = !(fieldsOk && filesOk);
        console.log('Form validity:', { fieldsOk, filesOk }); // Debug log
      }
    }

    [...requiredFields, ...requiredFiles].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', checkFormValidity);
        if (el.type === 'file') el.addEventListener('change', checkFormValidity);
      }
    });
    if (registerBtn) registerBtn.disabled = true;

    // ---- Utils ----
    function escapeHtml(text) {
      if (text === undefined || text === null) return '';
      return String(text).replace(/[&<>\"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]));
    }

    // Upload: if editing and no new file selected, KEEP existingUrl
    async function uploadMaybe(inputId, folder, newKey, existingUrl) {
      const el = document.getElementById(inputId);
      if (!el || !el.files || el.files.length === 0) return existingUrl || null;

      try {
        const file = el.files[0];
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "somap_unsigned"); // update if your preset differs
        formData.append("folder", "studentDocs/" + newKey + "/" + folder);

        const res = await fetch("https://api.cloudinary.com/v1_1/dg7vnrkgd/auto/upload", {
          method: "POST",
          body: formData
        });
        const data = await res.json();

        if (data.secure_url) {
          console.log(`Uploaded ${inputId} to Cloudinary:`, data.secure_url);
          return data.secure_url;
        } else {
          console.error("Cloudinary upload failed:", data);
          return existingUrl || null;
        }
      } catch (err) {
        console.error(`Upload error for ${inputId}:`, err);
        return existingUrl || null;
      }
    }

    // ---- Registration submit (create OR update) ----
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (registerBtn) registerBtn.disabled = true;
        console.log('Form submitted'); // Debug log

        const fd = new FormData(form);
        const studentData = {
  firstName: fd.get('firstName'),
  middleName: fd.get('middleName') || '',
  lastName: fd.get('lastName'),
  gender: fd.get('gender'),
  dob: fd.get('dob'),
  pupilId: fd.get('pupilId') || '',
  birthCertNumber: fd.get('birthCertNumber') || '',
  religion: fd.get('religion') || '',
  tribe: fd.get('tribe') || '',
  schoolName: fd.get('schoolName'),
  classLevel: fd.get('classLevel'),
  stream: fd.get('stream') || '',
  academicYear: fd.get('academicYear'),
  academicTrack: fd.get('academicTrack') || '',
  boardingStatus: fd.get('boardingStatus'),
  shiftedFrom: fd.get('shiftedFrom') || '',
  primaryParentName: fd.get('primaryParentName'),
  primaryParentContact: fd.get('primaryParentContact'),
  secondaryGuardian: fd.get('secondaryGuardian') || '',
  relationshipToStudent: fd.get('relationshipToStudent') || '',
  residentialAddress: fd.get('residentialAddress'),
  employmentStatus: fd.get('employmentStatus') || '',
  feePerYear: Number(fd.get('feePerYear') || 0),
  paymentPlan: fd.get('paymentPlan'),
};
        try {
          if (!db) throw new Error('Database not available');

          // Duplicate check: look for existing student with same parent contact + name + dob + class
          let duplicate = false;
          const dupQuery = db.ref('students').orderByChild('primaryParentContact').equalTo(studentData.primaryParentContact);
          const dupSnap = await dupQuery.once('value');
          dupSnap.forEach(child => {
            const s = child.val();
            const key = child.key;
            if (s) {
              const sameIdentity = ((s.firstName||'') === studentData.firstName && (s.lastName||'') === studentData.lastName && (s.dob||'') === studentData.dob && (s.classLevel||'') === studentData.classLevel);
              if (sameIdentity) {
                // if creating new -> any match is duplicate. If editing -> ignore self
                if (!editingKey || (editingKey && editingKey !== key)) duplicate = true;
              }
            }
          });

          if (duplicate) {
            alert("Duplicate student detected (same name, DOB, class & parent contact). Update aborted.");
            if (registerBtn) registerBtn.disabled = false;
            return;
          }

          if (!editingKey) {
            // CREATE NEW
            const newRef = db.ref('students').push();
            const newKey = newRef.key;

            // Upload files (all required for new registration)
            studentData.passportPhotoUrl   = await uploadMaybe("passportPhoto", "passport", newKey, null);
            studentData.birthCertUrl       = await uploadMaybe("birthCertUpload", "birthCert", newKey, null);
            studentData.reportCardUrl      = await uploadMaybe("reportCardUpload", "reportCard", newKey, null);
            studentData.joiningLetterUrl   = await uploadMaybe("joiningLetterUpload", "joiningLetter", newKey, null);
            studentData.medicalDocsUrl     = await uploadMaybe("medicalDocsUpload", "medicalDocs", newKey, null);

            await newRef.set({ createdAt: firebase.database.ServerValue.TIMESTAMP, ...studentData });

            alert('✅ Student registered successfully!');
            closeRegistrationModal();

          } else {
            // UPDATE existing
            const keyToUpdate = editingKey;
            // Use existing student data URLs as defaults
            const existing = editingStudent || {};

            studentData.passportPhotoUrl   = await uploadMaybe("passportPhoto", "passport", keyToUpdate, existing.passportPhotoUrl || null);
            studentData.birthCertUrl       = await uploadMaybe("birthCertUpload", "birthCert", keyToUpdate, existing.birthCertUrl || null);
            studentData.reportCardUrl      = await uploadMaybe("reportCardUpload", "reportCard", keyToUpdate, existing.reportCardUrl || null);
            studentData.joiningLetterUrl   = await uploadMaybe("joiningLetterUpload", "joiningLetter", keyToUpdate, existing.joiningLetterUrl || null);
            studentData.medicalDocsUrl     = await uploadMaybe("medicalDocsUpload", "medicalDocs", keyToUpdate, existing.medicalDocsUrl || null);

            // Do an update (preserves existing createdAt if present)
            await db.ref('students/' + keyToUpdate).update({ ...studentData, updatedAt: firebase.database.ServerValue.TIMESTAMP });

            alert('✅ Student record updated successfully!');
            closeRegistrationModal();
          }

        } catch (err) {
          console.error('Registration/Update error:', err);
          alert('❌ Error saving student: ' + (err.message || err));
          if (registerBtn) registerBtn.disabled = false;
        }
      });
    }

    // ---- Live cache + rendering for search (and edit buttons) ----
    let cachedStudents = [];

    if (db) {
      db.ref('students').on('value', (snapshot) => {
        const raw = snapshot.val() || {};
        cachedStudents = Object.entries(raw).map(([key, s]) => ({ key, ...s }));
        renderSearchList(cachedStudents);
      });
    }

    function renderSearchList(students) {
      const searchList = document.getElementById('student-list');
      const searchBox = document.getElementById('search-box');
      if (!searchList) return;
      const term = (searchBox ? searchBox.value || '' : '').toLowerCase();
      const filtered = !term ? students : students.filter(s =>
        ((s.firstName||'').toLowerCase().includes(term)) ||
        ((s.lastName||'').toLowerCase().includes(term)) ||
        ((s.pupilId||'').toLowerCase().includes(term)) ||
        ((s.admissionNumber||'').toLowerCase().includes(term))
      );
      searchList.innerHTML = '';
      filtered.forEach(stu => {
        const div = document.createElement('div');
        div.className = 'student-card';
        div.innerHTML = `
  <div class="flex justify-between items-start">
    <div>
      <strong>${escapeHtml((stu.firstName||'') + ' ' + (stu.lastName||''))}</strong><br>
      ID: ${escapeHtml(stu.pupilId || stu.admissionNumber || 'N/A')}<br>
      Class: ${escapeHtml(stu.classLevel || 'N/A')}<br>
      Fee: ${escapeHtml(String(stu.feePerYear || 0))}<br>
    </div>
    <div class="flex gap-2">
      <button class="btn edit-btn bg-yellow-100 text-yellow-800 px-3 py-1 rounded" data-key="${stu.key}">Edit</button>
      <button class="btn delete-btn bg-red-100 text-red-800 px-3 py-1 rounded" data-key="${stu.key}">Delete</button>
    </div>
  </div>

  ${stu.passportPhotoUrl ? `<img src="${stu.passportPhotoUrl}" alt="Passport" style="width:80px; height:80px; margin-top:8px; border-radius:6px;" />` : ''}

  <div style="margin-top:6px;">
    ${stu.birthCertUrl ? `<a href="${stu.birthCertUrl}" target="_blank">Birth Cert</a> | ` : ''}
    ${stu.reportCardUrl ? `<a href="${stu.reportCardUrl}" target="_blank">Report Card</a> | ` : ''}
    ${stu.joiningLetterUrl ? `<a href="${stu.joiningLetterUrl}" target="_blank">Joining Letter</a> | ` : ''}
    ${stu.medicalDocsUrl ? `<a href="${stu.medicalDocsUrl}" target="_blank">Medical Docs</a>` : ''}
  </div>
`;
        searchList.appendChild(div);
      });

      // Attach listeners to edit/delete buttons
      document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const key = e.currentTarget.getAttribute('data-key');
        startEditForKey(key);
      }));
      document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const key = e.currentTarget.getAttribute('data-key');
        doDeleteKey(key);
      }));
    }

    // Search input
    const searchBox = document.getElementById('search-box');
    if (searchBox) searchBox.addEventListener('input', () => renderSearchList(cachedStudents));

    // ---- Edit flow ----
    function startEditForKey(key) {
      const student = cachedStudents.find(s => s.key === key);
      if (!student) return alert('Student not found locally. Please refresh.');
      editingKey = key;
      editingStudent = student;
      document.getElementById('recordKey').value = key;
      modalTitle.textContent = 'Edit Student — ' + (student.firstName || '') + ' ' + (student.lastName || '');
      registerBtn.textContent = 'Save Changes';
      cancelEditBtn.classList.remove('hidden');

      // populate fields
      populateFormWithStudent(student);
      openModal();
    }

    document.getElementById('cancelEditBtn').addEventListener('click', () => {
      clearForm();
      modal.style.display = 'none';
    });

    function populateFormWithStudent(s) {
      try {
        const map = [
          'firstName','middleName','lastName','gender','dob','admissionNumber','pupilId','birthCertNumber','religion','tribe',
          'schoolName','classLevel','stream','academicYear','academicTrack','boardingStatus','shiftedFrom',
          'primaryParentName','primaryParentContact','secondaryGuardian','relationshipToStudent','residentialAddress','employmentStatus',
          'feePerYear','paymentPlan'
        ];
        map.forEach(k => {
          const el = document.getElementById(k);
          if (el) el.value = s[k] || '';
        });

        // show file previews (links) - files themselves cannot be set programmatically
        const setIf = (id, url, text) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.innerHTML = url ? `<a href="${url}" target="_blank">${text}</a>` : '';
        };
        setIf('passportPreview', s.passportPhotoUrl, 'Current Passport Photo');
        setIf('birthCertPreview', s.birthCertUrl, 'Current Birth Cert');
        setIf('reportCardPreview', s.reportCardUrl, 'Current Report Card');
        setIf('joiningLetterPreview', s.joiningLetterUrl, 'Current Joining Letter');
        setIf('medicalDocsPreview', s.medicalDocsUrl, 'Current Medical Docs');

        checkFormValidity();
      } catch (err) { console.error('populateForm error', err); }
    }

    // ---- Delete flow (simple) ----
    async function doDeleteKey(key) {
      if (!confirm('Delete this student record? This action cannot be undone.')) return;
      try {
        await db.ref('students/' + key).remove();
        alert('✅ Student deleted.');
      } catch (err) {
        console.error('Delete error', err);
        alert('Error deleting: ' + (err.message || err));
      }
    }

    // ---- Connectivity sanity check ----
    if (db) {
      db.ref('z_test_write').set({ ok: true, ts: Date.now() })
        .then(() => console.log('DB test write OK'))
        .catch(err => console.warn('DB test write failed (ignore if rules block):', err.message));
    }

  });
</script>
</body>
</html>