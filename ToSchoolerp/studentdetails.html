<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SoMAp — Student ID & Details</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Your firebase.js (adjust path if needed) -->
  <script src="firebase.js"></script>

  <style>
    body { font-family: Inter, system-ui, Arial; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); color: #0f172a; padding: 20px; min-height: 100vh; }
    .card { background: #ffffff; border-radius: 16px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); padding: 24px; max-width: 980px; margin: 0 auto; }
    .grid-2 { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
    .left { flex: 0 0 280px; }
    .right { flex: 1 1 auto; min-width: 280px; }
    .id-preview { width: 280px; border-radius: 12px; padding: 16px; background: linear-gradient(135deg, #eef2ff 0%, #dbeafe 100%); box-shadow: 0 8px 16px rgba(0,0,0,0.08); border: 1px solid #dbeafe; }
    .id-photo { width: 100px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #c7d2fe; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 0.6rem 1rem; border-radius: 0.5rem; transition: all 0.2s; }
    .muted { color: #6b7280; font-size: 14px; }
    .detail-item { margin-bottom: 12px; }
    .detail-label { font-weight: 600; color: #4f46e5; font-size: 15px; }
    .detail-value { color: #1f2937; font-size: 14px; }
    .header-bg { background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%); color: white; padding: 12px; border-radius: 8px 8px 0 0; text-align: center; font-weight: 700; font-size: 16px; }
    .footer { margin-top: 24px; text-align: center; color: #6b7280; font-size: 12px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="header-bg">SoMAp Student ID & Details</div>

    <div class="flex items-center justify-between mb-6 mt-4">
      <h2 class="text-xl font-semibold text-gray-800">Student Details & ID Preview</h2>
      <div class="flex gap-2">
        <a href="../studentlist.html" class="py-2 px-3 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 btn">
          <i class="fas fa-arrow-left"></i> Back to List
        </a>
        <button id="downloadPdf" class="py-2 px-3 bg-indigo-600 text-white rounded hover:bg-indigo-700 btn">
          <i class="fa-solid fa-file-pdf"></i> Generate ID (PDF)
        </button>
      </div>
    </div>

    <div id="status" class="muted mb-4 text-center">Loading student data...</div>

    <div class="grid-2">
      <!-- Left: ID Preview -->
      <div class="left">
        <div class="id-preview" id="idPreview">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; background: linear-gradient(90deg, #4f46e5, #6366f1); padding:8px; border-radius:6px; color:white;">
            <div style="flex:0 0 auto">
              <img src="../images/somap-logo.png.jpg" alt="School Logo" style="width:30px; height:30px; border-radius:50%; border:1px solid white;">
            </div>
            <div style="flex:1 1 auto; text-align:center; font-weight:600; font-size:14px;">STUDENT ID CARD</div>
          </div>
          <div style="display:flex; gap:12px; align-items:flex-start; margin-bottom:12px;">
            <img id="idPhotoSmall" class="id-photo" src="https://via.placeholder.com/100x120" alt="Passport Photo">
            <div style="flex:1;">
              <div id="idFullName" class="detail-label">Full Name: —</div>
              <div id="idClass" class="detail-value muted">Class: —</div>
              <div id="idAdmission" class="detail-value muted">Admission No: —</div>
              <div id="idParent" class="detail-value muted">Parent Contact: —</div>
            </div>
          </div>
          <div id="idSchoolContact" class="detail-value muted">School Contact: +255 686 828 732</div>
          <div id="idSchoolEmail" class="detail-value muted">School Email: socratesschool2020@gmail.com</div>
          <div id="idYear" class="detail-value muted">Year: <span id="idYearVal"></span></div>
          <div style="margin-top:12px; font-size:12px; color:#4f46e5; font-weight:600; text-align:center;">Issued by Socrates School</div>
        </div>
      </div>

      <!-- Right: Details -->
      <div class="right">
        <div id="detailsBlock" class="space-y-2">
          <!-- Filled by JS -->
        </div>
        <div class="mt-6">
          <button id="editStudent" class="py-2 px-3 bg-yellow-500 text-white rounded hover:bg-yellow-600 btn">
            <i class="fas fa-edit"></i> Edit Student
          </button>
          <button id="refreshBtn" class="py-2 px-3 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 btn ml-2">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
      </div>
    </div>

    <div class="footer">
      © 2025 SoMAp - Built for excellence in education.
    </div>
  </div>

  <script>
    (function() {
      // Require db
      const db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
      if (!db) {
        document.getElementById('status').textContent = 'Firebase not available. Check firebase.js path.';
        return;
      }

      // Read URL params
      const params = new URLSearchParams(window.location.search);
      const paramsKey = params.get('key');
      const paramsAdm = params.get('adm');

      const statusEl = document.getElementById('status');
      const detailsBlock = document.getElementById('detailsBlock');
      const downloadPdfBtn = document.getElementById('downloadPdf');
      const refreshBtn = document.getElementById('refreshBtn');
      const editBtn = document.getElementById('editStudent');

      async function fetchStudent() {
        statusEl.textContent = 'Loading student…';
        try {
          let s = null;
          let studentKey = null;
          if (paramsKey) {
            const snap = await db.ref('students/' + paramsKey).once('value');
            s = snap.val() || null;
            studentKey = paramsKey;
          } else if (paramsAdm) {
            const snap = await db.ref('students').orderByChild('admissionNumber').equalTo(paramsAdm).once('value');
            const obj = snap.val() || {};
            const firstKey = Object.keys(obj)[0];
            studentKey = firstKey || null;
            s = firstKey ? obj[firstKey] : null;
          } else {
            statusEl.textContent = 'No key or admission number provided in URL. Use ?key=FIREBASE_KEY or ?adm=ADM_NUMBER.';
            return;
          }
          if (!s) {
            statusEl.textContent = 'Student not found.';
            detailsBlock.innerHTML = '';
            return;
          }
          statusEl.textContent = '';
          renderStudent(s, studentKey);
        } catch (err) {
          statusEl.textContent = 'Error loading student: ' + err.message;
          console.error(err);
        }
      }

      function safePhoto(s) {
        return s.passportPhotoURL || s.passportPhotoUrl || s.passportPhoto || s.photoUrl || 'https://via.placeholder.com/100x120';
      }

      function renderStudent(s, studentKey) {
        const fullName = [s.firstName, s.middleName, s.lastName].filter(Boolean).join(' ').trim();
        const photo = safePhoto(s);
        const paidAmount = (s.payments) ? Object.values(s.payments).reduce((a, b) => (a + Number(b.amount || 0)), 0) : 0;
        const feePerYear = Number(s.feePerYear || 0);
        const debt = Math.max(0, feePerYear - paidAmount);
        const dateReg = s.timestamp ? new Date(s.timestamp).toLocaleDateString() : (s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'N/A');

        // Details block
        detailsBlock.innerHTML = `
          <div class="detail-item"><span class="detail-label">Full Name:</span> <span class="detail-value">${escapeHtml(fullName)}</span></div>
          <div class="detail-item"><span class="detail-label">Class:</span> <span class="detail-value">${escapeHtml(s.classLevel || 'N/A')}</span></div>
          <div class="detail-item"><span class="detail-label">Date of Registration:</span> <span class="detail-value">${escapeHtml(dateReg)}</span></div>
          <div class="detail-item"><span class="detail-label">Parent Contact:</span> <span class="detail-value">${escapeHtml(s.primaryParentContact || 'N/A')}</span></div>
          <div class="detail-item"><span class="detail-label">Fee Total:</span> <span class="detail-value">${escapeHtml(String(feePerYear))}</span></div>
          <div class="detail-item"><span class="detail-label">Paid Amount:</span> <span class="detail-value">${escapeHtml(String(paidAmount))}</span></div>
          <div class="detail-item"><span class="detail-label">Debt:</span> <span class="detail-value">${escapeHtml(String(debt))}</span></div>
          <div class="detail-item"><span class="detail-label">Payment Plan:</span> <span class="detail-value">${escapeHtml(s.paymentPlan || 'N/A')}</span></div>
          <div class="detail-item"><span class="detail-label">Residential Address:</span> <span class="detail-value">${escapeHtml(s.residentialAddress || 'N/A')}</span></div>
          <div class="detail-item"><span class="detail-label">Admission Number:</span> <span class="detail-value">${escapeHtml(s.admissionNumber || 'N/A')}</span></div>
        `;

        // Fill ID preview
        document.getElementById('idPhotoSmall').src = photo;
        document.getElementById('idFullName').textContent = `Full Name: ${fullName}`;
        document.getElementById('idClass').textContent = `Class: ${s.classLevel || 'N/A'}`;
        document.getElementById('idAdmission').textContent = `Admission No: ${s.admissionNumber || 'N/A'}`;
        document.getElementById('idParent').textContent = `Parent Contact: ${s.primaryParentContact || 'N/A'}`;
        document.getElementById('idSchoolContact').textContent = `School Contact: +255 686 828 732`;
        document.getElementById('idSchoolEmail').textContent = `School Email: socratesschool2020@gmail.com`;
        document.getElementById('idYearVal').textContent = new Date().getFullYear();
      }

      function escapeHtml(text) {
        if (text === undefined || text === null) return '';
        return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
      }

      // PDF generation (matches previous style, but improved with colors)
      function generatePdfID(student, fullName, photoUrl) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("landscape", "mm", "credit-card");

        // Colors
        const primaryColor = "#4f46e5"; // Indigo blue
        const textColor = "#1f2937"; // Dark gray

        // Background
        doc.setFillColor("#f0f9ff"); // Light blue
        doc.rect(0, 0, 85.6, 54, "F");

        // Top Bar
        doc.setFillColor(primaryColor);
        doc.rect(0, 0, 85.6, 10, "F");
        doc.setTextColor("#FFFFFF");
        doc.setFontSize(10);
        doc.text("STUDENT ID CARD", 42.8, 7, { align: "center" });

        // School Logo (adjust path)
        try {
          doc.addImage("images/somap-logo.png.jpg", "PNG", 2, 2, 8, 8);
        } catch (e) {
          console.warn("Logo not found, skipping.");
        }

        // Student Photo
        if (photoUrl) {
          try {
            doc.addImage(photoUrl, "JPEG", 2, 12, 20, 25);
          } catch (e) {
            doc.setDrawColor(0);
            doc.rect(2, 12, 20, 25);
            doc.text("Photo", 12, 25, { align: "center" });
          }
        } else {
          doc.setDrawColor(0);
          doc.rect(2, 12, 20, 25);
          doc.text("Photo", 12, 25, { align: "center" });
        }

        // Student Details
        const admissionNo = student.admissionNumber || "N/A";
        const classLevel = student.classLevel || "N/A";
        const parentContact = student.primaryParentContact || "N/A";
        doc.setTextColor(textColor);
        doc.setFontSize(8);
        let startX = 25, startY = 15;
        doc.text(`Full Name: ${fullName}`, startX, startY);
        doc.text(`Class: ${classLevel}`, startX, startY + 6);
        doc.text(`Admission No: ${admissionNo}`, startX, startY + 12);
        doc.text(`Parent Contact: ${parentContact}`, startX, startY + 18);
        doc.text(`School Contact: +255 686 828 732`, startX, startY + 24);
        doc.text(`School Email: socratesschool2020@gmail.com`, startX, startY + 30);
        doc.text(`Year: ${new Date().getFullYear()}`, startX, startY + 36);

        // Bottom Bar
        doc.setFillColor(primaryColor);
        doc.rect(0, 46, 85.6, 8, "F");
        doc.setTextColor("#FFFFFF");
        doc.setFontSize(7);
        doc.text("Issued by Socrates School", 42.8, 51, { align: "center" });

        // Save PDF
        const safeName = (fullName || "student").replace(/\s+/g, "_");
        doc.save(`${safeName}_ID.pdf`);
      }

      // Start fetch
      fetchStudent();

      refreshBtn.onclick = fetchStudent;
      editBtn.onclick = () => {
        // Redirect to admission.html with key or adm for editing (implement edit in admission.html)
        const editUrl = '../admission.html?key=' + (studentKey || '');
        window.location.href = editUrl;
      };
    })();
  </script>
</body>
</html>