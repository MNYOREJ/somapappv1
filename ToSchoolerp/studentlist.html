<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp — Students List</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: Inter, system-ui, Arial; background:#f8fafc; color:#0f172a; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border:1px solid #e6e9ef; text-align:left; font-size:13px; }
    thead th { background:#eef2ff; color:#0b69ff; }
    .hidden { display:none !important; }
    .block { display:block !important; }
    .student-card { background:#fff; border:1px solid #e6e9ef; border-radius:8px; padding:10px; margin-bottom:10px; }
    .hint { font-size:12px; color:#6b7280; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:.5rem .85rem; border-radius:.5rem; }
    .modal { display:none; position:fixed; inset:0; width:100%; height:100%;
             background-color: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { position:relative; background:#fff; margin:0 auto; padding:20px;
      border-radius:10px; width:95%; max-width:920px; height:90vh; overflow-y:auto; margin-top:20px; }
    .close { position:absolute; top:10px; right:16px; font-size:24px; cursor:pointer; }
  </style>
</head>
<body class="bg-gray-50 p-4">

  <!-- Back to Dashboard -->
  <div class="mb-4">
    <a href="../schoolerp.html" class="text-indigo-600 hover:underline flex items-center gap-2 mb-4">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Students List Content -->
  <div class="bg-white rounded-lg shadow p-4">
    <h3 class="font-medium text-gray-800">Student List</h3>
    <p class="text-sm text-gray-500 mb-3">Filter by class and download the list.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="student-list-class" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="">All Classes</option>
        <option>Baby Class</option>
        <option>Class 1</option>
        <option>Class 2</option>
        <option>Class 3</option>
        <option>Class 4</option>
        <option>Class 5</option>
        <option>Class 6</option>
        <option>Class 7</option>
      </select>

      <div class="ml-auto flex gap-2">
        <button id="downloadCsvBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="downloadPdfBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="student-list-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Date of Registration</th>
            <th>Passport Photo</th>
            <th>Parent Contact</th>
            <th>Fee Total</th>
            <th>Paid Amount</th>
            <th>Debt</th>
            <th>Payment Plan</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="studentListBody">
          <!-- filled by JS -->
        </tbody>
      </table>
    </div>

    <hr class="my-6">

    <h3 class="font-medium text-gray-800 mt-4">School Reports</h3>
    <p class="text-sm text-gray-500 mb-3">Download reports per school, class, month, term, year.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="school-report-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="per-school">Per School</option>
        <option value="per-class">Per Class</option>
        <option value="per-month">Per Month</option>
        <option value="per-term">Per Term</option>
        <option value="per-year">Per Year</option>
      </select>
      <div class="ml-auto flex gap-2">
        <button id="schoolDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="schoolDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="school-report-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Parents Contact</th>
            <th>Fee Per Year</th>
            <th>Paid Amount</th>
            <th>Debt</th>
          </tr>
        </thead>
        <tbody id="schoolReportBody"></tbody>
      </table>
    </div>

    <hr class="my-6">

    <h3 class="font-medium text-gray-800 mt-4">Report Forms</h3>
    <p class="text-sm text-gray-500 mb-3">Download report forms with student details.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="report-form-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="per-student">Per Student</option>
        <option value="per-class">Per Class</option>
        <option value="per-term">Per Term</option>
      </select>
      <div class="ml-auto flex gap-2">
        <button id="reportDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="reportDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="report-form-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Parents Contact</th>
            <th>Fee Per Year</th>
            <th>Paid Amount</th>
            <th>Debt</th>
          </tr>
        </thead>
        <tbody id="reportFormBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Student Details Modal -->
  <div id="detailsModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span id="closeDetailsModal" class="close" title="Close">&times;</span>
      <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Student Details</h2>
      <div id="studentDetails" class="space-y-2"></div>
      <div class="mt-4">
        <button id="generateIDCard" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          Generate ID Card (PDF)
        </button>
      </div>
    </div>
  </div>

  <!-- Third-party libraries (CSV + PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDKs (compat) + your config -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="../firebase.js"></script> <!-- Adjusted path to firebase.js in root -->

  <!-- Students List Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('studentlist.html loaded'); // Debug log

      // ---- Resolve Firebase handles gracefully ----
      const db = window.db || (window.firebase && firebase.database ? firebase.database() : null);

      if (!db) {
        console.error('Firebase Realtime Database not available. Ensure ../firebase.js and Firebase SDKs are loaded.');
      } else {
        console.log('Firebase DB initialized successfully');
      }

      // ---- Live cache + rendering ----
      let cachedStudents = []; // array of { key, ...data }

      if (db) {
        db.ref('students').on('value', (snapshot) => {
          console.log('Students data received:', snapshot.val()); // Debug log
          const raw = snapshot.val() || {};
          cachedStudents = Object.entries(raw).map(([key, s]) => ({ key, ...s }));
          console.log('Cached students:', cachedStudents.length); // Debug log
          renderAllTables(); // render with current cache + filter
        });
      } else {
        console.warn('No DB, using empty students list');
        renderAllTables();
      }

      // Utility to calculate paid amount from payments (matching finance.html)
      function calculatePaidAmount(student) {
        if (!student.payments) return 0;
        return Object.values(student.payments).reduce((sum, payment) => sum + (Number(payment.amount) || 0), 0);
      }

      // Utility to calculate debt
      function calculateDebt(student) {
        const feePerYear = Number(student.feePerYear) || 0;
        const paidAmount = calculatePaidAmount(student);
        return Math.max(0, feePerYear - paidAmount);
      }

      // ---- Students rendering ----
      function renderAllTables() {
        console.log('Rendering tables with', cachedStudents.length, 'students'); // Debug log
        const classFilter = document.getElementById('student-list-class') ? document.getElementById('student-list-class').value || '' : '';
        const listBody = document.getElementById('studentListBody');
        const schoolReportBody = document.getElementById('schoolReportBody');
        const reportFormBody = document.getElementById('reportFormBody');
        if (!listBody || !schoolReportBody || !reportFormBody) {
          console.error('Table bodies not found');
          return;
        }

        listBody.innerHTML = '';
        const filtered = cachedStudents.filter(s => !classFilter || s.classLevel === classFilter);

        filtered.forEach(s => {
          const paidAmount = calculatePaidAmount(s);
          const debt = calculateDebt(s);
          const tr = document.createElement('tr');
          const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
          const dateReg = s.timestamp ? new Date(s.timestamp).toLocaleDateString() :
                          s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'N/A';
          const photoURL = s.passportPhotoURL || 'https://via.placeholder.com/50';
          tr.innerHTML = `
            <td>${escapeHtml(s.admissionNumber || 'N/A')}</td>
            <td>${escapeHtml(fullName)}</td>
            <td>${escapeHtml(s.classLevel || 'N/A')}</td>
            <td>${escapeHtml(dateReg)}</td>
            <td><img src="${escapeHtml(photoURL)}" alt="photo" style="width:50px;height:50px;object-fit:cover;border-radius:4px"/></td>
            <td>${escapeHtml(s.primaryParentContact || 'N/A')}</td>
            <td>${escapeHtml(String(s.feePerYear || 0))}</td>
            <td>${escapeHtml(String(paidAmount))}</td>
            <td>${escapeHtml(String(debt))}</td>
            <td>${escapeHtml(s.paymentPlan || 'N/A')}</td>
            <td><button class="py-1 px-2 border rounded text-indigo-600" data-view="${s.key}">
                  <i class="fas fa-eye"></i>
                </button></td>
          `;
          listBody.appendChild(tr);
        });

        // Attach one delegated listener for view buttons
        listBody.onclick = (e) => {
          const btn = e.target.closest('button[data-view]');
          if (!btn) return;
          const key = btn.getAttribute('data-view');
          openDetails(key);
        };

        // School Reports + Report Forms (same structure, with calculated payments)
        schoolReportBody.innerHTML = '';
        reportFormBody.innerHTML = '';
        cachedStudents.forEach(s => {
          const paidAmount = calculatePaidAmount(s);
          const debt = calculateDebt(s);
          const rowHtml = `
            <td>${escapeHtml(s.admissionNumber || 'N/A')}</td>
            <td>${escapeHtml((s.firstName || '') + ' ' + (s.lastName || ''))}</td>
            <td>${escapeHtml(s.classLevel || 'N/A')}</td>
            <td>${escapeHtml(s.primaryParentContact || 'N/A')}</td>
            <td>${escapeHtml(String(s.feePerYear || 0))}</td>
            <td>${escapeHtml(String(paidAmount))}</td>
            <td>${escapeHtml(String(debt))}</td>
          `;
          const tr1 = document.createElement('tr'); tr1.innerHTML = rowHtml;
          const tr2 = document.createElement('tr'); tr2.innerHTML = rowHtml;
          schoolReportBody.appendChild(tr1);
          reportFormBody.appendChild(tr2);
        });
      }

      document.getElementById('student-list-class')
        .addEventListener('change', renderAllTables);

      function escapeHtml(text) {
        if (text === undefined || text === null) return '';
        return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
      }

      // Initial render
      renderAllTables();

      // ---- Details Modal ----
      async function openDetails(key) {
        if (!db) return alert('DB not ready');
        try {
          const snap = await db.ref('students/' + key).once('value');
          const s = snap.val() || {};
          const details = document.getElementById('studentDetails');
          const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.trim();
          const photoURL = s.passportPhotoURL || 'https://via.placeholder.com/120';
          const paidAmount = calculatePaidAmount(s);
          const debt = calculateDebt(s);
          details.innerHTML = `
            <p><strong>Full Name:</strong> ${escapeHtml(fullName)}</p>
            <p><strong>Class:</strong> ${escapeHtml(s.classLevel || 'N/A')}</p>
            <p><strong>Date of Registration:</strong> ${s.timestamp ? new Date(s.timestamp).toLocaleDateString() : (s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'N/A')}</p>
            <p><strong>Passport Photo:</strong><br/><img src="${escapeHtml(photoURL)}" alt="photo" style="width:120px;height:120px;object-fit:cover;border-radius:6px"/></p>
            <p><strong>Parent Contact:</strong> ${escapeHtml(s.primaryParentContact || 'N/A')}</p>
            <p><strong>Fee Total:</strong> ${escapeHtml(String(s.feePerYear || 0))}</p>
            <p><strong>Paid Amount:</strong> ${escapeHtml(String(paidAmount))}</p>
            <p><strong>Debt:</strong> ${escapeHtml(String(debt))}</p>
            <p><strong>Payment Plan:</strong> ${escapeHtml(s.paymentPlan || 'N/A')}</p>
            <p><strong>Residential Address:</strong> ${escapeHtml(s.residentialAddress || 'N/A')}</p>
            <p><strong>Admission Number:</strong> ${escapeHtml(s.admissionNumber || 'N/A')}</p>
          `;
          document.getElementById('generateIDCard').onclick = () => generateIDCard(s);
          document.getElementById('detailsModal').style.display = 'block';
        } catch (err) {
          console.error('Error fetching details:', err);
        }
      }
      document.getElementById('closeDetailsModal').addEventListener('click', () => {
        document.getElementById('detailsModal').style.display = 'none';
      });

      // ---- ID Card PDF ----
      function generateIDCard(student) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("landscape", "mm", "credit-card");

        // Colors
        const primaryColor = "#0b3d91"; // dark blue
        const textColor = "#000000";

        // Background
        doc.setFillColor("#f5f5f5");
        doc.rect(0, 0, 85.6, 54, "F");

        // Top Bar
        doc.setFillColor(primaryColor);
        doc.rect(0, 0, 85.6, 10, "F");
        doc.setTextColor("#FFFFFF");
        doc.setFontSize(10);
        doc.text("STUDENT ID CARD", 42.8, 7, { align: "center" });

        // School Logo (already in your folder, e.g. "assets/logo.png")
        try {
          doc.addImage("../images/somap-logo.png.jpg", "PNG", 2, 2, 8, 8);
        } catch (e) {
          console.warn("⚠️ Logo not found, ensure '../images/somap-logo.png.jpg' exists.");
        }

        // Student Photo
        if (student.passportPhotoURL) {
          try {
            doc.addImage(student.passportPhotoURL, "JPEG", 2, 12, 20, 25);
          } catch (e) {
            doc.setDrawColor(0);
            doc.rect(2, 12, 20, 25);
            doc.text("Photo", 12, 25, { align: "center" });
          }
        } else {
          doc.setDrawColor(0);
          doc.rect(2, 12, 20, 25);
          doc.text("Photo", 12, 25, { align: "center" });
        }

        // Student Details (correct mapping to your DB fields)
        const fullName = `${student.firstName || ""} ${student.middleName || ""} ${student.lastName || ""}`.trim();
        const admissionNo = student.admissionNumber || "N/A";
        const classLevel = student.classLevel || "N/A";
        const parentContact = student.primaryParentContact || "N/A";

        doc.setTextColor(textColor);
        doc.setFontSize(8);

        let startX = 25, startY = 15;
        doc.text(`Full Name: ${fullName}`, startX, startY);
        doc.text(`Class: ${classLevel}`, startX, startY + 6);
        doc.text(`Admission No: ${admissionNo}`, startX, startY + 12);
        doc.text(`Parent Contact: ${parentContact}`, startX, startY + 18);
        doc.text(`School Contact: +255686828732`, startX, startY + 24);
        doc.text(`Year: ${new Date().getFullYear()}`, startX, startY + 30);

        // Bottom Bar
        doc.setFillColor(primaryColor);
        doc.rect(0, 46, 85.6, 8, "F");
        doc.setTextColor("#FFFFFF");
        doc.setFontSize(7);
        doc.text("Issued by Socrates School", 42.8, 51, { align: "center" });

        // Save PDF
        const safeName = (fullName || "student").replace(/\s+/g, "_");
        doc.save(`${safeName}_ID.pdf`);
        console.log('ID card generated and saved'); // Debug log
      }

      // ---- CSV & PDF downloads for tables ----
      async function downloadCSVforTab(filenameBase) {
        console.log('Download CSV clicked for:', filenameBase); // Debug log
        if (!cachedStudents.length) {
          alert('No data to download');
          return;
        }
        const classFilter = document.getElementById('student-list-class') ? document.getElementById('student-list-class').value || '' : '';
        const list = (filenameBase === 'student-list')
          ? cachedStudents.filter(s => !classFilter || s.classLevel === classFilter)
          : cachedStudents;

        const arr = list.map(s => {
          const paidAmount = calculatePaidAmount(s);
          const debt = calculateDebt(s);
          return {
            'Admission No': s.admissionNumber || 'N/A',
            'Full Name': `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim(),
            'Class': s.classLevel || 'N/A',
            'Date of Registration': s.timestamp ? new Date(s.timestamp).toLocaleDateString() :
                                   (s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'N/A'),
            'Parent Contact': s.primaryParentContact || 'N/A',
            'Fee Total': s.feePerYear || 0,
            'Paid Amount': paidAmount,
            'Debt': debt,
            'Payment Plan': s.paymentPlan || 'N/A'
          };
        });

        const csv = Papa.unparse(arr);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filenameBase}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log('CSV downloaded'); // Debug log
      }

      async function downloadPDFforTab(filenameBase) {
        console.log('Download PDF clicked for:', filenameBase); // Debug log
        if (!cachedStudents.length) {
          alert('No data to download');
          return;
        }
        const classFilter = document.getElementById('student-list-class') ? document.getElementById('student-list-class').value || '' : '';
        const list = (filenameBase === 'student-list')
          ? cachedStudents.filter(s => !classFilter || s.classLevel === classFilter)
          : cachedStudents;

        const rows = list.map(s => {
          const paidAmount = calculatePaidAmount(s);
          const debt = calculateDebt(s);
          return [
            s.admissionNumber || 'N/A',
            `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim(),
            s.classLevel || 'N/A',
            s.timestamp ? new Date(s.timestamp).toLocaleDateString() :
              (s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'N/A'),
            s.primaryParentContact || 'N/A',
            s.feePerYear || 0,
            paidAmount,
            debt,
            s.paymentPlan || 'N/A'
          ];
        });
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          alert('jsPDF not loaded');
          return;
        }
        const doc = new jsPDF({ orientation: 'landscape' });
        doc.setFontSize(14);
        doc.text(`${filenameBase.replace('-', ' ')} Report`, 14, 10);
        doc.autoTable({
          head: [['Admission No','Full Name','Class','Date of Registration','Parent Contact','Fee Total','Paid Amount','Debt','Payment Plan']],
          body: rows,
          startY: 18,
          styles: { fontSize: 8 }
        });
        doc.save(`${filenameBase}.pdf`);
        console.log('PDF downloaded'); // Debug log
      }

      // Event listeners for download buttons
      const downloadCsvBtn = document.getElementById('downloadCsvBtn');
      const downloadPdfBtn = document.getElementById('downloadPdfBtn');
      const schoolDownloadCsv = document.getElementById('schoolDownloadCsv');
      const schoolDownloadPdf = document.getElementById('schoolDownloadPdf');
      const reportDownloadCsv = document.getElementById('reportDownloadCsv');
      const reportDownloadPdf = document.getElementById('reportDownloadPdf');

      if (downloadCsvBtn) downloadCsvBtn.addEventListener('click', () => downloadCSVforTab('student-list'));
      if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', () => downloadPDFforTab('student-list'));
      if (schoolDownloadCsv) schoolDownloadCsv.addEventListener('click', () => downloadCSVforTab('school-reports'));
      if (schoolDownloadPdf) schoolDownloadPdf.addEventListener('click', () => downloadPDFforTab('school-reports'));
      if (reportDownloadCsv) reportDownloadCsv.addEventListener('click', () => downloadCSVforTab('report-forms'));
      if (reportDownloadPdf) reportDownloadPdf.addEventListener('click', () => downloadPDFforTab('report-forms'));
    });
  </script>
</body>
</html>