<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp â€” Students List</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: Inter, system-ui, Arial; background:#f8fafc; color:#0f172a; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border:1px solid #e6e9ef; text-align:left; font-size:13px; }
    thead th { background:#eef2ff; color:#0b69ff; }
    .hidden { display:none !important; }
    .block { display:block !important; }
    .student-card { background:#fff; border:1px solid #e6e9ef; border-radius:8px; padding:10px; margin-bottom:10px; }
    .hint { font-size:12px; color:#6b7280; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:.5rem .85rem; border-radius:.5rem; }
    .modal { display:none; position:fixed; inset:0; width:100%; height:100%;
             background-color: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { position:relative; background:#fff; margin:0 auto; padding:20px;
      border-radius:10px; width:95%; max-width:920px; height:90vh; overflow-y:auto; margin-top:20px; }
    .close { position:absolute; top:10px; right:16px; font-size:24px; cursor:pointer; }
  </style>

  <script>
  /** Year range + anchor **/
  const SOMAP_ALLOWED_YEARS = Array.from({length: 20}, (_,i)=>2023+i); // 2023..2042
  const SOMAP_DEFAULT_YEAR = 2025;

  /** Tanzania class ladder (no Class 8). Keep labels EXACTLY. */
  const CLASS_ORDER = ['Baby Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
  const L = s => String(s||'').trim().toLowerCase();

  /** Shift a base class by delta years relative to anchor (2025). */
  function shiftClass(baseClass, deltaYears){
    const i = CLASS_ORDER.findIndex(c => L(c)===L(baseClass));
    if (i<0) return baseClass||'';
    const j = i + Number(deltaYears||0);
    if (j < 0) return 'PRE-ADMISSION';
    if (j >= CLASS_ORDER.length) return 'GRADUATED';
    return CLASS_ORDER[j];
  }
  </script>

  <script>
  /** Reuse shared year context if present, else create a light fallback. */
  window.somapYearContext = window.somapYearContext || (function(){
    let selected = (sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR)+'';
    const listeners = new Set();
    return {
      getSelectedYear(){ return selected; },
      setSelectedYear(y){
        y = String(y);
        if (selected===y) return;
        selected = y;
        try{ sessionStorage.setItem('somap_selected_year', y); }catch(_e){}
        listeners.forEach(fn=>{ try{ fn(y); }catch(err){ console.error(err); } });
      },
      onYearChanged(fn){ if (typeof fn==='function') listeners.add(fn); }
    };
  })();
  </script>
</head>
<body class="bg-gray-50 p-4">

  <!-- Back to Dashboard -->
  <div class="mb-4">
    <a href="../schoolerp.html" class="text-indigo-600 hover:underline flex items-center gap-2 mb-4">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Students List Content -->
  <div class="bg-white rounded-lg shadow p-4">
    <h3 class="font-medium text-gray-800">Student List</h3>
    <p class="text-sm text-gray-500 mb-3">Filter by class and download the list.</p>

    <div id="somapYearWrap" style="display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;">
      <label class="text-xs font-semibold">Academic Year</label>
      <select data-somap-year-select class="border rounded px-2 py-1 text-sm"></select>
      <span class="text-xs text-slate-600">Working year: <b id="somapYearHint">--</b></span>
    </div>

    <script>
    (function initYearSelector(){
      const sel = document.querySelector('[data-somap-year-select]');
      const hint = document.getElementById('somapYearHint');
      if (!sel) return;
      sel.innerHTML = SOMAP_ALLOWED_YEARS.map(y=>`<option value="${y}">${y}</option>`).join('');
      const current = window.somapYearContext.getSelectedYear();
      sel.value = current;
      if (hint) hint.textContent = current;
      sel.addEventListener('change', e=>{
        const y = String(e.target.value);
        window.somapYearContext.setSelectedYear(y);
        if (hint) hint.textContent = y;
      });
    })();
    </script>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="student-list-class" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="">All Classes</option>
        <option>Baby Class</option>
        <option>Middle Class</option>
        <option>Pre Unit Class</option>
        <option>Class 1</option>
        <option>Class 2</option>
        <option>Class 3</option>
        <option>Class 4</option>
        <option>Class 5</option>
        <option>Class 6</option>
        <option>Class 7</option>
      </select>

      <div class="ml-auto flex gap-2">
        <button id="downloadCsvBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="downloadPdfBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="student-list-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Date of Registration</th>
            <th>Passport Photo</th>
            <th>Parent Contact</th>
            <th>Fee Total</th>
            <th>Paid Amount</th>
            <th>Debt</th>
            <th>Payment Plan</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="studentListBody">
          <!-- filled by JS -->
        </tbody>
      </table>
    </div>

    <hr class="my-6">

    <h3 class="font-medium text-gray-800 mt-4">School Reports</h3>
    <p class="text-sm text-gray-500 mb-3">Download reports per school, class, month, term, year.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="school-report-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="per-school">Per School</option>
        <option value="per-class">Per Class</option>
        <option value="per-month">Per Month</option>
        <option value="per-term">Per Term</option>
        <option value="per-year">Per Year</option>
      </select>
      <div class="ml-auto flex gap-2">
        <button id="schoolDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="schoolDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="school-report-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Parents Contact</th>
            <th>Fee Per Year</th>
            <th>Paid Amount</th>
            <th>Debt</th>
          </tr>
        </thead>
        <tbody id="schoolReportBody"></tbody>
      </table>
    </div>

    <hr class="my-6">

    <h3 class="font-medium text-gray-800 mt-4">Report Forms</h3>
    <p class="text-sm text-gray-500 mb-3">Download report forms with student details.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="report-form-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="per-student">Per Student</option>
        <option value="per-class">Per Class</option>
        <option value="per-term">Per Term</option>
      </select>
      <div class="ml-auto flex gap-2">
        <button id="reportDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="reportDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="report-form-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Parents Contact</th>
            <th>Fee Per Year</th>
            <th>Paid Amount</th>
            <th>Debt</th>
          </tr>
        </thead>
        <tbody id="reportFormBody"></tbody>
      </table>
    </div>
  </div>

   <!-- Third-party libraries (CSV + PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDKs (compat) + your config -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="../firebase.js"></script> <!-- Adjusted path to firebase.js in root -->

  <!-- Students List Logic -->
  <script type="module">
    import { resolveEffectiveFinance, readPlan } from '../js/financeplans.js';

    document.addEventListener('DOMContentLoaded', () => {
      const db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
      if (!db) {
        console.error('Firebase Realtime Database not available. Ensure ../firebase.js and Firebase SDKs are loaded.');
        return;
      }

      const elements = {
        listBody: document.getElementById('studentListBody'),
        schoolReportBody: document.getElementById('schoolReportBody'),
        reportFormBody: document.getElementById('reportFormBody'),
        classFilter: document.getElementById('student-list-class'),
        downloadCsvBtn: document.getElementById('downloadCsvBtn'),
        downloadPdfBtn: document.getElementById('downloadPdfBtn'),
        schoolDownloadCsv: document.getElementById('schoolDownloadCsv'),
        schoolDownloadPdf: document.getElementById('schoolDownloadPdf'),
        reportDownloadCsv: document.getElementById('reportDownloadCsv'),
        reportDownloadPdf: document.getElementById('reportDownloadPdf'),
      };

      const withSchool = (path) => window.currentSchoolId ? `schools/${window.currentSchoolId}/${path}` : path;
      const currencyFormatter = new Intl.NumberFormat('en-US', { minimumFractionDigits: 0 });
      const fmtCurrency = (value) => `TSh ${currencyFormatter.format(Number(value) || 0)}`;
      const normalize = (value) => String(value || '').trim().toLowerCase();
      const getWorkingYear = () => window.somapYearContext?.getSelectedYear?.() || SOMAP_DEFAULT_YEAR;

      const state = {
        students: new Map(),
        anchorEnrollments: {},
        yearEnrollments: {},
        ledger: {},
        planCache: new Map(),
        latestRecords: [],
        latestYear: getWorkingYear(),
        renderToken: 0,
        yearEnrollRef: null,
        ledgerRef: null,
      };

      const queueRender = () => {
        renderAllTables().catch((err) => console.error('Render error', err));
      };

      function resolveClassForYear(studentId, fallbackClass, year) {
        const override = state.yearEnrollments[studentId] || {};
        if (override && (override.className || override.classLevel)) {
          return override.className || override.classLevel;
        }
        const anchor = state.anchorEnrollments[studentId] || {};
        const baseClass = anchor.className || anchor.classLevel || fallbackClass || '';
        const delta = Number(year) - SOMAP_DEFAULT_YEAR;
        return shiftClass(baseClass, delta);
      }

      async function planLabelFor(planId, year) {
        if (!planId) return '';
        const key = `${year}::${planId}`;
        if (state.planCache.has(key)) return state.planCache.get(key);
        try {
          const plan = await readPlan(planId, { year });
          const label = plan?.name || planId;
          state.planCache.set(key, label);
          return label;
        } catch (err) {
          console.warn('Plan lookup failed', planId, err);
          return planId;
        }
      }

      function sumPayments(ledgerEntry) {
        if (!ledgerEntry || typeof ledgerEntry !== 'object') return 0;
        const source = ledgerEntry.payments || ledgerEntry.entries || ledgerEntry.records || ledgerEntry;
        return Object.values(source || {}).reduce((total, entry) => {
          const amount = Number(entry?.amount ?? entry?.value ?? entry?.paid ?? entry?.total ?? 0);
          return Number.isFinite(amount) && amount > 0 ? total + amount : total;
        }, 0);
      }

      function escapeHtml(text) {
        if (text === undefined || text === null) return '';
        return String(text).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
      }

      function attachYearListeners(year) {
        const yearStr = String(year);
        if (state.yearEnrollRef) state.yearEnrollRef.off();
        if (state.ledgerRef) state.ledgerRef.off();

        state.yearEnrollRef = db.ref(`enrollments/${yearStr}`);
        state.yearEnrollRef.on('value', (snap) => {
          state.yearEnrollments = snap.val() || {};
          queueRender();
        });

        state.ledgerRef = db.ref(withSchool(`financeLedgers/${yearStr}`));
        state.ledgerRef.on('value', (snap) => {
          state.ledger = snap.val() || {};
          queueRender();
        });
      }

      db.ref('students').on('value', (snapshot) => {
        const raw = snapshot.val() || {};
        state.students.clear();
        Object.entries(raw).forEach(([key, value]) => {
          state.students.set(key, { key, ...(value || {}) });
        });
        queueRender();
      });

      db.ref(`enrollments/${SOMAP_DEFAULT_YEAR}`).on('value', (snapshot) => {
        state.anchorEnrollments = snapshot.val() || {};
        queueRender();
      });

      attachYearListeners(getWorkingYear());

      window.somapYearContext.onYearChanged((newYear) => {
        const year = String(newYear);
        state.planCache.clear();
        attachYearListeners(year);
        state.latestYear = year;
        const sel = document.querySelector('[data-somap-year-select]');
        const hint = document.getElementById('somapYearHint');
        if (sel) sel.value = year;
        if (hint) hint.textContent = year;
        queueRender();
      });

      if (elements.classFilter) {
        elements.classFilter.addEventListener('change', queueRender);
      }

      [
        [elements.downloadCsvBtn, () => downloadCSV('student-list')],
        [elements.downloadPdfBtn, () => downloadPDF('student-list')],
        [elements.schoolDownloadCsv, () => downloadCSV('school-reports')],
        [elements.schoolDownloadPdf, () => downloadPDF('school-reports')],
        [elements.reportDownloadCsv, () => downloadCSV('report-forms')],
        [elements.reportDownloadPdf, () => downloadPDF('report-forms')],
      ].forEach(([btn, handler]) => {
        if (btn) btn.addEventListener('click', handler);
      });

      queueRender();

      async function renderAllTables() {
        const listBody = elements.listBody;
        const schoolReportBody = elements.schoolReportBody;
        const reportFormBody = elements.reportFormBody;
        if (!listBody || !schoolReportBody || !reportFormBody) return;

        const year = getWorkingYear();
        state.latestYear = year;
        const generation = ++state.renderToken;

        const studentsArray = Array.from(state.students.values());
        const records = await Promise.all(studentsArray.map(async (stu) => {
          const fallbackClass = stu.classLevel || stu.className || '';
          const resolvedClass = resolveClassForYear(stu.key, fallbackClass, year) || fallbackClass || 'N/A';
          const anchorClass = state.anchorEnrollments[stu.key]?.className || state.anchorEnrollments[stu.key]?.classLevel || fallbackClass;
          let finance = { fee: 0, planId: null, feeOverride: null };
          try {
            finance = await resolveEffectiveFinance(stu.key, resolvedClass, { anchorClass, year });
          } catch (err) {
            console.error('resolveEffectiveFinance error', stu.key, err);
          }
          const planLabel = await planLabelFor(finance.planId, year);
          const ledgerEntry = state.ledger?.[stu.key] || {};
          const paidAmount = sumPayments(ledgerEntry);
          const feeValue = Number(finance.fee || 0);
          const debtAmount = Math.max(0, feeValue - paidAmount);
          const fullName = `${stu.firstName || ''} ${stu.middleName || ''} ${stu.lastName || ''}`.replace(/\s+/g, ' ').trim();
          const registrationDate = stu.timestamp
            ? new Date(stu.timestamp).toLocaleDateString()
            : (stu.createdAt ? new Date(stu.createdAt).toLocaleDateString() : 'N/A');
          const photoURL = stu.passportPhotoURL || 'https://via.placeholder.com/50';
          const isOverrideLocked = finance.feeOverride && (finance.feeOverride.locked !== false);
          const feeSource = isOverrideLocked ? 'Override' : 'Class default';
          return {
            key: stu.key,
            admissionNo: stu.admissionNumber || 'N/A',
            fullName: fullName || 'N/A',
            classLabel: resolvedClass === 'GRADUATED' ? `Graduated (${year})` : resolvedClass,
            rawClass: resolvedClass,
            registrationDate,
            photoURL,
            contact: stu.primaryParentContact || 'N/A',
            fee: feeValue,
            paid: paidAmount,
            debt: debtAmount,
            planId: finance.planId || null,
            planLabel,
            isGraduated: resolvedClass === 'GRADUATED',
            feeSource,
          };
        }));

        if (generation !== state.renderToken) return;

        state.latestRecords = records;

        const filterValue = elements.classFilter ? elements.classFilter.value || '' : '';
        const filteredRecords = records.filter((rec) => {
          if (rec.isGraduated) return false;
          if (!filterValue) return true;
          return normalize(rec.classLabel) === normalize(filterValue);
        });

        const buildRow = (rec) => `
  <td>${escapeHtml(rec.admissionNo)}</td>
  <td>${escapeHtml(rec.fullName)}</td>
  <td>${escapeHtml(rec.classLabel)}</td>
  <td>${escapeHtml(rec.registrationDate)}</td>
  <td><img src="${escapeHtml(rec.photoURL)}" alt="photo" style="width:50px;height:50px;object-fit:cover;border-radius:4px"/></td>
  <td>${escapeHtml(rec.contact)}</td>
  <td>${escapeHtml(fmtCurrency(rec.fee))}</td>
  <td>${escapeHtml(fmtCurrency(rec.paid))}</td>
  <td>${escapeHtml(fmtCurrency(rec.debt))}</td>
  <td>${escapeHtml(rec.planLabel || rec.planId || 'Class default')}</td>
  <td>
    <a href="generateid.html?key=${encodeURIComponent(rec.key)}" target="_blank"
       class="py-1 px-2 border rounded text-indigo-600 inline-block" title="Open details & generate ID">
      <i class="fas fa-eye"></i>
    </a>
  </td>
`;

        listBody.innerHTML = '';
        if (!filteredRecords.length) {
          listBody.innerHTML = `<tr><td colspan="11" class="text-center text-sm text-slate-500 py-4">No students for ${escapeHtml(String(year))} yet.</td></tr>`;
        } else {
          filteredRecords.forEach((rec) => {
            const tr = document.createElement('tr');
            tr.innerHTML = buildRow(rec);
            listBody.appendChild(tr);
          });
        }

        const simpleRow = (rec) => `
          <td>${escapeHtml(rec.admissionNo)}</td>
          <td>${escapeHtml(rec.fullName)}</td>
          <td>${escapeHtml(rec.classLabel)}</td>
          <td>${escapeHtml(rec.contact)}</td>
          <td>${escapeHtml(fmtCurrency(rec.fee))}</td>
          <td>${escapeHtml(fmtCurrency(rec.paid))}</td>
          <td>${escapeHtml(fmtCurrency(rec.debt))}</td>
        `;

        const activeRecords = records.filter((rec) => !rec.isGraduated);

        [schoolReportBody, reportFormBody].forEach((tbody) => {
          tbody.innerHTML = '';
          if (!activeRecords.length) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-sm text-slate-500 py-4">No student data for ${escapeHtml(String(year))}.</td></tr>`;
          } else {
            activeRecords.forEach((rec) => {
              const tr = document.createElement('tr');
              tr.innerHTML = simpleRow(rec);
              tbody.appendChild(tr);
            });
          }
        });
      }

      function getRecordsForExport(kind) {
        const year = state.latestYear || getWorkingYear();
        const filterValue = elements.classFilter ? elements.classFilter.value || '' : '';
        let records = state.latestRecords.filter((rec) => !rec.isGraduated);
        if (!records.length) return { year, records: [] };
        if (kind === 'student-list' && filterValue) {
          records = records.filter((rec) => normalize(rec.classLabel) === normalize(filterValue));
        }
        return { year, records };
      }

      function downloadCSV(kind) {
        const { year, records } = getRecordsForExport(kind);
        if (!records.length) {
          alert('No data to download for the selected year.');
          return;
        }
        if (!window.Papa) {
          alert('CSV library not loaded.');
          return;
        }
        const rows = records.map((rec) => ({
          'Admission No': rec.admissionNo,
          'Full Name': rec.fullName,
          'Class': rec.classLabel,
          'Date of Registration': rec.registrationDate,
          'Parent Contact': rec.contact,
          'Fee Total': rec.fee,
          'Paid Amount': rec.paid,
          'Debt': rec.debt,
          'Payment Plan': rec.planLabel || rec.planId || 'Class default',
          'Fee Source': rec.feeSource,
        }));
        const csv = window.Papa.unparse(rows);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${kind}_${year}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function downloadPDF(kind) {
        const { year, records } = getRecordsForExport(kind);
        if (!records.length) {
          alert('No data to download for the selected year.');
          return;
        }
        const jsPDFLib = window.jspdf?.jsPDF;
        if (!jsPDFLib) {
          alert('jsPDF not loaded');
          return;
        }
        const doc = new jsPDFLib({ orientation: 'landscape' });
        doc.setFontSize(14);
        doc.text(`${kind.replace('-', ' ')} Report (${year})`, 14, 10);
        const body = records.map((rec) => [
          rec.admissionNo,
          rec.fullName,
          rec.classLabel,
          rec.registrationDate,
          rec.contact,
          fmtCurrency(rec.fee),
          fmtCurrency(rec.paid),
          fmtCurrency(rec.debt),
          rec.planLabel || rec.planId || 'Class default',
        ]);
        doc.autoTable({
          head: [['Admission No','Full Name','Class','Date of Registration','Parent Contact','Fee Total','Paid Amount','Debt','Payment Plan']],
          body,
          startY: 18,
          styles: { fontSize: 8 },
        });
        doc.save(`${kind}_${year}.pdf`);
      }
    });
  </script>
</body>
</html>
