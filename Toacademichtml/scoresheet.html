<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Scoresheet</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF + autotable (kept for scoresheet table exports, NOT for report cards here) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- FileSaver + SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase compat (v9 compat libs) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>

  <!-- Your Firebase config wrapper (exports window.db, window.storage) -->
  <script src="../firebase.js"></script>

  <style>
    :root {
      --col-num-width: 3.5rem;
      --col-adm-width: 6rem;
      --col-student-width: 16rem;
    }
    .sticky-th th { position: sticky; top:0; background:#fff; z-index:2; }
    .scroll-shadow { box-shadow: inset 0 10px 8px -10px rgba(2,6,23,0.12); }
    .bg-white.rounded-2xl.p-4 { overflow:hidden; }
    .min-w-table { min-width:1200px; }
    /* Ensure the Generate button is always visible */
    #btnCheckScoresheet { display: inline-block !important; visibility: visible !important; opacity: 1 !important; min-width: 120px; }
    .flex.items-center.gap-2 { flex-wrap: nowrap !important; overflow: visible !important; }

    /* Base table (desktop) */
    .scoresheet-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .scoresheet-table th, .scoresheet-table td { border: 1px solid #e5e7eb; padding: 0.35rem 0.5rem; }

    /* Freeze key columns */
    .scoresheet-table .sticky-col-1 { position: sticky; left: 0; z-index: 5; background: #fff; min-width: var(--col-num-width); }
    .scoresheet-table .sticky-col-2 { position: sticky; left: var(--col-num-width); z-index: 5; background: #fff; min-width: var(--col-adm-width); }
    .scoresheet-table .sticky-col-3 { position: sticky; left: calc(var(--col-num-width) + var(--col-adm-width)); z-index: 5; background: #fff; min-width: var(--col-student-width); }

    /* Mobile: card layout instead of wide side-scroll */
    @media (max-width: 768px) {
      html, body {
        height: auto;
        overflow: auto;
      }

      :root {
        --col-num-width: auto;
        --col-adm-width: auto;
        --col-student-width: auto;
      }

      .min-w-table { min-width: 100%; }

      .scoresheet-table,
      .scoresheet-table thead,
      .scoresheet-table tbody,
      .scoresheet-table th,
      .scoresheet-table td,
      .scoresheet-table tr {
        display: block;
      }

      .scoresheet-table thead { display: none; }

      .scoresheet-table tr.scoresheet-row {
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem 0.75rem 0.5rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        background: #ffffff;
      }

      .scoresheet-table td {
        border: none;
        padding: 0.15rem 0;
      }

      .scoresheet-table td[data-label]::before {
        content: attr(data-label) ": ";
        font-weight: 600;
        display: inline-block;
        min-width: 7rem;
      }

      .scoresheet-table input[type="number"],
      .scoresheet-table input[type="text"] {
        width: 6rem;
        max-width: 70%;
      }

      .scoresheet-table textarea {
        width: 100%;
        max-width: 100%;
      }

      .scoresheet-sticky-header {
        position: sticky;
        top: 0;
        background: #f9fafb;
        z-index: 20;
        padding: 0.5rem 0;
      }

      /* Disable sticky on mobile since layout is stacked */
      .scoresheet-table .sticky-col-1,
      .scoresheet-table .sticky-col-2,
      .scoresheet-table .sticky-col-3 {
        position: static;
        left: auto;
        min-width: 100%;
        width: 100%;
        box-shadow: none;
      }

      .mobile-action-bar {
        display: block;
        position: sticky;
        top: 0;
        background: #f9fafb;
        z-index: 30;
        padding: 0.5rem 0;
      }
    }

    /* Desktop hides mobile action bar */
    .mobile-action-bar { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800" style="margin: 0; padding: 0; height: auto; overflow: auto;">
  <!-- Top bar with Go Back -->
  <header class="bg-white border-b sticky top-0 z-50 w-full">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="#" class="px-3 py-2 rounded-lg bg-red-600 text-white text-sm flex items-center gap-2" onclick="window.parent.document.getElementById('closeModal').click();">
          <i class="fas fa-arrow-left"></i> Go Back
        </a>
        <div>
          <h1 class="text-lg font-semibold">SoMAp — Scoresheet</h1>
          <p class="text-xs text-slate-500">Enter marks per subject • Auto averages • Positions • Grades</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnCheckScoresheet" class="px-3 py-2 rounded-lg bg-purple-600 text-white text-sm" onclick="window.location.href='checkscoresheet.html'">Check Scoresheet</button>
        <button id="btnFullScreen" class="px-3 py-2 rounded-lg bg-green-600 text-white text-sm">Full Screen</button>
        <button id="btnSaveAll" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm">Save Scores</button>
        <div class="hidden sm:flex gap-2">
          <button id="btnExportCSV" class="px-3 py-2 bg-white border rounded-lg text-sm">CSV</button>
          <button id="btnExportXLSX" class="px-3 py-2 bg-white border rounded-lg text-sm">Excel</button>
          <button id="btnExportPDF" class="px-3 py-2 bg-white border rounded-lg text-sm">PDF</button>
          <button id="btnPrint" class="px-3 py-2 bg-white border rounded-lg text-sm">Print</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 h-full overflow-auto">
    <!-- Mobile quick actions -->
    <div class="mobile-action-bar">
      <button id="btnFullScreenMobile" class="px-3 py-2 bg-green-600 text-white text-sm rounded w-full">Full Screen</button>
    </div>

    <section class="mt-6">
      <div class="bg-white rounded-2xl shadow overflow-hidden h-full">
        <div class="px-4 py-3 border-b flex items-center justify-between">
          <div>
            <h2 class="text-base font-semibold">Scoresheet</h2>
            <p class="text-xs text-slate-500">Enter marks per subject • Auto averages • Positions • Grades</p>
          </div>

          <div class="flex items-center gap-3">
            <label class="text-xs text-slate-500 flex items-center gap-2">
              Max/100
              <input id="globalMaxInput" type="number" min="1" max="100" value="100" class="w-20 px-2 py-1 border rounded">
            </label>
            <button id="btnSetAllMax" class="px-3 py-2 bg-slate-100 border rounded text-sm">Set all Max</button>
            <button id="btnRecalc" class="px-3 py-2 bg-white border rounded text-sm">Recalculate</button>
          </div>
        </div>

        <div class="overflow-auto scroll-shadow" style="max-height:calc(100vh - 200px)">
          <table id="scoresTable" class="scoresheet-table w-full min-w-table text-sm">
            <thead class="sticky-th">
              <tr id="scoresheet-header-row" class="bg-slate-50">
                <th class="p-2 border">#</th>
                <th class="p-2 border">Adm</th>
                <th class="p-2 border text-left">Student</th>
                <th class="p-2 border">Fee Due</th>
                <th class="p-2 border">Paid</th>
                <th class="p-2 border">Balance</th>
                <!-- SUBJECT HEADERS INJECTED HERE -->
                <th class="p-2 border">Total</th>
                <th class="p-2 border">Max</th>
                <th class="p-2 border">% Avg</th>
                <th class="p-2 border">Overall Pos</th>
                <th class="p-2 border">Grade</th>
                <th class="p-2 border">Present</th>
                <th class="p-2 border">Absent</th>
                <th class="p-2 border">Teacher Comment</th>
              </tr>
            </thead>
            <tbody id="scoresBody"></tbody>
          </table>
        </div>

        <div class="px-4 py-3 border-t flex items-center justify-between">
          <div class="text-xs text-slate-500">
            <span id="lblCount">0</span> students • <span id="lblSubjects">0</span> subjects
            <div id="lblStatus" class="text-xs mt-1"></div>
          </div>
          <div class="flex gap-2">
            <!-- This now just opens the standalone dashboard -->
            <button id="btnGenerateReports" class="px-3 py-2 bg-green-600 text-white rounded text-sm">Generate Report Cards (PDF)</button>
            <button id="btnEmailReports" class="px-3 py-2 bg-white border rounded text-sm">Email/SMS Links</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Templates -->
  <template id="tplSubjectHeader">
    <th class="p-2 border subject-col"></th>
    <th class="p-2 border max-col">Max</th>
    <th class="p-2 border pos-col">Pstn</th>
  </template>

  <template id="tplSubjectCell">
    <td class="p-1.5 border"><input type="number" min="0" step="0.01" class="w-20 px-2 py-1 border rounded score-input" /></td>
    <td class="p-1.5 border"><input type="number" min="1" class="w-16 px-2 py-1 border rounded max-input" value="100" /></td>
    <td class="p-1.5 border text-center"><span class="inline-block w-10 text-center pstn-cell">–</span></td>
  </template>

  <script>
    /* ---------- CONFIG ---------- */
    const SUBJECTS_BY_CLASS = {
      'Baby Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Baby': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Middle Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Middle': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Preunit Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Preunit': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Pre-Unit': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Class 1': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 1 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 2': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 2 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 3': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 4': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 5': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 6': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals'],
      'Class 7': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals']
    };

    const EXAM_KEYS = {
      'Monthly': 'monthly','Midterm 1':'midterm1','End Term':'endterm','Midterm 2':'midterm2','Annual':'annual'
    };

    // Returns default subjects as { key, label } objects for non-Class 5 cases
    function sanitizeSubjectKey(val){ return String(val || '').replace(/[.#$\[\]/]/g,'_'); }
    function getDefaultSubjectsForClass(className){
      const normalizedKey = Object.keys(SUBJECTS_BY_CLASS).find(k => k.toLowerCase() === String(className || '').trim().toLowerCase());
      const list = SUBJECTS_BY_CLASS[normalizedKey || className] || [];
      return list.map(sub => ({ key: sanitizeSubjectKey(sub), label: sub }));
    }

    // Returns the list of subjects for a given class & year (Class 5 has year-based logic)
    function getSubjectsForClassAndYear(className, year){
      const y = parseInt(year, 10);
      const normalized = String(className || '').trim().toLowerCase();
      const isClass5 = normalized === 'class 5' || normalized === 'std 5' || normalized === '5' || normalized.startsWith('class 5');

      if (isClass5) {
        if (!isNaN(y) && y <= 2025) {
          return [
            { key: sanitizeSubjectKey('Math'),      label: 'Math' },
            { key: sanitizeSubjectKey('English'),   label: 'English' },
            { key: sanitizeSubjectKey('Kiswahili'), label: 'Kiswahili' },
            { key: sanitizeSubjectKey('Science'),   label: 'Science' },
            { key: sanitizeSubjectKey('SST'),       label: 'SST' },
            { key: sanitizeSubjectKey('CME'),       label: 'CME' },
            { key: sanitizeSubjectKey('VSkills'),   label: 'VSkills' }
          ];
        }
        return [
          { key: sanitizeSubjectKey('Math'),      label: 'Math' },
          { key: sanitizeSubjectKey('English'),   label: 'English' },
          { key: sanitizeSubjectKey('Kiswahili'), label: 'Kiswahili' },
          { key: sanitizeSubjectKey('Science'),   label: 'Science' },
          { key: sanitizeSubjectKey('Geography'), label: 'Geography' },
          { key: sanitizeSubjectKey('Historia'),  label: 'Historia' },
          { key: sanitizeSubjectKey('DSA'),       label: 'DSA' }
        ];
      }

      return getDefaultSubjectsForClass(className);
    }

    function letterGrade(pct) {
      const p = Number(pct);
      if (p >= 80.5) return 'A';
      if (p >= 60.5) return 'B';
      if (p >= 40.5) return 'C';
      if (p >= 20.5) return 'D';
      return 'F';
    }

    function getTeacherComment(grade, name) {
      switch (grade) {
        case 'A': return `Wonderful ${name}, keep this spirit!`;
        case 'B': return `Good trial ${name}, aim higher!`;
        case 'C': return `Now, ${name}, this is completely not what we signed up for at our school. Work harder!`;
        case 'D': return `Dear ${name}, your performance needs significant improvement. Seek help and try harder!`;
        case 'F': return `Oh ${name}, this is a serious concern. Immediate effort is required!`;
        case '0': return `Unfortunately ${name}, no marks recorded. Please address this immediately!`;
        default: return `Feedback for ${name} pending.`;
      }
    }

    /* ---------- STATE ---------- */
    const state = {
      students: [], attendance: {}, fees: {}, scores: {}, subjectList: [], subjectConfigs: [],
      rowsByAdm: {}, className:'', stream:'', month:'', year:'', examKey:'', schoolBranch:''
    };

    /* ---------- ELEMENTS ---------- */
    const scoresBody = document.getElementById('scoresBody');
    const lblCount = document.getElementById('lblCount');
    const lblSubjects = document.getElementById('lblSubjects');
    const lblStatus = document.getElementById('lblStatus');

    const btnRecalc = document.getElementById('btnRecalc');
    const btnSaveAll = document.getElementById('btnSaveAll');
    const btnExportCSV = document.getElementById('btnExportCSV');
    const btnExportXLSX = document.getElementById('btnExportXLSX');
    const btnExportPDF = document.getElementById('btnExportPDF');
    const btnPrint = document.getElementById('btnPrint');
    const btnSetAllMax = document.getElementById('btnSetAllMax');
    const btnGenerateReports = document.getElementById('btnGenerateReports');
    const btnEmailReports = document.getElementById('btnEmailReports');
    const globalMaxInput = document.getElementById('globalMaxInput');
    const btnFullScreenMobile = document.getElementById('btnFullScreenMobile');

    /* ---------- Firebase DB helper ---------- */
    function sanitizePathSegment(val){ return String(val || '').replace(/[.#$\[\]/]/g,'_'); }
    function getScoresRef(db, { year, className, examKey, month }){
      const y = sanitizePathSegment(year);
      const c = sanitizePathSegment(className);
      const e = sanitizePathSegment(examKey);
      const m = sanitizePathSegment(month);
      return db.ref(`/scores/${y}/${c}/${e}/${m}`);
    }
    function getDB(){
      if(window && window.db) return window.db;
      if(!window.firebase) {
        console.error('Firebase not loaded; ensure firebase.js is present and provides window.db');
        return null;
      }
      if (!firebase.apps.length){
        const cfg = {
          apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
          authDomain: "somaptestt.firebaseapp.com",
          databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
          projectId: "somaptestt",
          storageBucket: "somaptestt.appspot.com",
          messagingSenderId: "105526245138",
          appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
        };
        firebase.initializeApp(cfg);
      }
      try {
        if(firebase.auth && firebase.auth().currentUser == null){
          firebase.auth().signInAnonymously().catch(()=>{});
        }
      } catch(e) {}
      return firebase.database();
    }

    /* ---------- Robust student loader ---------- */
    async function fetchStudents(className, stream){
      const db = getDB();
      if(!db) {
        console.error('Firebase database not available');
        return [];
      }
      
      console.log('Fetching students for class:', className, 'stream:', stream);
      
      const tryPaths = ['students','Students','StudentsList','Students_List','studentList','studentlist','attendance','school','schoolerp'];
      for(const p of tryPaths){
        try{
          console.log('Trying path:', p);
          const snap = await db.ref(p).get();
          if(snap && snap.exists && snap.exists()){
            const data = snap.val();
            console.log('Found data at path:', p, 'Type:', typeof data, 'Keys:', Object.keys(data || {}).length);
            
            const arr = [];
            if(Array.isArray(data)){
              data.forEach((item, idx)=> {
                if(item) {
                  const adm = item.adm || item.admissionNumber || item.admNo || ('A'+idx);
                  arr.push(normalizeStudentRecord(adm, item));
                }
              });
            } else {
              Object.keys(data).forEach(k=>{
                const s = data[k] || {};
                if(typeof s === 'object' && (s.name || s.fullName || s.firstName || s.adm || s.admissionNumber || s.admissionNo || s.feeDue || s.feePaid)){
                  const adm = s.adm || s.admissionNumber || s.admNo || s.admission || k;
                  arr.push(normalizeStudentRecord(adm, s));
                }
              });
            }
            
            console.log('Total students found:', arr.length);
            
            const filtered = arr.filter(x=>{
              const normalizedClass = String(x.class || '').toUpperCase().replace(/[\s-]/g, '');
              const normalizedSelect = className.toUpperCase().replace(/[\s-]/g, '');
              const classMatches = !className || normalizedClass.includes(normalizedSelect) || normalizedSelect.includes(normalizedClass);
              
              const normalizedStream = String(x.stream || '').toUpperCase().replace(/[\s-]/g, '');
              const normalizedInputStream = (stream||'').toUpperCase().replace(/[\s-]/g, '');
              const streamMatches = !stream || normalizedStream.includes(normalizedInputStream) || normalizedInputStream.includes(normalizedStream);
              
              const matches = classMatches && streamMatches;
              if(matches) {
                console.log('Student matches:', x.name, 'Class:', x.class, 'Stream:', x.stream);
              }
              return matches;
            });
            
            filtered.sort((a,b)=> (a.name || '').localeCompare(b.name || ''));
            console.log('Filtered students count:', filtered.length);
            if(filtered.length) return filtered;
          }
        }catch(err){
          console.warn('fetchStudents trying', p, err && err.message);
        }
      }
      console.warn('No students found for class:', className, 'stream:', stream);
      return [];
    }

    function normalizeStudentRecord(admKey, s){
      const name = [s.firstName, s.middleName, s.lastName].filter(Boolean).join(' ').trim() || s.name || s.fullName || ('Student ' + admKey);
      let sClass = s.class || s.currentClass || s.level || s.className || s.grade || s.classLevel || '';
      
      // Normalize class names to match our SUBJECTS_BY_CLASS keys
      if(sClass) {
        const normalizedClass = sClass.toUpperCase().replace(/[\s-]/g, '');
        if(normalizedClass.includes('BABY') && !normalizedClass.includes('CLASS')) {
          sClass = 'Baby Class';
        } else if(normalizedClass.includes('MIDDLE') && !normalizedClass.includes('CLASS')) {
          sClass = 'Middle Class';
        } else if(normalizedClass.includes('PREUNIT') || normalizedClass.includes('PRE-UNIT')) {
          sClass = 'Preunit Class';
        } else if(normalizedClass.includes('CLASS1') || normalizedClass.includes('CLASS 1')) {
          sClass = 'Class 1';
        } else if(normalizedClass.includes('CLASS2') || normalizedClass.includes('CLASS 2')) {
          sClass = 'Class 2';
        } else if(normalizedClass.includes('CLASS3') || normalizedClass.includes('CLASS 3')) {
          sClass = 'Class 3';
        } else if(normalizedClass.includes('CLASS4') || normalizedClass.includes('CLASS 4')) {
          sClass = 'Class 4';
        } else if(normalizedClass.includes('CLASS5') || normalizedClass.includes('CLASS 5')) {
          sClass = 'Class 5';
        } else if(normalizedClass.includes('CLASS6') || normalizedClass.includes('CLASS 6')) {
          sClass = 'Class 6';
        } else if(normalizedClass.includes('CLASS7') || normalizedClass.includes('CLASS 7')) {
          sClass = 'Class 7';
        }
      }
      
      const sStream = s.stream || s.streamName || s.section || '';
      const feeDue = Number(s.totalFee || s.feePerYear || s.feeDue || s.required || s.debt || 0);
      let feePaid = Number(s.paid || s.feePaid || s.totalPaid || s.paidAmount || s.credit || 0);
      if (s.payments && typeof s.payments === 'object') {
        feePaid = Object.values(s.payments).reduce((sum, p) => sum + Number(p.amount || 0), 0);
      }
      const balance = Number(s.balance || Math.max(0, feeDue - feePaid) || 0);
      return { adm: String(admKey), name, class: sClass, stream: sStream, feeDue, feePaid, balance, meta: s };
    }

    /* ---------- Attendance + fees + scores fetchers ---------- */
    async function fetchAttendance(year, month, className){
      const db = getDB();
      if(!db) return {};
      const refPath = `/attendance/${year}/${month}/${className}`;
      try{
        const snap = await db.ref(refPath).get();
        const out = {};
        if(snap && snap.exists && snap.exists()){
          const val = snap.val();
          Object.keys(val).forEach(adm=>{
            const a = val[adm] || {};
            out[adm] = { present: Number(a.present || a.daysPresent || 0), absent: Number(a.absent || a.daysAbsent || 0), days: Number(a.days || (Number(a.present||0)+Number(a.absent||0))) };
          });
        }
        return out;
      }catch(e){ console.warn('fetchAttendance', e && e.message); return {}; }
    }

    async function fetchFees(year, className){
      const db = getDB();
      if(!db) return {};
      const refPath = `/fees/${year}/${className}`;
      try{
        const snap = await db.ref(refPath).get();
        const out = {};
        if(snap && snap.exists && snap.exists()){
          const val = snap.val();
          Object.keys(val).forEach(adm=>{
            const f = val[adm] || {};
            const required = Number(f.required || f.expected || f.total || 0);
            const paid = Number(f.paid || f.paidAmount || 0);
            out[adm] = { required, paid, balance: Math.max(0, required - paid) };
          });
        }
        return out;
      }catch(e){ console.warn('fetchFees', e && e.message); return {}; }
    }

    async function fetchScores({year, className, examKey, month}){
      const db = getDB();
      if(!db) return {};
      const ref = getScoresRef(db, { year, className, examKey, month });
      try{
        const snap = await ref.get();
        const out = {};
        if(snap && snap.exists && snap.exists()){
          const val = snap.val();
          Object.keys(val).forEach(adm=>{
            out[adm] = {};
            const subjObj = val[adm] || {};
            Object.keys(subjObj).forEach(sub=>{
              const o = subjObj[sub] || {};
              out[adm][sub] = { score: Number(o.score||0), max: Number(o.max||100) };
            });
          });
        }
        return out;
      }catch(e){ console.warn('fetchScores', e && e.message); return {}; }
    }

    /* ---------- Save ---------- */
    async function saveAllScores(){
      const db = getDB();
      if(!db){ alert('Firebase not initialized'); return; }

      // Fallback defaults if any are missing
      if(!state.year) state.year = new Date().getFullYear().toString();
      if(!state.month) state.month = String(new Date().getMonth()+1).padStart(2,'0');
      if(!state.examKey) state.examKey = 'monthly';
      if(!state.className){
        alert('Missing class; please reopen from dashboard to set the class.');
        return;
      }

      const { year, className, examKey, month } = state;

      const baseRef = getScoresRef(db, { year, className, examKey, month });
      const payload = {};
      Object.keys(state.rowsByAdm).forEach(adm=>{
        const row = state.rowsByAdm[adm];
        payload[adm] = payload[adm] || {};
        state.subjectConfigs.forEach(({ key })=>{
          const cell = row.subjectCells[key];
          const score = Number(cell.scoreInput.value || 0);
          const max = Math.max(1, Number(cell.maxInput.value || 100));
          payload[adm][key] = { score, max };
        });
      });

      try{
        await baseRef.set(payload);
        await persistComputedSummary().catch(()=>{});
        alert('Scores saved.');
      }catch(err){
        console.error('Save failed', err);
        alert(`Saving failed: ${err && err.message ? err.message : 'Unknown error'}`);
      }
    }

    /* ---------- Build table ---------- */
    function buildTable(){
      const theadRow = document.getElementById('scoresheet-header-row');
      if (theadRow) {
        let headerHtml = `
          <th class="p-2 border sticky-col-1 text-center">#</th>
          <th class="p-2 border sticky-col-2 text-center">Adm</th>
          <th class="p-2 border sticky-col-3 text-left">Student</th>
          <th class="p-2 border">Fee Due</th>
          <th class="p-2 border">Paid</th>
          <th class="p-2 border">Balance</th>
        `;

        state.subjectConfigs.forEach(sub => {
          headerHtml += `
            <th class="p-2 border">${sub.label}</th>
            <th class="p-2 border">Max</th>
            <th class="p-2 border">Pstn</th>
          `;
        });

        headerHtml += `
          <th class="p-2 border">Total</th>
          <th class="p-2 border">Max</th>
          <th class="p-2 border">% Avg</th>
          <th class="p-2 border">Overall Pos</th>
          <th class="p-2 border">Grade</th>
          <th class="p-2 border">Present</th>
          <th class="p-2 border">Absent</th>
          <th class="p-2 border">Teacher Comment</th>
        `;
        theadRow.innerHTML = headerHtml;
      }

      scoresBody.innerHTML = '';
      state.rowsByAdm = {};

      // If no students found, show a message
      if(state.students.length === 0) {
        const tr = document.createElement('tr');
        tr.className = 'bg-yellow-50';
        const td = document.createElement('td');
        td.colSpan = 6 + (state.subjectConfigs.length * 3) + 8; // Total columns
        td.className = 'p-8 text-center text-slate-500';
        td.innerHTML = `
          <div class="text-lg mb-2">⚠️ No students found</div>
          <div class="text-sm">Please check:</div>
          <ul class="text-xs mt-2 text-left max-w-md mx-auto">
            <li>• Class name matches the database</li>
            <li>• Students are properly assigned to this class</li>
            <li>• Check browser console for detailed logs</li>
          </ul>
        `;
        tr.appendChild(td);
        scoresBody.appendChild(tr);
        return;
      }

      const tplCell = document.getElementById('tplSubjectCell');

      state.students.forEach((s, idx)=>{
        const tr = document.createElement('tr');
        tr.className = `scoresheet-row ${idx % 2 ? 'bg-white' : 'bg-slate-50'}`;

        const tdIndex = document.createElement('td'); tdIndex.className='p-2 border text-center sticky-col-1'; tdIndex.textContent = String(idx+1); tdIndex.dataset.label = '#';
        tr.appendChild(tdIndex);

        const tdAdm = document.createElement('td'); tdAdm.className='p-2 border text-center sticky-col-2'; tdAdm.textContent = s.adm; tdAdm.dataset.label = 'Adm';
        tr.appendChild(tdAdm);

        const tdName = document.createElement('td'); tdName.className='p-2 border sticky-col-3'; tdName.dataset.label = 'Student';
        tdName.innerHTML = `<div class="font-medium">${escapeHtml(s.name)}</div><div class="text-xs text-slate-500">${escapeHtml(s.class)} ${s.stream? '('+escapeHtml(s.stream)+')':''}</div>`;
        tr.appendChild(tdName);

        const feeObj = state.fees[s.adm] || { required: s.feeDue || 0, paid: s.feePaid || 0, balance: s.balance || 0 };
        const tdFeeDue = document.createElement('td'); tdFeeDue.className='p-2 border text-center'; tdFeeDue.dataset.label = 'Fee Due'; tdFeeDue.textContent = money(feeObj.required || 0);
        const tdPaid = document.createElement('td'); tdPaid.className='p-2 border text-center'; tdPaid.dataset.label = 'Paid'; tdPaid.textContent = money(feeObj.paid || 0);
        const tdBal = document.createElement('td'); tdBal.className='p-2 border text-center'; tdBal.dataset.label = 'Balance'; tdBal.textContent = money(feeObj.balance || 0);
        tr.appendChild(tdFeeDue); tr.appendChild(tdPaid); tr.appendChild(tdBal);

        const subjectCells = {};
        state.subjectConfigs.forEach(({ key, label })=>{
          const frag = tplCell.content.cloneNode(true);
          const tds = frag.querySelectorAll('td');
          const scoreInp = tds[0].querySelector('input.score-input');
          const maxInp = tds[1].querySelector('input.max-input');
          const pstnSpan = tds[2].querySelector('.pstn-cell');

          tds[0].dataset.label = `${label} Mark`;
          tds[1].dataset.label = `${label} Max`;
          tds[2].dataset.label = `${label} Pstn`;

          scoreInp.setAttribute('data-subject', key);
          maxInp.setAttribute('data-subject', key);
          pstnSpan.setAttribute('data-subject', key);

          const sc = (state.scores[s.adm]||{})[key] || {};
          scoreInp.value = sc.score ?? '';
          maxInp.value = sc.max ?? 100;

          scoreInp.addEventListener('input', recomputeAll);
          maxInp.addEventListener('input', recomputeAll);

          tr.appendChild(tds[0]); tr.appendChild(tds[1]); tr.appendChild(tds[2]);

          subjectCells[key] = { scoreInput: scoreInp, maxInput: maxInp, pstnSpan };
        });

        const tdTotal = document.createElement('td'); tdTotal.className='p-2 border text-center font-medium'; tdTotal.textContent='0'; tdTotal.dataset.label = 'Total';
        const tdMax = document.createElement('td'); tdMax.className='p-2 border text-center'; tdMax.textContent='0'; tdMax.dataset.label = 'Max Total';
        const tdAvg = document.createElement('td'); tdAvg.className='p-2 border text-center'; tdAvg.textContent='0'; tdAvg.dataset.label = '% Avg';
        const tdPstn = document.createElement('td'); tdPstn.className='p-2 border text-center'; tdPstn.textContent='-'; tdPstn.dataset.label = 'Overall Pos';
        const tdGrade = document.createElement('td'); tdGrade.className='p-2 border text-center'; tdGrade.textContent='-'; tdGrade.dataset.label = 'Grade';
        tr.appendChild(tdTotal); tr.appendChild(tdMax); tr.appendChild(tdAvg); tr.appendChild(tdPstn); tr.appendChild(tdGrade);

        const att = state.attendance[s.adm] || { present:0, absent:0, days:0 };
        const tdPresent = document.createElement('td'); tdPresent.className='p-2 border text-center'; tdPresent.textContent = att.present; tdPresent.dataset.label = 'Present';
        const tdAbsent = document.createElement('td'); tdAbsent.className='p-2 border text-center'; tdAbsent.textContent = att.absent; tdAbsent.dataset.label = 'Absent';
        tr.appendChild(tdPresent); tr.appendChild(tdAbsent);

        const tdComment = document.createElement('td'); tdComment.className='p-2 border'; tdComment.dataset.label = 'Teacher Comment';
        const avg = Number(tdAvg.textContent) || 0;
        const grade = letterGrade(avg);
        const comment = getTeacherComment(grade, s.name);
        tdComment.innerHTML = `<textarea class="w-56 h-10 p-2 border rounded text-xs" placeholder="Teacher comment...">${comment}</textarea>`;
        tr.appendChild(tdComment);

        scoresBody.appendChild(tr);

        state.rowsByAdm[s.adm] = {
          tr, subjectCells,
          tdTotal, tdMax, tdAvg, tdPstn, tdGrade,
          tdPresent, tdAbsent,
          tdFeeDue, tdPaid, tdBal,
          tdComment,
          meta: s
        };
      });

      lblCount.textContent = String(state.students.length);
      lblSubjects.textContent = String(state.subjectConfigs.length);
      
      // Update status message
      if(state.students.length === 0) {
        lblStatus.innerHTML = '<span class="text-red-600">⚠️ No students found for this class. Check console for details.</span>';
      } else {
        lblStatus.innerHTML = '<span class="text-green-600">✅ Students loaded successfully</span>';
      }
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function money(n){ n = Number(n||0); return new Intl.NumberFormat('en-TZ',{style:'currency',currency:'TZS',maximumFractionDigits:0}).format(n); }

    /* ---------- Computation: totals/averages/positions/grades ---------- */
    function recomputeAll(){
      const perSubject = {};
      Object.keys(state.rowsByAdm).forEach(adm=>{
        const row = state.rowsByAdm[adm];
        let sumScore=0, sumMax=0;
        state.subjectConfigs.forEach(({ key })=>{
          const cell = row.subjectCells[key];
          const score = Number(cell.scoreInput.value || 0);
          const max = Math.max(1, Number(cell.maxInput.value || 100));
          sumScore += score; sumMax += max;
          const pct = (score/max)*100;
          perSubject[key] = perSubject[key] || [];
          perSubject[key].push({ adm, pct });
        });
        const avgPct = sumMax ? (sumScore/sumMax)*100 : 0;
        row.tdTotal.textContent = sumScore.toFixed(2);
        row.tdMax.textContent = Math.round(sumMax);
        row.tdAvg.textContent = avgPct.toFixed(2);
        row.tdGrade.textContent = letterGrade(avgPct);
        row._avgPct = avgPct;
        row._sumScore = sumScore;

        // Auto-update teacher comment based on grade
        const grade = letterGrade(avgPct);
        const comment = getTeacherComment(grade, row.meta.name);
        row.tdComment.querySelector('textarea').value = comment;
      });

      // Subject positions
      state.subjectConfigs.forEach(({ key })=>{
        const list = (perSubject[key] || []).slice().sort((a,b)=> b.pct - a.pct);
        let pos=0, last=null, idx=0;
        list.forEach(item=>{
          idx++;
          if(last === null || item.pct < last){ pos = idx; last = item.pct; }
          const row = state.rowsByAdm[item.adm];
          row.subjectCells[key].pstnSpan.textContent = String(pos);
        });
      });

      // Overall position (avg desc, then total desc, then attendance desc)
      const arr = Object.keys(state.rowsByAdm).map(adm=>{
        const r = state.rowsByAdm[adm];
        return { adm, avg: r._avgPct || 0, total: r._sumScore || 0, attendance: Number(r.tdPresent.textContent || 0) };
      });
      arr.sort((a,b)=>{
        if(b.avg !== a.avg) return b.avg - a.avg;
        if(b.total !== a.total) return b.total - a.total;
        return b.attendance - a.attendance;
      });
      arr.forEach((r,i)=> state.rowsByAdm[r.adm].tdPstn.textContent = String(i+1));
    }

    /* ---------- Exports (scoresheet table) ---------- */
    function gatherRowsForExport(){
      const rows = [];
      const header = ['Adm','Student', 'Fee Due','Paid','Balance', ...expandSubjectTripletsHeader(), 'Total','Max','% Avg','Overall Pos','Grade','Present','Absent','Comment'];
      rows.push(header);
      Object.keys(state.rowsByAdm).forEach(adm=>{
        const r = state.rowsByAdm[adm];
        const arr = [adm, r.meta.name, (r.tdFeeDue?.textContent||''), (r.tdPaid?.textContent||''), (r.tdBal?.textContent||'')];
        state.subjectConfigs.forEach(({ key })=>{
          const c = r.subjectCells[key];
          arr.push(Number(c.scoreInput.value||0)); arr.push(Number(c.maxInput.value||100)); arr.push(c.pstnSpan.textContent||'');
        });
        arr.push(Number(r.tdTotal.textContent||0)); arr.push(Number(r.tdMax.textContent||0)); arr.push(Number(r.tdAvg.textContent||0));
        arr.push(r.tdPstn.textContent||''); arr.push(r.tdGrade.textContent||''); arr.push(Number(r.tdPresent.textContent||0)); arr.push(Number(r.tdAbsent.textContent||0));
        arr.push(r.tdComment.querySelector('textarea').value || '');
        rows.push(arr);
      });
      return rows;
    }

    function expandSubjectTripletsHeader(){ const out=[]; state.subjectConfigs.forEach(({ label })=> out.push(`${label} Score`, `${label} Max`, `${label} Pstn`)); return out; }

    function exportCSV(){
      const rows = gatherRowsForExport();
      const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, `Scoresheet_${state.className || 'Class'}_${state.examKey || 'exam'}_${state.year || 'year'}-${state.month || 'mm'}.csv`);
    }

    function exportXLSX(){
      const rows = gatherRowsForExport();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Scoresheet');
      XLSX.writeFile(wb, `Scoresheet_${state.className || 'Class'}_${state.examKey || 'exam'}_${state.year || 'year'}-${state.month || 'mm'}.xlsx`);
    }

    function exportPDF(){
      const rows = gatherRowsForExport();
      if(rows.length <= 1){
        alert('No scores to export yet.');
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:'l', unit:'pt', format:'a4' });
      const title = `Scoresheet ${state.className || ''} ${state.examKey || ''} ${state.year || ''}/${state.month || ''}`;
      const subtitle = `Stream ${state.stream || '-'}  |  ${state.examKey || 'monthly'}  |  Month ${state.month || ''}`;

      doc.setFillColor(79, 70, 229);
      doc.rect(30, 28, 782, 42, 'F');
      doc.setTextColor(255,255,255);
      doc.setFontSize(16); doc.text(title, 40, 55);
      doc.setFontSize(11); doc.text(subtitle, 40, 70);

      doc.autoTable({
        startY:90,
        head:[rows[0]],
        body:rows.slice(1),
        theme:'grid',
        styles:{fontSize:7,cellPadding:3, halign:'center', textColor:[31,41,55]},
        headStyles:{fillColor:[99,102,241], textColor:[255,255,255], fontStyle:'bold'},
        alternateRowStyles:{fillColor:[245,248,255]},
        columnStyles:{0:{halign:'left'},1:{halign:'left'}},
        didDrawPage:(data)=>{
          doc.setFontSize(9);
          doc.setTextColor(148,163,184);
          doc.text(`Generated ${new Date().toLocaleString()}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
      });
      doc.save(title.replace(/[^A-Za-z0-9_\\- ]/g,'_') + '.pdf');
    }

    /* ---------- Persist summary (kept) ---------- */
    async function persistComputedSummary(){
      const db = getDB();
      if(!db) return;
      const summary = { updatedAt: Date.now(), className: state.className, stream: state.stream, year: state.year, month: state.month, examKey: state.examKey, subjectList: state.subjectConfigs.map(s => s.key) };
      summary.subjectAverages = {};
      state.subjectConfigs.forEach(({ key })=>{
        let sum=0, cnt=0;
        Object.keys(state.rowsByAdm).forEach(adm=>{
          const row = state.rowsByAdm[adm];
          const c = row.subjectCells[key]; const sc = Number(c.scoreInput.value || 0); const mx = Math.max(1, Number(c.maxInput.value || 100));
          sum += (sc/mx)*100; cnt++;
        });
        summary.subjectAverages[key] = cnt ? sum/cnt : 0;
      });
      const list = Object.values(state.rowsByAdm).map(r=>({ name: r.meta.name, adm: r.meta.adm, avg: r._avgPct || 0 })).sort((a,b)=> b.avg - a.avg);
      summary.top3 = list.slice(0,3); summary.bottom3 = list.slice(-3);
      let sumP=0,sumA=0,sumD=0, feeReq=0,feePaid=0,feeBal=0;
      Object.keys(state.rowsByAdm).forEach(adm=>{
        const r = state.rowsByAdm[adm];
        sumP += Number(r.tdPresent.textContent||0); sumA += Number(r.tdAbsent.textContent||0); sumD += (Number(r.tdPresent.textContent||0)+Number(r.tdAbsent.textContent||0));
        const f = state.fees[adm] || { required: r.meta.feeDue || 0, paid: r.meta.feePaid || 0, balance: r.meta.balance || 0 };
        feeReq += f.required||0; feePaid += f.paid||0; feeBal += f.balance||0;
      });
      summary.attendance = { present: sumP, absent: sumA, days: sumD };
      summary.fees = { required: feeReq, paid: feePaid, balance: feeBal };
      await db.ref(`/summaries/${state.year}/${state.className}/${state.examKey}/${state.month}`).set(summary);
    }

    /* ---------- Load sequence (main entry) ---------- */
    async function loadAll(){
      console.log('=== Loading scoresheet data ===');
      
      state.className = window.sessionStorage.getItem('className') || '';
      let inputStream = window.sessionStorage.getItem('stream') || '';
      state.month = window.sessionStorage.getItem('month') || '';
      state.year = window.sessionStorage.getItem('year') || '';
      state.examKey = window.sessionStorage.getItem('examKey') || 'monthly';
      state.schoolBranch = window.sessionStorage.getItem('schoolBranch') || '';

      console.log('Session data:', {
        className: state.className,
        stream: inputStream,
        month: state.month,
        year: state.year,
        examKey: state.examKey,
        schoolBranch: state.schoolBranch
      });

      if(!state.className){ 
        console.error('No class selected');
        alert('Class not selected; please select from dashboard'); 
        return; 
      }
      if(!state.year){ 
        console.error('No year selected');
        alert('Year not selected; please select from dashboard'); 
        return; 
      }

      const classNumMatch = state.className.match(/\d+/);
      const classNum = classNumMatch ? classNumMatch[0] : '';
      const effectiveStream = inputStream.replace(/class/i, '').replace(classNum, '').trim().toUpperCase();
      state.stream = effectiveStream;

      try {
        const ss = window.sessionStorage || {};
        ss.setItem('assignedClass', state.className);
        ss.setItem('className', state.className);
        ss.setItem('stream', state.stream || '');
        ss.setItem('year', state.year || '');
        ss.setItem('month', state.month || '');
        ss.setItem('examKey', state.examKey || '');
      } catch(e) {}

      console.log('Effective stream:', state.stream);

      state.subjectConfigs = getSubjectsForClassAndYear(state.className, state.year);
      state.subjectList = state.subjectConfigs.map(s => s.key);
      console.log('Subject list for', state.className, ':', state.subjectConfigs.map(s => s.label));

      if(state.subjectConfigs.length === 0) {
        console.warn('No subjects found for class:', state.className);
        console.log('Available classes:', Object.keys(SUBJECTS_BY_CLASS));
      }

      console.log('Fetching students...');
      state.students = await fetchStudents(state.className, state.stream);
      console.log('Students fetched:', state.students.length);
      
      if(state.students.length === 0) {
        console.warn('No students found! Trying alternative class name variations...');
        
        // Try alternative class name variations
        const alternatives = [];
        if(state.className.includes('Class')) {
          alternatives.push(state.className.replace('Class', '').trim());
        }
        if(state.className.includes(' ')) {
          alternatives.push(state.className.replace(' ', ''));
        }
        if(!state.className.includes('Class') && !state.className.includes(' ')) {
          alternatives.push(state.className + ' Class');
        }
        
        console.log('Trying alternatives:', alternatives);
        
        for(const alt of alternatives) {
          console.log('Trying alternative class name:', alt);
          const altStudents = await fetchStudents(alt, state.stream);
          if(altStudents.length > 0) {
            console.log('Found students with alternative class name:', alt, 'Count:', altStudents.length);
            state.students = altStudents;
            state.className = alt; // Update the class name to match
            state.subjectConfigs = getSubjectsForClassAndYear(state.className, state.year);
            state.subjectList = state.subjectConfigs.map(s => s.key);
            break;
          }
        }
        
        if(state.students.length === 0) {
          console.error('Still no students found after trying alternatives');
          const allClasses = Object.keys(SUBJECTS_BY_CLASS);
          console.log('Available class names in SUBJECTS_BY_CLASS:', allClasses);
        }
      }

      console.log('Fetching attendance...');
      state.attendance = await fetchAttendance(state.year, state.month, state.className) || {};
      console.log('Attendance data:', Object.keys(state.attendance).length, 'students');
      
      console.log('Fetching fees...');
      state.fees = await fetchFees(state.year, state.className) || {};
      console.log('Fees data:', Object.keys(state.fees).length, 'students');
      
      console.log('Fetching scores...');
      state.scores = await fetchScores({ year: state.year, className: state.className, examKey: state.examKey, month: state.month }) || {};
      console.log('Scores data:', Object.keys(state.scores).length, 'students');

      console.log('Building table...');
      buildTable();
      console.log('Recomputing all...');
      recomputeAll();
      console.log('=== Load complete ===');
    }

    /* ---------- Event Listeners ---------- */
    btnRecalc.addEventListener('click', recomputeAll);
    btnSaveAll.addEventListener('click', saveAllScores);
    btnExportCSV.addEventListener('click', exportCSV);
    btnExportXLSX.addEventListener('click', exportXLSX);
    btnExportPDF.addEventListener('click', exportPDF);
    btnPrint.addEventListener('click', ()=>window.print());
    btnSetAllMax.addEventListener('click', ()=>{ const v = Number(globalMaxInput.value||100); scoresBody.querySelectorAll('input.max-input').forEach(i=>i.value=v); recomputeAll(); });

    // ✅ NEW: open standalone report-form dashboard instead of generating here
    btnGenerateReports.addEventListener('click', () => {
      try {
        const ss = window.sessionStorage || {};
        ss.setItem('className', state.className || ss.getItem('className') || '');
        ss.setItem('stream', state.stream || ss.getItem('stream') || '');
        ss.setItem('year', state.year || ss.getItem('year') || new Date().getFullYear());
        ss.setItem('month', state.month || ss.getItem('month') || 'Sep');
        ss.setItem('examKey', state.examKey || ss.getItem('examKey') || 'monthly');
        ss.setItem('schoolBranch', state.schoolBranch || ss.getItem('schoolBranch') || 'Socrates School');
      } catch(e) {}
      window.location.href = 'generatereportform.html';
    });

    btnEmailReports.addEventListener('click', ()=>alert('Integrate your SMS/email gateway here.'));

    // Full screen toggle
    const btnFullScreen = document.getElementById('btnFullScreen');
    btnFullScreen.addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        btnFullScreen.textContent = 'Exit Full Screen';
        btnFullScreen.classList.replace('bg-green-600', 'bg-red-600');
      } else {
        document.exitFullscreen();
        btnFullScreen.textContent = 'Full Screen';
        btnFullScreen.classList.replace('bg-red-600', 'bg-green-600');
      }
    });
    if (btnFullScreenMobile) {
      btnFullScreenMobile.addEventListener('click', () => btnFullScreen.click());
    }

    // Load initial data
    window.addEventListener('load', loadAll);

    /* ---------- Small helpers ---------- */
    function hexToRgb(hex){ const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:37,g:99,b:235}; }
  </script>
</body>
</html>


