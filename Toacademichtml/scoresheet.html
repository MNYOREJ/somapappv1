<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Scoresheet (Separated)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:Inter,system-ui,Arial,sans-serif} .muted{color:#6b7280}.table-fixed td, .table-fixed th { padding:8px }</style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="p-6 bg-gray-50">
  <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-xl font-semibold">Scoresheet — Enter marks • Auto averages • Positions • Grades</h1>
        <p class="muted text-sm">Independent scoresheet page — kept modular and connectable to Academic.</p>
      </div>
      <div class="space-x-2">
        <button id="btnSaveScores" class="px-3 py-2 bg-green-600 text-white rounded">Save Scores</button>
        <button id="btnCSV" class="px-3 py-2 bg-gray-200 rounded">CSV</button>
        <button id="btnExcel" class="px-3 py-2 bg-gray-200 rounded">Excel</button>
        <button id="btnPDF" class="px-3 py-2 bg-indigo-600 text-white rounded">PDF</button>
        <button id="btnPrint" class="px-3 py-2 bg-gray-200 rounded">Print</button>
        <button id="btnLoad" class="px-3 py-2 bg-blue-600 text-white rounded">Load</button>
      </div>
    </header>

    <section class="grid grid-cols-3 gap-4 mb-6">
      <div>
        <label class="block text-sm">School Branch</label>
        <select id="branch" class="mt-1 w-full rounded border px-2 py-1">
          <option value="Socrates — Main">Socrates — Main (optional)</option>
        </select>
      </div>
      <div>
        <label class="block text-sm">Class</label>
        <select id="classSelect" class="mt-1 w-full rounded border px-2 py-1">
          <option value="">Select Class…</option>
          <option>Baby</option><option>Middle</option><option>Preunit</option>
          <option>Class 1</option><option>Class 2</option><option>Class 3</option>
          <option>Class 4</option><option>Class 5</option><option>Class 6</option>
          <option>Class 7</option>
        </select>
      </div>
      <div>
        <label class="block text-sm">Stream</label>
        <select id="streamSelect" class="mt-1 w-full rounded border px-2 py-1">
          <option value="">All</option>
          <option>A</option><option>B</option><option>Red</option>
        </select>
      </div>
    </section>

    <section class="mb-4">
      <div class="flex items-center gap-3">
        <label class="text-sm">Exam Type</label>
        <select id="examType" class="rounded border px-2 py-1">
          <option>Monthly</option><option>Midterm 1</option><option>End Term</option><option>Midterm 2</option><option>Annual</option>
        </select>
        <label class="text-sm ml-4">Month</label>
        <select id="examMonth" class="rounded border px-2 py-1">
          <option>January</option><option>February</option><option>March</option><option>April</option>
        </select>
        <label class="text-sm ml-4">Academic Year</label>
        <input id="academicYear" class="border rounded px-2 py-1 w-28" placeholder="e.g., 2025" />
      </div>
    </section>

    <section id="controls" class="mb-4">
      <div class="flex items-center gap-2 text-sm muted">
        <div>Max/100</div>
        <input id="globalMax" class="border rounded px-2 py-1 w-20" value="100" />
        <button id="btnSetAllMax" class="px-2 py-1 bg-gray-200 rounded">Set all Max</button>
        <button id="btnRecalc" class="px-2 py-1 bg-yellow-200 rounded">Recalculate</button>
      </div>
    </section>

    <section class="overflow-x-auto">
      <table id="scoresTable" class="w-full table-fixed border-collapse border">
        <thead class="bg-gray-100">
          <tr>
            <th class="w-8">#</th>
            <th class="w-36">Adm</th>
            <th>Student</th>
            <th>Fee Due</th>
            <th>Paid</th>
            <th>Balance</th>
            <th>Total</th>
            <th>Max</th>
            <th>% Avg</th>
            <th>Overall Pos</th>
            <th>Grade</th>
            <th>Present</th>
            <th>Absent</th>
            <th>Teacher Comment</th>
          </tr>
        </thead>
        <tbody id="scoresBody">
          <tr><td colspan="14" class="p-6 muted">0 students • 0 subjects</td></tr>
        </tbody>
      </table>
    </section>

    <footer class="mt-6 flex items-center justify-between">
      <div>
        <button id="btnGenerateReport" class="px-3 py-2 bg-indigo-600 text-white rounded">Generate Report Cards (PDF)</button>
      </div>
      <div class="text-right">
        <button id="btnEmailSMS" class="px-3 py-2 bg-emerald-500 text-white rounded">Email/SMS Links</button>
      </div>
    </footer>
  </div>

<script>
  // Scoresheet logic — independent but compatible with finance/academic compute.
  // It will attempt to reuse global finance functions if present (from academic.html) otherwise use a light compute fallback.

  function fmt(n){ return (Number(n)||0).toLocaleString(); }

  // fallback finance compute (light) — if parent page provides better functions, we'll prefer those.
  function computeFinancialsFallback(student){
    const feePerYear = Number(student.feePerYear || student.totalFee || student.required || 0);
    let paid = 0;
    if(student.payments){
      Object.values(student.payments).forEach(p=> paid += Number(p.amount||0));
    } else if(student.paid) paid = Number(student.paid||0);
    const balance = Math.max(0, feePerYear - paid);
    return { feePerYear, paidAmount: paid, balance };
  }

  async function loadStudentsForClass(cls, stream){
    // Try to use parent/global db fetch if available
    const db = window.db || (window.parent && window.parent.db) || null;
    if(!db){
      console.warn('Firebase DB not found on window. Scoresheet will attempt to fetch via parent.');
    }
    // Attempt to read from common known paths
    const tryPaths = ['students','Students','StudentList','studentsList'];
    let students = [];
    if(db){
      for(const p of tryPaths){
        try{
          const snap = await db.ref(p).get();
          if(snap && snap.exists && snap.exists()){
            const val = snap.val();
            Object.keys(val).forEach(k=>{
              const s = val[k];
              const adm = s.adm || s.admissionNumber || k;
              students.push(Object.assign({ adm }, s));
            });
            break;
          }
        }catch(e){ console.warn('path fetch failed', p, e); }
      }
    }
    // If still empty, attempt parent window if embedded in parent
    if(!students.length && window.parent && window.parent.getPreloadedStudents){
      try{ students = await window.parent.getPreloadedStudents(cls, stream); }catch(e){}
    }
    // filter class/stream
    const filtered = students.filter(s=>{
      if(cls && String((s.class || s.className || s.grade||'')).toLowerCase() !== String(cls).toLowerCase()) return false;
      if(stream && s.stream && String(s.stream).toLowerCase() !== String(stream).toLowerCase()) return false;
      return true;
    });
    return filtered.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  }

  function gradeFromPercent(p){
    if(p>=80) return 'A';
    if(p>=70) return 'B+';
    if(p>=60) return 'B';
    if(p>=50) return 'C+';
    if(p>=40) return 'C';
    return 'D';
  }

  function buildScoresTable(students, subjects){
    const tbody = document.getElementById('scoresBody');
    tbody.innerHTML = '';
    if(!students.length){ tbody.innerHTML = '<tr><td colspan="14" class="p-6 muted">0 students • 0 subjects</td></tr>'; return; }
    students.forEach((s, idx)=>{
      const fin = (window.finance_computeStudentFinancials ? window.finance_computeStudentFinancials(s) : computeFinancialsFallback(s));
      const total = 0; // subjects sums — for now assume scores stored in s.scores
      let sumMarks = 0, numSubjects = 0;
      if(s.scores){ Object.values(s.scores).forEach(ss=>{ sumMarks += Number(ss||0); numSubjects++; }); }
      const max = Number(document.getElementById('globalMax').value||100);
      const percent = numSubjects? Math.round((sumMarks / (numSubjects*max))*100) : 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border-t">${idx+1}</td>
        <td class="border-t">${s.adm}</td>
        <td class="border-t">${s.name|| (s.fullName||'Student')}</td>
        <td class="border-t">${fmt(fin.feePerYear)}</td>
        <td class="border-t">${fmt(fin.paidAmount)}</td>
        <td class="border-t">${fmt(fin.balance)}</td>
        <td class="border-t">${sumMarks}</td>
        <td class="border-t"><input class="max-cell w-20 border rounded px-1 py-0.5" value="${max}" /></td>
        <td class="border-t">${percent}%</td>
        <td class="border-t">-</td>
        <td class="border-t">${gradeFromPercent(percent)}</td>
        <td class="border-t"><input class="present-cell w-16 border rounded px-1 py-0.5" value="${s.present||0}" /></td>
        <td class="border-t"><input class="absent-cell w-16 border rounded px-1 py-0.5" value="${s.absent||0}" /></td>
        <td class="border-t"><input class="comment-cell w-48 border rounded px-1 py-0.5" value="${(s.comment||'') }" /></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function onLoadClicked(){
    const cls = document.getElementById('classSelect').value;
    const stream = document.getElementById('streamSelect').value;
    const students = await loadStudentsForClass(cls, stream);
    window.__scoresheet_students = students;
    buildScoresTable(students, []);
  }

  document.getElementById('btnLoad').addEventListener('click', onLoadClicked);
  document.getElementById('btnSetAllMax').addEventListener('click', ()=>{
    const max = Number(document.getElementById('globalMax').value||100);
    document.querySelectorAll('.max-cell').forEach(i=>i.value = max);
  });
  document.getElementById('btnRecalc').addEventListener('click', ()=>{
    const students = window.__scoresheet_students || [];
    buildScoresTable(students, []);
  });
  document.getElementById('btnCSV').addEventListener('click', ()=>{
    const students = window.__scoresheet_students || [];
    const rows = students.map(s=>({ adm: s.adm, name: s.name, fee: s.feePerYear || '', paid: (s.paid||'') }));
    const csv = [Object.keys(rows[0]||{}).join(','), ...rows.map(r=>Object.values(r).map(v=>`"${String(v||'')}"`).join(','))].join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'scoresheet.csv'; a.click();
  });
  document.getElementById('btnExcel').addEventListener('click', ()=>{
    const students = window.__scoresheet_students || [];
    const ws = XLSX.utils.json_to_sheet(students.map(s=>({ adm: s.adm, name: s.name, fee: s.feePerYear || '', paid: (s.paid||'') }))); 
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Scores'); XLSX.writeFile(wb, 'scoresheet.xlsx');
  });
  document.getElementById('btnPDF').addEventListener('click', ()=>{
    const students = window.__scoresheet_students || [];
    const doc = new jspdf.jsPDF();
    const cols = ['Adm','Student','Total','%','Grade'];
    const rows = students.map(s=>[s.adm, s.name, '', '', '']);
    doc.autoTable({ head:[cols], body: rows });
    doc.save('report-cards.pdf');
  });
  document.getElementById('btnPrint').addEventListener('click', ()=> window.print());

  document.getElementById('btnSaveScores').addEventListener('click', async ()=>{
    const db = window.db || (window.parent && window.parent.db) || null;
    if(!db){ alert('No database connection found. Save function requires firebase DB.'); return; }
    const students = window.__scoresheet_students || [];
    // Gather inputs and push to db under /scores/<year>/<examType>/<class>
    const year = document.getElementById('academicYear').value || new Date().getFullYear();
    const exam = document.getElementById('examType').value || 'Monthly';
    const cls = document.getElementById('classSelect').value || 'Unknown';
    const refPath = `/scores/${year}/${exam}/${cls}`;
    const updates = {};
    const tbody = document.getElementById('scoresBody');
    [...tbody.children].forEach((tr, idx)=>{
      const adm = tr.children[1] ? tr.children[1].innerText : null;
      if(!adm) return;
      const present = tr.querySelector('.present-cell') ? Number(tr.querySelector('.present-cell').value||0) : 0;
      const absent = tr.querySelector('.absent-cell') ? Number(tr.querySelector('.absent-cell').value||0) : 0;
      const comment = tr.querySelector('.comment-cell') ? tr.querySelector('.comment-cell').value : '';
      updates[`${refPath}/${adm}`] = { present, absent, comment, updatedAt: Date.now() };
    });
    try{
      await db.ref().update(updates);
      alert('Scores saved successfully.');
    }catch(e){ console.error(e); alert('Error saving scores: '+e.message); }
  });

  // Email/SMS handler: builds contact links for open mail client or sms if phone provided.
  document.getElementById('btnEmailSMS').addEventListener('click', ()=>{
    const students = window.__scoresheet_students || [];
    const contacts = students.map(s=>({ name:s.name, email: s.email||'', phone: s.phone||'' }));
    // Build mailto of top 10 emails
    const emails = contacts.filter(c=>c.email).map(c=>c.email).slice(0,20);
    if(emails.length) window.location.href = `mailto:${emails.join(',')}?subject=Report Cards&body=Please find attached.`;
    else alert('No emails found on students.');
  });

  // If embedded as iframe, expose a simple API so academic.html can open scoresheet and pass current class
  window.scoresheetAPI = {
    loadClass: async function(cls, stream){
      document.getElementById('classSelect').value = cls || '';
      document.getElementById('streamSelect').value = stream || '';
      await onLoadClicked();
    },
    getSummary: function(){
      const students = window.__scoresheet_students || [];
      return { studentsCount: students.length };
    }
  };
</script>
</body>
</html>