<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Report Card</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js for graphs and pie charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- jsPDF + autotable for PDF generation -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase compat (v9 compat libs) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>

  <!-- Your Firebase config wrapper -->
  <script src="../firebase.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom right, #f3f4f6, #e5e7eb); color: #1f2937; min-height: 100vh; padding: 1.5rem; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); padding: 1.5rem; }
    .photo-oval { clip-path: ellipse(50% 50% at 50% 50%); width: 120px; height: 160px; object-fit: cover; border: 2px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .chart-container { background: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .archive-item { background: #f9fafb; border-radius: 0.5rem; padding: 1rem; cursor: pointer; transition: all 0.2s; }
    .archive-item:hover { background: #f3f4f6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(to right, #1d4ed8, #3b82f6); color: white; box-shadow: 0 2px 4px rgba(29,78,216,0.2); }
    .btn-primary:hover { background: linear-gradient(to right, #1e40af, #2563eb); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(29,78,216,0.3); }
    .btn-secondary { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
    .btn-secondary:hover { background: #e5e7eb; transform: translateY(-1px); }
    .hidden { display: none; }
    .preview-bg { background: linear-gradient(to bottom right, #eff6ff, #dbeafe); border-radius: 1rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
  </style>
</head>
<body>
  <div class="card max-w-6xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-900">SoMAp Report Card Dashboard</h1>
      <div class="flex gap-3">
        <button id="downloadSinglePdf" class="btn btn-primary">
          <i class="fas fa-file-pdf"></i> Download Report
        </button>
        <a href="#" id="backButton" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </a>
      </div>
    </header>

    <div id="status" class="mb-4 p-3 bg-blue-50 text-blue-700 rounded-lg text-center">Initializing...</div>

    <div class="dashboard-grid">
      <!-- Report Card Preview -->
      <div class="card p-6 preview-bg">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-id-card text-blue-600"></i> Report Card Preview
        </h2>
        <div class="p-6 rounded-xl shadow-inner bg-white">
          <img id="studentPhoto" class="photo-oval mx-auto mb-4" src="https://via.placeholder.com/120x160" alt="Student Photo">
          <div id="studentName" class="text-center font-bold text-lg mb-2">Loading...</div>
          <div id="classInfo" class="text-center text-sm text-gray-600 mb-2">Class: —</div>
          <div id="admNo" class="text-center text-sm text-gray-600 mb-2">Adm No: —</div>
          <div id="overallAvg" class="text-center text-sm text-gray-600 mb-2">Average: —%</div>
          <div id="overallGrade" class="text-center text-sm text-gray-600 mb-4">Grade: —</div>
          <div class="border-t pt-4">
            <p class="text-sm font-medium mb-2">Teacher Comment:</p>
            <p id="teacherComment" class="text-sm italic text-gray-700">—</p>
          </div>
        </div>
      </div>

      <!-- Performance Dashboard -->
      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-chart-line text-blue-600"></i> Performance Dashboard
        </h2>
        <div class="chart-container mb-4">
          <canvas id="performanceChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="subjectPieChart"></canvas>
        </div>
      </div>

      <!-- Archive Selector -->
      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <i class="fas fa-archive text-blue-600"></i> Report Archive
        </h2>
        <select id="archiveSelect" class="w-full p-2 border rounded mb-4">
          <option value="">Select period...</option>
        </select>
        <div id="archivePreview" class="bg-gray-50 p-4 rounded-lg min-h-[200px]">
          <p class="text-center text-gray-500">Select a period to view</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      // Firebase Initialization
      const db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
      if (!db) {
        document.getElementById('status').innerHTML = 'Database unavailable. Check console.';
        document.getElementById('status').className = 'mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-center';
        return;
      }

      // SUBJECTS_BY_CLASS from scoresheet.html
      const SUBJECTS_BY_CLASS = {
        'Baby': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
        'Middle': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
        'Preunit': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
        'Class 1': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
        'Class 2': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
        'Class 3': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
        'Class 4': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
        'Class 5': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
        'Class 6': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals'],
        'Class 7': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals']
      };

      // URL Params
      const params = new URLSearchParams(window.location.search);
      const key = params.get('key');
      const adm = params.get('adm');
      const phone = params.get('phone');
      const firstName = params.get('firstName');
      const lastName = params.get('lastName');
      const isTeacher = params.get('role') === 'teacher';

      if (!isTeacher) {
        document.getElementById('backButton').href = '../parent.html';
      } else {
        document.getElementById('backButton').href = '../checkscoresheet.html'; // Back to checkscoresheet for teachers
      }

      let student = null;
      let subjectList = [];
      let allScores = {}; // For positions

      // Fetch student data
      async function fetchStudentData() {
        document.getElementById('status').innerHTML = 'Loading report card...';
        try {
          let studentkey = null;

          if (key) {
            const snap = await db.ref('students/' + key).once('value');
            student = snap.val();
            studentkey = key;
          } else if (adm) {
            const snap = await db.ref('students').orderByChild('adm').equalTo(adm).once('value');
            const data = snap.val() || {};
            const firstKey = Object.keys(data)[0];
            if (firstKey) {
              student = data[firstKey];
              studentkey = firstKey;
            }
          } else if (phone && firstName && lastName) {
            const snap = await db.ref('students').once('value');
            const data = snap.val() || {};
            for (const [sKey, s] of Object.entries(data)) {
              if (
                s.primaryParentContact === phone &&
                s.firstName.toLowerCase().replace(/\s+/g, '') === firstName.toLowerCase().replace(/\s+/g, '') &&
                s.lastName.toLowerCase().replace(/\s+/g, '') === lastName.toLowerCase().replace(/\s+/g, '')
              ) {
                student = s;
                studentkey = sKey;
                break;
              }
            }
          }

          if (!student) {
            throw new Error('Student not found.');
          }

          const year = window.sessionStorage.getItem('year') || new Date().getFullYear().toString();
          const month = window.sessionStorage.getItem('month') || new Date().toLocaleString('default', { month: 'long' }).toLowerCase();
          const examKey = window.sessionStorage.getItem('examKey') || 'monthly';
          const className = student.class || student.classLevel;

          // Fetch scores for this student
          const scoresSnap = await db.ref(`scores/${year}/${className}/${examKey}/${month}/${student.adm}`).once('value');
          student.scores = scoresSnap.val() || {};

          // Fetch attendance
          const attSnap = await db.ref(`attendance/${year}/${month}/${className}/${student.adm}`).once('value');
          student.attendance = attSnap.val() || { present: 0, absent: 0, days: 0 };

          // Fetch payments and calculate
          const paymentsSnap = await db.ref(`students/${studentkey}/payments`).once('value');
          student.payments = paymentsSnap.val() || {};
          const { paid, debt } = calculatePayments(student);

          // Fetch class summary for subject list and positions
          const summarySnap = await db.ref(`summaries/${year}/${className}/${examKey}/${month}`).once('value');
          const summary = summarySnap.val() || {};
          subjectList = summary.subjectList || SUBJECTS_BY_CLASS[className] || [];

          // Fetch all class scores for positions
          const scoresSnapAll = await db.ref(`scores/${year}/${className}/${examKey}/${month}`).once('value');
          allScores = scoresSnapAll.val() || {};

          // Calculate per-subject positions
          const perSubject = {};
          subjectList.forEach(subject => {
            perSubject[subject] = [];
            Object.keys(allScores).forEach(adm => {
              const subjObj = allScores[adm][subject] || {};
              const score = Number(subjObj.score || 0);
              const max = Math.max(1, Number(subjObj.max || 100));
              const pct = (score / max) * 100;
              perSubject[subject].push({ adm, pct });
            });
            perSubject[subject].sort((a, b) => b.pct - a.pct);
          });

          student.subjectPositions = {};
          subjectList.forEach(subject => {
            const list = perSubject[subject];
            let pos = 0, last = null, idx = 0;
            list.forEach(item => {
              idx++;
              if (last === null || item.pct < last) { pos = idx; last = item.pct; }
              if (item.adm === student.adm) {
                student.subjectPositions[subject] = pos;
              }
            });
          });

          // Overall position from summaries or calculate
          if (summary.top3 && summary.bottom3) {
            const list = [...summary.top3, ...summary.bottom3].map(item => ({ adm: item.adm, avg: item.avg }));
            list.sort((a, b) => b.avg - a.avg);
            const posIndex = list.findIndex(item => item.adm === student.adm);
            student.overallPos = posIndex >= 0 ? posIndex + 1 : '—';
          } else {
            const arr = Object.keys(allScores).map(adm => {
              const scores = allScores[adm] || {};
              let sumScore = 0, sumMax = 0;
              subjectList.forEach(sub => {
                sumScore += Number(scores[sub]?.score || 0);
                sumMax += Number(scores[sub]?.max || 100);
              });
              const avg = sumMax ? (sumScore / sumMax) * 100 : 0;
              return { adm, avg };
            });
            arr.sort((a, b) => b.avg - a.avg);
            const posIndex = arr.findIndex(item => item.adm === student.adm);
            student.overallPos = posIndex >= 0 ? posIndex + 1 : '—';
          }

          // Photo from DB
          student.passportPhotoUrl = student.passportPhotoUrl || 'https://via.placeholder.com/120x160';

          renderReportCard(student, paid, debt);
          renderPerformanceDashboard(student);
          renderArchive(studentkey);
          document.getElementById('status').innerHTML = 'Report card loaded successfully.';
          document.getElementById('status').className = 'mb-4 p-3 bg-green-50 text-green-700 rounded-lg text-center';
        } catch (err) {
          console.error('Fetch Error:', err);
          document.getElementById('status').innerHTML = 'Error: ' + err.message;
          document.getElementById('status').className = 'mb-4 p-3 bg-red-50 text-red-700 rounded-lg text-center';
        }
      }

      // Render Report Card Preview
      function renderReportCard(student, paid, debt) {
        const photoUrl = student.passportPhotoUrl;
        const fullName = [student.firstName, student.middleName, student.lastName].filter(Boolean).join(' ').trim() || 'N/A';
        const classLevel = student.class || student.classLevel || 'N/A';
        const admNo = student.adm || student.admissionNumber || 'N/A';
        const avg = calculateAverage(student.scores);
        const grade = letterGrade(avg);
        const comment = getTeacherComment(grade, fullName.split(' ')[0] || '');

        document.getElementById('studentPhoto').src = photoUrl;
        document.getElementById('studentName').textContent = fullName;
        document.getElementById('classInfo').textContent = `Class: ${classLevel}`;
        document.getElementById('admNo').textContent = `Adm No: ${admNo}`;
        document.getElementById('overallAvg').textContent = `Average: ${avg.toFixed(2)}%`;
        document.getElementById('overallGrade').textContent = `Grade: ${grade}`;
        document.getElementById('teacherComment').textContent = comment;
      }

      // Performance Dashboard
      function renderPerformanceDashboard(student) {
        const scores = student.scores || {};
        const subjects = subjectList;
        const percentages = subjects.map(sub => ((scores[sub]?.score || 0) / (scores[sub]?.max || 100) * 100));
        const avg = calculateAverage(scores);

        const ctxGraph = document.getElementById('performanceChart').getContext('2d');
        new Chart(ctxGraph, {
          type: 'line',
          data: {
            labels: ['Prev Term', 'Midterm', 'Current'], // Mock; replace with real if archive data
            datasets: [{
              label: 'Performance Trend',
              data: [avg - 10, avg - 5, avg],
              borderColor: '#1d4ed8',
              fill: false
            }]
          },
          options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
        });

        const ctxPie = document.getElementById('subjectPieChart').getContext('2d');
        new Chart(ctxPie, {
          type: 'pie',
          data: {
            labels: subjects,
            datasets: [{
              data: percentages,
              backgroundColor: ['#ef4444', '#eab308', '#22c55e', '#3b82f6', '#a855f7', '#ec4899', '#f97316', '#6d28d9']
            }]
          },
          options: { responsive: true }
        });
      }

      // Report Archive
      async function renderArchive(studentkey) {
        const archiveSnap = await db.ref('summaries').once('value');
        const archives = archiveSnap.val() || {};
        const select = document.getElementById('archiveSelect');
        select.innerHTML = '<option value="">Select period...</option>';
        Object.entries(archives).forEach(([year, yearData]) => {
          Object.entries(yearData).forEach(([classLevel, classData]) => {
            Object.entries(classData).forEach(([examKey, examData]) => {
              Object.entries(examData).forEach(([month, data]) => {
                const option = document.createElement('option');
                option.value = `${year}-${classLevel}-${examKey}-${month}`;
                option.textContent = `${month.charAt(0).toUpperCase() + month.slice(1)} ${examKey} ${year} (${classLevel})`;
                select.appendChild(option);
              });
            });
          });
        });

        select.addEventListener('change', async (e) => {
          const [year, classLevel, examKey, month] = e.target.value.split('-');
          const preview = document.getElementById('archivePreview');
          preview.innerHTML = '<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div>';
          const snap = await db.ref(`summaries/${year}/${classLevel}/${examKey}/${month}`).get();
          const data = snap.val() || {};
          preview.innerHTML = `
            <p class="text-sm"><strong>Average:</strong> ${data.subjectAverages ? (Object.values(data.subjectAverages).reduce((sum, v) => sum + v, 0) / Object.keys(data.subjectAverages).length).toFixed(2) : '0'}%</p>
            <p class="text-sm"><strong>Top 3:</strong> ${data.top3 ? data.top3.map(t => t.name).join(', ') : 'N/A'}</p>
            <p class="text-sm"><strong>Bottom 3:</strong> ${data.bottom3 ? data.bottom3.map(b => b.name).join(', ') : 'N/A'}</p>
            <p class="text-sm"><strong>Attendance:</strong> ${data.attendance ? data.attendance.present : 0} present</p>
          `;
        });
      }

      // Download Single PDF (matched to bulk style from scoresheet.html)
      document.getElementById('downloadSinglePdf').onclick = () => {
        if (!student) {
          alert('No student data loaded. Please check credentials.');
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
        const margin = 36;
        const headerColor = { r: 37, g: 99, b: 235 };

        // Header (match bulk)
        doc.setFillColor(headerColor.r, headerColor.g, headerColor.b);
        doc.rect(0, 0, 595, 80, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        const school = student.schoolName || 'School';
        doc.text(`${school} — Academic Report`, margin, 40);
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);

        // Student Details (match bulk)
        doc.text(`Name: ${[student.firstName, student.middleName, student.lastName].filter(Boolean).join(' ').toUpperCase()}`, margin, 110);
        doc.text(`Admission: ${student.adm || student.admissionNumber || 'N/A'}`, margin, 130);
        const att = student.attendance || { present: 0, absent: 0, days: 0 };
        const days = att.days || (att.present + att.absent) || 0;
        const pct = days ? ((att.present / days) * 100).toFixed(1) : '0.0';
        doc.text(`Attendance: ${att.present}/${days} days (${pct}%)`, margin, 150);
        const fee = { required: student.feePerYear || student.feeDue || 0, paid: calculatePayments(student).paid, balance: calculatePayments(student).debt };
        doc.text(`Fees: Required ${money(fee.required)} | Paid ${money(fee.paid)} | Balance ${money(fee.balance)}`, margin, 170);

        // Scores Table (match bulk, include Max)
        const tableHead = ['Subject', 'Score', 'Max', '%', 'Pstn', 'Grade'];
        const tableBody = subjectList.map(sub => {
          const scObj = student.scores[sub] || {};
          const sc = Number(scObj.score || 0);
          const mx = Math.max(1, Number(scObj.max || 100));
          const pctS = (sc / mx) * 100;
          const g = letterGrade(pctS);
          const pstn = student.subjectPositions[sub] || '—';
          return [sub, sc.toFixed(2), mx.toFixed(0), pctS.toFixed(2), pstn, g];
        });
        doc.autoTable({ head: [tableHead], body: tableBody, startY: 200, styles: { fontSize: 9 }, headStyles: { fillColor: [headerColor.r, headerColor.g, headerColor.b] } });

        // Summary (match bulk)
        const after = doc.lastAutoTable.finalY + 20;
        const avg = calculateAverage(student.scores);
        doc.text(`Overall Average: ${avg.toFixed(2)}%`, margin, after);
        doc.text(`Overall Position: ${student.overallPos || '—'}`, margin, after + 18);
        doc.text(`Overall Grade: ${letterGrade(avg)}`, margin, after + 36);
        const comment = getTeacherComment(letterGrade(avg), student.firstName || '');
        doc.text('Teacher Comment:', margin, after + 64);
        doc.text(comment, margin, after + 82, { maxWidth: 595 - margin * 2 });

        doc.save(`ReportCard_${student.firstName}_${student.lastName}_${new Date().getFullYear()}.pdf`);
      };

      // Helper functions
      function calculatePayments(student) {
        let paid = 0;
        if (student.payments && typeof student.payments === 'object') {
          paid = Object.values(student.payments).reduce((sum, p) => sum + Number(p.amount || 0), 0);
        }
        const fee = Number(student.feePerYear || student.totalFee || student.feeDue || 0);
        const debt = Math.max(0, fee - paid);
        return { paid, debt };
      }

      function letterGrade(pct) {
        const p = Number(pct);
        if (p >= 80.5) return 'A';
        if (p >= 60.5) return 'B';
        if (p >= 40.5) return 'C';
        if (p >= 20.5) return 'D';
        return 'F';
      }

      function getTeacherComment(grade, name) {
        switch (grade) {
          case 'A': return `Wonderful ${name}, keep this spirit!`;
          case 'B': return `Good trial ${name}, aim higher!`;
          case 'C': return `Now, ${name}, this is completely not what we signed up for at our school. Work harder!`;
          case 'D': return `Dear ${name}, your performance needs significant improvement. Seek help and try harder!`;
          case 'F': return `Oh ${name}, this is a serious concern. Immediate effort is required!`;
          default: return `Feedback for ${name} pending.`;
        }
      }

      function money(n) {
        n = Number(n || 0);
        return new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES', maximumFractionDigits: 0 }).format(n);
      }

      function calculateAverage(scores) {
        const subjects = Object.keys(scores);
        if (subjects.length === 0) return 0;
        const total = subjects.reduce((sum, sub) => sum + ((scores[sub].score || 0) / (scores[sub].max || 100) * 100), 0);
        return total / subjects.length;
      }

      // Initial Load
      fetchStudentData();
    })();
  </script>
</body>
</html>