<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SoMAp — Per-Student Attendance</title>

<!-- Tailwind for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
  *{font-family:Inter,system-ui,Arial}
  .status-chip{min-width:44px;border-radius:9999px;padding:6px 10px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .chip-P{background:#dcfce7;color:#166534} /* green */
  .chip-A{background:#fee2e2;color:#991b1b} /* red */
  .chip-S{background:#fff7ed;color:#c2410c} /* amber */
  .chip-LE{background:#eef2ff;color:#3730a3} /* indigo */
  .chip-MT{background:#fff7f0;color:#9a3412} /* orange-ish */
  .chip-PG{background:#eef2ff;color:#0b69ff} /* permission blue */
  .chip-empty{background:#f3f4f6;color:#374151;border:1px dashed #e5e7eb}
  .status-pill{padding:4px 8px;border-radius:9999px;font-weight:700}
  .hidden{display:none!important}
  .table th, .table td{padding:8px;border-bottom:1px solid #e6e9ef;white-space:nowrap}
  .table thead th{background:#f8fafc;font-weight:700;position:sticky;top:0}
  .scroll{overflow:auto}
</style>
</head>
<body class="bg-slate-50 min-h-screen">

<header class="bg-white border-b sticky top-0 z-30">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <a href="../attendance.html" class="text-slate-700 hover:text-blue-600">← Back to Dashboard</a>
      <h1 class="text-lg font-semibold">SoMAp — Per-Student Attendance</h1>
    </div>
    <div class="flex items-center gap-3">
      <button id="btnFullscreen" class="px-3 py-1 rounded-md border bg-slate-100">Enter Fullscreen</button>
      <div id="rtState" class="text-sm text-slate-500">Connecting…</div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-4 space-y-4">

  <!-- Filters -->
  <section class="bg-white rounded-2xl p-4 shadow-sm border">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
      <div>
        <label class="text-sm font-medium">Class</label>
        <select id="classSelect" class="w-full border rounded px-3 py-2"></select>
      </div>
      <div>
        <label class="text-sm font-medium">Search / Show</label>
        <input id="searchInput" type="text" placeholder="Type name or admission" class="w-full border rounded px-3 py-2"/>
      </div>
    </div>
  </section>

  <!-- Per-student analytics list -->
  <section class="bg-white rounded-2xl p-4 shadow-sm border">
    <h3 class="font-semibold mb-3">Per-student summary (Month)</h3>
    <div id="perStudentStats" class="grid gap-3"></div>
  </section>

</main>

<footer class="bg-white border-t py-3 sticky bottom-0">
  <div class="max-w-6xl mx-auto px-4 text-sm text-slate-500 flex items-center gap-3">
    <div>SoMAp Per-Student Attendance · Mobile friendly</div>
    <div id="todayAlert" class="ml-auto text-sm text-yellow-700 hidden"></div>
  </div>
</footer>

<!-- Firebase libs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script src="../firebase.js"></script>

<script>
(async function(){
  // ---------- CONFIG ----------
  const TZ = 'Africa/Nairobi';
  const SCHOOL_DAY_CUTOFF_HOUR = 15;
  const HOLIDAYS = ['01-01','04-07','04-26','05-01','07-07','08-08','10-14','12-09','12-25','12-26'];
  const MOVABLE = ['2025-03-29','2025-04-01','2025-04-10','2025-04-11','2025-06-16'];

  // ---------- STATE ----------
  let students = [];
  let filtered = [];
  let currentClass = '';
  let currentDateStr = '';
  let monthKey = '';
  let attendanceCache = {};
  let monthAttendance = {};
  let db = window.db || (window.firebase && firebase.database ? firebase.database() : null);

  // ---------- HELPERS ----------
  const el = id => document.getElementById(id);
  function fmtDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function toMonthKey(dStr){ const d = new Date(dStr + 'T00:00:00'); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  function isWeekend(d){ const day = d.getDay(); return day===0 || day===6; }
  function isHoliday(d){ const fixed = String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); const iso = fmtDate(d); return HOLIDAYS.includes(fixed) || MOVABLE.includes(iso); }
  function monthWorkingDays(dateStr){
    const d = new Date(dateStr + 'T00:00:00'); const y=d.getFullYear(), m=d.getMonth();
    let count=0;
    for(let day=1; day<=31; day++){
      const dt = new Date(y,m,day); if(dt.getMonth()!==m) break;
      if(isWeekend(dt) || isHoliday(dt)) continue; count++;
    }
    return count;
  }

  // ---------- FIREBASE: load students ----------
  async function loadStudentsFromDb(){
    if(!db) return [];
    const tryPaths = ['students','Students','StudentsList','Students_List'];
    for(const p of tryPaths){
      try{
        const snap = await db.ref(p).get();
        if(snap.exists()){
          const data = snap.val();
          return Object.keys(data).map(k=>{
            const s = data[k] || {};
            const name = [s.firstName,s.middleName,s.lastName].filter(Boolean).join(' ').trim() || s.name || (s.fullName||'');
            const feeDue = Number(s.totalFee || s.feePerYear || s.feeDue || 0);
            const feePaid = Number(s.feesPaid || s.feePaid || s.paidAmount || 0);
            const balance = Number(s.balance || (feeDue - feePaid) || 0);
            return { id:k, admissionNo: s.admissionNumber || s.admNo || s.admissionNo || '', name, class: s.class || s.classLevel || s.grade || 'Unknown', feeDue, feePaid, balance };
          });
        }
      }catch(e){ console.warn('load path',p,e.message); }
    }
    return [];
  }

  // ---------- Attendance CRUD ----------
  async function loadMonthAttendance(cls, yymm){
    monthAttendance = {};
    if(!db || !cls) return;
    try{
      const snap = await db.ref(`attendance/${cls}/${yymm}`).get();
      const d = snap.exists() ? snap.val() : {};
      Object.keys(d).forEach(dateKey=>{
        const byStu = d[dateKey] || {};
        Object.keys(byStu).forEach(stuId=>{
          monthAttendance[stuId] = monthAttendance[stuId] || {};
          monthAttendance[stuId][dateKey] = byStu[stuId];
        });
      });
    }catch(e){ console.warn(e); }
  }

  // ---------- Render UI ----------
  function renderStudentStats(){
    const q = (el('searchInput').value || '').toLowerCase();
    filtered = students.filter(s => s.class === currentClass).filter(s => !q || s.name.toLowerCase().includes(q) || String(s.admissionNo || '').includes(q));
    el('perStudentStats').innerHTML = '';
    const workdays = monthWorkingDays(currentDateStr);
    filtered.forEach(s=>{
      const dates = monthAttendance[s.id] || {};
      let present=0, absent=0;
      Object.keys(dates).forEach(dk=>{
        const rec = dates[dk];
        if(rec && rec.daily==='P') present++;
        if(rec && (rec.daily||'').includes('A')) absent++;
      });
      const pct = workdays ? Math.round((present/workdays)*100) : 0;
      const card = document.createElement('div');
      card.className = 'p-3 rounded-xl border bg-white';
      card.innerHTML = `<div class="flex items-center justify-between"><div><b>${escapeHtml(s.name)}</b></div><div class="text-sm text-slate-500">${s.admissionNo}</div></div>
        <div class="text-sm mt-1">Present: <b>${present}</b> / ${workdays} · Absent: <b>${absent}</b> · ${pct}%</div>`;
      el('perStudentStats').appendChild(card);
    });
  }

  // ---------- UI wiring ----------
  function wireUI(){
    el('classSelect').addEventListener('change', async (e)=>{
      currentClass = e.target.value; if(!currentClass) return;
      monthKey = toMonthKey(currentDateStr);
      await loadMonthAttendance(currentClass, monthKey);
      renderStudentStats();
    });

    el('searchInput').addEventListener('input', () => renderStudentStats());

    el('btnFullscreen').addEventListener('click', ()=>{
      if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
      else document.exitFullscreen().catch(()=>{});
    });
    setInterval(check3pmAlert, 60*1000);
  }

  // ---------- 3PM alert ----------
  function check3pmAlert(){
    const now = new Date(); const cut = new Date(now); cut.setHours(SCHOOL_DAY_CUTOFF_HOUR,0,0,0);
    const box = el('todayAlert');
    if(now > cut){
      const need = filtered.some(s=> {
        const rec = attendanceCache[s.id] || {};
        return !(rec.am && rec.pm);
      });
      if(need){ box.textContent = '⚠️ 3:00 PM: Attendance not fully marked for today'; box.classList.remove('hidden'); }
      else { box.classList.add('hidden'); }
    } else { box.classList.add('hidden'); }
  }

  // ---------- Utilities ----------
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','"':'&#39;"}[m])); }

  // ---------- Start ----------
  async function init(){
    const now = new Date();
    currentDateStr = fmtDate(now);
    monthKey = toMonthKey(currentDateStr);

    if(!db){ el('rtState').textContent='firebase.js not loaded'; alert('firebase.js not loaded or window.db not set'); return; }
    el('rtState').textContent='Loading students...';
    students = await loadStudentsFromDb();
    populateClassSelect();
    el('rtState').textContent='Ready';
    wireUI();
    if(students.length && !currentClass){
      const classes = Array.from(new Set(students.map(s=>s.class))).sort();
      if(classes.length===1){ el('classSelect').value = classes[0]; el('classSelect').dispatchEvent(new Event('change')); }
    }
  }

  function populateClassSelect(){
    const classes = Array.from(new Set(students.map(s=>s.class))).filter(Boolean).sort();
    const sel = el('classSelect');
    sel.innerHTML = `<option value="">-- Select class --</option>` + classes.map(c=>`<option value="${c}">${c}</option>`).join('');
  }

  await init();
  el('rtState').textContent = db ? 'Connected' : 'No DB';
})();
</script>
</body>
</html>