<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SoMAp — Shifted Students Hub</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --glass: rgba(15,23,42,0.65);
    --glass-light: rgba(30,41,59,0.45);
    --accent: #38bdf8;
    --warning: #f97316;
    --danger: #ef4444;
    --success: #22c55e;
  }
  body{font-family:Inter,system-ui,sans-serif;background:radial-gradient(140% 100% at 0% 0%,#0f172a 0%,#020617 55%,#020617 100%);color:#e2e8f0;min-height:100vh;}
  a.back-link{color:#60a5fa;display:inline-flex;align-items:center;gap:6px;font-weight:500}
  .glass{background:var(--glass);border:1px solid rgba(148,163,184,0.18);backdrop-filter:blur(16px);border-radius:18px;box-shadow:0 24px 40px rgba(2,6,23,0.35)}
  .card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px}
  .metric-card{padding:18px}
  .metric-value{font-size:1.85rem;font-weight:700;margin-top:6px}
  .filters{display:flex;flex-wrap:wrap;gap:12px}
  .filters select,.filters input{background:rgba(148,163,184,0.08);border:1px solid rgba(148,163,184,0.25);border-radius:12px;padding:10px 14px;color:#e2e8f0}
  .filters select:focus,.filters input:focus{outline:2px solid rgba(56,189,248,0.5)}
  table{width:100%;border-collapse:collapse}
  thead th{background:rgba(15,23,42,0.85);position:sticky;top:0;padding:12px;text-align:left;font-weight:600;color:#cbd5f5}
  tbody td{padding:12px;border-bottom:1px solid rgba(148,163,184,0.18)}
  tbody tr:hover{background:rgba(15,118,110,0.15)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
  .badge-warning{background:rgba(249,115,22,0.16);color:#fb923c}
  .badge-danger{background:rgba(239,68,68,0.16);color:#f87171}
  .badge-success{background:rgba(34,197,94,0.16);color:#86efac}
  .badge-info{background:rgba(56,189,248,0.18);color:#7dd3fc}
  .view-link{color:#60a5fa;font-weight:500}
  @media(max-width:768px){
    thead{display:none}
    tbody tr{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;padding:16px 12px}
    tbody td{border:0;padding:0}
    tbody td::before{content:attr(data-label);display:block;font-size:12px;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.08em}
  }
</style>
</head>
<body>
  <header class="px-6 pt-6 pb-4 flex items-center justify-between">
    <a href="../attendance.html" class="back-link">
      <span aria-hidden="true">⟵</span> Back to Attendance
    </a>
    <h1 class="text-2xl font-semibold text-sky-200">Shifted Students Hub</h1>
  </header>

  <main class="px-6 pb-10 space-y-6">
    <!-- Metrics -->
    <section class="card-grid">
      <div class="glass metric-card">
        <div class="text-sm text-slate-300 uppercase tracking-wide">Total Shifted</div>
        <div id="totalShifted" class="metric-value text-sky-200">0</div>
        <div class="text-xs text-slate-400 mt-1">Students moved out of active rolls</div>
      </div>
      <div class="glass metric-card">
        <div class="text-sm text-slate-300 uppercase tracking-wide">Outstanding Debt</div>
        <div id="totalDebt" class="metric-value text-amber-300">0</div>
        <div class="text-xs text-slate-400 mt-1">Balance carried forward to hub</div>
      </div>
      <div class="glass metric-card">
        <div class="text-sm text-slate-300 uppercase tracking-wide">Most Impacted Class</div>
        <div id="topClass" class="metric-value text-emerald-200">—</div>
        <div class="text-xs text-slate-400 mt-1">Class with highest shifted count</div>
      </div>
      <div class="glass metric-card">
        <div class="text-sm text-slate-300 uppercase tracking-wide">Active Filter</div>
        <div id="activeFilter" class="metric-value text-indigo-200">All Years</div>
        <div class="text-xs text-slate-400 mt-1">Adjust filters to drill down</div>
      </div>
    </section>

    <!-- Filters -->
    <section class="glass p-4">
      <div class="filters">
        <div class="flex flex-col gap-2">
          <label class="text-xs text-slate-400 uppercase tracking-wide">Shift Year</label>
          <select id="yearFilter">
            <option value="all">All years</option>
          </select>
        </div>
        <div class="flex flex-col gap-2 flex-1 min-w-[220px]">
          <label class="text-xs text-slate-400 uppercase tracking-wide">Search</label>
          <input id="searchInput" type="text" placeholder="Search by student, admission or school"/>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="glass p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold text-slate-100">Shifted Students</h2>
        <div id="visibleCount" class="text-sm text-slate-400">0 records</div>
      </div>
      <div class="overflow-auto max-h-[70vh]">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Student</th>
              <th>Admission</th>
              <th>Class</th>
              <th>Date Shifted</th>
              <th>Debt</th>
              <th>Probable School</th>
              <th>Reason</th>
              <th>Status</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody id="shiftedBody">
            <tr>
              <td colspan="10" class="text-center text-slate-400 py-6">Waiting for shifted student records...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="../firebase.js"></script>

  <script>
  (async function(){
    const el = id => document.getElementById(id);
    const fmt = num => Number(num || 0).toLocaleString();
    const fmtCurrency = amt => 'TZS ' + Number(amt || 0).toLocaleString(undefined, { maximumFractionDigits: 0 });
    const safe = v => v ? String(v) : '';

    let db = null;
    let shifted = [];
    let filtered = [];
    let years = new Set();
    const filters = { year: 'all', search: '' };

    const nodes = {
      totalShifted: el('totalShifted'),
      totalDebt: el('totalDebt'),
      topClass: el('topClass'),
      activeFilter: el('activeFilter'),
      yearFilter: el('yearFilter'),
      searchInput: el('searchInput'),
      tableBody: el('shiftedBody'),
      count: el('visibleCount')
    };

    function escapeHtml(str){
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function initFirebase(){
      try {
        if (!window.firebase || !window.firebase.apps.length) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = '../firebase.js';
            script.onload = resolve;
            script.onerror = () => reject(new Error('Unable to load firebase.js'));
            document.head.appendChild(script);
          });
        }
        db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
        if (!db) throw new Error('Firebase database not initialised');
      } catch (err) {
        console.error(err);
        alert('Firebase error: ' + err.message);
      }
    }

    function subscribeShiftedStudents(){
      if (!db) return;
      db.ref('shiftedStudents').on('value', snapshot => {
        const raw = snapshot.val() || {};
        shifted = Object.keys(raw).map(key => {
          const s = raw[key] || {};
          const report = s.shiftReport || {};
          const classLevel = s.classLevel || s.class || report.className || 'Unknown';
          const shiftDate = report.dateShifted || s.shiftedAt || '';
          const debt = s.outstandingBalance != null ? s.outstandingBalance : (report.outstandingBalance || 0);
          const debtStatus = report.debtStatus || (debt > 0 ? 'not cleared' : 'cleared');
          const year = shiftDate ? shiftDate.slice(0,4) : 'Unknown';
          return {
            key,
            name: [s.firstName, s.middleName, s.lastName].filter(Boolean).join(' ') || s.name || report.studentName || 'Unknown',
            admission: s.admissionNumber || s.pupilId || s.admissionNo || s.admNo || report.admissionNo || '-',
            classLevel,
            shiftDate,
            year,
            debt,
            debtStatus,
            probableSchool: report.probableSchool || s.probableSchool || '-',
            reason: report.reason || '-',
            parentContact: report.parentContact || s.primaryParentContact || '-',
            shiftChoice: report.shiftChoice || '-',
            pathParent: `../parent.html?studentKey=${encodeURIComponent(key)}&source=shifted`
          };
        });
        years = new Set(shifted.map(item => item.year).filter(Boolean));
        buildYearFilter();
        applyFilters();
      });
    }

    function buildYearFilter(){
      if (!nodes.yearFilter) return;
      const current = filters.year;
      nodes.yearFilter.innerHTML = '<option value="all">All years</option>' + Array.from(years).sort((a,b)=>a.localeCompare(b)).map(y => `<option value="${escapeHtml(y)}">${escapeHtml(y)}</option>`).join('');
      if (current && Array.from(years).includes(current)) {
        nodes.yearFilter.value = current;
      } else {
        filters.year = 'all';
      }
    }

    function applyFilters(){
      filtered = shifted.filter(item => {
        const matchYear = filters.year === 'all' || item.year === filters.year;
        const term = filters.search.toLowerCase();
        const matchSearch = !term || [item.name, item.admission, item.probableSchool, item.reason].some(v => (v || '').toLowerCase().includes(term));
        return matchYear && matchSearch;
      });
      renderTable();
      renderMetrics();
    }

    function renderMetrics(){
      const total = shifted.length;
      const debt = shifted.reduce((sum, s) => sum + Number(s.debt || 0), 0);
      const map = {};
      shifted.forEach(s => {
        const key = s.classLevel || 'Unknown';
        map[key] = (map[key] || 0) + 1;
      });
      const topClassEntry = Object.entries(map).sort((a,b) => b[1]-a[1])[0];
      if (nodes.totalShifted) nodes.totalShifted.textContent = fmt(total);
      if (nodes.totalDebt) nodes.totalDebt.textContent = fmtCurrency(debt);
      if (nodes.topClass) nodes.topClass.textContent = topClassEntry ? `${topClassEntry[0]} (${topClassEntry[1]})` : '—';
      if (nodes.activeFilter) nodes.activeFilter.textContent = filters.year === 'all'
        ? `All Years - ${filtered.length} students`
        : `${filters.year} - ${filtered.length} students`;
      if (nodes.count) nodes.count.textContent = `${filtered.length} record${filtered.length === 1 ? '' : 's'}`;
    }

    function renderTable(){
      if (!nodes.tableBody) return;
      if (!filtered.length) {
        nodes.tableBody.innerHTML = `<tr><td colspan="10" class="text-center text-slate-400 py-6">No shifted students match the current filters.</td></tr>`;
        return;
      }
      nodes.tableBody.innerHTML = filtered.map((row, idx) => {
        const debtBadge = row.debt > 0 ? 'badge badge-warning' : 'badge badge-success';
        const debtText = row.debt > 0 ? 'Debt: Not cleared' : 'Debt: Cleared';
        const statusBadge = `<span class="${debtBadge}">${escapeHtml(debtText)}</span>`;
        return `
          <tr>
            <td data-label="#">${idx + 1}</td>
            <td data-label="Student">${escapeHtml(row.name)}</td>
            <td data-label="Admission">${escapeHtml(row.admission)}</td>
            <td data-label="Class">${escapeHtml(row.classLevel)}</td>
            <td data-label="Shift Date">${escapeHtml(row.shiftDate || '-')}</td>
            <td data-label="Debt">${fmtCurrency(row.debt)}</td>
            <td data-label="Probable School">${escapeHtml(row.probableSchool || '-')}</td>
            <td data-label="Reason">${escapeHtml(row.reason || '-')}</td>
            <td data-label="Status">${statusBadge}</td>
            <td data-label="View"><a class="view-link" href="${row.pathParent}" target="_blank" rel="noopener">View</a></td>
          </tr>
        `;
      }).join('');
    }

    if (nodes.yearFilter) {
      nodes.yearFilter.addEventListener('change', (e) => {
        filters.year = e.target.value || 'all';
        applyFilters();
      });
    }
    if (nodes.searchInput) {
      nodes.searchInput.addEventListener('input', (e) => {
        filters.search = (e.target.value || '').trim();
        applyFilters();
      });
    }

    await initFirebase();
    if (!db) return;
    subscribeShiftedStudents();
  })();
  </script>
</body>
</html>
