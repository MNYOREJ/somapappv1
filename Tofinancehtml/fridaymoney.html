<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoMAp - Friday Money Control Center</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="../firebase.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-bxRhwc8RaOPxYxJrW9pJ4SqqTHknc0aF4Pjk6DQKoNwV41jWzYuo82aDsr1BWqE7dprImC1Q4R0iU9wQ0p4F6w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root { font-size: 15px; }
    body {
      min-height: 100vh;
      background: linear-gradient(120deg, #fff7ed 0%, #fffbeb 55%, #fef3c7 100%);
      color: #1f2937;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(8px);
      border-radius: 16px;
      box-shadow: 0 25px 45px rgba(148, 109, 37, 0.12);
      border: 1px solid rgba(247, 202, 123, 0.4);
    }
    .stat-card h4 { font-size: 0.8rem; letter-spacing: 0.04em; text-transform: uppercase; }
    .stat-value { font-size: 1.85rem; font-weight: 700; color: #92400e; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.15rem 0.55rem;
      font-size: 0.68rem;
      font-weight: 600;
      border-radius: 999px;
      text-transform: uppercase;
    }
    .badge-green { background: #dcfce7; color: #166534; }
    .badge-amber { background: #fef3c7; color: #92400e; }
    .badge-red { background: #fee2e2; color: #b91c1c; }
    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.65rem;
      font-size: 0.75rem;
      border-radius: 999px;
      font-weight: 600;
      text-transform: capitalize;
    }
    .status-ok { background: #dcfce7; color: #166534; }
    .status-warn { background: #fef9c3; color: #854d0e; }
    .status-bad { background: #fee2e2; color: #991b1b; }
    table { border-collapse: collapse; width: 100%; }
    thead { background: #fef3c7; color: #78350f; }
    thead th {
      font-weight: 600;
      font-size: 0.78rem;
      letter-spacing: 0.03em;
      padding: 0.55rem 0.4rem;
      text-transform: uppercase;
    }
    tbody td {
      border-bottom: 1px solid #f3e8ff;
      padding: 0.55rem 0.45rem;
      font-size: 0.8rem;
    }
    tbody tr:nth-child(even) { background: rgba(255, 255, 255, 0.72); }
    tbody tr:hover { background: rgba(253, 230, 138, 0.3); transition: background 0.2s ease; }
    .table-scroll { overflow-x: auto; }
    .timeline-line { position: relative; padding-left: 1.35rem; margin-bottom: 0.65rem; }
    .timeline-line::before {
      content: "";
      position: absolute;
      left: 0.45rem;
      top: 0.3rem;
      width: 0.4rem;
      height: 0.4rem;
      border-radius: 999px;
      background: #f59e0b;
      box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 50;
    }
    .modal.active { display: flex; }
    .modal-card {
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      background: #fffaf0;
      border-radius: 18px;
      box-shadow: 0 30px 60px rgba(120, 53, 15, 0.25);
      padding: 1.5rem;
      position: relative;
    }
    .close-modal {
      position: absolute;
      top: 0.7rem;
      right: 0.9rem;
      cursor: pointer;
      font-size: 1.4rem;
      color: #92400e;
    }
    .floating-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(251, 191, 36, 0.15);
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.72rem;
    }
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }
    .shadowed-input {
      border: 1px solid rgba(249, 115, 22, 0.35);
      border-radius: 12px;
      padding: 0.55rem 0.65rem;
      width: 100%;
      background: rgba(255, 255, 255, 0.9);
    }
    .shadowed-input:focus {
      outline: 2px solid rgba(249, 115, 22, 0.35);
      box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.25);
    }
    @media (max-width: 960px) {
      .stat-value { font-size: 1.4rem; }
      thead { position: sticky; top: 0; z-index: 1; }
    }
  </style>
</head>
<body class="pb-16">
  <div class="mx-auto max-w-7xl px-4 py-6 lg:px-6">
    <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-widest text-amber-700">SoMAp Finance Intelligence</p>
        <h1 class="text-3xl font-black text-amber-900">Friday Money Control Center</h1>
        <p class="text-sm text-slate-500">Track weekly contributions, identify gaps instantly, and keep families informed with auditable exports.</p>
        <div class="mt-2 flex flex-wrap gap-2 text-xs">
          <span id="lastUpdated" class="floating-indicator"><i class="fa fa-clock"></i> Synced --</span>
          <span id="activeFridayBadge" class="floating-indicator"><i class="fa fa-calendar-week"></i> Active Fridays 0</span>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="fullscreenBtn" class="rounded-lg bg-amber-600 px-3 py-2 text-sm font-semibold text-white shadow hover:bg-amber-700"><i class="fa fa-expand"></i> Full Screen</button>
        <button id="reloadBtn" class="rounded-lg border border-amber-500 px-3 py-2 text-sm font-semibold text-amber-700 hover:bg-amber-100"><i class="fa fa-rotate"></i> Reload Data</button>
        <a href="../index.html" class="rounded-lg border border-slate-300 px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100"><i class="fa fa-arrow-left"></i> Back to Dashboard</a>
      </div>
    </header>

    <section class="mt-6 grid gap-3 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6">
      <div class="glass-card stat-card p-4">
        <h4>Total Students</h4>
        <div id="totalStudents" class="stat-value">--</div>
        <span class="badge badge-amber">Registered</span>
      </div>
      <div class="glass-card stat-card p-4">
        <h4>Present (Selected Friday)</h4>
        <div id="presentToday" class="stat-value">--</div>
        <span class="badge badge-green">Attendance</span>
      </div>
      <div class="glass-card stat-card p-4">
        <h4>Absent (Selected Friday)</h4>
        <div id="absentToday" class="stat-value">--</div>
        <span class="badge badge-red">Attendance</span>
      </div>
      <div class="glass-card stat-card p-4">
        <h4>Paid 1,000 TSH</h4>
        <div id="paidToday" class="stat-value">--</div>
        <span class="badge badge-green">This Friday</span>
      </div>
      <div class="glass-card stat-card p-4">
        <h4>Collected (TSH)</h4>
        <div id="collectedToday" class="stat-value">--</div>
        <span class="badge badge-amber">Selected Friday</span>
      </div>
      <div class="glass-card stat-card p-4">
        <h4>Balance After Expenses</h4>
        <div id="balanceAfterExpenses" class="stat-value">--</div>
        <span class="badge badge-green">Net</span>
      </div>
    </section>

    <section class="glass-card mt-8 p-4">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
        <div class="grid gap-3 md:grid-cols-2 lg:grid-cols-3">
          <div>
            <label class="text-xs font-semibold uppercase tracking-widest text-slate-500">Select Friday</label>
            <select id="fridaySelector" class="shadowed-input"></select>
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-widest text-slate-500">Filter by Class</label>
            <select id="classFilter" class="shadowed-input"></select>
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-widest text-slate-500">Search Student / Admission</label>
            <input id="studentSearch" class="shadowed-input" placeholder="Type name, admission or contact" />
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="showOnlyUnpaid" class="rounded-lg border border-amber-500 px-3 py-2 text-xs font-semibold uppercase tracking-widest text-amber-700 hover:bg-amber-100">Show Only Debtors</button>
          <button id="clearFilters" class="rounded-lg border border-slate-300 px-3 py-2 text-xs font-semibold uppercase tracking-widest text-slate-700 hover:bg-slate-100">Reset Filters</button>
        </div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2 text-xs text-slate-600">
        <span id="selectedFridayLabel" class="badge badge-amber">Friday</span>
        <span id="selectedFridayMeta" class="badge badge-green">Records --</span>
        <span id="unpaidSummary" class="badge badge-red">Debtors --</span>
      </div>
    </section>
    <section class="mt-6 grid gap-6 lg:grid-cols-3">
      <div class="lg:col-span-2">
        <div class="glass-card p-4">
          <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div>
              <h2 class="text-xl font-semibold text-amber-900">Student Ledger</h2>
              <p class="text-xs uppercase tracking-widest text-slate-500">Admission No / Full Name / Class / Attendance / Paid / Recorded By</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="downloadFridayExcel" class="rounded bg-amber-600 px-3 py-1.5 text-xs font-semibold uppercase tracking-widest text-white hover:bg-amber-700"><i class="fa fa-file-excel"></i> Friday Excel</button>
              <button id="downloadFridayPdf" class="rounded bg-amber-500 px-3 py-1.5 text-xs font-semibold uppercase tracking-widest text-white hover:bg-amber-600"><i class="fa fa-file-pdf"></i> Friday PDF</button>
              <button id="downloadDebtorsExcel" class="rounded bg-slate-800 px-3 py-1.5 text-xs font-semibold uppercase tracking-widest text-white hover:bg-slate-900"><i class="fa fa-file-export"></i> Debtors Excel</button>
            </div>
          </div>
          <div id="studentTableContainer" class="table-scroll mt-4">
            <table>
              <thead>
                <tr>
                  <th>Admission No</th>
                  <th>Full Name</th>
                  <th>Class</th>
                  <th>Attendance</th>
                  <th>Paid 1000 TSH</th>
                  <th>Recorded By</th>
                  <th>Total Paid</th>
                  <th>Fridays Paid</th>
                  <th>Fridays Due</th>
                  <th>Outstanding (TSH)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ledgerBody"></tbody>
            </table>
          </div>
          <div id="studentEmptyState" class="empty-state hidden">
            <i class="fa fa-face-smile text-amber-500"></i>
            <p class="mt-2 font-semibold">No matching records</p>
            <p class="text-sm">Adjust filters to view the list of students for this Friday.</p>
          </div>
        </div>
      </div>
      <div class="glass-card flex flex-col gap-4 p-4">
        <div>
          <h3 class="text-lg font-semibold text-amber-900">Friday Insights</h3>
          <p class="text-xs uppercase tracking-widest text-slate-500">Auto-updated from firebase</p>
        </div>
        <div id="fridayInsights" class="space-y-3 text-sm"></div>
        <div>
          <h4 class="text-sm font-semibold uppercase tracking-widest text-slate-600">Top Outstanding Learners</h4>
          <ul id="topDebtors" class="mt-2 space-y-2 text-sm"></ul>
        </div>
        <div>
          <h4 class="text-sm font-semibold uppercase tracking-widest text-slate-600">Export Tools</h4>
          <div class="mt-2 flex flex-wrap gap-2">
            <button id="downloadLedgerPdf" class="rounded border border-amber-400 px-3 py-1.5 text-xs font-semibold uppercase tracking-widest text-amber-800 hover:bg-amber-50"><i class="fa fa-file-pdf"></i> Ledger PDF</button>
            <button id="downloadLedgerExcel" class="rounded border border-amber-400 px-3 py-1.5 text-xs font-semibold uppercase tracking-widest text-amber-800 hover:bg-amber-50"><i class="fa fa-file-excel"></i> Ledger Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section class="mt-8 grid gap-6 lg:grid-cols-2">
      <div class="glass-card p-4">
        <div class="flex flex-col gap-2">
          <h3 class="text-lg font-semibold text-amber-900">Record Attendance & Payment</h3>
          <p class="text-xs uppercase tracking-widest text-slate-500">Quick entry for selected Friday</p>
        </div>
        <form id="quickEntryForm" class="mt-3 grid gap-3 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="text-xs font-semibold uppercase tracking-widest">Student</label>
            <select id="quickStudent" class="shadowed-input" required></select>
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-widest">Attendance</label>
            <select id="quickAttendance" class="shadowed-input" required>
              <option value="">Select</option>
              <option value="present">Present</option>
              <option value="absent">Absent</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-widest">Paid 1,000 TSH?</label>
            <select id="quickPayment" class="shadowed-input" required>
              <option value="">Select</option>
              <option value="paid">Yes - Paid</option>
              <option value="unpaid">No - Not Paid</option>
            </select>
          </div>
          <div class="md:col-span-2 flex flex-wrap gap-2">
            <button type="submit" class="rounded bg-amber-600 px-4 py-2 text-sm font-semibold uppercase tracking-widest text-white hover:bg-amber-700">Save Record</button>
            <button type="button" id="openAttendanceModal" class="rounded border border-amber-500 px-4 py-2 text-sm font-semibold uppercase tracking-widest text-amber-700 hover:bg-amber-100">Open Full Form</button>
          </div>
        </form>
      </div>
      <div class="glass-card p-4">
        <div class="flex flex-col gap-2">
          <h3 class="text-lg font-semibold text-amber-900">Expense Tracker</h3>
          <p class="text-xs uppercase tracking-widest text-slate-500">Attach proof & keep balances clean</p>
        </div>
        <form id="expenseForm" class="mt-3 grid gap-3">
          <div class="grid gap-3 md:grid-cols-2">
            <input id="expenseItem" class="shadowed-input" placeholder="Item (e.g. Juices)" required />
            <input id="expenseSeller" class="shadowed-input" placeholder="Seller / Shop" required />
          </div>
          <div class="grid gap-3 md:grid-cols-2">
            <input id="expenseContact" class="shadowed-input" placeholder="Seller Contact" required />
            <input id="expenseQuantity" type="number" min="1" class="shadowed-input" placeholder="Quantity" required />
          </div>
          <div class="grid gap-3 md:grid-cols-2">
            <input id="expensePricePer" type="number" min="0" class="shadowed-input" placeholder="Price per item" required />
            <input id="expenseProof" type="file" accept="image/*,application/pdf" class="shadowed-input" required />
          </div>
          <button type="submit" class="rounded bg-slate-900 px-4 py-2 text-sm font-semibold uppercase tracking-widest text-white hover:bg-slate-800"><i class="fa fa-plus"></i> Save Expense</button>
        </form>
      </div>
    </section>
    <section class="glass-card mt-8 p-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h3 class="text-lg font-semibold text-amber-900">Friday Expenses Ledger</h3>
          <p class="text-xs uppercase tracking-widest text-slate-500">Proof based spending</p>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="downloadExpensesExcel" class="rounded border border-amber-500 px-3 py-1.5 text-xs font-semibold uppercase tracking-widest text-amber-800 hover:bg-amber-50"><i class="fa fa-file-excel"></i> Expenses Excel</button>
          <button id="downloadAuditExcel" class="rounded border border-amber-500 px-3 py-1.5 text-xs font-semibold uppercase tracking-widest text-amber-800 hover:bg-amber-50"><i class="fa fa-clipboard-list"></i> Audit Excel</button>
        </div>
      </div>
      <div class="table-scroll mt-3">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Seller</th>
              <th>Contact</th>
              <th>Price (TSH)</th>
              <th>Qty</th>
              <th>Total</th>
              <th>Proof</th>
              <th>Recorded By</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="expenseTableBody"></tbody>
        </table>
      </div>
    </section>

    <section class="glass-card mt-8 p-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h3 class="text-lg font-semibold text-amber-900">Audit Log</h3>
          <p class="text-xs uppercase tracking-widest text-slate-500">Every change is tracked per Friday</p>
        </div>
        <button id="downloadAuditCsv" class="rounded border border-slate-400 px-3 py-1.5 text-xs font-semibold uppercase tracking-widest text-slate-700 hover:bg-slate-100"><i class="fa fa-file-export"></i> Download CSV</button>
      </div>
      <ul id="auditLogList" class="mt-3 space-y-2 text-sm"></ul>
    </section>
  </div>

  <div id="attendanceModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <span id="closeAttendanceModal" class="close-modal">&times;</span>
      <h3 class="text-lg font-semibold text-amber-900">Record Friday Attendance & Payment</h3>
      <form id="attendanceForm" class="mt-4 space-y-3">
        <div>
          <label class="text-xs font-semibold uppercase tracking-widest">Student</label>
          <select id="studentSelect" class="shadowed-input" required></select>
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-widest">Attendance</label>
          <select id="attendanceStatus" class="shadowed-input" required>
            <option value="">Select status</option>
            <option value="present">Present</option>
            <option value="absent">Absent</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-widest">Paid 1,000 TSH?</label>
          <select id="paymentStatus" class="shadowed-input" required>
            <option value="">Select payment</option>
            <option value="paid">Yes - Paid</option>
            <option value="unpaid">No - Not paid</option>
          </select>
        </div>
        <button type="submit" class="w-full rounded bg-amber-600 px-4 py-2 text-sm font-semibold uppercase tracking-widest text-white hover:bg-amber-700">Save Record</button>
      </form>
    </div>
  </div>

  <div id="detailsModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card max-w-3xl">
      <span id="closeDetailsModal" class="close-modal">&times;</span>
      <div>
        <h3 id="detailsTitle" class="text-lg font-semibold text-amber-900">Student Ledger</h3>
        <p class="text-xs uppercase tracking-widest text-slate-500">Friday-by-Friday breakdown</p>
      </div>
      <div id="detailsContent" class="mt-4 space-y-2"></div>
    </div>
  </div>
  <script>
    (function () {
      const COST_PER_FRIDAY = 1000;
      const FRIDAY_START = "2024-08-22";
      const YEARS_AHEAD = 6;
      const DATE_OPTIONS = { weekday: "short", month: "short", day: "numeric", year: "numeric" };

      const db = window.db || null;
      const auth = firebase.auth();
      const storage = window.storage || (firebase.storage ? firebase.storage() : null);

      const state = {
        fridays: [],
        selectedFridayId: "",
        currentFridayId: "",
        students: {},
        fridayMoney: {},
        expenses: {},
        audit: {},
        users: {},
        fridayMeta: {},
        activeFridaySet: new Set(),
        studentSummaries: {},
        filters: { classLevel: "", showOnlyUnpaid: false, search: "" },
        currentUser: null,
        loading: false
      };

      const dom = {
        totalStudents: document.getElementById("totalStudents"),
        presentToday: document.getElementById("presentToday"),
        absentToday: document.getElementById("absentToday"),
        paidToday: document.getElementById("paidToday"),
        collectedToday: document.getElementById("collectedToday"),
        balanceAfterExpenses: document.getElementById("balanceAfterExpenses"),
        fridaySelector: document.getElementById("fridaySelector"),
        classFilter: document.getElementById("classFilter"),
        showOnlyUnpaid: document.getElementById("showOnlyUnpaid"),
        clearFilters: document.getElementById("clearFilters"),
        studentSearch: document.getElementById("studentSearch"),
        ledgerBody: document.getElementById("ledgerBody"),
        studentEmptyState: document.getElementById("studentEmptyState"),
        fridayInsights: document.getElementById("fridayInsights"),
        topDebtors: document.getElementById("topDebtors"),
        reloadBtn: document.getElementById("reloadBtn"),
        fullscreenBtn: document.getElementById("fullscreenBtn"),
        activeFridayBadge: document.getElementById("activeFridayBadge"),
        selectedFridayLabel: document.getElementById("selectedFridayLabel"),
        selectedFridayMeta: document.getElementById("selectedFridayMeta"),
        unpaidSummary: document.getElementById("unpaidSummary"),
        lastUpdated: document.getElementById("lastUpdated"),
        quickEntryForm: document.getElementById("quickEntryForm"),
        quickStudent: document.getElementById("quickStudent"),
        quickAttendance: document.getElementById("quickAttendance"),
        quickPayment: document.getElementById("quickPayment"),
        attendanceModal: document.getElementById("attendanceModal"),
        closeAttendanceModal: document.getElementById("closeAttendanceModal"),
        attendanceForm: document.getElementById("attendanceForm"),
        studentSelect: document.getElementById("studentSelect"),
        attendanceStatus: document.getElementById("attendanceStatus"),
        paymentStatus: document.getElementById("paymentStatus"),
        detailsModal: document.getElementById("detailsModal"),
        closeDetailsModal: document.getElementById("closeDetailsModal"),
        detailsContent: document.getElementById("detailsContent"),
        detailsTitle: document.getElementById("detailsTitle"),
        expenseForm: document.getElementById("expenseForm"),
        expenseTableBody: document.getElementById("expenseTableBody"),
        auditLogList: document.getElementById("auditLogList"),
        downloadFridayExcel: document.getElementById("downloadFridayExcel"),
        downloadFridayPdf: document.getElementById("downloadFridayPdf"),
        downloadDebtorsExcel: document.getElementById("downloadDebtorsExcel"),
        downloadLedgerPdf: document.getElementById("downloadLedgerPdf"),
        downloadLedgerExcel: document.getElementById("downloadLedgerExcel"),
        downloadExpensesExcel: document.getElementById("downloadExpensesExcel"),
        downloadAuditExcel: document.getElementById("downloadAuditExcel"),
        downloadAuditCsv: document.getElementById("downloadAuditCsv"),
        openAttendanceModalBtn: document.getElementById("openAttendanceModal")
      };

      function init() {
        if (!db) {
          alert("Database not detected. Please confirm firebase.js is loaded correctly.");
          return;
        }
        state.fridays = generateFridayList();
        state.currentFridayId = findCurrentFridayId();
        state.selectedFridayId = state.currentFridayId;
        populateFridaySelector();
        attachEventListeners();
        auth.onAuthStateChanged((user) => {
          state.currentUser = user;
          if (!user) {
            window.location.href = "../index.html";
          }
        });
        loadAllData();
      }

      function generateFridayList() {
        const fridays = [];
        const start = new Date(FRIDAY_START);
        while (start.getDay() !== 5) {
          start.setDate(start.getDate() + 1);
        }
        const limit = new Date(start);
        limit.setFullYear(limit.getFullYear() + YEARS_AHEAD);
        const cursor = new Date(start);
        while (cursor <= limit) {
          const id = cursor.toISOString().slice(0, 10);
          fridays.push({
            id,
            label: cursor.toLocaleDateString(undefined, DATE_OPTIONS),
            timestamp: cursor.getTime()
          });
          cursor.setDate(cursor.getDate() + 7);
        }
        return fridays;
      }

      function findCurrentFridayId() {
        const today = Date.now();
        let chosen = state.fridays[0]?.id || "";
        for (const f of state.fridays) {
          if (f.timestamp <= today) chosen = f.id;
        }
        return chosen;
      }

      async function loadAllData() {
        setLoading(true);
        try {
          const [studentsSnap, moneySnap, expenseSnap, auditSnap, usersSnap] = await Promise.all([
            db.ref("students").once("value"),
            db.ref("fridayMoney").once("value"),
            db.ref("fridayExpenses").once("value"),
            db.ref("fridayAudit").once("value"),
            db.ref("users").once("value")
          ]);
          state.students = studentsSnap.val() || {};
          state.fridayMoney = moneySnap.val() || {};
          state.expenses = expenseSnap.val() || {};
          state.audit = auditSnap.val() || {};
          state.users = usersSnap.val() || {};
          refreshDerivedData();
          renderAll();
          updateLastSynced();
        } catch (err) {
          console.error("Failed to load Friday money data", err);
          alert("Unable to load data. Check your internet connection and Firebase permissions.");
        } finally {
          setLoading(false);
        }
      }
      function refreshDerivedData() {
        computeFridayMeta();
        computeStudentSummaries();
        populateStudentSelects();
        populateClassFilter();
      }

      function computeFridayMeta() {
        const activeSet = new Set();
        const today = Date.now();
        const meta = {};
        for (const friday of state.fridays) {
          const recs = state.fridayMoney[friday.id] || {};
          let paidCount = 0;
          let presentCount = 0;
          let unpaidPresent = 0;
          Object.values(recs).forEach((entry) => {
            if (entry.attendance === "present") {
              presentCount += 1;
              if (entry.payment !== "paid") {
                unpaidPresent += 1;
              }
            }
            if (entry.payment === "paid") {
              paidCount += 1;
            }
          });
          const collected = paidCount * COST_PER_FRIDAY;
          const hasPaid = paidCount > 0 && friday.timestamp <= today;
          if (hasPaid) {
            activeSet.add(friday.id);
          }
          meta[friday.id] = {
            paidCount,
            presentCount,
            unpaidPresent,
            collected,
            recorded: Object.keys(recs).length,
            hasPaid,
            timestamp: friday.timestamp
          };
        }
        state.fridayMeta = meta;
        state.activeFridaySet = activeSet;
        dom.activeFridayBadge.textContent = `Active Fridays ${activeSet.size}`;
      }

      function computeStudentSummaries() {
        const summaries = {};
        const now = Date.now();
        const fridaysPast = state.fridays.filter((f) => f.timestamp <= now);
        for (const [id, student] of Object.entries(state.students)) {
          const summary = {
            id,
            fullName: buildFullName(student),
            admission: student.admissionNumber || "",
            classLevel: student.classLevel || "",
            contact: extractContact(student),
            paidFridays: [],
            unpaidFridays: [],
            totalPaidAmount: 0,
            attendanceRecords: 0,
            paidCount: 0,
            unpaidCount: 0,
            amountDue: 0,
            lastPaymentTs: 0
          };
          let expectedFridays = 0;
          fridaysPast.forEach((friday) => {
            const recs = state.fridayMoney[friday.id] || {};
            const record = recs[id];
            const isActive = state.activeFridaySet.has(friday.id);
            if (record) {
              summary.attendanceRecords += 1;
              if (record.payment === "paid") {
                summary.paidFridays.push(friday);
                summary.totalPaidAmount += COST_PER_FRIDAY;
                summary.paidCount += 1;
                if (record.timestamp && record.timestamp > summary.lastPaymentTs) {
                  summary.lastPaymentTs = record.timestamp;
                }
              } else if (isActive) {
                summary.unpaidFridays.push(friday);
                summary.unpaidCount += 1;
              }
            } else if (isActive) {
              summary.unpaidFridays.push(friday);
              summary.unpaidCount += 1;
            }
            if (isActive) {
              expectedFridays += 1;
            }
          });
          summary.expectedFridays = expectedFridays;
          summary.amountDue = Math.max(0, expectedFridays * COST_PER_FRIDAY - summary.totalPaidAmount);
          summaries[id] = summary;
        }
        state.studentSummaries = summaries;
      }

      function populateFridaySelector() {
        dom.fridaySelector.innerHTML = "";
        state.fridays.forEach((friday) => {
          const opt = document.createElement("option");
          opt.value = friday.id;
          opt.textContent = friday.label;
          if (friday.id === state.selectedFridayId) opt.selected = true;
          dom.fridaySelector.appendChild(opt);
        });
      }

      function populateStudentSelects() {
        const entries = Object.entries(state.students).sort((a, b) => buildFullName(a[1]).localeCompare(buildFullName(b[1])));
        const targets = [dom.studentSelect, dom.quickStudent];
        targets.forEach((select) => {
          select.innerHTML = "<option value=''>Select student</option>";
        });
        entries.forEach(([id, student]) => {
          const label = `${buildFullName(student)} - ${student.classLevel || ""} - ${student.admissionNumber || ""}`;
          targets.forEach((select) => {
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = label;
            select.appendChild(opt);
          });
        });
      }

      function populateClassFilter() {
        const classes = new Set();
        Object.values(state.students).forEach((s) => {
          if (s.classLevel) classes.add(s.classLevel);
        });
        dom.classFilter.innerHTML = "<option value=''>All classes</option>";
        Array.from(classes).sort().forEach((cls) => {
          const opt = document.createElement("option");
          opt.value = cls;
          opt.textContent = cls;
          dom.classFilter.appendChild(opt);
        });
      }

      function renderAll() {
        renderSummaryCards();
        renderStudentLedger();
        renderFridayInsights();
        renderExpenses();
        renderAudit();
      }

      function renderSummaryCards() {
        const totalStudents = Object.keys(state.students).length;
        const records = state.fridayMoney[state.selectedFridayId] || {};
        let present = 0;
        let paid = 0;
        Object.values(records).forEach((rec) => {
          if (rec.attendance === "present") present += 1;
          if (rec.payment === "paid") paid += 1;
        });
        const absent = Math.max(0, totalStudents - present);
        const collected = paid * COST_PER_FRIDAY;
        const expenses = computeTotalExpenses(state.selectedFridayId);
        const balance = collected - expenses;
        dom.totalStudents.textContent = formatNumber(totalStudents);
        dom.presentToday.textContent = formatNumber(present);
        dom.absentToday.textContent = formatNumber(absent);
        dom.paidToday.textContent = formatNumber(paid);
        dom.collectedToday.textContent = formatCurrency(collected);
        dom.balanceAfterExpenses.textContent = formatCurrency(balance);
        const meta = state.fridayMeta[state.selectedFridayId] || {};
        dom.selectedFridayLabel.textContent = `Friday ${state.selectedFridayId}`;
        dom.selectedFridayMeta.textContent = `${meta.presentCount || 0} present / ${meta.paidCount || 0} paid`;
        dom.unpaidSummary.textContent = `${meta.unpaidPresent || 0} pending payments`;
      }

      function renderStudentLedger() {
        const records = state.fridayMoney[state.selectedFridayId] || {};
        const filtered = Object.values(state.studentSummaries)
          .filter((summary) => matchFilters(summary))
          .sort((a, b) => a.fullName.localeCompare(b.fullName));
        dom.ledgerBody.innerHTML = "";
        if (!filtered.length) {
          dom.studentEmptyState.classList.remove("hidden");
          return;
        }
        dom.studentEmptyState.classList.add("hidden");
        filtered.forEach((summary) => {
          const record = records[summary.id] || null;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${summary.admission || ""}</td>
            <td class="font-semibold">${summary.fullName}</td>
            <td>${summary.classLevel || ""}</td>
            <td>${renderAttendancePill(record)}</td>
            <td>${renderPaymentPill(record)}</td>
            <td>${record && record.recordedBy ? resolveUserName(record.recordedBy) : "--"}</td>
            <td>${formatCurrency(summary.totalPaidAmount)}</td>
            <td>${summary.paidCount}</td>
            <td>${summary.unpaidCount}</td>
            <td class="font-semibold ${summary.amountDue > 0 ? "text-red-600" : "text-emerald-600"}">${formatCurrency(summary.amountDue)}</td>
            <td>
              <div class="flex flex-col gap-1">
                <button class="rounded bg-amber-500 px-2 py-1 text-xs font-semibold text-white hover:bg-amber-600" data-action="record" data-id="${summary.id}">Record</button>
                <button class="rounded border border-amber-400 px-2 py-1 text-xs font-semibold text-amber-700 hover:bg-amber-100" data-action="details" data-id="${summary.id}">History</button>
              </div>
            </td>
          `;
          dom.ledgerBody.appendChild(tr);
        });
        dom.ledgerBody.querySelectorAll("button[data-action='record']").forEach((btn) => {
          btn.addEventListener("click", () => openAttendanceModal(btn.dataset.id));
        });
        dom.ledgerBody.querySelectorAll("button[data-action='details']").forEach((btn) => {
          btn.addEventListener("click", () => openDetailsModal(btn.dataset.id));
        });
      }
      function renderAttendancePill(record) {
        if (!record) return `<span class="status-pill status-warn">unmarked</span>`;
        const cls = record.attendance === "present" ? "status-ok" : record.attendance === "absent" ? "status-bad" : "status-warn";
        return `<span class="status-pill ${cls}">${record.attendance}</span>`;
      }

      function renderPaymentPill(record) {
        if (!record) return `<span class="status-pill status-bad">No</span>`;
        const cls = record.payment === "paid" ? "status-ok" : "status-bad";
        return `<span class="status-pill ${cls}">${record.payment === "paid" ? "Yes" : "No"}</span>`;
      }

      function renderFridayInsights() {
        const meta = state.fridayMeta[state.selectedFridayId] || {};
        const insights = [
          { label: "Students recorded", value: formatNumber(meta.recorded || 0) },
          { label: "Active Fridays to date", value: formatNumber(state.activeFridaySet.size) },
          { label: "Total outstanding", value: formatCurrency(sumOutstanding()) },
          { label: "Total collected overall", value: formatCurrency(sumCollected()) },
          { label: "Expenses (selected)", value: formatCurrency(computeTotalExpenses(state.selectedFridayId)) },
          { label: "Expected this Friday", value: formatCurrency((meta.hasPaid ? Object.keys(state.students).length : 0) * COST_PER_FRIDAY) }
        ];
        dom.fridayInsights.innerHTML = insights.map((ins) => `<div class="flex justify-between"><span class="text-slate-600">${ins.label}</span><span class="font-semibold text-amber-900">${ins.value}</span></div>`).join("");
        renderTopDebtors();
      }

      function renderTopDebtors() {
        const top = Object.values(state.studentSummaries)
          .filter((s) => s.amountDue > 0)
          .sort((a, b) => b.amountDue - a.amountDue)
          .slice(0, 6);
        if (!top.length) {
          dom.topDebtors.innerHTML = '<li class="text-slate-500">No outstanding balances 🎉</li>';
          return;
        }
        dom.topDebtors.innerHTML = "";
        top.forEach((s) => {
          const li = document.createElement("li");
          li.innerHTML = `<div class="flex flex-col">
            <span class="font-semibold text-amber-900">${s.fullName}</span>
            <span class="text-xs text-slate-500">${s.classLevel || ""} | Contact: ${s.contact || "--"}</span>
            <span class="text-sm font-semibold text-red-600">Outstanding ${formatCurrency(s.amountDue)}</span>
          </div>`;
          dom.topDebtors.appendChild(li);
        });
      }

      function renderExpenses() {
        const expenses = state.expenses[state.selectedFridayId] || {};
        dom.expenseTableBody.innerHTML = "";
        const entries = Object.entries(expenses);
        if (!entries.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="9" class="text-center text-sm text-slate-500">No expenses recorded for this Friday.</td>`;
          dom.expenseTableBody.appendChild(tr);
          return;
        }
        entries.sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0)).forEach(([id, exp]) => {
          const tr = document.createElement("tr");
          const total = Number(exp.pricePer || 0) * Number(exp.quantity || 0);
          tr.innerHTML = `
            <td>${exp.item || ""}</td>
            <td>${exp.seller || ""}</td>
            <td>${exp.contact || ""}</td>
            <td>${formatCurrency(exp.pricePer || 0)}</td>
            <td>${exp.quantity || 0}</td>
            <td>${formatCurrency(total)}</td>
            <td>${exp.proofUrl ? `<a href="${exp.proofUrl}" target="_blank" class="text-amber-700 underline">View proof</a>` : "--"}</td>
            <td>${exp.recordedBy ? resolveUserName(exp.recordedBy) : "--"}</td>
            <td>${exp.timestamp ? new Date(exp.timestamp).toLocaleString() : "--"}</td>
          `;
          dom.expenseTableBody.appendChild(tr);
        });
      }

      function renderAudit() {
        const logs = state.audit[state.selectedFridayId] || {};
        const entries = Object.values(logs).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        dom.auditLogList.innerHTML = "";
        if (!entries.length) {
          const li = document.createElement("li");
          li.className = "text-sm text-slate-500";
          li.textContent = "No audit activity recorded for this Friday yet.";
          dom.auditLogList.appendChild(li);
          return;
        }
        entries.forEach((log) => {
          const li = document.createElement("li");
          li.innerHTML = `<span class="font-semibold text-amber-900">${new Date(log.timestamp).toLocaleString()}</span> — ${log.action} <span class="text-slate-500">by ${resolveUserName(log.userId)}</span>`;
          dom.auditLogList.appendChild(li);
        });
      }

      function matchFilters(summary) {
        if (state.filters.classLevel && summary.classLevel !== state.filters.classLevel) return false;
        if (state.filters.showOnlyUnpaid && summary.amountDue <= 0) return false;
        if (state.filters.search) {
          const term = state.filters.search.toLowerCase();
          const hay = `${summary.fullName} ${summary.admission} ${summary.classLevel} ${summary.contact}`.toLowerCase();
          if (!hay.includes(term)) return false;
        }
        return true;
      }

      function attachEventListeners() {
        dom.fridaySelector.addEventListener("change", (e) => {
          state.selectedFridayId = e.target.value || state.currentFridayId;
          renderAll();
        });
        dom.classFilter.addEventListener("change", (e) => {
          state.filters.classLevel = e.target.value;
          renderStudentLedger();
        });
        dom.showOnlyUnpaid.addEventListener("click", () => {
          state.filters.showOnlyUnpaid = !state.filters.showOnlyUnpaid;
          dom.showOnlyUnpaid.textContent = state.filters.showOnlyUnpaid ? "Showing Debtors" : "Show Only Debtors";
          renderStudentLedger();
        });
        dom.clearFilters.addEventListener("click", () => {
          state.filters = { classLevel: "", showOnlyUnpaid: false, search: "" };
          dom.classFilter.value = "";
          dom.studentSearch.value = "";
          dom.showOnlyUnpaid.textContent = "Show Only Debtors";
          renderStudentLedger();
        });
        dom.studentSearch.addEventListener("input", (e) => {
          state.filters.search = e.target.value.trim();
          renderStudentLedger();
        });
        dom.reloadBtn.addEventListener("click", loadAllData);
        dom.fullscreenBtn.addEventListener("click", toggleFullScreen);
        dom.quickEntryForm.addEventListener("submit", handleQuickEntrySubmit);
        dom.attendanceForm.addEventListener("submit", handleAttendanceSubmit);
        dom.expenseForm.addEventListener("submit", handleExpenseSubmit);
        dom.closeAttendanceModal.addEventListener("click", closeAttendanceModal);
        dom.closeDetailsModal.addEventListener("click", closeDetailsModal);
        dom.openAttendanceModalBtn.addEventListener("click", () => openAttendanceModal());
        window.addEventListener("click", (e) => {
          if (e.target === dom.attendanceModal) closeAttendanceModal();
          if (e.target === dom.detailsModal) closeDetailsModal();
        });
        dom.downloadFridayExcel.addEventListener("click", downloadSelectedFridayExcel);
        dom.downloadFridayPdf.addEventListener("click", downloadSelectedFridayPdf);
        dom.downloadDebtorsExcel.addEventListener("click", downloadDebtorsExcel);
        dom.downloadLedgerPdf.addEventListener("click", downloadLedgerPdf);
        dom.downloadLedgerExcel.addEventListener("click", downloadLedgerExcel);
        dom.downloadExpensesExcel.addEventListener("click", downloadExpensesExcel);
        dom.downloadAuditExcel.addEventListener("click", downloadAuditExcel);
        dom.downloadAuditCsv.addEventListener("click", downloadAuditCsvFile);
        document.addEventListener("fullscreenchange", updateFullscreenButton);
      }

      function toggleFullScreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }

      function updateFullscreenButton() {
        const active = Boolean(document.fullscreenElement);
        dom.fullscreenBtn.innerHTML = active ? '<i class="fa fa-compress"></i> Exit Full Screen' : '<i class="fa fa-expand"></i> Full Screen';
      }
      function handleQuickEntrySubmit(e) {
        e.preventDefault();
        const studentId = dom.quickStudent.value;
        const attendance = dom.quickAttendance.value;
        const payment = dom.quickPayment.value;
        if (!studentId || !attendance || !payment) {
          alert("Fill all quick entry fields.");
          return;
        }
        saveAttendance(studentId, attendance, payment);
      }

      function handleAttendanceSubmit(e) {
        e.preventDefault();
        const studentId = dom.studentSelect.value;
        const attendance = dom.attendanceStatus.value;
        const payment = dom.paymentStatus.value;
        if (!studentId || !attendance) {
          alert("Select student and attendance status.");
          return;
        }
        const paymentValue = attendance === "present" ? (payment || "unpaid") : "unpaid";
        saveAttendance(studentId, attendance, paymentValue, true);
      }

      async function saveAttendance(studentId, attendance, payment, closeModal = false) {
        try {
          const payload = {
            attendance,
            payment,
            recordedBy: state.currentUser ? state.currentUser.uid : "system",
            timestamp: Date.now()
          };
          await db.ref(`fridayMoney/${state.selectedFridayId}/${studentId}`).set(payload);
          addAudit(`Recorded ${attendance}/${payment} for ${studentId}`);
          if (!state.fridayMoney[state.selectedFridayId]) state.fridayMoney[state.selectedFridayId] = {};
          state.fridayMoney[state.selectedFridayId][studentId] = payload;
          refreshDerivedData();
          renderAll();
          dom.quickEntryForm.reset();
          if (closeModal) {
            closeAttendanceModal();
          }
          alert("Record saved successfully.");
        } catch (err) {
          console.error("Unable to save attendance", err);
          alert("Failed to save record. Check your internet connection.");
        }
      }

      async function handleExpenseSubmit(e) {
        e.preventDefault();
        const item = document.getElementById("expenseItem").value.trim();
        const seller = document.getElementById("expenseSeller").value.trim();
        const contact = document.getElementById("expenseContact").value.trim();
        const quantity = Number(document.getElementById("expenseQuantity").value || 0);
        const pricePer = Number(document.getElementById("expensePricePer").value || 0);
        const file = document.getElementById("expenseProof").files[0];
        if (!item || !seller || !contact || !quantity || !pricePer || !file) {
          alert("Provide all expense fields including proof.");
          return;
        }
        try {
          const storagePath = `fridayProofs/${state.selectedFridayId}/${Date.now()}_${file.name}`;
          let proofUrl = "";
          if (storage) {
            const uploadRef = storage.ref(storagePath);
            await uploadRef.put(file);
            proofUrl = await uploadRef.getDownloadURL();
          }
          const ref = db.ref(`fridayExpenses/${state.selectedFridayId}`).push();
          const payload = {
            item,
            seller,
            contact,
            quantity,
            pricePer,
            proofUrl,
            recordedBy: state.currentUser ? state.currentUser.uid : "system",
            timestamp: Date.now()
          };
          await ref.set(payload);
          addAudit(`Added expense ${item} (${quantity} @ ${pricePer})`);
          if (!state.expenses[state.selectedFridayId]) state.expenses[state.selectedFridayId] = {};
          state.expenses[state.selectedFridayId][ref.key] = payload;
          renderExpenses();
          renderSummaryCards();
          dom.expenseForm.reset();
          alert("Expense saved successfully.");
        } catch (err) {
          console.error("Failed to save expense", err);
          alert("Unable to save expense. Please try again.");
        }
      }

      function openAttendanceModal(studentId = "") {
        dom.attendanceModal.classList.add("active");
        dom.studentSelect.value = studentId || "";
        if (studentId) preloadAttendance(studentId);
      }

      function preloadAttendance(studentId) {
        const record = (state.fridayMoney[state.selectedFridayId] || {})[studentId];
        dom.attendanceStatus.value = record ? record.attendance : "";
        dom.paymentStatus.value = record ? record.payment : "";
      }

      function closeAttendanceModal() {
        dom.attendanceModal.classList.remove("active");
        dom.attendanceForm.reset();
      }

      function openDetailsModal(studentId) {
        const summary = state.studentSummaries[studentId];
        if (!summary) return;
        dom.detailsModal.classList.add("active");
        dom.detailsTitle.textContent = `${summary.fullName} — ${summary.classLevel || ""}`;
        const rows = [];
        state.fridays.forEach((friday) => {
          const rec = (state.fridayMoney[friday.id] || {})[studentId];
          const payment = rec ? rec.payment : "unmarked";
          const attendance = rec ? rec.attendance : "unmarked";
          if (!rec && !state.activeFridaySet.has(friday.id)) return;
          rows.push(`<div class="timeline-line">
            <div class="flex justify-between">
              <span class="font-semibold text-amber-900">${friday.label}</span>
              <span class="text-xs text-slate-500">${state.activeFridaySet.has(friday.id) ? "Counted Friday" : "Pending"}</span>
            </div>
            <div class="text-sm">Attendance: <strong>${attendance}</strong>, Paid: <strong>${payment}</strong></div>
          </div>`);
        });
        dom.detailsContent.innerHTML = rows.join("") || "<p class='text-sm text-slate-500'>No records yet for this learner.</p>";
      }

      function closeDetailsModal() {
        dom.detailsModal.classList.remove("active");
        dom.detailsContent.innerHTML = "";
      }

      function addAudit(action) {
        const entry = {
          action,
          userId: state.currentUser ? state.currentUser.uid : "system",
          timestamp: Date.now()
        };
        db.ref(`fridayAudit/${state.selectedFridayId}`).push(entry);
        if (!state.audit[state.selectedFridayId]) state.audit[state.selectedFridayId] = {};
        const key = `local-${Date.now()}`;
        state.audit[state.selectedFridayId][key] = entry;
        renderAudit();
      }

      function downloadSelectedFridayExcel() {
        const headers = ["Admission", "Full Name", "Class", "Parent Contact", "Attendance", "Paid", "Recorded By", "Recorded At"];
        const rows = [headers];
        const records = state.fridayMoney[state.selectedFridayId] || {};
        Object.entries(state.students).forEach(([id, student]) => {
          const record = records[id];
          rows.push([
            student.admissionNumber || "",
            buildFullName(student),
            student.classLevel || "",
            extractContact(student),
            record ? record.attendance : "unmarked",
            record && record.payment === "paid" ? "Yes" : "No",
            record && record.recordedBy ? resolveUserName(record.recordedBy) : "--",
            record && record.timestamp ? new Date(record.timestamp).toLocaleString() : "--"
          ]);
        });
        exportToExcel(rows, `friday_${state.selectedFridayId}.xlsx`, "Friday");
      }

      function downloadSelectedFridayPdf() {
        const records = state.fridayMoney[state.selectedFridayId] || {};
        const body = Object.entries(state.students).map(([id, student]) => {
          const record = records[id];
          return [
            student.admissionNumber || "",
            buildFullName(student),
            student.classLevel || "",
            record ? record.attendance : "unmarked",
            record && record.payment === "paid" ? "Yes" : "No",
            record && record.recordedBy ? resolveUserName(record.recordedBy) : "--",
            record && record.timestamp ? new Date(record.timestamp).toLocaleDateString() : "--"
          ];
        });
        exportToPdf({
          filename: `friday_${state.selectedFridayId}.pdf`,
          head: [["Admission", "Full Name", "Class", "Attendance", "Paid", "Recorded By", "Recorded At"]],
          body
        });
      }

      function downloadDebtorsExcel() {
        const headers = ["Admission", "Full Name", "Class", "Parent Contact", "Fridays Paid", "Fridays Due", "Amount Paid", "Amount Due", "Unpaid Dates"];
        const rows = [headers];
        Object.values(state.studentSummaries)
          .filter((s) => s.amountDue > 0)
          .forEach((s) => {
            rows.push([
              s.admission,
              s.fullName,
              s.classLevel,
              s.contact,
              s.paidCount,
              s.unpaidCount,
              formatCurrencyPlain(s.totalPaidAmount),
              formatCurrencyPlain(s.amountDue),
              s.unpaidFridays.map((f) => f.id).join(", ")
            ]);
          });
        exportToExcel(rows, "friday_debtors.xlsx", "Debtors");
      }

      function downloadLedgerPdf() {
        const body = Object.values(state.studentSummaries).map((s) => [
          s.admission,
          s.fullName,
          s.classLevel,
          s.paidCount,
          s.unpaidCount,
          formatCurrencyPlain(s.totalPaidAmount),
          formatCurrencyPlain(s.amountDue)
        ]);
        exportToPdf({
          filename: "friday_ledger.pdf",
          head: [["Admission", "Full Name", "Class", "Fridays Paid", "Fridays Due", "Paid", "Outstanding"]],
          body
        });
      }
      function downloadLedgerExcel() {
        const headers = ["Admission", "Full Name", "Class", "Contact", "Fridays Paid", "Fridays Due", "Amount Paid", "Outstanding", "Last Payment"];
        const rows = [headers];
        Object.values(state.studentSummaries).forEach((s) => {
          rows.push([
            s.admission,
            s.fullName,
            s.classLevel,
            s.contact,
            s.paidCount,
            s.unpaidCount,
            formatCurrencyPlain(s.totalPaidAmount),
            formatCurrencyPlain(s.amountDue),
            s.lastPaymentTs ? new Date(s.lastPaymentTs).toLocaleDateString() : "--"
          ]);
        });
        exportToExcel(rows, "friday_ledger.xlsx", "Ledger");
      }

      function downloadExpensesExcel() {
        const headers = ["Friday", "Item", "Seller", "Contact", "Price", "Quantity", "Total", "Recorded By", "Date", "Proof"];
        const rows = [headers];
        const expenses = state.expenses[state.selectedFridayId] || {};
        Object.values(expenses).forEach((exp) => {
          const total = Number(exp.pricePer || 0) * Number(exp.quantity || 0);
          rows.push([
            state.selectedFridayId,
            exp.item,
            exp.seller,
            exp.contact,
            formatCurrencyPlain(exp.pricePer || 0),
            exp.quantity,
            formatCurrencyPlain(total),
            resolveUserName(exp.recordedBy),
            exp.timestamp ? new Date(exp.timestamp).toLocaleString() : "--",
            exp.proofUrl || ""
          ]);
        });
        exportToExcel(rows, `friday_expenses_${state.selectedFridayId}.xlsx`, "Expenses");
      }

      function downloadAuditExcel() {
        const headers = ["Friday", "Action", "User", "Timestamp"];
        const rows = [headers];
        const logs = state.audit[state.selectedFridayId] || {};
        Object.values(logs).forEach((log) => {
          rows.push([
            state.selectedFridayId,
            log.action,
            resolveUserName(log.userId),
            log.timestamp ? new Date(log.timestamp).toLocaleString() : "--"
          ]);
        });
        exportToExcel(rows, `friday_audit_${state.selectedFridayId}.xlsx`, "Audit");
      }

      function downloadAuditCsvFile() {
        const headers = ["Friday", "Action", "User", "Timestamp"];
        const rows = [headers];
        const logs = state.audit[state.selectedFridayId] || {};
        Object.values(logs).forEach((log) => {
          rows.push([
            state.selectedFridayId,
            log.action,
            resolveUserName(log.userId),
            log.timestamp ? new Date(log.timestamp).toLocaleString() : "--"
          ]);
        });
        const worksheet = XLSX.utils.aoa_to_sheet(rows);
        const csv = XLSX.utils.sheet_to_csv(worksheet);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `friday_audit_${state.selectedFridayId}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function exportToExcel(rows, filename, sheetName) {
        const worksheet = XLSX.utils.aoa_to_sheet(rows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
        XLSX.writeFile(workbook, filename);
      }

      function exportToPdf({ filename, head, body }) {
        const doc = new window.jspdf.jsPDF("landscape");
        doc.autoTable({ head, body, styles: { fontSize: 8 } });
        doc.save(filename);
      }

      function buildFullName(student) {
        return [student.firstName, student.middleName, student.lastName].filter(Boolean).join(" ") || "Unnamed";
      }

      function extractContact(student) {
        return student.parentContact || student.guardianPhone || student.contact || student.parentPhone || "";
      }

      function resolveUserName(uid) {
        if (!uid) return "Unknown";
        const safe = uid.replace(/\./g, "_");
        const user = state.users[safe] || state.users[uid];
        if (!user) return uid;
        return user.name || user.displayName || uid;
      }

      function computeTotalExpenses(fridayId) {
        const expenses = state.expenses[fridayId] || {};
        return Object.values(expenses).reduce((sum, exp) => sum + Number(exp.pricePer || 0) * Number(exp.quantity || 0), 0);
      }

      function sumOutstanding() {
        return Object.values(state.studentSummaries).reduce((sum, s) => sum + s.amountDue, 0);
      }

      function sumCollected() {
        let total = 0;
        Object.values(state.fridayMeta).forEach((meta) => {
          total += meta.collected || 0;
        });
        return total;
      }

      function formatNumber(val) {
        return Number(val || 0).toLocaleString();
      }

      function formatCurrency(amount) {
        return `${formatNumber(amount)} TSH`;
      }

      function formatCurrencyPlain(amount) {
        return Number(amount || 0);
      }

      function setLoading(isLoading) {
        state.loading = isLoading;
        dom.reloadBtn.disabled = isLoading;
        dom.reloadBtn.textContent = isLoading ? "Refreshing..." : "Reload Data";
      }

      function updateLastSynced() {
        dom.lastUpdated.innerHTML = `<i class="fa fa-clock"></i> Synced ${new Date().toLocaleTimeString()}`;
      }

      init();
    })();
  </script>
</body>
</html>
