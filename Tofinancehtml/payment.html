<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Installment Breakdown</title>

  <!-- Firebase (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    .status-pill { padding:2px 8px; border-radius:999px; font-size: 11px; font-weight:600; }
    .status-cleared { background:#dcfce7; color:#166534; }
    .status-partial { background:#fef9c3; color:#854d0e; }
    .status-overdue { background:#fee2e2; color:#991b1b; }
    .table-header { background:#eef2ff; color:#1f2937; }
  </style>
</head>
<body class="bg-white">
  <div id="breakdownContent" class="text-sm p-4">
    <!-- skeleton loader -->
    <div id="skel" class="animate-pulse">
      <div class="h-4 bg-slate-200 rounded w-2/3 mb-3"></div>
      <div class="h-3 bg-slate-200 rounded w-full mb-2"></div>
      <div class="h-3 bg-slate-200 rounded w-5/6"></div>
    </div>
  </div>

  <script>
    (function () {
      // ---- Firebase init (inline, so the iframe never depends on ../firebase.js) ----
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
        measurementId: "G-4HKX7KN6Q3"
      };
      try { if (!firebase?.apps?.length) firebase.initializeApp(firebaseConfig); }
      catch (e) { console.error('Firebase init error', e); }
      const db = (() => { try { return firebase.database(); } catch { return null; }})();

      const mount = (html) => {
        const el = document.getElementById('breakdownContent');
        el.innerHTML = html;
        // ask parent to resize this iframe
        const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        try { window.parent.postMessage({ type:'resizeIframe', id: window.__STUDENT_ID__, height: h }, '*'); } catch {}
      };
      const err = (msg) => mount(`<div class="p-3 rounded bg-rose-50 text-rose-700 border border-rose-200">${msg}</div>`);

      if (!db) { err('Error: Database not initialized. Please check Firebase credentials or internet connection.'); return; }

      // ---- helpers ----
      const fmt = (n) => (Number(n) || 0).toLocaleString();
      const nowTS = () => Date.now();
      function ymdToTS(academicYear, m, d, endOfDay = false) {
        const y = (m === 12) ? (Number(academicYear) - 1) : Number(academicYear);
        return endOfDay
          ? new Date(y, m - 1, d, 23, 59, 59, 999).getTime()
          : new Date(y, m - 1, d, 0, 0, 0, 0).getTime();
      }
      function apportion(total, weights) {
        if (!Array.isArray(weights) || !weights.length) return [];
        const sumW = weights.reduce((a, b) => a + b, 0);
        let amounts = weights.map(w => Math.floor((w * total) / sumW));
        let sumA = amounts.reduce((a, b) => a + b, 0);
        let rem = total - sumA;
        if (rem > 0) {
          const sortedIdx = [...weights.keys()].sort((a, b) => weights[b] - weights[a]);
          for (let i = 0; i < rem; i++) amounts[sortedIdx[i % sortedIdx.length]]++;
        }
        return amounts;
      }

      // ---- installment configs (5% off for full-year; 2-instalments = no discount) ----
      const installmentConfigs = {
        lower: {
          type: '6', weights: [44, 13, 12, 22, 22, 16],
          labels: ['Inst 1','Inst 2','Inst 3','Inst 4','Inst 5','Inst 6'],
          windows: [
            { from:[12,1], to:[1,10] }, { from:[3,1], to:[3,15] }, { from:[4,1], to:[4,15] },
            { from:[5,1], to:[5,15] }, { from:[7,1], to:[7,15] }, { from:[9,1], to:[9,15] },
          ]
        },
        class4_7: {
          type: '4', weights: [328, 180, 176, 132],
          labels: ['Inst 1','Inst 2','Inst 3','Inst 4'],
          windows: [
            { from:[12,1], to:[1,10] }, { from:[3,1], to:[3,15] }, { from:[4,1], to:[4,15] }, { from:[5,1], to:[5,15] }
          ]
        },
        class5: {
          type: '6', weights: [44, 23, 22, 32, 26, 17],
          labels: ['Inst 1','Inst 2','Inst 3','Inst 4','Inst 5','Inst 6'],
          windows: [
            { from:[12,1], to:[1,10] }, { from:[3,1], to:[3,15] }, { from:[4,1], to:[4,15] },
            { from:[5,1], to:[5,15] }, { from:[7,1], to:[7,15] }, { from:[9,1], to:[9,15] },
          ]
        },
        class6: {
          type: '6', weights: [236, 115, 110, 160, 160, 100],
          labels: ['Inst 1','Inst 2','Inst 3','Inst 4','Inst 5','Inst 6'],
          windows: [
            { from:[12,1], to:[1,10] }, { from:[3,1], to:[3,15] }, { from:[4,1], to:[4,15] },
            { from:[5,1], to:[5,15] }, { from:[7,1], to:[7,15] }, { from:[9,1], to:[9,15] },
          ]
        },
        monthly: {
          type: 'monthly',
          weights: [2,1,1,1,1,1,2,1,1,1],
          labels: ['Jan (2 months)','Feb','Mar','Apr','May','Jun','Jul (2 months)','Aug','Sep','Oct'],
          windows: [
            { from:[1,1], to:[1,31] }, { from:[2,1], to:[2,28] }, { from:[3,1], to:[3,31] }, { from:[4,1], to:[4,30] },
            { from:[5,1], to:[5,31] }, { from:[6,1], to:[6,30] }, { from:[7,1], to:[7,31] },
            { from:[8,1], to:[8,31] }, { from:[9,1], to:[9,30] }, { from:[10,1], to:[10,31] },
          ]
        },
        '2inst': {
          type: '2', discount: 1, // 0% discount (can change if policy says otherwise)
          weights: [1,1], labels: ['1st Half','2nd Half'],
          windows: [ { from:[1,1], to:[1,10] }, { from:[7,1], to:[7,5] } ]
        },
        full: {
          type: 'full', discount: 0.95, // 5% off for full-year
          weights: [1], labels: ['Full Year (5% off)'],
          windows: [ { from:[1,1], to:[1,10] } ]
        }
      };

      function getConfig(student) {
        const plan = String(student.paymentPlan || '').toLowerCase();
        const c = String(student.classLevel || '').toLowerCase();
        if (plan.includes('monthly')) return installmentConfigs.monthly;
        if (plan.includes('2')) return installmentConfigs['2inst'];
        if (plan.includes('full') || plan.includes('year')) return installmentConfigs.full;
        if (plan.includes('inst')) {
          if (c === 'class 1' || c === 'class 2' || c === 'class 3') return installmentConfigs.lower;
          if (c === 'class 5') return installmentConfigs.class5;
          if (c === 'class 6') return installmentConfigs.class6;
          if (c === 'class 4' || c === 'class 7') return installmentConfigs.class4_7;
        }
        return installmentConfigs.lower;
      }

      function buildSchedule(student) {
        const config = getConfig(student);
        const academicYear = Number(student.academicYear || new Date().getFullYear());
        let feeBase = Number(student.feePerYear) || 0;
        const disc = (typeof config.discount === 'number') ? config.discount : 1;
        feeBase = Math.round(feeBase * disc);

        const amounts = apportion(feeBase, config.weights);
        const items = config.labels.map((label, idx) => {
          const [fromM, fromD] = config.windows[idx].from;
          const [toM, toD] = config.windows[idx].to;
          return {
            label, amount: amounts[idx],
            fromTS: ymdToTS(academicYear, fromM, fromD, false),
            toTS:   ymdToTS(academicYear, toM, toD, true),
            paidAllocated: 0, status: 'Pending'
          };
        });
        return { items, academicYear, feeBase };
      }

      function allocatePayments(schedule, student) {
        const payments = Object.values(student.payments || {}).map(p => Number(p.amount) || 0);
        const totalPaid = payments.reduce((a,b) => a + b, 0);
        let pot = totalPaid;
        for (const it of schedule.items) {
          if (pot <= 0) break;
          const need = Math.max(0, it.amount - it.paidAllocated);
          const use = Math.min(need, pot);
          it.paidAllocated += use;
          pot -= use;
        }
        const credit = Math.max(0, pot);
        const now = nowTS();
        for (const it of schedule.items) {
          const got = it.paidAllocated, need = it.amount;
          if (got >= need) it.status = 'Cleared';
          else if (now > it.toTS) it.status = (got > 0) ? 'Partially Paid (Overdue)' : 'Overdue';
          else it.status = (got > 0) ? 'Partially Paid' : 'Pending';
        }
        const expectedToDate = schedule.items.filter(it => it.toTS < now).reduce((s, it) => s + it.amount, 0);
        const paidConsumed = totalPaid - credit;
        const debtTillNow = Math.max(0, expectedToDate - paidConsumed);
        return { credit, totalPaid, debtTillNow };
      }

      function render(student) {
        const schedule = buildSchedule(student);
        const { credit, totalPaid, debtTillNow } = allocatePayments(schedule, student);
        const totalsExp = schedule.items.reduce((s, it) => s + it.amount, 0);
        const totalsPaid = schedule.items.reduce((s, it) => s + it.paidAllocated, 0);
        const rem = Math.max(0, totalsExp - totalsPaid);
        const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();

        const rows = schedule.items.map(it => {
          const remaining = Math.max(0, it.amount - it.paidAllocated);
          const win = new Date(it.fromTS).toLocaleDateString() + ' – ' + new Date(it.toTS).toLocaleDateString();
          const statusClass = it.status === 'Cleared'
            ? 'status-cleared'
            : (it.status.includes('Overdue') ? 'status-overdue' : 'status-partial');
          return `
            <tr>
              <td class="p-1 border text-center">${it.label}</td>
              <td class="p-1 border text-right">${fmt(it.amount)}</td>
              <td class="p-1 border text-right">${fmt(it.paidAllocated)}</td>
              <td class="p-1 border text-right">${fmt(remaining)}</td>
              <td class="p-1 border text-center"><span class="status-pill ${statusClass}">${it.status}</span></td>
              <td class="p-1 border text-center">${win}</td>
            </tr>`;
        }).join('');

        mount(`
          <div class="mb-2 flex items-center justify-between">
            <h2 class="font-semibold text-indigo-700">Installment Breakdown — ${fullName} (${student.admissionNumber || ''})</h2>
            <div class="text-xs">
              <span class="mr-3">Plan: <strong>${student.paymentPlan || ''}</strong></span>
              <span class="mr-3">Class: <strong>${student.classLevel || ''}</strong></span>
              <span>Year: <strong>${student.academicYear || ''}</strong></span>
            </div>
          </div>

          <div class="mb-3 flex items-center justify-between text-xs">
            <div>
              <span class="mr-3">Expected: <strong>${fmt(totalsExp)}</strong></span>
              <span class="mr-3">Paid (total): <strong>${fmt(totalPaid)}</strong></span>
              <span class="mr-3">Allocated: <strong>${fmt(totalsPaid)}</strong></span>
              <span class="mr-3">Remaining: <strong>${fmt(rem)}</strong></span>
            </div>
            <div>
              <span class="mr-3">Debt till now: <strong>${fmt(debtTillNow)}</strong></span>
              <span>Credit: <strong>${fmt(credit)}</strong></span>
            </div>
          </div>

          <div class="overflow-auto border rounded">
            <table class="min-w-full text-xs">
              <thead>
                <tr class="table-header">
                  <th class="p-1 border">Period</th>
                  <th class="p-1 border">Expected</th>
                  <th class="p-1 border">Allocated Paid</th>
                  <th class="p-1 border">Remaining</th>
                  <th class="p-1 border">Status</th>
                  <th class="p-1 border">Window</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `);
      }

      // ---- load student and render ----
      const studentId = new URL(location.href).searchParams.get('student');
      window.__STUDENT_ID__ = studentId;
      if (!studentId) { err('Error: No student ID provided in URL.'); return; }
      db.ref(`students/${studentId}`).once('value')
        .then(snap => {
          const student = snap.val();
          if (!student) { err('Student not found.'); return; }
          render(student);
        })
        .catch(e => { console.error(e); err('Error loading student data.'); });

      // resize again after fonts/images settle
      window.addEventListener('load', () => {
        const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        try { window.parent.postMessage({ type:'resizeIframe', id: window.__STUDENT_ID__, height: h }, '*'); } catch {}
      });
    })();
  </script>
</body>
</html>
