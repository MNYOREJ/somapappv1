<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payments & Installments Management</title>

  <!-- Tailwind (for quick glassmorphism) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    /* subtle glass */
    .glass {
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
    }
    .glass-dark {
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.08);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-indigo-900 to-purple-900 text-slate-100">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="glass-dark rounded-2xl p-5 mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-xl font-semibold">üí≥ Payments & Installments Management</h1>
        <p class="text-xs text-slate-300">Manage class fees, installment templates, and per-student overrides per academic year.</p>
      </div>
      <!-- Year selector -->
      <div id="somapYearWrap" class="flex gap-2 items-center">
        <label class="text-xs font-semibold">Academic Year</label>
        <select data-somap-year-select class="text-slate-100 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm"></select>
        <span class="text-xs text-slate-300">Working year: <b id="somapYearHint">--</b></span>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="glass-dark rounded-2xl p-4 mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex gap-2 items-center">
        <input id="searchClass" type="text" placeholder="Search class..." class="w-56 text-sm bg-slate-800 border border-slate-700 rounded px-3 py-2 placeholder-slate-500" />
        <button id="btnImportAllYears" class="text-xs bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded shadow">üöÄ Import All Years</button>
        <button id="btnImportThisYear" class="text-xs bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded shadow">üì¶ Import This Year</button>
      </div>
      <div class="flex gap-2">
        <button id="btnAddClass" class="text-xs bg-fuchsia-600 hover:bg-fuchsia-500 px-3 py-2 rounded shadow">+ Add Class Pricing</button>
      </div>
    </div>

    <!-- Content layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Class pricing cards -->
      <div class="lg:col-span-2">
        <div id="classesWrap" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        <div id="emptyState" class="hidden glass-dark rounded-xl p-6 text-center text-sm text-slate-300">
          No fee structure found for this year. Use Import or + Add Class Pricing to begin.
        </div>
      </div>

      <!-- Right: Per-student overrides -->
      <div class="glass-dark rounded-2xl p-4">
        <div class="mb-3 flex items-center justify-between">
          <h2 class="font-semibold text-sm">Per-Student Overrides</h2>
          <button id="btnClearStudent" class="text-xs text-slate-300 hover:text-white">Clear</button>
        </div>
        <div class="mb-3 flex gap-2">
          <input id="studentQuery" type="text" placeholder="Search admission/name..." class="flex-1 text-sm bg-slate-800 border border-slate-700 rounded px-3 py-2 placeholder-slate-500" />
          <button id="btnFindStudent" class="text-xs bg-sky-600 hover:bg-sky-500 px-3 py-2 rounded">Find</button>
        </div>
        <div id="studentPanel" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <!-- Simple modal root -->
  <div id="modalRoot" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative glass-dark rounded-2xl p-5 w-full max-w-lg shadow-xl"></div>
  </div>

  <script>
    /** Year range + anchor **/
    const SOMAP_ALLOWED_YEARS = Array.from({length: 20}, (_,i)=>2023+i); // 2023..2042
    const SOMAP_DEFAULT_YEAR = 2025;
    /** Tanzania class ladder (no Class 8). Keep labels EXACTLY. */
    const CLASS_ORDER = ['Baby Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
    const L = s => String(s||'').trim().toLowerCase();
    function shiftClass(baseClass, deltaYears){
      const i = CLASS_ORDER.findIndex(c => L(c)===L(baseClass));
      if (i<0) return baseClass||'';
      const j = i + Number(deltaYears||0);
      if (j < 0) return 'PRE-ADMISSION';
      if (j >= CLASS_ORDER.length) return 'GRADUATED';
      return CLASS_ORDER[j];
    }

    /** Reuse shared year context if present, else create a light fallback. */
    window.somapYearContext = window.somapYearContext || (function(){
      let selected = (sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR)+'';
      const listeners = new Set();
      return {
        getSelectedYear(){ return selected; },
        setSelectedYear(y){
          y = String(y);
          if (selected===y) return;
          selected = y;
          try{ sessionStorage.setItem('somap_selected_year', y); }catch{}
          listeners.forEach(fn=>{ try{ fn(y); }catch{} });
        },
        onYearChanged(fn){ if (typeof fn==='function') listeners.add(fn); }
      };
    })();

    (function initYearSelector(){
      const sel = document.querySelector('[data-somap-year-select]');
      const hint = document.getElementById('somapYearHint');
      if (!sel) return;
      sel.innerHTML = SOMAP_ALLOWED_YEARS.map(y=>`<option value="${y}">${y}</option>`).join('');
      const current = window.somapYearContext.getSelectedYear();
      sel.value = current; if (hint) hint.textContent = current;
      sel.addEventListener('change', e=>{
        const y = String(e.target.value);
        window.somapYearContext.setSelectedYear(y);
        if (hint) hint.textContent = y;
      });
    })();

    // Firebase init (standalone to avoid external deps)
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };
    try { if (!firebase?.apps?.length) firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
    const db = (()=>{ try { return firebase.database(); } catch { return null; } })();
    if (!db) console.error('DB not initialized; ensure internet connection.');

    // Helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt = n => (Number(n)||0).toLocaleString();
    const now = () => Date.now();
    function openModal(html){
      const root = document.getElementById('modalRoot');
      const box = root.querySelector('div.relative');
      box.innerHTML = html;
      root.classList.remove('hidden');
      root.classList.add('flex');
    }
    function closeModal(){
      const root = document.getElementById('modalRoot');
      root.classList.add('hidden');
      root.classList.remove('flex');
      const box = root.querySelector('div.relative');
      box.innerHTML = '';
    }
    document.getElementById('modalRoot').addEventListener('click', (e)=>{
      if (e.target.id==='modalRoot') closeModal();
    });

    function writer(path, payload){
      return db.ref(path).set(payload);
    }
    function updater(path, payload){
      return db.ref(path).update(payload);
    }
    function p(path){ return db.ref(path).once('value').then(s=>s.val()); }
    function histPath(y, type, id){ return `paymentEditHistory/${y}/${type}/${id}`; }
    async function writeHistory(y, type, id, action, before, after){
      const hId = db.ref().push().key;
      const rec = { action, before: before||null, after: after||null, at: now(), by: (window.currentUserId||'admin') };
      await writer(`${histPath(y,type,id)}/${hId}`, rec);
    }

    // Load and render class cards
    async function loadYearFees(y){
      const data = await p(`feesStructure/${y}`) || {};
      return data;
    }

    function renderInstallmentCard(y, className, instId, inst){
      const activeBadge = inst?.active===false ? '<span class="text-rose-300 text-[10px] border border-rose-400/30 px-2 py-0.5 rounded-full">Inactive</span>' : '<span class="text-emerald-300 text-[10px] border border-emerald-400/30 px-2 py-0.5 rounded-full">Active</span>';
      const label = inst?.label || instId;
      const amount = Number(inst?.amount||0);
      const win = inst?.window ? `${inst.window.from?.join('/')} - ${inst.window.to?.join('/')}` : '';
      return `
        <div class="glass-dark rounded-xl p-3 text-xs space-y-2">
          <div class="flex items-center justify-between">
            <div class="font-semibold">${label}</div>
            <div class="flex gap-2 items-center">${activeBadge}
              <button class="text-sky-300 hover:text-white" data-action="inst-history" data-class="${className}" data-id="${instId}"><i class="fa-regular fa-clock"></i></button>
              <button class="text-amber-300 hover:text-white" data-action="inst-edit" data-class="${className}" data-id="${instId}"><i class="fa-solid fa-pen"></i></button>
              <button class="text-rose-300 hover:text-white" data-action="inst-deactivate" data-class="${className}" data-id="${instId}"><i class="fa-solid fa-ban"></i></button>
              <button class="text-rose-400 hover:text-white" data-action="inst-delete" data-class="${className}" data-id="${instId}"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
          <div class="flex flex-wrap gap-3 text-slate-300">
            <div>Amount: <b class="text-slate-100">TSh ${fmt(amount)}</b></div>
            <div>${win}</div>
          </div>
        </div>`;
    }

    function renderClassCard(y, className, rec){
      const fee = Number(rec?.feePerYear||0);
      const plan = rec?.defaultPlan || '6-instalments';
      const isActive = rec?.active!==false;
      const badge = isActive ? '<span class="text-emerald-300 text-[10px] border border-emerald-400/30 px-2 py-0.5 rounded-full">Active</span>' : '<span class="text-rose-300 text-[10px] border border-rose-400/30 px-2 py-0.5 rounded-full">Inactive</span>';
      const insts = Object.entries(rec?.installments||{});
      const instCards = insts.length ? insts.map(([id,inst])=>renderInstallmentCard(y,className,id,inst)).join('') : '<div class="text-xs text-slate-300">No installments. Add one.</div>';
      return `
        <div class="glass-dark rounded-2xl p-4 space-y-3" data-class-card="${className}">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold">${className}</div>
              <div class="text-[11px] text-slate-300">Year ${y} ‚Ä¢ Plan: <b class="text-slate-100">${plan}</b></div>
            </div>
            <div class="flex gap-2 items-center">${badge}
              <button class="text-sky-300 hover:text-white" data-action="class-history" data-class="${className}"><i class="fa-regular fa-clock"></i></button>
              <button class="text-amber-300 hover:text-white" data-action="class-edit" data-class="${className}"><i class="fa-solid fa-pen"></i></button>
              <button class="text-rose-300 hover:text-white" data-action="class-deactivate" data-class="${className}"><i class="fa-solid fa-ban"></i></button>
              <button class="text-rose-400 hover:text-white" data-action="class-delete" data-class="${className}"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
          <div class="flex flex-wrap gap-4 text-xs text-slate-300">
            <div>Fee (year): <b class="text-slate-100">TSh ${fmt(fee)}</b></div>
            <div>Installments: <b class="text-slate-100">${insts.length}</b></div>
          </div>
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-[12px] text-slate-300">Installments</div>
              <button class="text-xs bg-sky-600 hover:bg-sky-500 px-2 py-1 rounded" data-action="inst-add" data-class="${className}">+ Add Installment</button>
            </div>
            <div class="grid grid-cols-1 gap-2">${instCards}</div>
          </div>
        </div>`;
    }

    function renderEmpty(show){
      const empty = document.getElementById('emptyState');
      empty.classList.toggle('hidden', !show);
    }

    async function renderClasses(){
      const y = String(window.somapYearContext.getSelectedYear());
      const wrap = document.getElementById('classesWrap');
      wrap.innerHTML = '<div class="text-sm text-slate-300">Loading...</div>';
      const data = await loadYearFees(y);
      const entries = Object.entries(data||{});
      if (!entries.length){
        wrap.innerHTML = '';
        renderEmpty(true);
        return;
      }
      renderEmpty(false);
      // search filter
      const q = L(document.getElementById('searchClass').value||'');
      const filtered = q ? entries.filter(([name])=>L(name).includes(q)) : entries;
      wrap.innerHTML = filtered.map(([name, rec])=>renderClassCard(y, name, rec)).join('');
    }

    // Year change wire
    window.somapYearContext.onYearChanged(()=>{ renderClasses(); clearStudentPanel(); });

    // Toolbar actions
    document.getElementById('searchClass').addEventListener('input', ()=> renderClasses());
    document.getElementById('btnAddClass').addEventListener('click', ()=>{
      const y = String(window.somapYearContext.getSelectedYear());
      openModal(`
        <div class="space-y-3">
          <div class="text-sm font-semibold">Add Class Pricing (${y})</div>
          <div class="space-y-2 text-sm">
            <div>
              <label class="text-xs">Class Name</label>
              <select id="mClassName" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
                ${CLASS_ORDER.map(c=>`<option>${c}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="text-xs">Fee per Year (TSh)</label>
              <input id="mFee" type="number" min="0" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
            </div>
            <div>
              <label class="text-xs">Default Plan</label>
              <select id="mPlan" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
                <option>6-instalments</option>
                <option>4-instalments</option>
                <option>monthly</option>
                <option>2inst</option>
                <option>full</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end gap-2 text-xs">
            <button class="px-3 py-2" onclick="(${closeModal.toString()})();">Cancel</button>
            <button id="mSave" class="bg-fuchsia-600 hover:bg-fuchsia-500 px-3 py-2 rounded">Save</button>
          </div>
        </div>`);
      document.getElementById('mSave').addEventListener('click', async ()=>{
        const name = document.getElementById('mClassName').value;
        const fee = Math.max(0, Number(document.getElementById('mFee').value||0));
        const plan = document.getElementById('mPlan').value;
        const before = await p(`feesStructure/${y}/${name}`) || null;
        const rec = { feePerYear: fee, defaultPlan: plan, active: true, updatedAt: now(), updatedBy: (window.currentUserId||'admin') };
        await updater(`feesStructure/${y}/${name}`, rec);
        await writeHistory(y, 'class', name, before ? 'update' : 'create', before, rec);
        closeModal();
        renderClasses();
      });
    });

    // Import buttons (skeleton)
    document.getElementById('btnImportAllYears').addEventListener('click', ()=>{
      openModal(`<div class="space-y-3 text-sm">
        <div class="font-semibold">Import All Years (skeleton)</div>
        <div>Feature stub. We will add options to copy structures from previous years.</div>
        <div class="flex justify-end"><button class="bg-slate-700 px-3 py-2 rounded" onclick="(${closeModal.toString()})();">Close</button></div>
      </div>`);
    });
    document.getElementById('btnImportThisYear').addEventListener('click', ()=>{
      openModal(`<div class="space-y-3 text-sm">
        <div class="font-semibold">Import This Year (skeleton)</div>
        <div>Feature stub. Copy from previous year with structure/amount options.</div>
        <div class="flex justify-end"><button class="bg-slate-700 px-3 py-2 rounded" onclick="(${closeModal.toString()})();">Close</button></div>
      </div>`);
    });

    // Delegated actions for class/inst controls
    document.addEventListener('click', async (e)=>{
      const a = e.target.closest('[data-action]'); if (!a) return;
      const y = String(window.somapYearContext.getSelectedYear());
      const act = a.getAttribute('data-action');
      const className = a.getAttribute('data-class');
      const instId = a.getAttribute('data-id');

      if (act==='class-edit'){
        const before = await p(`feesStructure/${y}/${className}`) || {};
        openModal(`
          <div class="space-y-3">
            <div class="text-sm font-semibold">Edit Class (${className})</div>
            <div class="space-y-2 text-sm">
              <div>
                <label class="text-xs">Fee per Year (TSh)</label>
                <input id="mFee" type="number" min="0" value="${before.feePerYear||0}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
              <div>
                <label class="text-xs">Default Plan</label>
                <select id="mPlan" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
                  ${['6-instalments','4-instalments','monthly','2inst','full'].map(pn=>`<option ${pn===(before.defaultPlan||'6-instalments')?'selected':''}>${pn}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="flex justify-end gap-2 text-xs">
              <button class="px-3 py-2" onclick="(${closeModal.toString()})();">Cancel</button>
              <button id="mSave" class="bg-amber-600 hover:bg-amber-500 px-3 py-2 rounded">Save</button>
            </div>
          </div>`);
        document.getElementById('mSave').addEventListener('click', async ()=>{
          const fee = Math.max(0, Number(document.getElementById('mFee').value||0));
          const plan = document.getElementById('mPlan').value;
          const after = { ...before, feePerYear: fee, defaultPlan: plan, updatedAt: now(), updatedBy: (window.currentUserId||'admin') };
          await updater(`feesStructure/${y}/${className}`, after);
          await writeHistory(y, 'class', className, 'update', before, after);
          closeModal(); renderClasses();
        });
      }

      if (act==='class-deactivate'){
        const before = await p(`feesStructure/${y}/${className}`) || {};
        const after = { ...before, active: false, updatedAt: now(), updatedBy: (window.currentUserId||'admin') };
        await updater(`feesStructure/${y}/${className}`, after);
        await writeHistory(y, 'class', className, 'deactivate', before, after);
        renderClasses();
      }

      if (act==='class-delete'){
        const before = await p(`feesStructure/${y}/${className}`) || {};
        if (!confirm('Delete this class pricing?')) return;
        await writer(`feesStructure/${y}/${className}`, null);
        await writeHistory(y, 'class', className, 'delete', before, null);
        renderClasses();
      }

      if (act==='class-history'){
        const hist = await p(histPath(y,'class',className)) || {};
        const items = Object.values(hist).sort((a,b)=>a.at-b.at).map(h=>`<li class="py-1">${new Date(h.at).toLocaleString()} ‚Äî ${h.action}</li>`).join('') || '<li class="py-1 text-slate-400">No history.</li>';
        openModal(`<div class="space-y-3 text-sm"><div class="font-semibold">History ‚Äî ${className}</div><ul>${items}</ul><div class="flex justify-end"><button class="bg-slate-700 px-3 py-2 rounded" onclick="(${closeModal.toString()})();">Close</button></div></div>`);
      }

      if (act==='inst-add'){
        openModal(`
          <div class="space-y-3">
            <div class="text-sm font-semibold">Add Installment (${className})</div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="col-span-2">
                <label class="text-xs">Label</label>
                <input id="iLabel" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
              <div>
                <label class="text-xs">Amount (TSh)</label>
                <input id="iAmount" type="number" min="0" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
              <div>
                <label class="text-xs">Active</label>
                <select id="iActive" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2"><option value="true">true</option><option value="false">false</option></select>
              </div>
              <div>
                <label class="text-xs">From (m,d)</label>
                <input id="iFrom" placeholder="12,1" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
              <div>
                <label class="text-xs">To (m,d)</label>
                <input id="iTo" placeholder="1,10" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
            </div>
            <div class="flex justify-end gap-2 text-xs">
              <button class="px-3 py-2" onclick="(${closeModal.toString()})();">Cancel</button>
              <button id="iSave" class="bg-sky-600 hover:bg-sky-500 px-3 py-2 rounded">Save</button>
            </div>
          </div>`);
        document.getElementById('iSave').addEventListener('click', async ()=>{
          const label = document.getElementById('iLabel').value.trim();
          const amount = Math.max(0, Number(document.getElementById('iAmount').value||0));
          const active = document.getElementById('iActive').value==='true';
          const from = (document.getElementById('iFrom').value||'').split(',').map(s=>Number(s.trim()));
          const to = (document.getElementById('iTo').value||'').split(',').map(s=>Number(s.trim()));
          const id = db.ref().push().key;
          const before = null;
          const inst = { label, amount, active, window: { from, to }, createdAt: now(), createdBy: (window.currentUserId||'admin') };
          await updater(`feesStructure/${y}/${className}/installments/${id}`, inst);
          await writeHistory(y, 'installment', `${className}::${id}`, 'create', before, inst);
          closeModal(); renderClasses();
        });
      }

      if (act==='inst-edit'){
        const before = await p(`feesStructure/${y}/${className}/installments/${instId}`) || {};
        openModal(`
          <div class="space-y-3">
            <div class="text-sm font-semibold">Edit Installment (${className})</div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="col-span-2">
                <label class="text-xs">Label</label>
                <input id="iLabel" value="${before.label||''}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
              <div>
                <label class="text-xs">Amount (TSh)</label>
                <input id="iAmount" type="number" min="0" value="${before.amount||0}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
              <div>
                <label class="text-xs">Active</label>
                <select id="iActive" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
                  <option value="true" ${before.active!==false?'selected':''}>true</option>
                  <option value="false" ${before.active===false?'selected':''}>false</option>
                </select>
              </div>
              <div>
                <label class="text-xs">From (m,d)</label>
                <input id="iFrom" value="${(before.window?.from||[]).join(',')}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
              <div>
                <label class="text-xs">To (m,d)</label>
                <input id="iTo" value="${(before.window?.to||[]).join(',')}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
            </div>
            <div class="flex justify-end gap-2 text-xs">
              <button class="px-3 py-2" onclick="(${closeModal.toString()})();">Cancel</button>
              <button id="iSave" class="bg-amber-600 hover:bg-amber-500 px-3 py-2 rounded">Save</button>
            </div>
          </div>`);
        document.getElementById('iSave').addEventListener('click', async ()=>{
          const label = document.getElementById('iLabel').value.trim();
          const amount = Math.max(0, Number(document.getElementById('iAmount').value||0));
          const active = document.getElementById('iActive').value==='true';
          const from = (document.getElementById('iFrom').value||'').split(',').map(s=>Number(s.trim()));
          const to = (document.getElementById('iTo').value||'').split(',').map(s=>Number(s.trim()));
          const after = { ...before, label, amount, active, window: { from, to }, updatedAt: now(), updatedBy: (window.currentUserId||'admin') };
          await updater(`feesStructure/${y}/${className}/installments/${instId}`, after);
          await writeHistory(y, 'installment', `${className}::${instId}`, 'update', before, after);
          closeModal(); renderClasses();
        });
      }

      if (act==='inst-deactivate'){
        const before = await p(`feesStructure/${y}/${className}/installments/${instId}`) || {};
        const after = { ...before, active: false, updatedAt: now(), updatedBy: (window.currentUserId||'admin') };
        await updater(`feesStructure/${y}/${className}/installments/${instId}`, after);
        await writeHistory(y, 'installment', `${className}::${instId}`, 'deactivate', before, after);
        renderClasses();
      }

      if (act==='inst-delete'){
        const before = await p(`feesStructure/${y}/${className}/installments/${instId}`) || {};
        if (!confirm('Delete this installment?')) return;
        await writer(`feesStructure/${y}/${className}/installments/${instId}`, null);
        await writeHistory(y, 'installment', `${className}::${instId}`, 'delete', before, null);
        renderClasses();
      }

      if (act==='inst-history'){
        const hist = await p(histPath(y,'installment',`${className}::${instId}`)) || {};
        const items = Object.values(hist).sort((a,b)=>a.at-b.at).map(h=>`<li class=\"py-1\">${new Date(h.at).toLocaleString()} ‚Äî ${h.action}</li>`).join('') || '<li class="py-1 text-slate-400">No history.</li>';
        openModal(`<div class="space-y-3 text-sm"><div class="font-semibold">History ‚Äî ${className}/${instId}</div><ul>${items}</ul><div class="flex justify-end"><button class="bg-slate-700 px-3 py-2 rounded" onclick="(${closeModal.toString()})();">Close</button></div></div>`);
      }
    });

    // Student overrides (skeleton)
    async function findStudentByQuery(q){
      q = L(q);
      const students = await p('students') || {};
      const id = Object.keys(students).find(k=>{
        const s = students[k]||{};
        const name = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.trim();
        return L(s.admissionNumber||k)===q || L(name).includes(q);
      });
      return id || null;
    }
    function clearStudentPanel(){ document.getElementById('studentPanel').innerHTML = '<div class="text-xs text-slate-300">No student selected.</div>'; }
    async function renderStudentPanel(studentId){
      const y = String(window.somapYearContext.getSelectedYear());
      if (!studentId){ clearStudentPanel(); return; }
      const [S, anchor, overlay, override] = await Promise.all([
        p(`students/${studentId}`),
        p(`enrollments/${SOMAP_DEFAULT_YEAR}/${studentId}`),
        p(`enrollments/${y}/${studentId}`),
        p(`studentFees/${y}/${studentId}`)
      ]);
      if (!S){ document.getElementById('studentPanel').innerHTML = '<div class="text-xs text-rose-300">Student not found.</div>'; return; }
      const baseClass = (overlay?.className||overlay?.classLevel) || (anchor?.className||anchor?.classLevel) || S.classLevel || '';
      const displayClass = shiftClass(baseClass, Number(y)-SOMAP_DEFAULT_YEAR);
      const identity = `${S.firstName||''} ${S.middleName||''} ${S.lastName||''}`.replace(/\s+/g,' ').trim();
      const feeOverride = Number(override?.feePerYear||0);
      const planOverride = override?.planName || '';
      const insts = Object.entries(override?.installments||{});
      const instHtml = insts.length? insts.map(([id,it])=>`<li class="flex justify-between py-1"><span>${it.label||id}</span><span>TSh ${fmt(it.amount||0)}</span></li>`).join('') : '<li class="py-1 text-slate-400">No overrides.</li>';
      document.getElementById('studentPanel').innerHTML = `
        <div class="glass-dark rounded-xl p-3">
          <div class="text-sm font-semibold">${identity} <span class="text-[10px] ml-2 border border-slate-600 rounded-full px-2">${S.admissionNumber||studentId}</span></div>
          <div class="text-[12px] text-slate-300">Class ${displayClass} ‚Ä¢ Year ${y}</div>
          <div class="mt-3 space-y-2 text-xs">
            <div>Fee override: <b class="text-slate-100">TSh ${fmt(feeOverride)}</b></div>
            <div>Plan override: <b class="text-slate-100">${planOverride||'‚Äî'}</b></div>
            <div class="flex items-center justify-between">
              <div>Installment overrides</div>
              <div class="flex gap-2">
                <button id="btnEditStudentFee" class="text-xs bg-amber-600 hover:bg-amber-500 px-2 py-1 rounded">‚úèÔ∏è Edit</button>
                <button id="btnAddStudInst" class="text-xs bg-sky-600 hover:bg-sky-500 px-2 py-1 rounded">+ Add</button>
              </div>
            </div>
            <ul>${instHtml}</ul>
          </div>
        </div>`;

      document.getElementById('btnEditStudentFee').addEventListener('click', ()=>{
        openModal(`
          <div class="space-y-3">
            <div class="text-sm font-semibold">Edit Student Override</div>
            <div class="space-y-2 text-sm">
              <div>
                <label class="text-xs">Fee per Year (TSh)</label>
                <input id="sFee" type="number" min="0" value="${feeOverride||0}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
              <div>
                <label class="text-xs">Plan Name</label>
                <input id="sPlan" value="${planOverride||''}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
            </div>
            <div class="flex justify-end gap-2 text-xs">
              <button class="px-3 py-2" onclick="(${closeModal.toString()})();">Cancel</button>
              <button id="sSave" class="bg-amber-600 hover:bg-amber-500 px-3 py-2 rounded">Save</button>
            </div>
          </div>`);
        document.getElementById('sSave').addEventListener('click', async ()=>{
          const fee = Math.max(0, Number(document.getElementById('sFee').value||0));
          const plan = String(document.getElementById('sPlan').value||'');
          const before = override || null;
          const after = { ...(before||{}), feePerYear: fee, planName: plan, updatedAt: now(), updatedBy: (window.currentUserId||'admin') };
          await updater(`studentFees/${y}/${studentId}`, after);
          await writeHistory(y, 'studentOverride', studentId, before ? 'update' : 'create', before, after);
          closeModal(); renderStudentPanel(studentId);
        });
      });

      document.getElementById('btnAddStudInst').addEventListener('click', ()=>{
        openModal(`
          <div class="space-y-3">
            <div class="text-sm font-semibold">Add Student Installment</div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="col-span-2">
                <label class="text-xs">Label</label>
                <input id="stLabel" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
              <div>
                <label class="text-xs">Amount (TSh)</label>
                <input id="stAmount" type="number" min="0" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2" />
              </div>
              <div>
                <label class="text-xs">Active</label>
                <select id="stActive" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2"><option value="true">true</option><option value="false">false</option></select>
              </div>
            </div>
            <div class="flex justify-end gap-2 text-xs">
              <button class="px-3 py-2" onclick="(${closeModal.toString()})();">Cancel</button>
              <button id="stSave" class="bg-sky-600 hover:bg-sky-500 px-3 py-2 rounded">Save</button>
            </div>
          </div>`);
        document.getElementById('stSave').addEventListener('click', async ()=>{
          const id = db.ref().push().key;
          const label = document.getElementById('stLabel').value.trim();
          const amount = Math.max(0, Number(document.getElementById('stAmount').value||0));
          const active = document.getElementById('stActive').value==='true';
          const inst = { label, amount, active, createdAt: now(), createdBy: (window.currentUserId||'admin') };
          const before = override || null;
          await updater(`studentFees/${y}/${studentId}/installments/${id}`, inst);
          await writeHistory(y, 'studentOverride', `${studentId}::${id}`, 'create', before, inst);
          closeModal(); renderStudentPanel(studentId);
        });
      });
    }

    document.getElementById('btnFindStudent').addEventListener('click', async ()=>{
      const q = document.getElementById('studentQuery').value;
      const id = await findStudentByQuery(q);
      renderStudentPanel(id);
    });
    document.getElementById('btnClearStudent').addEventListener('click', ()=>{
      document.getElementById('studentQuery').value='';
      clearStudentPanel();
    });

    // Boot
    document.addEventListener('DOMContentLoaded', ()=>{
      renderClasses();
      clearStudentPanel();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payments Config ‚Äî Plans, Class Fees & Overrides</title>
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <!-- Firebase (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    .card { @apply bg-white rounded-2xl shadow border border-slate-200 p-4; }
    .chip { @apply inline-block text-xs px-2 py-0.5 rounded-full border; }
    .btn { @apply inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border text-sm font-medium; }
    .btn-primary { @apply bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-700; }
    .btn-ghost { @apply border-slate-200 hover:bg-slate-50; }
    .btn-danger { @apply bg-rose-600 text-white border-rose-600 hover:bg-rose-700; }
    .input { @apply border rounded-lg px-3 py-2 text-sm w-full; }
    .label { @apply text-xs font-semibold text-slate-600; }
    .toolbar { @apply flex flex-wrap items-center gap-2; }
    .tab-btn { @apply px-3 py-1.5 rounded-lg text-sm font-medium border; }
    .tab-btn.active { @apply bg-indigo-600 text-white border-indigo-600; }
    .kbd { @apply px-1.5 py-0.5 text-xs border rounded bg-slate-50; }
    .pill { @apply px-2 py-0.5 text-[11px] font-semibold rounded-full; }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-4">

    <!-- Header / Year Selector -->
    <div class="flex items-start justify-between gap-3 mb-4">
      <div>
        <h1 class="text-xl font-semibold text-slate-800">üí≥ Payments Config</h1>
        <p class="text-slate-500 text-sm">Define instalment plans, set per-class fees & defaults, and add student overrides. All changes are scoped to the selected academic year.</p>
      </div>
      <div id="somapYearWrap" class="toolbar">
        <label class="label">Academic Year</label>
        <select data-somap-year-select class="input !w-auto"></select>
        <span class="text-xs text-slate-600">Working year: <b id="somapYearHint">--</b></span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex items-center gap-2 mb-4">
      <button class="tab-btn" data-tab="plans">Plans & Instalments</button>
      <button class="tab-btn" data-tab="classes">Class Fees & Defaults</button>
      <button class="tab-btn" data-tab="overrides">Student Overrides</button>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnRefresh" class="btn btn-ghost"><i class="fa fa-rotate"></i> Refresh</button>
        <a href="../dashboard.html" class="btn btn-ghost"><i class="fa fa-arrow-left"></i> Back to Dashboard</a>
      </div>
    </div>

    <!-- Plans Panel -->
    <section id="panel-plans" class="hidden">
      <div class="card mb-3">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="font-semibold">Plans & Instalments (<span id="plansYear"></span>)</h2>
            <p class="text-xs text-slate-500">Create reusable instalment plans (6-instalments, 4-instalments, monthly, etc). Assign them to classes or individual students.</p>
          </div>
          <div class="toolbar">
            <button id="btnAddPlan" class="btn btn-primary"><i class="fa fa-plus"></i> Add Plan</button>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3" id="plansGrid"></div>
    </section>

    <!-- Classes Panel -->
    <section id="panel-classes" class="hidden">
      <div class="card mb-3">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="font-semibold">Class Fees & Defaults (<span id="classesYear"></span>)</h2>
            <p class="text-xs text-slate-500">Set each class‚Äô feePerYear and default plan for the selected year. This does <b>not</b> change other years.</p>
          </div>
          <div class="toolbar">
            <button id="btnImportFromPrev" class="btn btn-ghost"><i class="fa fa-box-archive"></i> Import from previous year</button>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3" id="classesGrid"></div>
    </section>

    <!-- Overrides Panel -->
    <section id="panel-overrides" class="hidden">
      <div class="card mb-3">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="font-semibold">Student Overrides (<span id="overridesYear"></span>)</h2>
            <p class="text-xs text-slate-500">Search a student, then override their <b>feePerYear</b>, select a different plan, or assign a <b>custom schedule</b> (e.g., TSh 10,000 weekly).</p>
          </div>
          <div class="toolbar">
            <input id="studentSearch" class="input" placeholder="Search by name or admission no..." />
          </div>
        </div>
      </div>

      <div id="studentResults" class="grid md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-3 right-3 hidden">
      <div class="bg-slate-900 text-white px-3 py-2 rounded-lg shadow text-sm" id="toastMsg"></div>
    </div>
  </div>

  <script>
    /*********************
     * 1) Year context
     *********************/
    const SOMAP_ALLOWED_YEARS = Array.from({length: 20}, (_,i)=>2023+i);
    const SOMAP_DEFAULT_YEAR = 2025;
    const CLASS_ORDER = ['Baby Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
    const L = s => String(s||'').trim().toLowerCase();

    window.somapYearContext = window.somapYearContext || (function(){
      let selected = (sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR)+'';
      const listeners = new Set();
      return {
        getSelectedYear(){ return selected; },
        setSelectedYear(y){
          y = String(y);
          if (selected===y) return;
          selected = y;
          try{ sessionStorage.setItem('somap_selected_year', y); }catch{}
          listeners.forEach(fn=>{ try{ fn(y); }catch{} });
        },
        onYearChanged(fn){ if (typeof fn==='function') listeners.add(fn); }
      };
    })();

    (function initYearSelector(){
      const sel = document.querySelector('[data-somap-year-select]');
      const hint = document.getElementById('somapYearHint');
      sel.innerHTML = SOMAP_ALLOWED_YEARS.map(y=>`<option value="${y}">${y}</option>`).join('');
      const current = window.somapYearContext.getSelectedYear();
      sel.value = current; if (hint) hint.textContent = current;
      sel.addEventListener('change', e=>{
        const y = String(e.target.value);
        window.somapYearContext.setSelectedYear(y);
        if (hint) hint.textContent = y;
      });
    })();

    /*********************
     * 2) Firebase init
     *********************/
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };
    try { if (!firebase?.apps?.length) firebase.initializeApp(firebaseConfig); } catch(e){ console.error(e); }
    const db = (()=>{ try { return firebase.database(); } catch { return null; }})();
    if (!db) alert('Firebase DB failed to initialize.');

    /*********************
     * 3) RTDB paths (by year)
     *********************/
    function pathPlans(y){ return `installmentPlans/${y}`; }
    function pathFees(y){ return `feesStructure/${y}`; }              // { [className]: { feePerYear, defaultPlanId } }
    function pathStudentOverrides(y){ return `studentOverrides/${y}`; } // { [studentId]: { feePerYear?, planId?, customSchedule? } }
    function pathConfigHistory(y){ return `financeConfigHistory/${y}`; }

    /*********************
     * 4) Utils
     *********************/
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const money = n => (Number(n)||0).toLocaleString();
    const toast = (msg) => {
      const t = $('#toast'); const m = $('#toastMsg');
      m.textContent = msg; t.classList.remove('hidden');
      setTimeout(()=> t.classList.add('hidden'), 1800);
    };

    function uid(prefix='id'){ return `${prefix}-${Math.random().toString(36).slice(2,9)}`; }

    function today(){ const d = new Date(); const m = String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; }

    /*********************
     * 5) Tabs
     *********************/
    const tabs = ['plans','classes','overrides'];
    function activateTab(key){
      tabs.forEach(t => {
        const btn = document.querySelector(`.tab-btn[data-tab="${t}"]`);
        const panel = document.getElementById(`panel-${t}`);
        if (t===key){ btn.classList.add('active'); panel.classList.remove('hidden'); }
        else { btn.classList.remove('active'); panel.classList.add('hidden'); }
      });
    }
    $$('.tab-btn').forEach(b=> b.addEventListener('click', ()=> activateTab(b.dataset.tab)));

    /*********************
     * 6) Plans ‚Äî CRUD
     *********************/
    async function fetchPlans(y){
      const snap = await db.ref(pathPlans(y)).once('value');
      return snap.val() || {};
    }

    async function savePlan(y, planId, data){
      const path = `${pathPlans(y)}/${planId}`;
      const beforeSnap = await db.ref(path).once('value');
      const before = beforeSnap.val();
      await db.ref(path).set(data);
      // history
      const hist = {
        at: Date.now(),
        by: 'unknown', // TODO: wire to auth.email if available
        action: before ? 'update' : 'create',
        before: before || null,
        after: data
      };
      await db.ref(`${pathConfigHistory(y)}/plans/${planId}`).push(hist);
    }

    async function deactivatePlan(y, planId, isActive){
      const path = `${pathPlans(y)}/${planId}/isActive`;
      await db.ref(path).set(isActive);
      await db.ref(`${pathConfigHistory(y)}/plans/${planId}`).push({ at: Date.now(), by: 'unknown', action: isActive?'activate':'deactivate' });
    }

    function planCard(planId, P){
      const labels = (P.schedule||[]).map(s=>s.label).join(' ¬∑ ');
      const status = P.isActive!==false ? '<span class="pill bg-emerald-100 text-emerald-700 border-emerald-200">Active</span>' : '<span class="pill bg-rose-100 text-rose-700 border-rose-200">Inactive</span>';
      return `
        <div class="card" data-plan="${planId}">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="flex items-center gap-2">
                <h3 class="font-semibold">${P.name||'Unnamed plan'}</h3>
                ${status}
              </div>
              <div class="text-xs text-slate-500">${P.description||''}</div>
              <div class="mt-1 text-xs"><span class="chip border-slate-200">${(P.appliesTo||[]).length} classes</span> <span class="chip border-slate-200">${(P.schedule||[]).length} instalments</span></div>
              <div class="mt-2 text-xs text-slate-600">${labels}</div>
            </div>
            <div class="toolbar">
              <button class="btn btn-ghost" data-act="edit"><i class="fa fa-pen"></i> Edit</button>
              <button class="btn btn-ghost" data-act="history"><i class="fa fa-scroll"></i> History</button>
              ${P.isActive!==false ? `<button class="btn btn-danger" data-act="deactivate"><i class="fa fa-ban"></i> Deactivate</button>` : `<button class="btn btn-primary" data-act="activate"><i class="fa fa-check"></i> Activate</button>`}
            </div>
          </div>
        </div>`;
    }

    async function renderPlans(){
      const y = String(window.somapYearContext.getSelectedYear());
      $('#plansYear').textContent = y;
      const grid = $('#plansGrid'); grid.innerHTML = '<div class="text-sm text-slate-500">Loading plans...</div>';
      const plans = await fetchPlans(y);
      const ids = Object.keys(plans);
      grid.innerHTML = ids.length ? ids.map(id => planCard(id, plans[id])).join('') : '<div class="text-sm text-slate-500">No plans yet for this year.</div>';
      // wire actions
      $$('#plansGrid [data-plan]').forEach(card => {
        const id = card.getAttribute('data-plan');
        card.querySelector('[data-act="edit"]').addEventListener('click', ()=> openPlanEditor(id, plans[id]));
        card.querySelector('[data-act="history"]').addEventListener('click', ()=> openPlanHistory(id));
        const deact = card.querySelector('[data-act="deactivate"]');
        const act = card.querySelector('[data-act="activate"]');
        if (deact) deact.addEventListener('click', async ()=>{ await deactivatePlan(y, id, false); toast('Plan deactivated'); renderPlans(); });
        if (act) act.addEventListener('click', async ()=>{ await deactivatePlan(y, id, true); toast('Plan activated'); renderPlans(); });
      });
    }

    function openPlanEditor(planId=null, P={}){
      const y = String(window.somapYearContext.getSelectedYear());
      // Minimal modal via prompt() to keep file compact. You can replace with a proper dialog later.
      const name = prompt('Plan name (e.g., 6-instalments monthly):', P.name || '6-instalments');
      if (name==null) return;
      // Schedule editor: CSV lines "label|from|to|weight"; dates in MM-DD (year inferred)
      const existing = (P.schedule||[]).map(s => `${s.label}|${s.from||''}|${s.to||''}|${s.weight||1}`).join('\n');
      const help = 'Enter instalments, one per line as: LABEL|MM-DD|MM-DD|WEIGHT\nExample:\nInst 1|12-01|01-10|44\nInst 2|03-01|03-15|13';
      const lines = prompt(help, existing || 'Inst 1|12-01|01-10|44\nInst 2|03-01|03-15|13\nInst 3|04-01|04-15|12\nInst 4|05-01|05-15|22\nInst 5|07-01|07-15|22\nInst 6|09-01|09-15|16');
      if (lines==null) return;
      const schedule = String(lines).split(/\n+/).map(row => {
        const [label, fromMD, toMD, weight] = row.split('|').map(s=>String(s||'').trim());
        const from = fromMD ? `${y}-${fromMD}` : '';
        const to   = toMD ? `${y}-${toMD}` : '';
        return { label: label||'Inst', from, to, weight: Number(weight)||1 };
      }).filter(x=>x.label);

      // Applies-to classes (CSV)
      const applies = prompt('Comma-separated classes this plan applies to (leave empty to assign per-class later)\nOptions: '+CLASS_ORDER.join(', '), (P.appliesTo||[]).join(', '));
      const appliesTo = String(applies||'').split(',').map(s=>s.trim()).filter(Boolean);

      const plan = {
        name,
        description: P.description || '',
        isActive: P.isActive!==false,
        appliesTo,
        schedule
      };
      const id = planId || uid('plan');
      savePlan(y, id, plan).then(()=>{ toast('Plan saved'); renderPlans(); }).catch(e=> alert('Save failed: '+e.message));
    }

    async function openPlanHistory(planId){
      const y = String(window.somapYearContext.getSelectedYear());
      const snap = await db.ref(`${pathConfigHistory(y)}/plans/${planId}`).limitToLast(25).once('value');
      const rows = Object.values(snap.val()||{}).sort((a,b)=> (a.at||0)-(b.at||0)).map(h=>{
        const d = new Date(h.at||Date.now()).toLocaleString();
        return `‚Ä¢ ${d}: ${h.action||'edit'} by ${h.by||'unknown'}`;
      }).join('\n') || 'No history.';
      alert(`History for ${planId}:\n\n${rows}`);
    }

    /*********************
     * 7) Classes ‚Äî feePerYear + defaultPlanId
     *********************/
    async function fetchClassFees(y){
      const snap = await db.ref(pathFees(y)).once('value');
      return snap.val() || {};
    }

    async function saveClassFee(y, className, data){
      const path = `${pathFees(y)}/${className}`;
      const beforeSnap = await db.ref(path).once('value');
      await db.ref(path).set(data);
      await db.ref(`${pathConfigHistory(y)}/classes/${className}`).push({ at: Date.now(), by: 'unknown', action: 'upsert', after: data, before: beforeSnap.val()||null });
    }

    function classCard(className, cfg, plans){
      const fee = money(cfg.feePerYear||0);
      const plan = cfg.defaultPlanId ? (plans[cfg.defaultPlanId]?.name || cfg.defaultPlanId) : '‚Äî';
      return `
        <div class="card" data-class="${className}">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="flex items-center gap-2">
                <h3 class="font-semibold">${className}</h3>
                <span class="chip border-slate-200">Fee: TSh ${fee}</span>
                <span class="chip border-slate-200">Default Plan: ${plan}</span>
              </div>
              <p class="text-xs text-slate-500 mt-1">Changes apply only to <b>${$('#classesYear').textContent}</b>.</p>
            </div>
            <div class="toolbar">
              <button class="btn btn-ghost" data-act="edit"><i class="fa fa-pen"></i> Edit</button>
              <button class="btn btn-ghost" data-act="history"><i class="fa fa-scroll"></i> History</button>
            </div>
          </div>
        </div>`;
    }

    async function renderClasses(){
      const y = String(window.somapYearContext.getSelectedYear());
      $('#classesYear').textContent = y;
      const grid = $('#classesGrid'); grid.innerHTML = '<div class="text-sm text-slate-500">Loading classes...</div>';
      const [plans, fees] = await Promise.all([ fetchPlans(y), fetchClassFees(y) ]);
      const classNames = CLASS_ORDER;
      grid.innerHTML = classNames.map(cn => classCard(cn, fees[cn]||{}, plans)).join('');
      // wire actions
      $$('#classesGrid [data-class]').forEach(card => {
        const cn = card.getAttribute('data-class');
        card.querySelector('[data-act="edit"]').addEventListener('click', ()=> openClassEditor(cn, fees[cn]||{}, plans));
        card.querySelector('[data-act="history"]').addEventListener('click', ()=> openClassHistory(cn));
      });
    }

    function openClassEditor(className, cfg={}, plans={}){
      const y = String(window.somapYearContext.getSelectedYear());
      const feeStr = prompt(`Fee per year for ${className} (TSh):`, cfg.feePerYear ?? '0');
      if (feeStr==null) return;
      const feePerYear = Math.max(0, Number(feeStr)||0);
      const planKeys = Object.keys(plans);
      const pick = prompt(`Default plan id for ${className}:\n\n` + planKeys.map(k=>`${k} ‚Äî ${plans[k].name}`).join('\n') + `\n\n(Leave empty to keep ${cfg.defaultPlanId||'none'})`, cfg.defaultPlanId||'');
      const defaultPlanId = String(pick||'').trim() || (cfg.defaultPlanId||'');
      saveClassFee(y, className, { feePerYear, defaultPlanId }).then(()=>{ toast('Class updated'); renderClasses(); }).catch(e=> alert('Save failed: '+e.message));
    }

    async function openClassHistory(className){
      const y = String(window.somapYearContext.getSelectedYear());
      const snap = await db.ref(`${pathConfigHistory(y)}/classes/${className}`).limitToLast(25).once('value');
      const rows = Object.values(snap.val()||{}).sort((a,b)=> (a.at||0)-(b.at||0)).map(h=>{
        const d = new Date(h.at||Date.now()).toLocaleString();
        return `‚Ä¢ ${d}: ${h.action||'edit'} by ${h.by||'unknown'} ‚Äî feePerYear: ${h.after?.feePerYear||0}, defaultPlanId: ${h.after?.defaultPlanId||'‚Äî'}`;
      }).join('\n') || 'No history.';
      alert(`History for ${className}:\n\n${rows}`);
    }

    // Import from previous year
    $('#btnImportFromPrev').addEventListener('click', async ()=>{
      const y = Number(window.somapYearContext.getSelectedYear());
      const prev = y-1; if (!confirm(`Copy fees & defaults from ${prev} ‚Üí ${y}?`)) return;
      const [prevFees, curFees] = await Promise.all([
        db.ref(pathFees(prev)).once('value').then(s=>s.val()||{}),
        db.ref(pathFees(y)).once('value').then(s=>s.val()||{})
      ]);
      const merged = { ...prevFees, ...curFees }; // do not overwrite things already set in current year
      await db.ref(pathFees(y)).set(merged);
      await db.ref(`${pathConfigHistory(y)}/imports`).push({ at: Date.now(), by: 'unknown', from: prev, target: y, type: 'feesStructure' });
      toast('Imported from previous year');
      renderClasses();
    });

    /*********************
     * 8) Student Overrides ‚Äî search + edit
     *********************/
    async function searchStudents(query){
      // Simple client-side search: load all students; in large schools, replace with server-side paging
      const snap = await db.ref('students').once('value');
      const map = snap.val()||{}; const q = L(query);
      const res = Object.entries(map).filter(([id,S])=>{
        const name = `${S.firstName||''} ${S.middleName||''} ${S.lastName||''}`.toLowerCase();
        const adm = String(S.admissionNumber||id).toLowerCase();
        return name.includes(q) || adm.includes(q);
      }).slice(0, 30);
      return res.map(([id,S])=>({ id, S }));
    }

    function studentCard(stu){
      const { id, S, yCfg } = stu;
      const nm = `${S.firstName||''} ${S.middleName||''} ${S.lastName||''}`.replace(/\s+/g,' ').trim();
      const fee = money(yCfg?.feePerYear||0);
      const plan = yCfg?.planId || '‚Äî';
      return `
        <div class="card" data-stu="${id}">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold">${nm}</div>
              <div class="text-xs text-slate-500">Adm: ${S.admissionNumber||id} ¬∑ Mother: ${S.motherPhone||S.parentPhone||'‚Äî'}</div>
              <div class="mt-1 text-xs"><span class="chip border-slate-200">Fee override: TSh ${fee}</span> <span class="chip border-slate-200">Plan: ${plan}</span></div>
            </div>
            <div class="toolbar">
              <button class="btn btn-ghost" data-act="override"><i class="fa fa-sliders"></i> Edit Override</button>
              <button class="btn btn-ghost" data-act="custom"><i class="fa fa-calendar-week"></i> Custom Schedule</button>
              <button class="btn btn-ghost" data-act="clear"><i class="fa fa-eraser"></i> Clear Override</button>
            </div>
          </div>
        </div>`;
    }

    async function fetchStudentOverride(y, studentId){
      const snap = await db.ref(`${pathStudentOverrides(y)}/${studentId}`).once('value');
      return snap.val()||{};
    }

    async function setStudentOverride(y, studentId, payload){
      const path = `${pathStudentOverrides(y)}/${studentId}`;
      const before = (await db.ref(path).once('value')).val()||null;
      await db.ref(path).update(payload);
      await db.ref(`${pathConfigHistory(y)}/studentOverrides/${studentId}`).push({ at: Date.now(), by: 'unknown', action: 'update', before, after: payload });
    }

    async function clearStudentOverride(y, studentId){
      await db.ref(`${pathStudentOverrides(y)}/${studentId}`).remove();
      await db.ref(`${pathConfigHistory(y)}/studentOverrides/${studentId}`).push({ at: Date.now(), by: 'unknown', action: 'clear' });
    }

    async function renderOverrides(query=''){
      const y = String(window.somapYearContext.getSelectedYear());
      $('#overridesYear').textContent = y;
      const container = $('#studentResults');
      if (!query){ container.innerHTML = '<div class="text-sm text-slate-500">Search a student to override.</div>'; return; }
      container.innerHTML = '<div class="text-sm text-slate-500">Searching...</div>';
      const results = await searchStudents(query);
      // attach per-student year override
      for (const r of results){ r.yCfg = await fetchStudentOverride(y, r.id); }
      container.innerHTML = results.length ? results.map(r => studentCard(r)).join('') : '<div class="text-sm text-slate-500">No results.</div>';
      // wire actions
      $$('#studentResults [data-stu]').forEach(card => {
        const id = card.getAttribute('data-stu');
        card.querySelector('[data-act="override"]').addEventListener('click', async ()=>{
          const fee = prompt('Fee override (TSh). Leave empty to keep current:', '');
          const planId = prompt('Plan ID override (optional):', '');
          const payload = {};
          if (fee!==null && fee!=='') payload.feePerYear = Math.max(0, Number(fee)||0);
          if (planId!==null && planId!=='') payload.planId = planId;
          if (!Object.keys(payload).length) return;
          await setStudentOverride(y, id, payload);
          toast('Override saved');
          renderOverrides($('#studentSearch').value);
        });
        card.querySelector('[data-act="custom"]').addEventListener('click', async ()=>{
          alert('Custom Schedule: enter lines as LABEL|YYYY-MM-DD|YYYY-MM-DD|AMOUNT');
          const lines = prompt('One per line. Example: Week 1|2026-01-07|2026-01-13|10000');
          if (lines==null) return;
          const customSchedule = String(lines).split(/\n+/).map(row=>{
            const [label, from, to, amount] = row.split('|').map(s=>String(s||'').trim());
            return { label: label||'Item', from, to, amount: Math.max(0, Number(amount)||0) };
          }).filter(x=>x.label && x.from && x.to);
          if (!customSchedule.length) return;
          await setStudentOverride(y, id, { customSchedule });
          toast('Custom schedule saved');
          renderOverrides($('#studentSearch').value);
        });
        card.querySelector('[data-act="clear"]').addEventListener('click', async ()=>{
          if (!confirm('Clear override for this year?')) return;
          await clearStudentOverride(y, id);
          toast('Override cleared');
          renderOverrides($('#studentSearch').value);
        });
      });
    }

    $('#studentSearch').addEventListener('input', (e)=>{
      const q = e.target.value.trim();
      if (q.length<2){ renderOverrides(''); return; }
      renderOverrides(q);
    });

    /*********************
     * 9) Initializers & wiring
     *********************/
    function refreshAll(){ renderPlans(); renderClasses(); renderOverrides($('#studentSearch').value||''); }
    $('#btnAddPlan').addEventListener('click', ()=> openPlanEditor());
    $('#btnRefresh').addEventListener('click', refreshAll);
    window.somapYearContext.onYearChanged(refreshAll);
    document.addEventListener('DOMContentLoaded', ()=>{ activateTab('plans'); refreshAll(); });
  </script>
</body>
</html>
