<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Academics & Exams</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Firebase compat (v9 compat libs) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>

  <!-- Your Firebase config wrapper (exports window.db, window.storage) -->
  <script src="firebase.js"></script>

  <style>
    .sticky-th th { position: sticky; top:0; background:#fff; z-index:2; }
    .scroll-shadow { box-shadow: inset 0 10px 8px -10px rgba(2,6,23,0.12); }
    #chartSubjects, #chartTop10 { max-width:100%; height:260px; display:block; }
    .bg-white.rounded-2xl.p-4 { overflow:hidden; }
    .min-w-table { min-width:1200px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1200px; height: 80vh; overflow-y: auto; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">
  <!-- Top bar -->
  <header class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="staff.html" class="px-3 py-2 rounded-lg bg-white border text-sm flex items-center gap-2">
          <span style="font-size:18px;">←</span> Back
        </a>
        <div>
          <h1 class="text-lg font-semibold">SoMAp — Academic & Exams Module</h1>
          <p class="text-xs text-slate-500">Scores • Rankings • Reports</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnOpenScoresheet" class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm flex items-center gap-2">
          <i class="fas fa-table"></i> Scoresheet
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Controls -->
    <section class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3">
      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">School Branch</label>
        <input id="schoolBranch" class="mt-1 w-full border rounded px-2 py-2 text-sm" placeholder="Socrates — Main (optional)">
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Class</label>
        <select id="classSelect" class="mt-1 w-full border rounded px-2 py-2 text-sm" disabled></select>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Stream</label>
        <input id="streamInput" class="mt-1 w-full border rounded px-2 py-2 text-sm" placeholder="A / B / Red">
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Exam Type</label>
        <select id="examType" class="mt-1 w-full border rounded px-2 py-2 text-sm">
          <option>Monthly</option>
          <option>Midterm 1</option>
          <option>End Term</option>
          <option>Midterm 2</option>
          <option>Annual</option>
        </select>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Month</label>
        <select id="monthSelect" class="mt-1 w-full border rounded px-2 py-2 text-sm">
          <option value="01">January</option><option value="02">February</option><option value="03">March</option>
          <option value="04">April</option><option value="05">May</option><option value="06">June</option>
          <option value="07">July</option><option value="08">August</option><option value="09">September</option>
          <option value="10">October</option><option value="11">November</option><option value="12">December</option>
        </select>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Academic Year</label>
        <input id="yearInput" class="mt-1 w-full border rounded px-2 py-2 text-sm" placeholder="e.g., 2025">
      </div>
    </section>

    <!-- KPI + Charts -->
    <section class="mt-6 grid lg:grid-cols-12 gap-4">
      <div class="lg:col-span-5 grid grid-cols-2 sm:grid-cols-3 gap-4">
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-blue-500">
          <p class="text-xs text-slate-500">Top Student</p>
          <h3 id="kpiTopStudent" class="text-lg font-semibold mt-1 text-blue-600">–</h3>
          <p id="kpiTopScore" class="text-xs text-slate-500">–</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-red-500">
          <p class="text-xs text-slate-500">Bottom Student</p>
          <h3 id="kpiBottomStudent" class="text-lg font-semibold mt-1 text-red-600">–</h3>
          <p id="kpiBottomScore" class="text-xs text-slate-500">–</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-purple-500">
          <p class="text-xs text-slate-500">Class Max</p>
          <h3 id="kpiClassMax" class="text-lg font-semibold mt-1 text-purple-600">–</h3>
          <p class="text-xs text-slate-500">Highest overall avg</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-indigo-500">
          <p class="text-xs text-slate-500">Class Grade</p>
          <h3 id="kpiClassGrade" class="text-lg font-semibold mt-1 text-indigo-600">–</h3>
          <p class="text-xs text-slate-500">Avg grade</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-green-500">
          <p class="text-xs text-slate-500">% Present</p>
          <h3 id="kpiPresent" class="text-lg font-semibold mt-1 text-green-600">–</h3>
          <p class="text-xs text-slate-500">Attendance</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-red-500">
          <p class="text-xs text-slate-500">% Absent</p>
          <h3 id="kpiAbsent" class="text-lg font-semibold mt-1 text-red-600">–</h3>
          <p class="text-xs text-slate-500">Attendance</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-yellow-500">
          <p class="text-xs text-slate-500">Fee: Required</p>
          <h3 id="kpiFeeRequired" class="text-lg font-semibold mt-1 text-yellow-600">–</h3>
          <p class="text-xs text-slate-500">Class/year</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-green-500">
          <p class="text-xs text-slate-500">Fee: Paid</p>
          <h3 id="kpiFeePaid" class="text-lg font-semibold mt-1 text-green-600">–</h3>
          <p class="text-xs text-slate-500">Aggregated</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-red-500">
          <p class="text-xs text-slate-500">Fee: Balance</p>
          <h3 id="kpiFeeBalance" class="text-lg font-semibold mt-1 text-red-600">–</h3>
          <p class="text-xs text-slate-500">Outstanding</p>
        </div>
      </div>

      <div class="lg:col-span-7 grid gap-4">
        <div class="bg-white rounded-2xl p-4 shadow">
          <div class="flex items-center justify-between">
            <p class="text-sm font-medium">Subject Performance (Class)</p>
            <div class="text-xs text-slate-500">Average per subject</div>
          </div>
          <canvas id="chartSubjects" class="mt-3"></canvas>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow">
          <div class="flex items-center justify-between">
            <p class="text-sm font-medium">Student Averages (Top 10)</p>
            <div class="text-xs text-slate-500">Overall %</div>
          </div>
          <canvas id="chartTop10" class="mt-3"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal for Scoresheet -->
  <div id="scoresheetModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <iframe id="scoresheetFrame" src="Toacademichtml/scoresheet.html" style="width: 100%; height: 90%; border: none;"></iframe>
    </div>
  </div>

  <script>
    /* ---------- CONFIG ---------- */
    const SUBJECTS_BY_CLASS = {
      'Baby Class': ['Arithmetic', 'Communication', 'Relation', 'CRN', 'Healthcare', 'Arts'],
      'Middle Class': ['Arithmetic', 'Communication', 'Relation', 'CRN', 'Healthcare', 'Arts'],
      'Pre-Unit': ['Arithmetic', 'Communication', 'Relation', 'CRN', 'Healthcare', 'Arts'],
      'Class 1 AB': ['Writing Skills', 'Arithmetic', 'Developing Sports & Arts', 'Health.AREC', 'Kusoma', 'Listening'],
      'Class 1': ['Writing Skills', 'Arithmetic', 'Developing Sports & Arts', 'Health.AREC', 'Kusoma', 'Listening'], // Added for variants
      'Class 2 AB': ['Writing Skills', 'Arithmetic', 'Developing Sports & Arts', 'Health.AREC', 'Kusoma', 'Listening'],
      'Class 2': ['Writing Skills', 'Arithmetic', 'Developing Sports & Arts', 'Health.AREC', 'Kusoma', 'Listening'], // Added for variants
      'Class 3': ['Math', 'English', 'Kiswahili', 'Science', 'Geography', 'Arts', 'History', 'French'],
      'Class 4': ['Math', 'English', 'Kiswahili', 'Science', 'Geography', 'Arts', 'History', 'French'],
      'Class 5': ['Math', 'English', 'Kiswahili', 'Science', 'Geography', 'Arts', 'History', 'French'],
      'Class 6': ['Math', 'English', 'Kiswahili', 'Science', 'Social Studies', 'Civics & Morals'],
      'Class 7': ['Math', 'English', 'Kiswahili', 'Science', 'Social Studies', 'Civics & Morals']
    };

    const EXAM_KEYS = {
      'Monthly': 'monthly',
      'Midterm 1': 'midterm1',
      'End Term': 'endterm',
      'Midterm 2': 'midterm2',
      'Annual': 'annual'
    };

    function letterGrade(pct) {
      const p = Number(pct);
      if (p >= 80.5) return 'A';
      if (p >= 60.5) return 'B';
      if (p >= 40.5) return 'C';
      if (p >= 20.5) return 'D';
      return 'F';
    }

    /* ---------- STATE ---------- */
    const state = {
      students: [], attendance: {}, fees: {}, scores: {}, subjectList: [],
      rowsByAdm: {}, className: '', stream: '', month: '', year: '', examKey: '', schoolBranch: '',
      assignedClass: ''
    };

    /* ---------- ELEMENTS ---------- */
    const classSelect = document.getElementById('classSelect');
    const streamInput = document.getElementById('streamInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearInput = document.getElementById('yearInput');
    const examType = document.getElementById('examType');
    const schoolBranch = document.getElementById('schoolBranch');

    const subjectsChartCtx = document.getElementById('chartSubjects');
    const top10ChartCtx = document.getElementById('chartTop10');
    let subjectsChart = null, top10Chart = null;

    const kpiTopStudent = document.getElementById('kpiTopStudent');
    const kpiTopScore = document.getElementById('kpiTopScore');
    const kpiBottomStudent = document.getElementById('kpiBottomStudent');
    const kpiBottomScore = document.getElementById('kpiBottomScore');
    const kpiClassMax = document.getElementById('kpiClassMax');
    const kpiClassGrade = document.getElementById('kpiClassGrade');
    const kpiPresent = document.getElementById('kpiPresent');
    const kpiAbsent = document.getElementById('kpiAbsent');
    const kpiFeeRequired = document.getElementById('kpiFeeRequired');
    const kpiFeePaid = document.getElementById('kpiFeePaid');
    const kpiFeeBalance = document.getElementById('kpiFeeBalance');

    const scoresheetModal = document.getElementById('scoresheetModal');
    const btnOpenScoresheet = document.getElementById('btnOpenScoresheet');
    const closeModal = document.getElementById('closeModal');

    /* ---------- Firebase DB helper ---------- */
    function getDB() {
      if (window && window.db) return window.db;
      if (!window.firebase) {
        console.error('Firebase not loaded; ensure firebase.js is present and provides window.db');
        return null;
      }
      if (!firebase.apps.length) {
        const cfg = {
          apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
          authDomain: "somaptestt.firebaseapp.com",
          databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
          projectId: "somaptestt",
          storageBucket: "somaptestt.appspot.com",
          messagingSenderId: "105526245138",
          appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
        };
        firebase.initializeApp(cfg);
      }
      return firebase.database();
    }

    /* ---------- Parse class from Gmail ---------- */
    function parseClassFromEmail(email) {
      const emailPrefix = email.split('@')[0].toLowerCase();
      const classMap = {
        'ssbabyclass': 'Baby Class',
        'ssmiddleclass': 'Middle Class',
        'sspreunit': 'Pre-Unit',
        'ssclass1ab': 'Class 1 AB',
        'ssclass1ab': 'Class 1',
        'ssclass2ab': 'Class 2 AB',
        'ssclass2ab': 'Class 2',
        'ssclass3': 'Class 3',
        'ssclass4': 'Class 4',
        'ssclass5': 'Class 5',
        'ssclass6': 'Class 6',
        'ssclass7': 'Class 7'
      };
      for (const [key, className] of Object.entries(classMap)) {
        if (emailPrefix.includes(key)) {
          return className;
        }
      }
      return null;
    }

    /* ---------- Populate class dropdown (locked to assigned class) ---------- */
    function populateClasses(assignedClass) {
      const opts = Object.keys(SUBJECTS_BY_CLASS);
      if (assignedClass && opts.includes(assignedClass)) {
        classSelect.innerHTML = `<option value="${assignedClass}">${assignedClass}</option>`;
        classSelect.value = assignedClass;
        classSelect.disabled = true;
      } else {
        classSelect.innerHTML = '<option value="">Select Class…</option>' + opts.map(c => `<option>${c}</option>`).join('');
        classSelect.disabled = false;
      }
    }

    /* ---------- Robust student loader ---------- */
    async function fetchStudents(className, stream) {
      const db = getDB();
      if (!db) return [];
      const tryPaths = ['students', 'Students', 'StudentsList', 'Students_List', 'studentList', 'studentlist', 'attendance', 'school', 'schoolerp'];
      for (const p of tryPaths) {
        try {
          const snap = await db.ref(p).get();
          if (snap && snap.exists && snap.exists()) {
            const data = snap.val();
            const arr = [];
            if (Array.isArray(data)) {
              data.forEach((item, idx) => {
                if (item) {
                  const adm = item.adm || item.admissionNumber || item.admNo || ('A' + idx);
                  arr.push(normalizeStudentRecord(adm, item));
                }
              });
            } else {
              Object.keys(data).forEach(k => {
                const s = data[k] || {};
                if (typeof s === 'object' && (s.name || s.fullName || s.firstName || s.adm || s.admissionNumber || s.admissionNo || s.feeDue || s.feePaid)) {
                  const adm = s.adm || s.admissionNumber || s.admNo || s.admission || k;
                  arr.push(normalizeStudentRecord(adm, s));
                }
              });
            }
            const filtered = arr.filter(x => {
              const normalizedClass = String(x.class || '').toUpperCase().replace(/[\s-]/g, '');
              const normalizedSelect = className.toUpperCase().replace(/[\s-]/g, '');
              const classMatches = !className || normalizedClass.includes(normalizedSelect);
              const normalizedStream = String(x.stream || '').toUpperCase().replace(/[\s-]/g, '');
              const normalizedInputStream = stream.toUpperCase().replace(/[\s-]/g, '');
              const streamMatches = !stream || normalizedStream.includes(normalizedInputStream);
              return classMatches && streamMatches;
            });
            filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            if (filtered.length) return filtered;
          }
        } catch (err) {
          console.warn('fetchStudents trying', p, err && err.message);
        }
      }
      return [];
    }

    function normalizeStudentRecord(admKey, s) {
      const name = [s.firstName, s.middleName, s.lastName].filter(Boolean).join(' ').trim() || s.name || s.fullName || ('Student ' + admKey);
      const sClass = s.class || s.currentClass || s.level || s.className || s.grade || s.classLevel || '';
      const sStream = s.stream || s.streamName || s.section || '';
      const feeDue = Number(s.totalFee || s.feePerYear || s.feeDue || s.required || s.debt || 0);
      let feePaid = Number(s.paid || s.feePaid || s.totalPaid || s.paidAmount || s.credit || 0);
      if (s.payments && typeof s.payments === 'object') {
        feePaid = Object.values(s.payments).reduce((sum, p) => sum + Number(p.amount || 0), 0);
      }
      const balance = Number(s.balance || Math.max(0, feeDue - feePaid) || 0);
      return { adm: admKey, name, class: sClass, stream: sStream, feeDue, feePaid, balance, meta: s };
    }

    /* ---------- Attendance + fees + scores fetchers ---------- */
    async function fetchAttendance(year, month, className) {
      const db = getDB();
      if (!db) return {};
      const refPath = `/attendance/${year}/${month}/${className}`;
      try {
        const snap = await db.ref(refPath).get();
        const out = {};
        if (snap && snap.exists && snap.exists()) {
          const val = snap.val();
          Object.keys(val).forEach(adm => {
            const a = val[adm] || {};
            out[adm] = { present: Number(a.present || a.daysPresent || 0), absent: Number(a.absent || a.daysAbsent || 0), days: Number(a.days || (Number(a.present || 0) + Number(a.absent || 0))) };
          });
        }
        return out;
      } catch (e) { console.warn('fetchAttendance', e && e.message); return {}; }
    }

    async function fetchFees(year, className) {
      const db = getDB();
      if (!db) return {};
      const refPath = `/fees/${year}/${className}`;
      try {
        const snap = await db.ref(refPath).get();
        const out = {};
        if (snap && snap.exists && snap.exists()) {
          const val = snap.val();
          Object.keys(val).forEach(adm => {
            const f = val[adm] || {};
            const required = Number(f.required || f.expected || f.total || 0);
            const paid = Number(f.paid || f.paidAmount || 0);
            out[adm] = { required, paid, balance: Math.max(0, required - paid) };
          });
        }
        return out;
      } catch (e) { console.warn('fetchFees', e && e.message); return {}; }
    }

    async function fetchScores({ year, className, examKey, month }) {
      const db = getDB();
      if (!db) return {};
      const refPath = `/scores/${year}/${className}/${examKey}/${month}`;
      try {
        const snap = await db.ref(refPath).get();
        const out = {};
        if (snap && snap.exists && snap.exists()) {
          const val = snap.val();
          Object.keys(val).forEach(adm => {
            out[adm] = {};
            const subjObj = val[adm] || {};
            Object.keys(subjObj).forEach(sub => {
              const o = subjObj[sub] || {};
              out[adm][sub] = { score: Number(o.score || 0), max: Number(o.max || 100) };
            });
          });
        }
        return out;
      } catch (e) { console.warn('fetchScores', e && e.message); return {}; }
    }

    /* ---------- Load sequence (main entry) ---------- */
    async function loadAll() {
      if (!state.assignedClass) {
        alert('No assigned class detected. Please contact the administrator.');
        return;
      }
      if (classSelect.value !== state.assignedClass) {
        alert('NOT YOUR CLASS BUDDY! You are restricted to ' + state.assignedClass);
        classSelect.value = state.assignedClass;
        return;
      }

      state.className = classSelect.value;
      let inputStream = (streamInput.value || '').trim();
      state.month = monthSelect.value;
      state.year = (yearInput.value || '').trim();
      state.examKey = EXAM_KEYS[examType.value] || 'monthly';
      state.schoolBranch = (schoolBranch.value || '').trim();

      if (!state.className) { alert('Select a class'); return; }
      if (!state.year) { alert('Enter academic year'); return; }

      const classNumMatch = state.className.match(/\d+/);
      const classNum = classNumMatch ? classNumMatch[0] : '';
      const effectiveStream = inputStream.replace(/class/i, '').replace(classNum, '').trim().toUpperCase();
      state.stream = effectiveStream;

      state.subjectList = SUBJECTS_BY_CLASS[state.className] || [];

      state.students = await fetchStudents(state.className, state.stream);
      state.attendance = await fetchAttendance(state.year, state.month, state.className) || {};
      state.fees = await fetchFees(state.year, state.className) || {};
      state.scores = await fetchScores({ year: state.year, className: state.className, examKey: state.examKey, month: state.month }) || {};

      updateKPIs();
      drawCharts();
    }

    /* ---------- Authentication and class lock ---------- */
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      const safeEmail = user.email.replace('.', '_');
      const db = getDB();
      db.ref('users/' + safeEmail).once('value').then(snap => {
        const ud = snap.val() || {};
        if (ud.role !== 'teacher') {
          alert('Unauthorized: only teachers allowed');
          firebase.auth().signOut();
          window.location.href = 'index.html';
          return;
        }
        // Parse class from email or use Firebase user data
        state.assignedClass = parseClassFromEmail(user.email) || ud.class || ud.classLevel || '';
        if (!state.assignedClass || !Object.keys(SUBJECTS_BY_CLASS).includes(state.assignedClass)) {
          alert('Invalid or no class assigned. Contact administrator.');
          firebase.auth().signOut();
          window.location.href = 'index.html';
          return;
        }
        // Lock dropdown to assigned class
        populateClasses(state.assignedClass);
        classSelect.value = state.assignedClass;
        yearInput.value = new Date().getFullYear().toString(); // Default to current year
        loadAll();
      });
    });

    /* ---------- Computation: totals/averages/positions/grades ---------- */
    function updateKPIs() {
      const list = Object.values(state.students).map(s => ({
        name: s.name,
        avg: (state.scores[s.adm] ? Object.values(state.scores[s.adm]).reduce((sum, { score, max }) => sum + (score / max) * 100, 0) / state.subjectList.length : 0) || 0
      }));
      if (list.length === 0) {
        ['kpiTopStudent', 'kpiTopScore', 'kpiBottomStudent', 'kpiBottomScore', 'kpiClassMax', 'kpiClassGrade', 'kpiPresent', 'kpiAbsent', 'kpiFeeRequired', 'kpiFeePaid', 'kpiFeeBalance'].forEach(id => document.getElementById(id).textContent = '–');
        return;
      }
      const sorted = list.slice().sort((a, b) => b.avg - a.avg);
      const top = sorted[0];
      const bottom = sorted[sorted.length - 1];
      kpiTopStudent.textContent = top.name || '–';
      kpiTopScore.textContent = (top.avg || 0).toFixed(2) + '%';
      kpiBottomStudent.textContent = bottom.name || '–';
      kpiBottomScore.textContent = (bottom.avg || 0).toFixed(2) + '%';
      kpiClassMax.textContent = (top.avg || 0).toFixed(2) + '%';
      const classAvg = sorted.reduce((s, x) => s + (x.avg || 0), 0) / sorted.length;
      kpiClassGrade.textContent = letterGrade(classAvg);

      let sumPresent = 0, sumAbsent = 0, sumDays = 0;
      state.students.forEach(s => {
        const att = state.attendance[s.adm] || { present: 0, absent: 0, days: 0 };
        sumPresent += att.present;
        sumAbsent += att.absent;
        sumDays += att.days || (att.present + att.absent);
      });
      const pctPresent = sumDays ? (sumPresent / sumDays) * 100 : 0;
      const pctAbsent = sumDays ? (sumAbsent / sumDays) * 100 : 0;
      kpiPresent.textContent = pctPresent.toFixed(1) + '%';
      kpiAbsent.textContent = pctAbsent.toFixed(1) + '%';

      let totalReq = 0, totalPaid = 0, totalBal = 0;
      state.students.forEach(s => {
        const fee = state.fees[s.adm] || { required: s.feeDue || 0, paid: s.feePaid || 0, balance: s.balance || 0 };
        totalReq += fee.required || 0;
        totalPaid += fee.paid || 0;
        totalBal += fee.balance || 0;
      });
      kpiFeeRequired.textContent = money(totalReq);
      kpiFeePaid.textContent = money(totalPaid);
      kpiFeeBalance.textContent = money(totalBal);
    }

    /* ---------- Charts (bounded) ---------- */
    function drawCharts() {
      const MAX_LABELS = 50;
      const subjects = state.subjectList || [];
      const avgPerSubject = subjects.map(sub => {
        let sum = 0, cnt = 0;
        state.students.forEach(s => {
          const sc = (state.scores[s.adm]?.[sub]?.score || 0);
          const mx = Math.max(1, state.scores[s.adm]?.[sub]?.max || 100);
          sum += (sc / mx) * 100;
          cnt++;
        });
        return cnt ? sum / cnt : 0;
      });

      const topList = state.students.map(s => ({
        name: s.name,
        avg: (state.scores[s.adm] ? Object.values(state.scores[s.adm]).reduce((sum, { score, max }) => sum + (score / max) * 100, 0) / state.subjectList.length : 0) || 0
      })).sort((a, b) => b.avg - a.avg).slice(0, 10);

      try { if (subjectsChart) { subjectsChart.destroy(); subjectsChart = null; } } catch (e) {}
      try { if (top10Chart) { top10Chart.destroy(); top10Chart = null; } } catch (e) {}

      const subjectsToShow = subjects.slice(0, MAX_LABELS);
      const avgToShow = avgPerSubject.slice(0, MAX_LABELS);

      subjectsChart = new Chart(subjectsChartCtx, {
        type: 'bar',
        data: { labels: subjectsToShow, datasets: [{ label: 'Average %', data: avgToShow, backgroundColor: '#4B5EAA' }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 }, x: { ticks: { autoSkip: true, maxTicksLimit: 12 } } } }
      });

      top10Chart = new Chart(top10ChartCtx, {
        type: 'bar',
        data: { labels: topList.map(x => x.name), datasets: [{ label: 'Overall %', data: topList.map(x => x.avg), backgroundColor: '#6B7280' }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 }, x: { ticks: { autoSkip: true } } } }
      });
    }

    /* ---------- Small helpers ---------- */
    function money(n) { n = Number(n || 0); return new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES', maximumFractionDigits: 0 }).format(n); }

    /* ---------- Load on change ---------- */
    classSelect.addEventListener('change', () => {
      if (classSelect.value !== state.assignedClass) {
        alert('NOT YOUR CLASS BUDDY! You are restricted to ' + state.assignedClass);
        classSelect.value = state.assignedClass;
        return;
      }
      loadAll();
    });
    streamInput.addEventListener('change', loadAll);
    monthSelect.addEventListener('change', loadAll);
    yearInput.addEventListener('change', loadAll);
    examType.addEventListener('change', loadAll);
    schoolBranch.addEventListener('change', loadAll);

    /* ---------- Modal Control ---------- */
    btnOpenScoresheet.addEventListener('click', () => {
      if (!state.className || !state.year) {
        alert('Please select a class and academic year first.');
        return;
      }
      sessionStorage.setItem('className', state.className);
      sessionStorage.setItem('stream', state.stream);
      sessionStorage.setItem('month', state.month);
      sessionStorage.setItem('year', state.year);
      sessionStorage.setItem('examKey', state.examKey);
      sessionStorage.setItem('schoolBranch', state.schoolBranch);
      scoresheetModal.style.display = 'block';
      document.getElementById('scoresheetFrame').contentWindow.location.reload();
    });

    closeModal.addEventListener('click', () => {
      scoresheetModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      if (event.target == scoresheetModal) {
        scoresheetModal.style.display = 'none';
      }
    });
  </script>
</body>
</html>