<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoMAp – Academic & Exams Module</title>

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- PDF & Excel libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>

  <!-- Optional alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --primary:#1e3a8a; /* thick blue */
      --border:#e5e7eb;
    }
    .brand { color: var(--primary); }
    .thin { font-weight: 500; }
    .cell-input{ width: 5rem; }
    .badge{ border:1px solid var(--border); padding:.125rem .375rem; border-radius:.375rem; font-size:.75rem; }
    .muted{ color:#6b7280; }
    .table-fixed th, .table-fixed td { white-space: nowrap; }
  </style>
</head>

<body class="bg-gray-50">
  <!-- Top Bar -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-3">
        <img src="images/somap-logo.png.jpg" alt="SoMAp Logo" class="h-10 w-auto">
        <div>
          <div class="text-xl font-bold brand">SoMAp – Academics</div>
          <div class="text-xs text-gray-500 -mt-1">Scoresheets • Reports • Dashboards</div>
        </div>
      </a>
      <nav class="flex items-center gap-2">
        <a href="index.html" class="text-sm px-3 py-1 rounded hover:bg-gray-100">Home</a>
        <a href="schoolerp.html.html" class="text-sm px-3 py-1 rounded hover:bg-gray-100">ERP</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 md:p-6">
    <div class="bg-white rounded-xl shadow p-4 md:p-6">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Academic & Exams Module</h1>
      <p class="text-gray-600 mt-1">Enter marks, compute averages, rank students, and export report cards.</p>

      <!-- Controls -->
      <div class="mt-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Class -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Class</label>
          <select id="classSelect" class="w-full border rounded-lg px-3 py-2">
            <option value="">Choose Class</option>
            <option value="baby">Baby</option>
            <option value="middle">Middle</option>
            <option value="preunit">Preunit</option>
            <option value="class1">Class 1</option>
            <option value="class2">Class 2</option>
            <option value="class3">Class 3</option>
            <option value="class4">Class 4</option>
            <option value="class5">Class 5</option>
            <option value="class6">Class 6</option>
            <option value="class7">Class 7</option>
          </select>
        </div>

        <!-- Month -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Month</label>
          <select id="monthSelect" class="w-full border rounded-lg px-3 py-2">
            <option>January</option><option>February</option><option>March</option><option>April</option>
            <option>May</option><option>June</option><option>July</option><option>August</option>
            <option>September</option><option>October</option><option>November</option><option>December</option>
          </select>
        </div>

        <!-- Year -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Year</label>
          <input id="yearInput" type="number" class="w-full border rounded-lg px-3 py-2" min="2000" max="2100" />
        </div>

        <!-- Exam type -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Exam Type</label>
          <select id="examTypeSelect" class="w-full border rounded-lg px-3 py-2">
            <option value="monthly">Monthly</option>
            <option value="midterm">Midterm</option>
            <option value="term">Term</option>
            <option value="annual">Annual</option>
          </select>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-2">
        <button id="loadStudentsBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          Load Students
        </button>
        <span id="statusBadge" class="badge muted">Idle</span>
      </div>

      <!-- Scoresheet -->
      <div class="mt-6 overflow-x-auto">
        <table id="scoresheetTable" class="min-w-full table-fixed border">
          <thead class="bg-indigo-50">
            <tr id="scoresheetHeader">
              <!-- dynamic columns -->
            </tr>
          </thead>
          <tbody id="scoresheetBody">
            <!-- dynamic rows -->
          </tbody>
        </table>
      </div>

      <!-- Actions -->
      <div class="mt-5 flex flex-wrap gap-2">
        <button id="saveBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          Save to Firebase
        </button>
        <button id="pdfBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
          Download Class PDF
        </button>
        <button id="excelBtn" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
          Download Excel
        </button>
        <button id="recalcBtn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">
          Recalculate Averages & Positions
        </button>
      </div>

      <!-- Notes -->
      <div class="mt-6 bg-gray-50 border rounded-lg p-4 text-sm">
        <p class="mb-2"><strong>Data paths (Firebase Realtime Database):</strong></p>
        <ul class="list-disc ml-5 space-y-1">
          <li><code>students/{classId}/{studentId} → { name, admissionNumber, photoUrl? }</code></li>
          <li><code>attendanceSummary/{classId}/{studentId}/{periodKey} → { presentDays, absentDays, totalDays }</code></li>
          <li><code>fees/{studentId}/balance → number (TZS)</code></li>
          <li><code>marks/{classId}/{studentId}/{periodKey} → { subjectScores..., average, position }</code></li>
        </ul>
        <p class="mt-2 text-gray-600">If attendance/fees don’t exist yet, the table shows “–”. You can add them later — saving marks still works.</p>
      </div>
    </div>
  </main>

  <!-- Firebase bootstrap (must already exist in your project root) -->
  <!-- This file should initialize: const db = firebase.database(); -->
  <script src="firebase.js"></script>

  <script>
    // -----------------------------
    // Helpers & Config
    // -----------------------------
    const monthMap = {
      January:'01', February:'02', March:'03', April:'04',
      May:'05', June:'06', July:'07', August:'08',
      September:'09', October:'10', November:'11', December:'12'
    };

    // Subject templates by level
    const SUBJECTS = {
      baby: ['Arithmetic', 'Communication', 'Relation', 'CRN', 'Healthcare', 'Arts'],
      middle: ['Arithmetic', 'Communication', 'Relation', 'CRN', 'Healthcare', 'Arts'],
      preunit: ['Arithmetic', 'Communication', 'Relation', 'CRN', 'Healthcare', 'Arts'],
      class1: ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      class2: ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      class3: ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      class4: ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      class5: ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      class6: ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals'],
      class7: ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals']
    };

    const classSelect = document.getElementById('classSelect');
    const monthSelect = document.getElementById('monthSelect');
    const yearInput = document.getElementById('yearInput');
    const examTypeSelect = document.getElementById('examTypeSelect');
    const statusBadge = document.getElementById('statusBadge');

    const headerEl = document.getElementById('scoresheetHeader');
    const bodyEl = document.getElementById('scoresheetBody');

    document.getElementById('loadStudentsBtn').addEventListener('click', loadStudents);
    document.getElementById('saveBtn').addEventListener('click', saveScoresheet);
    document.getElementById('recalcBtn').addEventListener('click', recalcAll);
    document.getElementById('pdfBtn').addEventListener('click', downloadPDF);
    document.getElementById('excelBtn').addEventListener('click', downloadExcel);

    // Default year = current
    (function setDefaultYear(){
      const y = new Date().getFullYear();
      yearInput.value = y;
    })();

    function setStatus(text, tone='muted'){
      statusBadge.textContent = text;
      statusBadge.className = 'badge ' + (tone==='ok' ? 'text-green-700 border-green-300 bg-green-50'
                                     : tone==='warn' ? 'text-yellow-700 border-yellow-300 bg-yellow-50'
                                     : tone==='err' ? 'text-red-700 border-red-300 bg-red-50'
                                     : 'muted');
    }

    function getPeriodKey(){
      const m = monthSelect.value;
      const y = (yearInput.value || '').trim();
      const t = examTypeSelect.value;
      const mm = monthMap[m] || '01';
      return `${y}-${mm}_${t}`;
    }

    // -----------------------------
    // Load students & build table
    // -----------------------------
    async function loadStudents(){
      const classId = classSelect.value;
      if(!classId){ alert('Choose Class'); return; }

      setStatus('Loading students...', 'warn');

      // Build header
      buildHeader(classId);

      // Fetch students
      try{
        const snap = await db.ref(`students/${classId}`).get();
        const studentsObj = snap.val() || {};
        const students = Object.entries(studentsObj).map(([id, s]) => ({ id, ...s }));

        // Sort by name
        students.sort((a,b)=> (a.name||'').localeCompare(b.name||''));

        // Render
        bodyEl.innerHTML = '';
        for(const s of students){
          await renderStudentRow(classId, s);
        }
        recalcAll();
        setStatus(`Loaded ${students.length} students`, 'ok');
      }catch(err){
        console.error(err);
        setStatus('Failed to load students', 'err');
        alert('Failed to load students: ' + err.message);
      }
    }

    function buildHeader(classId){
      const subs = SUBJECTS[classId] || [];
      const staticCols = [
        '<th class="px-3 py-2 border text-left">Student</th>',
        '<th class="px-3 py-2 border text-left">Adm No.</th>',
        '<th class="px-3 py-2 border text-left">Attendance</th>',
        '<th class="px-3 py-2 border text-left">Fees (TZS)</th>'
      ];
      const subjectCols = subs.map(s=> `<th class="px-3 py-2 border text-left">${escapeHtml(s)}</th>`);
      const tail = [
        '<th class="px-3 py-2 border text-left">Average</th>',
        '<th class="px-3 py-2 border text-left">Position</th>'
      ];
      headerEl.innerHTML = staticCols.concat(subjectCols).concat(tail).join('');
    }

    async function renderStudentRow(classId, student){
      const periodKey = getPeriodKey();
      const subs = SUBJECTS[classId] || [];

      // Fetch attendance (optional)
      let attendStr = '–';
      try{
        const atSnap = await db.ref(`attendanceSummary/${classId}/${student.id}/${periodKey}`).get();
        const at = atSnap.val();
        if(at && (at.totalDays || at.presentDays || at.absentDays)){
          const present = at.presentDays ?? '–';
          const total = at.totalDays ?? '–';
          attendStr = `${present}/${total}`;
        }
      }catch(_){}

      // Fetch fees balance (optional)
      let feeBalance = '–';
      try{
        const feeSnap = await db.ref(`fees/${student.id}/balance`).get();
        const bal = feeSnap.val();
        if(typeof bal === 'number'){ feeBalance = Intl.NumberFormat().format(bal); }
      }catch(_){}

      // Fetch previous marks (if any)
      let marks = {};
      try{
        const mkSnap = await db.ref(`marks/${classId}/${student.id}/${periodKey}`).get();
        marks = mkSnap.val() || {};
      }catch(_){}

      const tr = document.createElement('tr');
      tr.dataset.sid = student.id;

      const cells = [];
      // Student
      cells.push(`<td class="px-3 py-2 border"><div class="font-medium">${escapeHtml(student.name||'')}</div></td>`);
      // Adm
      cells.push(`<td class="px-3 py-2 border">${escapeHtml(student.admissionNumber||'')}</td>`);
      // Attendance
      cells.push(`<td class="px-3 py-2 border">${attendStr}</td>`);
      // Fees
      cells.push(`<td class="px-3 py-2 border">${feeBalance}</td>`);

      // Subject inputs
      for(const sub of subs){
        const key = normKey(sub);
        const val = (marks[key] ?? '');
        cells.push(`
          <td class="px-2 py-1 border">
            <input type="number" min="0" max="100" step="0.5"
                   class="border rounded px-2 py-1 cell-input"
                   data-subject="${escapeAttr(key)}"
                   value="${escapeAttr(val)}"
                   oninput="onScoreChange(this)" />
          </td>`);
      }

      // Average + Position
      const avg = (typeof marks.average === 'number') ? marks.average.toFixed(2) : '';
      const pos = (marks.position ?? '');
      cells.push(`<td class="px-3 py-2 border avg-cell text-gray-800 font-semibold">${avg}</td>`);
      cells.push(`<td class="px-3 py-2 border pos-cell">${pos}</td>`);

      tr.innerHTML = cells.join('');
      bodyEl.appendChild(tr);
    }

    function onScoreChange(input){
      // Recalculate this row’s average
      const tr = input.closest('tr');
      calcRowAverage(tr);
    }

    function calcRowAverage(tr){
      const inputs = tr.querySelectorAll('input[data-subject]');
      let sum = 0, n = 0;
      inputs.forEach(i=>{
        const v = parseFloat(i.value);
        if(!isNaN(v)){ sum += v; n++; }
      });
      const avg = n ? (sum/n) : 0;
      tr.querySelector('.avg-cell').textContent = n ? avg.toFixed(2) : '';
    }

    function recalcAll(){
      const rows = [...bodyEl.querySelectorAll('tr')];
      // averages
      rows.forEach(calcRowAverage);
      // positions
      const arr = rows.map(tr=>{
        const avg = parseFloat(tr.querySelector('.avg-cell').textContent) || 0;
        return { tr, avg };
      });
      arr.sort((a,b)=> b.avg - a.avg);

      // Assign positions with ties
      let currentPos = 0;
      let lastAvg = null;
      for(let i=0;i<arr.length;i++){
        const {tr, avg} = arr[i];
        if(i===0){ currentPos = 1; lastAvg = avg; }
        else{
          if(avg === lastAvg){ /* same position */ }
          else{ currentPos = i+1; lastAvg = avg; }
        }
        tr.querySelector('.pos-cell').textContent = (avg>0)? currentPos : '';
      }
    }

    // -----------------------------
    // Save to Firebase
    // -----------------------------
    async function saveScoresheet(){
      const classId = classSelect.value;
      if(!classId){ alert('Choose Class'); return; }
      const periodKey = getPeriodKey();

      setStatus('Saving...', 'warn');
      const updates = {};

      const rows = [...bodyEl.querySelectorAll('tr')];
      for(const tr of rows){
        const sid = tr.dataset.sid;
        const inputs = tr.querySelectorAll('input[data-subject]');
        const data = {};
        let sum = 0, n = 0;

        inputs.forEach(i=>{
          const key = i.getAttribute('data-subject');
          const val = parseFloat(i.value);
          if(!isNaN(val)){ data[key] = val; sum += val; n++; }
        });

        const avg = n? (sum/n) : 0;
        data.average = avg;

        // position cell may not exist yet (call recalcAll before save)
        const posText = tr.querySelector('.pos-cell').textContent.trim();
        if(posText){ data.position = parseInt(posText,10); }

        updates[`marks/${classId}/${sid}/${periodKey}`] = data;
      }

      try{
        await db.ref().update(updates);
        setStatus('Saved successfully', 'ok');
        Swal.fire({icon:'success', title:'Saved', text:'Scoresheet stored in Firebase.'});
      }catch(err){
        console.error(err);
        setStatus('Save failed', 'err');
        Swal.fire({icon:'error', title:'Error', text:err.message});
      }
    }

    // -----------------------------
    // Export: PDF
    // -----------------------------
    function downloadPDF(){
      const classId = classSelect.value || 'class';
      const periodKey = getPeriodKey();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const title = `SoMAp – ${classId.toUpperCase()} • ${periodKey}`;
      doc.setFontSize(14);
      doc.text(title, 14, 16);

      // Build table for PDF
      const head = [...headerEl.children].map(th=> th.textContent.trim());
      const rows = [...bodyEl.querySelectorAll('tr')].map(tr=>{
        return [...tr.children].map(td=>{
          return td.querySelector('input') ? (td.querySelector('input').value || '') : td.textContent.trim();
        });
      });

      doc.autoTable({
        head:[head],
        body: rows,
        startY: 22,
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [30,58,138] } // deep blue
      });

      doc.save(`SoMAp_${classId}_${periodKey}.pdf`);
    }

    // -----------------------------
    // Export: Excel
    // -----------------------------
    function downloadExcel(){
      const classId = classSelect.value || 'class';
      const periodKey = getPeriodKey();

      // Build JSON rows
      const head = [...headerEl.children].map(th=> th.textContent.trim());
      const rows = [...bodyEl.querySelectorAll('tr')].map(tr=>{
        return [...tr.children].map(td=>{
          return td.querySelector('input') ? (td.querySelector('input').value || '') : td.textContent.trim();
        });
      });

      const data = [head, ...rows];
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Scoresheet");
      XLSX.writeFile(wb, `SoMAp_${classId}_${periodKey}.xlsx`);
    }

    // -----------------------------
    // Utils
    // -----------------------------
    function normKey(s){ return (s||'').toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,''); }
    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function escapeAttr(s){ return String(s ?? '').replace(/"/g,'&quot;'); }
  </script>
</body>
</html>
