<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SoMAp — Attendance</title>

<!-- Tailwind for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
  *{font-family:Inter,system-ui,Arial}
  .status-chip{min-width:44px;border-radius:9999px;padding:6px 10px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .chip-P{background:#dcfce7;color:#166534} /* green */
  .chip-A{background:#fee2e2;color:#991b1b} /* red */
  .chip-S{background:#fff7ed;color:#c2410c} /* amber */
  .chip-LE{background:#eef2ff;color:#3730a3} /* indigo */
  .chip-MT{background:#fff7f0;color:#9a3412} /* orange-ish */
  .chip-PG{background:#eef2ff;color:#0b69ff} /* permission blue */
  .chip-empty{background:#f3f4f6;color:#374151;border:1px dashed #e5e7eb}
  .status-pill{padding:4px 8px;border-radius:9999px;font-weight:700}
  .hidden{display:none!important}
  .table th, .table td{padding:8px;border-bottom:1px solid #e6e9ef;white-space:nowrap}
  .table thead th{background:#f8fafc;font-weight:700;position:sticky;top:0}
  .scroll{overflow:auto}
</style>
</head>
<body class="bg-slate-50 min-h-screen">

<header class="bg-white border-b sticky top-0 z-30">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <a href="schoolerp.html" class="text-slate-700 hover:text-blue-600">← Back to ERP</a>
      <h1 class="text-lg font-semibold">SoMAp — Attendance</h1>
    </div>
    <div class="flex items-center gap-3">
      <button id="btnFullscreen" class="px-3 py-1 rounded-md border bg-slate-100">Enter Fullscreen</button>
      <div id="rtState" class="text-sm text-slate-500">Connecting…</div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-4 space-y-4">

  <!-- Top Analytics (moved first as requested) -->
  <section id="analytics" class="bg-white rounded-2xl p-4 shadow-sm border">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-sm text-slate-500">Analytics — <span id="monthLabel">—</span></div>
        <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="p-3 rounded-xl border bg-[var(--muted,#fbfcfe)]">
            <div class="text-sm text-slate-500">Class Days (excl. weekends & holidays)</div>
            <div id="classDays" class="text-2xl font-bold">—</div>
          </div>
          <div class="p-3 rounded-xl border bg-[var(--muted,#fbfcfe)]">
            <div class="text-sm text-slate-500">% Present (Class Avg)</div>
            <div id="classPctPresent" class="text-2xl font-bold">—</div>
          </div>
          <div class="p-3 rounded-xl border bg-[var(--muted,#fbfcfe)]">
            <div class="text-sm text-slate-500">Yellow Alerts (≥ 10 absent days/month)</div>
            <div id="yellowCount" class="text-2xl font-bold">—</div>
          </div>
        </div>
      </div>

      <div class="w-64">
        <div class="text-sm text-slate-500 mb-2">Archived query</div>
        <div class="grid grid-cols-1 gap-2">
          <input id="fromDate" type="date" class="px-3 py-2 border rounded" />
          <input id="toDate" type="date" class="px-3 py-2 border rounded" />
          <button id="btnRangeLoad" class="px-3 py-2 bg-indigo-600 text-white rounded">Load Range</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Filters + actions -->
  <section class="bg-white rounded-2xl p-4 shadow-sm border">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
      <div>
        <label class="text-sm font-medium">Class</label>
        <select id="classSelect" class="w-full border rounded px-3 py-2"></select>
      </div>

      <div>
        <label class="text-sm font-medium">Date</label>
        <input id="dateInput" type="date" class="w-full border rounded px-3 py-2" />
      </div>

      <div>
        <label class="text-sm font-medium">Search / Show</label>
        <input id="searchInput" type="text" placeholder="Type name or admission" class="w-full border rounded px-3 py-2"/>
      </div>

      <div>
        <label class="text-sm font-medium">Quick Set</label>
        <div class="flex gap-2">
          <select id="quickAm" class="border rounded px-3 py-2">
            <option value="">AM</option><option value="P">P</option><option value="A">A</option><option value="S">S</option><option value="LE">LE</option><option value="MT">MT</option><option value="PG">PG</option>
          </select>
          <select id="quickPm" class="border rounded px-3 py-2">
            <option value="">PM</option><option value="P">P</option><option value="A">A</option><option value="S">S</option><option value="LE">LE</option><option value="MT">MT</option><option value="PG">PG</option>
          </select>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="markAllPresent" class="px-3 py-2 bg-green-600 text-white rounded">Mark all Present</button>
        <button id="applyQuick" class="px-3 py-2 bg-slate-900 text-white rounded">Apply Quick</button>
        <button id="saveAll" class="px-3 py-2 bg-blue-600 text-white rounded">Save</button>
      </div>
    </div>
  </section>

  <!-- Attendance list -->
  <section class="bg-white rounded-2xl p-4 shadow-sm border">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold">Class Attendance</h2>
      <div class="text-sm text-slate-500">Students in view: <span id="studentCount">0</span></div>
    </div>

    <div class="scroll">
      <table class="table min-w-full" id="attTable">
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="width:120px">Adm No</th>
            <th>Student Name</th>
            <th style="width:120px">Fee Due</th>
            <th style="width:120px">Paid</th>
            <th style="width:120px">Balance</th>
            <th style="width:380px">Mark AM / PM</th>
            <th style="width:140px">Daily</th>
            <th style="width:140px">Actions</th>
          </tr>
        </thead>
        <tbody id="attBody"></tbody>
      </table>
    </div>

    <div class="mt-3 flex gap-2">
      <button id="exportDaily" class="px-3 py-2 border rounded">Export Daily (PDF)</button>
      <button id="exportMonthly" class="px-3 py-2 border rounded">Export Monthly (PDF)</button>
      <button id="exportStudent" class="px-3 py-2 border rounded">Export Student (PDF)</button>
      <div id="saveToast" class="text-sm text-slate-500 ml-auto"></div>
    </div>
  </section>

  <!-- Per-student analytics list -->
  <section class="bg-white rounded-2xl p-4 shadow-sm border">
    <h3 class="font-semibold mb-3">Per-student summary (Month)</h3>
    <div id="perStudentStats" class="grid gap-3"></div>
  </section>

</main>

<footer class="bg-white border-t py-3 sticky bottom-0">
  <div class="max-w-6xl mx-auto px-4 text-sm text-slate-500 flex items-center gap-3">
    <div>SoMAp Attendance · Mobile friendly</div>
    <div id="todayAlert" class="ml-auto text-sm text-yellow-700 hidden"></div>
  </div>
</footer>

<!-- Firebase libs assumed; your firebase.js must load and set window.db -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script src="firebase.js"></script>

<!-- jsPDF for export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(async function(){
  // ---------- CONFIG ----------
  const TZ = 'Africa/Nairobi';
  const SCHOOL_DAY_CUTOFF_HOUR = 15;
  const HOLIDAYS = ['01-01','04-07','04-26','05-01','07-07','08-08','10-14','12-09','12-25','12-26'];
  const MOVABLE = ['2025-03-29','2025-04-01','2025-04-10','2025-04-11','2025-06-16']; // example

  // ---------- STATE ----------
  let students = []; // {id, admissionNo, name, class, feeDue, feePaid, balance}
  let filtered = [];
  let currentClass = '';
  let currentDateStr = '';
  let monthKey = '';
  let attendanceCache = {}; // { studentId: { am, pm, daily, snap } }
  let monthAttendance = {}; // historical month view
  let db = window.db || (window.firebase && firebase.database ? firebase.database() : null);

  // ---------- HELPERS ----------
  const el = id => document.getElementById(id);
  function fmtDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function toMonthKey(dStr){ const d = new Date(dStr + 'T00:00:00'); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  function isWeekend(d){ const day = d.getDay(); return day===0 || day===6; }
  function isHoliday(d){ const fixed = String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); const iso = fmtDate(d); return HOLIDAYS.includes(fixed) || MOVABLE.includes(iso); }
  function deriveDaily(am, pm){
    if(!am && !pm) return '';
    const A=(am||'').toUpperCase(); const P=(pm||'').toUpperCase();
    if(A==='P' && P==='P') return 'P';
    const map = {'P-A':'PA','A-P':'AP','P-S':'PS','P-MT':'PMT','P-PG':'PPG','P-LE':'PLE','S-P':'SP','MT-P':'MTP','PG-P':'PGP','LE-P':'LEP'};
    return map[`${A}-${P}`] || `${A}${P}`;
  }
  function monthWorkingDays(dateStr){
    const d = new Date(dateStr + 'T00:00:00'); const y=d.getFullYear(), m=d.getMonth();
    let count=0;
    for(let day=1; day<=31; day++){
      const dt = new Date(y,m,day); if(dt.getMonth()!==m) break;
      if(isWeekend(dt) || isHoliday(dt)) continue; count++;
    }
    return count;
  }
  function setStatusElem(elm, val){
    if(!elm) return;
    elm.textContent = val || '—';
    elm.className = 'status-pill ' + (val==='P' ? 'bg-green-100 text-green-800' : (val||'').includes('A') ? 'bg-red-100 text-red-700' : (val||'').includes('S') ? 'bg-amber-100 text-amber-800' : 'bg-slate-100 text-slate-700');
  }

  // ---------- FIREBASE: load students robustly ----------
  async function loadStudentsFromDb(){
    if(!db) return [];
    const tryPaths = ['students','Students','StudentsList','Students_List'];
    for(const p of tryPaths){
      try{
        const snap = await db.ref(p).get();
        if(snap.exists()){
          const data = snap.val();
          return Object.keys(data).map(k=>{
            const s = data[k] || {};
            const name = [s.firstName,s.middleName,s.lastName].filter(Boolean).join(' ').trim() || s.name || (s.fullName||'');
            const feeDue = Number(s.totalFee || s.feePerYear || s.feeDue || 0);
            const feePaid = Number(s.feesPaid || s.feePaid || s.paidAmount || 0);
            const balance = Number(s.balance || (feeDue - feePaid) || 0);
            return { id:k, admissionNo: s.admissionNumber || s.admNo || s.admissionNo || '', name, class: s.class || s.classLevel || s.grade || 'Unknown', feeDue, feePaid, balance };
          });
        }
      }catch(e){ console.warn('load path',p,e.message); }
    }
    return [];
  }

  async function init(){
    // init dates
    const now = new Date();
    currentDateStr = fmtDate(now);
    monthKey = toMonthKey(currentDateStr);
    el('dateInput').value = currentDateStr;
    el('fromDate').value = currentDateStr;
    el('toDate').value = currentDateStr;

    if(!db){ el('rtState').textContent='firebase.js not loaded'; alert('firebase.js not loaded or window.db not set'); return; }
    el('rtState').textContent='Loading students...';
    students = await loadStudentsFromDb();
    populateClassSelect();
    el('rtState').textContent='Ready';
    wireUI();
    // If only one class, preselect
    if(students.length && !currentClass){
      const classes = Array.from(new Set(students.map(s=>s.class))).sort();
      if(classes.length===1){ el('classSelect').value = classes[0]; el('classSelect').dispatchEvent(new Event('change')); }
    }
  }

  function populateClassSelect(){
    const classes = Array.from(new Set(students.map(s=>s.class))).filter(Boolean).sort();
    const sel = el('classSelect');
    sel.innerHTML = `<option value="">-- Select class --</option>` + classes.map(c=>`<option value="${c}">${c}</option>`).join('');
  }

  // ---------- Attendance CRUD ----------
  async function loadDayAttendance(cls, dateStr){
    attendanceCache = {};
    if(!db || !cls) return;
    const yymm = toMonthKey(dateStr);
    try{
      const snap = await db.ref(`attendance/${cls}/${yymm}/${dateStr}`).get();
      const d = snap.exists() ? snap.val() : {};
      Object.keys(d).forEach(k=>attendanceCache[k]=d[k]);
    }catch(e){ console.warn(e); }
  }
  async function loadMonthAttendance(cls, yymm){
    monthAttendance = {};
    if(!db || !cls) return;
    try{
      const snap = await db.ref(`attendance/${cls}/${yymm}`).get();
      const d = snap.exists() ? snap.val() : {};
      Object.keys(d).forEach(dateKey=>{
        const byStu = d[dateKey]||{};
        Object.keys(byStu).forEach(stuId=>{
          monthAttendance[stuId] = monthAttendance[stuId]||{};
          monthAttendance[stuId][dateKey] = byStu[stuId];
        });
      });
    }catch(e){ console.warn(e); }
  }
  async function saveDayAttendance(cls, dateStr){
    if(!db) return;
    const yymm = toMonthKey(dateStr);
    const path = `attendance/${cls}/${yymm}/${dateStr}`;
    try{
      await db.ref(path).update(attendanceCache);
      el('saveToast').textContent='Saved ✓';
      setTimeout(()=>el('saveToast').textContent='',1400);
    }catch(e){ alert('Save failed: '+e.message); }
  }

  // ---------- Render UI ----------
  function renderTable(){
    const body = el('attBody'); body.innerHTML='';
    const q = (el('searchInput').value||'').toLowerCase();
    filtered = students.filter(s=>s.class===currentClass).filter(s=>!q||s.name.toLowerCase().includes(q)||String(s.admissionNo||'').includes(q));
    el('studentCount').textContent = filtered.length;

    filtered.forEach((s, idx)=>{
      const rec = attendanceCache[s.id] || {};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${s.admissionNo||''}</td>
        <td>${escapeHtml(s.name)}</td>
        <td>${s.feeDue.toLocaleString()}</td>
        <td>${s.feePaid.toLocaleString()}</td>
        <td>${s.balance.toLocaleString()}</td>
        <td id="chips-${s.id}"></td>
        <td><span id="daily-${s.id}" class="status-pill">—</span></td>
        <td>
          <button data-id="${s.id}" class="btn-export text-sm px-2 py-1 border rounded">Export</button>
        </td>
      `;
      body.appendChild(tr);

      // create chips (AM + PM) with colors
      const chipsCell = tr.querySelector(`#chips-${s.id}`);
      const statuses = ['P','A','S','LE','MT','PG'];
      // AM group
      const amGroup = document.createElement('div'); amGroup.className='flex gap-2 items-center mb-2';
      const lblAm = document.createElement('div'); lblAm.className='text-xs text-slate-500 mr-2'; lblAm.textContent='AM';
      amGroup.appendChild(lblAm);
      statuses.forEach(st=>{
        const b = document.createElement('div');
        b.className = 'status-chip ' + (st ? 'chip-'+st : 'chip-empty');
        b.textContent = st;
        b.title = 'AM: '+st;
        b.dataset.stu = s.id; b.dataset.sess='am'; b.dataset.val=st;
        b.addEventListener('click', onChipClick);
        amGroup.appendChild(b);
      });
      chipsCell.appendChild(amGroup);

      // PM group
      const pmGroup = document.createElement('div'); pmGroup.className='flex gap-2 items-center';
      const lblPm = document.createElement('div'); lblPm.className='text-xs text-slate-500 mr-2'; lblPm.textContent='PM';
      pmGroup.appendChild(lblPm);
      statuses.forEach(st=>{
        const b = document.createElement('div');
        b.className = 'status-chip ' + (st ? 'chip-'+st : 'chip-empty');
        b.textContent = st;
        b.title = 'PM: '+st;
        b.dataset.stu = s.id; b.dataset.sess='pm'; b.dataset.val=st;
        b.addEventListener('click', onChipClick);
        pmGroup.appendChild(b);
      });
      chipsCell.appendChild(pmGroup);

      // set existing values visuals
      updateRowVisuals(s.id);
    });

    // attach export per-student
    document.querySelectorAll('.btn-export').forEach(btn=>{
      btn.addEventListener('click', ()=>exportPdfForStudent(btn.dataset.id));
    });
  }

  function onChipClick(e){
    const b = e.currentTarget;
    const stu = b.dataset.stu; const sess = b.dataset.sess; const val = b.dataset.val;
    attendanceCache[stu] = attendanceCache[stu]||{};
    // toggle: if same value -> clear
    if(attendanceCache[stu][sess] === val) attendanceCache[stu][sess] = '';
    else attendanceCache[stu][sess] = val;
    attendanceCache[stu].daily = deriveDaily(attendanceCache[stu].am, attendanceCache[stu].pm);
    // attach snapshot
    const s = students.find(x=>x.id===stu);
    attendanceCache[stu].snap = { admissionNo: s?.admissionNo||'', name:s?.name||'', class:s?.class||'', feeDue:s?.feeDue||0, feePaid:s?.feePaid||0, balance:s?.balance||0 };
    updateRowVisuals(stu);
  }

  function updateRowVisuals(stu){
    // update chips style and daily pill
    const rec = attendanceCache[stu] || {};
    // AM chips set active border
    document.querySelectorAll(`[data-stu="${stu}"][data-sess="am"]`).forEach(el=>{
      el.style.outline = (rec.am && el.dataset.val === rec.am) ? '3px solid rgba(11,103,255,0.12)' : 'none';
    });
    document.querySelectorAll(`[data-stu="${stu}"][data-sess="pm"]`).forEach(el=>{
      el.style.outline = (rec.pm && el.dataset.val === rec.pm) ? '3px solid rgba(11,103,255,0.12)' : 'none';
    });
    setStatusElem(el('daily-'+stu), rec.daily || deriveDaily(rec.am, rec.pm));
  }

  // ---------- Quick / Mark all ----------
  function applyQuick(){
    const qAm = el('quickAm').value; const qPm = el('quickPm').value;
    filtered.forEach(s=>{
      attendanceCache[s.id] = attendanceCache[s.id]||{};
      if(qAm) attendanceCache[s.id].am = qAm;
      if(qPm) attendanceCache[s.id].pm = qPm;
      attendanceCache[s.id].daily = deriveDaily(attendanceCache[s.id].am, attendanceCache[s.id].pm);
      attendanceCache[s.id].snap = { admissionNo: s.admissionNo||'', name:s.name, class:s.class, feeDue:s.feeDue, feePaid:s.feePaid, balance:s.balance };
      updateRowVisuals(s.id);
    });
  }
  function markAllPresent(){
    filtered.forEach(s=>{
      attendanceCache[s.id] = attendanceCache[s.id]||{};
      attendanceCache[s.id].am = 'P'; attendanceCache[s.id].pm = 'P';
      attendanceCache[s.id].daily = 'P';
      attendanceCache[s.id].snap = { admissionNo: s.admissionNo||'', name:s.name, class:s.class, feeDue:s.feeDue, feePaid:s.feePaid, balance:s.balance };
      updateRowVisuals(s.id);
    });
  }

  // ---------- Analytics compute (including 3-month) ----------
  async function computeAnalytics(){
    const workdays = monthWorkingDays(currentDateStr);
    el('classDays').textContent = workdays;
    el('monthLabel').textContent = monthKey;

    // load monthAttendance (already loaded) + compute per-student stats for month
    let totalPct=0, nWithData=0; let yellow=0, red=0;
    // For RED alert: check rolling 3 months
    const [y,m] = monthKey.split('-').map(Number);
    const monthsToCheck = [];
    for(let k=0;k<3;k++){
      const dt = new Date(y, m-1-k, 1);
      monthsToCheck.push(`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`);
    }

    // load 3 months attendance for red alert
    const threeMonthAttendance = {};
    for(const mon of monthsToCheck){
      const snap = await db.ref(`attendance/${currentClass}/${mon}`).get();
      const data = snap.exists()? snap.val() : {};
      Object.keys(data).forEach(dateKey=>{
        const byStu = data[dateKey]||{};
        Object.keys(byStu).forEach(sid=>{
          threeMonthAttendance[sid] = threeMonthAttendance[sid] || {};
          threeMonthAttendance[sid][dateKey] = byStu[sid];
        });
      });
    }

    el('perStudentStats').innerHTML = '';
    filtered.forEach(s=>{
      const dates = monthAttendance[s.id] || {};
      let presentDays=0, absentDays=0;
      Object.keys(dates).forEach(dk=>{
        const rec = dates[dk];
        if(rec && rec.daily==='P') presentDays++;
        if(rec && (rec.daily||'').includes('A')) absentDays++;
      });
      const pct = workdays ? Math.round((presentDays/workdays)*100) : 0;
      if(workdays){ totalPct += pct; nWithData++; }
      if(absentDays >= 10) yellow++;

      // compute red 3-month absent days
      let absent3 = 0;
      const three = threeMonthAttendance[s.id] || {};
      Object.keys(three).forEach(dk=>{
        const r = three[dk];
        if(r && (r.daily||'').includes('A')) absent3++;
      });
      if(absent3 >= 35) red++;

      const card = document.createElement('div');
      card.className = 'p-3 rounded-xl border bg-white';
      card.innerHTML = `<div class="flex items-center justify-between"><div><b>${escapeHtml(s.name)}</b></div><div class="text-sm text-slate-500">${s.admissionNo}</div></div>
        <div class="text-sm mt-1">Present: <b>${presentDays}</b> / ${workdays} · Absent: <b>${absentDays}</b> · ${pct}%</div>`;
      el('perStudentStats').appendChild(card);
    });

    el('classPctPresent').textContent = nWithData ? Math.round(totalPct/nWithData)+'%' : '—';
    el('yellowCount').textContent = yellow;
    el('studentCount').textContent = filtered.length;
    // red is not shown on top but stored
    // show red count somewhere if you want
  }

  // ---------- Export features ----------
  async function exportDailyPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:'landscape'});
    doc.setFontSize(12);
    doc.text(`SoMAp Daily Attendance — ${currentClass} — ${currentDateStr}`, 14, 14);
    let y=24;
    doc.setFontSize(10);
    ['No','Adm','Name','AM','PM','Daily','Due','Paid','Bal'].forEach((h,i)=>doc.text(h, 14 + i*30, y));
    y+=6;
    filtered.forEach((s,i)=>{
      const rec = attendanceCache[s.id] || {};
      if(y>180){ doc.addPage('landscape'); y=20; }
      doc.text(String(i+1),14,y); doc.text(String(s.admissionNo||''),44,y); doc.text(String(s.name||''),74,y);
      doc.text(String(rec.am||''),134,y); doc.text(String(rec.pm||''),164,y); doc.text(String(rec.daily||''),194,y);
      doc.text(String(s.feeDue||0),224,y); doc.text(String(s.feePaid||0),254,y); doc.text(String(s.balance||0),284,y);
      y+=6;
    });
    doc.save(`SoMAp_Daily_${currentClass}_${currentDateStr}.pdf`);
  }
  async function exportMonthlyPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(12);
    doc.text(`SoMAp Monthly — ${currentClass} — ${monthKey}`, 14, 14);
    let y=28;
    const workdays = monthWorkingDays(currentDateStr);
    filtered.forEach((s,i)=>{
      if(y>270){ doc.addPage(); y=20; }
      const dates = monthAttendance[s.id]||{};
      let present=0, absent=0;
      Object.keys(dates).forEach(dk=>{
        const r=dates[dk];
        if(r && r.daily==='P') present++; if(r && (r.daily||'').includes('A')) absent++;
      });
      doc.text(`${i+1}. ${s.name} (${s.admissionNo}) — Present: ${present}/${workdays} Absent: ${absent} => ${workdays? Math.round((present/workdays)*100):0}%`, 14, y);
      y+=6;
    });
    doc.save(`SoMAp_Monthly_${currentClass}_${monthKey}.pdf`);
  }
  async function exportPdfForStudent(studentId){
    const s = students.find(x=>x.id===studentId);
    if(!s) return alert('Student not found');
    // Build single-student month summary
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14); doc.text(`Attendance for ${s.name}`, 14, 18);
    doc.setFontSize(11); doc.text(`Admission No: ${s.admissionNo}`, 14, 28);
    // list daily records for monthKey
    const dates = monthAttendance[studentId] || {};
    let y=40;
    const workdays = monthWorkingDays(currentDateStr);
    Object.keys(dates).sort().forEach(dk=>{
      const r = dates[dk];
      doc.text(`${dk}: AM=${r.am||''} PM=${r.pm||''} Daily=${r.daily||''}`, 14, y); y+=6;
      if(y>270){ doc.addPage(); y=20; }
    });
    doc.text(`Summary: ${workdays? 'Workdays: '+workdays : ''}`, 14, y+6);
    doc.save(`Attendance_${s.admissionNo || s.id}_${monthKey}.pdf`);
  }

  // ---------- Archive load range ----------
  async function loadRangeBetween(from, to, cls){
    // loads attendance into UI structure: show only records in that range grouped by date
    if(!db || !cls) return alert('Pick class and ensure connection');
    // for simplicity here we fetch each date between and display counts in console and UI alert
    const start = new Date(from + 'T00:00:00'); const end = new Date(to + 'T00:00:00');
    const days = [];
    for(let d = new Date(start); d<=end; d.setDate(d.getDate()+1)){
      if(isWeekend(new Date(d)) || isHoliday(new Date(d))) continue;
      days.push(fmtDate(new Date(d)));
    }
    // prepare results
    const results = {};
    for(const day of days){
      const mon = toMonthKey(day);
      const snap = await db.ref(`attendance/${cls}/${mon}/${day}`).get();
      const d = snap.exists() ? snap.val() : {};
      let present=0, absent=0;
      Object.keys(d||{}).forEach(k=>{
        const rec = d[k];
        if(rec && rec.daily==='P') present++; if(rec && (rec.daily||'').includes('A')) absent++;
      });
      results[day] = { present, absent };
    }
    // show in modal? For now alert summary
    let text = `Attendance summary for ${cls} from ${from} to ${to}:\n`;
    Object.keys(results).forEach(k=> text += `${k}: P=${results[k].present} A=${results[k].absent}\n`);
    alert(text);
  }

  // ---------- UI wiring ----------
  function wireUI(){
    el('classSelect').addEventListener('change', async (e)=>{
      currentClass = e.target.value; if(!currentClass) return;
      await loadDayAttendance(currentClass, currentDateStr);
      monthKey = toMonthKey(currentDateStr);
      await loadMonthAttendance(currentClass, monthKey);
      renderTable();
      await computeAnalytics();
      check3pmAlert();
    });

    el('dateInput').addEventListener('change', async (e)=>{
      currentDateStr = e.target.value; monthKey = toMonthKey(currentDateStr);
      if(!currentClass) return;
      await loadDayAttendance(currentClass, currentDateStr);
      await loadMonthAttendance(currentClass, monthKey);
      renderTable(); computeAnalytics(); check3pmAlert();
    });

    el('searchInput').addEventListener('input', () => renderTable());
    el('applyQuick').addEventListener('click', ()=>{ applyQuick(); el('saveToast').textContent='Quick applied'; setTimeout(()=>el('saveToast').textContent='',1200); });
    el('markAllPresent').addEventListener('click', ()=>{ markAllPresent(); el('saveToast').textContent='All marked present'; setTimeout(()=>el('saveToast').textContent='',1200); });
    el('saveAll').addEventListener('click', async ()=>{ if(!currentClass) return alert('Pick a class'); await saveDayAttendance(currentClass, currentDateStr); await loadMonthAttendance(currentClass, monthKey); computeAnalytics(); });
    el('btnRangeLoad').addEventListener('click', ()=> loadRangeBetween(el('fromDate').value, el('toDate').value, el('classSelect').value));
    el('applyQuick').addEventListener('click', ()=>applyQuick());
    el('exportDaily').addEventListener('click', ()=>exportDailyPDF());
    el('exportMonthly').addEventListener('click', ()=>exportMonthlyPDF());
    el('exportStudent').addEventListener('click', ()=> {
      const id = prompt('Enter student admission number or ID to export (leave blank to pick first in view):');
      if(!id){
        if(filtered.length) exportPdfForStudent(filtered[0].id);
        else alert('No student selected');
        return;
      }
      const s = students.find(x=> (x.admissionNo||'') === id || x.id === id);
      if(!s) return alert('Student not found');
      exportPdfForStudent(s.id);
    });
    // Fullscreen toggle
    el('btnFullscreen').addEventListener('click', ()=> {
      if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
      else document.exitFullscreen().catch(()=>{});
    });
    // periodic 3pm check
    setInterval(check3pmAlert, 60*1000);
  }

  // ---------- 3PM / absentee alerts ----------
  function check3pmAlert(){
    const now = new Date(); const cut = new Date(now); cut.setHours(SCHOOL_DAY_CUTOFF_HOUR,0,0,0);
    const box = el('todayAlert');
    if(now > cut){
      const need = filtered.some(s=> {
        const rec = attendanceCache[s.id] || {};
        return !(rec.am && rec.pm);
      });
      if(need){ box.textContent = '⚠️ 3:00 PM: Attendance not fully marked for today'; box.classList.remove('hidden'); }
      else { box.classList.add('hidden'); }
    } else { box.classList.add('hidden'); }
  }

  // ---------- Utilities ----------
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

  // ---------- Start ----------
  await init();

  // When user selects class, if students list empty, load students again
  if(!students.length){
    // attempt reload
    students = await loadStudentsFromDb(); populateClassSelect();
  }

  // Show UI state
  el('rtState').textContent = db ? 'Connected' : 'No DB';

})();
</script>
</body>
</html>