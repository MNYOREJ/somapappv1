<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SoMAp — Attendance</title>

<!-- Tailwind for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
  *{font-family:Inter,system-ui,Arial}
  .status-chip{min-width:44px;border-radius:9999px;padding:6px 10px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .chip-P{background:#dcfce7;color:#166534} /* green */
  .chip-A{background:#fee2e2;color:#991b1b} /* red */
  .chip-S{background:#fff7ed;color:#c2410c} /* amber */
  .chip-LE{background:#eef2ff;color:#3730a3} /* indigo */
  .chip-MT{background:#fff7f0;color:#9a3412} /* orange-ish */
  .chip-PG{background:#eef2ff;color:#0b69ff} /* permission blue */
  .chip-empty{background:#f3f4f6;color:#374151;border:1px dashed #e5e7eb}
  .status-pill{padding:4px 8px;border-radius:9999px;font-weight:700}
  .hidden{display:none!important}
  .table th, .table td{padding:8px;border-bottom:1px solid #e6e9ef;white-space:nowrap}
  .table thead th{background:#f8fafc;font-weight:700;position:sticky;top:0}
  .scroll{overflow:auto}
</style>
</head>
<body class="bg-slate-50 min-h-screen">

<header class="bg-white border-b sticky top-0 z-30">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <a href="schoolerp.html" class="text-slate-700 hover:text-blue-600">← Back to ERP</a>
      <h1 class="text-lg font-semibold">SoMAp — Attendance</h1>
    </div>
    <div class="flex items-center gap-3">
      <button id="btnFullscreen" class="px-3 py-1 rounded-md border bg-slate-100">Enter Fullscreen</button>
      <div id="rtState" class="text-sm text-slate-500">Connecting…</div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-4 space-y-4">

  <!-- Top Analytics -->
  <section id="analytics" class="bg-white rounded-2xl p-4 shadow-sm border">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-sm text-slate-500">Analytics — <span id="monthLabel">—</span></div>
        <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="p-3 rounded-xl border bg-[var(--muted,#fbfcfe)]">
            <div class="text-sm text-slate-500">Class Days (excl. weekends & holidays)</div>
            <div id="classDays" class="text-2xl font-bold">—</div>
          </div>
          <div class="p-3 rounded-xl border bg-[var(--muted,#fbfcfe)]">
            <div class="text-sm text-slate-500">% Present (Class Avg)</div>
            <div id="classPctPresent" class="text-2xl font-bold">—</div>
          </div>
          <div class="p-3 rounded-xl border bg-[var(--muted,#fbfcfe)]">
            <div class="text-sm text-slate-500">Yellow Alerts (≥ 10 absent days/month)</div>
            <div id="yellowCount" class="text-2xl font-bold">—</div>
          </div>
        </div>
      </div>
      <div class="w-64">
        <div class="text-sm text-slate-500 mb-2">Archived query</div>
        <div class="grid grid-cols-1 gap-2">
          <input id="fromDate" type="date" class="px-3 py-2 border rounded" />
          <input id="toDate" type="date" class="px-3 py-2 border rounded" />
          <button id="btnRangeLoad" class="px-3 py-2 bg-indigo-600 text-white rounded">Load Range</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Navigation Links -->
  <section class="bg-white rounded-2xl p-4 shadow-sm border">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <a href="Toattendancehtml/classattendance.html" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-center">Class Attendance</a>
      <a href="Toattendancehtml/perstudentattendance.html" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-center">Per-Student Attendance</a>
    </div>
  </section>

</main>

<footer class="bg-white border-t py-3 sticky bottom-0">
  <div class="max-w-6xl mx-auto px-4 text-sm text-slate-500 flex items-center gap-3">
    <div>SoMAp Attendance · Mobile friendly</div>
    <div id="todayAlert" class="ml-auto text-sm text-yellow-700 hidden"></div>
  </div>
</footer>

<!-- Firebase libs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script src="firebase.js"></script>

<script>
(async function(){
  // ---------- CONFIG ----------
  const TZ = 'Africa/Nairobi';
  const SCHOOL_DAY_CUTOFF_HOUR = 15;
  const HOLIDAYS = ['01-01','04-07','04-26','05-01','07-07','08-08','10-14','12-09','12-25','12-26'];
  const MOVABLE = ['2025-03-29','2025-04-01','2025-04-10','2025-04-11','2025-06-16'];

  // ---------- STATE ----------
  let students = [];
  let filtered = [];
  let currentClass = '';
  let currentDateStr = '';
  let monthKey = '';
  let attendanceCache = {};
  let monthAttendance = {};
  let db = null;

  // ---------- HELPERS ----------
  const el = id => document.getElementById(id);
  function fmtDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function toMonthKey(dStr){ const d = new Date(dStr + 'T00:00:00'); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  function isWeekend(d){ const day = d.getDay(); return day===0 || day===6; }
  function isHoliday(d){ const fixed = String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); const iso = fmtDate(d); return HOLIDAYS.includes(fixed) || MOVABLE.includes(iso); }
  function monthWorkingDays(dateStr){
    const d = new Date(dateStr + 'T00:00:00'); const y=d.getFullYear(), m=d.getMonth();
    let count=0;
    for(let day=1; day<=31; day++){
      const dt = new Date(y,m,day); if(dt.getMonth()!==m) break;
      if(isWeekend(dt) || isHoliday(dt)) continue; count++;
    }
    return count;
  }
  function setStatusElem(elm, val){
    if(!elm) return;
    elm.textContent = val || '—';
    elm.className = 'status-pill ' + (val==='P' ? 'bg-green-100 text-green-800' : (val||'').includes('A') ? 'bg-red-100 text-red-700' : (val||'').includes('S') ? 'bg-amber-100 text-amber-800' : 'bg-slate-100 text-slate-700');
  }

  // ---------- FIREBASE: initialize and load students ----------
  async function initializeFirebase() {
    try {
      if (!window.firebase || !window.firebase.apps.length) {
        await new Promise((resolve) => {
          const script = document.createElement('script');
          script.src = 'firebase.js';
          script.onload = resolve;
          script.onerror = () => {
            console.error('Failed to load firebase.js');
            el('rtState').textContent = 'Failed to load firebase.js';
            alert('Error: firebase.js not found. Please check the file path.');
          };
          document.head.appendChild(script);
        });
      }
      db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
      if (!db) {
        throw new Error('Firebase database not initialized');
      }
      el('rtState').textContent = 'Connected to Firebase';
    } catch (e) {
      console.error('Firebase initialization error:', e.message);
      el('rtState').textContent = 'Firebase error: ' + e.message;
      alert('Firebase initialization failed: ' + e.message + '. Please check firebase.js and database rules.');
    }
  }

  async function loadStudentsFromDb() {
    if (!db) return [];
    const tryPaths = ['students', 'Students', 'StudentsList', 'Students_List'];
    for (const p of tryPaths) {
      try {
        const snap = await db.ref(p).get();
        if (snap.exists()) {
          const data = snap.val();
          return Object.keys(data).map(k => {
            const s = data[k] || {};
            const name = [s.firstName, s.middleName, s.lastName].filter(Boolean).join(' ').trim() || s.name || (s.fullName || '');
            const feeDue = Number(s.totalFee || s.feePerYear || s.feeDue || 0);
            const feePaid = Number(s.feesPaid || s.feePaid || s.paidAmount || 0);
            const balance = Number(s.balance || (feeDue - feePaid) || 0);
            return { id: k, admissionNo: s.admissionNumber || s.admNo || s.admissionNo || '', name, class: s.class || s.classLevel || s.grade || 'Unknown', feeDue, feePaid, balance };
          });
        }
      } catch (e) {
        console.warn('Failed to load path', p, ':', e.message);
      }
    }
    console.error('No students data found in any path');
    return [];
  }

  // ---------- Attendance CRUD ----------
  async function loadMonthAttendance(cls, yymm) {
    monthAttendance = {};
    if (!db || !cls) return;
    try {
      const snap = await db.ref(`attendance/${cls}/${yymm}`).get();
      const d = snap.exists() ? snap.val() : {};
      Object.keys(d).forEach(dateKey => {
        const byStu = d[dateKey] || {};
        Object.keys(byStu).forEach(stuId => {
          monthAttendance[stuId] = monthAttendance[stuId] || {};
          monthAttendance[stuId][dateKey] = byStu[stuId];
        });
      });
    } catch (e) {
      console.warn('Failed to load month attendance:', e.message);
    }
  }

  // ---------- Analytics compute ----------
  async function computeAnalytics() {
    const workdays = monthWorkingDays(currentDateStr);
    el('classDays').textContent = workdays;
    el('monthLabel').textContent = monthKey;

    let totalPct = 0, nWithData = 0;
    let yellow = 0;
    const [y, m] = monthKey.split('-').map(Number);
    const monthsToCheck = [];
    for (let k = 0; k < 3; k++) {
      const dt = new Date(y, m - 1 - k, 1);
      monthsToCheck.push(`${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`);
    }

    const threeMonthAttendance = {};
    for (const mon of monthsToCheck) {
      try {
        const snap = await db.ref(`attendance/${currentClass}/${mon}`).get();
        const data = snap.exists() ? snap.val() : {};
        Object.keys(data).forEach(dateKey => {
          const byStu = data[dateKey] || {};
          Object.keys(byStu).forEach(sid => {
            threeMonthAttendance[sid] = threeMonthAttendance[sid] || {};
            threeMonthAttendance[sid][dateKey] = byStu[sid];
          });
        });
      } catch (e) {
        console.warn(`Failed to load attendance for ${mon}:`, e.message);
      }
    }

    filtered.forEach(s => {
      const dates = monthAttendance[s.id] || {};
      let present = 0, absent = 0;
      Object.keys(dates).forEach(dk => {
        const rec = dates[dk];
        if (rec && rec.daily === 'P') present++;
        if (rec && (rec.daily || '').includes('A')) absent++;
      });
      const pct = workdays ? Math.round((present / workdays) * 100) : 0;
      if (workdays) { totalPct += pct; nWithData++; }
      if (absent >= 10) yellow++;
    });

    el('classPctPresent').textContent = nWithData ? Math.round(totalPct / nWithData) + '%' : '—';
    el('yellowCount').textContent = yellow;
  }

  // ---------- Archive load range ----------
  async function loadRangeBetween(from, to, cls) {
    if (!db || !cls) return alert('Pick class and ensure connection');
    const start = new Date(from + 'T00:00:00');
    const end = new Date(to + 'T00:00:00');
    const days = [];
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      if (isWeekend(d) || isHoliday(d)) continue;
      days.push(fmtDate(new Date(d)));
    }
    const results = {};
    for (const day of days) {
      const mon = toMonthKey(day);
      try {
        const snap = await db.ref(`attendance/${cls}/${mon}/${day}`).get();
        const d = snap.exists() ? snap.val() : {};
        let present = 0, absent = 0;
        Object.keys(d || {}).forEach(k => {
          const rec = d[k];
          if (rec && rec.daily === 'P') present++;
          if (rec && (rec.daily || '').includes('A')) absent++;
        });
        results[day] = { present, absent };
      } catch (e) {
        console.warn(`Failed to load attendance for ${day}:`, e.message);
      }
    }
    let text = `Attendance summary for ${cls} from ${from} to ${to}:\n`;
    Object.keys(results).forEach(k => text += `${k}: P=${results[k].present} A=${results[k].absent}\n`);
    alert(text);
  }

  // ---------- UI wiring ----------
  function wireUI() {
    el('btnRangeLoad').addEventListener('click', () => loadRangeBetween(el('fromDate').value, el('toDate').value, currentClass));
    el('btnFullscreen').addEventListener('click', () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
      else document.exitFullscreen().catch(() => {});
    });
    setInterval(check3pmAlert, 60 * 1000);
  }

  // ---------- 3PM alert ----------
  function check3pmAlert() {
    const now = new Date();
    const cut = new Date(now);
    cut.setHours(SCHOOL_DAY_CUTOFF_HOUR, 0, 0, 0);
    const box = el('todayAlert');
    if (now > cut) {
      const need = filtered.some(s => {
        const rec = attendanceCache[s.id] || {};
        return !(rec.am && rec.pm);
      });
      if (need) {
        box.textContent = '⚠️ 3:00 PM: Attendance not fully marked for today';
        box.classList.remove('hidden');
      } else {
        box.classList.add('hidden');
      }
    } else {
      box.classList.add('hidden');
    }
  }

  // ---------- Utilities ----------
  function escapeHtml(s) {
    if (!s) return '';
    return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
  }

  // ---------- Start ----------
  async function init() {
    const now = new Date();
    currentDateStr = fmtDate(now);
    monthKey = toMonthKey(currentDateStr);
    el('fromDate').value = currentDateStr;
    el('toDate').value = currentDateStr;

    await initializeFirebase();
    if (!db) return;

    el('rtState').textContent = 'Loading students...';
    for (let attempt = 1; attempt <= 3; attempt++) {
      students = await loadStudentsFromDb();
      if (students.length) break;
      console.warn(`Attempt ${attempt} failed to load students. Retrying...`);
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    if (!students.length) {
      el('rtState').textContent = 'No students found';
      alert('No students found in database. Please check Firebase data at /students.');
      return;
    }
    el('rtState').textContent = 'Ready';
    wireUI();
    if (students.length && !currentClass) {
      const classes = Array.from(new Set(students.map(s => s.class))).sort();
      if (classes.length === 1) {
        currentClass = classes[0];
        computeAnalytics();
      }
    }
  }

  await init();
  el('rtState').textContent = db ? 'Connected' : 'No DB';
})();
</script>
</body>
</html>