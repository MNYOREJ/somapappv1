<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <script src="Todashboardhtml/yearContext.js"></script>
    <title>SoMAp - Society Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* ==== SoMAp anti-overlap + responsive overrides ==== */
        *, *::before, *::after { box-sizing: border-box; }
        .app-header h1, .app-header .title,
        .section h1, .section h2, .section h3, .section p,
        .card, .card *,
        .stat-card, .stat-card *,
        .badge, .pill, .menu-group h3,
        .workspace .grid, .workspace .grid * {
          white-space: normal !important;
          overflow-wrap: anywhere;
          word-break: break-word;
        }
        .workspace, .section, .card, .stat-card, .grid, .row {
          min-width: 0;
        }
        .layout-row, .grid, .row {
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
        }
        .card, .stat-card {
          flex: 1 1 280px;
          min-width: 240px;
        }
        img, video, canvas {
          max-width: 100%;
          height: auto;
        }
        .workspace { margin-left: 64px; }
        @media (max-width: 768px) {
          .workspace { margin-left: 56px; }
        }
        @media (max-width: 560px) {
          .workspace { margin-left: 0; }
          .sidebar { position: fixed; transform: translateX(-100%); transition: transform .2s ease; }
          .has-sidebar-open .sidebar { transform: none; }
        }
        :root {
          --primary: #4f46e5;
          --secondary: #818cf8;
          --success: #10b981;
          --danger: #ef4444;
          --warning: #f59e0b;
          --info: #06b6d4;
          --light-bg: #f9fafb;
          --border: #e5e7eb;
        }
        body {
          font-family: 'Inter', system-ui, -apple-system, sans-serif;
          overflow-x: hidden;
          background: linear-gradient(135deg, #007bff, #6610f2);
          color: #fff;
          min-height: 100vh;
        }
        .sidebar-icon {
          position: relative;
          transition: all 0.3s;
        }
        .sidebar-icon:hover {
          background-color: rgba(79, 70, 229, 0.1);
        }
        .sidebar-icon.active {
          background-color: var(--primary);
          color: white;
        }
        .sidebar-tooltip {
          position: absolute;
          left: 100%;
          top: 50%;
          transform: translateY(-50%);
          background: #1f2937;
          color: white;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 0.75rem;
          opacity: 0;
          pointer-events: none;
          transition: all 0.2s;
          z-index: 100;
          white-space: nowrap;
        }
        .sidebar-icon:hover .sidebar-tooltip {
          opacity: 1;
          transform: translateY(-50%) translateX(8px);
        }
        .module-panel {
          transition: transform 0.3s ease-in-out;
          transform: translateX(100%);
          box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        }
        .module-panel.active {
          transform: translateX(0);
        }
        .card {
          border-radius: 0.75rem;
          box-shadow: 0 25px 45px rgba(15, 23, 42, 0.35);
          transition: all 0.3s;
          background: rgba(15, 23, 42, 0.55);
          border: 1px solid rgba(148, 163, 184, 0.25);
          color: #f8fafc;
          backdrop-filter: blur(18px);
        }
        .card:hover {
          transform: translateY(-6px);
          box-shadow: 0 35px 60px rgba(15, 23, 42, 0.45);
        }
        .stat-card {
          transition: all 0.3s;
          background: linear-gradient(135deg, rgba(59,130,246,0.65), rgba(14,165,233,0.52));
          color: #f8fafc;
          border: 1px solid rgba(191,219,254,0.4);
          backdrop-filter: blur(14px);
        }
        .stat-card:hover {
          transform: translateY(-4px);
        }
        .btn {
          transition: all 0.2s;
        }
        .btn:hover {
          transform: translateY(-1px);
        }
        .btn:active {
          transform: translateY(0);
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .fade-in {
          animation: fadeIn 0.3s ease-in-out;
        }
        .loader {
          border-top-color: var(--primary);
          animation: spinner 0.6s linear infinite;
        }
        @keyframes spinner {
          to {
            transform: rotate(360deg);
          }
        }
        ::-webkit-scrollbar {
          width: 6px;
          height: 6px;
        }
        ::-webkit-scrollbar-track {
          background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
          background: #c1c1c1;
          border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
          background: #a1a1a1;
        }
        .workspace {
          flex: 1 1 auto;
          min-width: 0;
          overflow-x: hidden;
          overflow-y: auto;
          background: linear-gradient(135deg, #007bff, #6610f2);
          padding: 1rem;
          transition: margin-left 0.3s ease;
        }
        .grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 1.5rem;
          max-width: 100%;
          word-break: break-word;
        }
        .stat-card .mt-4, .card .mt-4 {
          flex-wrap: wrap;
          gap: 0.5rem;
        }
        @media (min-width: 1024px) {
          .grid {
            gap: 2rem;
          }
          .workspace {
            padding: 1.5rem;
          }
        }
        @media (max-width: 767px) {
          .grid {
            grid-template-columns: 1fr;
          }
          .workspace {
            padding: 0.5rem;
          }
        }
        .tab-content {
          display: none;
        }
        .tab-content.active {
          display: block;
          animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.1); }
          100% { transform: scale(1); }
        }
        .badge-pulse {
          animation: pulse 2s infinite;
        }
        .sidebar-logo {
          height: 40px;
          width: auto;
          max-width: 100%;
          display: block;
          margin: 0 auto;
        }
        .sidebar-expanded .sidebar-logo {
          height: 48px;
        }
        @media (max-width: 480px) {
          .sidebar-logo { height: 32px; }
        }
        .navbar {
          background: linear-gradient(135deg, #28a745, #20c997);
          box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .sidebar {
          background: linear-gradient(to bottom, #fd7e14, #ffc107);
          height: 100vh;
          padding: 20px;
          position: fixed;
          width: 64px;
          overflow-y: auto;
          box-shadow: 2px 0 10px rgba(0,0,0,0.1);
          transition: width 0.3s ease;
        }
        .sidebar-expanded .sidebar {
          width: 250px;
        }
        .sidebar a, .sidebar button {
          color: #fff;
          text-decoration: none;
          display: block;
          padding: 10px;
          border-radius: 5px;
          margin-bottom: 10px;
          transition: background 0.3s;
        }
        .sidebar a:hover, .sidebar button:hover {
          background-color: rgba(255,255,255,0.2);
        }
        .main-content {
          margin-left: 64px;
          padding: 20px;
          transition: margin-left 0.3s ease;
        }
        .sidebar-expanded .main-content {
          margin-left: 250px;
        }
        .welcome-note {
          background: linear-gradient(135deg, #6f42c1, #d63384);
          padding: 50px;
          text-align: center;
          border-radius: 20px;
          margin: 50px auto;
          max-width: 800px;
          box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .market-section {
          background: linear-gradient(135deg, #dc3545, #fd7e14);
          padding: 30px;
          border-radius: 15px;
          color: #fff;
        }
        .market-img {
          width: 100%;
          height: 250px;
          object-fit: cover;
          border-radius: 10px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .quick-action-btn {
          background: linear-gradient(135deg, #198754, #20c997);
          color: #fff;
          border: none;
          margin: 10px;
          padding: 15px 30px;
          border-radius: 10px;
          font-weight: bold;
          transition: opacity 0.3s;
        }
        .quick-action-btn:hover {
          opacity: 0.9;
        }
        #language-select {
          margin: 20px auto;
          width: 200px;
          background: #fff;
          color: #000;
          border: 2px solid #ced4da;
          border-radius: 10px;
        }
        .events-list {
          list-style: none;
          padding: 0;
        }
        .events-list li {
          background: #fff;
          color: #000;
          padding: 15px;
          margin: 10px 0;
          border-radius: 10px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chart-container {
          background: #fff;
          padding: 20px;
          border-radius: 15px;
          margin-bottom: 20px;
        }
        .footer {
          background-color: #343a40;
          color: #fff;
          padding: 20px;
          text-align: center;
          margin-top: 50px;
          border-top: 2px solid #fff;
        }
        .role-specific {
          display: none;
        }
        .module-section {
          background: linear-gradient(135deg, #ffc107, #fd7e14);
          padding: 30px;
          border-radius: 15px;
          margin-bottom: 30px;
          color: #000;
        }
        .attendance-trends {
          background: #fff;
          padding: 20px;
          border-radius: 10px;
        }
        .discipline-card {
          background: linear-gradient(135deg, #dc3545, #f55);
        }
        .finance-overview {
          background: linear-gradient(135deg, #28a745, #198754);
        }
        .resource-card {
          background: linear-gradient(135deg, #0dcaf0, #20c997);
        }
        .communication-stats {
          background: linear-gradient(135deg, #6610f2, #6f42c1);
        }
        .ai-insights {
          background: linear-gradient(135deg, #d63384, #dc3545);
          color: #fff;
        }
        .volunteer-section {
          background: linear-gradient(135deg, #ffc107, #ffca2c);
        }
        .calendar {
          background: #fff;
          padding: 20px;
          border-radius: 10px;
        }
        .hidden {
          display: none;
        }
        .btn-custom {
          background-color: #6f42c1;
          color: #fff;
          border-radius: 50px;
          padding: 10px 20px;
        }
        .form-control-custom {
          border-radius: 10px;
          border: 2px solid #ced4da;
        }
        h1, h2, h3, h4, h5, h6 {
          color: #fff;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .card h5, .card p, .events-list li {
          color: #f8fafc;
          text-shadow: none;
        }
        p {
          line-height: 1.6;
        }
        .img-fluid {
          border-radius: 10px;
        }
        .section-padding {
          padding: 40px 0;
        }
        .card-body {
          padding: 20px;
        }
        /* New Finance Cards in Dashboard */
        .finance-card {
          background: linear-gradient(135deg, rgba(99,102,241,0.85), rgba(16,185,129,0.7));
          color: #f8fafc;
          border-radius: 1rem;
          padding: 20px;
          margin-bottom: 20px;
          border: 1px solid rgba(191, 219, 254, 0.35);
          box-shadow: 0 30px 50px rgba(15, 23, 42, 0.4);
          backdrop-filter: blur(18px);
        }
        .finance-card h5 {
          color: #f8fafc;
          text-shadow: 1px 1px 2px rgba(15,23,42,0.4);
        }
        .finance-card p {
          font-size: 1.6rem;
          font-weight: 700;
        }
    </style>

    <script>
    /** Year range + anchor **/
    const SOMAP_ALLOWED_YEARS = Array.from({length: 20}, (_,i)=>2023+i); // 2023..2042
    const SOMAP_DEFAULT_YEAR = 2025;

    /** Tanzania class ladder (no Class 8). Keep labels EXACTLY. */
    const CLASS_ORDER = ['Baby Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
    const L = s => String(s||'').trim().toLowerCase();

    /** Shift a base class by delta years relative to anchor (2025). */
    function shiftClass(baseClass, deltaYears){
      const i = CLASS_ORDER.findIndex(c => L(c)===L(baseClass));
      if (i<0) return baseClass||'';
      const j = i + Number(deltaYears||0);
      if (j < 0) return 'PRE-ADMISSION';
      if (j >= CLASS_ORDER.length) return 'GRADUATED';
      return CLASS_ORDER[j];
    }
    </script>

    <script>
    /** Reuse shared year context if present, else create a light fallback. */
    window.somapYearContext = window.somapYearContext || (function(){
      let selected = (sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR)+'';
      const listeners = new Set();
      return {
        getSelectedYear(){ return selected; },
        setSelectedYear(y){
          y = String(y);
          if (selected===y) return;
          selected = y;
          try{ sessionStorage.setItem('somap_selected_year', y); }catch(_e){}
          listeners.forEach(fn=>{ try{ fn(y); }catch(err){ console.error(err); } });
        },
        onYearChanged(fn){ if (typeof fn==='function') listeners.add(fn); }
      };
    })();
    </script>

    <script src="shared/finance_math.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-500 to-purple-600 overflow-hidden">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="flex flex-col h-full bg-gradient-to-b from-orange-500 to-yellow-400 shadow-md p-1 relative z-10 hidden" style="width: 64px; transition: width 0.3s ease;">
            <div class="flex items-center justify-center h-14 mb-2">
                <img src="images/somap-logo.png.jpg" alt="SoMAp Logo" class="sidebar-logo">
            </div>
            <div class="flex-1 overflow-y-auto">
                <div class="flex flex-col space-y-1">
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto active" data-module="dashboard">
                        <i class="fas fa-th-large text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-dashboard">Dashboard</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-dashboard-expanded">Dashboard</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="erp">
                        <i class="fas fa-user-graduate text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-academic">Academic</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-academic-expanded">Academic</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="attendance">
                        <i class="fas fa-check-circle text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-attendance">Attendance</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-attendance-expanded">Attendance</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="discipline">
                        <i class="fas fa-exclamation-circle text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-discipline">Discipline</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-discipline-expanded">Discipline</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="finance">
                        <i class="fas fa-money-bill-wave text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-finance">Finance</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-finance-expanded">Finance</span>
                    </button>
                    <a href="Bookshtml/upload.html" class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto">
    <i class="fas fa-book text-xl"></i>
    <span class="sidebar-tooltip" id="sidebar-resources">Books</span>
    <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-resources-expanded">Books</span>
</a>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="communications">
                        <i class="fas fa-comment-alt text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-communications">Communications</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-communications-expanded">Communications</span>
                        <span class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center badge-pulse">5</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="market">
                        <i class="fas fa-store text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-market">Market</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-market-expanded">Market</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="ai-insights">
                        <i class="fas fa-robot text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-ai-insights">AI Insights</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-ai-insights-expanded">AI Insights</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="volunteers">
                        <i class="fas fa-people-carry text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-volunteers">Volunteers</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-volunteers-expanded">Volunteers</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="events">
                        <i class="fas fa-calendar-alt text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-events">Events</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-events-expanded">Events</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" onclick="window.location.href='preformonehtml/prefonedashboard.html';">
    <i class="fas fa-graduation-cap text-xl text-blue-500"></i>
    <span class="sidebar-tooltip" id="sidebar-preformone">Preform One</span>
    <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-preformone-expanded">Preform One</span>
</button>
                    <button id="graduationShortcut" class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" style="display:none;" onclick="window.location.href='Tostaffhtml/graduation.html';">
                        <i class="fas fa-trophy text-xl text-amber-300"></i>
                        <span class="sidebar-tooltip">Graduation</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium">Graduation</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto role-specific admin-only" data-module="admin-tools">
                        <i class="fas fa-tools text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-admin-tools">Admin Tools</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-admin-tools-expanded">Admin Tools</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto role-specific teacher-only" data-module="class-tools">
                        <i class="fas fa-chalkboard-teacher text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-class-tools">Class Tools</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-class-tools-expanded">Class Tools</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto role-specific accountant-only" data-module="finance-tools">
                        <i class="fas fa-calculator text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-finance-tools">Finance Tools</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-finance-tools-expanded">Finance Tools</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto role-specific parent-only" data-module="child-info">
                        <i class="fas fa-child text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-child-info">Child Info</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-child-info-expanded">Child Info</span>
                    </button>
                    <button id="logout" class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                        <span class="sidebar-tooltip" id="sidebar-logout">Logout</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium" id="sidebar-logout-expanded">Logout</span>
                    </button>
                </div>
            </div>
            <div class="mt-2 mb-1">
                <button id="toggle-sidebar" class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto">
                    <i class="fas fa-chevron-right text-sm sidebar-collapsed"></i>
                    <i class="fas fa-chevron-left text-sm sidebar-expanded hidden"></i>
                    <span class="sidebar-tooltip">Toggle Menu</span>
                </button>
                <div class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto mt-1">
                    <img src="https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png" alt="Profile" class="rounded-full h-8 w-8 object-cover">
                    <span class="sidebar-tooltip">Profile</span>
                    <span class="sidebar-expanded hidden ml-3 text-sm font-medium">Admin</span>
                </div>
            </div>
        </div>
        <!-- Main workspace -->
        <div class="workspace flex-1 min-w-0 overflow-x-hidden overflow-y-auto bg-gradient-to-br from-blue-500 to-purple-600 transition-all">
            <header class="bg-white shadow-sm">
                <div class="flex items-center justify-between px-6 py-3">
                    <div>
                        <h1 id="page-title" class="text-xl font-semibold text-gray-800">SoMAp - SOCIETY MANAGEMENT APP</h1>
                    </div>
                      <div class="flex items-center space-x-4">
                          <div id="somapYearWrap" class="flex flex-col md:flex-row md:items-center md:space-x-3 text-xs font-semibold text-gray-500">
                              <div class="flex flex-col">
                                  <span class="uppercase tracking-wide mb-1 text-[0.65rem] text-gray-500">Academic Year</span>
                                  <select
                                      data-somap-year-select
                                      class="min-w-[140px] rounded-lg border border-gray-300 bg-white px-3 py-1 text-sm font-medium text-gray-700 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                                  </select>
                              </div>
                              <span class="text-[0.7rem] text-gray-600 mt-1 md:mt-0">Working year: <b id="somapYearHint">--</b></span>
                          </div>
                          <div class="relative">
                              <input type="text" class="px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500 w-64" placeholder="Search...">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                        <button class="p-2 rounded-lg hover:bg-gray-100">
                            <i class="far fa-bell text-gray-500 relative">
                                <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">3</span>
                            </i>
                        </button>
                        <button class="p-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-cog text-gray-500"></i>
                        </button>
              </div>
          </div>
          <div class="px-6 pb-3 md:hidden">
              <label class="mb-2 block text-xs font-semibold uppercase tracking-wide text-gray-500">Academic Year</label>
              <select
                  data-somap-year-select
                  class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200">
              </select>
              <p class="mt-2 text-xs text-gray-600">Working year: <b id="somapYearHintMobile">--</b></p>
          </div>
      </header>
            <!-- Main Dashboard -->
            <div id="main-dashboard" class="main-content">
                <nav class="navbar navbar-expand-lg">
                    <div class="container-fluid">
                        <a class="navbar-brand text-white" href="#">SoMAp Dashboard</a>
                        <div class="collapse navbar-collapse">
                            <ul class="navbar-nav ms-auto">
                                <li class="nav-item"><a class="nav-link text-white" href="#market">SoMAp Market</a></li>
                                <li class="nav-item"><a class="nav-link text-white" href="#schools">Schools</a></li>
                            </ul>
                        </div>
                    </div>
                </nav>
                <!-- Dashboard Overview -->
                <section id="dashboard" class="section-padding">
                    <h2>Dashboard Overview</h2>
                    <div class="row grid">
                        <div class="col-md-3">
                            <div class="card stat-card stats-card">
                                <div class="card-body">
                                    <h5>Total Students</h5>
                                    <p id="total-students">Loading... <small>5.2% Since last month</small></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card stats-card">
                                <div class="card-body">
                                    <h5>Attendance Rate</h5>
                                    <p id="attendance-rate">Loading... <small>1.5% Since last month</small></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card stats-card">
                                <div class="card-body">
                                    <h5>Upcoming Events</h5>
                                    <p id="upcoming-events">Loading... <small>2 new This week</small></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
  <div class="finance-card">
    <h5>Total Due (All Students)</h5>
    <p id="total-due">TSh 0</p>
  </div>
</div>
<div class="col-md-3">
  <div class="finance-card">
    <h5>Total Collected</h5>
    <p id="total-collected">TSh 0</p>
  </div>
</div>
<div class="col-md-3">
  <div class="finance-card">
    <h5>Total Outstanding</h5>
    <p id="total-outstanding">TSh 0</p>
  </div>
</div>
<div class="col-md-3">
  <div class="finance-card">
    <h5>Total Expenses</h5>
    <p id="total-expenses">TSh 0</p>
  </div>
</div>
<div class="col-md-3">
  <div class="finance-card">
    <h5>Net Balance</h5>
    <p id="net-balance">TSh 0</p>
  </div>
</div>
<div class="col-md-3">
  <div class="card stat-card stats-card glass-panel">
    <div class="card-body">
      <h5>Students Today</h5>
      <p><span id="students-present-today">--</span> Present</p>
      <p><span id="students-absent-today">--</span> Absent</p>
      <p class="text-sm text-slate-300">Boys: <span id="students-boys-count">--</span> · Girls: <span id="students-girls-count">--</span></p>
    </div>
  </div>
</div>
<div class="col-md-3">
  <div class="card stat-card stats-card glass-panel">
    <div class="card-body">
      <h5>Workers Snapshot</h5>
      <p>Total: <span id="workers-total-count">--</span></p>
      <p><span id="workers-present-count">--</span> Present · <span id="workers-absent-count">--</span> Absent</p>
      <p class="text-sm text-slate-300">Male: <span id="workers-male-count">--</span> · Female: <span id="workers-female-count">--</span></p>
    </div>
  </div>
</div>
<div class="col-md-3 role-specific admin-only" id="approvalsShortcut">
  <div class="card stat-card stats-card" style="background: linear-gradient(135deg, rgba(56,189,248,0.35), rgba(14,165,233,0.22)); color: #0f172a;">
    <div class="card-body">
      <h5>Payment Approvals</h5>
      <p>Review pending payments before they hit the ledgers.</p>
      <a href="Todashboardhtml/approvals.html" class="btn quick-action-btn role-specific admin-only" style="margin-top: 0.75rem; background: rgba(15,23,42,0.85); color: #e0f2fe; border: 1px solid rgba(56,189,248,0.45);">Open Approvals</a>
    </div>
  </div>
</div>
</div>
                </section>
                <!-- Fee Collection Trends Chart -->
                <section id="fee-trends" class="module-section">
                    <h2>Fee Collection Trends</h2>
                    <div class="chart-container">
                        <canvas id="fee-chart"></canvas>
                    </div>
                </section>
                <!-- Quick Actions -->
                <section id="quick-actions" class="module-section">
                    <h2>Quick Actions</h2>
                    <div class="row grid">
                        <button class="btn quick-action-btn role-specific accountant-only">New Admission</button>
                        <button class="btn quick-action-btn role-specific accountant-only">Record Payment</button>
                        <button class="btn quick-action-btn">Send Announcement</button>
                        <button class="btn quick-action-btn">Generate Reports</button>
                        <a class="btn quick-action-btn role-specific admin-only" href="workershtml/workersadmission.html">Open Workers Hub</a>
                    </div>
                </section>
                <!-- Recent Activities -->
                <section id="activities" class="module-section">
                    <h2>Recent Activities</h2>
                    <ul class="events-list" id="activities-list">
                        <li>Loading...</li>
                    </ul>
                    <button class="btn quick-action-btn">View All</button>
                </section>
                <!-- Upcoming Events -->
                <section id="upcoming-events" class="module-section">
                    <h2>Upcoming Events</h2>
                    <ul class="events-list" id="events-list">
                        <li>Loading...</li>
                    </ul>
                    <button class="btn quick-action-btn">View Calendar</button>
                </section>
                <!-- Academic Module -->
                <section id="academic" class="module-section role-specific teacher-only admin-only">
                    <h2>Academic Management</h2>
                    <div class="row grid">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5>Class Assignment</h5>
                                    <p>Manage student class assignments.</p>
                                    <button class="btn quick-action-btn">Assign Students</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5>Timetables</h5>
                                    <p>Create and manage timetables.</p>
                                    <button class="btn quick-action-btn">Create Timetable</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5>Exam Management</h5>
                                    <p>Schedule examinations.</p>
                                    <button class="btn quick-action-btn">Schedule Exam</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Attendance Module -->
                <section id="attendance" class="module-section role-specific teacher-only admin-only">
                    <h2>Attendance</h2>
                    <div class="row grid">
                        <div class="col-md-6">
                            <div class="card attendance-trends">
                                <h5>Today's Attendance</h5>
                                <p id="today-attendance">Loading...</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h5>Attendance Trends</h5>
                                <canvas id="attendance-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <button class="btn quick-action-btn">Mark Attendance</button>
                    <a class="btn quick-action-btn" href="Toattendancehtml/shiftedkids.html">Shifted Students Hub</a>
                </section>
                <!-- Discipline Module -->
                <section id="discipline" class="module-section role-specific teacher-only admin-only">
                    <h2>Discipline Records</h2>
                    <p>Track student discipline cases.</p>
                    <ul class="events-list" id="discipline-list">
                        <li>Loading...</li>
                    </ul>
                    <button class="btn quick-action-btn">Add Incident</button>
                </section>
                <!-- Finance Module -->
                <section id="finance" class="finance-overview module-section role-specific accountant-only admin-only">
                    <h2>Finance</h2>
                    <div class="row grid">
                        <div class="col-md-6">
                            <div class="card">
                                <h5>Fee Collection Overview</h5>
                                <p id="fee-overview">Loading...</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <h5>Recent Fee Payments</h5>
                                <ul class="events-list" id="recent-payments">
                                    <li>Loading...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <button class="btn quick-action-btn">Record Payment</button>
                    <button class="btn quick-action-btn">Create New Admission</button>
                </section>
                <!-- Resources Module -->
                <section id="resources" class="resource-card module-section role-specific teacher-only admin-only">
                    <h2>Digital Resources</h2>
                    <p>Access educational resources.</p>
                    <div class="row grid">
                        <div class="col-md-4">
                            <div class="card">
                                <h5>Cell Biology</h5>
                                <p>PDF • 2.4 MB</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <h5>Algebra Problems</h5>
                                <p>PDF • 1.8 MB</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <h5>African History</h5>
                                <p>Video • 15:24 min</p>
                            </div>
                        </div>
                    </div>
                    <button class="btn quick-action-btn">Upload Resource</button>
                    <div class="card mt-3">
                        <h5>Resource Metrics</h5>
                        <p id="resource-metrics">Loading...</p>
                    </div>
                </section>
                <!-- Communications Module -->
                <section id="communications" class="communication-stats module-section">
                    <h2>Communications</h2>
                    <div class="row grid">
                        <div class="col-md-6">
                            <div class="card">
                                <h5>Recent Messages</h5>
                                <ul class="events-list" id="recent-messages">
                                    <li>Loading...</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <h5>Communication Statistics</h5>
                                <p id="comm-stats">Loading...</p>
                            </div>
                        </div>
                    </div>
                    <button class="btn quick-action-btn">Send Announcement</button>
                </section>
                <!-- Market Section -->
                <section id="market" class="market-section">
                    <h2>SoMAp Market - Available Goods</h2>
                    <p>Explore school essentials like uniforms and supplies.</p>
                    <div class="row grid">
                        <div class="col-md-3">
                            <img src="https://images.pexels.com/photos/5212324/pexels-photo-5212324.jpeg" alt="School Uniform" class="market-img">
                            <p>Grey Trousers, Skirts, White Shirts, Grey Sweaters</p>
                        </div>
                        <div class="col-md-3">
                            <img src="https://images.pexels.com/photos/1280942/pexels-photo-1280942.jpeg" alt="Black Shoes" class="market-img">
                            <p>Black Shoes</p>
                        </div>
                        <div class="col-md-3">
                            <img src="https://images.pexels.com/photos/247879/pexels-photo-247879.jpeg" alt="Bags of Maize" class="market-img">
                            <p>Bags of Maize, Beans, Cereals</p>
                        </div>
                        <div class="col-md-3">
                            <img src="https://images.pexels.com/photos/163064/pexels-photo-163064.jpeg" alt="Stationaries" class="market-img">
                            <p>Stationeries</p>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <h5>Marketplace Overview</h5>
                        <p id="market-overview">Loading...</p>
                    </div>
                    <button class="btn quick-action-btn">View All Products</button>
                </section>
                <!-- AI Insights -->
                <section id="ai-insights" class="ai-insights module-section">
                    <h2>AI-Powered Insights</h2>
                    <div class="row grid">
                        <div class="col-md-4">
                            <div class="card">
                                <h5>Students at Risk</h5>
                                <p id="students-at-risk">Loading...</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <h5>Financial Forecasts</h5>
                                <p id="financial-forecasts">Loading...</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <h5>AI Assistant</h5>
                                <input type="text" class="form-control" placeholder="Ask about school data...">
                                <button class="btn quick-action-btn mt-2">Ask AI</button>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Volunteers Module -->
                <section id="volunteers" class="volunteer-section module-section">
                    <h2>Volunteers & Exchanges</h2>
                    <div class="row grid">
                        <div class="col-md-6">
                            <div class="card">
                                <h5>Current Volunteers</h5>
                                <ul class="events-list" id="current-volunteers">
                                    <li>Loading...</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <h5>Volunteer Hours</h5>
                                <p id="volunteer-hours">Loading...</p>
                            </div>
                        </div>
                    </div>
                    <button class="btn quick-action-btn role-specific admin-only">Manage Volunteers</button>
                </section>
                <!-- Events Planning -->
                <section id="events" class="module-section">
                    <h2>Events Management</h2>
                    <div class="calendar">
                        <h5>September 2025 Calendar</h5>
                        <p id="calendar-view">Loading...</p>
                    </div>
                    <div class="card mt-3">
                        <h5>Upcoming Event</h5>
                        <p id="upcoming-event-details">Loading...</p>
                    </div>
                    <button class="btn quick-action-btn role-specific admin-only">Create Event</button>
                </section>
                <!-- Admin Tools -->
                <section id="admin-tools" class="module-section role-specific admin-only">
                    <h2>Admin Tools</h2>
                    <p>Manage schools, users, etc.</p>
                    <div class="card">
                        <h5>Add New School</h5>
                        <form id="add-school-form">
                            <input type="text" class="form-control mb-2" id="school-name" placeholder="School Name">
                            <button type="submit" class="btn quick-action-btn">Add School</button>
                        </form>
                        <ul id="school-list">
                            <li>Socrates School</li>
                            <li>Mnyore Academy</li>
                        </ul>
                    </div>
                    <div class="card mt-3">
                        <h5>Transport Hub · Bwalo la Usafiri</h5>
                        <p>Vehicle management, payments, fuel, maintenance — all transport controls in one place.</p>
                        <div class="quick-action-group" style="display:flex; gap:0.75rem; flex-wrap:wrap;">
                            <a class="btn quick-action-btn" href="transporthtml/transport.html">
                                Open Transport Hub
                            </a>
                            <a class="btn quick-action-btn secondary" href="transporthtml/transportattendance.html">
                                Open Transport Attendance
                            </a>
                            <a class="btn quick-action-btn" href="Tofinancehtml/paymentedits.html">
                                Payments Config (Plans, Fees & Overrides)
                            </a>
                        </div>
                    </div>
                </section>
                <!-- Class Tools for Teachers -->
                <section id="class-tools" class="module-section role-specific teacher-only">
                    <h2>Class Tools</h2>
                    <p>Manage your class: Attendance, Students, etc.</p>
                    <select id="class-stream" class="form-select mb-3">
                        <option>Select Stream (e.g., A or B)</option>
                    </select>
                    <button class="btn quick-action-btn">View Student List</button>
                </section>
                <!-- Finance Tools for Accountant -->
                <section id="finance-tools" class="module-section role-specific accountant-only">
                    <h2>Finance Tools</h2>
                    <p>Manage admissions, fees.</p>
                    <button class="btn quick-action-btn">Create New Admission</button>
                    <button class="btn quick-action-btn">Check Fees</button>
                </section>
                <!-- Child Info for Parents -->
                <section id="child-info" class="module-section role-specific parent-only">
                    <h2>Your Child's Info</h2>
                    <p>Details, attendance, fees, etc.</p>
                    <div id="child-details">Loading...</div>
                </section>
                <!-- Footer -->
                <footer class="footer">
                    <p>&copy; 2025 SoMAp - Built for excellence in education. Integrated with Firebase.</p>
                </footer>
            </div>
        </div>
    </div>
    <script>
     // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
    };
    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();
    const GRAD_EMAILS = new Set(['ssclass42023@gmail.com','socratesschool2020@gmail.com']);
    // Language Translations
    const translations = {
        en: {
            welcomeTitle: "Welcome to SoMAp - The Best School Management System",
            welcomeText: "Transform your school with our integrated SuperApp. Manage academics, finances, attendance, and more effortlessly. Connect parents, boost performance, and explore SoMAp Market for uniforms, supplies, and essentials. Inspired by top systems for excellence in Tanzania's education.",
            getStarted: "Get Started",
            dashboard: "Dashboard",
            academic: "Academic",
            attendance: "Attendance",
            discipline: "Discipline",
            finance: "Finance",
            resources: "Resources",
            communications: "Communications",
            market: "Market",
            aiInsights: "AI Insights",
            volunteers: "Volunteers",
            events: "Events",
            adminTools: "Admin Tools",
            classTools: "Class Tools",
            financeTools: "Finance Tools",
            childInfo: "Child Info",
            logout: "Logout"
        },
        sw: {
            welcomeTitle: "Karibu kwa SoMAp - Mfumo Bora wa Usimamizi wa Shule",
            welcomeText: "Badilisha shule yako na SuperApp yetu iliyounganishwa. Simamia masomo, fedha, mahudhurio, na zaidi kwa urahisi. Unganisha wazazi, ongeza utendaji, na chunguza SoMAp Market kwa uniformu, vifaa, na mahitaji. Imechochewa na mifumo ya juu kwa ubora katika elimu ya Tanzania.",
            getStarted: "Anza",
            dashboard: "Dashibodi",
            academic: "Elimu",
            attendance: "Mahudhurio",
            discipline: "Nidhamu",
            finance: "Fedha",
            resources: "Rasilimali",
            communications: "Mawasiliano",
            market: "Soko",
            aiInsights: "Maarifa ya AI",
            volunteers: "Wajitolea",
            events: "Matukio",
            adminTools: "Zana za Admin",
            classTools: "Zana za Darasa",
            financeTools: "Zana za Fedha",
            childInfo: "Taarifa za Mtoto",
            logout: "Toka"
        }
    };
    // No language select in dashboard, but translations defined for sidebar
    // Get Class from Email
    function getClassFromEmail(email) {
        if (!email) return '';
        email = email.toLowerCase();
        if (email.includes('babyclass')) return 'Baby Class';
        if (email.includes('middleclass')) return 'Middle Class';
        if (email.includes('preunit')) return 'Pre-Unit';
        if (email.includes('class1ab')) return 'Class 1 AB';
        if (email.includes('class2ab')) return 'Class 2 AB';
        if (email.includes('class32023')) return 'Class 3';
        if (email.includes('class42023')) return 'Class 4';
        if (email.includes('class52023')) return 'Class 5';
        if (email.includes('class62023')) return 'Class 6';
        if (email.includes('class72023')) return 'Class 7';
        return '';
    }
    const formatTsh = (value) => `TSh ${Math.round(Number(value) || 0).toLocaleString()}`;
    const yearManager = window.somapYearContext || null;
    const getSelectedYear = () => {
        if (yearManager && typeof yearManager.getSelectedYear === 'function') {
            return String(yearManager.getSelectedYear());
        }
        return String(SOMAP_DEFAULT_YEAR);
    };
    function updateYearHint() {
        const year = getSelectedYear();
        const desktopHint = document.getElementById('somapYearHint');
        const mobileHint = document.getElementById('somapYearHintMobile');
        if (desktopHint) desktopHint.textContent = year;
        if (mobileHint) mobileHint.textContent = year;
    }
    let currentRole = 'admin';
    let currentClassScope = '';
    let yearListenerBound = false;

    function scopeEntries(entriesMap, role, className) {
        const records = Object.entries(entriesMap || {}).map(([id, entry]) => ({ id, ...entry }));
        if (role === 'teacher' && className) {
            const target = L(className);
            return records.filter(rec => L(rec.student?.classLevel || rec.student?.className || '') === target);
        }
        return records;
    }

    function scopeStudents(studentsMap, role, className) {
        const records = Object.entries(studentsMap || {}).map(([id, student]) => ({ id, ...student }));
        if (role === 'teacher' && className) {
            const target = L(className);
            return records.filter(rec => L(rec.classLevel || rec.className || '') === target);
        }
        return records;
    }

    function bindYearChangeListener() {
        if (yearListenerBound || !yearManager || typeof yearManager.onYearChanged !== 'function') return;
        yearListenerBound = true;
        yearManager.onYearChanged(() => refreshDashboard(currentRole, currentClassScope));
    }

    function buildDateKeys(year) {
        const today = new Date();
        today.setFullYear(Number(year) || SOMAP_DEFAULT_YEAR);
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        const d = String(today.getDate()).padStart(2, '0');
        return {
            studentMonthKey: `${y}-${m}`,
            studentDayKey: `${y}-${m}-${d}`,
            workerMonthKey: `${y}${m}`,
            workerDayKey: `${y}${m}${d}`
        };
    }

    async function refreshDashboard(role, className) {
        if (!window.SomapFinance) return;
        currentRole = role || currentRole || 'admin';
        currentClassScope = className || currentClassScope || '';
        const year = getSelectedYear();
        updateYearHint();
        try {
            const [entriesMap, studentsMap, payments] = await Promise.all([
                window.SomapFinance.getYearFinanceEntries(year),
                window.SomapFinance.getYearStudents(year),
                window.SomapFinance.listRecentPayments(year, 6)
            ]);
            const entries = scopeEntries(entriesMap, currentRole, currentClassScope);
            const students = scopeStudents(studentsMap, currentRole, currentClassScope);
            await renderFinanceStats(entries, year);
            await renderStudentSnapshot(students);
            await renderAttendanceSummary(students, year);
            await loadWorkerSnapshot(year);
            renderRecentActivitiesFromPayments(payments, new Set(entries.map(entry => entry.id)));
        } catch (error) {
            console.error('Error loading dashboard:', error);
            Swal.fire('Error', 'Failed to load dashboard data: ' + error.message, 'error');
        }
    }

    async function renderFinanceStats(entries, year) {
        const totals = entries.reduce((acc, entry) => {
            acc.due += Number(entry.due || 0);
            acc.paid += Number(entry.paid || 0);
            acc.outstanding += Number(entry.outstanding || 0);
            return acc;
        }, { due: 0, paid: 0, outstanding: 0 });
        const expensesTotal = await window.SomapFinance.loadExpensesTotal(year);
        document.getElementById('total-due').innerHTML = formatTsh(totals.due);
        document.getElementById('total-collected').innerHTML = formatTsh(totals.paid);
        document.getElementById('total-outstanding').innerHTML = formatTsh(totals.outstanding);
        document.getElementById('total-expenses').innerHTML = formatTsh(expensesTotal);
        document.getElementById('net-balance').innerHTML = formatTsh(totals.paid - expensesTotal);
        updateFeeChart(totals.paid, totals.due);
    }

    function renderStudentSnapshot(students) {
        const active = students.filter(st => (st.classLevel || st.className || '').toUpperCase() !== 'GRADUATED');
        document.getElementById('total-students').innerHTML = `${active.length} <small class="text-xs text-slate-300">Live count</small>`;
        let boys = 0, girls = 0;
        active.forEach(st => {
            const gender = String(st.gender || st.sex || st.meta?.gender || '').trim().toLowerCase();
            if (gender.startsWith('m')) boys++;
            else if (gender.startsWith('f')) girls++;
        });
        document.getElementById('students-boys-count').textContent = boys;
        document.getElementById('students-girls-count').textContent = girls;
    }

    async function renderAttendanceSummary(students, year) {
        const active = students.filter(st => (st.classLevel || '').toUpperCase() !== 'GRADUATED');
        const { studentMonthKey, studentDayKey } = buildDateKeys(year);
        const classNames = Array.from(new Set(active.map(st => st.classLevel).filter(Boolean)));
        let present = 0;
        let recordedAbsent = 0;
        await Promise.all(classNames.map(async cls => {
            const snap = await db.ref(`attendance/${cls}/${studentMonthKey}/${studentDayKey}`).once('value');
            const records = snap.val() || {};
            Object.values(records).forEach(rec => {
                const status = String(rec?.daily || '').toUpperCase();
                if (status === 'P') present++;
                else if (status.includes('A')) recordedAbsent++;
            });
        }));
        const totalStudents = active.length;
        const computedAbsent = Math.max(0, totalStudents - present);
        const absent = Math.max(recordedAbsent, computedAbsent);
        document.getElementById('students-present-today').textContent = present;
        document.getElementById('students-absent-today').textContent = absent;
        const rate = totalStudents ? Math.round((present / totalStudents) * 1000) / 10 : 0;
        document.getElementById('attendance-rate').innerHTML = `${rate}% <small class="text-xs text-slate-200">Live</small>`;
    }

    async function loadWorkerSnapshot(year) {
        const { workerMonthKey, workerDayKey } = buildDateKeys(year);
        const [workersSnap, attendanceSnap] = await Promise.all([
            db.ref('workers').once('value'),
            db.ref('attendance').once('value')
        ]);
        const workers = workersSnap.val() || {};
        const totalWorkers = Object.values(workers).filter(w => w?.profile?.active !== false).length;
        let male = 0, female = 0;
        Object.values(workers).forEach(worker => {
            const gender = String(worker?.profile?.gender || worker.gender || '').trim().toLowerCase();
            if (gender.startsWith('m')) male++;
            else if (gender.startsWith('f')) female++;
        });
        const attendance = attendanceSnap.val() || {};
        let present = 0;
        Object.values(attendance).forEach(record => {
            const monthBucket = record?.[workerMonthKey];
            const dayEntry = monthBucket?.[workerDayKey];
            if (dayEntry?.checkInTs) present++;
        });
        const absent = Math.max(0, totalWorkers - present);
        document.getElementById('workers-total-count').textContent = totalWorkers;
        document.getElementById('workers-present-count').textContent = present;
        document.getElementById('workers-absent-count').textContent = absent;
        document.getElementById('workers-male-count').textContent = male;
        document.getElementById('workers-female-count').textContent = female;
    }

    function renderRecentActivitiesFromPayments(payments, allowedIds) {
        const list = document.getElementById('activities-list');
        if (!list) return;
        if (!allowedIds.size) {
            list.innerHTML = '<li>No recent activities.</li>';
            return;
        }
        const items = payments.filter(p => allowedIds.has(p.studentId)).slice(0, 4);
        if (!items.length) {
            list.innerHTML = '<li>No recent activities.</li>';
            return;
        }
        list.innerHTML = items.map(p => {
            const ts = p.timestamp ? new Date(p.timestamp).toLocaleString() : new Date().toLocaleString();
            return `<li>${p.fullName} paid ${formatTsh(p.amount)} via ${p.method || '-'} - ${ts}</li>`;
        }).join('');
    }
    function updateFeeChart(collected, due) {
        const ctx = document.getElementById('fee-chart')?.getContext('2d');
        if (ctx && Chart.getChart(ctx.canvas)) {
            Chart.getChart(ctx.canvas).data.datasets[0].data = [collected, due - collected];
            Chart.getChart(ctx.canvas).data.labels = ['Collected', 'Outstanding'];
            Chart.getChart(ctx.canvas).update();
        }
    }
    // Load Parent Data for parent role
    function loadParentData(phone) {
        db.ref('students').orderByChild('parentPhone').equalTo(phone).once('value').then(snapshot => {
            const child = snapshot.val();
            document.getElementById('child-details').innerHTML = child ? Object.values(child).map(c => `<p>${c.name || c.firstName + ' ' + c.lastName} - Class: ${c.classLevel} - Balance: TSh ${c.balance}</p>`).join('') : '<p>No child found.</p>';
        });
    }
    // Add School
    document.getElementById('add-school-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const schoolName = document.getElementById('school-name').value;
        db.ref('schools').push({ name: schoolName });
        Swal.fire('Success', 'School added!', 'success');
    });
    // Logout
    document.getElementById('logout').addEventListener('click', () => {
        auth.signOut().then(() => location.reload());
    });
    // Charts (Fee Trends)
    const feeCtx = document.getElementById('fee-chart')?.getContext('2d');
    if (feeCtx) {
        new Chart(feeCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'],
                datasets: [{ label: 'Fee Collection (TSh)', data: [0, 0, 0, 0, 0, 0, 0, 0, 0], backgroundColor: '#20c997' }]
            }
        });
    }
    // Attendance Chart
    const attendanceCtx = document.getElementById('attendance-chart')?.getContext('2d');
    if (attendanceCtx) {
        new Chart(attendanceCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{ label: 'Attendance', data: [90, 92, 94, 93, 95, 80, 85], backgroundColor: '#20c997' }]
            }
        });
    }
    // Load Market
    function loadMarket() {
        db.ref('market/products').once('value').then(snapshot => {
            // Populate if data
        });
    }
    // AI Ask
    document.querySelector('#ai-insights button')?.addEventListener('click', () => {
        const query = document.querySelector('#ai-insights input').value;
        Swal.fire('AI Response', `Generating report for: ${query}`, 'info');
    });
    // Initial
    auth.onAuthStateChanged(user => {
        if (user) {
            const role = localStorage.getItem('role') || 'admin';
            
            // Check if accessed from Teacher Dashboard (workertasks.html) in read-only mode
            const isReadOnly = sessionStorage.getItem('dashboardReadOnly') === 'true';
            const accessedBy = sessionStorage.getItem('dashboardAccessedBy');
            
            if (isReadOnly && accessedBy) {
                console.log('📊 Dashboard accessed in READ-ONLY mode by:', accessedBy);
                
                // HIDE THE ENTIRE SIDEBAR - teachers don't need to see it
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.style.display = 'none';
                }
                
                // Remove workspace left margin since sidebar is hidden
                const workspace = document.querySelector('.workspace');
                if (workspace) {
                    workspace.style.marginLeft = '0';
                    workspace.style.maxWidth = '100%';
                }
                
                // Hide all role-specific elements first
                document.querySelectorAll('.role-specific').forEach(el => el.style.display = 'none');
                
                // Show only stats and overview sections (no editing capabilities)
                document.querySelectorAll('.module-section').forEach(section => {
                    // Hide all sections by default
                    section.style.display = 'none';
                });
                
                // Show only the dashboard overview and statistics
                const dashboardSection = document.getElementById('dashboard');
                if (dashboardSection) {
                    dashboardSection.style.display = 'block';
                }
                
                // Hide charts to speed up loading
                const feeTrendsSection = document.getElementById('fee-trends');
                if (feeTrendsSection) feeTrendsSection.style.display = 'none';
                
                // Hide attendance chart if it's in a module-section
                document.querySelectorAll('.chart-container').forEach(container => {
                    const canvas = container.querySelector('canvas');
                    if (canvas && (canvas.id === 'fee-chart' || canvas.id === 'attendance-chart')) {
                        container.style.display = 'none';
                    }
                });
                
                // Make all stat cards non-clickable
                document.querySelectorAll('.stat-card, .stats-card, .finance-card').forEach(card => {
                    card.style.cursor = 'default';
                    card.style.pointerEvents = 'none';
                    card.style.transform = 'none';
                    // Remove hover effects
                    card.addEventListener('mouseenter', (e) => {
                        e.currentTarget.style.transform = 'none';
                    });
                });
                
                // Show Quick Actions section but make it read-only
                const quickActionsSection = document.getElementById('quick-actions');
                if (quickActionsSection) {
                    quickActionsSection.style.display = 'block';
                    
                    // Disable all quick action buttons except for specific ones
                    quickActionsSection.querySelectorAll('.quick-action-btn').forEach(btn => {
                        // Check if it's the Workers Hub button
                        if (btn.textContent.includes('Open Workers Hub')) {
                            // Only show Workers Hub for Head Teacher
                            if (accessedBy === 'Head Teacher') {
                                btn.style.display = 'inline-block';
                                btn.style.pointerEvents = 'auto';
                                btn.style.cursor = 'pointer';
                            } else {
                                btn.style.display = 'none';
                            }
                        } else {
                            // Hide all other action buttons completely
                            btn.style.display = 'none';
                        }
                    });
                }
                
                // Add read-only banner
                if (workspace && !document.getElementById('readonly-banner')) {
                    const banner = document.createElement('div');
                    banner.id = 'readonly-banner';
                    banner.style.cssText = `
                        background: linear-gradient(135deg, #f59e0b, #ef4444);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        text-align: center;
                        font-weight: 600;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        position: sticky;
                        top: 0;
                        z-index: 100;
                    `;
                    banner.innerHTML = `
                        📊 <strong>READ-ONLY DASHBOARD</strong> - ${accessedBy} View
                        ${accessedBy === 'Head Teacher' ? '<br><small style="font-size: 0.9em;">✓ You can access Workers Hub for staff registration</small>' : '<br><small style="font-size: 0.9em;">View statistics only - No editing allowed</small>'}
                        <button onclick="window.location.href='workershtml/workertasks.html'" 
                            style="margin-left: 20px; padding: 8px 16px; background: white; color: #ef4444; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                            🔙 Back to Teacher Dashboard
                        </button>
                    `;
                    workspace.insertBefore(banner, workspace.firstChild);
                }
                
                // Add loading indicator
                const dashboardOverview = document.querySelector('#dashboard .row.grid');
                if (dashboardOverview) {
                    dashboardOverview.style.opacity = '0.6';
                    const loader = document.createElement('div');
                    loader.id = 'stats-loader';
                    loader.style.cssText = 'text-align: center; padding: 20px; color: white; font-size: 1.2rem;';
                    loader.innerHTML = '<div class="loader" style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; margin: 0 auto; animation: spin 0.8s linear infinite;"></div><p style="margin-top: 16px;">Loading statistics...</p>';
                    dashboardOverview.parentElement.insertBefore(loader, dashboardOverview);
                }
                
                // Load dashboard data in view-only mode (optimized - only load essential data)
                console.log('⚡ Loading optimized read-only dashboard data...');
                
                // Use a slight delay to ensure DOM is ready
                setTimeout(() => {
                    refreshDashboard('admin', null);
                    bindYearChangeListener();
                    
                    // Remove loader after data loads
                    setTimeout(() => {
                        const loader = document.getElementById('stats-loader');
                        if (loader) loader.remove();
                        if (dashboardOverview) dashboardOverview.style.opacity = '1';
                    }, 1500);
                }, 100);
                
            } else {
                // Normal mode - regular user access
                document.getElementById('sidebar').classList.remove('hidden');
                document.querySelectorAll('.role-specific').forEach(el => el.style.display = 'none');
                document.querySelectorAll(`.role-specific.${role}-only`).forEach(el => el.style.display = 'block');
                const gradShortcut = document.getElementById('graduationShortcut');
                if (gradShortcut) {
                    gradShortcut.style.display = GRAD_EMAILS.has(user.email.toLowerCase()) ? 'flex' : 'none';
                }
                refreshDashboard(role, getClassFromEmail(user.email));
                bindYearChangeListener();
                if (role === 'parent') {
                    const phone = localStorage.getItem('parentPhone');
                    if (phone) loadParentData(phone);
                }
            }
        } else {
            // Check if accessed from teacher dashboard with workerId
            const workerId = localStorage.getItem('workerId');
            const isReadOnly = sessionStorage.getItem('dashboardReadOnly') === 'true';
            
            if (workerId && isReadOnly) {
                // Teacher accessing - don't redirect, use anonymous access for viewing
                console.log('👨‍🏫 Teacher viewing dashboard in read-only mode');
                
                const accessedBy = sessionStorage.getItem('dashboardAccessedBy');
                
                // HIDE THE ENTIRE SIDEBAR - teachers don't need to see it
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.style.display = 'none';
                }
                
                // Remove workspace left margin since sidebar is hidden
                const workspace = document.querySelector('.workspace');
                if (workspace) {
                    workspace.style.marginLeft = '0';
                    workspace.style.maxWidth = '100%';
                }
                
                // Hide all role-specific elements
                document.querySelectorAll('.role-specific').forEach(el => el.style.display = 'none');
                
                // Hide all sections except dashboard overview
                document.querySelectorAll('.module-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show only the main dashboard
                const dashboardSection = document.getElementById('dashboard');
                if (dashboardSection) dashboardSection.style.display = 'block';
                
                // Hide charts to speed up loading
                const feeTrendsSection = document.getElementById('fee-trends');
                if (feeTrendsSection) feeTrendsSection.style.display = 'none';
                
                // Hide attendance chart if it's in a module-section
                document.querySelectorAll('.chart-container').forEach(container => {
                    const canvas = container.querySelector('canvas');
                    if (canvas && (canvas.id === 'fee-chart' || canvas.id === 'attendance-chart')) {
                        container.style.display = 'none';
                    }
                });
                
                // Make all stat cards non-clickable
                document.querySelectorAll('.stat-card, .stats-card, .finance-card').forEach(card => {
                    card.style.cursor = 'default';
                    card.style.pointerEvents = 'none';
                    card.style.transform = 'none';
                    // Remove hover effects
                    card.addEventListener('mouseenter', (e) => {
                        e.currentTarget.style.transform = 'none';
                    });
                });
                
                // Show Quick Actions for Head Teacher to access Workers Hub
                if (accessedBy === 'Head Teacher') {
                    const quickActionsSection = document.getElementById('quick-actions');
                    if (quickActionsSection) {
                        quickActionsSection.style.display = 'block';
                        quickActionsSection.querySelectorAll('.quick-action-btn').forEach(btn => {
                            if (btn.textContent.includes('Open Workers Hub')) {
                                btn.style.display = 'inline-block';
                                btn.style.pointerEvents = 'auto';
                                btn.style.cursor = 'pointer';
                            } else {
                                btn.style.display = 'none';
                            }
                        });
                    }
                }
                
                // Add read-only banner
                if (workspace && !document.getElementById('readonly-banner')) {
                    const banner = document.createElement('div');
                    banner.id = 'readonly-banner';
                    banner.style.cssText = `
                        background: linear-gradient(135deg, #f59e0b, #ef4444);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        text-align: center;
                        font-weight: 600;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        position: sticky;
                        top: 0;
                        z-index: 100;
                    `;
                    banner.innerHTML = `
                        📊 <strong>READ-ONLY DASHBOARD</strong> - ${accessedBy || 'Teacher'} View
                        ${accessedBy === 'Head Teacher' ? '<br><small style="font-size: 0.9em;">✓ You can access Workers Hub for staff registration</small>' : '<br><small style="font-size: 0.9em;">View statistics only - No editing allowed</small>'}
                        <button onclick="window.location.href='workershtml/workertasks.html'" 
                            style="margin-left: 20px; padding: 8px 16px; background: white; color: #ef4444; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                            🔙 Back to Teacher Dashboard
                        </button>
                    `;
                    workspace.insertBefore(banner, workspace.firstChild);
                }

                refreshDashboard('admin', null);
                bindYearChangeListener();
                
            } else {
                // Not logged in and not from teacher dashboard - redirect to login
                window.location.href = 'index.html';
            }
        }
    });
    // Sidebar Clicks
    document.querySelector('[data-module="erp"]').addEventListener('click', () => {
        window.location.href = 'schoolerp.html';
    });
    document.querySelector('[data-module="finance"]').addEventListener('click', () => {
        window.location.href = 'finance.html';
    });
    // Toggle Sidebar
    document.getElementById('toggle-sidebar').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('sidebar-expanded');
        document.querySelectorAll('.sidebar-collapsed').forEach(el => el.classList.toggle('hidden'));
        document.querySelectorAll('.sidebar-expanded').forEach(el => el.classList.toggle('hidden'));
    });
    document.querySelector('[data-module="dashboard"]').addEventListener('click', () => {
        refreshDashboard(localStorage.getItem('role'), getClassFromEmail(auth.currentUser?.email));
        bindYearChangeListener();
        document.getElementById('dashboard').scrollIntoView({ behavior: 'smooth' });
    });
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
