<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoMAp - Downloads</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Enhanced styling for attractiveness */
    .tab-button {
      transition: all 0.3s ease;
    }
    .tab-button.active {
      color: #4f46e5;
      border-bottom-color: #4f46e5;
    }
    .table-header {
      background-color: #f3f4f6;
      color: #4b5563;
    }
    .table-row:nth-child(even) {
      background-color: #f9fafb;
    }
    .download-btn {
      background-color: #4f46e5;
      color: white;
      transition: all 0.3s ease;
    }
    .download-btn:hover {
      background-color: #4338ca;
    }
    .section-header {
      color: #1f2937;
    }
  </style>
  <script src="firebase.js"></script> <!-- Same firebase.js as in index.html -->
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF autotable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS for Excel/CSV export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 p-4">
  <div class="mb-4">
    <div class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg text-sm mb-4 section-header">
      Download reports, lists, and receipts for students, fees, and more.
    </div>
    <!-- Tabs for different download types -->
    <div class="flex border-b mb-4">
      <button class="download-tab tab-button px-4 py-2 font-medium border-b-2 border-indigo-500 text-indigo-600 active" data-tab="student-list">Student List</button>
      <button class="download-tab tab-button px-4 py-2 font-medium text-gray-500 hover:text-indigo-700" data-tab="school-reports">School Reports</button>
      <button class="download-tab tab-button px-4 py-2 font-medium text-gray-500 hover:text-indigo-700" data-tab="fee-reports">Fee Reports</button>
      <button class="download-tab tab-button px-4 py-2 font-medium text-gray-500 hover:text-indigo-700" data-tab="report-forms">Report Forms</button>
      <button class="download-tab tab-button px-4 py-2 font-medium text-gray-500 hover:text-indigo-700" data-tab="receipts">Receipts</button>
    </div>
    <!-- Tab content -->
    <div class="download-tab-content active" data-tab="student-list">
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="font-medium text-gray-800 section-header">Student List</h3>
        <p class="text-sm text-gray-500 mb-3">Download list of all students with key details.</p>
        <select id="student-list-class" class="w-full p-2 border rounded-lg mb-3">
          <option>All Classes</option>
          <option>Baby Class</option>
          <option>Class 1</option>
          <option>Class 2</option>
          <option>Class 3</option>
          <option>Class 4</option>
          <option>Class 5</option>
          <option>Class 6</option>
          <option>Class 7</option>
        </select>
        <table id="student-list-table" class="w-full text-sm border-collapse">
          <thead>
            <tr class="table-header bg-indigo-100">
              <th class="p-2 border">Admission No</th>
              <th class="p-2 border">Full Name</th>
              <th class="p-2 border">Class</th>
              <th class="p-2 border">Parents Contact</th>
              <th class="p-2 border">Fee Per Year</th>
              <th class="p-2 border">Payment Plan</th>
              <th class="p-2 border">Paid Amount</th>
              <th class="p-2 border">Debt</th>
            </tr>
          </thead>
          <tbody class="table-row"></tbody>
        </table>
        <button onclick="downloadCSV('student-list')" class="mt-3 py-2 px-4 download-btn rounded-lg hover:opacity-90">Download CSV</button>
        <button onclick="downloadPDF('student-list')" class="mt-3 py-2 px-4 download-btn rounded-lg hover:opacity-90">Download PDF</button>
      </div>
    </div>
    <div class="download-tab-content" data-tab="school-reports">
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="font-medium text-gray-800 section-header">School Reports</h3>
        <p class="text-sm text-gray-500 mb-3">Download reports per school, class, month, term, year.</p>
        <select id="school-report-type" class="w-full p-2 border rounded-lg mb-3">
          <option>Per School</option>
          <option>Per Class</option>
          <option>Per Month</option>
          <option>Per Term</option>
          <option>Per Year</option>
        </select>
        <table id="school-report-table" class="w-full text-sm border-collapse">
          <thead>
            <tr class="table-header bg-indigo-100">
              <th class="p-2 border">Admission No</th>
              <th class="p-2 border">Full Name</th>
              <th class="p-2 border">Class</th>
              <th class="p-2 border">Parents Contact</th>
              <th class="p-2 border">Fee Per Year</th>
              <th class="p-2 border">Paid Amount</th>
              <th class="p-2 border">Debt</th>
            </tr>
          </thead>
          <tbody class="table-row"></tbody>
        </table>
        <button onclick="downloadCSV('school-reports')" class="mt-3 py-2 px-4 download-btn rounded-lg hover:opacity-90">Download CSV</button>
        <button onclick="downloadPDF('school-reports')" class="mt-3 py-2 px-4 download-btn rounded-lg hover:opacity-90">Download PDF</button>
      </div>
    </div>
    <div class="download-tab-content" data-tab="fee-reports">
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="font-medium text-gray-800 section-header">Fee Reports</h3>
        <p class="text-sm text-gray-500 mb-3">Download fee reports for paid all, per installment, per month, current time, debts per school/class/pupil.</p>
        <select id="fee-report-type" class="w-full p-2 border rounded-lg mb-3">
          <option>Paid All Fees</option>
          <option>Paid Per Installment</option>
          <option>Paid Per Month</option>
          <option>Paid Till Current Time</option>
          <option>Debts Per School</option>
          <option>Debts Per Class</option>
          <option>Debts Per Pupil</option>
        </select>
        <table id="fee-report-table" class="w-full text-sm border-collapse">
          <thead>
            <tr class="table-header bg-indigo-100">
              <th class="p-2 border">Admission No</th>
              <th class="p-2 border">Full Name</th>
              <th class="p-2 border">Class</th>
              <th class="p-2 border">Parents Contact</th>
              <th class="p-2 border">Fee Per Year</th>
              <th class="p-2 border">Paid Amount</th>
              <th class="p-2 border">Debt</th>
            </tr>
          </thead>
          <tbody class="table-row"></tbody>
        </table>
        <button onclick="downloadCSV('fee-reports')" class="mt-3 py-2 px-4 download-btn rounded-lg hover:opacity-90">Download CSV</button>
        <button onclick="downloadPDF('fee-reports')" class="mt-3 py-2 px-4 download-btn rounded-lg hover:opacity-90">Download PDF</button>
      </div>
    </div>
    <div class="download-tab-content" data-tab="report-forms">
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="font-medium text-gray-800 section-header">Report Forms</h3>
        <p class="text-sm text-gray-500 mb-3">Download report forms with student details.</p>
        <select id="report-form-type" class="w-full p-2 border rounded-lg mb-3">
          <option>Per Student</option>
          <option>Per Class</option>
          <option>Per Term</option>
        </select>
        <table id="report-form-table" class="w-full text-sm border-collapse">
          <thead>
            <tr class="table-header bg-indigo-100">
              <th class="p-2 border">Admission No</th>
              <th class="p-2 border">Full Name</th>
              <th class="p-2 border">Class</th>
              <th class="p-2 border">Parents Contact</th>
              <th class="p-2 border">Fee Per Year</th>
              <th class="p-2 border">Paid Amount</th>
              <th class="p-2 border">Debt</th>
            </tr>
          </thead>
          <tbody class="table-row"></tbody>
        </table>
        <button onclick="downloadCSV('report-forms')" class="mt-3 py-2 px-4 download-btn rounded-lg hover:opacity-90">Download CSV</button>
        <button onclick="downloadPDF('report-forms')" class="mt-3 py-2 px-4 download-btn rounded-lg hover:opacity-90">Download PDF</button>
      </div>
    </div>
    <div class="download-tab-content" data-tab="receipts">
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="font-medium text-gray-800 section-header">Receipts</h3>
        <p class="text-sm text-gray-500 mb-3">Download receipts for payments.</p>
        <select id="receipt-type" class="w-full p-2 border rounded-lg mb-3">
          <option>Per Student</option>
          <option>Per Class</option>
          <option>Per Month</option>
        </select>
        <table id="receipt-table" class="w-full text-sm border-collapse">
          <thead>
            <tr class="table-header bg-indigo-100">
              <th class="p-2 border">Admission No</th>
              <th class="p-2 border">Full Name</th>
              <th class="p-2 border">Class</th>
              <th class="p-2 border">Parents Contact</th>
              <th class="p-2 border">Fee Per Year</th>
              <th class="p-2 border">Paid Amount</th>
              <th class="p-2 border">Debt</th>
            </tr>
          </thead>
          <tbody class="table-row"></tbody>
        </table>
        <button onclick="downloadCSV('receipts')" class="mt-3 py-2 px-4 download-btn rounded-lg hover:opacity-90">Download CSV</button>
        <button onclick="downloadPDF('receipts')" class="mt-3 py-2 px-4 download-btn rounded-lg hover:opacity-90">Download PDF</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Initialization
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.firebasestorage.app",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Tab Switching
    const tabs = document.querySelectorAll('.download-tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-600'));
        tab.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-600');
        document.querySelectorAll('.download-tab-content').forEach(content => content.classList.remove('active'));
        document.querySelector(`.download-tab-content[data-tab="${tab.dataset.tab}"]`).classList.add('active');
        loadData(tab.dataset.tab); // Load data for the selected tab
      });
    });

    // Fetch data from Firebase and populate tables
    async function loadData(tab) {
      const snapshot = await db.ref('students').once('value');
      const students = snapshot.val() || {};
      const studentArray = Object.values(students);

      // Filter data based on tab if needed (e.g., per class, per month)
      let filteredStudents = studentArray; // Default to all

      // Populate table for the current tab
      const tableBody = document.querySelector(`#${tab}-table tbody`);
      tableBody.innerHTML = '';
      filteredStudents.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-2 border">${student.admissionNumber || ''}</td>
          <td class="p-2 border">${student.firstName} ${student.lastName}</td>
          <td class="p-2 border">${student.classLevel || ''}</td>
          <td class="p-2 border">${student.primaryParentContact || ''}</td>
          <td class="p-2 border">${student.feePerYear || '$0'}</td>
          <td class="p-2 border">${student.paymentPlan || 'N/A'}</td>
          <td class="p-2 border">${student.paidAmount || '$0'}</td>
          <td class="p-2 border">${student.debt || '$0'}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Download CSV
    function downloadCSV(tab) {
      const snapshot = db.ref('students').once('value').then(snap => {
        const data = snap.val() || {};
        const students = Object.values(data);
        const ws = XLSX.utils.json_to_sheet(students.map((s, i) => ({
          '#': i + 1,
          'Admission No': s.admissionNumber || '',
          'Full Name': s.firstName + ' ' + s.lastName,
          'Class': s.classLevel || '',
          'Parents Contact': s.primaryParentContact || '',
          'Fee Per Year': s.feePerYear || '$0',
          'Paid Amount': s.paidAmount || '$0',
          'Debt': s.debt || '$0'
        })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Data');
        XLSX.writeFile(wb, tab + '.xlsx');
      });
    }

    // Download PDF
    function downloadPDF(tab) {
      const snapshot = db.ref('students').once('value').then(snap => {
        const data = snap.val() || {};
        const students = Object.values(data);
        const doc = new window.jspdf.jsPDF({orientation: 'landscape'});
        doc.text(tab.charAt(0).toUpperCase() + tab.slice(1) + ' Report', 10, 10);
        let rows = students.map((s, i) => [
          i + 1,
          s.admissionNumber || '',
          s.firstName + ' ' + s.lastName,
          s.classLevel || '',
          s.primaryParentContact || '',
          s.feePerYear || '$0',
          s.paidAmount || '$0',
          s.debt || '$0'
        ]);
        doc.autoTable({
          head: [['#', 'Admission No', 'Full Name', 'Class', 'Parents Contact', 'Fee Per Year', 'Paid Amount', 'Debt']],
          body: rows,
          startY: 15,
          styles: { fontSize: 8 }
        });
        doc.save(tab + '.pdf');
      });
    }

    // Load data for the initial tab
    loadData('student-list');
  </script>
</body>
</html>