<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Firebase SDKs (same as index.html, version 9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
  <!-- Your Firebase config wrapper -->
  <script src="firebase.js"></script>
  <title>SoMAp - Finance</title>
  <!-- Tailwind + FontAwesome (same style as your app) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    body { background: #f8fafc; }
    .table-header { background: #eef2ff; color: #1f2937; }
    .table-row:nth-child(even) { background: #ffffff; }
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { background:#fff; max-width:800px; margin:4% auto; padding:18px; border-radius:8px; height:80vh; overflow:auto; }
    .expander { cursor: pointer; }
    .status-pill { padding:2px 8px; border-radius:999px; font-size: 11px; font-weight:600; }
    .status-paid { background:#dcfce7; color:#166534; } /* green */
    .status-partial { background:#fef9c3; color:#854d0e; } /* amber */
    .status-overdue { background:#fee2e2; color:#991b1b; } /* red */
  </style>
  <!-- Third-party libs for export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="p-6">
  <div class="max-w-6xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold text-indigo-700">SoMAp — Finance</h1>
      <div class="space-x-2">
        <button id="reloadBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">Reload</button>
        <a href="index.html" class="px-3 py-1 border rounded text-sm">Back to Dashboard</a>
      </div>
    </header>
    <!-- Summary cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Total Due (All Students)</h3>
        <div id="totalDue" class="text-xl font-semibold mt-2">--</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Total Collected</h3>
        <div id="totalCollected" class="text-xl font-semibold mt-2">--</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
  <h3 class="text-sm text-gray-500">Total Outstanding (Due – Collected)</h3>
  <div id="totalOutstanding" class="text-xl font-semibold mt-2">--</div>
</div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Total Expenses</h3>
        <div id="totalExpenses" class="text-xl font-semibold mt-2">--</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Net Balance (Collected - Expenses)</h3>
        <div id="netBalance" class="text-xl font-semibold mt-2">--</div>
      </div>
    </div>
    <!-- Action Row -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <label class="text-sm text-gray-600">Filter by class</label>
        <select id="classFilter" class="p-2 border rounded">
          <option value="">All Classes</option>
          <option>Baby Class</option>
          <option>Class 1</option>
          <option>Class 2</option>
          <option>Class 3</option>
          <option>Class 4</option>
          <option>Class 5</option>
          <option>Class 6</option>
          <option>Class 7</option>
        </select>
        <button id="showOnlyDebtors" class="px-3 py-1 bg-yellow-500 text-white rounded text-sm">Show Debtors</button>
      </div>
      <div class="flex items-center gap-2">
        <button id="downloadCsv" class="px-3 py-1 bg-indigo-600 text-white rounded"><i class="fa fa-file-excel mr-1"></i> Main CSV</button>
        <button id="downloadPdf" class="px-3 py-1 bg-red-600 text-white rounded"><i class="fa fa-file-pdf mr-1"></i> Main PDF</button>
        <button id="downloadDebtNowCsv" class="px-3 py-1 bg-amber-600 text-white rounded"><i class="fa fa-file-excel mr-1"></i> Debt (current) CSV</button>
        <button id="downloadDebtNowPdf" class="px-3 py-1 bg-amber-700 text-white rounded"><i class="fa fa-file-pdf mr-1"></i> Debt (current) PDF</button>
        <button id="downloadBreakdownCsv" class="px-3 py-1 bg-teal-600 text-white rounded"><i class="fa fa-file-excel mr-1"></i> Breakdown CSV</button>
        <button id="downloadBreakdownPdf" class="px-3 py-1 bg-teal-700 text-white rounded"><i class="fa fa-file-pdf mr-1"></i> Breakdown PDF</button>
      </div>
    </div>
    <!-- Finance table -->
    <div class="bg-white rounded shadow overflow-x-auto">
      <table id="financeTable" class="min-w-full text-sm">
        <thead>
          <tr class="table-header">
            <th class="p-2 border"></th>
            <th class="p-2 border">Admission No</th>
            <th class="p-2 border">Full Name</th>
            <th class="p-2 border">Class</th>
            <th class="p-2 border">Fee (year)</th>
            <th class="p-2 border">Payment Plan</th>
            <th class="p-2 border">Paid</th>
            <th class="p-2 border">Balance (Year)</th>
            <th class="p-2 border">Debt till …</th>
            <th class="p-2 border">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- Expenses Management -->
    <div class="bg-white rounded shadow p-4 mt-6">
      <h2 class="text-lg font-semibold text-indigo-700 mb-3">Expenses</h2>
      <form id="expenseForm" class="grid md:grid-cols-4 gap-3 mb-4">
        <select id="expenseCategory" required class="p-2 border rounded">
          <option value="">Select Category</option>
          <option>FOOD</option>
          <option>SALARIES</option>
          <option>OFFICE</option>
          <option>EDUCATION</option>
          <option>WATER & ELECTRICITY</option>
          <option>SANITATION</option>
          <option>ENVIRONMENT</option>
          <option>HEALTH</option>
          <option>SECURITY</option>
          <option>CLOTHING</option>
          <option>SHELTER</option>
          <option>RECREATION</option>
          <option>PROJECTS</option>
          <option>TRANSPORT</option>
          <option>PURCHASES</option>
          <option>SIL</option>
          <option>MAINTENANCE</option>
          <option>BOOKS</option>
          <option>EMERGENCY</option>
          <option>MISCELLANEOUS</option>
        </select>
        <input id="expenseDescription" type="text" placeholder="Description" required class="p-2 border rounded">
        <input id="expenseAmount" type="number" min="1" placeholder="Amount" required class="p-2 border rounded">
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Add Expense</button>
      </form>
      <div class="flex items-center gap-2 mb-3">
        <button id="downloadExpenseCsv" class="px-3 py-1 bg-green-600 text-white rounded">
          Download Expense Report (CSV)
        </button>
        <button id="downloadExpensePdf" class="px-3 py-1 bg-red-600 text-white rounded">
          Download Expense Report (PDF)
        </button>
      </div>
      <table id="expenseTable" class="min-w-full text-sm border">
        <thead>
          <tr class="table-header">
            <th class="p-2 border">Category</th>
            <th class="p-2 border">Description</th>
            <th class="p-2 border">Amount</th>
            <th class="p-2 border">Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- Payment modal -->
    <div id="paymentModal" class="modal">
      <div class="modal-content">
        <span id="closePaymentModal" class="float-right cursor-pointer text-2xl">&times;</span>
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Record Payment</h2>
        <form id="paymentForm" class="space-y-3">
          <div>
            <label class="text-sm text-gray-600">Student</label>
            <select id="studentSelect" class="w-full p-2 border rounded" required></select>
          </div>
          <div>
            <label class="text-sm text-gray-600">Amount</label>
            <input id="paymentAmount" type="number" step="1" min="1" class="w-full p-2 border rounded" required />
          </div>
          <div>
            <label class="text-sm text-gray-600">Method</label>
            <select id="paymentMethod" class="w-full p-2 border rounded">
              <option>Cash</option>
              <option>MPesa</option>
              <option>Airtel Money</option>
              <option>TigoPesa</option>
              <option>Bank Transfer</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-600">Note (optional)</label>
            <input id="paymentNote" type="text" class="w-full p-2 border rounded" />
          </div>
          <div class="flex space-x-2">
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Save Payment</button>
            <button id="cancelPayment" type="button" class="px-4 py-2 border rounded">Cancel</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Details modal (kept for ledger view) -->
    <div id="detailsModal" class="modal">
      <div class="modal-content">
        <span id="closeDetailsModal" class="float-right cursor-pointer text-2xl">&times;</span>
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Student Finance Details</h2>
        <div id="detailsContent"></div>
      </div>
    </div>
  </div>
<script>
/*
  finance.html — enhanced
  - Strict installment/monthly windows
  - Payment allocation (previous debt → oldest open installment → next → credit)
  - “Debt till X” column + downloadable debt list for the current period
  - Expandable, color-coded per-student breakdown via iframe to payment.html
  - Exports with totals (main, debt, breakdown)
*/
(function () {
  const db = window.db || null;
  // DOM handles
  const tbody = document.querySelector('#financeTable tbody');
  const studentSelect = document.getElementById('studentSelect');
  const paymentModal = document.getElementById('paymentModal');
  const closePaymentModal = document.getElementById('closePaymentModal');
  const paymentForm = document.getElementById('paymentForm');
  const cancelPayment = document.getElementById('cancelPayment');
  const detailsModal = document.getElementById('detailsModal');
  const closeDetailsModal = document.getElementById('closeDetailsModal');
  const detailsContent = document.getElementById('detailsContent');
  const classFilter = document.getElementById('classFilter');
  const showOnlyDebtorsBtn = document.getElementById('showOnlyDebtors');
  const downloadCsvBtn = document.getElementById('downloadCsv');
  const downloadPdfBtn = document.getElementById('downloadPdf');
  const downloadDebtNowCsvBtn = document.getElementById('downloadDebtNowCsv');
  const downloadDebtNowPdfBtn = document.getElementById('downloadDebtNowPdf');
  const downloadBreakdownCsvBtn = document.getElementById('downloadBreakdownCsv');
  const downloadBreakdownPdfBtn = document.getElementById('downloadBreakdownPdf');
  const reloadBtn = document.getElementById('reloadBtn');
  let cachedStudents = {}; // key => student
  let showingDebtorsOnly = false;
  if (!db) {
    console.error('DB not found.');
    alert('DB not ready. Ensure firebase.js initializes window.db.');
  }
  // ====================== UTILITIES ======================
  function fmt(n) {
    n = Number(n) || 0;
    return n.toLocaleString();
  }
  function clamp(n){ return Math.max(0, Math.round(Number(n)||0)); }
  function todayYMD() {
    const d = new Date();
    return { y: d.getFullYear(), m: d.getMonth()+1, d: d.getDate() };
  }
  function dateFromYMD(y,m,d){ return new Date(y, m-1, d).getTime(); }
  function isPast(ts){ return Date.now() > ts; }
  function apportion(total, weights) {
    if (!weights.length) return [];
    const sumW = weights.reduce((a,b)=>a + b, 0);
    let amounts = weights.map(w => Math.floor((w * total) / sumW));
    let sumA = amounts.reduce((a,b)=>a + b, 0);
    let rem = total - sumA;
    if (rem > 0) {
      const sortedIdx = [...weights.keys()].sort((a,b) => weights[b] - weights[a]);
      for (let i = 0; i < rem; i++) {
        amounts[sortedIdx[i % sortedIdx.length]]++;
      }
    }
    return amounts;
  }
  // Installment configs
  const installmentConfigs = {
    lower: {
      type: '6',
      weights: [44, 13, 12, 22, 22, 16], // sum 129
      labels: ['Jan (2 months)', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul (2 months)', 'Aug', 'Sep', 'Oct'],
      windows: [ // m,d for from/to
        {from: [12,1], to: [1,10]},
        {from: [3,1], to: [3,15]},
        {from: [4,1], to: [4,15]},
        {from: [5,1], to: [5,15]},
        {from: [7,1], to: [7,15]},
        {from: [9,1], to: [9,15]},
      ]
    },
    class4_7: {
      type: '4',
      weights: [27, 20, 20, 15], // sum 82
      labels: ['Inst 1', 'Inst 2', 'Inst 3', 'Inst 4'],
      windows: [
        {from: [12,1], to: [1,10]},
        {from: [3,1], to: [3,15]},
        {from: [4,1], to: [4,15]},
        {from: [5,1], to: [5,15]},
      ]
    },
    class5: {
      type: '6',
      weights: [44, 23, 22, 32, 26, 17], // sum 164
      labels: ['Inst 1', 'Inst 2', 'Inst 3', 'Inst 4', 'Inst 5', 'Inst 6'],
      windows: [
        {from: [12,1], to: [1,10]},
        {from: [3,1], to: [3,15]},
        {from: [4,1], to: [4,15]},
        {from: [5,1], to: [5,15]},
        {from: [7,1], to: [7,15]},
        {from: [9,1], to: [9,15]},
      ]
    },
    class6: {
      type: '6',
      weights: [236, 115, 110, 160, 160, 100], // sum 881
      labels: ['Inst 1', 'Inst 2', 'Inst 3', 'Inst 4', 'Inst 5', 'Inst 6'],
      windows: [
        {from: [12,1], to: [1,10]},
        {from: [3,1], to: [3,15]},
        {from: [4,1], to: [4,15]},
        {from: [5,1], to: [5,15]},
        {from: [7,1], to: [7,15]},
        {from: [9,1], to: [9,15]},
      ]
    },
    monthly: {
      type: 'monthly',
      weights: [2, 1, 1, 1, 1, 1, 2, 1, 1, 1], // sum 12
      labels: ['Jan (2 months)', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul (2 months)', 'Aug', 'Sep', 'Oct'],
      windows: [
        {from: [1,1], to: [1,31]},
        {from: [2,1], to: [2,28]},
        {from: [3,1], to: [3,31]},
        {from: [4,1], to: [4,30]},
        {from: [5,1], to: [5,31]},
        {from: [6,1], to: [6,30]},
        {from: [7,1], to: [7,31]},
        {from: [8,1], to: [8,31]},
        {from: [9,1], to: [9,30]},
        {from: [10,1], to: [10,31]},
      ]
    },
    '2inst': {
      type: '2',
      discount: 0.96,
      weights: [1, 1], // sum 2
      labels: ['1st Half (48%)', '2nd Half (48%)'],
      windows: [
        {from: [1,1], to: [1,10]},
        {from: [7,1], to: [7,5]},
      ]
    },
    full: {
      type: 'full',
      discount: 0.95,
      weights: [1],
      labels: ['Full Year (5% off)'],
      windows: [
        {from: [1,1], to: [1,10]},
      ]
    }
  };
  // Get config for student
  function getConfig(student) {
    const plan = (student.paymentPlan || '').toLowerCase();
    const c = (student.classLevel || '').toLowerCase();
    if (plan.includes('monthly')) return installmentConfigs.monthly;
    if (plan.includes('2')) return installmentConfigs['2inst'];
    if (plan.includes('full')) return installmentConfigs.full;
    if (plan.includes('4') || (plan.includes('inst') && (c === 'class 4' || c === 'class 7'))) return installmentConfigs.class4_7;
    if (plan.includes('inst')) {
      if (c === 'class 1' || c === 'class 2' || c === 'class 3') return installmentConfigs.lower;
      if (c === 'class 5') return installmentConfigs.class5;
      if (c === 'class 6') return installmentConfigs.class6;
    }
    // default
    return installmentConfigs.full;
  }
  // Build plan schedule for a student (windows + expected amounts)
  // Returns: { items: [{key,label,fromTS,toTS,amount, paidAllocated, status}], periodLabelNow, expectedToDate }
  function buildSchedule(student) {
    const config = getConfig(student);
    const { y } = todayYMD();
    let feeBase = Number(student.feePerYear) || 0;
    const discount = config.discount || 1;
    feeBase = Math.round(feeBase * discount);
    const weights = config.weights;
    const amounts = apportion(feeBase, weights);
    const sc = [];
    config.labels.forEach((label, i) => {
      let fromY = y, toY = y;
      const fromM = config.windows[i].from[0], fromD = config.windows[i].from[1];
      const toM = config.windows[i].to[0], toD = config.windows[i].to[1];
      if (fromM === 12) fromY = y - 1;
      if (toM === 12) toY = y - 1;
      const fromTS = dateFromYMD(fromY, fromM, fromD);
      const toTS = dateFromYMD(toY, toM, toD);
      sc.push({ key: `inst${i+1}`, label, fromTS, toTS, amount: amounts[i] });
    });
    // Determine current period label for “Debt till …”
    const now = Date.now();
    let lastDueIndex = -1;
    let periodLabel = '—';
    let expectedToDate = 0;
    sc.forEach((it, idx) => {
      if (it.toTS < now) { lastDueIndex = idx; expectedToDate += it.amount; }
    });
    if (lastDueIndex >= 0) periodLabel = sc[lastDueIndex].label;
    // initialize paidAllocated/status
    sc.forEach(it => { it.paidAllocated = 0; it.status = 'Pending'; });
    return { items: sc, periodLabelNow: periodLabel, expectedToDate };
  }
  // Allocate payments: previousDebt first, then schedule oldest→newest, then credit
  // Returns { scheduleItems, prevDebtAfter, credit, totalPaid, debtTillNow }
  function allocatePayments(student, schedule) {
    const payList = [];
    if (student.payments) {
      Object.values(student.payments).forEach(p => {
        payList.push({ amount: clamp(p.amount), ts: Number(p.timestamp)||0 });
      });
    }
    payList.sort((a,b)=>a.ts - b.ts);
    let pot = payList.reduce((s,p)=>s + p.amount, 0);
    const totalPaid = pot;
    // 1) previous debt
    let prevDebt = clamp(student.previousDebt || student.debt);
    let toPrev = Math.min(prevDebt, pot);
    prevDebt -= toPrev;
    pot -= toPrev;
    // 2) Schedule
    for (const it of schedule.items) {
      const need = Math.max(0, it.amount - it.paidAllocated);
      if (need <= 0) continue;
      if (pot <= 0) break;
      const use = Math.min(need, pot);
      it.paidAllocated += use;
      pot -= use;
    }
    // 3) Credit
    const credit = Math.max(0, pot);
    // Status
    const now = Date.now();
    for (const it of schedule.items) {
      const a = it.paidAllocated;
      const need = it.amount;
      if (a >= need) {
        it.status = 'Cleared';
      } else {
        if (isPast(it.toTS)) {
          it.status = a > 0 ? 'Partially Paid (Overdue)' : 'Overdue';
        } else {
          it.status = a > 0 ? 'Partially Paid' : 'Pending';
        }
      }
    }
    // Debt till now
    const expectedToDate = schedule.items.filter(it => it.toTS < now).reduce((s,it)=>s + it.amount, 0);
    const paidConsumed = totalPaid - credit;
    const debtTillNow = Math.max(0, expectedToDate - paidConsumed);
    return { scheduleItems: schedule.items, prevDebtAfter: prevDebt, credit, totalPaid, debtTillNow };
  }
  // Compute financials for rendering
  function computeStudentFinancials(student) {
    const feePerYear = Number(student.feePerYear) || 0;
    const previousDebt = clamp(student.previousDebt || student.debt);
    const schedule = buildSchedule(student);
    const alloc = allocatePayments(student, schedule);
    const paidAfterPrev = Math.max(0, alloc.totalPaid - (previousDebt - alloc.prevDebtAfter));
    const yearBalance = Math.max(0, feePerYear - paidAfterPrev);
    return {
      feePerYear,
      previousDebt,
      paidAmount: alloc.totalPaid,
      balance: yearBalance,
      periodDebtLabel: schedule.periodLabelNow || '—',
      periodDebtValue: alloc.debtTillNow,
      credit: alloc.credit,
      scheduleItems: alloc.scheduleItems
    };
  }
  // ====================== RENDER TABLE ======================
  function breakdownRowHTML(id, fin) {
    return `
      <tr id="br-${id}" class="hidden bg-slate-50">
        <td class="p-2 border-t" colspan="10">
          <iframe src="Tofinancehtml/payment.html?student=${id}" width="100%" height="400" frameborder="0"></iframe>
        </td>
      </tr>
    `;
  }
  function renderTable() {
    tbody.innerHTML = '';
    let totalDue = 0, totalCollected = 0;
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, student]) => {
      if (filterClass && student.classLevel !== filterClass) return;
      const fin = computeStudentFinancials(student);
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.periodDebtValue <= 0)) return;
      totalDue += fin.feePerYear;
      totalCollected += fin.paidAmount;
      const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();
      const debtLabel = fin.periodDebtValue > 0 ? `Debt till ${fin.periodDebtLabel}` : '—';
      const tr = document.createElement('tr');
      tr.className = 'table-row';
      tr.innerHTML = `
        <td class="p-2 border text-center align-top">
          <button class="expander text-indigo-600 hover:text-indigo-800" data-id="${id}" title="Expand/Collapse"><i class="fa fa-chevron-down"></i></button>
        </td>
        <td class="p-2 border align-top">${student.admissionNumber || ''}</td>
        <td class="p-2 border align-top">${fullName}</td>
        <td class="p-2 border align-top">${student.classLevel || ''}</td>
        <td class="p-2 border align-top text-right">${fmt(fin.feePerYear)}</td>
        <td class="p-2 border align-top">${student.paymentPlan || ''}</td>
        <td class="p-2 border align-top text-right">${fmt(fin.paidAmount)}</td>
        <td class="p-2 border align-top text-right">${fmt(fin.balance)}</td>
        <td class="p-2 border align-top">
          <div class="flex items-center justify-between gap-2">
            <span>${debtLabel}</span>
            <span class="font-semibold ${fin.periodDebtValue > 0 ? 'text-red-700' : ''}">${fmt(fin.periodDebtValue)}</span>
          </div>
        </td>
        <td class="p-2 border align-top">
          <button class="viewBtn px-2 py-1 text-xs border rounded" data-id="${id}">View</button>
          <button class="payBtn px-2 py-1 text-xs bg-indigo-600 text-white rounded ml-1" data-id="${id}">Pay</button>
        </td>
      `;
      tbody.appendChild(tr);
      const br = document.createElement('tbody');
      br.innerHTML = breakdownRowHTML(id, fin);
      tbody.appendChild(br.firstElementChild);
    });
    const totalOutstanding = totalDue - totalCollected;
    document.getElementById('totalDue').textContent = fmt(totalDue);
    document.getElementById('totalCollected').textContent = fmt(totalCollected);
    document.getElementById('totalOutstanding').textContent = fmt(totalOutstanding);
    // attach events
    tbody.querySelectorAll('.payBtn').forEach(btn => btn.addEventListener('click', e => openPaymentModalFor(e.target.dataset.id)));
    tbody.querySelectorAll('.viewBtn').forEach(btn => btn.addEventListener('click', e => openDetailsModal(e.target.dataset.id)));
    tbody.querySelectorAll('.expander').forEach(btn => btn.addEventListener('click', e => {
      const id = e.target.closest('button').dataset.id;
      const row = document.getElementById('br-' + id);
      const icon = e.target.closest('button').querySelector('i');
      if (row.classList.contains('hidden')) {
        row.classList.remove('hidden');
        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
      } else {
        row.classList.add('hidden');
        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
      }
    }));
  }
  // ====================== LOAD & SELECTORS ======================
  async function loadStudents() {
    if (!db) return;
    try {
      const snap = await db.ref('students').once('value');
      cachedStudents = snap.val() || {};
      populateStudentSelect();
      renderTable();
    } catch (err) {
      console.error('Error loading students:', err);
      alert('Error loading students: ' + err.message);
    }
  }
  function populateStudentSelect() {
    studentSelect.innerHTML = '<option value="">-- Select student --</option>';
    Object.entries(cachedStudents).forEach(([id, s]) => {
      const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = `${fullName} — ${s.classLevel || ''} — ${s.admissionNumber || ''}`;
      studentSelect.appendChild(opt);
    });
  }
  function openPaymentModalFor(id) {
    if (!cachedStudents[id]) return alert('Student not found');
    studentSelect.value = id;
    paymentModal.style.display = 'block';
  }
  function closePaymentModalFn() {
    paymentModal.style.display = 'none';
    paymentForm.reset();
  }
  // ====================== DETAILS MODAL (ledger) ======================
  function openDetailsModal(id) {
    const s = cachedStudents[id];
    if (!s) return alert('Student not found');
    const fin = computeStudentFinancials(s);
    const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
    let html = `
      <p><strong>Name:</strong> ${fullName}</p>
      <p><strong>Admission No:</strong> ${s.admissionNumber || ''}</p>
      <p><strong>Class:</strong> ${s.classLevel || ''}</p>
      <p><strong>Fee/year:</strong> ${fmt(fin.feePerYear || 0)}</p>
      <p><strong>Payment Plan:</strong> ${s.paymentPlan || ''}</p>
      <p><strong>Debt till:</strong> ${fin.periodDebtLabel} — <strong>${fmt(fin.periodDebtValue)}</strong></p>
      <p><strong>Paid:</strong> ${fmt(fin.paidAmount)}</p>
      <p><strong>Balance (Year):</strong> ${fmt(fin.balance)}</p>
      <hr class="my-3"/>
      <h4 class="font-semibold">Payments Ledger</h4>
    `;
    if (!s.payments) {
      html += '<div class="text-sm text-gray-500">No payments recorded yet.</div>';
    } else {
      html += `<div class="overflow-auto"><table class="min-w-full text-xs mt-2"><thead><tr class="table-header"><th class="p-1 border">Date</th><th class="p-1 border">Amount</th><th class="p-1 border">Method</th><th class="p-1 border">Note</th></tr></thead><tbody>`;
      Object.values(s.payments).sort((a,b)=> (a.timestamp||0) - (b.timestamp||0)).forEach(p => {
        const d = new Date(p.timestamp || 0).toLocaleString();
        html += `<tr><td class="p-1 border">${d}</td><td class="p-1 border">${fmt(p.amount)}</td><td class="p-1 border">${p.method || ''}</td><td class="p-1 border">${p.note || ''}</td></tr>`;
      });
      html += `</tbody></table></div>`;
    }
    detailsContent.innerHTML = html;
    detailsModal.style.display = 'block';
  }
  function closeDetailsModalFn() { detailsModal.style.display = 'none'; detailsContent.innerHTML = ''; }
  // ====================== PAYMENT SAVE (ledger source-of-truth) ======================
  paymentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const studentId = studentSelect.value;
    const amount = Number(document.getElementById('paymentAmount').value || 0);
    const method = document.getElementById('paymentMethod').value || 'Cash';
    const note = document.getElementById('paymentNote').value || '';
    if (!studentId) return alert('Choose a student');
    if (amount <= 0) return alert('Enter a valid amount');
    try {
      const studentRef = db.ref('students/' + studentId);
      const snap = await studentRef.once('value');
      const student = snap.val();
      if (!student) throw new Error('Student not found');
      const payment = {
        amount: Math.round(amount),
        method,
        note,
        timestamp: Date.now()
      };
      await studentRef.child('payments').push(payment);
      alert('Payment recorded successfully.');
      closePaymentModalFn();
      await loadStudents();
    } catch (err) {
      console.error('Error recording payment', err);
      alert('Error recording payment: ' + err.message);
    }
  });
  // ====================== EXPORTS (MAIN) ======================
  function downloadCSV_Main() {
    const rows = [['Admission No','Full Name','Class','Fee (Year)','Plan','Paid','Balance (Year)','Debt till …','Debt Amount']];
    let totalFee = 0, totalPaid = 0, totalBal = 0, totalDebt = 0;
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && s.classLevel !== filterClass) return;
      const fin = computeStudentFinancials(s);
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.periodDebtValue <= 0)) return;
      const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.trim();
      rows.push([s.admissionNumber||'', fullName, s.classLevel||'', fin.feePerYear, s.paymentPlan||'', fin.paidAmount, fin.balance, fin.periodDebtLabel, fin.periodDebtValue]);
      totalFee += fin.feePerYear;
      totalPaid += fin.paidAmount;
      totalBal += fin.balance;
      totalDebt += fin.periodDebtValue;
    });
    rows.push(['TOTAL','','',totalFee,'',totalPaid,totalBal,'',totalDebt]);
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Finance');
    XLSX.writeFile(wb, `finance_export_${Date.now()}.xlsx`);
  }
  function downloadPDF_Main() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    const headers = [['Admission No','Full Name','Class','Fee (Year)','Plan','Paid','Balance (Year)','Debt till …','Debt Amount']];
    const body = [];
    let totalFee = 0, totalPaid = 0, totalBal = 0, totalDebt = 0;
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && s.classLevel !== filterClass) return;
      const fin = computeStudentFinancials(s);
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.periodDebtValue <= 0)) return;
      const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.trim();
      body.push([s.admissionNumber||'', fullName, s.classLevel||'', fin.feePerYear, s.paymentPlan||'', fin.paidAmount, fin.balance, fin.periodDebtLabel, fin.periodDebtValue]);
      totalFee += fin.feePerYear;
      totalPaid += fin.paidAmount;
      totalBal += fin.balance;
      totalDebt += fin.periodDebtValue;
    });
    body.push(['TOTAL','','',totalFee,'',totalPaid,totalBal,'',totalDebt]);
    doc.setFontSize(14);
    doc.text('SoMAp Finance Report', 14, 14);
    doc.autoTable({ head: headers, body, startY: 20, styles: { fontSize: 8 } });
    doc.save(`finance_report_${Date.now()}.pdf`);
  }
  // ====================== EXPORTS (CURRENT PERIOD DEBT LIST) ======================
  function _gatherDebtNow() {
    const rows = [];
    let totalDebt = 0;
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && s.classLevel !== filterClass) return;
      const fin = computeStudentFinancials(s);
      if (fin.periodDebtValue > 0) {
        const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.trim();
        rows.push([s.admissionNumber||'', fullName, s.classLevel||'', s.paymentPlan||'', fin.periodDebtLabel, fin.periodDebtValue]);
        totalDebt += fin.periodDebtValue;
      }
    });
    return { rows, totalDebt };
  }
  function downloadCSV_DebtNow() {
    const header = ['Admission No','Full Name','Class','Plan','Debt till …','Debt Amount'];
    const { rows, totalDebt } = _gatherDebtNow();
    const data = [header, ...rows, ['TOTAL','','','','', totalDebt]];
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Debt Now');
    XLSX.writeFile(wb, `debt_now_${Date.now()}.xlsx`);
  }
  function downloadPDF_DebtNow() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    const header = [['Admission No','Full Name','Class','Plan','Debt till …','Debt Amount']];
    const { rows, totalDebt } = _gatherDebtNow();
    const body = [...rows, ['TOTAL','','','','', totalDebt]];
    doc.setFontSize(14);
    doc.text('Debt List (Current Period)', 14, 14);
    doc.autoTable({ head: header, body, startY: 20, styles: {fontSize:8} });
    doc.save(`debt_now_${Date.now()}.pdf`);
  }
  // ====================== EXPORTS (BREAKDOWN) ======================
  function _gatherBreakdown() {
    const sheets = [];
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && s.classLevel !== filterClass) return;
      const fin = computeStudentFinancials(s);
      const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.trim();
      const rows = [['Period','Expected','Allocated Paid','Remaining','Status','Window']];
      let totalExp = 0, totalPaid = 0;
      fin.scheduleItems.forEach(it => {
        const need = it.amount;
        const got = it.paidAllocated;
        const rem = Math.max(0, need - got);
        totalExp += need;
        totalPaid += got;
        rows.push([it.label, need, got, rem, it.status, `${new Date(it.fromTS).toLocaleDateString()} – ${new Date(it.toTS).toLocaleDateString()}`]);
      });
      const totalRem = Math.max(0, totalExp - totalPaid);
      rows.push(['TOTAL', totalExp, totalPaid, totalRem, '', '']);
      sheets.push({ title: `${fullName} (${s.admissionNumber||''})`, rows });
    });
    return sheets;
  }
  function downloadCSV_Breakdown() {
    const wb = XLSX.utils.book_new();
    const sheets = _gatherBreakdown();
    if (!sheets.length) return alert('No students to export.');
    sheets.forEach(sh => {
      const ws = XLSX.utils.aoa_to_sheet(sh.rows);
      XLSX.utils.book_append_sheet(wb, ws, sh.title.slice(0,31));
    });
    XLSX.writeFile(wb, `breakdowns_${Date.now()}.xlsx`);
  }
  function downloadPDF_Breakdown() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    const sheets = _gatherBreakdown();
    if (!sheets.length) return alert('No students to export.');
    sheets.forEach((sh, idx) => {
      if (idx > 0) doc.addPage();
      doc.setFontSize(14);
      doc.text(`Installment Breakdown — ${sh.title}`, 14, 14);
      doc.autoTable({ head: [['Period','Expected','Allocated Paid','Remaining','Status','Window']], body: sh.rows.slice(1), startY: 20, styles: {fontSize:8} });
    });
    doc.save(`breakdowns_${Date.now()}.pdf`);
  }
  // ====================== EXPENSES (kept) ======================
  const expenseForm = document.getElementById('expenseForm');
  const expenseTableBody = document.querySelector('#expenseTable tbody');
  async function loadExpenses() {
    try {
      const snap = await db.ref('expenses').once('value');
      const raw = snap.val() || {};
      expenseTableBody.innerHTML = '';
      let total = 0;
      Object.values(raw).forEach(exp => {
        total += Number(exp.amount) || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 border">${exp.category || ''}</td>
          <td class="p-2 border">${exp.description || ''}</td>
          <td class="p-2 border text-right">${fmt(exp.amount)}</td>
          <td class="p-2 border">${exp.timestamp ? new Date(exp.timestamp).toLocaleDateString() : ''}</td>
        `;
        expenseTableBody.appendChild(tr);
      });
      document.getElementById('totalExpenses').textContent = fmt(total);
      const collected = Number(document.getElementById('totalCollected').textContent.replace(/,/g, '')) || 0;
      document.getElementById('netBalance').textContent = fmt(collected - total);
    } catch (err) {
      console.error('Error loading expenses:', err);
    }
  }
  expenseForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const category = document.getElementById('expenseCategory').value;
    const description = document.getElementById('expenseDescription').value;
    const amount = Number(document.getElementById('expenseAmount').value);
    if (!category || !description || amount <= 0) return alert('Fill all fields');
    try {
      await db.ref('expenses').push({ category, description, amount, timestamp: Date.now() });
      expenseForm.reset();
      await loadExpenses();
    } catch (err) {
      console.error('Error saving expense:', err);
      alert('Error saving expense');
    }
  });
  // ====================== EVENTS & INIT ======================
  closePaymentModal.addEventListener('click', closePaymentModalFn);
  cancelPayment.addEventListener('click', closePaymentModalFn);
  closeDetailsModal.addEventListener('click', closeDetailsModalFn);
  showOnlyDebtorsBtn.addEventListener('click', () => {
    showingDebtorsOnly = !showingDebtorsOnly;
    showOnlyDebtorsBtn.textContent = showingDebtorsOnly ? 'Showing Debtors' : 'Show Debtors';
    renderTable();
  });
  downloadCsvBtn.addEventListener('click', downloadCSV_Main);
  downloadPdfBtn.addEventListener('click', downloadPDF_Main);
  downloadDebtNowCsvBtn.addEventListener('click', downloadCSV_DebtNow);
  downloadDebtNowPdfBtn.addEventListener('click', downloadPDF_DebtNow);
  downloadBreakdownCsvBtn.addEventListener('click', downloadCSV_Breakdown);
  downloadBreakdownPdfBtn.addEventListener('click', downloadPDF_Breakdown);
  reloadBtn.addEventListener('click', async () => { await loadStudents(); await loadExpenses(); });
  window.addEventListener('click', ev => {
    if (ev.target === paymentModal) closePaymentModalFn();
    if (ev.target === detailsModal) closeDetailsModalFn();
  });
  classFilter.addEventListener('change', renderTable);
  document.addEventListener('DOMContentLoaded', () => { loadStudents(); loadExpenses(); });
  // Expense downloads (kept from your code)
  document.getElementById("downloadExpenseCsv").addEventListener("click", () => {
    const rows = [["Category", "Description", "Amount", "Date"]];
    document.querySelectorAll("#expenseTable tbody tr").forEach(tr => {
      const cells = [...tr.querySelectorAll("td")].map(td => td.innerText);
      rows.push(cells);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Expenses");
    XLSX.writeFile(wb, "expenses_report.xlsx");
  });
  document.getElementById("downloadExpensePdf").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Expense Report", 14, 10);
    const rows = [];
    document.querySelectorAll("#expenseTable tbody tr").forEach(tr => {
      const cells = [...tr.querySelectorAll("td")].map(td => td.innerText);
      rows.push(cells);
    });
    doc.autoTable({
      head: [["Category", "Description", "Amount", "Date"]],
      body: rows,
      startY: 20,
    });
    doc.save("expenses_report.pdf");
  });
})(); // end IIFE
</script>
</body>
</html>