<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoMAp - Finance Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Enhanced styling for attractiveness */
    .tab-button {
      transition: all 0.3s ease;
    }
    .tab-button.active {
      color: #4f46e5;
      border-bottom-color: #4f46e5;
    }
    .table-header {
      background-color: #f3f4f6;
      color: #4b5563;
    }
    .table-row:nth-child(even) {
      background-color: #f9fafb;
    }
    .download-btn {
      background-color: #4f46e5;
      color: white;
      transition: all 0.3s ease;
    }
    .download-btn:hover {
      background-color: #4338ca;
    }
    .section-header {
      color: #1f2937;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    .modal-content {
      position: relative;
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      height: 80vh;
      overflow-y: auto;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="firebase.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 p-4">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
    <h2 class="text-2xl font-bold mb-4">Finance Management</h2>
    <p class="text-sm text-gray-500 mb-4">Manage fees, payments, expenses, and reports.</p>
    <!-- Tabs for different sections -->
    <div class="flex border-b mb-4">
      <button class="finance-tab px-4 py-2 font-medium border-b-2 border-indigo-500 text-indigo-600 active" data-tab="fee-collection">Fee Collection</button>
      <button class="finance-tab px-4 py-2 font-medium text-gray-500 hover:text-indigo-700" data-tab="expenses">Expenses</button>
      <button class="finance-tab px-4 py-2 font-medium text-gray-500 hover:text-indigo-700" data-tab="reports">Reports</button>
    </div>
    <!-- Fee Collection Tab -->
    <div class="finance-tab-content active" data-tab="fee-collection">
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="font-medium text-gray-800">Fee Collection Overview</h3>
        <p class="text-sm text-gray-500 mb-3">View and manage student fees.</p>
        <select id="student-search" class="w-full p-2 border rounded-lg mb-3">
          <option>Select Student</option>
        </select>
        <table id="student-finance-table" class="w-full text-sm border-collapse">
          <thead>
            <tr class="table-header bg-indigo-100">
              <th class="p-2 border">Admission No</th>
              <th class="p-2 border">Full Name</th>
              <th class="p-2 border">Class</th>
              <th class="p-2 border">Total Fee</th>
              <th class="p-2 border">Payment Plan</th>
              <th class="p-2 border">Paid</th>
              <th class="p-2 border">Balance</th>
              <th class="p-2 border">Debt</th>
              <th class="p-2 border">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <!-- Payment Form -->
        <div class="mt-4">
          <h4 class="font-medium text-gray-800 mb-2">Record Payment</h4>
          <form id="paymentForm" class="space-y-4">
            <select id="studentSelect" required class="w-full p-2 border rounded-lg">
              <option>Select Student</option>
            </select>
            <input type="number" id="paymentAmount" placeholder="Payment Amount" required class="w-full p-2 border rounded-lg">
            <select id="paymentMethod" required class="w-full p-2 border rounded-lg">
              <option>Select Payment Method</option>
              <option>M-Pesa</option>
              <option>Airtel Money</option>
              <option>TigoPesa</option>
              <option>Bank Transfer</option>
              <option>Cash</option>
            </select>
            <button type="submit" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Record Payment</button>
          </form>
        </div>
      </div>
    </div>
    <!-- Expenses Tab -->
    <div class="finance-tab-content" data-tab="expenses">
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="font-medium text-gray-800">Expenses Management</h3>
        <p class="text-sm text-gray-500 mb-3">Record and track school expenses.</p>
        <form id="expenseForm" class="space-y-4">
          <select id="expenseCategory" required class="w-full p-2 border rounded-lg">
            <option>Select Category</option>
            <option>FOOD</option>
            <option>SALARIES</option>
            <option>OFFICE</option>
            <option>EDUCATION</option>
            <option>WATER & ELECTRICITY</option>
            <option>SANITATION</option>
            <option>ENVIRONMENT</option>
            <option>HEALTH</option>
            <option>SECURITY</option>
            <option>CLOTHING</option>
            <option>SHELTER</option>
            <option>RECREATION</option>
            <option>PROJECTS</option>
            <option>TRANSPORT</option>
            <option>PURCHASES</option>
            <option>SIL</option>
            <option>MAINTENANCE</option>
            <option>BOOKS</option>
            <option>EMERGENCY</option>
            <option>MISCELLANEOUS</option>
          </select>
          <input type="text" id="expenseDescription" placeholder="Description" required class="w-full p-2 border rounded-lg">
          <input type="number" id="expenseAmount" placeholder="Amount" required class="w-full p-2 border rounded-lg">
          <button type="submit" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Record Expense</button>
        </form>
        <table id="expense-table" class="w-full text-sm border-collapse mt-4">
          <thead>
            <tr class="table-header bg-indigo-100">
              <th class="p-2 border">Category</th>
              <th class="p-2 border">Description</th>
              <th class="p-2 border">Amount</th>
              <th class="p-2 border">Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- Reports Tab -->
    <div class="finance-tab-content" data-tab="reports">
      <div class="bg-white rounded-lg shadow p-4">
        <h3 class="font-medium text-gray-800">Financial Reports</h3>
        <p class="text-sm text-gray-500 mb-3">Generate and download reports.</p>
        <button onclick="generateFeeReport('csv')" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 mb-2">Download Fee Report (CSV)</button>
        <button onclick="generateFeeReport('pdf')" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 mb-2">Download Fee Report (PDF)</button>
        <button onclick="generateExpenseReport('csv')" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 mb-2">Download Expense Report (CSV)</button>
        <button onclick="generateExpenseReport('pdf')" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Download Expense Report (PDF)</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Initialization
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // Tab Switching
    const tabs = document.querySelectorAll('.finance-tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-600'));
        tab.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-600');
        document.querySelectorAll('.finance-tab-content').forEach(content => content.classList.remove('active'));
        document.querySelector(`.finance-tab-content[data-tab="${tab.dataset.tab}"]`).classList.add('active');
        if (tab.dataset.tab === 'fee-collection') loadStudentFinances();
        if (tab.dataset.tab === 'expenses') loadExpenses();
      });
    });

    // Load Student Finances
    async function loadStudentFinances() {
      const snapshot = await db.ref('students').once('value');
      const students = snapshot.val() || {};
      const studentArray = Object.values(students);
      const tableBody = document.querySelector('#student-finance-table tbody');
      tableBody.innerHTML = '';
      studentArray.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-2 border">${student.admissionNumber || ''}</td>
          <td class="p-2 border">${student.firstName} ${student.middleName || ''} ${student.lastName}</td>
          <td class="p-2 border">${student.classLevel || ''}</td>
          <td class="p-2 border">${student.feePerYear || '$0'}</td>
          <td class="p-2 border">${student.paymentPlan || 'N/A'}</td>
          <td class="p-2 border">${student.paidAmount || '$0'}</td>
          <td class="p-2 border">${student.balance || '$0'}</td>
          <td class="p-2 border">${student.debt || '$0'}</td>
          <td class="p-2 border"><i class="fas fa-eye cursor-pointer" onclick="viewStudentDetails('${student.id}')"></i></td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Record Payment
    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentId = document.getElementById('studentSelect').value;
      const amount = parseFloat(document.getElementById('paymentAmount').value);
      const method = document.getElementById('paymentMethod').value;

      if (!studentId || isNaN(amount) || amount <= 0) {
        alert('Invalid input');
        return;
      }

      try {
        const studentRef = db.ref('students/' + studentId);
        const snapshot = await studentRef.once('value');
        let student = snapshot.val();
        if (!student) return;

        // Allocate payment
        let remaining = amount;
        // Apply to debt first
        if (student.debt > 0) {
          const debtReduction = Math.min(remaining, student.debt);
          student.debt -= debtReduction;
          remaining -= debtReduction;
        }

        // Apply to balance
        if (remaining > 0 && student.balance > 0) {
          const balanceReduction = Math.min(remaining, student.balance);
          student.balance -= balanceReduction;
          student.paidAmount = (student.paidAmount || 0) + balanceReduction;
          remaining -= balanceReduction;
        }

        // Carry over to next installment if remaining
        if (remaining > 0) {
          student.credit = (student.credit || 0) + remaining;
        }

        // Update student in Firebase
        await studentRef.update(student);

        alert('Payment recorded successfully!');
        document.getElementById('paymentForm').reset();
        loadStudentFinances();
      } catch (err) {
        alert('Error recording payment: ' + err.message);
      }
    });

    // Load Expenses
    async function loadExpenses() {
      const snapshot = await db.ref('expenses').once('value');
      const expenses = snapshot.val() || {};
      const expenseArray = Object.values(expenses);
      const tableBody = document.querySelector('#expense-table tbody');
      tableBody.innerHTML = '';
      expenseArray.forEach(expense => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-2 border">${expense.category || ''}</td>
          <td class="p-2 border">${expense.description || ''}</td>
          <td class="p-2 border">${expense.amount || ''}</td>
          <td class="p-2 border">${expense.timestamp ? new Date(expense.timestamp).toLocaleDateString() : 'N/A'}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Record Expense
    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const category = document.getElementById('expenseCategory').value;
      const description = document.getElementById('expenseDescription').value;
      const amount = parseFloat(document.getElementById('expenseAmount').value);

      if (!category || !description || isNaN(amount) || amount <= 0) {
        alert('Invalid input');
        return;
      }

      try {
        await db.ref('expenses').push({
          category,
          description,
          amount,
          timestamp: Date.now()
        });
        alert('Expense recorded successfully!');
        document.getElementById('expenseForm').reset();
        loadExpenses();
      } catch (err) {
        alert('Error recording expense: ' + err.message);
      }
    });

    // Generate Fee Report
    async function generateFeeReport(type) {
      const snapshot = await db.ref('students').once('value');
      const students = snapshot.val() || {};
      const data = Object.values(students).map(student => ({
        'Admission No': student.admissionNumber || '',
        'Full Name': `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`,
        'Class': student.classLevel || '',
        'Total Fee': student.feePerYear || '0',
        'Payment Plan': student.paymentPlan || 'N/A',
        'Paid': student.paidAmount || '0',
        'Balance': student.balance || '0',
        'Debt': student.debt || '0'
      }));

      if (type === 'csv') {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Fee Report');
        XLSX.writeFile(wb, 'fee-report.xlsx');
      } else if (type === 'pdf') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });
        doc.text('Fee Report', 10, 10);
        doc.autoTable({
          head: [['Admission No', 'Full Name', 'Class', 'Total Fee', 'Payment Plan', 'Paid', 'Balance', 'Debt']],
          body: data.map(d => Object.values(d)),
          startY: 15,
          styles: { fontSize: 8 }
        });
        doc.save('fee-report.pdf');
      }
    }

    // Generate Expense Report
    async function generateExpenseReport(type) {
      const snapshot = await db.ref('expenses').once('value');
      const expenses = snapshot.val() || {};
      const data = Object.values(expenses).map(expense => ({
        'Category': expense.category || '',
        'Description': expense.description || '',
        'Amount': expense.amount || '0',
        'Date': expense.timestamp ? new Date(expense.timestamp).toLocaleDateString() : 'N/A'
      }));

      if (type === 'csv') {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Expense Report');
        XLSX.writeFile(wb, 'expense-report.xlsx');
      } else if (type === 'pdf') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });
        doc.text('Expense Report', 10, 10);
        doc.autoTable({
          head: [['Category', 'Description', 'Amount', 'Date']],
          body: data.map(d => Object.values(d)),
          startY: 15,
          styles: { fontSize: 8 }
        });
        doc.save('expense-report.pdf');
      }
    }

    // Load students for payment dropdown
    async function loadStudentSelect() {
      const snapshot = await db.ref('students').once('value');
      const students = snapshot.val() || {};
      const select = document.getElementById('studentSelect');
      select.innerHTML = '<option>Select Student</option>';
      Object.entries(students).forEach(([id, student]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = `${student.firstName} ${student.middleName || ''} ${student.lastName} (${student.admissionNumber})`;
        select.appendChild(option);
      });
    }

    loadStudentFinances();
    loadExpenses();
    loadStudentSelect();
  </script>
</body>
</html>