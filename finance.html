<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Firebase SDKs (same as index.html, version 9 compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>

<!-- Your Firebase config wrapper -->
<script src="firebase.js"></script>
  <title>SoMAp - Finance</title>

  <!-- Tailwind + FontAwesome (same style as your app) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <style>
    body { background: #f8fafc; }
    .table-header { background: #eef2ff; color: #1f2937; }
    .table-row:nth-child(even) { background: #ffffff; }
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { background:#fff; max-width:800px; margin:4% auto; padding:18px; border-radius:8px; height:80vh; overflow:auto; }
  </style>

  <!-- Third-party libs for export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

</head>
<body class="p-6">

  <div class="max-w-6xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold text-indigo-700">SoMAp — Finance</h1>
      <div class="space-x-2">
        <button id="reloadBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">Reload</button>
        <a href="index.html" class="px-3 py-1 border rounded text-sm">Back to Dashboard</a>
      </div>
    </header>

    <!-- Summary cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-sm text-gray-500">Total Due (All Students)</h3>
    <div id="totalDue" class="text-xl font-semibold mt-2">--</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-sm text-gray-500">Total Collected</h3>
    <div id="totalCollected" class="text-xl font-semibold mt-2">--</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-sm text-gray-500">Total Outstanding</h3>
    <div id="totalOutstanding" class="text-xl font-semibold mt-2">--</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-sm text-gray-500">Total Expenses</h3>
    <div id="totalExpenses" class="text-xl font-semibold mt-2">--</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-sm text-gray-500">Net Balance (Collected - Expenses)</h3>
    <div id="netBalance" class="text-xl font-semibold mt-2">--</div>
  </div>
</div>

    <!-- Action Row -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <label class="text-sm text-gray-600">Filter by class</label>
        <select id="classFilter" class="p-2 border rounded">
          <option value="">All Classes</option>
          <option>Baby Class</option>
          <option>Class 1</option>
          <option>Class 2</option>
          <option>Class 3</option>
          <option>Class 4</option>
          <option>Class 5</option>
          <option>Class 6</option>
          <option>Class 7</option>
        </select>
        <button id="showOnlyDebtors" class="px-3 py-1 bg-yellow-500 text-white rounded text-sm">Show Debtors</button>
      </div>

      <div class="flex items-center gap-2">
        <button id="downloadCsv" class="px-3 py-1 bg-indigo-600 text-white rounded">Download CSV</button>
        <button id="downloadPdf" class="px-3 py-1 bg-red-600 text-white rounded">Download PDF</button>
      </div>
    </div>

    <!-- Finance table -->
    <div class="bg-white rounded shadow overflow-x-auto">
      <table id="financeTable" class="min-w-full text-sm">
        <thead>
          <tr class="table-header">
            <th class="p-2 border">Admission No</th>
            <th class="p-2 border">Full Name</th>
            <th class="p-2 border">Class</th>
            <th class="p-2 border">Fee (year)</th>
            <th class="p-2 border">Payment Plan</th>
            <th class="p-2 border">Paid</th>
            <th class="p-2 border">Balance</th>
            <th class="p-2 border">Debt</th>
            <th class="p-2 border">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- Expenses Management -->
<div class="bg-white rounded shadow p-4 mt-6">
  <h2 class="text-lg font-semibold text-indigo-700 mb-3">Expenses</h2>

  <form id="expenseForm" class="grid md:grid-cols-4 gap-3 mb-4">
    <select id="expenseCategory" required class="p-2 border rounded">
  <option value="">Select Category</option>
  <option>FOOD</option>
  <option>SALARIES</option>
  <option>OFFICE</option>
  <option>EDUCATION</option>
  <option>WATER & ELECTRICITY</option>
  <option>SANITATION</option>
  <option>ENVIRONMENT</option>
  <option>HEALTH</option>
  <option>SECURITY</option>
  <option>CLOTHING</option>
  <option>SHELTER</option>
  <option>RECREATION</option>
  <option>PROJECTS</option>
  <option>TRANSPORT</option>
  <option>PURCHASES</option>
  <option>SIL</option>
  <option>MAINTENANCE</option>
  <option>BOOKS</option>
  <option>EMERGENCY</option>
  <option>MISCELLANEOUS</option>
</select>
    <input id="expenseDescription" type="text" placeholder="Description" required class="p-2 border rounded">
    <input id="expenseAmount" type="number" min="1" placeholder="Amount" required class="p-2 border rounded">
    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Add Expense</button>
  </form>
  <div class="flex items-center gap-2 mb-3">
  <button id="downloadExpenseCsv" class="px-3 py-1 bg-green-600 text-white rounded">
    Download Expense Report (CSV)
  </button>
  <button id="downloadExpensePdf" class="px-3 py-1 bg-red-600 text-white rounded">
    Download Expense Report (PDF)
  </button>
</div>

  <table id="expenseTable" class="min-w-full text-sm border">
    <thead>
      <tr class="table-header">
        <th class="p-2 border">Category</th>
        <th class="p-2 border">Description</th>
        <th class="p-2 border">Amount</th>
        <th class="p-2 border">Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

    <!-- Payment modal -->
    <div id="paymentModal" class="modal">
      <div class="modal-content">
        <span id="closePaymentModal" class="float-right cursor-pointer text-2xl">&times;</span>
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Record Payment</h2>

        <form id="paymentForm" class="space-y-3">
          <div>
            <label class="text-sm text-gray-600">Student</label>
            <select id="studentSelect" class="w-full p-2 border rounded" required></select>
          </div>

          <div>
            <label class="text-sm text-gray-600">Amount</label>
            <input id="paymentAmount" type="number" step="1" min="1" class="w-full p-2 border rounded" required />
          </div>

          <div>
            <label class="text-sm text-gray-600">Method</label>
            <select id="paymentMethod" class="w-full p-2 border rounded">
              <option>Cash</option>
              <option>MPesa</option>
              <option>Airtel Money</option>
              <option>TigoPesa</option>
              <option>Bank Transfer</option>
              <option>Other</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-gray-600">Note (optional)</label>
            <input id="paymentNote" type="text" class="w-full p-2 border rounded" />
          </div>

          <div class="flex space-x-2">
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Save Payment</button>
            <button id="cancelPayment" type="button" class="px-4 py-2 border rounded">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Details modal -->
    <div id="detailsModal" class="modal">
      <div class="modal-content">
        <span id="closeDetailsModal" class="float-right cursor-pointer text-2xl">&times;</span>
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Student Finance Details</h2>
        <div id="detailsContent"></div>
      </div>
    </div>
  </div>

<script>
/*
  finance.html
  - Relies on firebase.js to already initialize Firebase and expose window.db and window.storage
  - Save as finance.html in same folder with index.html and firebase.js
*/

(function () {
  // Ensure db is available from firebase.js
  const db = window.db || null;
  const storage = window.storage || null;

  // DOM handles
  const tbody = document.querySelector('#financeTable tbody');
  const studentSelect = document.getElementById('studentSelect');
  const paymentModal = document.getElementById('paymentModal');
  const closePaymentModal = document.getElementById('closePaymentModal');
  const paymentForm = document.getElementById('paymentForm');
  const cancelPayment = document.getElementById('cancelPayment');
  const detailsModal = document.getElementById('detailsModal');
  const closeDetailsModal = document.getElementById('closeDetailsModal');
  const detailsContent = document.getElementById('detailsContent');
  const classFilter = document.getElementById('classFilter');
  const showOnlyDebtorsBtn = document.getElementById('showOnlyDebtors');
  const downloadCsvBtn = document.getElementById('downloadCsv');
  const downloadPdfBtn = document.getElementById('downloadPdf');
  const reloadBtn = document.getElementById('reloadBtn');

  let cachedStudents = {}; // key => student
  let showingDebtorsOnly = false;

  // Helpful guard
  if (!db) {
    console.error('Realtime Database (db) not found. finance.html expects firebase.js to have initialized Firebase and set window.db.');
    alert('DB not ready. Make sure firebase.js initializes Firebase and exposes window.db.');
    // still continue so user can read UI, but no data will appear
  }

  // Utility: format money
  function fmt(n) {
    n = Number(n) || 0;
    return n.toLocaleString();
  }
// Returns installment amount per class
function classInstalment(className, instNo) {
  className = (className || "").toLowerCase();
  if (["class 1", "class 2", "class 3"].includes(className)) {
    const values = [184000, 36000, 65000, 60000, 110000, 110000, 80000];
    return values[instNo] || 0;
  }
  if (["class 4", "class 7"].includes(className)) {
    const values = [234000, 36000, 200000, 200000, 150000, 0, 0];
    return values[instNo] || 0;
  }
  if (["class 5"].includes(className)) {
    const values = [184000, 36000, 115000, 110000, 160000, 130000, 85000];
    return values[instNo] || 0;
  }
  if (["class 6"].includes(className)) {
    const values = [236000, 0, 115000, 110000, 160000, 160000, 100000];
    return values[instNo] || 0;
  }
  return 0;
}

  // Compute financials for a student from stored payments (source-of-truth)
  // Returns object: { paidAmount, totalDue, previousDebt, balance, credit, installments }
  // Compute financials with installment/monthly plan logic
function computeStudentFinancials(student) {
  const feePerYear = Number(student.feePerYear) || 0;
  const previousDebt = Number(student.previousDebt) || 0;
  const plan = (student.paymentPlan || '').toLowerCase();
  let paid = 0;

  if (student.payments) {
    Object.values(student.payments).forEach(p => {
      paid += Number(p.amount) || 0;
    });
  }

  // Define installment schedules
  const today = new Date();
  const schedules = [];

  if (plan.includes("6")) {
    // 6 Installments logic
    schedules.push({ label: "Inst 1", due: "01-10", month: 1, amount: classInstalment(student.className, 1) });
    schedules.push({ label: "Inst 2", due: "03-15", month: 3, amount: classInstalment(student.className, 2) });
    schedules.push({ label: "Inst 3", due: "04-15", month: 4, amount: classInstalment(student.className, 3) });
    schedules.push({ label: "Inst 4", due: "05-15", month: 5, amount: classInstalment(student.className, 4) });
    schedules.push({ label: "Inst 5", due: "07-15", month: 7, amount: classInstalment(student.className, 5) });
    schedules.push({ label: "Inst 6", due: "09-15", month: 9, amount: classInstalment(student.className, 6) });
  } 
  else if (plan.includes("monthly")) {
    // Monthly logic (Jan–Oct, Jan/Jul cover 2 months)
    const monthlyAmount = feePerYear / 10;
    schedules.push({ label: "Jan (2 months)", month: 1, due: "01-31", amount: monthlyAmount * 2 });
    schedules.push({ label: "Feb", month: 2, due: "02-28", amount: monthlyAmount });
    schedules.push({ label: "Mar", month: 3, due: "03-31", amount: monthlyAmount });
    schedules.push({ label: "Apr", month: 4, due: "04-30", amount: monthlyAmount });
    schedules.push({ label: "May", month: 5, due: "05-31", amount: monthlyAmount });
    schedules.push({ label: "Jun", month: 6, due: "06-30", amount: monthlyAmount });
    schedules.push({ label: "Jul (2 months)", month: 7, due: "07-31", amount: monthlyAmount * 2 });
    schedules.push({ label: "Aug", month: 8, due: "08-31", amount: monthlyAmount });
    schedules.push({ label: "Sep", month: 9, due: "09-30", amount: monthlyAmount });
    schedules.push({ label: "Oct", month: 10, due: "10-31", amount: monthlyAmount });
  } 
  else if (plan.includes("2")) {
    // 2 Installments (48% each, 4% discount total)
    const discounted = feePerYear * 0.96; // apply 4% discount
    schedules.push({ label: "Half 1", month: 1, due: "01-10", amount: discounted * 0.5 });
    schedules.push({ label: "Half 2", month: 7, due: "07-05", amount: discounted * 0.5 });
  } 
  else if (plan.includes("full")) {
    // Full year upfront, 5% discount
    const discounted = feePerYear * 0.95;
    schedules.push({ label: "Full Year", month: 1, due: "01-10", amount: discounted });
  }

  // Work out expected payment till today
  let expectedTillNow = 0;
  const currentMonth = today.getMonth() + 1;

  schedules.forEach(sch => {
    if (sch.month <= currentMonth) {
      expectedTillNow += sch.amount;
    }
  });

  // Debt = what should be paid by now - what is actually paid
  const debt = Math.max(0, expectedTillNow - paid);
  const balanceYear = feePerYear - paid;

  return {
    paidAmount: paid,
    totalDue: feePerYear,
    previousDebt,
    balance: balanceYear,
    debtTillNow: debt,
    installments: schedules
  };
}

  // Render main table using cachedStudents
  function renderTable() {
    tbody.innerHTML = '';
    let totalDue = 0, totalCollected = 0, totalOutstanding = 0;
    const filterClass = classFilter.value;

    Object.entries(cachedStudents).forEach(([id, student]) => {
      if (filterClass && (student.classLevel || '') !== filterClass) return;

      const fin = computeStudentFinancials(student);

      // skip non-debtors if button toggled
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.debt <= 0 && fin.credit <= 0)) return;

      totalDue += fin.totalDue;
      totalCollected += fin.paidAmount;
      totalOutstanding += fin.balance + fin.debt;

      const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.replace(/\s+/g,' ').trim();

      const tr = document.createElement('tr');
      tr.className = 'table-row';
      tr.innerHTML = `
        <td class="p-2 border">${student.admissionNumber || ''}</td>
        <td class="p-2 border">${fullName}</td>
        <td class="p-2 border">${student.classLevel || ''}</td>
        <td class="p-2 border">${fmt(student.feePerYear || 0)}</td>
        <td class="p-2 border">${student.paymentPlan || ''}</td>
        <td class="p-2 border">${fmt(fin.paidAmount)}</td>
        <td class="p-2 border">${fmt(fin.balance)}</td>
        <td class="p-2 border">${fmt(fin.debt)}</td>
        <td class="p-2 border">
          <button class="viewBtn px-2 py-1 text-xs border rounded" data-id="${id}">View</button>
          <button class="payBtn px-2 py-1 text-xs bg-indigo-600 text-white rounded ml-1" data-id="${id}">Pay</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('totalDue').textContent = fmt(totalDue);
    document.getElementById('totalCollected').textContent = fmt(totalCollected);
    document.getElementById('totalOutstanding').textContent = fmt(totalOutstanding);

    // attach row action events
    tbody.querySelectorAll('.payBtn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.currentTarget.dataset.id;
        openPaymentModalFor(id);
      });
    });
    tbody.querySelectorAll('.viewBtn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.currentTarget.dataset.id;
        openDetailsModal(id);
      });
    });
  }

  // Load students from DB into cachedStudents then render
  async function loadStudents() {
    if (!db) return;
    try {
      const snap = await db.ref('students').once('value');
      const raw = snap.val() || {};
      cachedStudents = raw; // keep as key => object
      populateStudentSelect();
      renderTable();
    } catch (err) {
      console.error('Error loading students:', err);
      alert('Error loading students: ' + err.message);
    }
  }

  // Populate the student select in the payment modal
  function populateStudentSelect() {
    studentSelect.innerHTML = '<option value="">-- Select student --</option>';
    Object.entries(cachedStudents).forEach(([id, s]) => {
      const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.replace(/\s+/g,' ').trim();
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = `${fullName} — ${s.classLevel || ''} — ${s.admissionNumber || ''}`;
      studentSelect.appendChild(opt);
    });
  }

  // Open payment modal for a specific student (prefill)
  function openPaymentModalFor(id) {
    if (!cachedStudents[id]) return alert('Student not found');
    studentSelect.value = id;
    paymentModal.style.display = 'block';
  }
  function closePaymentModalFn() {
    paymentModal.style.display = 'none';
    paymentForm.reset();
  }

  // Open details modal
  function openDetailsModal(id) {
    const s = cachedStudents[id];
    if (!s) return alert('Student not found');
    const fin = computeStudentFinancials(s);
    const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.replace(/\s+/g,' ').trim();

    let html = `
      <p><strong>Name:</strong> ${fullName}</p>
      <p><strong>Admission No:</strong> ${s.admissionNumber || ''}</p>
      <p><strong>Class:</strong> ${s.classLevel || ''}</p>
      <p><strong>Fee/year:</strong> ${fmt(s.feePerYear || 0)}</p>
      <p><strong>Payment Plan:</strong> ${s.paymentPlan || ''}</p>
      <p><strong>Previous Debt:</strong> ${fmt(fin.previousDebt)}</p>
      <p><strong>Total Due:</strong> ${fmt(fin.totalDue)}</p>
      <p><strong>Paid:</strong> ${fmt(fin.paidAmount)}</p>
      <p><strong>Balance:</strong> ${fmt(fin.balance)}</p>
      <p><strong>Credit:</strong> ${fmt(fin.credit)}</p>
      <hr class="my-3"/>
      <h4 class="font-semibold">Payments Ledger</h4>
    `;

    if (!s.payments) {
      html += '<div class="text-sm text-gray-500">No payments recorded yet.</div>';
    } else {
      html += `<div class="overflow-auto"><table class="min-w-full text-xs mt-2"><thead><tr class="table-header"><th class="p-1 border">Date</th><th class="p-1 border">Amount</th><th class="p-1 border">Method</th><th class="p-1 border">Note</th></tr></thead><tbody>`;
      Object.values(s.payments).sort((a,b)=> (a.timestamp||0)-(b.timestamp||0)).forEach(p => {
        const d = new Date(p.timestamp || 0).toLocaleString();
        html += `<tr><td class="p-1 border">${d}</td><td class="p-1 border">${fmt(p.amount)}</td><td class="p-1 border">${p.method || ''}</td><td class="p-1 border">${p.note || ''}</td></tr>`;
      });
      html += `</tbody></table></div>`;
    }

    detailsContent.innerHTML = html;
    detailsModal.style.display = 'block';
  }
  function closeDetailsModalFn() { detailsModal.style.display = 'none'; detailsContent.innerHTML = ''; }

  // Payment form submit => write payment and update computed fields
  paymentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const studentId = studentSelect.value;
    const amount = Number(document.getElementById('paymentAmount').value || 0);
    const method = document.getElementById('paymentMethod').value || 'Cash';
    const note = document.getElementById('paymentNote').value || '';
    if (!studentId) return alert('Choose a student');
    if (!amount || amount <= 0) return alert('Enter a valid amount');

    try {
      const studentRef = db.ref('students/' + studentId);
      const snap = await studentRef.once('value');
      const student = snap.val();
      if (!student) throw new Error('Student not found');

      // push payment to ledger
      const payment = {
        amount: Math.round(amount), // store integer
        method,
        note,
        timestamp: Date.now()
      };
      await studentRef.child('payments').push(payment);

      // Recompute and store derived fields for easy queries (OPTIONAL: we recompute from ledger on fly too)
      // We'll compute totals now (source-of-truth is payments node)
      const paymentsSnap = await studentRef.child('payments').once('value');
      let paidToDate = 0;
      paymentsSnap.forEach(p => { paidToDate += Number(p.val().amount) || 0; });

      const feePerYear = Number(student.feePerYear) || 0;
      const prevDebt = Number(student.debt) || Number(student.previousDebt) || 0;
      const totalDue = prevDebt + feePerYear;
      const debtRemaining = Math.max(0, prevDebt - paidToDate);
      const remainingAfterPrev = Math.max(0, paidToDate - prevDebt);
      const balanceThisYear = Math.max(0, feePerYear - remainingAfterPrev);
      const credit = Math.max(0, paidToDate - totalDue);

      await studentRef.update({
        paidAmount: paidToDate,
        balance: balanceThisYear,
        debt: debtRemaining,
        credit
      });

      alert('Payment recorded successfully.');
      closePaymentModalFn();
      await loadStudents(); // refresh UI
    } catch (err) {
      console.error('Error recording payment', err);
      alert('Error recording payment: ' + (err.message || err));
    }
  });

  // CSV download of displayed table
  function downloadCSV() {
    // build array of rows from currently shown table
    const rows = [];
    // header
    rows.push(['Admission No','Full Name','Class','Fee','Plan','Paid','Balance','Debt']);
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && (s.classLevel || '') !== filterClass) return;
      const fin = computeStudentFinancials(s);
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.debt <= 0 && fin.credit <= 0)) return;
      const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.replace(/\s+/g,' ').trim();
      rows.push([s.admissionNumber||'', fullName, s.classLevel||'', fin.totalDue - fin.previousDebt, s.paymentPlan||'', fin.paidAmount, fin.balance, fin.debt]);
    });

    // convert to workbook and save with SheetJS
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Finance');
    XLSX.writeFile(wb, `finance_export_${Date.now()}.xlsx`);
  }

  // PDF download using jsPDF autoTable
  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    const headers = [['Admission No','Full Name','Class','Fee','Plan','Paid','Balance','Debt']];
    const body = [];
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && (s.classLevel || '') !== filterClass) return;
      const fin = computeStudentFinancials(s);
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.debt <= 0 && fin.credit <= 0)) return;
      const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.replace(/\s+/g,' ').trim();
      body.push([s.admissionNumber||'', fullName, s.classLevel||'', (s.feePerYear||0), s.paymentPlan||'', fin.paidAmount, fin.balance, fin.debt]);
    });

    doc.setFontSize(14);
    doc.text('SoMAp Finance Report', 14, 14);
    doc.autoTable({
      head: headers,
      body,
      startY: 20,
      styles: { fontSize: 8 }
    });
    doc.save(`finance_report_${Date.now()}.pdf`);
  }

  // Event listeners
  closePaymentModal.addEventListener('click', closePaymentModalFn);
  cancelPayment.addEventListener('click', closePaymentModalFn);
  closeDetailsModal.addEventListener('click', closeDetailsModalFn);
  showOnlyDebtorsBtn.addEventListener('click', () => { showingDebtorsOnly = !showingDebtorsOnly; showOnlyDebtorsBtn.textContent = showingDebtorsOnly ? 'Showing Debtors' : 'Show Debtors'; renderTable(); });
  downloadCsvBtn.addEventListener('click', downloadCSV);
  downloadPdfBtn.addEventListener('click', downloadPDF);
  reloadBtn.addEventListener('click', () => loadStudents());

  // Close modal by clicking outside
  window.addEventListener('click', (ev) => {
    if (ev.target === paymentModal) closePaymentModalFn();
    if (ev.target === detailsModal) closeDetailsModalFn();
  });

  // Filter change
  classFilter.addEventListener('change', renderTable);

  // Initial load
  document.addEventListener('DOMContentLoaded', function() {
    loadStudents();
  });

  // Expose helpers to console for debugging
  window.fins = {
    computeStudentFinancials,
    loadStudents,
    cachedStudents,
    renderTable
  };
    // ================== EXPENSES ==================

  const expenseForm = document.getElementById('expenseForm');
  const expenseTableBody = document.querySelector('#expenseTable tbody');

  async function loadExpenses() {
    try {
      const snap = await db.ref('expenses').once('value');
      const raw = snap.val() || {};
      expenseTableBody.innerHTML = '';
      let total = 0;
      Object.values(raw).forEach(exp => {
        total += Number(exp.amount) || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 border">${exp.category || ''}</td>
          <td class="p-2 border">${exp.description || ''}</td>
          <td class="p-2 border">${fmt(exp.amount)}</td>
          <td class="p-2 border">${exp.timestamp ? new Date(exp.timestamp).toLocaleDateString() : ''}</td>
        `;
        expenseTableBody.appendChild(tr);
      });
      document.getElementById('totalExpenses').textContent = fmt(total);

      // update net balance (collected - expenses)
      const collected = Number(document.getElementById('totalCollected').textContent.replace(/,/g,'')) || 0;
      document.getElementById('netBalance').textContent = fmt(collected - total);
    } catch (err) {
      console.error('Error loading expenses:', err);
    }
  }

  // Record new expense
  expenseForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const category = document.getElementById('expenseCategory').value;
    const description = document.getElementById('expenseDescription').value;
    const amount = Number(document.getElementById('expenseAmount').value);
    if (!category || !description || !amount) return alert('Fill all fields');

    try {
      await db.ref('expenses').push({
        category,
        description,
        amount,
        timestamp: Date.now()
      });
      expenseForm.reset();
      await loadExpenses();
    } catch (err) {
      console.error('Error saving expense:', err);
      alert('Error saving expense');
    }
  });

  // Refresh net when students are reloaded
  async function reloadAll() {
    await loadStudents();
    await loadExpenses();
  }
  reloadBtn.addEventListener('click', reloadAll);

  // Initial load
  document.addEventListener('DOMContentLoaded', () => {
    reloadAll();
  });
  // ================== EXPENSE EXPORTS ==================
  function downloadExpenseCSV() {
    const rows = [['Category','Description','Amount','Date']];

    document.querySelectorAll('#expenseTable tbody tr').forEach(tr => {
      const cols = Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
      rows.push(cols);
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
    XLSX.writeFile(wb, `expenses_${Date.now()}.xlsx`);
  }

  function downloadExpensePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const headers = [['Category','Description','Amount','Date']];
    const body = [];

    document.querySelectorAll('#expenseTable tbody tr').forEach(tr => {
      const cols = Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
      body.push(cols);
    });

    doc.setFontSize(14);
    doc.text('Expense Report', 14, 14);
    doc.autoTable({
      head: headers,
      body,
      startY: 20,
      styles: { fontSize: 10 }
    });
    doc.save(`expenses_${Date.now()}.pdf`);
  }

  // Hook export buttons
  document.getElementById('downloadExpenseCsv').addEventListener('click', downloadExpenseCSV);
  document.getElementById('downloadExpensePdf').addEventListener('click', downloadExpensePDF);

})(); // end IIFE
</script>
</body>
</html>