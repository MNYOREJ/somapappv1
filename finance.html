<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Firebase SDKs (same as index.html, version 9 compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>

<!-- Your Firebase config wrapper -->
<script src="firebase.js"></script>
  <title>SoMAp - Finance</title>

  <!-- Tailwind + FontAwesome (same style as your app) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <style>
    body { background: #f8fafc; }
    .table-header { background: #eef2ff; color: #1f2937; }
    .table-row:nth-child(even) { background: #ffffff; }
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { background:#fff; max-width:800px; margin:4% auto; padding:18px; border-radius:8px; height:80vh; overflow:auto; }
  </style>

  <!-- Third-party libs for export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

</head>
<body class="p-6">

  <div class="max-w-6xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold text-indigo-700">SoMAp â€” Finance</h1>
      <div class="space-x-2">
        <button id="reloadBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">Reload</button>
        <a href="index.html" class="px-3 py-1 border rounded text-sm">Back to Dashboard</a>
      </div>
    </header>

    <!-- Summary cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Total Due (All Students)</h3>
        <div id="totalDue" class="text-xl font-semibold mt-2">--</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Total Collected</h3>
        <div id="totalCollected" class="text-xl font-semibold mt-2">--</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Total Outstanding</h3>
        <div id="totalOutstanding" class="text-xl font-semibold mt-2">--</div>
      </div>
    </div>

    <!-- Action Row -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <label class="text-sm text-gray-600">Filter by class</label>
        <select id="classFilter" class="p-2 border rounded">
          <option value="">All Classes</option>
          <option>Baby Class</option>
          <option>Class 1</option>
          <option>Class 2</option>
          <option>Class 3</option>
          <option>Class 4</option>
          <option>Class 5</option>
          <option>Class 6</option>
          <option>Class 7</option>
        </select>
        <button id="showOnlyDebtors" class="px-3 py-1 bg-yellow-500 text-white rounded text-sm">Show Debtors</button>
      </div>

      <div class="flex items-center gap-2">
        <button id="downloadCsv" class="px-3 py-1 bg-indigo-600 text-white rounded">Download CSV</button>
        <button id="downloadPdf" class="px-3 py-1 bg-red-600 text-white rounded">Download PDF</button>
      </div>
    </div>

    <!-- Finance table -->
    <div class="bg-white rounded shadow overflow-x-auto">
      <table id="financeTable" class="min-w-full text-sm">
        <thead>
          <tr class="table-header">
            <th class="p-2 border">Admission No</th>
            <th class="p-2 border">Full Name</th>
            <th class="p-2 border">Class</th>
            <th class="p-2 border">Fee (year)</th>
            <th class="p-2 border">Payment Plan</th>
            <th class="p-2 border">Paid</th>
            <th class="p-2 border">Balance</th>
            <th class="p-2 border">Debt</th>
            <th class="p-2 border">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Payment modal -->
    <div id="paymentModal" class="modal">
      <div class="modal-content">
        <span id="closePaymentModal" class="float-right cursor-pointer text-2xl">&times;</span>
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Record Payment</h2>

        <form id="paymentForm" class="space-y-3">
          <div>
            <label class="text-sm text-gray-600">Student</label>
            <select id="studentSelect" class="w-full p-2 border rounded" required></select>
          </div>

          <div>
            <label class="text-sm text-gray-600">Amount</label>
            <input id="paymentAmount" type="number" step="1" min="1" class="w-full p-2 border rounded" required />
          </div>

          <div>
            <label class="text-sm text-gray-600">Method</label>
            <select id="paymentMethod" class="w-full p-2 border rounded">
              <option>Cash</option>
              <option>MPesa</option>
              <option>Airtel Money</option>
              <option>TigoPesa</option>
              <option>Bank Transfer</option>
              <option>Other</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-gray-600">Note (optional)</label>
            <input id="paymentNote" type="text" class="w-full p-2 border rounded" />
          </div>

          <div class="flex space-x-2">
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Save Payment</button>
            <button id="cancelPayment" type="button" class="px-4 py-2 border rounded">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Details modal -->
    <div id="detailsModal" class="modal">
      <div class="modal-content">
        <span id="closeDetailsModal" class="float-right cursor-pointer text-2xl">&times;</span>
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Student Finance Details</h2>
        <div id="detailsContent"></div>
      </div>
    </div>
  </div>

<script>
/*
  finance.html
  - Relies on firebase.js to already initialize Firebase and expose window.db and window.storage
  - Save as finance.html in same folder with index.html and firebase.js
*/

(function () {
  // Ensure db is available from firebase.js
  const db = window.db || null;
  const storage = window.storage || null;

  // DOM handles
  const tbody = document.querySelector('#financeTable tbody');
  const studentSelect = document.getElementById('studentSelect');
  const paymentModal = document.getElementById('paymentModal');
  const closePaymentModal = document.getElementById('closePaymentModal');
  const paymentForm = document.getElementById('paymentForm');
  const cancelPayment = document.getElementById('cancelPayment');
  const detailsModal = document.getElementById('detailsModal');
  const closeDetailsModal = document.getElementById('closeDetailsModal');
  const detailsContent = document.getElementById('detailsContent');
  const classFilter = document.getElementById('classFilter');
  const showOnlyDebtorsBtn = document.getElementById('showOnlyDebtors');
  const downloadCsvBtn = document.getElementById('downloadCsv');
  const downloadPdfBtn = document.getElementById('downloadPdf');
  const reloadBtn = document.getElementById('reloadBtn');

  let cachedStudents = {}; // key => student
  let showingDebtorsOnly = false;

  // Helpful guard
  if (!db) {
    console.error('Realtime Database (db) not found. finance.html expects firebase.js to have initialized Firebase and set window.db.');
    alert('DB not ready. Make sure firebase.js initializes Firebase and exposes window.db.');
    // still continue so user can read UI, but no data will appear
  }

  // Utility: format money
  function fmt(n) {
    n = Number(n) || 0;
    return n.toLocaleString();
  }

  // Compute financials for a student from stored payments (source-of-truth)
  // Returns object: { paidAmount, totalDue, previousDebt, balance, credit, installments }
  function computeStudentFinancials(student) {
    // Normalize
    const feePerYear = Number(student.feePerYear) || 0;
    const previousDebt = Number(student.debt) || Number(student.previousDebt) || 0;
    // collect payments
    let paid = 0;
    if (student.payments) {
      Object.values(student.payments).forEach(p => {
        paid += Number(p.amount) || 0;
      });
    }

    const totalDue = previousDebt + feePerYear;
    // after paying previous debt fully, rest applies to current year
    let remainingAfterPrev = Math.max(0, paid - previousDebt);
    let debtRemaining = Math.max(0, previousDebt - paid); // still owe previous debt
    let balanceThisYear = Math.max(0, feePerYear - Math.max(0, remainingAfterPrev));
    let credit = Math.max(0, paid - totalDue);

    // Build an installment breakdown (basic)
    // We compute installments based on paymentPlan:
    const plan = (student.paymentPlan || '').toLowerCase();
    let installments = [];
    if (plan.indexOf('6') !== -1 || plan.indexOf('6-instal') !== -1 || plan.indexOf('6-instal') !== -1) {
      // 6 installments: split feePerYear equally into 6
      const base = Math.floor((feePerYear / 6) * 100) / 100;
      for (let i = 0; i < 6; i++) {
        installments.push({ label: `Inst ${i+1}`, due: base, paid: 0 });
      }
    } else if (plan.indexOf('monthly') !== -1 || plan.indexOf('10') !== -1) {
      // monthly 10 months: Jan-Oct
      const base = Math.floor((feePerYear / 10) * 100) / 100;
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct'];
      installments = months.map(m => ({ label: m, due: base, paid: 0 }));
    } else if (plan.indexOf('2') !== -1 || plan.indexOf('2-instal') !== -1) {
      // 2 installments: split into 2 (48% and 48% as per your plan? We'll use 50/50 if not specified)
      const base = Math.floor((feePerYear / 2) * 100) / 100;
      installments.push({ label: '1st', due: base, paid: 0 });
      installments.push({ label: '2nd', due: base, paid: 0 });
    } else {
      // yearly/other: single installment
      installments.push({ label: 'Full Year', due: feePerYear, paid: 0 });
    }

    // Allocate paid money to previous debt first then to installments
    let toAllocate = paid;
    // reduce previous debt first
    if (previousDebt > 0) {
      const againstPrev = Math.min(toAllocate, previousDebt);
      toAllocate -= againstPrev;
      // we track debtRemaining above
    }

    // Now allocate to installments oldest-first
    for (let inst of installments) {
      const allocated = Math.min(toAllocate, inst.due);
      inst.paid = allocated;
      toAllocate -= allocated;
      if (toAllocate <= 0) break;
    }

    return {
      paidAmount: paid,
      totalDue,
      previousDebt,
      balance: balanceThisYear,
      debt: debtRemaining,
      credit,
      installments
    };
  }

  // Render main table using cachedStudents
  function renderTable() {
    tbody.innerHTML = '';
    let totalDue = 0, totalCollected = 0, totalOutstanding = 0;
    const filterClass = classFilter.value;

    Object.entries(cachedStudents).forEach(([id, student]) => {
      if (filterClass && (student.classLevel || '') !== filterClass) return;

      const fin = computeStudentFinancials(student);

      // skip non-debtors if button toggled
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.debt <= 0 && fin.credit <= 0)) return;

      totalDue += fin.totalDue;
      totalCollected += fin.paidAmount;
      totalOutstanding += fin.balance + fin.debt;

      const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.replace(/\s+/g,' ').trim();

      const tr = document.createElement('tr');
      tr.className = 'table-row';
      tr.innerHTML = `
        <td class="p-2 border">${student.admissionNumber || ''}</td>
        <td class="p-2 border">${fullName}</td>
        <td class="p-2 border">${student.classLevel || ''}</td>
        <td class="p-2 border">${fmt(student.feePerYear || 0)}</td>
        <td class="p-2 border">${student.paymentPlan || ''}</td>
        <td class="p-2 border">${fmt(fin.paidAmount)}</td>
        <td class="p-2 border">${fmt(fin.balance)}</td>
        <td class="p-2 border">${fmt(fin.debt)}</td>
        <td class="p-2 border">
          <button class="viewBtn px-2 py-1 text-xs border rounded" data-id="${id}">View</button>
          <button class="payBtn px-2 py-1 text-xs bg-indigo-600 text-white rounded ml-1" data-id="${id}">Pay</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('totalDue').textContent = fmt(totalDue);
    document.getElementById('totalCollected').textContent = fmt(totalCollected);
    document.getElementById('totalOutstanding').textContent = fmt(totalOutstanding);

    // attach row action events
    tbody.querySelectorAll('.payBtn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.currentTarget.dataset.id;
        openPaymentModalFor(id);
      });
    });
    tbody.querySelectorAll('.viewBtn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.currentTarget.dataset.id;
        openDetailsModal(id);
      });
    });
  }

  // Load students from DB into cachedStudents then render
  async function loadStudents() {
    if (!db) return;
    try {
      const snap = await db.ref('students').once('value');
      const raw = snap.val() || {};
      cachedStudents = raw; // keep as key => object
      populateStudentSelect();
      renderTable();
    } catch (err) {
      console.error('Error loading students:', err);
      alert('Error loading students: ' + err.message);
    }
  }

  // Populate the student select in the payment modal
  function populateStudentSelect() {
    studentSelect.innerHTML = '<option value="">-- Select student --</option>';
    Object.entries(cachedStudents).forEach(([id, s]) => {
      const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.replace(/\s+/g,' ').trim();
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = `${fullName} â€” ${s.classLevel || ''} â€” ${s.admissionNumber || ''}`;
      studentSelect.appendChild(opt);
    });
  }

  // Open payment modal for a specific student (prefill)
  function openPaymentModalFor(id) {
    if (!cachedStudents[id]) return alert('Student not found');
    studentSelect.value = id;
    paymentModal.style.display = 'block';
  }
  function closePaymentModalFn() {
    paymentModal.style.display = 'none';
    paymentForm.reset();
  }

  // Open details modal
  function openDetailsModal(id) {
    const s = cachedStudents[id];
    if (!s) return alert('Student not found');
    const fin = computeStudentFinancials(s);
    const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.replace(/\s+/g,' ').trim();

    let html = `
      <p><strong>Name:</strong> ${fullName}</p>
      <p><strong>Admission No:</strong> ${s.admissionNumber || ''}</p>
      <p><strong>Class:</strong> ${s.classLevel || ''}</p>
      <p><strong>Fee/year:</strong> ${fmt(s.feePerYear || 0)}</p>
      <p><strong>Payment Plan:</strong> ${s.paymentPlan || ''}</p>
      <p><strong>Previous Debt:</strong> ${fmt(fin.previousDebt)}</p>
      <p><strong>Total Due:</strong> ${fmt(fin.totalDue)}</p>
      <p><strong>Paid:</strong> ${fmt(fin.paidAmount)}</p>
      <p><strong>Balance:</strong> ${fmt(fin.balance)}</p>
      <p><strong>Credit:</strong> ${fmt(fin.credit)}</p>
      <hr class="my-3"/>
      <h4 class="font-semibold">Payments Ledger</h4>
    `;

    if (!s.payments) {
      html += '<div class="text-sm text-gray-500">No payments recorded yet.</div>';
    } else {
      html += `<div class="overflow-auto"><table class="min-w-full text-xs mt-2"><thead><tr class="table-header"><th class="p-1 border">Date</th><th class="p-1 border">Amount</th><th class="p-1 border">Method</th><th class="p-1 border">Note</th></tr></thead><tbody>`;
      Object.values(s.payments).sort((a,b)=> (a.timestamp||0)-(b.timestamp||0)).forEach(p => {
        const d = new Date(p.timestamp || 0).toLocaleString();
        html += `<tr><td class="p-1 border">${d}</td><td class="p-1 border">${fmt(p.amount)}</td><td class="p-1 border">${p.method || ''}</td><td class="p-1 border">${p.note || ''}</td></tr>`;
      });
      html += `</tbody></table></div>`;
    }

    detailsContent.innerHTML = html;
    detailsModal.style.display = 'block';
  }
  function closeDetailsModalFn() { detailsModal.style.display = 'none'; detailsContent.innerHTML = ''; }

  // Payment form submit => write payment and update computed fields
  paymentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const studentId = studentSelect.value;
    const amount = Number(document.getElementById('paymentAmount').value || 0);
    const method = document.getElementById('paymentMethod').value || 'Cash';
    const note = document.getElementById('paymentNote').value || '';
    if (!studentId) return alert('Choose a student');
    if (!amount || amount <= 0) return alert('Enter a valid amount');

    try {
      const studentRef = db.ref('students/' + studentId);
      const snap = await studentRef.once('value');
      const student = snap.val();
      if (!student) throw new Error('Student not found');

      // push payment to ledger
      const payment = {
        amount: Math.round(amount), // store integer
        method,
        note,
        timestamp: Date.now()
      };
      await studentRef.child('payments').push(payment);

      // Recompute and store derived fields for easy queries (OPTIONAL: we recompute from ledger on fly too)
      // We'll compute totals now (source-of-truth is payments node)
      const paymentsSnap = await studentRef.child('payments').once('value');
      let paidToDate = 0;
      paymentsSnap.forEach(p => { paidToDate += Number(p.val().amount) || 0; });

      const feePerYear = Number(student.feePerYear) || 0;
      const prevDebt = Number(student.debt) || Number(student.previousDebt) || 0;
      const totalDue = prevDebt + feePerYear;
      const debtRemaining = Math.max(0, prevDebt - paidToDate);
      const remainingAfterPrev = Math.max(0, paidToDate - prevDebt);
      const balanceThisYear = Math.max(0, feePerYear - remainingAfterPrev);
      const credit = Math.max(0, paidToDate - totalDue);

      await studentRef.update({
        paidAmount: paidToDate,
        balance: balanceThisYear,
        debt: debtRemaining,
        credit
      });

      alert('Payment recorded successfully.');
      closePaymentModalFn();
      await loadStudents(); // refresh UI
    } catch (err) {
      console.error('Error recording payment', err);
      alert('Error recording payment: ' + (err.message || err));
    }
  });

  // CSV download of displayed table
  function downloadCSV() {
    // build array of rows from currently shown table
    const rows = [];
    // header
    rows.push(['Admission No','Full Name','Class','Fee','Plan','Paid','Balance','Debt']);
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && (s.classLevel || '') !== filterClass) return;
      const fin = computeStudentFinancials(s);
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.debt <= 0 && fin.credit <= 0)) return;
      const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.replace(/\s+/g,' ').trim();
      rows.push([s.admissionNumber||'', fullName, s.classLevel||'', fin.totalDue - fin.previousDebt, s.paymentPlan||'', fin.paidAmount, fin.balance, fin.debt]);
    });

    // convert to workbook and save with SheetJS
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Finance');
    XLSX.writeFile(wb, `finance_export_${Date.now()}.xlsx`);
  }

  // PDF download using jsPDF autoTable
  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    const headers = [['Admission No','Full Name','Class','Fee','Plan','Paid','Balance','Debt']];
    const body = [];
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && (s.classLevel || '') !== filterClass) return;
      const fin = computeStudentFinancials(s);
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.debt <= 0 && fin.credit <= 0)) return;
      const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.replace(/\s+/g,' ').trim();
      body.push([s.admissionNumber||'', fullName, s.classLevel||'', (s.feePerYear||0), s.paymentPlan||'', fin.paidAmount, fin.balance, fin.debt]);
    });

    doc.setFontSize(14);
    doc.text('SoMAp Finance Report', 14, 14);
    doc.autoTable({
      head: headers,
      body,
      startY: 20,
      styles: { fontSize: 8 }
    });
    doc.save(`finance_report_${Date.now()}.pdf`);
  }

  // Event listeners
  closePaymentModal.addEventListener('click', closePaymentModalFn);
  cancelPayment.addEventListener('click', closePaymentModalFn);
  closeDetailsModal.addEventListener('click', closeDetailsModalFn);
  showOnlyDebtorsBtn.addEventListener('click', () => { showingDebtorsOnly = !showingDebtorsOnly; showOnlyDebtorsBtn.textContent = showingDebtorsOnly ? 'Showing Debtors' : 'Show Debtors'; renderTable(); });
  downloadCsvBtn.addEventListener('click', downloadCSV);
  downloadPdfBtn.addEventListener('click', downloadPDF);
  reloadBtn.addEventListener('click', () => loadStudents());

  // Close modal by clicking outside
  window.addEventListener('click', (ev) => {
    if (ev.target === paymentModal) closePaymentModalFn();
    if (ev.target === detailsModal) closeDetailsModalFn();
  });

  // Filter change
  classFilter.addEventListener('change', renderTable);

  // Initial load
  document.addEventListener('DOMContentLoaded', function() {
    loadStudents();
  });

  // Expose helpers to console for debugging
  window.fins = {
    computeStudentFinancials,
    loadStudents,
    cachedStudents,
    renderTable
  };

})(); // end IIFE
</script>
</body>
</html>