<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
  <script src="Todashboardhtml/yearContext.js"></script>
  <script src="firebase.js"></script>
  <title>SoMAp - Finance</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Exports -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { background: #f8fafc; }
    .table-header { background: #eef2ff; color: #1f2937; }
    .table-row:nth-child(even) { background: #ffffff; }
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { background:#fff; max-width:800px; margin:4% auto; padding:18px; border-radius:8px; height:80vh; overflow:auto; }
    .expander { cursor: pointer; transition: transform .2s ease; }
    .expander .fa { transition: transform .2s ease; }
    .expander.open .fa { transform: rotate(180deg); }
    .status-pill { padding:2px 8px; border-radius:999px; font-size: 11px; font-weight:600; }
    .status-paid { background:#dcfce7; color:#166534; }
    .status-partial { background:#fef9c3; color:#854d0e; }
    .status-overdue { background:#fee2e2; color:#991b1b; }
    /* tiny shimmer used before iframe mounts */
    .skel { position: relative; overflow: hidden; background: #f1f5f9; }
    .skel::after {
      content: ""; position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(241,245,249,0) 0%, rgba(226,232,240,.8) 50%, rgba(241,245,249,0) 100%);
      transform: translateX(-100%); animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%); } }
  </style>
</head>

<body class="p-6">
  <div class="max-w-6xl mx-auto">
    <header class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex flex-col">
        <h1 class="text-2xl font-semibold text-indigo-700">SoMAp � Finance</h1>
        <p class="mt-1 text-sm font-medium text-indigo-600/80">Working year: <span id="financeYearLabel">--</span></p>
      </div>
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3">
        <label class="flex items-center gap-2 rounded-lg border border-indigo-200 bg-indigo-50/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-700">
          <span class="hidden sm:inline text-[0.7rem]">Academic Year</span>
          <select
            data-somap-year-select
            class="min-w-[120px] rounded-md border border-indigo-200 bg-white px-2 py-1 text-sm font-medium text-indigo-700 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          >
          </select>
        </label>
        <button id="reloadBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">Reload</button>
        <a href="index.html" class="px-3 py-1 border rounded text-sm">Back to Dashboard</a>
      </div>
    </header>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Total Due (All Students)</h3>
        <div id="totalDue" class="text-xl font-semibold mt-2">--</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Total Collected</h3>
        <div id="totalCollected" class="text-xl font-semibold mt-2">--</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Total Outstanding (Due – Collected)</h3>
        <div id="totalOutstanding" class="text-xl font-semibold mt-2">--</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Total Expenses</h3>
        <div id="totalExpenses" class="text-xl font-semibold mt-2">--</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500">Net Balance (Collected - Expenses)</h3>
        <div id="netBalance" class="text-xl font-semibold mt-2">--</div>
      </div>
    </div>

    <!-- Filters + actions -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <label class="text-sm text-gray-600">Filter by class</label>
        <select id="classFilter" class="p-2 border rounded">
          <option value="">All Classes</option>
          <option>Baby Class</option>
          <option>Class 1</option>
          <option>Class 2</option>
          <option>Class 3</option>
          <option>Class 4</option>
          <option>Class 5</option>
          <option>Class 6</option>
          <option>Class 7</option>
        </select>
        <button id="showOnlyDebtors" class="px-3 py-1 bg-yellow-500 text-white rounded text-sm">Show Debtors</button>
      </div>
      <div class="flex items-center gap-2">
        <button id="downloadCsv" class="px-3 py-1 bg-indigo-600 text-white rounded"><i class="fa fa-file-excel mr-1"></i> Main CSV</button>
        <button id="downloadPdf" class="px-3 py-1 bg-red-600 text-white rounded"><i class="fa fa-file-pdf mr-1"></i> Main PDF</button>
        <button id="downloadDebtNowCsv" class="px-3 py-1 bg-amber-600 text-white rounded"><i class="fa fa-file-excel mr-1"></i> Debt (current) CSV</button>
        <button id="downloadDebtNowPdf" class="px-3 py-1 bg-amber-700 text-white rounded"><i class="fa fa-file-pdf mr-1"></i> Debt (current) PDF</button>
        <button id="downloadBreakdownCsv" class="px-3 py-1 bg-teal-600 text-white rounded"><i class="fa fa-file-excel mr-1"></i> Breakdown CSV</button>
        <button id="downloadBreakdownPdf" class="px-3 py-1 bg-teal-700 text-white rounded"><i class="fa fa-file-pdf mr-1"></i> Breakdown PDF</button>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded shadow overflow-x-auto">
      <table id="financeTable" class="min-w-full text-sm">
        <thead>
          <tr class="table-header">
            <th class="p-2 border"></th>
            <th class="p-2 border">Admission No</th>
            <th class="p-2 border">Full Name</th>
            <th class="p-2 border">Class</th>
            <th class="p-2 border">Fee (year)</th>
            <th class="p-2 border">Payment Plan</th>
            <th class="p-2 border">Paid</th>
            <th class="p-2 border">Balance (Year)</th>
            <th class="p-2 border">Debt till …</th>
            <th class="p-2 border">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Expenses -->
    <div class="bg-white rounded shadow p-4 mt-6">
      <h2 class="text-lg font-semibold text-indigo-700 mb-3">Expenses</h2>
      <form id="expenseForm" class="grid md:grid-cols-4 gap-3 mb-4">
        <select id="expenseCategory" required class="p-2 border rounded">
          <option value="">Select Category</option>
          <option>FOOD</option>
          <option>SALARIES</option>
          <option>OFFICE</option>
          <option>EDUCATION</option>
          <option>WATER & ELECTRICITY</option>
          <option>SANITATION</option>
          <option>ENVIRONMENT</option>
          <option>HEALTH</option>
          <option>SECURITY</option>
          <option>CLOTHING</option>
          <option>SHELTER</option>
          <option>RECREATION</option>
          <option>PROJECTS</option>
          <option>TRANSPORT</option>
          <option>PURCHASES</option>
          <option>SIL</option>
          <option>MAINTENANCE</option>
          <option>BOOKS</option>
          <option>EMERGENCY</option>
          <option>MISCELLANEOUS</option>
        </select>
        <input id="expenseDescription" type="text" placeholder="Description" required class="p-2 border rounded">
        <input id="expenseAmount" type="number" min="1" placeholder="Amount" required class="p-2 border rounded">
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Add Expense</button>
      </form>
      <div class="flex items-center gap-2 mb-3">
        <button id="downloadExpenseCsv" class="px-3 py-1 bg-green-600 text-white rounded">Download Expense Report (CSV)</button>
        <button id="downloadExpensePdf" class="px-3 py-1 bg-red-600 text-white rounded">Download Expense Report (PDF)</button>
      </div>
      <table id="expenseTable" class="min-w-full text-sm border">
        <thead>
          <tr class="table-header">
            <th class="p-2 border">Category</th>
            <th class="p-2 border">Description</th>
            <th class="p-2 border">Amount</th>
            <th class="p-2 border">Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Payment modal -->
    <div id="paymentModal" class="modal">
      <div class="modal-content">
        <span id="closePaymentModal" class="float-right cursor-pointer text-2xl">&times;</span>
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Record Payment</h2>
        <form id="paymentForm" class="space-y-3">
          <div>
            <label class="text-sm text-gray-600">Student</label>
            <select id="studentSelect" class="w-full p-2 border rounded" required></select>
          </div>
          <div>
            <label class="text-sm text-gray-600">Amount</label>
            <input id="paymentAmount" type="number" step="1" min="1" class="w-full p-2 border rounded" required />
          </div>
          <div>
            <label class="text-sm text-gray-600">Payment Date</label>
            <input id="paymentDate" type="date" class="w-full p-2 border rounded" required />
          </div>
          <div>
            <label class="text-sm text-gray-600">Method</label>
            <select id="paymentMethod" class="w-full p-2 border rounded">
              <option>Cash</option>
              <option>MPesa</option>
              <option>Airtel Money</option>
              <option>TigoPesa</option>
              <option>Bank Transfer</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-600">Reference Code (MPesa / Receipt / Bank)</label>
            <input id="paymentReference" type="text" class="w-full p-2 border rounded" placeholder="e.g. MPESA1ABC23" />
          </div>
          <div>
            <label class="text-sm text-gray-600">Paid By (Name)</label>
            <input id="paymentPaidBy" type="text" class="w-full p-2 border rounded" placeholder="e.g. Parent name or Admin name" required />
          </div>
          <div>
            <label class="text-sm text-gray-600">Contact of Payer</label>
            <input id="paymentPayerContact" type="tel" class="w-full p-2 border rounded" placeholder="e.g. +255..." required />
          </div>
          <div>
            <label class="text-sm text-gray-600">Note (optional)</label>
            <input id="paymentNote" type="text" class="w-full p-2 border rounded" />
          </div>
          <div class="flex space-x-2">
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Save Payment</button>
            <button id="cancelPayment" type="button" class="px-4 py-2 border rounded">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Details modal -->
    <div id="detailsModal" class="modal">
      <div class="modal-content">
        <span id="closeDetailsModal" class="float-right cursor-pointer text-2xl">&times;</span>
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Student Finance Details</h2>
        <div id="detailsContent"></div>
      </div>
    </div>
  </div>

<script>
(function () {
  /* ===== Parent mode detection (non-destructive) ===== */
  const parentCtx = { enabled:false, studentId:null, adm:null, year:null, className:null };
  (function detectParentMode(){
    const q = new URLSearchParams(location.search);
    const scope = (q.get('scope')||'').toLowerCase();
    if (scope === 'parent') {
      parentCtx.enabled  = true;
      parentCtx.studentId= q.get('student');
      parentCtx.adm      = q.get('adm');
      parentCtx.year     = q.get('year');
      parentCtx.className= q.get('class');
      try {
        sessionStorage.setItem('parent_scope','1');
        if (parentCtx.studentId) sessionStorage.setItem('parent_student', parentCtx.studentId);
        if (parentCtx.adm)       sessionStorage.setItem('parent_adm', parentCtx.adm);
        if (parentCtx.year)      sessionStorage.setItem('parent_year', parentCtx.year);
        if (parentCtx.className) sessionStorage.setItem('parent_class', parentCtx.className);
      } catch(_) {}
    } else if (sessionStorage.getItem('parent_scope') === '1') {
      parentCtx.enabled   = true;
      parentCtx.studentId = sessionStorage.getItem('parent_student');
      parentCtx.adm       = sessionStorage.getItem('parent_adm');
      parentCtx.year      = sessionStorage.getItem('parent_year');
      parentCtx.className = sessionStorage.getItem('parent_class');
    }
  })();

  const db = window.db || null;
  const yearContext = window.somapYearContext || null;
  let activeYear = yearContext ? yearContext.getSelectedYear() : String(new Date().getFullYear());
  let financeYear = activeYear;
  const tbody = document.querySelector('#financeTable tbody');
  const studentSelect = document.getElementById('studentSelect');
  const paymentModal = document.getElementById('paymentModal');
  const closePaymentModal = document.getElementById('closePaymentModal');
  const paymentForm = document.getElementById('paymentForm');
  const cancelPayment = document.getElementById('cancelPayment');
  const detailsModal = document.getElementById('detailsModal');
  const closeDetailsModal = document.getElementById('closeDetailsModal');
  const detailsContent = document.getElementById('detailsContent');
  const classFilter = document.getElementById('classFilter');
  const showOnlyDebtorsBtn = document.getElementById('showOnlyDebtors');
  const yearHint = document.getElementById('financeYearLabel');
  const downloadCsvBtn = document.getElementById('downloadCsv');
  const downloadPdfBtn = document.getElementById('downloadPdf');
  const downloadDebtNowCsvBtn = document.getElementById('downloadDebtNowCsv');
  const downloadDebtNowPdfBtn = document.getElementById('downloadDebtNowPdf');
  const downloadBreakdownCsvBtn = document.getElementById('downloadBreakdownCsv');
  const downloadBreakdownPdfBtn = document.getElementById('downloadBreakdownPdf');
  const reloadBtn = document.getElementById('reloadBtn');

  let cachedStudents = {};
  let showingDebtorsOnly = false;

  function updateYearHint() {
    if (yearHint) yearHint.textContent = `${financeYear}`;
  }

  if (!db) {
    console.error('DB not found.');
    alert('DB not ready. Ensure firebase.js initializes window.db.');
  }

  // ===== Helpers (kept as-is) =====
  function fmt(n) { n = Number(n) || 0; return n.toLocaleString(); }
  function clamp(n) { return Math.max(0, Math.round(Number(n) || 0)); }
  function todayYMD() {
    const now = new Date();
    const selectedYear = Number(financeYear);
    return {
      y: Number.isFinite(selectedYear) ? selectedYear : now.getFullYear(),
      m: now.getMonth() + 1,
      d: now.getDate(),
    };
  }
  function dateFromYMD(y, m, d) { return new Date(y, m - 1, d).getTime(); }
  function isPast(ts) { return Date.now() > ts; }
  function apportion(total, weights) {
    if (!weights.length) return [];
    const sumW = weights.reduce((a, b) => a + b, 0);
    let amounts = weights.map(w => Math.floor((w * total) / sumW));
    let sumA = amounts.reduce((a, b) => a + b, 0);
    let rem = total - sumA;
    if (rem > 0) {
      const sortedIdx = [...weights.keys()].sort((a, b) => weights[b] - weights[a]);
      for (let i = 0; i < rem; i++) amounts[sortedIdx[i % sortedIdx.length]]++;
    }
    return amounts;
  }

  // ===== Installment config (DISCOUNTS REMOVED) =====
  const installmentConfigs = {
    lower: {
      type: '6',
      weights: [44, 13, 12, 22, 22, 16],
      labels: ['Inst 1', 'Inst 2', 'Inst 3', 'Inst 4', 'Inst 5', 'Inst 6'],
      windows: [
        { from: [12, 1], to: [1, 10] },
        { from: [3, 1], to: [3, 15] },
        { from: [4, 1], to: [4, 15] },
        { from: [5, 1], to: [5, 15] },
        { from: [7, 1], to: [7, 15] },
        { from: [9, 1], to: [9, 15] },
      ]
    },
    class4_7: {
      type: '4',
      weights: [27, 20, 20, 15],
      labels: ['Inst 1', 'Inst 2', 'Inst 3', 'Inst 4'],
      windows: [
        { from: [12, 1], to: [1, 10] },
        { from: [3, 1], to: [3, 15] },
        { from: [4, 1], to: [4, 15] },
        { from: [5, 1], to: [5, 15] },
      ]
    },
    class5: {
      type: '6',
      weights: [44, 23, 22, 32, 26, 17],
      labels: ['Inst 1', 'Inst 2', 'Inst 3', 'Inst 4', 'Inst 5', 'Inst 6'],
      windows: [
        { from: [12, 1], to: [1, 10] },
        { from: [3, 1], to: [3, 15] },
        { from: [4, 1], to: [4, 15] },
        { from: [5, 1], to: [5, 15] },
        { from: [7, 1], to: [7, 15] },
        { from: [9, 1], to: [9, 15] },
      ]
    },
    class6: {
      type: '6',
      weights: [236, 115, 110, 160, 160, 100],
      labels: ['Inst 1', 'Inst 2', 'Inst 3', 'Inst 4', 'Inst 5', 'Inst 6'],
      windows: [
        { from: [12, 1], to: [1, 10] },
        { from: [3, 1], to: [3, 15] },
        { from: [4, 1], to: [4, 15] },
        { from: [5, 1], to: [5, 15] },
        { from: [7, 1], to: [7, 15] },
        { from: [9, 1], to: [9, 15] },
      ]
    },
    monthly: {
      type: 'monthly',
      weights: [2, 1, 1, 1, 1, 1, 2, 1, 1, 1],
      labels: ['Jan (2 months)', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul (2 months)', 'Aug', 'Sep', 'Oct'],
      windows: [
        { from: [1, 1], to: [1, 31] },
        { from: [2, 1], to: [2, 28] },
        { from: [3, 1], to: [3, 31] },
        { from: [4, 1], to: [4, 30] },
        { from: [5, 1], to: [5, 31] },
        { from: [6, 1], to: [6, 30] },
        { from: [7, 1], to: [7, 31] },
        { from: [8, 1], to: [8, 31] },
        { from: [9, 1], to: [9, 30] },
        { from: [10, 1], to: [10, 31] },
      ]
    },
    '2inst': {
      type: '2',
      // discount removed
      weights: [1, 1],
      labels: ['1st Half', '2nd Half'],
      windows: [
        { from: [1, 1], to: [1, 10] },
        { from: [7, 1], to: [7, 5] },
      ]
    },
    full: {
      type: 'full',
      // discount removed
      weights: [1],
      labels: ['Full Year'],
      windows: [
        { from: [1, 1], to: [1, 10] },
      ]
    }
  };

  function getConfig(student) {
    const plan = (student.paymentPlan || '').toLowerCase();
    const c = (student.classLevel || '').toLowerCase();
    if (plan.includes('monthly')) return installmentConfigs.monthly;
    if (plan.includes('2')) return installmentConfigs['2inst'];
    if (plan.includes('full')) return installmentConfigs.full;
    if (plan.includes('4') || (plan.includes('inst') && (c === 'class 4' || c === 'class 7'))) return installmentConfigs.class4_7;
    if (plan.includes('inst')) {
      if (c === 'class 1' || c === 'class 2' || c === 'class 3') return installmentConfigs.lower;
      if (c === 'class 5') return installmentConfigs.class5;
      if (c === 'class 6') return installmentConfigs.class6;
    }
    return installmentConfigs.full;
  }

  function buildSchedule(student) {
    const config = getConfig(student);
    const { y } = todayYMD();
    // BASE FEE ONLY — NO DISCOUNTS
    const feeBase = Math.round(Number(student.feePerYear) || 0);
    const amounts = apportion(feeBase, config.weights);

    const sc = [];
    config.labels.forEach((label, i) => {
      let fromY = y, toY = y;
      const fromM = config.windows[i].from[0], fromD = config.windows[i].from[1];
      const toM = config.windows[i].to[0], toD = config.windows[i].to[1];
      if (fromM === 12) fromY = y - 1;
      if (toM === 12) toY = y - 1;
      const fromTS = dateFromYMD(fromY, fromM, fromD);
      const toTS = dateFromYMD(toY, toM, toD);
      sc.push({ key: `inst${i + 1}`, label, fromTS, toTS, amount: amounts[i], paidAllocated:0, status:'Pending' });
    });

    let lastDueIndex = -1, periodLabel = '—', expectedToDate = 0;
    const now = Date.now();
    sc.forEach((it, idx) => {
      if (it.toTS < now) { lastDueIndex = idx; expectedToDate += it.amount; }
    });
    if (lastDueIndex >= 0) periodLabel = sc[lastDueIndex].label;
    return { items: sc, periodLabelNow: periodLabel, expectedToDate };
  }

  function allocatePayments(student, schedule) {
    const payList = [];
    if (student.payments) {
      Object.values(student.payments).forEach(p => {
        payList.push({ amount: clamp(p.amount), ts: Number(p.timestamp) || 0 });
      });
    }
    payList.sort((a, b) => a.ts - b.ts);
    let pot = payList.reduce((s, p) => s + p.amount, 0);
    const totalPaid = pot;
    let prevDebt = clamp(student.previousDebt || student.debt);
    let toPrev = Math.min(prevDebt, pot); prevDebt -= toPrev; pot -= toPrev;

    for (const it of schedule.items) {
      const need = Math.max(0, it.amount - it.paidAllocated);
      if (need <= 0) continue;
      if (pot <= 0) break;
      const use = Math.min(need, pot);
      it.paidAllocated += use;
      pot -= use;
    }
    const credit = Math.max(0, pot);
    const now = Date.now();
    for (const it of schedule.items) {
      const a = it.paidAllocated, need = it.amount;
      if (a >= need) it.status = 'Cleared';
      else if (isPast(it.toTS)) it.status = a > 0 ? 'Partially Paid (Overdue)' : 'Overdue';
      else it.status = a > 0 ? 'Partially Paid' : 'Pending';
    }
    const expectedToDate = schedule.items.filter(it => it.toTS < now).reduce((s, it) => s + it.amount, 0);
    const paidConsumed = totalPaid - credit;
    const debtTillNow = Math.max(0, expectedToDate - paidConsumed);
    return { scheduleItems: schedule.items, prevDebtAfter: prevDebt, credit, totalPaid, debtTillNow };
  }

  function computeStudentFinancials(student) {
    const feePerYear = Number(student.feePerYear) || 0;
    const previousDebt = clamp(student.previousDebt || student.debt);
    const schedule = buildSchedule(student);
    const alloc = allocatePayments(student, schedule);
    const paidAfterPrev = Math.max(0, alloc.totalPaid - (previousDebt - alloc.prevDebtAfter));
    const yearBalance = Math.max(0, feePerYear - paidAfterPrev);
    return {
      feePerYear,
      previousDebt,
      paidAmount: alloc.totalPaid,
      balance: yearBalance,
      periodDebtLabel: schedule.periodLabelNow || '—',
      periodDebtValue: alloc.debtTillNow,
      credit: alloc.credit,
      scheduleItems: alloc.scheduleItems
    };
  }

  function normalizePayments(source) {
    if (!source) return {};
    const normalized = {};
    Object.entries(source).forEach(([key, raw]) => {
      if (raw == null) return;
      if (typeof raw === 'number') {
        if (raw <= 0) return;
        normalized[key] = { amount: Number(raw), timestamp: Date.now() };
        return;
      }
      const amount = Number(raw.amount ?? raw.value ?? raw.paid ?? raw.payment ?? raw.total ?? 0);
      if (!Number.isFinite(amount) || amount <= 0) return;
      const timestamp = Number(
        raw.timestamp ?? raw.datePaid ?? raw.createdAt ?? raw.updatedAt ?? raw.recordedAt ?? raw.time ?? Date.now()
      );
      normalized[key] = { ...raw, amount, timestamp };
    });
    return normalized;
  }

  function buildFinanceStudents(
    baseStudents = {},
    enrollments = {},
    classFees = {},
    overrides = {},
    ledgers = {},
    carryForward = {},
    year = activeYear
  ) {
    const targetYear = String(year || activeYear);
    const map = {};
    const ids = new Set([
      ...Object.keys(baseStudents || {}),
      ...Object.keys(enrollments || {}),
      ...Object.keys(overrides || {}),
      ...Object.keys(ledgers || {}),
      ...Object.keys(carryForward || {}),
    ]);

    ids.forEach((id) => {
      const base = baseStudents[id] || {};
      const enrollment = enrollments[id] || {};
      const override = overrides[id] || {};
      const ledger = ledgers[id] || {};
      const carry = carryForward[id] || {};
      const classLevel = enrollment.className || enrollment.classLevel || base.classLevel || base.class || '';
      const classDefaults = classFees[classLevel] || {};

      const resolvedFee =
        override.feePerYear ??
        classDefaults.feePerYear ??
        base.feePerYear ??
        base.feeDue ??
        base.requiredFee ??
        0;
      const feePerYear = Math.max(0, Math.round(Number(resolvedFee) || 0));
      const paymentPlan = override.planName || classDefaults.defaultPlan || base.paymentPlan || '6-instalments';

      let paymentsSource =
        (ledger[targetYear] && (ledger[targetYear].payments || ledger[targetYear].entries)) ||
        ledger.payments ||
        ledger.records ||
        base.payments ||
        {};
      const payments = normalizePayments(paymentsSource);

      const previousDebt = clamp(
        carry.amount ?? carry.balance ?? override.carryForward ?? override.previousDebt ?? base.previousDebt ?? base.debt
      );

      const parentContact =
        enrollment.parentPhone ||
        enrollment.guardianPhone ||
        base.primaryParentContact ||
        base.parentPhone ||
        base.guardianPhone ||
        base.contact ||
        '';

      const record = {
        ...base,
        classLevel,
        paymentPlan,
        feePerYear,
        previousDebt,
        payments,
        financeYear: targetYear,
        primaryParentContact: parentContact || base.primaryParentContact,
        admissionNumber: enrollment.admissionNumber || enrollment.admissionNo || base.admissionNumber || id,
      };

      if (!record.firstName && enrollment.firstName) record.firstName = enrollment.firstName;
      if (!record.lastName && enrollment.lastName) record.lastName = enrollment.lastName;
      if (!record.middleName && enrollment.middleName) record.middleName = enrollment.middleName;
      if (override && Object.keys(override).length) record.override = override;
      record._classDefaults = classDefaults;
      map[id] = record;
    });

    return map;
  }

  // ====== SPEED FIX: placeholder breakdown row (no iframe yet) ======
  function breakdownRowHTML(id) {
    return `
      <tr id="br-${id}" class="hidden bg-slate-50">
        <td class="p-2 border-t" colspan="10">
          <div class="breakdown-slot" data-id="${id}">
            <div class="p-3 text-xs text-slate-500 skel rounded">Loading area…</div>
          </div>
        </td>
      </tr>
    `;
  }

  // ===== Render table (unchanged except: uses placeholder breakdown row) =====
  function renderTable() {
    tbody.innerHTML = '';
    let totalDue = 0, totalCollected = 0;
    const filterClass = classFilter.value;

    Object.entries(cachedStudents).forEach(([id, student]) => {
      if (filterClass && student.classLevel !== filterClass) return;

      const fin = computeStudentFinancials(student);
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.periodDebtValue <= 0)) return;

      totalDue += fin.feePerYear;
      totalCollected += fin.paidAmount;

      const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();
      const debtLabel = fin.periodDebtValue > 0 ? `Debt till ${fin.periodDebtLabel}` : '—';

      const tr = document.createElement('tr');
      tr.className = 'table-row';
      tr.innerHTML = `
        <td class="p-2 border text-center align-top">
          <button class="expander text-indigo-600 hover:text-indigo-800" data-id="${id}" title="Expand/Collapse">
            <i class="fa fa-chevron-down"></i>
          </button>
        </td>
        <td class="p-2 border align-top">${student.admissionNumber || ''}</td>
        <td class="p-2 border align-top">${fullName}</td>
        <td class="p-2 border align-top">${student.classLevel || ''}</td>
        <td class="p-2 border align-top text-right">${fmt(fin.feePerYear)}</td>
        <td class="p-2 border align-top">${student.paymentPlan || ''}</td>
        <td class="p-2 border align-top text-right">${fmt(fin.paidAmount)}</td>
        <td class="p-2 border align-top text-right">${fmt(fin.balance)}</td>
        <td class="p-2 border align-top">
          <div class="flex items-center justify-between gap-2">
            <span>${debtLabel}</span>
            <span class="font-semibold ${fin.periodDebtValue > 0 ? 'text-red-700' : ''}">${fmt(fin.periodDebtValue)}</span>
          </div>
        </td>
        <td class="p-2 border align-top">
          <button class="viewBtn px-2 py-1 text-xs border rounded" data-id="${id}">View</button>
          <button class="payBtn px-2 py-1 text-xs bg-indigo-600 text-white rounded ml-1" data-id="${id}">Pay</button>
        </td>
      `;
      tbody.appendChild(tr);

      const brWrap = document.createElement('tbody');
      brWrap.innerHTML = breakdownRowHTML(id);
      tbody.appendChild(brWrap.firstElementChild);
    });

    const totalOutstanding = totalDue - totalCollected;
    const totalDueEl = document.getElementById('totalDue');
    if (totalDueEl) {
      totalDueEl.textContent = fmt(totalDue);
      totalDueEl.dataset.amount = String(totalDue);
    }
    const totalCollectedEl = document.getElementById('totalCollected');
    if (totalCollectedEl) {
      totalCollectedEl.textContent = fmt(totalCollected);
      totalCollectedEl.dataset.amount = String(totalCollected);
    }
    const totalOutstandingEl = document.getElementById('totalOutstanding');
    if (totalOutstandingEl) {
      totalOutstandingEl.textContent = fmt(totalOutstanding);
      totalOutstandingEl.dataset.amount = String(totalOutstanding);
    }

    tbody.querySelectorAll('.payBtn').forEach(btn => btn.addEventListener('click', e => openPaymentModalFor(e.target.dataset.id)));
    tbody.querySelectorAll('.viewBtn').forEach(btn => btn.addEventListener('click', e => openDetailsModal(e.target.dataset.id)));
    // NOTE: no per-row expander listeners added here (we use a single global delegated listener below)
  }

  // ====== SPEED FIX: lazy-load a single iframe when clicked, and close others ======
  function injectIframeIfNeeded(id) {
    const row = document.getElementById(`br-${id}`);
    if (!row) return;
    const slot = row.querySelector('.breakdown-slot');
    if (!slot) return;
    if (slot.dataset.loaded) return;

    const scopeParam = parentCtx.enabled ? '&scope=parent' : '';
    slot.innerHTML = `
      <div class="p-3 text-xs text-slate-500">Loading breakdown…</div>
      <iframe
        src="Tofinancehtml/payment.html?student=${encodeURIComponent(id)}&v=1${scopeParam}"
        class="w-full h-[360px] rounded border"
        loading="lazy"
      ></iframe>
    `;
    slot.dataset.loaded = '1';
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button.expander');
    if (!btn) return;

    const id = btn.dataset.id;
    const row = document.getElementById(`br-${id}`);
    if (!row) return;

    // Close any other open breakdown rows
    document.querySelectorAll('tr[id^="br-"]:not(.hidden)').forEach(r => {
      if (r !== row) r.classList.add('hidden');
    });
    // Reset other chevrons
    document.querySelectorAll('button.expander.open').forEach(b => {
      if (b !== btn) {
        b.classList.remove('open');
        const ic = b.querySelector('i'); if (ic) ic.classList.remove('fa-chevron-up'); if (ic) ic.classList.add('fa-chevron-down');
      }
    });

    const wasHidden = row.classList.contains('hidden');
    row.classList.toggle('hidden');

    const icon = btn.querySelector('i');
    if (wasHidden) {
      btn.classList.add('open');
      if (icon) { icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up'); }
      injectIframeIfNeeded(id);
    } else {
      btn.classList.remove('open');
      if (icon) { icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down'); }
    }
  });

  // Auto-resize when child posts its height
  window.addEventListener('message', (e) => {
    const d = e.data || {};
    if (d.type === 'resizeIframe' && d.id) {
      const frame = document.querySelector(`#br-${d.id} iframe`);
      if (frame) frame.style.height = Math.max(360, Number(d.height) || 0) + 'px';
    }
  });

  // ===== Expenses + exports (unchanged) =====
  const expenseForm = document.getElementById('expenseForm');
  const expenseTableBody = document.querySelector('#expenseTable tbody');

  async function loadExpenses(year = activeYear) {
    try {
      const targetYear = String(year || activeYear);
      let snap = await db.ref(`expenses/${targetYear}`).once('value');
      let raw = snap.val();
      if (!raw || (typeof raw === 'object' && !Object.keys(raw).length)) {
        snap = await db.ref('expenses').once('value');
        raw = snap.val();
      }
      expenseTableBody.innerHTML = '';
      let total = 0;
      Object.values(raw || {}).forEach(exp => {
        total += Number(exp.amount) || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 border">${exp.category || ''}</td>
          <td class="p-2 border">${exp.description || ''}</td>
          <td class="p-2 border text-right">${fmt(exp.amount)}</td>
          <td class="p-2 border">${exp.timestamp ? new Date(exp.timestamp).toLocaleDateString() : ''}</td>
        `;
        expenseTableBody.appendChild(tr);
      });
      const totalExpensesEl = document.getElementById('totalExpenses');
      if (totalExpensesEl) {
        totalExpensesEl.textContent = fmt(total);
        totalExpensesEl.dataset.amount = String(total);
      }
      const collectedEl = document.getElementById('totalCollected');
      const collected = Number(collectedEl?.dataset.amount || 0);
      const net = collected - total;
      const netEl = document.getElementById('netBalance');
      if (netEl) {
        netEl.textContent = fmt(net);
        netEl.dataset.amount = String(net);
      }
    } catch (err) {
      console.error('Error loading expenses:', err);
      alert('Error loading expenses: ' + err.message);
    }
  }

  async function refreshFinanceData(year = activeYear) {
    await loadStudents(year);
    await loadExpenses(year);
  }

  // ===== CSV/PDF downloaders (parent-scoped) =====
  function downloadCSV_Main() {
    const rows = [['Admission No', 'Full Name', 'Class', 'Fee (Year)', 'Plan', 'Paid', 'Balance (Year)', 'Debt till …', 'Debt Amount']];
    let totalFee = 0, totalPaid = 0, totalBal = 0, totalDebt = 0;
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && s.classLevel !== filterClass) return;
      const fin = computeStudentFinancials(s);
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.periodDebtValue <= 0)) return;
      const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
      rows.push([s.admissionNumber || '', fullName, s.classLevel || '', fin.feePerYear, s.paymentPlan || '', fin.paidAmount, fin.balance, fin.periodDebtLabel, fin.periodDebtValue]);
      totalFee += fin.feePerYear; totalPaid += fin.paidAmount; totalBal += fin.balance; totalDebt += fin.periodDebtValue;
    });
    rows.push(['TOTAL', '', '', totalFee, '', totalPaid, totalBal, '', totalDebt]);
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Finance');
    
    // Parent mode: use child-specific filename
    let filename = `finance_export_${Date.now()}.xlsx`;
    if (parentCtx.enabled) {
      const onlyId = Object.keys(cachedStudents||{})[0];
      const only = cachedStudents[onlyId] || {};
      const adm = only.admissionNumber || onlyId;
      filename = `finance_${adm}_${(parentCtx.year||financeYear)}.xlsx`;
    }
    XLSX.writeFile(wb, filename);
  }

  function downloadPDF_Main() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    const headers = [['Admission No', 'Full Name', 'Class', 'Fee (Year)', 'Plan', 'Paid', 'Balance (Year)', 'Debt till …', 'Debt Amount']];
    const body = [];
    let totalFee = 0, totalPaid = 0, totalBal = 0, totalDebt = 0;
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && s.classLevel !== filterClass) return;
      const fin = computeStudentFinancials(s);
      if (showingDebtorsOnly && (fin.balance <= 0 && fin.periodDebtValue <= 0)) return;
      const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
      body.push([s.admissionNumber || '', fullName, s.classLevel || '', fin.feePerYear, s.paymentPlan || '', fin.paidAmount, fin.balance, fin.periodDebtLabel, fin.periodDebtValue]);
      totalFee += fin.feePerYear; totalPaid += fin.paidAmount; totalBal += fin.balance; totalDebt += fin.periodDebtValue;
    });
    body.push(['TOTAL', '', '', totalFee, '', totalPaid, totalBal, '', totalDebt]);
    doc.setFontSize(14); doc.text('SoMAp Finance Report', 14, 14);
    doc.autoTable({ head: headers, body, startY: 20, styles: { fontSize: 8 } });
    
    // Parent mode: use child-specific filename
    let filename = `finance_report_${Date.now()}.pdf`;
    if (parentCtx.enabled) {
      const onlyId = Object.keys(cachedStudents||{})[0];
      const only = cachedStudents[onlyId] || {};
      const adm = only.admissionNumber || onlyId;
      filename = `finance_${adm}_${(parentCtx.year||financeYear)}.pdf`;
    }
    doc.save(filename);
  }

  function _gatherDebtNow() {
    const rows = []; let totalDebt = 0;
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && s.classLevel !== filterClass) return;
      const fin = computeStudentFinancials(s);
      if (fin.periodDebtValue > 0) {
        const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
        rows.push([s.admissionNumber || '', fullName, s.classLevel || '', s.paymentPlan || '', fin.periodDebtLabel, fin.periodDebtValue]);
        totalDebt += fin.periodDebtValue;
      }
    });
    return { rows, totalDebt };
  }

  function downloadCSV_DebtNow() {
    const header = ['Admission No', 'Full Name', 'Class', 'Plan', 'Debt till …', 'Debt Amount'];
    const { rows, totalDebt } = _gatherDebtNow();
    const data = [header, ...rows, ['TOTAL', '', '', '', '', totalDebt]];
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Debt Now');
    XLSX.writeFile(wb, `debt_now_${Date.now()}.xlsx`);
  }

  function downloadPDF_DebtNow() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    const header = [['Admission No', 'Full Name', 'Class', 'Plan', 'Debt till …', 'Debt Amount']];
    const { rows, totalDebt } = _gatherDebtNow();
    const body = [...rows, ['TOTAL', '', '', '', '', totalDebt]];
    doc.setFontSize(14); doc.text('Debt List (Current Period)', 14, 14);
    doc.autoTable({ head: header, body: body, startY: 20, styles: { fontSize: 8 } });
    doc.save(`debt_now_${Date.now()}.pdf`);
  }

  function _gatherBreakdown() {
    const sheets = [];
    const filterClass = classFilter.value;
    Object.entries(cachedStudents).forEach(([id, s]) => {
      if (filterClass && s.classLevel !== filterClass) return;
      const fin = computeStudentFinancials(s);
      const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
      const rows = [['Period', 'Expected', 'Allocated Paid', 'Remaining', 'Status', 'Window']];
      let totalExp = 0, totalPaid = 0;
      fin.scheduleItems.forEach(it => {
        const need = it.amount, got = it.paidAllocated, rem = Math.max(0, need - got);
        totalExp += need; totalPaid += got;
        rows.push([it.label, need, got, rem, it.status, `${new Date(it.fromTS).toLocaleDateString()} – ${new Date(it.toTS).toLocaleDateString()}`]);
      });
      const totalRem = Math.max(0, totalExp - totalPaid);
      rows.push(['TOTAL', totalExp, totalPaid, totalRem, '', '']);
      sheets.push({ title: `${fullName} (${s.admissionNumber || ''})`, rows });
    });
    return sheets;
  }

  function downloadCSV_Breakdown() {
    const wb = XLSX.utils.book_new();
    const sheets = _gatherBreakdown();
    if (!sheets.length) return alert('No students to export.');
    sheets.forEach(sh => {
      const ws = XLSX.utils.aoa_to_sheet(sh.rows);
      XLSX.utils.book_append_sheet(wb, ws, sh.title.slice(0, 31));
    });
    
    // Parent mode: use child-specific filename
    let filename = `breakdowns_${Date.now()}.xlsx`;
    if (parentCtx.enabled) {
      const onlyId = Object.keys(cachedStudents||{})[0];
      const only = cachedStudents[onlyId] || {};
      const adm = only.admissionNumber || onlyId;
      filename = `breakdown_${adm}_${(parentCtx.year||financeYear)}.xlsx`;
    }
    XLSX.writeFile(wb, filename);
  }

  function downloadPDF_Breakdown() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    const sheets = _gatherBreakdown();
    if (!sheets.length) return alert('No students to export.');
    sheets.forEach((sh, idx) => {
      if (idx > 0) doc.addPage();
      doc.setFontSize(14);
      doc.text(`Installment Breakdown — ${sh.title}`, 14, 14);
      doc.autoTable({ head: [['Period', 'Expected', 'Allocated Paid', 'Remaining', 'Status', 'Window']], body: sh.rows.slice(1), startY: 20, styles: { fontSize: 8 } });
    });
    
    // Parent mode: use child-specific filename
    let filename = `breakdowns_${Date.now()}.pdf`;
    if (parentCtx.enabled) {
      const onlyId = Object.keys(cachedStudents||{})[0];
      const only = cachedStudents[onlyId] || {};
      const adm = only.admissionNumber || onlyId;
      filename = `breakdown_${adm}_${(parentCtx.year||financeYear)}.pdf`;
    }
    doc.save(filename);
  }

  // ===== Payments & modals (unchanged) =====
  function populateStudentSelect() {
    studentSelect.innerHTML = '<option value="">-- Select student --</option>';
    Object.entries(cachedStudents).forEach(([id, s]) => {
      const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = `${fullName} — ${s.classLevel || ''} — ${s.admissionNumber || ''}`;
      studentSelect.appendChild(opt);
    });
  }

  function openPaymentModalFor(id) {
    if (!cachedStudents[id]) return alert('Student not found');
    studentSelect.value = id;
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('paymentDate').value = today;
    paymentModal.style.display = 'block';
  }
  function closePaymentModalFn() { paymentModal.style.display = 'none'; paymentForm.reset(); }

  function openDetailsModal(id) {
    const s = cachedStudents[id]; if (!s) return alert('Student not found');
    const fin = computeStudentFinancials(s);
    const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
    let html = `
      <p><strong>Name:</strong> ${fullName}</p>
      <p><strong>Admission No:</strong> ${s.admissionNumber || ''}</p>
      <p><strong>Class:</strong> ${s.classLevel || ''}</p>
      <p><strong>Fee/year:</strong> ${fmt(fin.feePerYear || 0)}</p>
      <p><strong>Payment Plan:</strong> ${s.paymentPlan || ''}</p>
      <p><strong>Debt till:</strong> ${fin.periodDebtLabel} — <strong>${fmt(fin.periodDebtValue)}</strong></p>
      <p><strong>Paid:</strong> ${fmt(fin.paidAmount)}</p>
      <p><strong>Balance (Year):</strong> ${fmt(fin.balance)}</p>
      <hr class="my-3"/>
      <h4 class="font-semibold">Payments Ledger</h4>
    `;
    if (!s.payments) {
      html += '<div class="text-sm text-gray-500">No payments recorded yet.</div>';
    } else {
      html += `<div class="overflow-auto"><table class="min-w-full text-xs mt-2"><thead><tr class="table-header"><th class="p-1 border">Date</th><th class="p-1 border">Amount</th><th class="p-1 border">Method</th><th class="p-1 border">Note</th></tr></thead><tbody>`;
      Object.values(s.payments).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0)).forEach(p => {
        const d = new Date(p.timestamp || 0).toLocaleString();
        html += `<tr><td class="p-1 border">${d}</td><td class="p-1 border">${fmt(p.amount)}</td><td class="p-1 border">${p.method || ''}</td><td class="p-1 border">${p.note || ''}</td></tr>`;
      });
      html += `</tbody></table></div>`;
    }
    detailsContent.innerHTML = html;
    detailsModal.style.display = 'block';
  }
  function closeDetailsModalFn() { detailsModal.style.display = 'none'; detailsContent.innerHTML = ''; }

  function resolveRecorderEmail() {
    if (window.currentUserEmail) return window.currentUserEmail;
    try {
      if (window.sessionStorage) {
        const stored = sessionStorage.getItem('somapUserEmail') || sessionStorage.getItem('userEmail');
        if (stored) return stored;
      }
    } catch (_) {}
    try {
      if (firebase.auth) {
        const user = firebase.auth().currentUser;
        if (user && user.email) return user.email;
      }
    } catch (_) {}
    return 'unknown';
  }

  paymentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const studentId = studentSelect.value;
    const amount = Number(document.getElementById('paymentAmount').value || 0);
    const paymentDateInput = document.getElementById('paymentDate').value;
    const method = document.getElementById('paymentMethod').value || 'Cash';
    const reference = (document.getElementById('paymentReference').value || '').trim();
    const paidBy = (document.getElementById('paymentPaidBy').value || '').trim();
    const payerContact = (document.getElementById('paymentPayerContact').value || '').trim();
    const note = document.getElementById('paymentNote').value || '';
    if (!studentId) return alert('Choose a student');
    if (amount <= 0) return alert('Enter a valid amount');
    if (!paymentDateInput) return alert('Please select payment date');
    if (!paidBy) return alert('Please enter who made the payment');
    if (!payerContact) return alert('Please enter contact of payer');
    try {
      const studentRef = db.ref('students/' + studentId);
      const snap = await studentRef.once('value');
      const student = snap.val();
      if (!student) throw new Error('Student not found');

      const fin = computeStudentFinancials(student);
      const totalRequired = Number(fin.feePerYear || 0);
      const totalPaidBefore = Number(fin.paidAmount || 0);
      const newBalance = Math.max(0, totalRequired - Math.min(totalRequired, totalPaidBefore + amount));
      const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.replace(/\s+/g, ' ').trim();
      const recorder = resolveRecorderEmail();
      const paymentTimestamp = new Date(paymentDateInput).getTime() || Date.now();
      const parentContact = student.primaryParentContact || student.parentPhone || student.guardianPhone || student.emergencyPhone || '--';

      const pendingRef = db.ref('approvalsPending').push();
      await pendingRef.set({
        approvalId: pendingRef.key,
        sourceModule: 'finance',
        studentAdm: student.admissionNumber || studentId,
        studentName: fullName || (student.admissionNumber || studentId),
        className: student.classLevel || '',
        parentContact,
        amountPaidNow: Math.round(amount),
        paymentMethod: method,
        paymentReferenceCode: reference || 'N/A',
        datePaid: paymentTimestamp,
        paidBy: paidBy,
        payerContact: payerContact,
        recordedBy: recorder,
        status: 'pending',
        academicYear: financeYear,
        notes: note,
        totalRequired,
        totalPaidBefore,
        newBalanceAfterThis: newBalance,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        modulePayload: {
          studentKey: studentId,
          payment: {
            amount: Math.round(amount),
            method,
            note,
            timestamp: paymentTimestamp,
            recordedBy: recorder,
            referenceCode: reference || null,
            paidBy: paidBy,
            payerContact: payerContact,
          },
          breakdown: [
            { label: 'Academic Year', value: financeYear },
            { label: 'Plan', value: student.paymentPlan || '--' },
            { label: 'Fee (Year)', value: `TSh ${fmt(totalRequired)}` },
            { label: 'Paid Before', value: `TSh ${fmt(totalPaidBefore)}` },
            { label: 'Balance After Approval', value: `TSh ${fmt(newBalance)}` },
            { label: 'Paid By', value: paidBy },
            { label: 'Payer Contact', value: payerContact },
          ],
        },
      });

      alert('Payment sent for admin approval. Student will update once approved.');
      paymentForm.reset();
      closePaymentModalFn();
      await loadStudents();
    } catch (err) {
      console.error('Error recording payment', err);
      alert('Error recording payment: ' + err.message);
    }
  });

  // ===== Parent mode UI lockdown =====
  function applyParentModeUI(){
    if (!parentCtx.enabled) return;
    
    // Hide filters & bulk exports that could reveal other students
    ['classFilter','showOnlyDebtors','downloadDebtNowCsv','downloadDebtNowPdf',
     'downloadBreakdownCsv','downloadBreakdownPdf'].forEach(id=>{
      const el = document.getElementById(id); 
      if (el) el.style.display = 'none';
    });
    
    // Hide expenses KPIs (parents don't need to see school expenses)
    const kpiCards = document.querySelectorAll('.bg-white.p-4.rounded.shadow');
    if (kpiCards[3]) kpiCards[3].style.display = 'none'; // Total Expenses
    if (kpiCards[4]) kpiCards[4].style.display = 'none'; // Net Balance
    
    // Hide entire expenses section (form, table, reports)
    const expenseSections = document.querySelectorAll('.bg-white.rounded.shadow.p-4.mt-6');
    expenseSections.forEach(section => {
      if (section.querySelector('#expenseForm') || section.querySelector('#expenseTable')) {
        section.style.display = 'none';
      }
    });
    
    // Rename finance KPIs to parent-friendly labels
    const kpiHeaders = document.querySelectorAll('.bg-white.p-4.rounded.shadow h3');
    if (kpiHeaders[0]) kpiHeaders[0].textContent = 'Your Total Due (Year)';
    if (kpiHeaders[1]) kpiHeaders[1].textContent = 'Paid (Total)';
    if (kpiHeaders[2]) kpiHeaders[2].textContent = 'Balance';
    
    // Auto-open the lone breakdown row (there is exactly one row in parent mode)
    setTimeout(() => {
      const onlyId = Object.keys(cachedStudents||{})[0];
      if (onlyId) {
        const br = document.getElementById(`br-${onlyId}`);
        if (br) {
          br.classList.remove('hidden');
          injectIframeIfNeeded(onlyId);
          // Also rotate the chevron
          const expandBtn = document.querySelector(`button.expander[data-id="${onlyId}"]`);
          if (expandBtn) {
            expandBtn.classList.add('open');
            const icon = expandBtn.querySelector('i');
            if (icon) { 
              icon.classList.remove('fa-chevron-down'); 
              icon.classList.add('fa-chevron-up'); 
            }
          }
        }
      }
    }, 100);
  }

  // ===== Data loading and UI wiring =====
  async function loadStudents(year = activeYear) {
    if (!db) return;
    const targetYear = String(year || activeYear);
    activeYear = targetYear;
    financeYear = targetYear;
    updateYearHint();
    try {
      const [baseSnap, enrollmentSnap, classFeesSnap, overridesSnap, ledgerSnap, carrySnap] = await Promise.all([
        db.ref('students').once('value'),
        db.ref(`enrollments/${targetYear}`).once('value'),
        db.ref(`feesStructure/${targetYear}`).once('value'),
        db.ref(`studentFees/${targetYear}`).once('value'),
        db.ref(`financeLedgers/${targetYear}`).once('value'),
        db.ref(`financeCarryForward/${targetYear}`).once('value'),
      ]);
      const baseStudents = baseSnap.val() || {};
      cachedStudents = buildFinanceStudents(
        baseStudents,
        enrollmentSnap.val() || {},
        classFeesSnap.val() || {},
        overridesSnap.val() || {},
        ledgerSnap.val() || {},
        carrySnap.val() || {},
        targetYear
      );
      if (!Object.keys(cachedStudents).length) {
        cachedStudents = baseStudents;
      }

      // ===== Parent mode: filter to single learner =====
      if (parentCtx.enabled) {
        let targetId = parentCtx.studentId;
        if (!targetId && parentCtx.adm) {
          targetId = Object.keys(cachedStudents||{}).find(k =>
            String(cachedStudents[k]?.admissionNumber||'') === String(parentCtx.adm)
          );
        }
        if (!targetId || !cachedStudents[targetId]) {
          // Clear table and show a friendly message; do not leak other records
          const tbodyEl = document.querySelector('#financeTable tbody');
          if (tbodyEl) tbodyEl.innerHTML =
            `<tr><td colspan="10" class="p-4 text-center text-sm text-slate-600">
              No finance record found for this learner.
            </td></tr>`;
          // Also lock KPIs to 0
          ['totalDue','totalCollected','totalOutstanding'].forEach(id=>{
            const el = document.getElementById(id);
            if (el){ el.textContent = '0'; el.dataset.amount = '0'; }
          });
          // Stop further rendering in parent scope
          populateStudentSelect();
          applyParentModeUI();
          return;
        }
        // Reduce dataset to the single learner
        cachedStudents = { [targetId]: cachedStudents[targetId] };
      }

      populateStudentSelect();
      renderTable();
      if (parentCtx.enabled) {
        applyParentModeUI();
      }
    } catch (err) {
      console.error('Error loading students:', err);
      alert('Error loading students: ' + err.message);
    }
  }

  document.getElementById("downloadExpenseCsv").addEventListener("click", () => {
    const rows = [["Category", "Description", "Amount", "Date"]];
    document.querySelectorAll("#expenseTable tbody tr").forEach(tr => {
      const cells = [...tr.querySelectorAll("td")].map(td => td.innerText);
      rows.push(cells);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Expenses");
    XLSX.writeFile(wb, "expenses_report.xlsx");
  });

  document.getElementById("downloadExpensePdf").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Expense Report", 14, 10);
    const rows = [];
    document.querySelectorAll("#expenseTable tbody tr").forEach(tr => {
      const cells = [...tr.querySelectorAll("td")].map(td => td.innerText);
      rows.push(cells);
    });
    doc.autoTable({ head: [["Category", "Description", "Amount", "Date"]], body: rows, startY: 20 });
    doc.save("expenses_report.pdf");
  });

  closePaymentModal.addEventListener('click', closePaymentModalFn);
  cancelPayment.addEventListener('click', closePaymentModalFn);
  closeDetailsModal.addEventListener('click', closeDetailsModalFn);
  showOnlyDebtorsBtn.addEventListener('click', () => {
    showingDebtorsOnly = !showingDebtorsOnly;
    showOnlyDebtorsBtn.textContent = showingDebtorsOnly ? 'Showing Debtors' : 'Show Debtors';
    renderTable();
  });
  downloadCsvBtn.addEventListener('click', downloadCSV_Main);
  downloadPdfBtn.addEventListener('click', downloadPDF_Main);
  downloadDebtNowCsvBtn.addEventListener('click', downloadCSV_DebtNow);
  downloadDebtNowPdfBtn.addEventListener('click', downloadPDF_DebtNow);
  downloadBreakdownCsvBtn.addEventListener('click', downloadCSV_Breakdown);
  downloadBreakdownPdfBtn.addEventListener('click', downloadPDF_Breakdown);
  reloadBtn.addEventListener('click', async () => { await refreshFinanceData(financeYear); });

  if (yearContext) {
    yearContext.onYearChanged((year) => {
      const normalized = String(year);
      if (normalized === financeYear) return;
      refreshFinanceData(normalized);
    });
  }
  window.addEventListener('click', ev => {
    if (ev.target === paymentModal) closePaymentModalFn();
    if (ev.target === detailsModal) closeDetailsModalFn();
  });
  classFilter.addEventListener('change', renderTable);
  document.addEventListener('DOMContentLoaded', () => {
    updateYearHint();
    refreshFinanceData(activeYear);
  });
})();
</script>
</body>
</html>

