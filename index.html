<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SoMAp — Student Profiles</title>
<style>
  :root {
    --blue:#0b69ff; --muted:#f5f7fa; --card:#ffffff; --muted-text:#6b7280;
  }
  * { box-sizing:border-box; }
  body { margin:0; font-family:Inter,system-ui,Arial; background:var(--muted); color:#0b2540; min-height:100vh; display:flex; flex-direction:column; }
  header { background:var(--blue); color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
  header .title { font-weight:700; }
  .wrap { max-width:1100px; margin:18px auto; padding:12px; width:95%; }
  .card { background:var(--card); border-radius:10px; padding:14px; box-shadow:0 6px 18px rgba(11,22,50,0.06); border:1px solid rgba(11,22,50,0.04); margin-bottom:20px; }
  h3 { margin:0 0 8px 0; }
  .small { font-size:13px; color:var(--muted-text); }
  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { border:1px solid #ddd; padding:8px; text-align:left; }
  th { background-color:var(--blue); color:#fff; }
  button { background:var(--blue); color:#fff; border:none; padding:9px 12px; border-radius:8px; cursor:pointer; }
  button.ghost { background:#eef2ff; color:var(--blue); border:1px solid rgba(11,105,255,0.08); }
  /* Modal styles */
  .modal {
    display:none; position:fixed; z-index:1000;
    left:0; top:0; width:100%; height:100%;
    overflow:auto; background-color:rgba(0,0,0,0.5);
  }
  .modal-content {
    background:#fff; margin:10% auto; padding:20px; border-radius:8px;
    max-width:700px; max-height:80vh; overflow-y:auto;
    box-shadow:0 6px 18px rgba(11,22,50,0.1);
  }
  .close-btn {
    float:right; font-size:22px; font-weight:bold; cursor:pointer; color:var(--blue);
  }
  .profile-section { margin-bottom:16px; }
  .profile-section h4 {
    margin-bottom:8px; border-bottom:1px solid var(--blue); padding-bottom:4px; color:var(--blue);
  }
  .profile-row { margin-bottom:6px; }
  .profile-row strong {
    display:inline-block; width:180px; color:#0b2540;
  }
  img.attachment-img {
    max-width:150px; max-height:120px; border:1px solid #ddd; border-radius:6px; margin-right:10px;
  }
</style>
</head>
<body>

<header>
  <div class="title">SoMAp — Student Profiles</div>
  <div class="tiny">Realtime • Firebase Realtime DB</div>
</header>

<div class="wrap">
  <div class="card">
    <h3>Registered Students</h3>
    <div class="small">List of students registered in the system with key details.</div>
    <table id="profilesTable" aria-live="polite">
      <thead>
        <tr>
          <th>Full Name</th>
          <th>Class Level</th>
          <th>Admission Date</th>
          <th>Admission Number</th>
          <th>Fees Due</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="exportCsvBtn" style="margin-top:12px;">Export CSV</button>
  </div>
</div>

<!-- Modal -->
<div id="profileModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-content">
    <span class="close-btn" id="closeModalBtn" aria-label="Close details">&times;</span>
    <h3 id="modalTitle">Student Detailed Profile</h3>
    <div id="profileDetails"></div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>
<!-- Your firebase.js -->
<script src="firebase.js"></script>

<script>
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

const profilesTableBody = document.querySelector('#profilesTable tbody');
const exportCsvBtn = document.getElementById('exportCsvBtn');
const modal = document.getElementById('profileModal');
const profileDetailsEl = document.getElementById('profileDetails');
const closeModalBtn = document.getElementById('closeModalBtn');

let profilesCache = {};

db.ref('profiles').on('value', snapshot => {
  const profiles = snapshot.val() || {};
  profilesCache = profiles;
  profilesTableBody.innerHTML = '';

  const rows = [];

  Object.entries(profiles).forEach(([key, profile]) => {
    const fullName = profile.fullName || 'N/A';
    const classLevel = profile.classLevel || 'N/A';
    const admissionDate = profile.admissionDate || 'N/A';
    const admissionNumber = profile.admissionNumber || 'N/A';
    const feesDue = profile.feesDue != null ? profile.feesDue : 'N/A';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(fullName)}</td>
      <td>${escapeHtml(classLevel)}</td>
      <td>${escapeHtml(admissionDate)}</td>
      <td>${escapeHtml(admissionNumber)}</td>
      <td>${escapeHtml(feesDue)}</td>
      <td><button data-key="${key}" class="viewDetailsBtn">View Details</button></td>
    `;
    profilesTableBody.appendChild(tr);

    rows.push([fullName, classLevel, admissionDate, admissionNumber, feesDue]);
  });

  window.csvData = rows;

  document.querySelectorAll('.viewDetailsBtn').forEach(btn => {
    btn.addEventListener('click', e => {
      const key = e.target.dataset.key;
      showProfileDetails(key);
    });
  });
});

exportCsvBtn.addEventListener('click', () => {
  if (!window.csvData || window.csvData.length === 0) {
    alert('No student profiles found to export.');
    return;
  }
  const header = ['Full Name', 'Class Level', 'Admission Date', 'Admission Number', 'Fees Due'];
  const rows = [header, ...window.csvData];
  const csvContent = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'somap_profiles.csv';
  a.click();
  URL.revokeObjectURL(url);
});

closeModalBtn.addEventListener('click', () => {
  modal.style.display = 'none';
  profileDetailsEl.innerHTML = '';
});
window.onclick = e => {
  if (e.target === modal) {
    modal.style.display = 'none';
    profileDetailsEl.innerHTML = '';
  }
};

function showProfileDetails(key) {
  const profile = profilesCache[key];
  if (!profile) {
    alert('Profile not found');
    return;
  }
  const makeRow = (label, val) =>
    `<div class="profile-row"><strong>${escapeHtml(label)}:</strong> ${escapeHtml(val || 'N/A')}</div>`;

  let html = '';

  html += `<div class="profile-section"><h4>Basic Information</h4>`;
  html += makeRow('Full Name', profile.fullName);
  html += makeRow('Gender', profile.gender);
  html += makeRow('Date of Birth', profile.dateOfBirth);
  html += makeRow('Admission Number', profile.admissionNumber);
  html += makeRow('Pupil’s ID', profile.pupilId);
  html += makeRow('Birth Certificate Number', profile.birthCertificateNumber);
  html += makeRow('Religion', profile.religion);
  html += makeRow('Tribe/Ethnicity', profile.tribeEthnicity);
  html += `</div>`;

  html += `<div class="profile-section"><h4>School Information</h4>`;
  html += makeRow('School Name', profile.schoolName);
  html += makeRow('Class Level', profile.classLevel);
  html += makeRow('Stream', profile.stream);
  html += makeRow('Current Academic Year', profile.currentAcademicYear);
  html += makeRow('Academic Track', profile.academicTrack);
  html += makeRow('Boarding or Day Scholar', profile.boardingOrDayScholar);
  html += makeRow('Shifted From', profile.shiftedFrom);
  html += `</div>`;

  html += `<div class="profile-section"><h4>Parent/Guardian Details</h4>`;
  html += makeRow('Primary Parent Name', profile.primaryParentName);
  html += makeRow('Primary Parent Contact', profile.primaryParentContact);
  html += makeRow('Secondary Guardian', profile.secondaryGuardian);
  html += makeRow('Relationship to Student', profile.relationshipToStudent);
  html += makeRow('Residential Address', profile.residentialAddress);
  html += makeRow('Employment Status', profile.employmentStatus);
  html += `</div>`;

  html += `<div class="profile-section"><h4>Photos & Attachments</h4>`;
  if (profile.passportPhotoUrl)
    html += `<div><strong>Passport Photo:</strong><br><img src="${escapeHtml(profile.passportPhotoUrl)}" alt="Passport Photo" class="attachment-img" /></div>`;
  if (profile.birthCertificateUrl)
    html += `<div><strong>Birth Certificate:</strong> <a href="${escapeHtml(profile.birthCertificateUrl)}" target="_blank" rel="noopener noreferrer">View Document</a></div>`;
  if (profile.reportCardUrl)
    html += `<div><strong>Report Card:</strong> <a href="${escapeHtml(profile.reportCardUrl)}" target="_blank" rel="noopener noreferrer">View Document</a></div>`;
  if (profile.joiningLetterUrl)
    html += `<div><strong>Joining/Transfer Letter:</strong> <a href="${escapeHtml(profile.joiningLetterUrl)}" target="_blank" rel="noopener noreferrer">View Document</a></div>`;
  if (profile.medicalDocumentsUrl)
    html += `<div><strong>Medical Documents:</strong> <a href="${escapeHtml(profile.medicalDocumentsUrl)}" target="_blank" rel="noopener noreferrer">View Document</a></div>`;
  html += `</div>`;

  profileDetailsEl.innerHTML = html;
  modal.style.display = 'block';
}

function escapeHtml(text) {
  return String(text).replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  })[m]);
}
</script>

</body>
</html>
