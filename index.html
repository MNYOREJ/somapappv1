<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Live</title>
  <style>
    :root{
      --blue:#0b69ff; --muted:#f5f7fa; --card:#ffffff; --muted-text:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--muted);color:#0b2540;min-height:100vh;display:flex;flex-direction:column}
    header{background:var(--blue);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
    header .title{font-weight:700}
    .wrap{max-width:1100px;margin:18px auto;padding:12px;width:95%}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(11,22,50,0.06);border:1px solid rgba(11,22,50,0.04)}
    h3{margin:0 0 8px 0}
    .small{font-size:13px;color:var(--muted-text)}
    /* students */
    .form-row{display:flex;gap:8px;margin-top:10px}
    input[type="text"], input[type="number"], select, textarea{padding:10px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px}
    input[type="text"].small{padding:8px}
    button{background:var(--blue);color:#fff;border:none;padding:9px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:#eef2ff;color:var(--blue);border:1px solid rgba(11,105,255,0.08)}
    .students-list{max-height:320px;overflow:auto;margin-top:10px}
    .student-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #f3f4f6}
    .student-meta{font-size:13px;color:#374151}
    /* chat */
    .chat-wrapper{display:flex;flex-direction:column;height:520px}
    .chat-box{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,#fbfdff,#ffffff);border-radius:8px}
    .msg{max-width:75%;padding:10px;border-radius:10px;background:#f3f6ff;box-shadow:0 2px 4px rgba(12,20,30,0.03)}
    .msg.me{margin-left:auto;background:#dbeafe}
    .msg .meta{font-size:12px;color:var(--muted-text);margin-bottom:6px}
    .chat-controls{display:flex;gap:8px;margin-top:10px}
    .chat-controls input[type="text"]{flex:1}
    .meta-row{display:flex;gap:10px;align-items:center}
    .tiny{font-size:12px;color:var(--muted-text)}
    /* responsive */
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;max-width:900px}
      .chat-wrapper{height:380px}
    }
  </style>
</head>
<body>

  <header>
    <div class="title">SoMAp — Live Prototype</div>
    <div class="tiny">Realtime • Firebase Realtime DB</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Left: Students & Admin -->
      <div>
        <div class="card">
          <h3>Students</h3>
          <div class="small">Add students (saved to <code>/students</code> in your Realtime Database).</div>

          <div class="form-row">
            <input id="stuName" type="text" placeholder="Full name (e.g. Amina Yusuf)" />
            <input id="stuForm" type="text" placeholder="Form (e.g. Form 2)" style="width:130px" />
            <button id="addStudentBtn">Add</button>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="exportCsvBtn" class="ghost">Export CSV</button>
            <button id="seedBtn" class="ghost">Seed sample</button>
            <button id="clearDbStudentsBtn" class="ghost" title="Danger">Delete DB students</button>
          </div>

          <div class="students-list" id="studentsList" aria-live="polite" style="margin-top:12px">
            <!-- rows filled by JS -->
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Activity / Notes</h3>
          <div class="small">Test helpers: use the seed to populate sample data. To inspect stored data go to Firebase Console → Build → Realtime Database → Data.</div>
        </div>
      </div>

      <!-- Right: Chat -->
      <div>
        <div class="card">
          <h3>Live Chat</h3>
          <div class="small">Messages saved to <code>/messages</code>. Your messages show on the right.</div>

          <div style="margin-top:10px" class="meta-row">
            <input id="myName" type="text" placeholder="Your name (saved locally)" style="width:150px" />
            <div class="tiny" style="margin-left:auto">Status: <span id="status">—</span></div>
          </div>

          <div class="chat-wrapper" style="margin-top:10px">
            <div id="chat" class="chat-box" role="log" aria-live="polite"></div>

            <div class="chat-controls">
              <input id="msgInput" type="text" placeholder="Write a message..." />
              <button id="sendBtn">Send</button>
            </div>
          </div>

          <div style="margin-top:8px" class="small">Tip: press Enter to send. Use the Firebase Console to view raw nodes under <code>/students</code> and <code>/messages</code>.</div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Developer / Debug</h3>
          <div class="small">
            If you see <strong>permission_denied</strong> when trying to write, set Realtime DB rules temporarily to:
            <pre style="background:#f7f7f9;padding:8px;border-radius:6px">{ "rules": { ".read": true, ".write": true } }</pre>
            (Only for testing — secure later.)
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>

  <!-- firebase.js must exist in repo (keeps your real config) -->
  <script src="firebase.js"></script>

  <script>
  /* ======================
     SoMAp — front-end logic
     Expects firebase.js to define `firebaseConfig`
     ====================== */

  // sanity check
  if (!window.firebaseConfig) {
    document.getElementById('status').textContent = 'No firebaseConfig';
    console.error('Missing firebaseConfig. Create firebase.js with your config object.');
    // show friendly alert (don't throw so user sees UI)
    alert('Missing firebase.js (firebaseConfig). Please add your firebase.js file and redeploy.');
  } else {
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    document.getElementById('status').textContent = 'connected';
    initApp(db);
  }

  function initApp(db) {
    // elements
    const stuName = document.getElementById('stuName');
    const stuForm = document.getElementById('stuForm');
    const addStudentBtn = document.getElementById('addStudentBtn');
    const studentsList = document.getElementById('studentsList');

    const seedBtn = document.getElementById('seedBtn');
    const clearDbStudentsBtn = document.getElementById('clearDbStudentsBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');

    const chatEl = document.getElementById('chat');
    const myName = document.getElementById('myName');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    // preserve name locally
    myName.value = localStorage.getItem('somap_name') || '';
    myName.addEventListener('change', () => {
      localStorage.setItem('somap_name', myName.value.trim());
    });

    // ---- STUDENTS ----
    addStudentBtn.addEventListener('click', () => {
      const name = (stuName.value || '').trim();
      const form = (stuForm.value || '').trim() || 'N/A';
      if (!name) { alert('Enter student name'); return; }
      const payload = { name, form, feesDue: 0, createdAt: Date.now() };
      addStudentBtn.disabled = true;
      db.ref('students').push(payload)
        .then(() => {
          stuName.value = ''; stuForm.value = '';
        })
        .catch(err => alert('Save failed: ' + err.message))
        .finally(() => addStudentBtn.disabled = false);
    });

    // listen students -> render list
    db.ref('students').on('value', snap => {
      studentsList.innerHTML = '';
      const data = snap.val() || {};
      const keys = Object.keys(data);
      if (keys.length === 0) {
        studentsList.innerHTML = '<div class="small">No students yet.</div>';
        return;
      }
      keys.forEach(k => {
        const s = data[k];
        const row = document.createElement('div');
        row.className = 'student-row';
        row.innerHTML = `
          <div>
            <div class="student-meta" style="font-weight:600">${escapeHtml(s.name)}</div>
            <div class="small">${escapeHtml(s.form)} • fees: ${s.feesDue || 0}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="ghost" data-key="${k}" onclick="viewStudent(event)">View</button>
            <button data-key="${k}" onclick="deleteStudent(event)">Delete</button>
          </div>
        `;
        studentsList.appendChild(row);
      });
    });

    // helper functions exposed to inline handlers
    window.viewStudent = (e) => {
      const key = e.target.dataset.key;
      db.ref('students/' + key).once('value').then(snap => {
        const s = snap.val();
        alert(`Name: ${s.name}\nForm: ${s.form}\nFees due: ${s.feesDue || 0}`);
      });
    };

    window.deleteStudent = (e) => {
      const key = e.target.dataset.key;
      if (!confirm('Delete this student from DB?')) return;
      db.ref('students/' + key).remove().catch(err => alert('Delete failed: ' + err.message));
    };

    exportCsvBtn.addEventListener('click', () => {
      db.ref('students').once('value').then(snap => {
        const data = snap.val() || {};
        const rows = [['name','form','feesDue','createdAt']];
        Object.values(data).forEach(s => rows.push([s.name || '', s.form || '', s.feesDue || 0, s.createdAt || '']));
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'somap_students.csv'; a.click();
        URL.revokeObjectURL(url);
      });
    });

    seedBtn.addEventListener('click', async () => {
      if (!confirm('Seed sample students?')) return;
      const sample = [
        { name:'Amina Yusuf', form:'Form 2', feesDue:0, createdAt:Date.now() },
        { name:'Peter Kamau', form:'Form 4', feesDue:12000, createdAt:Date.now() },
        { name:'Grace Mwikali', form:'Form 1', feesDue:5000, createdAt:Date.now() }
      ];
      for (const s of sample) {
        await db.ref('students').push(s);
      }
      alert('Sample students added');
    });

    clearDbStudentsBtn.addEventListener('click', () => {
      if (!confirm('Delete ALL students in DB? This is permanent.')) return;
      db.ref('students').remove().then(() => alert('All students removed')).catch(err => alert(err.message));
    });

    // ---- CHAT ----
    function addMessageToUI(msgObj, key) {
      const el = document.createElement('div');
      const name = msgObj.name || 'Anon';
      const text = msgObj.text || '';
      const ts = msgObj.timestamp ? new Date(msgObj.timestamp) : new Date();
      const time = ts.toLocaleString();
      const me = (myName.value || '').trim() && (myName.value || '').trim().toLowerCase() === name.toLowerCase();

      el.className = 'msg' + (me ? ' me' : '');
      el.innerHTML = `<div class="meta"><strong>${escapeHtml(name)}</strong> • <span class="tiny">${escapeHtml(time)}</span></div><div>${escapeHtml(text)}</div>`;
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });

    function sendMessage() {
      const name = (myName.value || '').trim();
      const text = (msgInput.value || '').trim();
      if (!name) { alert('Enter your name'); return; }
      if (!text) return;
      sendBtn.disabled = true;
      const payload = { name, text, timestamp: Date.now() };
      db.ref('messages').push(payload)
        .then(() => { msgInput.value = ''; })
        .catch(err => alert('Send failed: ' + err.message))
        .finally(() => sendBtn.disabled = false);
    }

    // listen for new messages
    db.ref('messages').limitToLast(200).on('child_added', snap => {
      addMessageToUI(snap.val(), snap.key);
    });

    // optional: clear old messages helper available on console:
    window.clearMessages = () => {
      if (confirm('Delete ALL messages?')) db.ref('messages').remove();
    };

    // small helper to escape HTML
    function escapeHtml(str = '') {
      return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
    }
  }
  </script>
</body>
</html>
