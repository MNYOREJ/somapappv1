<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Live & Student Registration</title>
  <style>
    :root{
      --blue:#0b69ff; --muted:#f5f7fa; --card:#ffffff; --muted-text:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--muted);color:#0b2540;min-height:100vh;display:flex;flex-direction:column}
    header{background:var(--blue);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
    header .title{font-weight:700}
    .wrap{max-width:1100px;margin:18px auto;padding:12px;width:95%}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(11,22,50,0.06);border:1px solid rgba(11,22,50,0.04)}
    h3{margin:0 0 8px 0}
    .small{font-size:13px;color:var(--muted-text)}
    .form-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    input[type="text"], input[type="number"], input[type="date"], select, textarea{padding:10px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px;flex-grow:1;min-width:150px;}
    input[type="text"].small, input[type="date"].small{padding:8px}
    button{background:var(--blue);color:#fff;border:none;padding:9px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:#eef2ff;color:var(--blue);border:1px solid rgba(11,105,255,0.08)}
    .students-list{max-height:320px;overflow:auto;margin-top:10px}
    .student-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #f3f4f6}
    .student-meta{font-size:13px;color:#374151}
    .chat-wrapper{display:flex;flex-direction:column;height:520px}
    .chat-box{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,#fbfdff,#ffffff);border-radius:8px}
    .msg{max-width:75%;padding:10px;border-radius:10px;background:#f3f6ff;box-shadow:0 2px 4px rgba(12,20,30,0.03)}
    .msg.me{margin-left:auto;background:#dbeafe}
    .msg .meta{font-size:12px;color:var(--muted-text);margin-bottom:6px}
    .chat-controls{display:flex;gap:8px;margin-top:10px}
    .chat-controls input[type="text"]{flex:1}
    .meta-row{display:flex;gap:10px;align-items:center}
    .tiny{font-size:12px;color:var(--muted-text)}
    label{font-weight:600; font-size: 14px; margin-top:12px; display:block;}
    input[type="file"]{padding:6px; background:#fefefe; border-radius:6px; border:1px solid #ccc;}
    fieldset{border:1px solid #ddd; padding:12px 15px; border-radius:10px; margin-top:14px;}
    legend{font-weight:700; padding:0 6px;}
    /* responsive */
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;max-width:900px}
      .chat-wrapper{height:380px}
    }
  </style>
</head>
<body>

  <header>
    <div class="title">SoMAp — Live & Student Registration</div>
    <div class="tiny">Realtime • Firebase Realtime DB</div>
  </header>

  <div class="wrap">
    <div class="grid">

      <!-- Left: Registration Form + Students -->
      <div>

        <div class="card" style="margin-bottom:20px;">
          <h3>Student Registration & Profile Management</h3>
          <form id="registrationForm" enctype="multipart/form-data" novalidate>
            <fieldset>
              <legend>Basic Information</legend>
              <label for="firstName">First Name *</label>
              <input id="firstName" name="firstName" type="text" required placeholder="First Name" />
              <label for="middleName">Middle Name</label>
              <input id="middleName" name="middleName" type="text" placeholder="Middle Name" />
              <label for="lastName">Last Name *</label>
              <input id="lastName" name="lastName" type="text" required placeholder="Last Name" />
              <label for="gender">Gender *</label>
              <select id="gender" name="gender" required>
                <option value="">-- Select Gender --</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
              <label for="dob">Date of Birth *</label>
              <input id="dob" name="dob" type="date" required />
              <label for="admissionNumber">Admission Number (auto-generated)</label>
              <input id="admissionNumber" name="admissionNumber" type="text" readonly placeholder="Will be generated on submit" />
              <label for="pupilId">Pupil’s ID</label>
              <input id="pupilId" name="pupilId" type="text" placeholder="Pupil’s ID" />
              <label for="birthCertNumber">Birth Certificate Number</label>
              <input id="birthCertNumber" name="birthCertNumber" type="text" placeholder="Birth Certificate Number" />
              <label for="religion">Religion</label>
              <input id="religion" name="religion" type="text" placeholder="Religion" />
              <label for="tribe">Tribe/Ethnicity</label>
              <input id="tribe" name="tribe" type="text" placeholder="Tribe or Ethnicity" />
            </fieldset>

            <fieldset>
              <legend>School Information</legend>
              <label for="schoolName">School Name *</label>
              <input id="schoolName" name="schoolName" type="text" required placeholder="School Name" />
              <label for="classLevel">Class Level *</label>
              <input id="classLevel" name="classLevel" type="text" required placeholder="e.g. Class 4" />
              <label for="stream">Stream</label>
              <input id="stream" name="stream" type="text" placeholder="e.g. 4B" />
              <label for="academicYear">Current Academic Year *</label>
              <input id="academicYear" name="academicYear" type="text" required placeholder="e.g. 2024/2025" />
              <label for="academicTrack">Academic Track</label>
              <input id="academicTrack" name="academicTrack" type="text" placeholder="e.g. NECTA / SFNA" />
              <label for="boardingStatus">Boarding or Day Scholar *</label>
              <select id="boardingStatus" name="boardingStatus" required>
                <option value="">-- Select Status --</option>
                <option value="Boarding">Boarding</option>
                <option value="Day Scholar">Day Scholar</option>
              </select>
              <label for="shiftedFrom">Shifted From (for transfer-ins)</label>
              <input id="shiftedFrom" name="shiftedFrom" type="text" placeholder="Previous school if transferred" />
            </fieldset>

            <fieldset>
              <legend>Parent/Guardian Details</legend>
              <label for="primaryParentName">Primary Parent/Guardian Name *</label>
              <input id="primaryParentName" name="primaryParentName" type="text" required placeholder="Primary Parent/Guardian Name" />
              <label for="primaryParentContact">Primary Parent Contact (Mobile/WhatsApp) *</label>
              <input id="primaryParentContact" name="primaryParentContact" type="text" required placeholder="Contact Number" />
              <label for="secondaryGuardian">Secondary Guardian (if any)</label>
              <input id="secondaryGuardian" name="secondaryGuardian" type="text" placeholder="Secondary Guardian Name" />
              <label for="relationshipToStudent">Relationship to Student</label>
              <input id="relationshipToStudent" name="relationshipToStudent" type="text" placeholder="Relationship" />
              <label for="residentialAddress">Residential Address *</label>
              <textarea id="residentialAddress" name="residentialAddress" required placeholder="Residential Address" rows="2" style="resize:none"></textarea>
              <label for="employmentStatus">Employment Status (optional for bursary)</label>
              <input id="employmentStatus" name="employmentStatus" type="text" placeholder="Employment Status" />
            </fieldset>

            <fieldset>
              <legend>Photos & Attachments</legend>
              <label for="passportPhoto">Passport Photo</label>
              <input id="passportPhoto" name="passportPhoto" type="file" accept="image/*" />
              <label for="birthCertUpload">Birth Certificate Upload</label>
              <input id="birthCertUpload" name="birthCertUpload" type="file" accept="image/*,application/pdf" />
              <label for="reportCard">Report Card (First Term, Ongoing)</label>
              <input id="reportCard" name="reportCard" type="file" accept="image/*,application/pdf" />
              <label for="joiningLetter">Joining Letter / Transfer Letter (PDF/Image)</label>
              <input id="joiningLetter" name="joiningLetter" type="file" accept="image/*,application/pdf" />
              <label for="medicalDocs">Medical Documents (if applicable)</label>
              <input id="medicalDocs" name="medicalDocs" type="file" accept="image/*,application/pdf" />
            </fieldset>

            <div style="margin-top:14px; text-align:right;">
              <button type="submit">Register Student</button>
            </div>
          </form>
        </div>

        <div class="card">
          <h3>Students</h3>
          <div class="small">Add students (saved to <code>/students</code> in your Realtime Database).</div>

          <div class="form-row">
            <input id="stuName" type="text" placeholder="Full name (e.g. Amina Yusuf)" />
            <input id="stuForm" type="text" placeholder="Form (e.g. Form 2)" style="width:130px" />
            <button id="addStudentBtn">Add</button>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="exportCsvBtn" class="ghost">Export CSV</button>
            <button id="seedBtn" class="ghost">Seed sample</button>
            <button id="clearDbStudentsBtn" class="ghost" title="Danger">Delete DB students</button>
          </div>

          <div class="students-list" id="studentsList" aria-live="polite" style="margin-top:12px">
            <!-- rows filled by JS -->
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Activity / Notes</h3>
          <div class="small">Test helpers: use the seed to populate sample data. To inspect stored data go to Firebase Console → Build → Realtime Database → Data.</div>
        </div>
      </div>

      <!-- Right: Chat -->
      <div>
        <div class="card">
          <h3>Live Chat</h3>
          <div class="small">Messages saved to <code>/messages</code>. Your messages show on the right.</div>

          <div style="margin-top:10px" class="meta-row">
            <input id="myName" type="text" placeholder="Your name (saved locally)" style="width:150px" />
            <div class="tiny" style="margin-left:auto">Status: <span id="status">—</span></div>
          </div>

          <div class="chat-wrapper" style="margin-top:10px">
            <div id="chat" class="chat-box" role="log" aria-live="polite"></div>

            <div class="chat-controls">
              <input id="msgInput" type="text" placeholder="Write a message..." />
              <button id="sendBtn">Send</button>
            </div>
          </div>

          <div style="margin-top:8px" class="small">Tip: press Enter to send. Use the Firebase Console to view raw nodes under <code>/students</code> and <code>/messages</code>.</div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Developer / Debug</h3>
          <div class="small">
            If you see <strong>permission_denied</strong> when trying to write, set Realtime DB rules temporarily to:
            <pre style="background:#f7f7f9;padding:8px;border-radius:6px">{ "rules": { ".read": true, ".write": true } }</pre>
            (Only for testing — secure later.)
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>

  <!-- firebase.js must exist in repo (keeps your real config) -->
  <script src="firebase.js"></script>

  <script>
  if (!window.firebaseConfig) {
    document.getElementById('status').textContent = 'No firebaseConfig';
    console.error('Missing firebaseConfig. Create firebase.js with your config object.');
    alert('Missing firebase.js (firebaseConfig). Please add your firebase.js file and redeploy.');
  } else {
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    document.getElementById('status').textContent = 'connected';
    initApp(db);
  }

  function initApp(db) {
    // Elements for existing students & chat
    const stuName = document.getElementById('stuName');
    const stuForm = document.getElementById('stuForm');
    const addStudentBtn = document.getElementById('addStudentBtn');
    const studentsList = document.getElementById('studentsList');
    const seedBtn = document.getElementById('seedBtn');
    const clearDbStudentsBtn = document.getElementById('clearDbStudentsBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const chatEl = document.getElementById('chat');
    const myName = document.getElementById('myName');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    // Preserve chat user name locally
    myName.value = localStorage.getItem('somap_name') || '';
    myName.addEventListener('change', () => {
      localStorage.setItem('somap_name', myName.value.trim());
    });

    // --- Students List management (existing) ---
    addStudentBtn.addEventListener('click', () => {
      const name = (stuName.value || '').trim();
      const form = (stuForm.value || '').trim() || 'N/A';
      if (!name) { alert('Enter student name'); return; }
      const payload = { name, form, feesDue: 0, createdAt: Date.now() };
      addStudentBtn.disabled = true;
      db.ref('students').push(payload)
        .then(() => {
          stuName.value = ''; stuForm.value = '';
        })
        .catch(err => alert('Save failed: ' + err.message))
        .finally(() => addStudentBtn.disabled = false);
    });

    db.ref('students').on('value', snap => {
      studentsList.innerHTML = '';
      const data = snap.val() || {};
      const keys = Object.keys(data);
      if (keys.length === 0) {
        studentsList.innerHTML = '<div class="small">No students yet.</div>';
        return;
      }
      keys.forEach(k => {
        const s = data[k];
        const row = document.createElement('div');
        row.className = 'student-row';
        row.innerHTML = `
          <div>
            <div class="student-meta" style="font-weight:600">${escapeHtml(s.name)}</div>
            <div class="small">${escapeHtml(s.form)} • fees: ${s.feesDue || 0}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="ghost" data-key="${k}" onclick="viewStudent(event)">View</button>
            <button data-key="${k}" onclick="deleteStudent(event)">Delete</button>
          </div>
        `;
        studentsList.appendChild(row);
      });
    });

    window.viewStudent = (e) => {
      const key = e.target.dataset.key;
      db.ref('students/' + key).once('value').then(snap => {
        const s = snap.val();
        alert(`Name: ${s.name}\nForm: ${s.form}\nFees due: ${s.feesDue || 0}`);
      });
    };

    window.deleteStudent = (e) => {
      const key = e.target.dataset.key;
      if (!confirm('Delete this student from DB?')) return;
      db.ref('students/' + key).remove().catch(err => alert('Delete failed: ' + err.message));
    };

    exportCsvBtn.addEventListener('click', () => {
      db.ref('students').once('value').then(snap => {
        const data = snap.val() || {};
        const rows = [['name','form','feesDue','createdAt']];
        Object.values(data).forEach(s => rows.push([s.name || '', s.form || '', s.feesDue || 0, s.createdAt || '']));
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'somap_students.csv'; a.click();
        URL.revokeObjectURL(url);
      });
    });

    seedBtn.addEventListener('click', async () => {
      if (!confirm('Seed sample students?')) return;
      const sample = [
        { name:'Amina Yusuf', form:'Form 2', feesDue:0, createdAt:Date.now() },
        { name:'Peter Kamau', form:'Form 4', feesDue:12000, createdAt:Date.now() },
        { name:'Grace Mwikali', form:'Form 1', feesDue:5000, createdAt:Date.now() }
      ];
      for (const s of sample) {
        await db.ref('students').push(s);
      }
      alert('Sample students added');
    });

    clearDbStudentsBtn.addEventListener('click', () => {
      if (!confirm('Delete ALL students in DB? This is permanent.')) return;
      db.ref('students').remove().then(() => alert('All students removed')).catch(err => alert(err.message));
    });

    // --- Chat ---
    function addMessageToUI(msgObj, key) {
      const el = document.createElement('div');
      const name = msgObj.name || 'Anon';
      const text = msgObj.text || '';
      const ts = msgObj.timestamp ? new Date(msgObj.timestamp) : new Date();
      const time = ts.toLocaleString();
      const me = (myName.value || '').trim().toLowerCase() === name.toLowerCase();

      el.className = 'msg' + (me ? ' me' : '');
      el.innerHTML = `<div class="meta"><strong>${escapeHtml(name)}</strong> • <span class="tiny">${escapeHtml(time)}</span></div><div>${escapeHtml(text)}</div>`;
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });

    function sendMessage() {
      const name = (myName.value || '').trim();
      const text = (msgInput.value || '').trim();
      if (!name) { alert('Enter your name'); return; }
      if (!text) return;
      sendBtn.disabled = true;
      const payload = { name, text, timestamp: Date.now() };
      db.ref('messages').push(payload)
        .then(() => { msgInput.value = ''; })
        .catch(err => alert('Send failed: ' + err.message))
        .finally(() => sendBtn.disabled = false);
    }

    db.ref('messages').limitToLast(200).on('child_added', snap => {
      addMessageToUI(snap.val(), snap.key);
    });

    window.clearMessages = () => {
      if (confirm('Delete ALL messages?')) db.ref('messages').remove();
    };

    function escapeHtml(str = '') {
      return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
    }

    // --- New Registration form logic ---
    const registrationForm = document.getElementById('registrationForm');
    const admissionNumberInput = document.getElementById('admissionNumber');

    // Auto-generate Admission Number: format e.g. ADM-YYYYMMDD-HHMMSS-RANDOM
    function generateAdmissionNumber() {
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const datePart = now.getFullYear() + pad(now.getMonth()+1) + pad(now.getDate());
      const timePart = pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds());
      const randPart = Math.floor(Math.random() * 9000 + 1000); // 4-digit random number
      return `ADM-${datePart}-${timePart}-${randPart}`;
    }

    // On form submit
    registrationForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate required fields manually (HTML5 should cover mostly)
      if (!registrationForm.checkValidity()) {
        alert('Please fill in all required fields.');
        return;
      }

      // Collect form data
      const data = {
        basicInfo: {
          firstName: registrationForm.firstName.value.trim(),
          middleName: registrationForm.middleName.value.trim(),
          lastName: registrationForm.lastName.value.trim(),
          gender: registrationForm.gender.value,
          dob: registrationForm.dob.value,
          admissionNumber: admissionNumberInput.value || generateAdmissionNumber(),
          pupilId: registrationForm.pupilId.value.trim(),
          birthCertNumber: registrationForm.birthCertNumber.value.trim(),
          religion: registrationForm.religion.value.trim(),
          tribe: registrationForm.tribe.value.trim()
        },
        schoolInfo: {
          schoolName: registrationForm.schoolName.value.trim(),
          classLevel: registrationForm.classLevel.value.trim(),
          stream: registrationForm.stream.value.trim(),
          academicYear: registrationForm.academicYear.value.trim(),
          academicTrack: registrationForm.academicTrack.value.trim(),
          boardingStatus: registrationForm.boardingStatus.value,
          shiftedFrom: registrationForm.shiftedFrom.value.trim()
        },
        parentGuardian: {
          primaryParentName: registrationForm.primaryParentName.value.trim(),
          primaryParentContact: registrationForm.primaryParentContact.value.trim(),
          secondaryGuardian: registrationForm.secondaryGuardian.value.trim(),
          relationshipToStudent: registrationForm.relationshipToStudent.value.trim(),
          residentialAddress: registrationForm.residentialAddress.value.trim(),
          employmentStatus: registrationForm.employmentStatus.value.trim()
        },
        photosAttachments: {}
      };

      // Handle file uploads - files must be uploaded separately or via Firebase Storage.
      // Here we only save filenames & sizes in DB as a placeholder
      const fileFields = ['passportPhoto','birthCertUpload','reportCard','joiningLetter','medicalDocs'];
      for (const field of fileFields) {
        const input = registrationForm[field];
        if (input && input.files.length > 0) {
          data.photosAttachments[field] = {
            name: input.files[0].name,
            size: input.files[0].size,
            type: input.files[0].type,
            lastModified: input.files[0].lastModified
          };
        }
      }

      // Set the generated Admission Number field in form
      admissionNumberInput.value = data.basicInfo.admissionNumber;

      // Save to Firebase Realtime Database under "profiles"
      try {
        await db.ref('profiles').push(data);
        alert('Student profile registered successfully!');
        registrationForm.reset();
        admissionNumberInput.value = '';
      } catch (err) {
        alert('Failed to save student profile: ' + err.message);
      }
    });

  }
  </script>

</body>
</html>
