<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SOMA â€” Upload Books</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-100 to-pink-100 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-purple-600 text-white p-4 flex justify-between items-center shadow-lg">
    <h1 class="text-2xl font-bold">ðŸ“š SOMA Upload</h1>
    <div>
      <span id="loggedEmail" class="mr-3 italic"></span>
      <button id="loginBtn" class="bg-green-500 px-3 py-1 rounded-lg">Sign in</button>
      <button id="logoutBtn" class="bg-red-500 px-3 py-1 rounded-lg hidden">Logout</button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="flex-1 container mx-auto p-6 grid md:grid-cols-2 gap-6">

    <!-- UPLOAD CARD -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-purple-500">
      <h2 class="text-xl font-bold mb-4 text-purple-700">ðŸ“¤ Upload a New Book</h2>

      <!-- Alerts -->
      <div id="alertBox" class="hidden mb-4 p-3 rounded-lg"></div>

      <!-- Upload Form -->
      <div class="space-y-3">
        <input type="text" id="bookTitle" placeholder="Book Title"
          class="w-full p-2 border rounded-lg"/>
        
        <select id="classSelect" class="w-full p-2 border rounded-lg">
          <option value="">-- Select Class --</option>
          <option>Class 1</option>
          <option>Class 2</option>
          <option>Class 3</option>
          <option>Class 4</option>
          <option>Class 5</option>
          <option>Class 6</option>
          <option>Class 7</option>
        </select>

        <select id="subjectSelect" class="w-full p-2 border rounded-lg">
          <option value="">-- Select Subject --</option>
        </select>

        <input type="file" id="bookFile" class="w-full p-2 border rounded-lg bg-gray-50"/>

        <button id="uploadBtn" disabled
          class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">
          Upload Book
        </button>
      </div>
    </div>

    <!-- RECENT UPLOADS -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-green-500">
      <h2 class="text-xl font-bold mb-4 text-green-700">ðŸ“– Recent Uploads</h2>
      <ul id="recentUploads" class="space-y-2 text-gray-700 text-sm"></ul>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="bg-purple-600 text-white text-center py-3 text-sm">
    Â© 2025 Socrates School â€” Kids Learn with Colors ðŸŒˆ
  </footer>

  <script>
    // ---------------- FIREBASE CONFIG ----------------
    const firebaseConfig = {
      apiKey: "YOUR_FIREBASE_API_KEY",
      authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
      databaseURL: "YOUR_FIREBASE_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    // ---------------- CLOUDINARY CONFIG ----------------
    const cloudName = "YOUR_CLOUD_NAME";
    const unsignedPreset = "YOUR_UPLOAD_PRESET";

    // ---------------- DOM ELEMENTS ----------------
    const loggedEmail = document.getElementById('loggedEmail');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const bookTitle = document.getElementById('bookTitle');
    const classSelect = document.getElementById('classSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const bookFile = document.getElementById('bookFile');
    const alertBox = document.getElementById('alertBox');
    const recentUploads = document.getElementById('recentUploads');

    let currentUser = null;

    // ---------------- SUBJECTS BY CLASS ----------------
    const SUBJECTS_BY_CLASS = {
      "Class 1": ["Math", "English", "Kiswahili"],
      "Class 2": ["Math", "English", "Kiswahili"],
      "Class 3": ["Math", "English", "Kiswahili", "Science"],
      "Class 4": ["Math", "English", "Kiswahili", "Science", "Social Studies"],
      "Class 5": ["Math", "English", "Kiswahili", "Science", "Social Studies"],
      "Class 6": ["Math", "English", "Kiswahili", "Science", "Social Studies"],
      "Class 7": ["Math", "English", "Kiswahili", "Science", "Social Studies", "History"]
    };

    classSelect.addEventListener('change', () => {
      const subjects = SUBJECTS_BY_CLASS[classSelect.value] || [];
      subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
      subjects.forEach(sub => {
        const opt = document.createElement('option');
        opt.value = sub;
        opt.textContent = sub;
        subjectSelect.appendChild(opt);
      });
    });

    // ---------------- HELPERS ----------------
    function normalizeEmailKey(email) {
      return email ? email.replace(/\./g, '_') : '';
    }

    function showAlert(msg, type="info") {
      alertBox.textContent = msg;
      alertBox.className = `mb-4 p-3 rounded-lg text-sm font-medium`;
      if(type==="error") alertBox.classList.add("bg-red-100","text-red-700","border","border-red-300");
      if(type==="success") alertBox.classList.add("bg-green-100","text-green-700","border","border-green-300");
      if(type==="info") alertBox.classList.add("bg-blue-100","text-blue-700","border","border-blue-300");
      alertBox.classList.remove("hidden");
    }

    // ---------------- AUTH ----------------
    loginBtn.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).catch(err => showAlert("Login failed: "+err.message,"error"));
    });

    logoutBtn.addEventListener('click', () => {
      firebase.auth().signOut();
    });

    firebase.auth().onAuthStateChanged(user => {
      if(!user){
        currentUser = null;
        loggedEmail.textContent = "not signed in";
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        uploadBtn.disabled = true;
        return;
      }
      currentUser = user;
      loggedEmail.textContent = user.email;
      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");

      const key = normalizeEmailKey(user.email);
      firebase.database().ref("users/"+key).once("value").then(snap=>{
        const data = snap.val();
        if(data && data.role==="admin"){
          showAlert("Welcome Admin! You can upload books.","success");
          uploadBtn.disabled = false;
        } else {
          showAlert("You are not an admin. Upload disabled.","error");
          uploadBtn.disabled = true;
        }
      });
    });

    // ---------------- UPLOAD ----------------
    uploadBtn.addEventListener('click', async () => {
      if(!bookFile.files[0]) return showAlert("Please choose a file.","error");

      const file = bookFile.files[0];
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", unsignedPreset);

      showAlert("Uploading file...","info");
      try {
        const res = await axios.post(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, formData);
        const fileUrl = res.data.secure_url;

        const newRef = firebase.database().ref("books").push();
        await newRef.set({
          title: bookTitle.value,
          class: classSelect.value,
          subject: subjectSelect.value,
          url: fileUrl,
          uploadedBy: currentUser.email,
          timestamp: Date.now()
        });

        showAlert("Book uploaded successfully!","success");
        bookTitle.value = "";
        classSelect.value = "";
        subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        bookFile.value = "";
      } catch(err){
        showAlert("Upload failed: "+err.message,"error");
      }
    });

    // ---------------- RECENT UPLOADS ----------------
    firebase.database().ref("books").limitToLast(10).on("child_added", snap=>{
      const data = snap.val();
      const li = document.createElement("li");
      li.innerHTML = `<a href="${data.url}" target="_blank" class="text-purple-600 underline">${data.title}</a> 
        <span class="text-gray-500">(${data.class} - ${data.subject})</span>`;
      recentUploads.prepend(li);
    });
  </script>
</body>
</html>
