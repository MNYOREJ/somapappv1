<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Live with Student Registration</title>
  <style>
    :root{
      --blue:#0b69ff; --muted:#f5f7fa; --card:#ffffff; --muted-text:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--muted);color:#0b2540;min-height:100vh;display:flex;flex-direction:column}
    header{background:var(--blue);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
    header .title{font-weight:700}
    .wrap{max-width:1100px;margin:18px auto;padding:12px;width:95%}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
    .card{background:var(--card);border-radius:10px;padding:20px 24px;box-shadow:0 6px 18px rgba(11,22,50,0.06);border:1px solid rgba(11,22,50,0.04);margin-bottom:20px;}
    h2, h3{margin-top:0;margin-bottom:12px;color:var(--blue);}
    h3{font-weight:600;}
    .small{font-size:13px;color:var(--muted-text);margin-bottom:12px;}
    /* students */
    .form-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px}
    label{flex-basis:100%;font-weight:600; margin-bottom:6px; color:#0b2540;}
    input[type="text"], input[type="number"], input[type="date"], input[type="email"], select, textarea {
      padding:10px; border:1px solid #e6e9ef; border-radius:8px; font-size:14px; width:100%;
      font-family:inherit;
    }
    input[type="file"] {
      font-size: 14px;
    }
    select {
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      background: white url('data:image/svg+xml;utf8,<svg fill="%230b69ff" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
      background-size: 16px 16px;
      cursor: pointer;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    button {
      background: var(--blue);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      margin-top: 10px;
      transition: background-color 0.3s ease;
      width: 100%;
    }
    button:hover {
      background: #074bd9;
    }
    .section {
      border-top: 1px solid #e6e9ef;
      padding-top: 20px;
      margin-top: 20px;
    }
    .grid-two-cols {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    @media (max-width: 720px) {
      .grid-two-cols {
        grid-template-columns: 1fr;
      }
      .grid {
        grid-template-columns: 1fr;
        max-width: 900px;
      }
    }
  </style>
</head>
<body>

  <header>
    <div class="title">SoMAp — Live Prototype with Student Registration</div>
    <div class="tiny">Realtime • Firebase Realtime DB</div>
  </header>

  <div class="wrap">
    <div class="grid">

      <!-- Left: New Student Registration Form & Students & Admin -->
      <div>

        <!-- New Student Registration & Profile Management -->
        <div class="card" id="studentRegistration">
          <h2>Student Registration & Profile Management</h2>
          <p class="small">Complete the digital student profile form below.</p>

          <form id="registrationForm" enctype="multipart/form-data" novalidate>

            <!-- Basic Information -->
            <div class="section">
              <h3>Basic Information</h3>
              <div class="grid-two-cols">
                <div>
                  <label for="firstName">First Name *</label>
                  <input type="text" id="firstName" name="firstName" placeholder="First Name" required />
                </div>
                <div>
                  <label for="middleName">Middle Name</label>
                  <input type="text" id="middleName" name="middleName" placeholder="Middle Name" />
                </div>
                <div>
                  <label for="lastName">Last Name *</label>
                  <input type="text" id="lastName" name="lastName" placeholder="Last Name" required />
                </div>
                <div>
                  <label for="gender">Gender *</label>
                  <select id="gender" name="gender" required>
                    <option value="" disabled selected>Select gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div>
                  <label for="dob">Date of Birth *</label>
                  <input type="date" id="dob" name="dob" required />
                </div>
                <div>
                  <label for="admissionNumber">Admission Number (Auto-generated)</label>
                  <input type="text" id="admissionNumber" name="admissionNumber" placeholder="Auto-generated on save" disabled />
                </div>
                <div>
                  <label for="pupilId">Pupil’s ID</label>
                  <input type="text" id="pupilId" name="pupilId" placeholder="Pupil's ID" />
                </div>
                <div>
                  <label for="birthCertNumber">Birth Certificate Number</label>
                  <input type="text" id="birthCertNumber" name="birthCertNumber" placeholder="Birth Certificate Number" />
                </div>
                <div>
                  <label for="religion">Religion</label>
                  <input type="text" id="religion" name="religion" placeholder="Religion" />
                </div>
                <div>
                  <label for="tribe">Tribe / Ethnicity</label>
                  <input type="text" id="tribe" name="tribe" placeholder="Tribe or Ethnicity" />
                </div>
              </div>
            </div>

            <!-- School Information -->
            <div class="section">
              <h3>School Information</h3>
              <div class="grid-two-cols">
                <div>
                  <label for="schoolName">School Name *</label>
                  <input type="text" id="schoolName" name="schoolName" placeholder="School Name" required />
                </div>
                <div>
                  <label for="classLevel">Class Level *</label>
                  <input type="text" id="classLevel" name="classLevel" placeholder="e.g., Class 4" required />
                </div>
                <div>
                  <label for="stream">Stream</label>
                  <input type="text" id="stream" name="stream" placeholder="e.g., 4B" />
                </div>
                <div>
                  <label for="academicYear">Current Academic Year *</label>
                  <input type="text" id="academicYear" name="academicYear" placeholder="e.g., 2024" required />
                </div>
                <div>
                  <label for="academicTrack">Academic Track</label>
                  <input type="text" id="academicTrack" name="academicTrack" placeholder="e.g., NECTA / SFNA" />
                </div>
                <div>
                  <label for="boardingStatus">Boarding or Day Scholar *</label>
                  <select id="boardingStatus" name="boardingStatus" required>
                    <option value="" disabled selected>Select status</option>
                    <option value="Boarding">Boarding</option>
                    <option value="Day Scholar">Day Scholar</option>
                  </select>
                </div>
                <div style="grid-column: span 2;">
                  <label for="shiftedFrom">Shifted From (for transfer-ins)</label>
                  <input type="text" id="shiftedFrom" name="shiftedFrom" placeholder="Previous school if transferred" />
                </div>
              </div>
            </div>

            <!-- Parent / Guardian Details -->
            <div class="section">
              <h3>Parent / Guardian Details</h3>
              <div class="grid-two-cols">
                <div>
                  <label for="primaryParentName">Primary Parent Name *</label>
                  <input type="text" id="primaryParentName" name="primaryParentName" placeholder="Primary Parent or Guardian" required />
                </div>
                <div>
                  <label for="primaryParentContact">Primary Parent Contact (Mobile, WhatsApp) *</label>
                  <input type="text" id="primaryParentContact" name="primaryParentContact" placeholder="+255 7xx xxx xxx" required />
                </div>
                <div>
                  <label for="secondaryGuardian">Secondary Guardian (if any)</label>
                  <input type="text" id="secondaryGuardian" name="secondaryGuardian" placeholder="Secondary Guardian" />
                </div>
                <div>
                  <label for="relationshipToStudent">Relationship to Student</label>
                  <input type="text" id="relationshipToStudent" name="relationshipToStudent" placeholder="e.g., Aunt, Uncle" />
                </div>
                <div style="grid-column: span 2;">
                  <label for="residentialAddress">Residential Address *</label>
                  <textarea id="residentialAddress" name="residentialAddress" placeholder="Residential Address" required></textarea>
                </div>
                <div style="grid-column: span 2;">
                  <label for="employmentStatus">Employment Status (if needed for bursary qualification)</label>
                  <input type="text" id="employmentStatus" name="employmentStatus" placeholder="Employment Status" />
                </div>
              </div>
            </div>

            <!-- Photos & Attachments -->
            <div class="section">
              <h3>Photos & Attachments</h3>
              <div class="grid-two-cols">
                <div>
                  <label for="passportPhoto">Passport Photo Upload</label>
                  <input type="file" id="passportPhoto" name="passportPhoto" accept="image/*" />
                </div>
                <div>
                  <label for="birthCertUpload">Birth Certificate Upload</label>
                  <input type="file" id="birthCertUpload" name="birthCertUpload" accept="image/*,application/pdf" />
                </div>
                <div>
                  <label for="reportCardUpload">Report Card (First Term, Ongoing)</label>
                  <input type="file" id="reportCardUpload" name="reportCardUpload" accept="image/*,application/pdf" />
                </div>
                <div>
                  <label for="joiningLetterUpload">Joining or Transfer Letter (PDF/Image)</label>
                  <input type="file" id="joiningLetterUpload" name="joiningLetterUpload" accept="image/*,application/pdf" />
                </div>
                <div>
                  <label for="medicalDocsUpload">Medical Documents (if applicable)</label>
                  <input type="file" id="medicalDocsUpload" name="medicalDocsUpload" accept="image/*,application/pdf" />
                </div>
              </div>
            </div>

            <button type="submit">Register Student</button>
          </form>
        </div>

        <!-- Original Students & Admin Card -->
        <div class="card">
          <h3>Students</h3>
          <div class="small">Add students (saved to <code>/students</code> in your Realtime Database).</div>

          <div class="form-row">
            <input id="stuName" type="text" placeholder="Full name (e.g. Amina Yusuf)" />
            <input id="stuForm" type="text" placeholder="Form (e.g. Form 2)" style="width:130px" />
            <button id="addStudentBtn">Add</button>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="exportCsvBtn" class="ghost">Export CSV</button>
            <button id="seedBtn" class="ghost">Seed sample</button>
            <button id="clearDbStudentsBtn" class="ghost" title="Danger">Delete DB students</button>
          </div>

          <div class="students-list" id="studentsList" aria-live="polite" style="margin-top:12px">
            <!-- rows filled by JS -->
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Activity / Notes</h3>
          <div class="small">Test helpers: use the seed to populate sample data. To inspect stored data go to Firebase Console → Build → Realtime Database → Data.</div>
        </div>

      </div>

      <!-- Right: Chat -->
      <div>
        <div class="card">
          <h3>Live Chat</h3>
          <div class="small">Messages saved to <code>/messages</code>. Your messages show on the right.</div>

          <div style="margin-top:10px" class="meta-row">
            <input id="myName" type="text" placeholder="Your name (saved locally)" style="width:150px" />
            <div class="tiny" style="margin-left:auto">Status: <span id="status">—</span></div>
          </div>

          <div class="chat-wrapper" style="margin-top:10px">
            <div id="chat" class="chat-box" role="log" aria-live="polite"></div>

            <div class="chat-controls">
              <input id="msgInput" type="text" placeholder="Write a message..." />
              <button id="sendBtn">Send</button>
            </div>
          </div>

          <div style="margin-top:8px" class="small">Tip: press Enter to send. Use the Firebase Console to view raw nodes under <code>/students</code> and <code>/messages</code>.</div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Developer / Debug</h3>
          <div class="small">
            If you see <strong>permission_denied</strong> when trying to write, set Realtime DB rules temporarily to:
            <pre style="background:#f7f7f9;padding:8px;border-radius:6px">{ "rules": { ".read": true, ".write": true } }</pre>
            (Only for testing — secure later.)
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>

  <!-- firebase.js must exist in repo (keeps your real config) -->
  <script src="firebase.js"></script>

  <script>
  /* ======================
     SoMAp — front-end logic (existing)
     Expects firebase.js to define `firebaseConfig`
     ====================== */

  if (!window.firebaseConfig) {
    document.getElementById('status').textContent = 'No firebaseConfig';
    console.error('Missing firebaseConfig. Create firebase.js with your config object.');
    alert('Missing firebase.js (firebaseConfig). Please add your firebase.js file and redeploy.');
  } else {
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    document.getElementById('status').textContent = 'connected';
    initApp(db);
  }

  function initApp(db) {
    // original elements
    const stuName = document.getElementById('stuName');
    const stuForm = document.getElementById('stuForm');
    const addStudentBtn = document.getElementById('addStudentBtn');
    const studentsList = document.getElementById('studentsList');

    const seedBtn = document.getElementById('seedBtn');
    const clearDbStudentsBtn = document.getElementById('clearDbStudentsBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');

    const chatEl = document.getElementById('chat');
    const myName = document.getElementById('myName');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    // preserve name locally
    myName.value = localStorage.getItem('somap_name') || '';
    myName.addEventListener('change', () => {
      localStorage.setItem('somap_name', myName.value.trim());
    });

    // ---- STUDENTS ----
    addStudentBtn.addEventListener('click', () => {
      const name = (stuName.value || '').trim();
      const form = (stuForm.value || '').trim() || 'N/A';
      if (!name) { alert('Enter student name'); return; }
      const payload = { name, form, feesDue: 0, createdAt: Date.now() };
      addStudentBtn.disabled = true;
      db.ref('students').push(payload)
        .then(() => {
          stuName.value = ''; stuForm.value = '';
        })
        .catch(err => alert('Save failed: ' + err.message))
        .finally(() => addStudentBtn.disabled = false);
    });

    // listen students -> render list
    db.ref('students').on('value', snap => {
      studentsList.innerHTML = '';
      const data = snap.val() || {};
      const keys = Object.keys(data);
      if (keys.length === 0) {
        studentsList.innerHTML = '<div class="small">No students yet.</div>';
        return;
      }
      keys.forEach(k => {
        const s = data[k];
        const row = document.createElement('div');
        row.className = 'student-row';
        row.innerHTML = `
          <div>
            <div class="student-meta" style="font-weight:600">${escapeHtml(s.name)}</div>
            <div class="small">${escapeHtml(s.form)} • fees: ${s.feesDue || 0}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="ghost" data-key="${k}" onclick="viewStudent(event)">View</button>
            <button data-key="${k}" onclick="deleteStudent(event)">Delete</button>
          </div>
        `;
        studentsList.appendChild(row);
      });
    });

    window.viewStudent = (e) => {
      const key = e.target.dataset.key;
      db.ref('students/' + key).once('value').then(snap => {
        const s = snap.val();
        alert(`Name: ${s.name}\nForm: ${s.form}\nFees due: ${s.feesDue || 0}`);
      });
    };

    window.deleteStudent = (e) => {
      const key = e.target.dataset.key;
      if (!confirm('Delete this student from DB?')) return;
      db.ref('students/' + key).remove().catch(err => alert('Delete failed: ' + err.message));
    };

    exportCsvBtn.addEventListener('click', () => {
      db.ref('students').once('value').then(snap => {
        const data = snap.val() || {};
        const rows = [['name','form','feesDue','createdAt']];
        Object.values(data).forEach(s => rows.push([s.name || '', s.form || '', s.feesDue || 0, s.createdAt || '']));
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'somap_students.csv'; a.click();
        URL.revokeObjectURL(url);
      });
    });

    seedBtn.addEventListener('click', async () => {
      if (!confirm('Seed sample students?')) return;
      const sample = [
        { name:'Amina Yusuf', form:'Form 2', feesDue:0, createdAt:Date.now() },
        { name:'Peter Kamau', form:'Form 4', feesDue:12000, createdAt:Date.now() },
        { name:'Grace Mwikali', form:'Form 1', feesDue:5000, createdAt:Date.now() }
      ];
      for (const s of sample) {
        await db.ref('students').push(s);
      }
      alert('Sample students added');
    });

    clearDbStudentsBtn.addEventListener('click', () => {
      if (!confirm('Delete ALL students in DB? This is permanent.')) return;
      db.ref('students').remove().then(() => alert('All students removed')).catch(err => alert(err.message));
    });

    // ---- CHAT ----
    function addMessageToUI(msgObj, key) {
      const el = document.createElement('div');
      const name = msgObj.name || 'Anon';
      const text = msgObj.text || '';
      const ts = msgObj.timestamp ? new Date(msgObj.timestamp) : new Date();
      const time = ts.toLocaleString();
      const me = (myName.value || '').trim() && (myName.value || '').trim().toLowerCase() === name.toLowerCase();

      el.className = 'msg' + (me ? ' me' : '');
      el.innerHTML = `<div class="meta"><strong>${escapeHtml(name)}</strong> • <span class="tiny">${escapeHtml(time)}</span></div><div>${escapeHtml(text)}</div>`;
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });

    function sendMessage() {
      const name = (myName.value || '').trim();
      const text = (msgInput.value || '').trim();
      if (!name) { alert('Enter your name'); return; }
      if (!text) return;
      sendBtn.disabled = true;
      const payload = { name, text, timestamp: Date.now() };
      db.ref('messages').push(payload)
        .then(() => { msgInput.value = ''; })
        .catch(err => alert('Send failed: ' + err.message))
        .finally(() => sendBtn.disabled = false);
    }

    db.ref('messages').limitToLast(200).on('child_added', snap => {
      addMessageToUI(snap.val(), snap.key);
    });

    window.clearMessages = () => {
      if (confirm('Delete ALL messages?')) db.ref('messages').remove();
    };

    function escapeHtml(str = '') {
      return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
    }

    // ===== NEW: Handle Registration Form Submit =====
    const registrationForm = document.getElementById('registrationForm');
    registrationForm.addEventListener('submit', e => {
      e.preventDefault();

      // Basic validations (required fields)
      const firstName = registrationForm.firstName.value.trim();
      const lastName = registrationForm.lastName.value.trim();
      const gender = registrationForm.gender.value;
      const dob = registrationForm.dob.value;
      const schoolName = registrationForm.schoolName.value.trim();
      const classLevel = registrationForm.classLevel.value.trim();
      const academicYear = registrationForm.academicYear.value.trim();
      const boardingStatus = registrationForm.boardingStatus.value;
      const primaryParentName = registrationForm.primaryParentName.value.trim();
      const primaryParentContact = registrationForm.primaryParentContact.value.trim();
      const residentialAddress = registrationForm.residentialAddress.value.trim();

      if (!firstName || !lastName || !gender || !dob || !schoolName || !classLevel || !academicYear || !boardingStatus || !primaryParentName || !primaryParentContact || !residentialAddress) {
        alert('Please fill all required fields marked with *');
        return;
      }

      // Auto-generate admission number (example: ADM + timestamp)
      const admissionNumber = 'ADM' + Date.now();
      registrationForm.admissionNumber.value = admissionNumber;

      // Collect data to save
      const studentProfile = {
        basicInfo: {
          firstName,
          middleName: registrationForm.middleName.value.trim(),
          lastName,
          gender,
          dob,
          admissionNumber,
          pupilId: registrationForm.pupilId.value.trim(),
          birthCertNumber: registrationForm.birthCertNumber.value.trim(),
          religion: registrationForm.religion.value.trim(),
          tribe: registrationForm.tribe.value.trim()
        },
        schoolInfo: {
          schoolName,
          classLevel,
          stream: registrationForm.stream.value.trim(),
          academicYear,
          academicTrack: registrationForm.academicTrack.value.trim(),
          boardingStatus,
          shiftedFrom: registrationForm.shiftedFrom.value.trim()
        },
        parentGuardian: {
          primaryParentName,
          primaryParentContact,
          secondaryGuardian: registrationForm.secondaryGuardian.value.trim(),
          relationshipToStudent: registrationForm.relationshipToStudent.value.trim(),
          residentialAddress,
          employmentStatus: registrationForm.employmentStatus.value.trim()
        },
        // Attachments will be handled separately
        attachments: {}
      };

      // TODO: handle file uploads to Firebase Storage or elsewhere - placeholder here
      alert('Student registered successfully (frontend only). Implement file upload and save to Firebase DB/storage as needed.');

      // Clear form
      registrationForm.reset();
      registrationForm.admissionNumber.value = '';
    });
  }
  </script>
</body>
</html>
