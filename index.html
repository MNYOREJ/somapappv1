<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Firebase SDKs (compat used to match your existing code) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <title>SoMAp - Index (fixed)</title>

  <style>
    /* === (Your original styles were preserved, only minor additions) === */
    /* ... (omitted here for brevity in the canvas preview) */

    /* I kept your original CSS but added a few small helpers to improve mobile form layout */
    :root{--primary:#4f46e5}
    body{font-family:Inter,system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#007bff,#6610f2);color:#fff;min-height:100vh}
    .hidden{display:none}
    .card{border-radius:0.75rem;background:linear-gradient(135deg,#ffffff,#e5e7eb);color:#000}
    .btn-google{display:flex;align-items:center;justify-content:center;background:white;border:1px solid #dadce0;border-radius:10px;padding:12px 18px;font-weight:700;color:#3c4043}
    /* Parent form beautify (keeps your look but a bit nicer) */
    .parent-form .form-control-custom{padding:12px;border-radius:10px;border:2px solid #ced4da;width:100%}
    .parent-form label{font-weight:600;color:#111}
    .parent-sign-btn{background:linear-gradient(135deg,#198754,#20c997);color:#fff;border-radius:10px;padding:12px;font-weight:700;width:100%;border:none}
    .error{color:#d93025;font-size:0.95rem;margin-top:0.5rem}

  </style>
</head>
<body>
  <div class="flex h-screen overflow-hidden">
    <div class="workspace flex-1 min-w-0 overflow-x-hidden overflow-y-auto bg-gradient-to-br from-blue-500 to-purple-600 transition-all p-6">

      <header class="bg-white shadow-sm rounded mb-6">
        <div class="flex items-center justify-between px-6 py-3">
          <div>
            <h1 id="page-title" class="text-xl font-semibold text-gray-800">SoMAp - SOCIETY MANAGEMENT APP</h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="relative">
              <input type="text" class="px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500 w-64" placeholder="Search...">
              <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            </div>
            <button class="p-2 rounded-lg hover:bg-gray-100">
              <i class="far fa-bell text-gray-500 relative"><span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">3</span></i>
            </button>
            <button id="sign-out" class="p-2 rounded-lg hover:bg-gray-100 hidden">
              <i class="fas fa-sign-out-alt text-gray-500"></i>
            </button>
          </div>
        </div>
      </header>

      <!-- Welcome Page (unchanged content/text) -->
      <div id="welcome-page" class="container section-padding">
        <div class="welcome-note">
          <h1 id="welcome-title">Welcome to SoMAp - The Best School Management System</h1>
          <p id="welcome-text">Transform your school with our integrated SuperApp. Manage academics, finances, attendance, and more effortlessly. Connect parents, boost performance, and explore SoMAp Market for uniforms, supplies, and essentials. Inspired by top systems for excellence in Tanzania's education.</p>
          <select id="language-select" class="form-select form-control-custom">
            <option value="en">English</option>
            <option value="sw">Swahili</option>
          </select>
          <button id="get-started" class="btn btn-lg btn-custom quick-action-btn mt-4">Get Started</button>
        </div>

        <!-- <omitted the rest of welcome cards - preserved in your original file> -->
        <section class="section-padding text-center mt-8">
          <h2>Ready to Transform Your School Management?</h2>
          <p>Join hundreds of Tanzanian schools already using SoMAp to streamline their operations</p>
          <button id="start-trial" class="btn btn-lg btn-custom quick-action-btn mt-4">Start Your Free Trial</button>
        </section>

      </div>

      <!-- Login Page -->
      <div id="login-page" class="container section-padding hidden">
        <div class="card p-4">
          <h2 class="text-center">Sign In to SoMAp</h2>

          <!-- Staff Sign-In -->
          <div class="mb-4">
            <h3 class="text-lg font-semibold">Staff Sign-In</h3>
            <p class="text-center text-gray-600 mb-3">Use your school Google account</p>

            <!-- reCAPTCHA may not render in some environments; we *gracefully* allow sign-in if grecaptcha is not available -->
            <div id="recaptcha-wrapper" class="mb-3">
              <div class="g-recaptcha" data-sitekey="6LekDsorAAAAAOkhrg-3PKJCHEpBN1HYQQzca83x"></div>
            </div>

            <button id="google-signin" class="btn-google">
              <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" style="height:20px;margin-right:8px" />
              Sign in with Google
            </button>
          </div>

          <hr class="my-4">

          <!-- Parent Sign-In (improved matching & validation) -->
          <div>
            <h3 class="text-lg font-semibold">Parent Sign-In</h3>
            <p class="text-center text-gray-600 mb-3">Use your child's full name and phone number</p>

            <form id="parent-signin" class="parent-form">
              <div class="mb-3">
                <label for="child-name" class="form-label">Child's Full Name</label>
                <input type="text" class="form-control form-control-custom" id="child-name" placeholder="e.g., Mnyore Joseph Omondi" required>
                <small class="text-sm text-gray-600">Enter any two names (order and case don't matter).</small>
              </div>

              <div class="mb-3">
                <label for="parent-phone" class="form-label">Parent Phone Number</label>
                <input type="tel" class="form-control form-control-custom" id="parent-phone" placeholder="e.g., +255123456789" required>
                <small class="text-sm text-gray-600">Include country code +254, +255 etc. No leading zero after country code.</small>
              </div>

              <button type="submit" class="parent-sign-btn">Sign In as Parent</button>
            </form>

            <div id="error-message" class="error hidden text-center mt-3"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // === Firebase config (kept as you provided) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Translations (unchanged)
    const translations = { en: { welcomeTitle: "Welcome to SoMAp - The Best School Management System", welcomeText: "Transform your school with our integrated SuperApp. Manage academics, finances, attendance, and more effortlessly. Connect parents, boost performance, and explore SoMAp Market for uniforms, supplies, and essentials. Inspired by top systems for excellence in Tanzania's education.", getStarted: "Get Started" }, sw: { welcomeTitle: "Karibu kwa SoMAp - Mfumo Bora wa Usimamizi wa Shule", welcomeText: "Badilisha shule yako na SuperApp yetu iliyounganishwa. Simamia masomo, fedha, mahudhurio, na zaidi kwa urahisi. Unganisha wazazi, ongeza utendaji, na chunguza SoMAp Market kwa uniformu, vifaa, na mahitaji. Imechochewa na mifumo ya juu kwa ubora katika elimu ya Tanzania.", getStarted: "Anza" } };

    // Helpers: normalize phone and name
    function normalizePhone(p) {
      if (!p) return '';
      let s = String(p).trim();
      // Remove spaces, parentheses, dashes
      s = s.replace(/[\s\-()]/g, '');
      // If it starts with 0 but no + and length looks local, do nothing; we require +country for parent
      if (!s.startsWith('+')) {
        // try to convert common local form like 0712345678 => +254712345678 (Kenya) - *DO NOT GUESS COUNTRY*.
        // We will NOT auto-insert country code. Require user to provide +country.
        return s;
      }
      return s;
    }

    function normalizeName(n) {
      if (!n) return '';
      // Lowercase, remove extra spaces, replace multiple spaces by single, keep letters and numbers.
      return n.trim().toLowerCase().replace(/\s+/g, ' ');
    }

    function nameHasAtLeastTwoWords(n){
      return normalizeName(n).split(' ').filter(Boolean).length >= 2;
    }

    function showError(msg){
      const el = document.getElementById('error-message');
      el.textContent = msg;
      el.classList.remove('hidden');
    }
    function clearError(){
      const el = document.getElementById('error-message');
      el.textContent = '';
      el.classList.add('hidden');
    }

    // Language select
    document.getElementById('language-select').addEventListener('change', (e) => {
      const lang = e.target.value;
      document.getElementById('welcome-title').textContent = translations[lang].welcomeTitle;
      document.getElementById('welcome-text').textContent = translations[lang].welcomeText;
      document.getElementById('get-started').textContent = translations[lang].getStarted;
    });

    // Get Started / Start Trial buttons
    function openLogin(){
      document.getElementById('welcome-page').classList.add('hidden');
      document.getElementById('login-page').classList.remove('hidden');
      document.getElementById('sign-out').classList.remove('hidden');
    }
    document.getElementById('get-started').addEventListener('click', openLogin);
    document.getElementById('start-trial').addEventListener('click', openLogin);

    // Sign-out
    document.getElementById('sign-out').addEventListener('click', () => {
      auth.signOut().then(() => {
        localStorage.removeItem('role');
        localStorage.removeItem('class');
        localStorage.removeItem('studentId');
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('welcome-page').classList.remove('hidden');
        document.getElementById('sign-out').classList.add('hidden');
        Swal.fire('Success', 'You have been signed out.', 'success');
      }).catch(err => Swal.fire('Error', 'Sign-out failed: ' + err.message, 'error'));
    });

    // STAFF SIGN-IN (Google)
    document.getElementById('google-signin').addEventListener('click', async () => {
      clearError();
      // If reCAPTCHA is present, require it; but if grecaptcha isn't available (some mobile browsers), don't block.
      const gre = window.grecaptcha;
      try{
        if (gre && typeof gre.getResponse === 'function'){
          const response = gre.getResponse();
          if (!response) { showError('Please complete the CAPTCHA'); return; }
        }
      }catch(e){ /* ignore captcha runtime errors and proceed */ }

      const provider = new firebase.auth.GoogleAuthProvider();

      // First try popup (desktop). On popup failure (blocked on mobile), fallback to redirect.
      try{
        const result = await auth.signInWithPopup(provider);
        await handleUserRedirect(result.user);
      }catch(err){
        // If popup blocked or not allowed, use redirect as a fallback
        if (err.code && (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user' || err.code === 'auth/operation-not-supported-in-this-environment')){
          try{
            await auth.signInWithRedirect(provider);
            // After redirect completes, onAuthStateChanged will handle the rest
          }catch(innerErr){
            showError('Google sign-in failed: ' + innerErr.message);
          }
        } else {
          showError('Sign-in failed: ' + err.message);
        }
      }
    });

    // Helper after Google sign in to redirect based on role
    async function handleUserRedirect(user){
      if (!user || !user.email) return;
      const safeKey = user.email.replace(/\./g, '_');
      try{
        const snap = await db.ref('users/' + safeKey).once('value');
        const userData = snap.val();
        if (!userData){
          showError('Unauthorized email. Contact admin.');
          await auth.signOut();
          return;
        }
        localStorage.setItem('role', userData.role);
        localStorage.setItem('class', userData.class || '');
        // Redirect according to role
        if (userData.role === 'accountant') window.location.href = 'mhasibu.html';
        else if (userData.role === 'teacher') window.location.href = 'staff.html';
        else if (userData.role === 'admin') window.location.href = 'dashboard.html';
        else {
          // default
          window.location.href = 'dashboard.html';
        }
      }catch(err){ showError('Sign-in failed: ' + err.message); }
    }

    // PARENT SIGN-IN (robust matching + phone validation)
    document.getElementById('parent-signin').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError();

      const childNameRaw = document.getElementById('child-name').value || '';
      const phoneRaw = document.getElementById('parent-phone').value || '';

      const childName = normalizeName(childNameRaw);
      const phone = normalizePhone(phoneRaw);

      if (!nameHasAtLeastTwoWords(childName)){
        showError('Please enter at least two names of the child (e.g., "Mnyore Joseph").');
        return;
      }
      if (!phone.startsWith('+') || phone.length < 9){
        showError('Please include the country code and use the format +254..., +255...');
        return;
      }

      try{
        // Read students from DB (snapshot once) - optimized by your structure
        const snap = await db.ref('students').once('value');
        const studentsObj = snap.val() || {};

        // We'll iterate through students and try to match phone and name with flexible rules
        let matchedStudent = null;

        const inputTokens = childName.split(' ').filter(Boolean);

        for (const key of Object.keys(studentsObj)){
          const s = studentsObj[key];
          // normalize stored names and phone
          const storedFull = ( (s.firstName || '') + ' ' + (s.middleName || '') + ' ' + (s.lastName || '') ).replace(/\s+/g,' ').trim();
          const storedNorm = normalizeName(storedFull);

          const storedPhone = normalizePhone(s.primaryParentContact || s.parentPhone || '');

          // PHONE MUST MATCH exactly after normalization
          if (!storedPhone) continue;
          if (storedPhone !== phone) continue;

          // Now check name: require that input contains at least two tokens that are present in stored name tokens (order-insensitive)
          const storedTokens = storedNorm.split(' ').filter(Boolean);
          let common = 0;
          for (const t of inputTokens){ if (storedTokens.includes(t)) common++; }

          if (common >= 2){ matchedStudent = s; break; }

          // Extra: also accept if input equals stored normalized full name (exact match)
          if (inputTokens.join(' ') === storedTokens.join(' ')) { matchedStudent = s; break; }
        }

        if (matchedStudent){
          localStorage.setItem('role', 'parent');
          localStorage.setItem('studentId', matchedStudent.admissionNumber || matchedStudent.id || matchedStudent.adm || '');
          // Redirect to parent dashboard
          window.location.href = 'parent.html';
        } else {
          showError('Invalid child name or phone number. Make sure the phone uses +countrycode and the child name has two names.');
        }

      }catch(err){ showError('Sign-in failed: ' + err.message); }
    });

    // Auth state change - robust and prevents flashing
    let initialAuthProcessed = false;
    auth.onAuthStateChanged(async (user) => {
      try{
        if (user){
          // When user is signed in, try to find role in DB and redirect only once
          const safeKey = user.email.replace(/\./g, '_');
          const snap = await db.ref('users/' + safeKey).once('value');
          const userData = snap.val();
          if (userData){
            localStorage.setItem('role', userData.role);
            localStorage.setItem('class', userData.class || '');
            document.getElementById('sign-out').classList.remove('hidden');
            // Redirect according to role
            if (!initialAuthProcessed){
              initialAuthProcessed = true;
              if (userData.role === 'accountant') window.location.href = 'mhasibu.html';
              else if (userData.role === 'teacher') window.location.href = 'staff.html';
              else if (userData.role === 'admin') window.location.href = 'dashboard.html';
            }
          } else {
            // Not in users list - keep them on login page but signed in (show message)
            document.getElementById('welcome-page').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('sign-out').classList.remove('hidden');
            showError('Your Google account is not registered with SoMAp. Contact admin.');
          }
        } else {
          // Not signed in: show welcome page only if we are NOT already on login
          if (!initialAuthProcessed){
            document.getElementById('welcome-page').classList.remove('hidden');
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('sign-out').classList.add('hidden');
          }
        }
      }catch(err){ console.error('onAuthState error', err); }
    });

    // Small UX: clear error when user types
    document.getElementById('child-name').addEventListener('input', clearError);
    document.getElementById('parent-phone').addEventListener('input', clearError);

    // End of script
  </script>
</body>
</html>
