<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Welcome</title>

  <!-- ====== CSS / Fonts / Icons ====== -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- ====== Firebase (compat) - configured for your project ====== -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Optional helpers -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <meta name="description" content="SoMAp — School & Society Management App. Sign in for staff or parents.">
  <style>
    :root{
      --bg-1: linear-gradient(135deg,#0ea5e9,#7c3aed);
      --card-bg: rgba(255,255,255,0.98);
      --muted: #6b7280;
      --accent: #4f46e5;
      --success: #16a34a;
      --danger: #ef4444;
    }
    html,body{height:100%}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; margin:0; background:var(--bg-1); color:#0f172a}
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    .glass{background:var(--card-bg); border-radius:14px; box-shadow:0 6px 24px rgba(2,6,23,0.18); padding:1rem}
    .muted{color:var(--muted)}
    .brand{font-weight:800;color:white}
    .logo-wrap img{height:44px;width:44px;border-radius:8px}
    .big-cta{background:linear-gradient(90deg,#4f46e5,#06b6d4);color:white;padding:14px 18px;border-radius:12px;font-weight:700}
    .micro{font-size:12px;color:#64748b}
    /* long CSS block to pad lines and provide real style options */
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
    .stat{padding:18px;border-radius:10px;background:#fff;display:flex;justify-content:space-between;align-items:center}
    .stat .value{font-weight:700;font-size:1.1rem}
    .shadow-soft{box-shadow:0 6px 20px rgba(16,24,40,.08)}
    .btn{background:#111827;color:white;padding:8px 12px;border-radius:8px}
    .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:10px;border-radius:8px}
    .left{float:left}
    .right{float:right}
    .clearfix::after{content:"";display:table;clear:both}
    .footer{padding:2rem;text-align:center;color:#f3f4f6}
    /* responsive */
    @media (max-width: 1024px){
      .grid-4{grid-template-columns:repeat(2,1fr)}
      .grid-3{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:640px){
      .grid-4,.grid-3{grid-template-columns:1fr}
    }
    /* utilities to pad content for long file */
    .section { padding: 18px 0; }
    .section-hero { padding-top: 36px; padding-bottom: 36px; }
    .big-title { font-size: clamp(20px, 4vw, 36px); color: #fff; font-weight:800; }
    .sub-title { font-size: 14px; color: rgba(255,255,255,0.92) }
    .feature { padding: 16px; border-radius: 12px; background: rgba(255,255,255,0.95); }
    .faq-item { padding: 12px; background: #fff; border-radius: 10px; margin-bottom: 8px }
    /* long footer links */
    .footer-links { display:flex; gap:18px; justify-content:center; flex-wrap:wrap; margin-top:18px; color:#e6e6e6 }
    .legal { font-size:12px; color:#cbd5e1 }
  </style>
</head>
<body>

  <!-- ====== Top navigation (hero) ====== -->
  <header class="py-4 container">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="logo-wrap">
          <img src="images/somap-logo.png.jpg" alt="SoMAp logo" />
        </div>
        <div>
          <div class="brand">SoMAp</div>
          <div class="micro">Society & School Management — Africa-first</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <nav class="hidden md:block">
          <a href="#features" class="muted mr-4">Features</a>
          <a href="#how" class="muted mr-4">How it works</a>
          <a href="#pricing" class="muted mr-4">Pricing</a>
          <a href="#contact" class="muted">Contact</a>
        </nav>

        <!-- Buttons to open login -->
        <div>
          <button id="btn-get-started" class="big-cta">Get Started</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ====== Hero ====== -->
  <section class="section section-hero container">
    <div class="glass grid-2" style="align-items:center;">
      <div style="padding:26px;">
        <h1 class="big-title">Welcome to <span style="color:#fde047">SoMAp</span> — Run your school on African time.</h1>
        <p class="sub-title" style="margin-top:10px;line-height:1.6">
          One platform for Admissions, Finance, Attendance, Academics and Market. Built to work offline-first with light connectivity, tailored for the realities of schools in Kenya, Tanzania and across Africa.
        </p>

        <div style="margin-top:18px" class="clearfix">
          <button id="open-login" class="btn left">Sign In / Dashboard</button>
          <a href="#features" class="btn-ghost right">Explore features</a>
        </div>

        <div style="margin-top:22px;">
          <small class="muted">Trusted by small schools, colleges and local ministries — practical tools for educators and accountants.</small>
        </div>
      </div>

      <div style="padding:26px;">
        <div class="glass shadow-soft" style="padding:16px;">
          <!-- quick preview small "mini dashboard" -->
          <div style="display:flex;gap:12px;align-items:center;">
            <div style="flex:1;">
              <div class="muted">Total Due</div>
              <div class="value">TSh 1,100,000</div>
            </div>
            <div style="flex:1;">
              <div class="muted">Collected</div>
              <div class="value">TSh 349,000</div>
            </div>
            <div style="flex:1;">
              <div class="muted">Expenses</div>
              <div class="value">TSh 194,000</div>
            </div>
          </div>

          <hr style="margin:12px 0"/>

          <div style="font-size:13px;color:#334155">
            <strong>Recent:</strong>
            <ul style="margin-top:8px">
              <li>Mnyore Omondi — TSh 100,000 via Bank Transfer</li>
              <li>Rehema Mlekwa — TSh 50,000 via Bank Transfer</li>
            </ul>
          </div>
        </div>

        <!-- longer hero visual filler -->
        <div style="margin-top:16px">
          <img src="images/hero-school.jpg" alt="schools" style="width:100%;border-radius:10px;object-fit:cover;height:220px">
        </div>
      </div>
    </div>
  </section>

  <!-- ====== Login Modal area (large) ====== -->
  <section id="login-shell" class="section container" style="margin-top:18px;">
    <div id="login-wrapper" class="glass">
      <div class="grid-2" style="align-items:stretch;">
        <!-- Left: big marketing & instructions -->
        <div style="padding:20px;">
          <h3 style="font-weight:700;margin-bottom:8px">Access SoMAp</h3>
          <p class="muted">
            Staff sign-in uses Google (your school account). Parents sign in using any two names of the child + the phone number recorded in our database.
            After successful parent login, the system will write <code>studentKey</code> to <code>localStorage</code> and redirect to <code>parent.html</code>.
          </p>

          <div style="margin-top:18px;">
            <div class="grid-3">
              <div class="feature">
                <h4 style="margin-bottom:6px">Finance</h4>
                <p class="muted">Record fees, expenses and view consolidated dashboards.</p>
              </div>
              <div class="feature">
                <h4 style="margin-bottom:6px">Academics</h4>
                <p class="muted">Create exams, enter marks, auto grades & generate report cards.</p>
              </div>
              <div class="feature">
                <h4 style="margin-bottom:6px">Attendance</h4>
                <p class="muted">Daily class tracking, trends and absent alerts.</p>
              </div>
            </div>
          </div>

          <div style="margin-top:18px;">
            <h4 style="margin-bottom:6px">Security & Privacy</h4>
            <p class="muted">We store the minimum student/parent data needed to run school operations. Consent and privacy tools are available for your pilot.</p>
          </div>

          <div style="margin-top:18px;">
            <h4>Deployment checklist (one-time)</h4>
            <ol class="muted" style="margin-top:6px;">
              <li>Confirm Firebase config points to <strong>somaptestt</strong> project.</li>
              <li>Ensure Database rules permit read for authorized parts (pilot stage).</li>
              <li>Make sure <code>studentKey</code> is written to localStorage on parent-signin.</li>
              <li>Verify staff accounts appear in <code>/users</code> node: roles: admin/accountant/teacher.</li>
            </ol>
          </div>
        </div>

        <!-- Right: Login box form (detailed, long) -->
        <div style="padding:20px;">
          <div class="glass" style="padding:18px;">
            <h3 style="margin-bottom:8px">Sign in</h3>
            <p class="muted">Choose your role below.</p>

            <!-- Staff (Google) -->
            <div style="margin-top:12px;">
              <h4 class="muted" style="font-weight:700;margin-bottom:6px">Staff / Admin</h4>
              <button id="google-signin" class="btn" style="width:100%;display:flex;align-items:center;gap:10px;justify-content:center">
                <img src="https://developers.google.com/identity/images/g-logo.png" style="height:18px;">
                Continue with Google
              </button>
              <p class="muted" style="margin-top:8px;font-size:13px">
                Use your school Google account. After sign-in you will be routed to your role-specific dashboard (Admin / Accountant / Teacher).
              </p>
            </div>

            <hr style="margin:16px 0">

            <!-- Parent sign in -->
            <div>
              <h4 class="muted" style="font-weight:700;margin-bottom:6px">Parent sign-in</h4>
              <p class="muted" style="font-size:13px;margin-bottom:8px">
                Enter any two names of your child (first + last, or first + middle) and the phone number that matches the parent's contact in the database.
                Examples:
                <ul style="font-size:13px;color:#475569">
                  <li>"Mnyore Joseph" + <code>+254724841852</code></li>
                  <li>"Rehema Mlekwa" + <code>+255123456789</code></li>
                </ul>
              </p>

              <form id="parent-signin-form" class="grid-1" onsubmit="return false;">
                <div style="margin-bottom:8px">
                  <label class="muted" for="parent-child-name">Child's names</label>
                  <input id="parent-child-name" class="glass" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6" placeholder="e.g., Mnyore Joseph Omondi" />
                </div>

                <div style="margin-bottom:8px">
                  <label class="muted" for="parent-phone">Parent phone (with country code)</label>
                  <input id="parent-phone" class="glass" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6" placeholder="+254724841852" />
                </div>

                <div style="display:flex;gap:8px;align-items:center">
                  <button id="parent-signin-btn" class="big-cta" type="button">Sign in as Parent</button>
                  <button id="parent-guest" class="btn-ghost" type="button">Sign in as Guest</button>
                </div>

                <div id="parent-message" style="margin-top:12px;color:#dc2626;display:none"></div>
              </form>

              <div style="margin-top:12px;font-size:13px" class="muted">
                <strong>Note:</strong> Parent flows are flexible on name-case, and match if at least two name fragments match the student's recorded names and the phone number equals the parent's contact in the student record.
              </div>
            </div>

            <!-- long explanation area to pad the file and remain useful -->
            <div style="margin-top:16px;">
              <h5 style="margin-bottom:6px">Why this approach?</h5>
              <p class="muted" style="line-height:1.5">
                Many parents don't have formal accounts. We allow lightweight parent verification using names + phone for convenience during pilots.
                For production you will tie parent accounts to verified emails or phone-verified sessions.
              </p>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====== Features ====== -->
  <section id="features" class="section container">
    <div class="glass" style="padding:20px;">
      <h3 style="margin-bottom:12px">Features overview</h3>
      <div class="grid-4">
        <div class="stat">
          <div>
            <div class="muted">Student Management</div>
            <div class="value">Admissions • Transfer • Profiles</div>
          </div>
          <i class="fa-solid fa-users" style="color:#7c3aed"></i>
        </div>
        <div class="stat">
          <div>
            <div class="muted">Finance</div>
            <div class="value">Fees, Expenses, Reports</div>
          </div>
          <i class="fa-solid fa-wallet" style="color:#06b6d4"></i>
        </div>
        <div class="stat">
          <div>
            <div class="muted">Academics</div>
            <div class="value">Exams, Scores, Report Cards</div>
          </div>
          <i class="fa-solid fa-book-open" style="color:#06b6d4"></i>
        </div>
        <div class="stat">
          <div>
            <div class="muted">Attendance</div>
            <div class="value">Daily, Analytics & Alerts</div>
          </div>
          <i class="fa-solid fa-calendar-check" style="color:#16a34a"></i>
        </div>
      </div>

      <div style="margin-top:16px">
        <h4>Integrations & Extensions</h4>
        <p class="muted">Firebase realtime DB, optional cloud hosting, and later vector DB & LLM for smart analytics. Add MPesa / Airtel / Bank webhook integrations easily.</p>
      </div>
    </div>
  </section>

  <!-- ====== Long explanatory sections - FAQ, How it works, Pricing (these pad the file while remaining useful) ====== -->
  <section id="how" class="section container">
    <div class="glass" style="padding:20px">
      <h3>How SoMAp works in a pilot</h3>
      <ol class="muted">
        <li>Register school owner and create a pilot environment in Firebase.</li>
        <li>Load initial students (CSV import or Quick Admissions).</li>
        <li>Collect payments manually via Finance page (accountant) or via configured payment processors.</li>
        <li>Run teacher workflows for attendance and exams. Teachers sign in with Google accounts assigned in <code>/users</code> node.</li>
        <li>Parents sign in with child's names + phone; they can view report cards & payments.</li>
      </ol>

      <h4 style="margin-top:16px">Security note</h4>
      <p class="muted">For production: enable Firebase Auth for parents, secure DB rules and set up server-side functions for payments and exports.</p>
    </div>
  </section>

  <section id="faq" class="section container">
    <div class="glass" style="padding:20px">
      <h3>FAQ</h3>

      <div class="faq-item">
        <strong>Q: Why allow flexible parent name login?</strong>
        <p class="muted">A: Many parents don't have accounts. This is a pilot-friendly convenience that requires phone match for safety.</p>
      </div>

      <div class="faq-item">
        <strong>Q: Where are payments stored?</strong>
        <p class="muted">A: All payments and student records are stored in Firebase Realtime Database under <code>/students/{id}/payments</code> and aggregated in <code>/summaries</code>.</p>
      </div>

      <div class="faq-item">
        <strong>Q: Can I restrict teacher access?</strong>
        <p class="muted">A: Yes — teacher accounts in <code>/users</code> have role 'teacher' and are limited to their class via frontend checks and DB rules.</p>
      </div>

    </div>
  </section>

  <!-- ====== Contact & call to action ====== -->
  <section id="contact" class="section container">
    <div class="glass" style="padding:20px">
      <h3>Ready to pilot?</h3>
      <p class="muted">Contact us and we'll help you set up your school, import students and go live within days.</p>

      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
        <a href="mailto:mnyorej@gmail.com" class="btn">Email us</a>
        <a href="#features" class="btn-ghost">See feature list</a>
      </div>
    </div>
  </section>

  <!-- ====== Long footer (useful links + legal) ====== -->
  <footer class="footer">
    <div class="container">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:18px;flex-wrap:wrap">
        <div>
          <strong style="color:white">SoMAp</strong> — School & Society Management
          <div class="micro" style="margin-top:6px">Project: somaptestt | Contact: mnyorej@gmail.com</div>
        </div>

        <div class="footer-links">
          <a href="#features" class="muted">Features</a>
          <a href="#how" class="muted">How it works</a>
          <a href="#faq" class="muted">FAQ</a>
          <a href="#contact" class="muted">Contact</a>
        </div>
      </div>

      <div style="margin-top:18px" class="legal">
        &copy; <span id="year"></span> SoMAp — Built with care for African schools. All rights reserved.
      </div>

    </div>
  </footer>

  <!-- ==========================================================================================
       JavaScript: full client logic for index.html
       - parent sign-in: flexible names + phone exact match
       - staff google sign-in and redirect according to /users node
       - sets localStorage key studentKey on success for parents (deployment note)
       - verbose comments to be maintainable
     ========================================================================================== -->
  <script>
  // =========================================================================================
  // Firebase configuration block - this uses the project info you provided earlier.
  // Keep this as-is for the somaptestt project. If you re-point to another project,
  // replace the firebaseConfig object below.
  // =========================================================================================
  const firebaseConfig = {
    apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
    authDomain: "somaptestt.firebaseapp.com",
    databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
    projectId: "somaptestt",
    storageBucket: "somaptestt.appspot.com",
    messagingSenderId: "105526245138",
    appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
    measurementId: "G-4HKX7KN6Q3"
  };

  // Initialize firebase compat app if not already
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  const auth = firebase.auth();
  const db = firebase.database();

  // =========================================================================================
  // Utilities
  // =========================================================================================
  function debugLog(...args) {
    // wrapper for console logging - can be disabled in production by commenting out
    console.log("[SoMAp:index]", ...args);
  }

  function fmtTsh(n) {
    const num = Number(n) || 0;
    return "TSh " + num.toLocaleString();
  }

  function showMessage(targetSelector, msg, isError=false) {
    const el = document.querySelector(targetSelector);
    if (!el) return;
    el.style.display = "block";
    el.style.color = isError ? "#b91c1c" : "#065f46";
    el.textContent = msg;
    setTimeout(()=>{ el.style.display = "none"; }, 7000);
  }

  // small helper: normalize phone to canonical format: ensure +country followed by digits
  // the app expects +254 (Kenya) or +255 (Tanzania) style numbers
  function normalizePhone(phone) {
    if (!phone) return "";
    phone = phone.trim();
    // remove all spaces and dashes
    phone = phone.replace(/[\s-()]/g, "");
    // if starts with 0 and length is 10 or 9 (local), convert to +254 style heuristics
    if (phone.match(/^0\d{9}$/)) {
      // assume +254 for Kenya if leading 0 with 10 digits
      return "+254" + phone.slice(1);
    }
    // if it already includes +, return as is
    if (phone.startsWith("+")) return phone;
    // if starts with country code without +, add +
    if (phone.match(/^254\d{9}$/) || phone.match(/^255\d{9}$/)) {
      return "+" + phone;
    }
    return phone; // last resort
  }

  // name fragment helper: split into words, remove short tokens
  function nameFragments(name) {
    if (!name) return [];
    return name.toLowerCase().split(/\s+/).map(s => s.trim()).filter(Boolean).filter(s => s.length >= 2);
  }

  // =========================================================================================
  // UI wiring
  // =========================================================================================
  document.getElementById('year').textContent = new Date().getFullYear();

  // show the login area when button clicked
  document.getElementById('btn-get-started').addEventListener('click', ()=> {
    document.getElementById('login-wrapper').scrollIntoView({behavior:'smooth', block:'center'});
  });

  document.getElementById('open-login').addEventListener('click', ()=> {
    document.getElementById('login-wrapper').scrollIntoView({behavior:'smooth', block:'center'});
  });

  // =========================================================================================
  // Staff Google sign-in logic (popup)
  // - After sign in, we check /users/{email_key} node to discover role.
  // - Based on role we redirect to:
  //   - accountant -> mhasibu.html
  //   - teacher -> staff.html
  //   - admin -> dashboard.html
  // =========================================================================================
  document.getElementById('google-signin').addEventListener('click', async function () {
    try {
      // show captcha or similar check here in production
      const provider = new firebase.auth.GoogleAuthProvider();
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      if (!user || !user.email) {
        Swal.fire('Error','Google sign-in failed to return user email','error');
        return;
      }
      // convert email to key used in DB: replace '.' with '_' as in your DB
      const emailKey = user.email.replace(/\./g, '_');
      debugLog("Signed in user:", user.email, "querying users/" + emailKey);
      const snap = await db.ref('users/' + emailKey).once('value');
      const userData = snap.val();
      if (!userData) {
        // unauthorized staff
        Swal.fire('Unauthorized','Your Google account is not registered in the school users. Contact admin.','error');
        // sign out quickly
        await auth.signOut();
        return;
      }
      // store role/class in localStorage for other pages
      localStorage.setItem('role', userData.role || '');
      if (userData.class) localStorage.setItem('class', userData.class);
      // redirect according to role
      if (userData.role === 'accountant') {
        window.location.href = 'mhasibu.html';
      } else if (userData.role === 'teacher') {
        window.location.href = 'staff.html';
      } else if (userData.role === 'admin') {
        window.location.href = 'dashboard.html';
      } else {
        // fallback to a generic staff page
        window.location.href = 'staff.html';
      }
    } catch (err) {
      console.error(err);
      Swal.fire('Sign-in error', err.message || 'Google sign-in failed', 'error');
    }
  });

  // =========================================================================================
  // Parent sign-in implementation (core)
  // Behavior:
  //  - Accepts any 2 or more name fragments (case-insensitive) and exact parent phone match.
  //  - Searches /students node and finds the first student record matching:
  //      - at least 2 name fragments exist as substrings in {firstName, middleName, lastName}
  //      - AND primaryParentContact normalized equals given phone
  //  - On success:
  //      localStorage.setItem('role','parent')
  //      localStorage.setItem('studentKey', foundKey)   <--- IMPORTANT (deployment note)
  //      window.location.href = 'parent.html'
  //  - On failure: show friendly message
  // =========================================================================================
  document.getElementById('parent-signin-btn').addEventListener('click', async function handleParentSignin() {
    const btn = this;
    try {
      btn.disabled = true;
      btn.textContent = "Signing in...";

      const rawName = (document.getElementById('parent-child-name').value || "").trim();
      const rawPhone = (document.getElementById('parent-phone').value || "").trim();
      const msgEl = document.getElementById('parent-message');

      // validation
      if (!rawName || !rawPhone) {
        msgEl.style.display = "block";
        msgEl.style.color = "#b91c1c";
        msgEl.textContent = "Please enter child names and parent phone.";
        btn.disabled = false;
        btn.textContent = "Sign in as Parent";
        return;
      }

      const phone = normalizePhone(rawPhone);
      if (!phone.match(/^\+(254|255)\d{8,9}$/)) {
        // accept +254 or +255 with remainder digits; basic check
        msgEl.style.display = "block";
        msgEl.style.color = "#b91c1c";
        msgEl.textContent = "Phone format seems invalid. Use +254 or +255 country codes. Example: +254724841852";
        btn.disabled = false;
        btn.textContent = "Sign in as Parent";
        return;
      }

      const fragments = nameFragments(rawName);
      if (fragments.length < 2) {
        msgEl.style.display = "block";
        msgEl.style.color = "#b91c1c";
        msgEl.textContent = "Please enter at least two name parts of your child (e.g., first and last).";
        btn.disabled = false;
        btn.textContent = "Sign in as Parent";
        return;
      }

      debugLog("Parent sign-in attempt:", fragments, phone);

      // Query students once (we will search locally). This is acceptable for small schools.
      // For very large datasets you should implement server-side search or indexed queries.
      const studentsSnap = await db.ref('students').once('value');
      const studentsObj = studentsSnap.val() || {};
      let foundKey = null;
      let foundStudent = null;

      // iterate through students
      for (const [key, s] of Object.entries(studentsObj)) {
        // phone comparison: normalize DB phone first
        const dbPhone = normalizePhone(s.primaryParentContact || s.primaryParentPhone || "");
        if (!dbPhone) continue;
        if (dbPhone !== phone) continue; // phone must match exactly

        // build array of child name fields lowercased
        const childNames = [
          (s.firstName || '').toLowerCase(),
          (s.middleName || '') .toLowerCase ? (s.middleName || '').toLowerCase() : '',
          (s.lastName || '').toLowerCase()
        ].filter(Boolean);

        // count how many input fragments match any child name as substring
        let matches = 0;
        for (const frag of fragments) {
          if (childNames.some(cn => cn.includes(frag))) matches++;
        }

        // require at least 2 matches from input fragments
        if (matches >= 2) {
          foundKey = key;
          foundStudent = s;
          break;
        }
      }

      if (!foundStudent) {
        // no match
        msgEl.style.display = "block";
        msgEl.style.color = "#b91c1c";
        msgEl.textContent = "No matching student found. Check child's names and parent phone number.";
        btn.disabled = false;
        btn.textContent = "Sign in as Parent";
        return;
      }

      // SUCCESS: write session keys exactly as required by deployment notes
      localStorage.setItem('role', 'parent');
      // Important: store the DB key of the matched student under studentKey
      // Other pages (parent.html) must read localStorage.getItem('studentKey')
      localStorage.setItem('studentKey', foundKey);

      // Also store a lightweight friendly name for UI
      localStorage.setItem('studentName', `${foundStudent.firstName || ''} ${foundStudent.lastName || ''}`.trim());

      // provide some visual feedback
      Swal.fire({
        title: 'Welcome',
        text: `Signed in for ${foundStudent.firstName || ''} ${foundStudent.lastName || ''}`,
        icon: 'success',
        timer: 1100,
        showConfirmButton: false
      });

      // redirect to parent dashboard
      setTimeout(()=> {
        window.location.href = 'parent.html';
      }, 900);

    } catch (err) {
      console.error("Parent sign-in error", err);
      Swal.fire('Sign-in error', err.message || 'Failed to sign in', 'error');
      document.getElementById('parent-signin-btn').disabled = false;
      document.getElementById('parent-signin-btn').textContent = "Sign in as Parent";
    }
  });

  // Parent guest button: allow demo view by selecting first student in DB (for demos only)
  document.getElementById('parent-guest').addEventListener('click', async function () {
    try {
      const snap = await db.ref('students').limitToFirst(1).once('value');
      const data = snap.val();
      if (!data) {
        Swal.fire('No data','No students found to demo','info');
        return;
      }
      const firstKey = Object.keys(data)[0];
      const s = data[firstKey];
      localStorage.setItem('role','parent');
      localStorage.setItem('studentKey', firstKey);
      localStorage.setItem('studentName', `${s.firstName || ''} ${s.lastName || ''}`.trim());
      Swal.fire('Demo', 'Entering demo parent dashboard', 'success');
      setTimeout(()=> window.location.href = 'parent.html', 700);
    } catch (err) {
      console.error(err);
      Swal.fire('Error','Could not start demo','error');
    }
  });

  // =========================================================================================
  // Restore staff session if already signed in via firebase auth
  // We will do a lightweight check: if auth.currentUser is present, attempt to route user
  // NOTE: The sign-in handling above already sets localStorage for role/class
  // =========================================================================================
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      debugLog("No firebase user currently.");
      return;
    }
    // If user signed in in another tab previously, we may auto-route them
    try {
      const emailKey = user.email.replace(/\./g, '_');
      const snap = await db.ref('users/' + emailKey).once('value');
      const userData = snap.val();
      if (!userData) {
        // sign out if not found
        await auth.signOut();
        localStorage.removeItem('role');
        localStorage.removeItem('class');
        return;
      }
      localStorage.setItem('role', userData.role || '');
      if (userData.class) localStorage.setItem('class', userData.class);
      if (userData.role === 'accountant') {
        window.location.href = 'mhasibu.html';
      } else if (userData.role === 'teacher') {
        window.location.href = 'staff.html';
      } else if (userData.role === 'admin') {
        window.location.href = 'dashboard.html';
      }
    } catch (err) {
      console.error("Auth state routing error:", err);
    }
  });

  // =========================================================================================
  // Small helper: When someone lands with "studentKey" already in localStorage (maybe from a previous session),
  // show a small quick link to go directly to parent dashboard in the top-right area.
  // =========================================================================================
  (function quickParentLink() {
    try {
      const studentKey = localStorage.getItem('studentKey');
      if (!studentKey) return;
      // show small toast in corner
      const toast = document.createElement('div');
      toast.style.position = 'fixed';
      toast.style.right = '12px';
      toast.style.bottom = '12px';
      toast.style.background = 'rgba(17,24,39,0.9)';
      toast.style.color = 'white';
      toast.style.padding = '10px 12px';
      toast.style.borderRadius = '8px';
      toast.style.boxShadow = '0 8px 30px rgba(2,6,23,0.3)';
      toast.style.zIndex = 9999;
      toast.innerHTML = `<div style="font-size:13px">Signed-in as parent — <a href="parent.html" style="color:#60a5fa">Open dashboard</a></div>`;
      document.body.appendChild(toast);
      setTimeout(()=> {
        toast.style.opacity = '0';
        setTimeout(()=> toast.remove(), 800);
      }, 7000);
    } catch (e) { console.warn(e); }
  })();

  // =========================================================================================
  // Extra: helpful debug button to print localStorage keys - visible only in dev (comment out in prod)
  // =========================================================================================
  // (not shown in UI; developers can call printSession() in console)
  function printSession() {
    console.log("localStorage dump:", {
      role: localStorage.getItem('role'),
      class: localStorage.getItem('class'),
      studentKey: localStorage.getItem('studentKey'),
      studentName: localStorage.getItem('studentName'),
    });
  }
  window.printSession = printSession;

  // =========================================================================================
  // Accessibility and keyboard shortcuts (small helpers)
  // - Press "L" to focus login area
  // - Press "P" to attempt quick parent demo (for demonstration only)
  // =========================================================================================
  document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'l') {
      document.getElementById('parent-child-name').focus();
    }
    if (e.key.toLowerCase() === 'p') {
      // attempt quick demo sign-in if user presses P (only in dev)
      // Uncomment to enable quick demo: document.getElementById('parent-guest').click();
    }
  });

  // =========================================================================================
  // End of index logic
  // =========================================================================================
  </script>
</body>
</html>
