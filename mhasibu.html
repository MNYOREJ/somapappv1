<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Accountant (Mhasibu) Dashboard — Real</title>

  <!-- Firebase compat SDKs (9.6.10 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <!-- UI libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Minimal but robust styles */
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: linear-gradient(135deg,#007bff,#6610f2); min-height:100vh; color:#0f172a; }
    .sidebar{width:64px;position:fixed;left:0;top:0;bottom:0;padding:10px;background:linear-gradient(to bottom,#fd7e14,#ffc107);display:flex;flex-direction:column;align-items:center;gap:6px}
    .workspace{margin-left:64px;padding:18px}
    .card{background:linear-gradient(180deg,#fff,#f3f4f6);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.12);color:#000}
    .hide{display:none}
    .modal-iframe{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:stretch;justify-content:center;z-index:60}
    .modal-iframe .panel{background:#fff;width:100%;max-width:1200px;height:100%;overflow:hidden;display:flex;flex-direction:column}
    .modal-iframe iframe{flex:1;border:0}
    @media (max-width:768px){ .workspace { margin-left:0; } .sidebar { transform:translateX(-100%); } .sidebar.show { transform:none; } }
  </style>
</head>
<body>

  <!-- Sidebar (icons hidden until signed-in with correct role) -->
  <div id="sidebar" class="sidebar" aria-hidden="false">
    <img src="images/somap-logo.png.jpg" alt="SoMAp" style="width:44px;height:44px;border-radius:8px"/>
    <button id="toggleSidebar" title="Toggle" class="p-2 bg-white/20 rounded text-white"><i class="fas fa-bars"></i></button>

    <!-- shown only to accountant/admin -->
    <button id="financeIcon" class="hide p-2 rounded text-white" title="Open Finance"><i class="fas fa-money-bill-wave"></i></button>
    <button id="admissionIcon" class="hide p-2 rounded text-white" title="Admissions (ERP)"><i class="fas fa-user-plus"></i></button>
    <button id="marketIcon" class="hide p-2 rounded text-white" title="Market (open)"><i class="fas fa-store"></i></button>

    <div style="flex:1"></div>
    <button id="logout" class="hide p-2 rounded text-white" title="Sign out"><i class="fas fa-sign-out-alt"></i></button>
  </div>

  <!-- Work area -->
  <div class="workspace">
    <header class="mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl text-white">SoMAp — Accountant Dashboard</h1>
          <p id="userLabel" class="text-sm text-white/80">Not signed in</p>
        </div>
        <div class="flex gap-2">
          <button id="openLogin" class="px-3 py-2 rounded bg-white/90">Sign in</button>
          <button id="refreshBtn" class="px-3 py-2 rounded bg-white/90">Refresh Data</button>
        </div>
      </div>
    </header>

    <main>
      <section class="card mb-6">
        <h2 class="text-lg font-semibold">Finance Overview (live from Firebase)</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
          <div class="p-3 bg-white rounded">
            <div class="text-sm text-gray-500">Total Due (All Students)</div>
            <div id="totalDue" class="text-xl font-bold">TSh 0</div>
          </div>
          <div class="p-3 bg-white rounded">
            <div class="text-sm text-gray-500">Total Collected</div>
            <div id="totalCollected" class="text-xl font-bold">TSh 0</div>
          </div>
          <div class="p-3 bg-white rounded">
            <div class="text-sm text-gray-500">Total Outstanding</div>
            <div id="totalOutstanding" class="text-xl font-bold">TSh 0</div>
          </div>
          <div class="p-3 bg-white rounded">
            <div class="text-sm text-gray-500">Total Expenses</div>
            <div id="totalExpenses" class="text-xl font-bold">TSh 0</div>
          </div>
        </div>

        <div class="mt-6">
          <canvas id="financeChart" height="80"></canvas>
        </div>
      </section>

      <section class="card">
        <h3 class="font-semibold">Recent Fee Payments</h3>
        <ul id="recentList" class="mt-3 space-y-2"></ul>
        <div class="mt-4 flex gap-2">
          <button id="openFinanceBtn" class="px-3 py-2 rounded bg-indigo-600 text-white">Open Full Finance (live)</button>
          <button id="openAdmissionBtn" class="px-3 py-2 rounded bg-emerald-600 text-white">Open Admissions (ERP)</button>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-white/80">© SoMAp — drop-in accountant dashboard</footer>
  </div>

  <!-- IFRAME modal panel -->
  <div id="iframeModal" class="modal-iframe hide" style="display:none;">
    <div class="panel">
      <div class="flex items-center justify-between p-3 border-b">
        <div id="iframeTitle" class="font-semibold">External Module</div>
        <div>
          <button id="iframeBack" class="px-3 py-2 rounded border mr-2">Back</button>
          <button id="iframeClose" class="px-3 py-2 rounded border">Close</button>
        </div>
      </div>
      <iframe id="iframeWindow" src="" title="Module"></iframe>
    </div>
  </div>

  <!-- SIGN IN modal -->
  <div id="loginModal" style="display:none;position:fixed;inset:0;z-index:80;align-items:center;justify-content:center;background:rgba(0,0,0,0.45)">
    <div style="background:#fff;padding:18px;border-radius:8px;max-width:420px;margin:auto;">
      <h3 class="font-semibold mb-2">Sign in to SoMAp</h3>
      <input id="email" placeholder="Email" class="w-full p-2 mb-2 border" />
      <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-2 border" />
      <div class="flex gap-2">
        <button id="emailLogin" class="px-3 py-2 bg-indigo-600 text-white rounded">Sign in</button>
        <button id="googleLogin" class="px-3 py-2 bg-red-600 text-white rounded">Google</button>
        <button id="closeLogin" class="px-3 py-2 border rounded">Close</button>
      </div>
      <p class="text-xs mt-2 text-gray-600">Make sure the email exists under /users in DB (normalized key) with role = "accountant" or "admin".</p>
    </div>
  </div>

<script>
/* ====== FIREBASE CONFIG (use your console config) ======
   Replace values if needed — I used the values you posted earlier.
========================================================*/
const firebaseConfig = {
  apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
  authDomain: "somaptestt.firebaseapp.com",
  databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
  projectId: "somaptestt",
  storageBucket: "somaptestt.appspot.com",
  messagingSenderId: "105526245138",
  appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
} else {
  firebase.app(); // already initialized
}

const auth = firebase.auth();
const db = firebase.database();

/* ====== environment check: popup auth requires http/https ====== */
function checkEnvironmentForAuth() {
  const p = location.protocol;
  if (p !== 'http:' && p !== 'https:' && p !== 'chrome-extension:') {
    // show a helpful message
    Swal.fire({
      icon: 'warning',
      title: 'Local file detected',
      html: 'You are opening the page with <code>file://</code>. Google/Github popup sign-in will fail. <br><br>Run a local server:<br><code>python3 -m http.server 8000</code><br>or<br><code>npx http-server</code> and open <code>http://localhost:8000/</code>',
      width: 700
    });
    return false;
  }
  return true;
}

/* ====== UI refs ====== */
const openLogin = document.getElementById('openLogin');
const loginModal = document.getElementById('loginModal');
const closeLogin = document.getElementById('closeLogin');
const emailLogin = document.getElementById('emailLogin');
const googleLogin = document.getElementById('googleLogin');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const userLabel = document.getElementById('userLabel');

const financeIcon = document.getElementById('financeIcon');
const admissionIcon = document.getElementById('admissionIcon');
const marketIcon = document.getElementById('marketIcon');
const logoutBtn = document.getElementById('logout');

const totalDueEl = document.getElementById('totalDue');
const totalCollectedEl = document.getElementById('totalCollected');
const totalOutstandingEl = document.getElementById('totalOutstanding');
const totalExpensesEl = document.getElementById('totalExpenses');
const recentList = document.getElementById('recentList');

const openFinanceBtn = document.getElementById('openFinanceBtn');
const openAdmissionBtn = document.getElementById('openAdmissionBtn');

const iframeModal = document.getElementById('iframeModal');
const iframeWindow = document.getElementById('iframeWindow');
const iframeClose = document.getElementById('iframeClose');
const iframeBack = document.getElementById('iframeBack');
const iframeTitle = document.getElementById('iframeTitle');

const refreshBtn = document.getElementById('refreshBtn');

function showAccountantIcons(show){
  [financeIcon, admissionIcon, marketIcon, logoutBtn].forEach(el => {
    if (show) el.classList.remove('hide'); else el.classList.add('hide');
  });
}

/* ====== Normalise email -> DB key (same convention you use in /users) ====== */
function normKey(email){
  if(!email) return '';
  return email.replace(/\./g, '_').replace(/\@/g, '_at_').replace(/\+/g,'plus');
}

/* ====== AUTH flows ====== */
openLogin.addEventListener('click', () => {
  loginModal.style.display = 'flex';
});
closeLogin.addEventListener('click', () => loginModal.style.display = 'none');

emailLogin.addEventListener('click', async () => {
  if(!checkEnvironmentForAuth()) return;
  const e = emailInput.value.trim();
  const p = passwordInput.value;
  if(!e || !p) { Swal.fire('Error','Provide email & password','error'); return; }
  try {
    await auth.signInWithEmailAndPassword(e,p);
    loginModal.style.display = 'none';
  } catch(err) {
    Swal.fire('Login failed', err.message, 'error');
    console.error(err);
  }
});

googleLogin.addEventListener('click', async () => {
  if(!checkEnvironmentForAuth()) return;
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await auth.signInWithPopup(provider);
    loginModal.style.display = 'none';
  } catch(err) {
    Swal.fire('Google Sign-In failed', err.message, 'error');
    console.error(err);
  }
});

logoutBtn.addEventListener('click', async () => {
  await auth.signOut();
  location.reload();
});

/* ====== On auth change: fetch role and show UI accordingly ====== */
auth.onAuthStateChanged(async user => {
  if(!user){
    userLabel.textContent = 'Not signed in';
    showAccountantIcons(false);
    return;
  }
  userLabel.textContent = (user.displayName || user.email || 'Signed in');
  console.log('Signed in user:', user);

  // read role in DB
  try {
    const key = normKey(user.email || '');
    const snap = await db.ref('users/' + key).once('value');
    const u = snap.exists() ? snap.val() : null;
    const role = u && u.role ? u.role : null;
    console.log('User role from DB:', role, u);

    if(role === 'accountant' || role === 'admin') {
      showAccountantIcons(true);
      // now load finance totals
      await loadFinanceTotals();
    } else {
      showAccountantIcons(false);
      Swal.fire('Access', 'Signed in but not accountant/admin. Role: ' + (role||'none'), 'info');
    }
  } catch(err) {
    console.error('Error reading role', err);
    Swal.fire('Error', 'Could not read your role: ' + err.message, 'error');
  }
});

/* ====== Finance totals calculation (reads /students and /expenses) ======
   - Total Due = sum of feePerYear OR feeDue OR feePerYear fallback
   - Total Collected = sum of all payments under student.payments OR student.paidAmount
   - Total Expenses = sum of expenses/*/amount
   - Recent payments = flattened list from student.payments
===============================================================*/
async function loadFinanceTotals(){
  try {
    totalDueEl.textContent = 'TSh ...';
    totalCollectedEl.textContent = 'TSh ...';
    totalOutstandingEl.textContent = 'TSh ...';
    totalExpensesEl.textContent = 'TSh ...';
    recentList.innerHTML = '<li class="p-2 bg-white rounded">Loading...</li>';

    const studentsSnap = await db.ref('students').once('value');
    const students = studentsSnap.val() || {};

    let totalDue = 0;
    let totalCollected = 0;
    let payments = []; // {name, amount, method, ts}

    Object.values(students).forEach(s=>{
      // sum fees
      const fee = Number(s.feePerYear || s.feeDue || s.fee || 0);
      totalDue += fee;

      // payments under s.payments
      if(s.payments){
        Object.values(s.payments).forEach(p=>{
          const amt = Number(p.amount || 0);
          totalCollected += amt;
          payments.push({
            name: (s.firstName ? s.firstName + ' ' + (s.lastName||'') : s.fullName || s.name) || 'Unknown',
            amount: amt,
            method: p.method || '',
            ts: Number(p.timestamp || p.ts || 0)
          });
        });
      } else if(Number(s.paidAmount || 0) > 0) {
        // fallback if paid amount stored on student record
        const amt = Number(s.paidAmount || 0);
        totalCollected += amt;
        payments.push({
          name: (s.firstName ? s.firstName + ' ' + (s.lastName||'') : s.fullName || s.name) || 'Unknown',
          amount: amt,
          method: 'recorded',
          ts: Number(s.timestamp || 0)
        });
      }
    });

    // expenses
    const expSnap = await db.ref('expenses').once('value');
    const exp = expSnap.val() || {};
    let totalExpenses = 0;
    Object.values(exp).forEach(e=> {
      totalExpenses += Number(e.amount || 0);
    });

    // compute outstanding & net
    const totalOutstanding = Math.max(0, totalDue - totalCollected);
    const netBalance = totalCollected - totalExpenses;

    // format and write
    const fmt = n => 'TSh ' + Number(n||0).toLocaleString();
    totalDueEl.textContent = fmt(totalDue);
    totalCollectedEl.textContent = fmt(totalCollected);
    totalOutstandingEl.textContent = fmt(totalOutstanding);
    totalExpensesEl.textContent = fmt(totalExpenses);

    // show recent payments sorted by ts desc
    payments.sort((a,b) => (b.ts||0) - (a.ts||0));
    if(payments.length === 0) {
      recentList.innerHTML = '<li class="p-2 bg-white rounded text-sm">No payments recorded yet.</li>';
    } else {
      recentList.innerHTML = payments.slice(0,30).map(p => {
        const date = p.ts ? new Date(p.ts).toLocaleString() : '';
        return `<li class="p-2 bg-white rounded"><strong>${escapeHtml(p.name)}</strong> — <span>${fmt(p.amount)}</span><br/><small class="text-gray-500">${escapeHtml(p.method)} · ${date}</small></li>`;
      }).join('');
    }

    // draw chart
    drawChart(totalDue, totalCollected, totalExpenses);

    console.log('Finance totals (computed):', { totalDue, totalCollected, totalOutstanding, totalExpenses, netBalance });
  } catch(err){
    console.error('loadFinanceTotals error', err);
    Swal.fire('Error', 'Failed to load finance totals: ' + err.message, 'error');
  }
}

/* chart */
let chartInstance = null;
function drawChart(due, collected, expenses){
  const ctx = document.getElementById('financeChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type:'doughnut',
    data:{
      labels:['Collected','Outstanding','Expenses'],
      datasets:[{ data: [collected, Math.max(0,due-collected), expenses], backgroundColor:['#10b981','#f59e0b','#ef4444'] }]
    },
    options:{responsive:true,plugins:{legend:{position:'bottom'}}}
  });
}

/* safe escape */
function escapeHtml(str){ return String(str || '').replace(/[&<>"'`=\/]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s])); }

/* ====== iframe open/close (finance.html / schoolerp.html) ====== */
function openIframe(url, title){
  iframeModal.style.display = 'flex';
  iframeWindow.src = url;
  iframeTitle.textContent = title || url;
}
function closeIframe(){
  iframeWindow.src = '';
  iframeTitle.textContent = '';
  iframeModal.style.display = 'none';
}
iframeClose.addEventListener('click', closeIframe);
iframeBack.addEventListener('click', closeIframe);

/* left icons & buttons */
financeIcon.addEventListener('click', () => openIframe('finance.html', 'SoMAp Finance (live)'));
admissionIcon.addEventListener('click', () => openIframe('schoolerp.html#create-admission', 'Admissions (ERP)'));
marketIcon.addEventListener('click', () => openIframe('market.html', 'SoMAp Market'));

openFinanceBtn.addEventListener('click', () => openIframe('finance.html', 'SoMAp Finance (live)'));
openAdmissionBtn.addEventListener('click', () => openIframe('schoolerp.html#create-admission', 'Admissions (ERP)'));

refreshBtn.addEventListener('click', loadFinanceTotals);

/* auto reload every 40s (keeps dashboard live) */
setInterval(() => {
  if (auth.currentUser) loadFinanceTotals();
}, 40000);

/* If page opened with file:// tell user how to serve */
if (!checkEnvironmentForAuth()) {
  // checkEnvironmentForAuth already shows a dialog; we still allow email/password if required but sign-in popup will fail
}

/* Make sure iframe pages are same origin to allow seamless actions.
   If you host finance.html on same domain, the iframe will be interactive and you can pay there.
*/

/* END */
</script>
</body>
</html>
