<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Accountant Dashboard (Mhasibu)</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>

  <!-- UI libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <!-- Tailwind CDN quick styles (keeps layout neat) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* custom design for accountant dashboard */
    :root{
      --accent-1:#0ea5a4;
      --accent-2:#6366f1;
      --bg-1:linear-gradient(135deg,#0ea5a4,#6366f1);
      --card-bg:linear-gradient(180deg,#ffffff,#f3f4f6);
      --muted:#6b7280;
    }
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background: var(--bg-1); min-height:100vh; color:#0f172a;}
    .sidebar{width:64px;background:linear-gradient(to bottom,#ef4444,#f97316);min-height:100vh;padding:8px;position:fixed;left:0;top:0;z-index:40}
    .sidebar-expanded{width:250px}
    .workspace{margin-left:64px;padding:18px;transition:margin-left .25s ease}
    .workspace.sidebar-expanded{margin-left:250px}
    .sidebar .icon-btn{display:block;width:48px;height:48px;margin:8px auto;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff}
    .sidebar .icon-btn:hover{background:rgba(255,255,255,0.12)}
    .topbar{background:rgba(255,255,255,.95);padding:8px 16px;border-radius:12px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 6px 18px rgba(15,23,42,0.12)}
    .card{background:var(--card-bg);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    .stat{padding:14px;border-radius:10px;background:white}
    .stat .value{font-weight:700;font-size:1.35rem}
    .currency{font-weight:700}
    .hide{display:none}
    .modal-iframe{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:stretch;justify-content:center;z-index:60}
    .modal-iframe .panel{background:white;width:100%;max-width:1200px;height:100%;border-radius:0;overflow:hidden;display:flex;flex-direction:column}
    .modal-iframe iframe{flex:1;border:0}
    .btn-primary{background:linear-gradient(90deg,#06b6d4,#06b6d4);color:white;padding:.6rem 1rem;border-radius:8px}
    .btn-ghost{background:transparent;border:1px solid rgba(15,23,42,.06);padding:.5rem .75rem;border-radius:8px}
    .recent-list li{background:white;border-radius:10px;padding:10px;margin-bottom:8px}
    @media (max-width:768px){
      .workspace{margin-left:0;padding:12px}
      .sidebar{position:fixed;left:0;top:0;transform:translateX(-100%);}
      .has-open-sidebar .sidebar{transform:none}
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <div id="sidebar" class="sidebar" aria-hidden="false">
    <div class="flex flex-col items-center mt-2">
      <img src="images/somap-logo.png.jpg" alt="SoMAp" style="width:44px;height:44px;border-radius:8px;margin-bottom:6px"/>
      <button id="toggleSidebar" class="icon-btn" title="Toggle menu"><i class="fas fa-bars"></i></button>
    </div>

    <div id="leftIcons" class="mt-6">
      <!-- visible only after login as accountant/admin -->
      <button id="finance-launch" class="icon-btn hide" title="Open Finance (full)"><i class="fas fa-money-bill-wave"></i></button>
      <button id="admissions-launch" class="icon-btn hide" title="Admissions (ERP)"><i class="fas fa-user-plus"></i></button>
      <button id="open-market" class="icon-btn hide" title="Market"><i class="fas fa-store"></i></button>
    </div>

    <div class="mt-auto mb-6 text-center">
      <button id="logoutBtn" class="icon-btn hide" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </div>

  <!-- WORKSPACE -->
  <div id="workspace" class="workspace">

    <!-- TOPBAR -->
    <div class="topbar mb-6">
      <div>
        <h1 class="text-2xl">SoMAp — Accountant Dashboard</h1>
        <p class="text-sm text-gray-600">Connected to: <span id="projectLabel">somaptestt</span></p>
      </div>
      <div class="flex items-center gap-3">
        <div id="userLabel" class="text-sm text-gray-700">Not signed in</div>
        <button id="openLogin" class="btn-ghost">Sign In</button>
      </div>
    </div>

    <!-- DASHBOARD GRID -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

      <!-- summary cards -->
      <div class="card col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Finance Overview</h2>
          <div class="text-sm text-gray-500">Live from Firebase (TSh)</div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
          <div class="stat">
            <div class="text-sm text-gray-500">Total Due (All Students)</div>
            <div class="value currency" id="totalDue">TSh 0</div>
          </div>
          <div class="stat">
            <div class="text-sm text-gray-500">Total Collected</div>
            <div class="value currency" id="totalCollected">TSh 0</div>
          </div>
          <div class="stat">
            <div class="text-sm text-gray-500">Total Outstanding</div>
            <div class="value currency" id="totalOutstanding">TSh 0</div>
          </div>
          <div class="stat">
            <div class="text-sm text-gray-500">Total Expenses</div>
            <div class="value currency" id="totalExpenses">TSh 0</div>
          </div>
        </div>

        <div class="mt-6">
          <canvas id="financeChart" height="90"></canvas>
        </div>
      </div>

      <!-- recent payments & quick actions -->
      <div class="card">
        <h3 class="font-semibold mb-2">Recent Fee Payments</h3>
        <ul id="recentPayments" class="recent-list" style="max-height:420px;overflow:auto"></ul>

        <div class="mt-4 flex gap-2">
          <button id="openFinanceFull" class="btn-primary flex-1"><i class="fas fa-external-link-alt mr-2"></i>Open Full Finance</button>
          <button id="openAdmissionOnly" class="btn-ghost flex-1">Admissions (ERP)</button>
        </div>

        <div class="mt-6">
          <h4 class="text-sm text-gray-600 mb-2">Net Balance</h4>
          <div class="text-2xl font-bold currency" id="netBalance">TSh 0</div>
        </div>
      </div>

    </div>

    <!-- extra modules area -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">

      <div class="card col-span-2">
        <h3 class="font-semibold mb-2">Quick Overview</h3>
        <div class="flex flex-wrap gap-3">
          <div class="p-3 rounded-lg bg-white">
            <div class="text-sm text-gray-500">Registered Students</div>
            <div id="studentsCount" class="font-semibold">0</div>
          </div>
          <div class="p-3 rounded-lg bg-white">
            <div class="text-sm text-gray-500">Payments Recorded</div>
            <div id="paymentsCount" class="font-semibold">0</div>
          </div>
          <div class="p-3 rounded-lg bg-white">
            <div class="text-sm text-gray-500">Expenses Items</div>
            <div id="expensesCount" class="font-semibold">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="font-semibold mb-2">SoMAp Market</h3>
        <p class="text-sm text-gray-600 mb-2">Quick view of available goods (so accountant can advise parents)</p>
        <div id="marketPreview" class="grid grid-cols-1 gap-2"></div>
        <button id="openMarketFull" class="mt-3 btn-ghost w-full">Open Market</button>
      </div>
    </div>

    <footer class="mt-6 text-sm text-gray-700">© <strong>SoMAp</strong> — Accountant Dashboard · Integrated with Firebase</footer>
  </div>

  <!-- IFRAME MODAL (for finance.html / schoolerp.html) -->
  <div id="iframeModal" class="modal-iframe hide" style="display:none;">
    <div class="panel">
      <div class="flex items-center justify-between p-3 border-b">
        <div id="iframeTitle" class="font-semibold">External Module</div>
        <div>
          <button id="iframeBack" class="btn-ghost mr-2"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
          <button id="iframeClose" class="btn-ghost"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <iframe id="iframeLoader" src="" title="External Module"></iframe>
    </div>
  </div>

  <!-- SIMPLE LOGIN MODAL (used for demo sign in) -->
  <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center" style="display:none;">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
      <h3 class="text-lg font-semibold mb-3">Sign in to SoMAp</h3>
      <div class="space-y-3">
        <input id="emailInput" type="email" placeholder="Email" class="w-full p-2 border rounded" />
        <input id="passwordInput" type="password" placeholder="Password" class="w-full p-2 border rounded" />
        <div class="flex gap-2">
          <button id="emailLoginBtn" class="btn-primary flex-1">Sign in</button>
          <button id="googleLoginBtn" class="btn-ghost flex-1"><i class="fab fa-google mr-2"></i> Google</button>
        </div>
        <div class="text-xs text-gray-500">Use an accountant/admin Gmail that exists in your DB under /users as normalized key.</div>
        <div class="mt-3 text-right"><button id="loginCancel" class="btn-ghost">Close</button></div>
      </div>
    </div>
  </div>

<script>
  /**********************************************
   * FIREBASE CONFIG - use your provided values
   **********************************************/
  const firebaseConfig = {
    apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
    authDomain: "somaptestt.firebaseapp.com",
    databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
    projectId: "somaptestt",
    storageBucket: "somaptestt.appspot.com",
    messagingSenderId: "105526245138",
    appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
    measurementId: "G-4HKX7KN6Q3"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // small helper to convert email -> normalized key used in DB (same you use)
  function normEmailKey(email){
    if(!email) return "";
    return email.replace(/\./g, "_").replace(/\@/g, "_at_");
  }

  /* ----------------------------
     UI Elements
  ---------------------------- */
  const leftIcons = document.getElementById('leftIcons');
  const financeLaunchBtn = document.getElementById('finance-launch');
  const admissionsLaunchBtn = document.getElementById('admissions-launch');
  const openMarketBtn = document.getElementById('open-market');
  const logoutBtn = document.getElementById('logoutBtn');

  const openLogin = document.getElementById('openLogin');
  const loginModal = document.getElementById('loginModal');
  const loginCancel = document.getElementById('loginCancel');
  const emailLoginBtn = document.getElementById('emailLoginBtn');
  const googleLoginBtn = document.getElementById('googleLoginBtn');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const userLabel = document.getElementById('userLabel');

  const totalDueEl = document.getElementById('totalDue');
  const totalCollectedEl = document.getElementById('totalCollected');
  const totalOutstandingEl = document.getElementById('totalOutstanding');
  const totalExpensesEl = document.getElementById('totalExpenses');
  const netBalanceEl = document.getElementById('netBalance');
  const recentPaymentsEl = document.getElementById('recentPayments');
  const studentsCountEl = document.getElementById('studentsCount');
  const paymentsCountEl = document.getElementById('paymentsCount');
  const expensesCountEl = document.getElementById('expensesCount');

  const iframeModal = document.getElementById('iframeModal');
  const iframeLoader = document.getElementById('iframeLoader');
  const iframeTitle = document.getElementById('iframeTitle');
  const iframeClose = document.getElementById('iframeClose');
  const iframeBack = document.getElementById('iframeBack');

  const openFinanceFull = document.getElementById('openFinanceFull');
  const openAdmissionOnly = document.getElementById('openAdmissionOnly');

  const toggleSidebar = document.getElementById('toggleSidebar');
  const workspace = document.getElementById('workspace');
  const sidebar = document.getElementById('sidebar');

  /* ----------------------------
     Show/hide helpers
  ---------------------------- */
  function showIfAccountant(){
    financeLaunchBtn.classList.remove('hide');
    admissionsLaunchBtn.classList.remove('hide');
    openMarketBtn.classList.remove('hide');
    logoutBtn.classList.remove('hide');
  }
  function hideAllLeft(){
    financeLaunchBtn.classList.add('hide');
    admissionsLaunchBtn.classList.add('hide');
    openMarketBtn.classList.add('hide');
    logoutBtn.classList.add('hide');
  }

  /* ----------------------------
     Auth and role handling
  ---------------------------- */
  openLogin.addEventListener('click', ()=>{ loginModal.style.display='flex'; });
  loginCancel.addEventListener('click', ()=>{ loginModal.style.display='none'; });

  emailLoginBtn.addEventListener('click', async ()=>{
    const email = emailInput.value.trim();
    const pwd = passwordInput.value;
    if(!email || !pwd) { Swal.fire('Error','Provide credentials','error'); return; }
    try{
      await auth.signInWithEmailAndPassword(email,pwd);
      loginModal.style.display='none';
    }catch(err){
      Swal.fire('Login failed', err.message, 'error');
    }
  });

  googleLoginBtn.addEventListener('click', async ()=>{
    const prov = new firebase.auth.GoogleAuthProvider();
    try{
      await auth.signInWithPopup(prov);
      loginModal.style.display='none';
    }catch(err){
      Swal.fire('Google Sign-In failed', err.message, 'error');
    }
  });

  logoutBtn.addEventListener('click', ()=> {
    auth.signOut().then(()=> location.reload());
  });

  // handle auth state
  auth.onAuthStateChanged(async (user)=>{
    if(!user){
      userLabel.textContent = 'Not signed in';
      hideAllLeft();
      return;
    }
    userLabel.textContent = (user.displayName || user.email || 'Signed in');
    // read role from DB
    const dbKey = normEmailKey(user.email || '');
    const snap = await db.ref('users/' + dbKey).once('value');
    const udata = snap.exists() ? snap.val() : null;
    const role = udata && udata.role ? udata.role : 'unknown';

    // show only if accountant or admin
    if(role === 'accountant' || role === 'admin'){
      showIfAccountant();
      // load all financial data
      loadFinanceTotals();
    } else {
      // not accountant -> hide left icons
      hideAllLeft();
      Swal.fire('Access','You are signed in but do not have accountant access.','info');
    }
  });

  /* ----------------------------
     Loading finance data (mirrors finance.html logic)
     - Total Due = sum of feePerYear across students
     - Total Collected = sum of all payments amounts found under each student.payments
     - Total Expenses = sum(expensess/*/amount)
     - List recent payments by timestamp (latest first)
  ---------------------------- */
  async function loadFinanceTotals(){
    // clear UI while loading
    totalDueEl.textContent = 'TSh ...';
    totalCollectedEl.textContent = 'TSh ...';
    totalOutstandingEl.textContent = 'TSh ...';
    totalExpensesEl.textContent = 'TSh ...';
    recentPaymentsEl.innerHTML = '<li class="p-3 bg-white rounded">Loading...</li>';
    try{
      const studentsSnap = await db.ref('students').once('value');
      const students = studentsSnap.val() || {};
      let totalDue = 0;
      let totalCollected = 0;
      let paymentsList = []; // {name, amount, method, timestamp}

      let paymentsCount = 0;
      let studentsCount = 0;
      Object.values(students).forEach(s=>{
        studentsCount++;
        const feePerYear = Number(s.feePerYear || s.feeDue || 0);
        totalDue += feePerYear;
        if(s.payments){
          Object.values(s.payments).forEach(p=>{
            const amt = Number(p.amount || 0);
            totalCollected += amt;
            paymentsCount++;
            paymentsList.push({
              name: (s.firstName? (s.firstName + ' ' + (s.lastName||'')) : s.name || s.fullName || 'Unknown'),
              amount: amt,
              method: p.method || 'Unknown',
              timestamp: Number(p.timestamp || p.ts || 0)
            });
          });
        } else {
          // also check if paidAmount exists
          if(s.paidAmount) {
            const amt = Number(s.paidAmount || 0);
            if(amt>0) {
              totalCollected += amt;
              paymentsCount++;
              paymentsList.push({
                name: (s.firstName? (s.firstName + ' ' + (s.lastName||'')) : s.name || s.fullName || 'Unknown'),
                amount: amt,
                method: 'Recorded',
                timestamp: Number(s.timestamp || 0)
              });
            }
          }
        }
      });

      // expenses
      const expensesSnap = await db.ref('expenses').once('value');
      const expenses = expensesSnap.val() || {};
      let totalExpenses = 0;
      let expensesCount = 0;
      Object.values(expenses).forEach(exp=>{
        const a = Number(exp.amount || 0);
        totalExpenses += a;
        expensesCount++;
      });

      // compute outstanding + net
      const totalOutstanding = Math.max(0, totalDue - totalCollected);
      const netBalance = totalCollected - totalExpenses;

      // write to UI (format with commas)
      function fmt(n){ return 'TSh ' + Number(n || 0).toLocaleString(); }
      totalDueEl.textContent = fmt(totalDue);
      totalCollectedEl.textContent = fmt(totalCollected);
      totalOutstandingEl.textContent = fmt(totalOutstanding);
      totalExpensesEl.textContent = fmt(totalExpenses);
      netBalanceEl.textContent = fmt(netBalance);

      studentsCountEl.textContent = studentsCount;
      paymentsCountEl.textContent = paymentsCount;
      expensesCountEl.textContent = expensesCount;

      // recent payments sorted by timestamp desc
      paymentsList.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
      if(paymentsList.length === 0){
        recentPaymentsEl.innerHTML = '<li class="p-3 bg-white rounded text-sm text-gray-600">No payments recorded yet.</li>';
      } else {
        recentPaymentsEl.innerHTML = paymentsList.slice(0,30).map(p=>{
          const date = p.timestamp ? new Date(p.timestamp).toLocaleString() : '';
          return `<li><div><strong>${escapeHtml(p.name)}</strong> - <span class="text-gray-600">${fmt(p.amount)}</span></div><div class="text-xs text-gray-500">${escapeHtml(p.method)} · ${date}</div></li>`;
        }).join('');
      }

      // small chart for visual (collected vs due vs expenses)
      drawFinanceChart(totalDue, totalCollected, totalExpenses);

    } catch(err){
      console.error("loadFinanceTotals error", err);
      Swal.fire('Error','Failed to load finance totals: ' + err.message,'error');
    }
  }

  /* ----------------------------
     Small chart
  ---------------------------- */
  let financeChartInstance = null;
  function drawFinanceChart(due, collected, expenses){
    const ctx = document.getElementById('financeChart').getContext('2d');
    if(financeChartInstance) financeChartInstance.destroy();
    financeChartInstance = new Chart(ctx, {
      type:'doughnut',
      data:{
        labels:['Collected','Outstanding','Expenses'],
        datasets:[{
          data: [collected, Math.max(0,due-collected), expenses],
          backgroundColor: ['#10b981','#f59e0b','#ef4444']
        }]
      },
      options:{
        responsive:true,
        plugins:{legend:{position:'bottom'}}
      }
    });
  }

  /* ----------------------------
     Utility: escapeHtml for safety in innerHTML
  ---------------------------- */
  function escapeHtml(s){
    if(!s) return '';
    return String(s).replace(/[&<>"'`=\/]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]; });
  }

  /* ----------------------------
     IFRAME modal controls
  ---------------------------- */
  function openIframe(url, title){
    iframeTitle.textContent = title || url;
    iframeLoader.src = url;
    iframeModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  function closeIframe(){
    iframeLoader.src = '';
    iframeModal.style.display = 'none';
    document.body.style.overflow = '';
  }
  iframeClose.addEventListener('click', closeIframe);
  iframeBack.addEventListener('click', closeIframe);

  // left icon clicks -> open finance.html and schoolerp create admission
  financeLaunchBtn.addEventListener('click', ()=> openIframe('finance.html','SoMAp Finance (live)'));
  admissionsLaunchBtn.addEventListener('click', ()=> openIframe('schoolerp.html#create-admission','ERP — Create New Admission (live)'));
  openFinanceFull.addEventListener('click', ()=> openIframe('finance.html','SoMAp Finance (live)'));
  openAdmissionOnly.addEventListener('click', ()=> openIframe('schoolerp.html#create-admission','ERP — Admissions (live)'));

  // open market (simple)
  openMarketBtn.addEventListener('click', ()=> openIframe('market.html','SoMAp Market'));

  // sidebar toggle
  toggleSidebar.addEventListener('click', ()=>{
    const expanded = sidebar.classList.toggle('sidebar-expanded');
    workspace.classList.toggle('sidebar-expanded', expanded);
  });

  // helper: run a refresh periodically (keeps dashboard live)
  setInterval(()=> {
    if(auth.currentUser) loadFinanceTotals();
  }, 1000 * 45); // every 45s

  // initial attempt to load (if already signed in)
  auth.onAuthStateChanged(u=> {
    if(u) loadFinanceTotals();
  });

</script>
</body>
</html>