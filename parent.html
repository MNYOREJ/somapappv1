<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoMAp - Parent Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body { font-family: 'Roboto', sans-serif; background: #f4f6fa; min-height: 100vh; }
    .sidebar { width: 80px; background: linear-gradient(to bottom, #4f46e5, #9333ea); height: 100vh; position: fixed; padding: 1rem; color: white; }
    .sidebar-icon { margin: 1rem 0; cursor: pointer; }
    .sidebar-icon:hover { transform: scale(1.1); transition: 0.3s; }
    .main-content { margin-left: 100px; padding: 2rem; }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
    .events-list { list-style: none; padding: 0; }
    .events-list li { background: #f8f9fa; padding: 0.75rem; margin: 0.5rem 0; border-radius: 6px; }
    .btn-main { background: linear-gradient(to right, #6366f1, #8b5cf6); color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: bold; }
    .btn-main:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <div class="flex">
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar flex flex-col items-center">
      <img src="images/somap-logo.png.jpg" alt="SoMAp Logo" class="h-12 mb-6 rounded-full shadow-lg">
      <div class="sidebar-icon" onclick="showSection('overview')"><i class="fas fa-home text-2xl"></i></div>
      <div class="sidebar-icon" onclick="showSection('id-card')"><i class="fas fa-id-card text-2xl"></i></div>
      <div class="sidebar-icon" onclick="showSection('report-card')"><i class="fas fa-file-alt text-2xl"></i></div>
      <div class="sidebar-icon" onclick="showSection('academics')"><i class="fas fa-book text-2xl"></i></div>
      <div class="sidebar-icon" onclick="showSection('finance')"><i class="fas fa-coins text-2xl"></i></div>
      <div class="sidebar-icon" onclick="showSection('marketplace')"><i class="fas fa-store text-2xl"></i></div>
      <div class="sidebar-icon mt-auto" onclick="window.location.href='index.html'"><i class="fas fa-sign-out-alt text-2xl"></i></div>
    </div>

    <!-- Main Content -->
    <div class="main-content w-full">
      <h1 class="text-3xl font-bold mb-6 text-gray-800">Parent Dashboard</h1>
      <h2 id="student-name" class="text-xl font-semibold mb-6 text-gray-600">Loading...</h2>

      <!-- Overview -->
      <div id="overview" class="section">
        <section id="fees" class="card">
          <h3 class="text-lg font-semibold mb-2 text-indigo-600">Fee Status</h3>
          <p id="fee-status">Loading...</p>
        </section>
        <section id="attendance" class="card">
          <h3 class="text-lg font-semibold mb-2 text-indigo-600">Attendance</h3>
          <p id="attendance-stats">Loading...</p>
        </section>
        <section id="scores" class="card">
          <h3 class="text-lg font-semibold mb-2 text-indigo-600">Exam Scores</h3>
          <ul id="scores-list" class="events-list">
            <li>Loading...</li>
          </ul>
        </section>
      </div>

      <!-- Generate Student ID -->
      <div id="id-card" class="section hidden">
        <div class="card">
          <h3 class="text-lg font-semibold mb-4 text-indigo-600">Generate Student ID</h3>
          <button onclick="generateStudentId()" class="btn-main">Generate ID</button>
          <p id="student-id" class="mt-3 text-gray-700 font-semibold"></p>
        </div>
      </div>

      <!-- Report Card -->
      <div id="report-card" class="section hidden">
        <div class="card">
          <h3 class="text-lg font-semibold mb-4 text-indigo-600">Report Card</h3>
          <button onclick="downloadReport('csv')" class="btn-main mr-2">Download CSV</button>
          <button onclick="downloadReport('pdf')" class="btn-main">Download PDF</button>
          <div id="report-preview" class="mt-4 text-gray-700">No report generated yet.</div>
        </div>
      </div>

      <!-- Academics -->
      <div id="academics" class="section hidden">
        <div class="card">
          <h3 class="text-lg font-semibold mb-4 text-indigo-600">Academic Details</h3>
          <p>Check scores, performance trends, and overall progress here.</p>
        </div>
      </div>

      <!-- Finance -->
      <div id="finance" class="section hidden">
        <div class="card">
          <h3 class="text-lg font-semibold mb-4 text-indigo-600">Finance Report</h3>
          <p>Parents can view balances and payments here.</p>
        </div>
      </div>

      <!-- Marketplace -->
      <div id="marketplace" class="section hidden">
        <div class="card">
          <h3 class="text-lg font-semibold mb-4 text-indigo-600">Marketplace</h3>
          <p>Buy uniforms, books, and more here.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const studentId = localStorage.getItem('studentId');
    const role = localStorage.getItem('role');
    if (role !== 'parent' || !studentId) {
      alert('Unauthorized access');
      window.location.href = 'index.html';
    }

    // Section toggle
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    // Load Student Data
    db.ref('students').orderByChild('admissionNumber').equalTo(studentId).once('value').then(snapshot => {
      const student = snapshot.val() ? Object.values(snapshot.val())[0] : null;
      if (!student) {
        alert('Student data not found');
        window.location.href = 'index.html';
        return;
      }
      document.getElementById('student-name').textContent = `${student.firstName} ${student.middleName || ''} ${student.lastName}`;
      document.getElementById('fee-status').textContent =
        `Fee Due: TSh ${student.feePerYear.toLocaleString()} | Paid: TSh ${student.paidAmount.toLocaleString()} | Balance: TSh ${student.balance.toLocaleString()}`;

      // Attendance
      db.ref(`attendance/${student.classLevel}/2025-09`).once('value').then(attSnapshot => {
        const attendance = attSnapshot.val() ? Object.values(attSnapshot.val()).flatMap(day => Object.values(day)) : [];
        let present = attendance.filter(a => a.daily === 'P' && a.snap.admissionNo === studentId).length;
        let total = attendance.filter(a => a.snap.admissionNo === studentId).length;
        document.getElementById('attendance-stats').textContent = `Present: ${present}/${total} (${total ? (present/total*100).toFixed(1) : 0}%)`;
      });

      // Scores
      db.ref(`scores/2025/${student.classLevel}/monthly/08`).once('value').then(scoreSnapshot => {
        const scores = scoreSnapshot.val() && scoreSnapshot.val()[studentId] ? scoreSnapshot.val()[studentId] : {};
        let html = '';
        for (let subject in scores) {
          html += `<li>${subject}: ${scores[subject].score}/${scores[subject].max} 
                  (${(scores[subject].score/scores[subject].max*100).toFixed(1)}%)</li>`;
        }
        document.getElementById('scores-list').innerHTML = html || '<li>No scores available.</li>';
      });
    });

    // Generate Student ID
    function generateStudentId() {
      db.ref('students').orderByChild('admissionNumber').equalTo(studentId).once('value').then(snapshot => {
        const student = snapshot.val() ? Object.values(snapshot.val())[0] : null;
        if (student) {
          document.getElementById('student-id').textContent = `Generated ID: SOMAP-${student.admissionNumber}`;
        }
      });
    }

    // Download Report
    function downloadReport(format) {
      let content = "Subject,Score,Max\n";
      document.querySelectorAll("#scores-list li").forEach(li => {
        content += li.textContent + "\n";
      });

      if (format === "csv") {
        let blob = new Blob([content], { type: "text/csv" });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "report_card.csv";
        link.click();
      } else if (format === "pdf") {
        let win = window.open("", "_blank");
        win.document.write("<pre>" + content + "</pre>");
        win.print();
      }
    }
  </script>
</body>
</html>
