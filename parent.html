<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Parent Dashboard</title>

  <!-- Tailwind CSS CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <!-- jsPDF + autoTable for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- SheetJS for CSV/Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- SweetAlert2 for nicer alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1: #0ea5e9;
      --bg2: #7c3aed;
      --card-bg: rgba(255,255,255,0.98);
      --accent: #4f46e5;
      --muted: #6b7280;
      --ok:#065f46; --warn:#9a3412; --risk:#991b1b;
    }
    html,body { height:100%; }
    html { scroll-behavior:smooth; }
    body {
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overscroll-behavior-y: none;
      touch-action: manipulation;
    }

    .sidebar {
      width:76px;
      background: linear-gradient(180deg,#ff7a50,#ffb86b);
      height:100vh;
      position:fixed; inset:0 auto 0 0;
      padding:12px 10px;
      display:flex; flex-direction:column; align-items:center; gap:10px;
      z-index:40;
      box-shadow: 2px 0 12px rgba(0,0,0,0.15);
    }
    .sidebar .icon {
      width:56px; height:56px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      color:#fff; cursor:pointer;
      transition: transform .15s ease, background .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .sidebar .icon:hover { transform: translateY(-3px); background: rgba(255,255,255,0.10); }
    .main {
      margin-left:96px;
      padding:20px;
      min-height:100vh;
      color:#0b1220;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border-radius:14px;
      box-shadow: 0 14px 34px rgba(2,6,23,0.16);
      padding:18px;
      overflow:hidden;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 18px 44px rgba(2,6,23,0.18); }

    /* Text bits */
    .stat-value { font-weight:800; font-size:1.25rem; letter-spacing:.2px; }
    .small-muted { color:var(--muted); font-size:0.92rem; }
    .ts { color: #065f46; font-weight:800; letter-spacing:.2px; }

    /* Buttons */
    .btn {
      background:var(--accent);
      color:white;
      padding:10px 14px;
      border-radius:10px;
      font-weight:700;
      border:none;
      box-shadow: 0 6px 16px rgba(79,70,229,.25);
    }
    .btn:hover { filter:brightness(1.05); }
    .btn-ghost {
      background:transparent;
      border:1px solid rgba(15,23,42,0.08);
      padding:8px 12px; border-radius:10px; font-weight:600;
    }

    /* Tables / lists */
    table { width:100%; border-collapse:collapse; }
    thead th { text-align:left; padding:10px 8px; font-weight:800; color:#334155; }
    tbody td { padding:10px 8px; border-top:1px solid #e6e7eb; color:#0f172a; }
    .payments-list li {
      padding:12px 0; border-bottom:1px dashed #eef2f7;
      display:flex; justify-content:space-between; align-items:center;
    }

    /* Badges */
    .badge { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:800; font-size:.82rem; letter-spacing:.2px; }
    .badge-ok{ background:#ecfdf5; color:var(--ok); }
    .badge-warn{ background:#fff7ed; color:var(--warn); }
    .badge-risk{ background:#fef2f2; color:var(--risk); }

    /* Skeletons */
    .skeleton {
      position:relative; overflow:hidden; background:#eef2ff; border-radius:10px; min-height:16px;
    }
    .skeleton::after{
      content:""; position:absolute; inset:0; transform:translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.7), transparent);
      animation: shimmer 1.6s infinite;
    }
    @keyframes shimmer{ 100% { transform: translateX(100%); } }

    /* Mobile */
    @media (max-width:1024px) {
      .main { margin-left:0; padding:14px; }
      .sidebar { position:sticky; top:0; width:100%; height:auto; flex-direction:row; justify-content:center; gap:10px; }
      .sidebar .icon { width:52px; height:52px; }
    }

    /* Reduce motion respect */
    @media (prefers-reduced-motion: reduce){
      .sidebar .icon:hover, .card:hover { transform:none; }
      .skeleton::after{ animation:none; }
    }
  </style>
</head>
<body>

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <img src="images/somap-logo.png.jpg" alt="SoMAp" style="width:48px;height:48px;border-radius:10px;object-fit:cover;">
    <div title="Market" class="icon" data-action="market" id="icon-market"><i class="fas fa-store"></i></div>
    <div title="Attendance" class="icon" data-action="attendance" id="icon-attendance"><i class="fas fa-calendar-check"></i></div>
    <div title="Fees" class="icon" data-action="fees" id="icon-fees"><i class="fas fa-money-bill-wave"></i></div>
    <div title="Books" class="icon" data-action="books" id="icon-books"><i class="fas fa-book"></i></div>
    <div id="preform-icon" title="Preform One" class="icon" style="display:none;" onclick="if(localStorage.getItem('preformParentIcon')) window.location.href='preformonehtml/prefoneparent.html';"><i class="fas fa-graduation-cap text-blue-500"></i></div>
    <div style="flex:1"></div>
    <div id="icon-logout" class="icon" title="Logout"><i class="fas fa-sign-out-alt"></i></div>
  </aside>

  <!-- MAIN -->
  <main class="main" id="main">
    <!-- header -->
    <div class="mb-4 flex items-center justify-between gap-3">
      <div>
        <h1 id="studentName" class="text-white font-extrabold text-[22px]" style="text-shadow:0 2px 6px rgba(0,0,0,0.18);">Parent Dashboard</h1>
        <div id="studentMeta" class="small-muted text-white/90">Loading student details…</div>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-right text-white">
          <div class="small-muted">Role</div>
          <div class="font-extrabold tracking-wide">Parent</div>
        </div>
        <button class="btn" id="openMarketTop">Open Market</button>
      </div>
    </div>

    <!-- STATS -->
    <div class="grid gap-3 grid-cols-[repeat(auto-fit,minmax(220px,1fr))] mb-4">
      <div class="card">
        <div class="small-muted">Total Fee (Year)</div>
        <div class="stat-value ts" id="statFeeDue">TSh 0</div>
        <div class="small-muted">Payment plan: <span id="statPaymentPlan">-</span></div>
      </div>
      <div class="card">
        <div class="small-muted">Total Paid</div>
        <div class="stat-value ts" id="statPaid">TSh 0</div>
        <div class="small-muted">To date • <span id="feeStatusBadge" class="badge badge-ok">OK</span></div>
      </div>
      <div class="card">
        <div class="small-muted">Balance</div>
        <div class="stat-value ts" id="statBalance">TSh 0</div>
        <div class="small-muted">Outstanding</div>
      </div>
      <div class="card">
        <div class="small-muted">Attendance (this student)</div>
        <div class="stat-value ts" id="statAttendancePct">0%</div>
        <div class="small-muted">Present / Total days</div>
      </div>
    </div>

    <!-- GRID -->
    <div class="grid gap-4" style="grid-template-columns: 1fr 360px;">
      <!-- LEFT -->
      <div class="flex flex-col gap-4">
        <!-- Payments -->
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="m-0 font-extrabold">Recent Payments</h3>
              <div class="small-muted">Last 10 payments</div>
            </div>
            <div>
              <button class="btn-ghost" id="refreshPayments">Refresh</button>
            </div>
          </div>
          <div class="mt-3">
            <ul class="payments-list" id="paymentsList">
              <li class="w-full"><div class="skeleton h-4 w-40"></div></li>
              <li class="w-full"><div class="skeleton h-4 w-56"></div></li>
              <li class="w-full"><div class="skeleton h-4 w-48"></div></li>
            </ul>
          </div>
        </div>

        <!-- Scores -->
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="m-0 font-extrabold">Exam Scores (latest)</h3>
              <div class="small-muted">Auto average • Exportable</div>
            </div>
            <div class="flex gap-2">
              <button class="btn-ghost" id="exportCsvBtn"><i class="fas fa-file-csv"></i> CSV</button>
              <button class="btn" id="exportPdfBtn"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>
          </div>

          <div class="mt-3 overflow-auto">
            <table id="scoresTable" class="min-w-full">
              <thead>
                <tr><th>Subject</th><th>Score</th><th>Max</th><th>%</th></tr>
              </thead>
              <tbody id="scoresTbody">
                <tr><td colspan="4" class="small-muted">No scores loaded.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="mt-3">
            <div class="chart-wrap card p-3">
              <canvas id="scoresChart" style="width:100%;height:200px;"></canvas>
            </div>
          </div>
        </div>

        <!-- Report Card -->
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="m-0 font-extrabold">Report Card</h3>
              <div class="small-muted">Generate downloadable report</div>
            </div>
            <div class="flex gap-2">
              <select id="reportExamSelect" class="btn-ghost px-3 py-2 rounded-[10px]">
                <option value="monthly">Monthly</option>
                <option value="term">Term</option>
              </select>
              <select id="reportMonth" class="btn-ghost px-3 py-2 rounded-[10px]">
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="01">January</option>
              </select>
              <button class="btn" id="genReportBtn"><i class="fas fa-download"></i> Download</button>
            </div>
          </div>
          <div class="mt-3" id="reportPreview">
            <div class="small-muted">Preview not available — click Generate to create PDF.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <aside class="flex flex-col gap-4">
        <div class="card">
          <h4 class="m-0 font-extrabold">Quick Actions</h4>
          <div class="flex flex-col gap-2 mt-2">
            <button class="btn" id="quickGenerateId">Generate ID</button>
            <button class="btn-ghost" id="quickReportCard">Open Current Report Card</button>
            <button class="btn-ghost" id="quickFees">View Fees Info</button>
          </div>
        </div>

        <div class="card">
          <h4 class="m-0 font-extrabold">Student Details</h4>
          <div class="mt-2 small-muted space-y-1">
            <div><strong>Class:</strong> <span id="detailClass">-</span></div>
            <div><strong>Stream:</strong> <span id="detailStream">-</span></div>
            <div><strong>Admission #:</strong> <span id="detailAdm">-</span></div>
            <div><strong>Parent phone:</strong> <span id="detailParentPhone">-</span></div>
          </div>
        </div>

        <div class="card">
          <h4 class="m-0 font-extrabold">Attendance Trend</h4>
          <div class="mt-2">
            <canvas id="attendanceChart" style="width:100%;height:160px;"></canvas>
          </div>
        </div>

        <div class="card">
          <h4 class="m-0 font-extrabold">Market</h4>
          <div class="small-muted mt-2">View uniforms, supplies and orders.</div>
          <button class="btn mt-2" id="viewMarketSmall">Open Market</button>
        </div>
      </aside>
    </div>

    <div class="text-white/70 mt-4 text-sm">SoMAp — All monetary values are shown in Tanzanian shillings (TSh).</div>
  </main>

  <script>
  /*************************************************************************
   * Parent Dashboard (UI-upgraded, logic-compatible)
   *************************************************************************/
  const firebaseConfig = {
    apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
    authDomain: "somaptestt.firebaseapp.com",
    databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
    projectId: "somaptestt",
    storageBucket: "somaptestt.appspot.com",
    messagingSenderId: "105526245138",
    appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
    measurementId: "G-4HKX7KN6Q3"
  };

  if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
  const db = firebase.database();

  // Utilities
  function fmtTsh(n){ const num = Number(n) || 0; return 'TSh ' + num.toLocaleString(); }
  function safe(s){ return s === undefined || s === null ? '' : String(s); }
  const q = sel => document.querySelector(sel);
  const qa = sel => Array.from(document.querySelectorAll(sel));

  // Element refs
  const studentNameEl = q('#studentName');
  const studentMetaEl = q('#studentMeta');
  const statFeeDue = q('#statFeeDue');
  const statPaid = q('#statPaid');
  const statBalance = q('#statBalance');
  const statAttendancePct = q('#statAttendancePct');
  const statPaymentPlan = q('#statPaymentPlan');
  const feeStatusBadge = q('#feeStatusBadge');

  const paymentsList = q('#paymentsList');
  const scoresTbody = q('#scoresTbody');
  const scoresChartCanvas = q('#scoresChart');
  const attendanceChartCanvas = q('#attendanceChart');

  const exportCsvBtn = q('#exportCsvBtn');
  const exportPdfBtn = q('#exportPdfBtn');
  const genReportBtn = q('#genReportBtn');

  const detailClass = q('#detailClass');
  const detailStream = q('#detailStream');
  const detailAdm = q('#detailAdm');
  const detailParentPhone = q('#detailParentPhone');

  const quickGenerateId = q('#quickGenerateId');
  const quickReportCard = q('#quickReportCard');
  const quickFees = q('#quickFees');
  const openMarketTop = q('#openMarketTop');
  const viewMarketSmall = q('#viewMarketSmall');

  // icons
  qa('.sidebar .icon').forEach(el => el.addEventListener('click', onSidebarIcon));
  q('#icon-logout').addEventListener('click', ()=> {
    localStorage.removeItem('studentKey');
    localStorage.removeItem('role');
    window.location.href = 'index.html';
  });

  // State
  let currentStudentKey = null;
  let currentStudent = null;
  let scoresChart = null;
  let attendanceChart = null;
  let __allPaymentsSum = 0;
  const CURRENT_YEAR = new Date().getFullYear();

  // Init
  (async function init(){
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const keyParam = urlParams.get('studentKey');
      const storageKey = localStorage.getItem('studentKey');

      if (keyParam) { currentStudentKey = keyParam; localStorage.setItem('studentKey', keyParam); }
      else if (storageKey) { currentStudentKey = storageKey; }
      else { window.location.href = 'index.html'; return; }

      const snap = await db.ref('students/' + currentStudentKey).once('value');
      if (!snap.exists()) {
        localStorage.removeItem('studentKey');
        window.location.href = 'index.html';
        return;
      }

      currentStudent = snap.val();
      await showParentDashboard();
      bindUI();
    } catch (err) {
      console.error('Init error', err);
      Swal.fire('Error', 'Failed to initialize dashboard. Please refresh the page.', 'error');
    }
  })();

  // Show Preform One icon for flagged parents
  if (localStorage.getItem('preformParentIcon') === 'true') {
    document.getElementById('preform-icon').style.display = 'flex';
  }

  async function showParentDashboard(){
    if (!currentStudent) {
      const snap = await db.ref('students/' + currentStudentKey).once('value');
      if (!snap.exists()) { window.location.href = 'index.html'; return; }
      currentStudent = snap.val();
    }

    // Header
    studentNameEl.textContent = `${safe(currentStudent.firstName)} ${safe(currentStudent.middleName || '')} ${safe(currentStudent.lastName)}`.replace(/\s+/g,' ').trim();
    studentMetaEl.textContent = `School: ${safe(currentStudent.schoolName || '-')}`;

    // Summary
    const feeDue = Number(currentStudent.feePerYear || currentStudent.feeDue || 0);
    const paidLocal = Number(currentStudent.paidAmount || calculateTotalPayments(currentStudent) || 0);
    statFeeDue.textContent = fmtTsh(feeDue);
    statPaid.textContent = fmtTsh(paidLocal);
    statBalance.textContent = fmtTsh(Math.max(0, feeDue - paidLocal));
    applyFeeBadge(feeDue, paidLocal);
    statPaymentPlan.textContent = safe(currentStudent.paymentPlan || '-');

    detailClass.textContent = safe(currentStudent.classLevel || '-');
    detailStream.textContent = safe(currentStudent.stream || '-');
    detailAdm.textContent = safe(currentStudent.admissionNumber || currentStudent.pupilId || '-');
    detailParentPhone.textContent = safe(currentStudent.primaryParentContact || '-');

    // Details
    await loadPaymentsAllSources(
      currentStudentKey,
      (currentStudent.admissionNumber || currentStudent.pupilId || currentStudentKey),
      (currentStudent.classLevel || ''),
      CURRENT_YEAR
    );
    await loadAttendanceForStudent(currentStudent.admissionNumber);
    await loadScoresForStudent(currentStudent.admissionNumber);

    renderAttendanceChart();
    renderScoresChart();
  }

  // Local student.payments fallback
  function calculateTotalPayments(student){
    if (!student) return 0;
    const payments = student.payments || {};
    let sum = 0;
    Object.values(payments).forEach(p => { sum += Number(p.amount || 0); });
    return sum;
  }

  // Fee badge
  function applyFeeBadge(feeDue, paid){
    const el = feeStatusBadge; if (!el) return;
    const bal = Math.max(0, feeDue - paid);
    el.className = 'badge ' + (bal <= 0 ? 'badge-ok' : (bal/Math.max(1,feeDue) <= .25 ? 'badge-warn' : 'badge-risk'));
    el.textContent = bal <= 0 ? 'PAID' : (bal/Math.max(1,feeDue) <= .25 ? 'DUE (low)' : 'DUE');
  }

  // Payments aggregator (adds common finance paths; non-breaking)
  function normalizePayment(p, sourceKey){
    const amt = Number(p?.amount || 0);
    let ts = Number(p?.timestamp || 0);
    if (!ts && p?.date){
      const t = Date.parse(p.date); if (!Number.isNaN(t)) ts = t;
    }
    if (!ts) ts = Date.now();
    return { amount: amt, timestamp: ts, method: p?.method || p?.mode || '-', note: p?.note || p?.remarks || '', _src: sourceKey || 'unknown' };
  }
  async function tryPathOnce(path){
    try{ const snap = await db.ref(path).once('value'); return snap.val() || null; } catch { return null; }
  }
  function dedupePayments(arr){
    const seen = new Set();
    return arr.filter(p=>{
      const key = `${p.amount}|${new Date(p.timestamp).toDateString()}|${p.method}|${p.note}`;
      if (seen.has(key)) return false; seen.add(key); return true;
    });
  }
  async function loadPaymentsAllSources(studentKey, admNo, classLevel, year){
    paymentsList.innerHTML = `
      <li class="w-full"><div class="skeleton h-4 w-40"></div></li>
      <li class="w-full"><div class="skeleton h-4 w-56"></div></li>
      <li class="w-full"><div class="skeleton h-4 w-48"></div></li>`;

    const paths = [
      `students/${studentKey}/payments`,
      `finance/${year}/${classLevel}/${admNo}/payments`,
      `fees/${year}/${admNo}/payments`,
      `payments/${admNo}`,
      `feesPayments/${admNo}`
    ];
    const results = await Promise.all(paths.map(p => tryPathOnce(p)));

    let merged = [];
    results.forEach((obj, idx) => {
      if (!obj) return;
      Object.values(obj).forEach(v => merged.push(normalizePayment(v, paths[idx])));
    });
    merged = dedupePayments(merged).sort((a,b)=> b.timestamp - a.timestamp);

    if (!merged.length){
      paymentsList.innerHTML = '<li class="small-muted">No payments recorded.</li>';
    } else {
      const max = Math.min(merged.length, 50);
      let html = '';
      for (let i=0;i<max;i++){
        const p = merged[i];
        html += `<li>
          <div>
            <div class="font-extrabold">${fmtTsh(p.amount)}</div>
            <div class="small-muted">${safe(p.method)} • ${safe(p.note)}</div>
          </div>
          <div class="small-muted text-right">${new Date(p.timestamp).toLocaleString()}</div>
        </li>`;
      }
      paymentsList.innerHTML = html;
    }

    // Recompute stats with best available total
    const aggSum = merged.reduce((s,p)=> s + (Number(p.amount)||0), 0);
    __allPaymentsSum = aggSum;
    const feeDue = Number(currentStudent?.feePerYear || currentStudent?.feeDue || 0);
    const paidLocal = Number(currentStudent?.paidAmount || calculateTotalPayments(currentStudent) || 0);
    const bestPaid = Math.max(aggSum, paidLocal);
    statPaid.textContent = fmtTsh(bestPaid);
    statBalance.textContent = fmtTsh(Math.max(0, feeDue - bestPaid));
    applyFeeBadge(feeDue, bestPaid);
  }

  // Attendance
  async function loadAttendanceForStudent(admNo){
    statAttendancePct.textContent = 'Calculating...';
    try {
      const snap = await db.ref('attendance').once('value');
      const obj = snap.val() || {};
      let present = 0, total = 0;
      const monthCounts = {};
      Object.values(obj).forEach(classObj => {
        Object.values(classObj || {}).forEach(monthObj => {
          Object.values(monthObj || {}).forEach(dayObj => {
            Object.values(dayObj || {}).forEach(rec => {
              try {
                const s = rec.snap;
                if (s && String(s.admissionNo) === String(admNo)) {
                  total++;
                  const daily = rec.daily || '';
                  if (daily === 'P' || daily === 'PS' || daily === 'PA' || daily === 'PS') present++;
                  const ts = rec.timestamp || rec.ts || null;
                  if (ts) {
                    const d = new Date(ts);
                    const m = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    monthCounts[m] = monthCounts[m] || {present:0,total:0};
                    monthCounts[m].total++;
                    if (daily === 'P' || daily === 'PS') monthCounts[m].present++;
                  }
                }
              } catch(e){}
            });
          });
        });
      });
      const pct = total ? Math.round((present/total)*100) : 0;
      statAttendancePct.textContent = pct + '%';
      window.__soMap_attendance_months = monthCounts;
      renderAttendanceChart();
    } catch (err){
      console.error('loadAttendanceForStudent error', err);
      statAttendancePct.textContent = '—';
    }
  }

  // Scores (latest)
  async function loadScoresForStudent(admNo){
    try {
      scoresTbody.innerHTML = '<tr><td colspan="4" class="small-muted">Loading scores…</td></tr>';
      const snap = await db.ref('scores').once('value');
      const root = snap.val() || {};
      let found = null;
      outer:
      for (const year of Object.keys(root).sort().reverse()){
        const classes = root[year] || {};
        for (const className of Object.keys(classes || {})){
          const examKeys = classes[className] || {};
          for (const examKey of Object.keys(examKeys || {})){
            const months = examKeys[examKey] || {};
            for (const monthKey of Object.keys(months || {}).sort().reverse()){
              const mdata = months[monthKey] || {};
              if (mdata && mdata[admNo]) { found = { year, className, examKey, monthKey, data: mdata[admNo] }; break outer; }
            }
          }
        }
      }
      if (!found){
        scoresTbody.innerHTML = '<tr><td colspan="4" class="small-muted">No scores found for this student.</td></tr>';
        window.__soMap_scores_for_chart = null;
        renderScoresChart();
        return;
      }
      const data = found.data;
      let rows = '';
      const labels = [];
      const values = [];
      Object.keys(data).forEach(subject => {
        const subj = data[subject] || {};
        const score = Number(subj.score || 0);
        const max = Number(subj.max || 100);
        const pct = max ? ((score/max)*100) : 0;
        rows += `<tr>
                  <td>${subject}</td>
                  <td>${score}</td>
                  <td>${max}</td>
                  <td>${pct.toFixed(1)}%</td>
                </tr>`;
        labels.push(subject);
        values.push(Number(pct.toFixed(1)));
      });
      scoresTbody.innerHTML = rows || '<tr><td colspan="4" class="small-muted">No subjects found.</td></tr>';
      window.__soMap_scores_for_chart = { labels, values, meta: found };
      renderScoresChart();
    } catch (err) {
      console.error('loadScoresForStudent error', err);
      scoresTbody.innerHTML = '<tr><td colspan="4" class="small-muted">Error loading scores.</td></tr>';
    }
  }

  // Charts
  function renderScoresChart(){
    const ctx = scoresChartCanvas.getContext('2d');
    if (scoresChart) scoresChart.destroy();
    const ds = window.__soMap_scores_for_chart;
    const labels = ds ? ds.labels : [];
    const values = ds ? ds.values : [];
    scoresChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '% (score / max)',
          data: values,
          backgroundColor: labels.map(()=> 'rgba(79,70,229,0.8)'),
          borderColor: labels.map(()=> 'rgba(79,70,229,1)'),
          borderWidth: 1
        }]
      },
      options: { responsive:true, scales: { y: { beginAtZero:true, max:100 } }, plugins:{ legend:{ display:false } } }
    });
  }

  function renderAttendanceChart(){
    const ctx = attendanceChartCanvas.getContext('2d');
    if (attendanceChart) attendanceChart.destroy();
    const months = window.__soMap_attendance_months || {};
    const keys = Object.keys(months).sort();
    const labels = keys;
    const values = keys.map(k => {
      const m = months[k] || {};
      const pct = (m.total && m.present) ? Math.round((m.present/m.total)*100) : 0;
      return pct;
    });
    attendanceChart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{ label:'Attendance %', data: values, tension:.35,
        borderColor:'rgba(16,185,129,0.9)', backgroundColor:'rgba(16,185,129,0.15)', pointRadius:4 }]},
      options:{ responsive:true, scales:{ y: { beginAtZero:true, max:100 } }, plugins:{ legend:{ display:false } } }
    });
  }

  // Exports
  exportCsvBtn.addEventListener('click', () => {
    if (!window.__soMap_scores_for_chart) { Swal.fire('No data','No scores to export','info'); return; }
    const labels = window.__soMap_scores_for_chart.labels;
    const values = window.__soMap_scores_for_chart.values;
    const arr = [['Subject','%']]; for (let i=0;i<labels.length;i++) arr.push([labels[i], values[i]]);
    const ws = XLSX.utils.aoa_to_sheet(arr);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Scores');
    const wbout = XLSX.write(wb,{bookType:'csv', type:'array'});
    const blob = new Blob([wbout], {type:'text/csv;charset=utf-8;'});
    const filename = `${currentStudent.admissionNumber || 'student'}_scores.csv`;
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
  });

  exportPdfBtn.addEventListener('click', async () => {
    if (!currentStudent) { Swal.fire('No student','Please sign in first','warning'); return; }
    const rows = [];
    document.querySelectorAll('#scoresTbody tr').forEach(tr => {
      const cols = Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
      if (cols.length) rows.push(cols);
    });
    if (!rows.length) { Swal.fire('No scores','No scores to export','info'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text(`${safe(currentStudent.firstName)} ${safe(currentStudent.lastName)} — Scores`, 14, 20);
    doc.autoTable({ startY: 30, head: [['Subject','Score','Max','%']], body: rows, styles:{fontSize:10} });
    const filename = `${currentStudent.admissionNumber||'student'}_scores.pdf`;
    doc.save(filename);
  });

  // Report-card buttons — open your existing single report page
  genReportBtn.addEventListener('click', () => openReportCard());
  quickReportCard.addEventListener('click', () => openReportCard());
  function openReportCard(){
    if (!currentStudent) { Swal.fire('No student','Please sign in first','warning'); return; }
    const phone = encodeURIComponent(currentStudent.primaryParentContact || '');
    const firstName = encodeURIComponent((currentStudent.firstName || '').toLowerCase().replace(/\s+/g, ''));
    const lastName = encodeURIComponent((currentStudent.lastName || '').toLowerCase().replace(/\s+/g, ''));
    const url = `Toacademichtml/singlereportcard.html?phone=${phone}&firstName=${firstName}&lastName=${lastName}`;
    window.open(url, '_blank');
  }

  // Quick actions
  quickGenerateId.addEventListener('click', () => {
    if (!currentStudent) { Swal.fire('No student', 'Please sign in first', 'warning'); return; }
    const phone = encodeURIComponent(currentStudent.primaryParentContact || '');
    const firstName = encodeURIComponent((currentStudent.firstName || '').toLowerCase().replace(/\s+/g, ''));
    const lastName = encodeURIComponent((currentStudent.lastName || '').toLowerCase().replace(/\s+/g, ''));
    const url = `ToSchoolerp/generateid.html?phone=${phone}&firstName=${firstName}&lastName=${lastName}`;
    window.open(url, '_blank');
  });
  quickFees.addEventListener('click', ()=> {
    Swal.fire({ title: 'Fees', html: `<div style="text-align:left">${statFeeDue.textContent}<br>${statPaid.textContent}<br>${statBalance.textContent}</div>` });
  });
  openMarketTop.addEventListener('click', ()=> window.open('market.html', '_blank'));
  viewMarketSmall.addEventListener('click', ()=> window.open('market.html', '_blank'));

  // Refresh payments uses the new aggregator
  q('#refreshPayments').addEventListener('click', ()=> {
    const admNo = (currentStudent?.admissionNumber || currentStudent?.pupilId || currentStudentKey);
    loadPaymentsAllSources(currentStudentKey, admNo, (currentStudent?.classLevel || ''), CURRENT_YEAR);
  });

  // Sidebar actions
  function handleAction(action){
    switch(action){
      case 'market':
        window.open('market.html', '_blank'); break;
      case 'attendance':
        if (!currentStudent) { Swal.fire('Error', 'Student data not loaded. Please sign in again.', 'error'); return; }
        const url = `Toattendancehtml/childattendance.html?class=${encodeURIComponent(currentStudent.classLevel || '')}&adm=${encodeURIComponent(currentStudent.admissionNumber || '')}`;
        const w = window.open(url, '_blank');
        if (!w) { Swal.fire('Error', 'Allow pop-ups to view attendance.', 'error'); return; }
        w.addEventListener('load', () => {
          w.document.documentElement.requestFullscreen?.().catch(()=>{});
        }, { once: true });
        break;
      case 'fees':
        Swal.fire({ title: 'Payments', html: paymentsList.innerHTML, width:800 }); break;
      case 'books':
        window.open('Bookshtml/childbook.html', '_blank'); break;
    }
  }
  function onSidebarIcon(ev){ handleAction(ev.currentTarget.dataset.action); }

  // Live updates: if student record changes
  db.ref('students').child(currentStudentKey).on('value', snap => {
    if (!snap.exists()){
      Swal.fire('Student removed', 'Student data was removed. You will be redirected to the login page.', 'warning').then(()=>{
        localStorage.removeItem('studentKey');
        window.location.href = 'index.html';
      });
      return;
    }
    currentStudent = snap.val();
    const feeDue = Number(currentStudent.feePerYear || currentStudent.feeDue || 0);
    const paidLocal = Number(currentStudent.paidAmount || calculateTotalPayments(currentStudent) || 0);
    const bestPaid = Math.max(paidLocal, __allPaymentsSum||0);
    statFeeDue.textContent = fmtTsh(feeDue);
    statPaid.textContent = fmtTsh(bestPaid);
    statBalance.textContent = fmtTsh(Math.max(0, feeDue - bestPaid));
    applyFeeBadge(feeDue, bestPaid);

    studentNameEl.textContent = `${safe(currentStudent.firstName)} ${safe(currentStudent.lastName)}`;
    detailClass.textContent = safe(currentStudent.classLevel || '-');
    detailStream.textContent = safe(currentStudent.stream || '-');
    detailAdm.textContent = safe(currentStudent.admissionNumber || '-');
    detailParentPhone.textContent = safe(currentStudent.primaryParentContact || '-');

    const admNo = (currentStudent.admissionNumber || currentStudent.pupilId || currentStudentKey);
    loadPaymentsAllSources(currentStudentKey, admNo, (currentStudent.classLevel || ''), CURRENT_YEAR);
  });

  function bindUI(){ /* hooks already wired */ }
  </script>
</body>
</html>
