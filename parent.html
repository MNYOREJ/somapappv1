<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp â€” Parent Dashboard</title>

  <!-- Tailwind CDN (for quick styling) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <!-- jsPDF (for PDF export) and autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- SheetJS (xlsx) for CSV/Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- SweetAlert2 for alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* extra custom */
    body { background: linear-gradient(135deg,#0ea5e9,#7c3aed); min-height:100vh; }
    /* container card */
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,250,0.92));
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.35);
      color: #0f172a;
    }
    .card-accent { background: linear-gradient(135deg,#22c55e,#06b6d4); color: white; }
    .price { font-weight: 700; font-size: 1.25rem; }
    .ts { font-size: .95rem; color: #065f46; font-weight:600; }
    .small-muted { font-size:.85rem; color: #6b7280; }
    .sidebar { width:64px; }
    .sidebar-expanded { width:260px; }
    .sidebar .icon {
      width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;
    }
    .sidebar .icon:hover { transform: translateY(-3px); }
    .hide { display:none; }
    /* responsive tweaks */
    @media (max-width: 1024px) {
      .desktop-only { display:none; }
    }
  </style>
</head>
<body class="antialiased">

  <!-- Page Layout: fixed sidebar + main content -->
  <div id="app" class="min-h-screen flex">

    <!-- Sidebar (hidden until logged-in) -->
    <aside id="sidebar" class="sidebar hidden fixed left-0 top-0 bottom-0 bg-gradient-to-b from-orange-400 to-yellow-300 p-2 z-40">
      <div class="flex flex-col items-center gap-4 pt-4">
        <img src="images/somap-logo.png.jpg" alt="SoMAp" class="w-10 h-10 rounded-full shadow-sm">
        <div id="sidebarIcons" class="flex flex-col gap-2 w-full">
          <button data-action="market" class="icon hover:shadow-md" title="Market">
            <i class="fas fa-store text-white"></i>
          </button>
          <button data-action="academics" class="icon hover:shadow-md" title="Academics">
            <i class="fas fa-user-graduate text-white"></i>
          </button>
          <button data-action="fees" class="icon hover:shadow-md" title="Fees">
            <i class="fas fa-money-bill-wave text-white"></i>
          </button>
          <button data-action="generate-id" class="icon hover:shadow-md" title="Generate ID">
            <i class="fas fa-id-card text-white"></i>
          </button>
          <button data-action="reportcard" class="icon hover:shadow-md" title="Report Card">
            <i class="fas fa-file-export text-white"></i>
          </button>
        </div>

        <div class="flex-1"></div>

        <button id="logoutBtn" class="w-full bg-white/20 text-white rounded-md py-2 px-3 hover:bg-white/30">
          <i class="fas fa-sign-out-alt mr-2"></i> Logout
        </button>
      </div>
    </aside>

    <!-- Main content -->
    <main id="main" class="flex-1 pl-0 lg:pl-20 pt-6 pb-12 px-4 lg:px-10">
      <!-- Welcome / Login area (visible before login) -->
      <div id="welcomeArea" class="max-w-4xl mx-auto glass p-6">
        <div class="flex flex-col lg:flex-row gap-6 items-center">
          <div class="flex-1">
            <h1 class="text-3xl font-bold text-slate-800">Welcome to <span class="text-indigo-600">SoMAp</span></h1>
            <p class="mt-2 text-slate-600">Parent portal â€” access your childâ€™s academic reports, attendance, fees and marketplace. Sign in using the phone number registered with the school and the child's two names (first + last).</p>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block small-muted mb-1">Parent Phone (exact)</label>
                <input id="parentPhoneInput" placeholder="+255..." class="w-full p-3 rounded-md border border-slate-200" />
              </div>
              <div>
                <label class="block small-muted mb-1">Child Name (two names)</label>
                <input id="childNameInput" placeholder="e.g., Rehema Mlekwa" class="w-full p-3 rounded-md border border-slate-200" />
              </div>
            </div>

            <div class="mt-4 flex gap-3">
              <button id="parentLoginBtn" class="bg-indigo-600 text-white px-5 py-3 rounded-md shadow hover:bg-indigo-700">
                Sign in as Parent
              </button>
              <button id="demoBtn" class="bg-white text-indigo-600 px-4 py-3 rounded-md shadow hover:bg-slate-50">
                Demo (auto load example)
              </button>
            </div>

            <div class="mt-6 text-sm text-slate-500">
              <p><strong>Note:</strong> Enter exactly two names (first + last) of the child and the registered parent phone number. Case does not matter.</p>
            </div>
          </div>

          <div class="w-full lg:w-96">
            <div class="card-accent p-4 rounded-lg">
              <h3 class="text-white text-lg font-semibold">Quick Parent Tips</h3>
              <ul class="mt-3 text-white/90 list-disc list-inside">
                <li>Generate and print your childâ€™s school ID.</li>
                <li>Download exam report as PDF or CSV.</li>
                <li>See recent payments & attendance percentage for this month.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Parent Dashboard (hidden until login) -->
      <section id="parentDashboard" class="mt-8 hidden">
        <!-- Top header -->
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
          <div>
            <h2 id="pdStudentName" class="text-2xl font-bold text-white"></h2>
            <div id="pdStudentMeta" class="text-slate-100 small-muted"></div>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-white small-muted">
              <div>Role: <span class="font-semibold">Parent</span></div>
            </div>
            <div>
              <button id="openMarketBtn" class="bg-white/10 text-white px-4 py-2 rounded-md hover:bg-white/20">
                View Market
              </button>
            </div>
          </div>
        </div>

        <!-- Stats row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="glass p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="small-muted">Fee Due (year)</div>
                <div class="price ts" id="statFeeDue">TSh 0</div>
                <div class="small-muted mt-1">Payment plan: <span id="statPaymentPlan">-</span></div>
              </div>
              <div class="text-3xl text-slate-700">ðŸ’³</div>
            </div>
          </div>

          <div class="glass p-4">
            <div>
              <div class="small-muted">Paid</div>
              <div class="price ts" id="statPaid">TSh 0</div>
              <div class="small-muted mt-1">Total paid to date</div>
            </div>
          </div>

          <div class="glass p-4">
            <div>
              <div class="small-muted">Balance</div>
              <div class="price ts" id="statBalance">TSh 0</div>
              <div class="small-muted mt-1">Outstanding</div>
            </div>
          </div>

          <div class="glass p-4">
            <div>
              <div class="small-muted">Attendance (This month)</div>
              <div class="price ts" id="statAttendancePct">0%</div>
              <div class="small-muted mt-1">Present / Total days</div>
            </div>
          </div>
        </div>

        <!-- Grid: left main + right small cards -->
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- Left big column (main details) -->
          <div class="lg:col-span-2 space-y-4">
            <!-- Payments & recent activities -->
            <div class="glass p-4">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-slate-800">Recent Payments</h3>
                <div class="small-muted">Showing last 10 payments</div>
              </div>
              <div id="paymentsList" class="mt-3"></div>
            </div>

            <!-- Scores (table + export) -->
            <div class="glass p-4">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-slate-800">Exam Scores (latest month)</h3>
                <div class="flex gap-2">
                  <button id="exportCsvBtn" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">Export CSV</button>
                  <button id="exportPdfBtn" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">Export PDF</button>
                </div>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table id="scoresTable" class="min-w-full text-sm">
                  <thead>
                    <tr class="bg-slate-100">
                      <th class="p-2 text-left">Subject</th>
                      <th class="p-2 text-left">Score</th>
                      <th class="p-2 text-left">Max</th>
                      <th class="p-2 text-left">%</th>
                    </tr>
                  </thead>
                  <tbody id="scoresTbody"></tbody>
                </table>
                <div id="scoresEmpty" class="text-slate-500 mt-2">No scores found.</div>
              </div>
            </div>

            <!-- Report card preview + generate -->
            <div class="glass p-4">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-slate-800">Report Card</h3>
                <div class="small-muted">Generate downloadable report card</div>
              </div>

              <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div>
                  <label class="block small-muted mb-1">Exam</label>
                  <select id="reportExamSelect" class="w-full p-2 border rounded">
                    <option value="monthly">Monthly</option>
                    <option value="term">Term</option>
                  </select>
                </div>
                <div>
                  <label class="block small-muted mb-1">Month</label>
                  <select id="reportMonth" class="w-full p-2 border rounded">
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="01">January</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <button id="genReportBtn" class="w-full bg-indigo-600 text-white py-2 rounded">Download Report (PDF)</button>
                </div>
              </div>

            </div>
          </div>

          <!-- Right small column -->
          <div class="space-y-4">
            <div class="glass p-4">
              <h4 class="font-semibold">Quick Actions</h4>
              <div class="mt-3 flex flex-col gap-2">
                <button data-action="generate-id" class="px-3 py-2 bg-emerald-500 text-white rounded">Generate ID</button>
                <button data-action="reportcard" class="px-3 py-2 bg-cyan-500 text-white rounded">Report Card PDF</button>
                <button data-action="fees" class="px-3 py-2 bg-yellow-500 text-white rounded">Pay / View Fees</button>
              </div>
            </div>

            <div class="glass p-4">
              <h4 class="font-semibold">Student Details</h4>
              <div class="mt-2 text-slate-700 small-muted">
                <div><strong>Class:</strong> <span id="detailClass">-</span></div>
                <div><strong>Stream:</strong> <span id="detailStream">-</span></div>
                <div><strong>Admission #:</strong> <span id="detailAdm">-</span></div>
                <div><strong>Parent contact:</strong> <span id="detailParentPhone">-</span></div>
              </div>
            </div>

            <div class="glass p-4">
              <h4 class="font-semibold">Marketplace</h4>
              <div class="mt-2 small-muted">View uniforms, supplies and orders in SoMAp Market.</div>
              <button id="viewMarketSmall" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded">Open Market</button>
            </div>

          </div>
        </div>
      </section>

      <!-- Hidden printable ID template -->
      <div id="idPrintArea" class="hidden">
        <div id="idCardTemplate" style="width:350px; border:1px solid #222; padding:12px; font-family: Arial;">
          <div style="display:flex; gap:10px; align-items:center;">
            <img src="images/somap-logo.png.jpg" style="width:64px; height:64px; object-fit:cover; border-radius:8px;">
            <div>
              <div style="font-size:18px; font-weight:700;">SoMAp School ID</div>
              <div id="idCardName" style="font-size:16px; margin-top:6px;"></div>
              <div id="idCardClass" style="font-size:14px; margin-top:4px;"></div>
              <div id="idCardAdm" style="font-size:12px; margin-top:4px;"></div>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- ======= Firebase + App Logic ======= -->
  <script>
    /*******************************
     *  Configuration (Firebase)
     *  Replace config if you want to change project
     *******************************/
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };

    // Initialize Firebase (compat)
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    /*******************************
     *  Helper utilities
     *******************************/
    function fmtTsh(n) {
      if (n === null || n === undefined) return "TSh 0";
      const num = Number(n) || 0;
      return "TSh " + num.toLocaleString();
    }
    function safeText(s){ return s === undefined || s === null ? "" : String(s); }

    // Query selectors
    const welcomeArea = document.getElementById('welcomeArea');
    const parentDashboard = document.getElementById('parentDashboard');
    const sidebar = document.getElementById('sidebar');
    const sidebarIcons = document.getElementById('sidebarIcons');
    const logoutBtn = document.getElementById('logoutBtn');

    // Login fields
    const parentPhoneInput = document.getElementById('parentPhoneInput');
    const childNameInput = document.getElementById('childNameInput');
    const parentLoginBtn = document.getElementById('parentLoginBtn');
    const demoBtn = document.getElementById('demoBtn');

    // Stats fields
    const statFeeDue = document.getElementById('statFeeDue');
    const statPaid = document.getElementById('statPaid');
    const statBalance = document.getElementById('statBalance');
    const statAttendancePct = document.getElementById('statAttendancePct');
    const statPaymentPlan = document.getElementById('statPaymentPlan');

    // Other UI
    const pdStudentName = document.getElementById('pdStudentName');
    const pdStudentMeta = document.getElementById('pdStudentMeta');
    const paymentsList = document.getElementById('paymentsList');
    const scoresTbody = document.getElementById('scoresTbody');
    const scoresEmpty = document.getElementById('scoresEmpty');
    const scoresTable = document.getElementById('scoresTable');

    // Report card controls
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const genReportBtn = document.getElementById('genReportBtn');
    const reportExamSelect = document.getElementById('reportExamSelect');
    const reportMonth = document.getElementById('reportMonth');

    // Student details
    const detailClass = document.getElementById('detailClass');
    const detailStream = document.getElementById('detailStream');
    const detailAdm = document.getElementById('detailAdm');
    const detailParentPhone = document.getElementById('detailParentPhone');

    // ID generation area
    const idPrintArea = document.getElementById('idPrintArea');
    const idCardName = document.getElementById('idCardName');
    const idCardClass = document.getElementById('idCardClass');
    const idCardAdm = document.getElementById('idCardAdm');

    // state
    let currentStudent = null; // will hold the student record object and key
    let currentStudentKey = null;

    /*******************************
     *  Parent login: by two names + phone
     *******************************/
    parentLoginBtn.addEventListener('click', async () => {
      const phone = (parentPhoneInput.value || "").trim();
      const name = (childNameInput.value || "").trim();

      if (!phone || !name) {
        Swal.fire("Missing data","Please enter the parent phone and child's two names.","warning");
        return;
      }

      // require at least two name tokens
      const tokens = name.split(/\s+/).filter(Boolean);
      if (tokens.length < 2) {
        Swal.fire("Two names required","Please enter the child's first and last name (two names).","warning");
        return;
      }

      Swal.fire({ title: "Checking...", text: "Looking up student record", didOpen: () => Swal.showLoading() });

      try {
        // Query students equal to possible matches on primaryParentContact
        const studentsSnap = await db.ref('students').orderByChild('primaryParentContact').equalTo(phone).once('value');
        const studentsObj = studentsSnap.val();
        if (!studentsObj) {
          Swal.fire("Not found","No student found registered with this phone number.", "error");
          return;
        }

        // find matching name ignoring case and punctuation. Accept partial matches where first and last present
        const wantedLower = tokens.map(t => t.toLowerCase());
        let matchedKey = null;
        let matchedStudent = null;
        Object.entries(studentsObj).some(([k, s]) => {
          const fullname = `${safeText(s.firstName)} ${safeText(s.lastName)}`.toLowerCase();
          // require both tokens present in fullname
          const ok = wantedLower.every(tok => fullname.includes(tok));
          if (ok) { matchedKey = k; matchedStudent = s; return true; }
          return false;
        });

        if (!matchedStudent) {
          Swal.fire("No match","Phone matches but child name did not match. Please check spelling or use different name format.", "error");
          return;
        }

        // success
        currentStudentKey = matchedKey;
        currentStudent = matchedStudent;
        // Save session (localStorage) so reload persists
        localStorage.setItem('somap_parent_logged_in', '1');
        localStorage.setItem('somap_parent_student_key', currentStudentKey);

        Swal.close();
        showParentDashboard();
      } catch (err) {
        console.error("Login error", err);
        Swal.fire("Error","Failed to query database. See console.", "error");
      }
    });

    // Demo button: picks first student in DB for easy demo
    demoBtn.addEventListener('click', async () => {
      Swal.fire({title:"Loading demo...", didOpen: () => Swal.showLoading()});
      try {
        const snap = await db.ref('students').limitToFirst(1).once('value');
        const obj = snap.val();
        if (!obj) { Swal.fire("No students","No students available in DB for demo", "error"); return; }
        const [k,s] = Object.entries(obj)[0];
        currentStudentKey = k; currentStudent = s;
        localStorage.setItem('somap_parent_logged_in', '1');
        localStorage.setItem('somap_parent_student_key', currentStudentKey);
        Swal.close();
        showParentDashboard();
      } catch(e){ console.error(e); Swal.fire("Error","Unable to load demo"); }
    });

    /*******************************
     *  Show dashboard and load data
     *******************************/
    async function showParentDashboard(){
      // UI toggle
      welcomeArea.classList.add('hide');
      parentDashboard.classList.remove('hidden');
      sidebar.classList.remove('hidden');
      sidebar.classList.add('block');

      // fill header data
      const s = await db.ref('students/' + currentStudentKey).once('value').then(snap => snap.val());
      currentStudent = s;
      pdStudentName.textContent = `${safeText(s.firstName)} ${safeText(s.middleName || '')} ${safeText(s.lastName)}`.replace(/\s+/g,' ');
      pdStudentMeta.innerHTML = `<span class="small-muted">School: ${safeText(s.schoolName || 'â€”')}</span>`;

      // summary stats
      statFeeDue.textContent = fmtTsh(s.feePerYear || s.feeDue || 0);
      statPaid.textContent = fmtTsh(s.paidAmount || 0);
      statBalance.textContent = fmtTsh(s.balance || ( (s.feePerYear || 0) - (s.paidAmount || 0) ) );
      statPaymentPlan.textContent = safeText(s.paymentPlan || '-');
      detailClass.textContent = safeText(s.classLevel || '-');
      detailStream.textContent = safeText(s.stream || '-');
      detailAdm.textContent = safeText(s.admissionNumber || '-');
      detailParentPhone.textContent = safeText(s.primaryParentContact || '-');

      // load payments & recent activities
      loadPayments(currentStudentKey);

      // attendance stats for current month (simple approach: search in attendance node for this admission No)
      loadAttendanceForStudent(currentStudent.admissionNumber);

      // load latest scores
      await loadScoresForStudent(currentStudent.admissionNumber);

      // mark sidebar active & bind icons
      bindSidebarActions();

      // make quick-actions clickable
      document.querySelectorAll('[data-action]').forEach(b=>{
        b.addEventListener('click', (ev)=> {
          const action = b.dataset.action;
          handleAction(action);
        });
      });
    }

    /*******************************
     *  Load payments for this student
     *******************************/
    async function loadPayments(studentKey){
      paymentsList.innerHTML = '<div class="text-slate-500">Loading payments...</div>';
      try {
        // The student record contains a "payments" object with child payments (from your sample)
        const studSnap = await db.ref('students/' + studentKey + '/payments').once('value');
        const payments = studSnap.val() || {};
        // Convert to array, sort descending by timestamp (if present)
        const arr = Object.values(payments).map(p => ({...p})).sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
        if (arr.length === 0) paymentsList.innerHTML = '<div class="text-slate-500">No payments recorded.</div>';
        else {
          let html = '<ul class="divide-y">';
          arr.forEach(p => {
            const date = p.timestamp ? new Date(p.timestamp).toLocaleString() : 'â€”';
            html += `<li class="py-2 flex justify-between items-start">
                      <div>
                        <div class="font-semibold">${fmtTsh(p.amount)}</div>
                        <div class="small-muted">${safeText(p.method || 'â€”')} â€¢ ${safeText(p.note || '')}</div>
                      </div>
                      <div class="small-muted text-right">${date}</div>
                    </li>`;
          });
          html += '</ul>';
          paymentsList.innerHTML = html;
        }
      } catch(err) {
        console.error("Load payments error", err);
        paymentsList.innerHTML = '<div class="text-red-500">Error loading payments.</div>';
      }
    }

    /*******************************
     *  Attendance loader (simple aggregated)
     *******************************/
    async function loadAttendanceForStudent(admNo) {
      statAttendancePct.textContent = 'Calculating...';
      // We will scan attendance node and find occurrences where snap.admissionNo === admNo
      // For performance, we search under top-level attendance branches (classes) -- but we do a simple search across attendance.
      try {
        const attendanceSnap = await db.ref('attendance').once('value');
        const attendanceObj = attendanceSnap.val() || {};
        // iterate through nested: class -> month -> day -> recordKey -> {snap: {...}}
        let present = 0, total = 0;
        Object.values(attendanceObj).forEach(classObj => {
          Object.values(classObj || {}).forEach(monthObj => {
            Object.values(monthObj || {}).forEach(dayObj => {
              Object.values(dayObj || {}).forEach(record => {
                const snap = record.snap;
                if (snap && String(snap.admissionNo) === String(admNo)) {
                  total++;
                  if (record.daily === 'P' || record.daily === 'PS') present++;
                }
              });
            });
          });
        });
        const pct = total ? Math.round((present/total)*100) : 0;
        statAttendancePct.textContent = pct + '%';
      } catch(e){
        console.error(e);
        statAttendancePct.textContent = 'â€”';
      }
    }

    /*******************************
     *  Load scores for the student (latest month)
     *******************************/
    async function loadScoresForStudent(admNo) {
      scoresTbody.innerHTML = '';
      scoresEmpty.style.display = 'block';
      try {
        // logic: look under scores -> find latest year -> class -> monthly -> month (we will search the structure)
        const scoresSnap = await db.ref('scores').once('value');
        const scoresRoot = scoresSnap.val() || {};

        // find first matching entry for this student: traverse years -> classes -> examkey -> months -> student
        let found = null;
        outer:
        for (const year of Object.keys(scoresRoot).sort().reverse()) {
          const byClass = scoresRoot[year];
          for (const className of Object.keys(byClass || {})) {
            const examKeys = byClass[className];
            for (const examKey of Object.keys(examKeys || {})) {
              const months = examKeys[examKey];
              for (const monthKey of Object.keys(months || {}).sort().reverse()) {
                const monthData = months[monthKey];
                if (monthData && monthData[admNo]) {
                  found = { year, className, examKey, monthKey, data: monthData[admNo] };
                  break outer;
                }
              }
            }
          }
        }

        if (!found) {
          scoresEmpty.style.display = 'block';
          scoresEmpty.textContent = 'No scores found for the student.';
          return;
        }

        // populate table with subjects
        scoresEmpty.style.display = 'none';
        const data = found.data;
        let html = '';
        Object.keys(data).forEach(subject => {
          const subj = data[subject];
          const score = subj.score || 0;
          const max = subj.max || subj.max || 100;
          const pct = max ? ((score/max)*100).toFixed(1) : '0.0';
          html += `<tr>
                    <td class="p-2 border">${subject}</td>
                    <td class="p-2 border">${score}</td>
                    <td class="p-2 border">${max}</td>
                    <td class="p-2 border">${pct}%</td>
                  </tr>`;
        });
        scoresTbody.innerHTML = html;
      } catch(e){ console.error(e); scoresEmpty.textContent = 'Error loading scores'; }
    }

    /*******************************
     *  Export CSV & PDF (report card)
     *******************************/
    exportCsvBtn.addEventListener('click', () => {
      if (!currentStudent) { Swal.fire('No student','Please sign in first','warning'); return; }
      // gather table rows
      const rows = [];
      document.querySelectorAll('#scoresTbody tr').forEach(tr => {
        const cols = Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
        rows.push(cols);
      });
      if (rows.length === 0) { Swal.fire('No scores','Nothing to export','info'); return; }
      // prepare sheet
      const data = [["Subject","Score","Max","%"], ...rows];
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Report");
      const wbout = XLSX.write(wb, {bookType:'csv', type:'array'});
      const blob = new Blob([wbout], {type: 'text/csv;charset=utf-8;'});
      const filename = `${currentStudent.admissionNumber || 'report'}_scores.csv`;
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      URL.revokeObjectURL(a.href);
    });

    exportPdfBtn.addEventListener('click', async () => {
      if (!currentStudent) { Swal.fire('No student','Please sign in first','warning'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text(`${safeText(currentStudent.firstName)} ${safeText(currentStudent.lastName)} â€” Report`, 14, 20);

      // collect data
      const head = [["Subject","Score","Max","%"]];
      const body = [];
      document.querySelectorAll('#scoresTbody tr').forEach(tr => {
        const cols = Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
        body.push(cols);
      });
      if (body.length === 0) { Swal.fire('No scores','Nothing to export','info'); return; }

      doc.autoTable({ startY: 28, head: head, body: body, styles: { fontSize:10 }});
      doc.save(`${currentStudent.admissionNumber || 'report'}_report.pdf`);
    });

    /*******************************
     *  Generate report PDF (full)
     *******************************/
    genReportBtn.addEventListener('click', async () => {
      if (!currentStudent) { Swal.fire('No student','Please sign in first','warning'); return; }
      const exam = reportExamSelect.value || 'monthly';
      const month = reportMonth.value || '08';
      // build a simple report: student header, scores table, attendance %
      Swal.fire({ title: 'Generating...', didOpen: () => Swal.showLoading() });
      try {
        // reuse current scores loaded
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({unit:'pt', format:'A4'});
        doc.setFontSize(18);
        doc.text("SoMAp Report Card", 40, 50);
        doc.setFontSize(12);
        doc.text(`Student: ${safeText(currentStudent.firstName)} ${safeText(currentStudent.lastName)}`, 40, 80);
        doc.text(`Admission: ${safeText(currentStudent.admissionNumber)}`, 40, 96);
        doc.text(`Class: ${safeText(currentStudent.classLevel)} â€¢ Stream: ${safeText(currentStudent.stream)}`, 40, 112);
        doc.text(`Month: ${month} â€¢ Exam: ${exam}`, 40, 128);

        // prepare table
        const body = [];
        document.querySelectorAll('#scoresTbody tr').forEach(tr=> {
          const cols = Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
          body.push(cols);
        });
        if (body.length === 0) {
          Swal.fire('No scores','No scores available to build a report', 'info');
          return;
        }
        doc.autoTable({ startY: 150, head: [["Subject","Score","Max","%"]], body, styles:{fontSize:10} });

        // footer with attendance & fees
        const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 260;
        doc.setFontSize(11);
        doc.text(`Attendance this month: ${statAttendancePct.textContent}`, 40, finalY);
        doc.text(`Fee Due: ${statFeeDue.textContent} â€¢ Paid: ${statPaid.textContent} â€¢ Balance: ${statBalance.textContent}`, 40, finalY + 16);

        const filename = `${currentStudent.admissionNumber || 'report'}_reportcard.pdf`;
        doc.save(filename);
        Swal.close();
      } catch(e){ console.error(e); Swal.fire('Error','Failed to generate report card'); }
    });

    /*******************************
     *  Sidebar & quick action handler
     *******************************/
    function bindSidebarActions(){
      document.querySelectorAll('#sidebar [data-action]').forEach(btn => {
        btn.onclick = (ev) => handleAction(btn.dataset.action);
      });
      document.getElementById('openMarketBtn').onclick = () => handleAction('market');
      document.getElementById('viewMarketSmall').onclick = () => handleAction('market');
      // logout
      logoutBtn.addEventListener('click', ()=> {
        localStorage.removeItem('somap_parent_logged_in');
        localStorage.removeItem('somap_parent_student_key');
        location.reload();
      });
    }

    function handleAction(action){
      if (!currentStudent && action !== 'market') { Swal.fire('Not signed in','Please sign in to use this action'); return; }
      switch(action){
        case 'market':
          // open market page (if you have market page)
          window.open('market.html', '_blank'); // or replace with your market path
          break;
        case 'academics':
          // open schoolerp/academic area restricted to parent view of student's class (if you have page)
          // In absence of a page, show a message
          Swal.fire('Academics','This opens class academic view (coming soon)','info');
          break;
        case 'fees':
          // open finance page or show a modal. We'll open finance.html in new tab (if present)
          window.open('finance.html', '_blank');
          break;
        case 'generate-id':
          generateIdCard();
          break;
        case 'reportcard':
          // trigger direct report PDF download
          genReportBtn.click();
          break;
      }
    }

    /*******************************
     *  ID generation / print
     *******************************/
    function generateIdCard(){
      if (!currentStudent) { Swal.fire('No student','Sign in first','warning'); return; }
      idCardName.textContent = `${safeText(currentStudent.firstName)} ${safeText(currentStudent.lastName)}`;
      idCardClass.textContent = `Class: ${safeText(currentStudent.classLevel)} â€¢ Stream: ${safeText(currentStudent.stream)}`;
      idCardAdm.textContent = `ADM: ${safeText(currentStudent.admissionNumber)}`;
      // produce PDF or print
      const el = document.getElementById('idCardTemplate');
      // open print window with content
      const w = window.open('', '_blank', 'width=420,height=280');
      w.document.write(`<html><head><title>ID</title></head><body>${el.innerHTML}</body></html>`);
      w.document.close();
      w.focus();
      setTimeout(()=>{ w.print(); }, 500);
    }

    /*******************************
     *  Session persistence: if logged in previously, restore
     *******************************/
    (async function restoreSession(){
      const logged = localStorage.getItem('somap_parent_logged_in');
      const key = localStorage.getItem('somap_parent_student_key');
      if (logged && key) {
        try {
          // check existence
          const snap = await db.ref('students/' + key).once('value');
          if (snap.exists()) {
            currentStudentKey = key;
            currentStudent = snap.val();
            welcomeArea.classList.add('hide');
            showParentDashboard();
          } else {
            // clear invalid
            localStorage.removeItem('somap_parent_logged_in');
            localStorage.removeItem('somap_parent_student_key');
          }
        } catch(e){ console.error(e); }
      }
    })();

    /*******************************
     *  Small UI: allow clicking rows / icons
     *******************************/
    // When clicking the top left sidebar icon area: expand sidebar details (not necessary now)
    sidebarIcons.addEventListener('click', (ev)=> {
      const btn = ev.target.closest('button[data-action]');
      if (btn) handleAction(btn.dataset.action);
    });

  </script>
</body>
</html>
