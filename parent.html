<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoMAp - Parent Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #ffebee 0%, #fff3e0 100%);
            min-height: 100vh;
        }
        .sidebar {
            width: 80px;
            background: linear-gradient(to bottom, #ff6b6b, #ff8e53);
            height: 100vh;
            position: fixed;
            padding: 1rem 0;
            transition: width 0.3s ease;
        }
        .sidebar.expanded { width: 250px; }
        .sidebar-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            margin: 10px auto;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .sidebar-icon:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .sidebar-tooltip {
            position: absolute;
            left: 60px;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .sidebar-icon:hover .sidebar-tooltip { opacity: 1; }
        .main-content {
            margin-left: 100px;
            padding: 1rem;
            transition: margin-left 0.3s ease;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #ff6b6b;
        }
        .card.academic { border-left-color: #4caf50; }
        .card.attendance { border-left-color: #ffc107; }
        .card.finance { border-left-color: #2196f3; }
        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(255,107,107,0.3); }
        .btn-secondary { background: linear-gradient(45deg, #6c757d, #495057); }
        .btn-secondary:hover { box-shadow: 0 4px 8px rgba(108,117,125,0.3); }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .table th, .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .table th { background: #f8f9fa; font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .stat-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 { font-size: 2rem; margin-bottom: 0.5rem; }
        .section { display: none; }
        .section.active { display: block; }
        #sidebar-toggle {
            position: fixed;
            left: 90px;
            top: 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1000;
        }
        #chartScores { max-width:100%; height:260px; }
    </style>
</head>
<body>
    <button id="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
   
    <div class="flex">
        <div id="sidebar" class="sidebar">
            <img src="images/somap-logo.png.jpg" alt="SoMAp Logo" class="h-12 mx-auto mb-6 rounded-full shadow-lg">
           
            <!-- Dashboard Icon -->
            <div class="sidebar-icon" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt text-xl"></i>
                <span class="sidebar-tooltip">Dashboard</span>
            </div>
           
            <!-- Academics Icon -->
            <div class="sidebar-icon" onclick="showSection('academics')">
                <i class="fas fa-book text-xl"></i>
                <span class="sidebar-tooltip">Academics</span>
            </div>
           
            <!-- Attendance Icon -->
            <div class="sidebar-icon" onclick="showSection('attendance')">
                <i class="fas fa-calendar-check text-xl"></i>
                <span class="sidebar-tooltip">Attendance</span>
            </div>
           
            <!-- Fees Icon -->
            <div class="sidebar-icon" onclick="showSection('fees')">
                <i class="fas fa-money-bill text-xl"></i>
                <span class="sidebar-tooltip">Fees & Payments</span>
            </div>
           
            <!-- Report Cards Icon -->
            <div class="sidebar-icon" onclick="showSection('reports')">
                <i class="fas fa-file-alt text-xl"></i>
                <span class="sidebar-tooltip">Report Cards</span>
            </div>
           
            <!-- Market Icon (assuming link to market) -->
            <div class="sidebar-icon" onclick="showSection('market')">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span class="sidebar-tooltip">Market</span>
            </div>
           
            <!-- Logout -->
            <div class="sidebar-icon mt-auto" onclick="logout()">
                <i class="fas fa-sign-out-alt text-xl"></i>
                <span class="sidebar-tooltip">Logout</span>
            </div>
        </div>
       
        <div class="main-content">
            <header class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Parent Dashboard</h1>
                <div class="text-sm text-gray-600">
                    Student: <span id="student-name">Loading...</span>
                </div>
            </header>
           
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Fee Summary -->
                    <div class="card finance">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-money-bill mr-2"></i> Fee Status
                        </h2>
                        <div class="stats-grid">
                            <div class="stat-card" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                                <h3 id="fee-due">-</h3>
                                <p class="text-xs">Due</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">
                                <h3 id="fee-paid">-</h3>
                                <p class="text-xs">Paid</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                                <h3 id="fee-balance">-</h3>
                                <p class="text-xs">Balance</p>
                            </div>
                        </div>
                    </div>
                   
                    <!-- Attendance Summary -->
                    <div class="card attendance">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-calendar-check mr-2"></i> Attendance
                        </h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3 id="attendance-present">-</h3>
                                <p class="text-xs">Present Days</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="attendance-percent">-</h3>
                                <p class="text-xs">% Attendance</p>
                            </div>
                        </div>
                    </div>
                   
                    <!-- Academic Summary -->
                    <div class="card academic">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-book mr-2"></i> Academics
                        </h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3 id="average-score">-</h3>
                                <p class="text-xs">Average Score</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="grade">-</h3>
                                <p class="text-xs">Grade</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
           
            <!-- Academics Section -->
            <section id="academics" class="section">
                <div class="card academic">
                    <h2 class="text-xl font-semibold mb-4">Exam Scores</h2>
                    <canvas id="chartScores" class="mb-4"></canvas>
                    <table class="table">
                        <thead>
                            <tr><th>Subject</th><th>Score</th><th>Max</th><th>%</th></tr>
                        </thead>
                        <tbody id="scores-tbody"></tbody>
                    </table>
                    <button class="btn mt-4" onclick="exportScoresCSV()">Download CSV</button>
                    <button class="btn mt-4 ml-2" onclick="exportScoresPDF()">Download PDF</button>
                </div>
            </section>
           
            <!-- Attendance Section -->
            <section id="attendance" class="section">
                <div class="card attendance">
                    <h2 class="text-xl font-semibold mb-4">Attendance Details</h2>
                    <table class="table">
                        <thead>
                            <tr><th>Date</th><th>Status</th></tr>
                        </thead>
                        <tbody id="attendance-tbody"></tbody>
                    </table>
                </div>
            </section>
           
            <!-- Fees Section -->
            <section id="fees" class="section">
                <div class="card finance">
                    <h2 class="text-xl font-semibold mb-4">Fees & Payments</h2>
                    <table class="table">
                        <thead>
                            <tr><th>Date</th><th>Amount</th><th>Method</th></tr>
                        </thead>
                        <tbody id="payments-tbody"></tbody>
                    </table>
                    <button class="btn mt-4" onclick="exportPaymentsPDF()">Download Payment Report</button>
                </div>
            </section>
           
            <!-- Reports Section -->
            <section id="reports" class="section">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Report Cards</h2>
                    <button class="btn" onclick="generateReportCardPDF()">Generate & Download PDF</button>
                    <button class="btn ml-2" onclick="generateReportCardCSV()">Download CSV</button>
                </div>
            </section>
           
            <!-- Market Section (placeholder) -->
            <section id="market" class="section">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">School Market</h2>
                    <p>View school items, uniforms, books, etc. (Integration coming soon)</p>
                </div>
            </section>
        </div>
    </div>
   
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
            authDomain: "somaptestt.firebaseapp.com",
            databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
            projectId: "somaptestt",
            storageBucket: "somaptestt.appspot.com",
            messagingSenderId: "105526245138",
            appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
       
        const studentId = localStorage.getItem('studentId');
        const role = localStorage.getItem('role');
        if (role !== 'parent' || !studentId) {
            alert('Unauthorized access');
            window.location.href = 'index.html';
            return;
        }
       
        let studentData = {};
        let scoresChart = null;
       
        // Load Student Data
        db.ref('students').orderByChild('admissionNumber').equalTo(studentId).once('value').then(snapshot => {
            studentData = snapshot.val() ? Object.values(snapshot.val())[0] : null;
            if (!studentData) {
                alert('Student not found');
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('student-name').textContent = `${studentData.firstName} ${studentData.middleName || ''} ${studentData.lastName}`;
            updateDashboardSummary();
            loadAttendance();
            loadScores();
            loadPayments();
        });
       
        // Update Dashboard Summary
        function updateDashboardSummary() {
            document.getElementById('fee-due').textContent = money(studentData.feePerYear || 0);
            document.getElementById('fee-paid').textContent = money(studentData.paidAmount || 0);
            document.getElementById('fee-balance').textContent = money(studentData.balance || 0);
           
            // Attendance summary calculated in loadAttendance
           
            // Academic summary calculated in loadScores
        }
       
        // Load Attendance
        function loadAttendance() {
            db.ref(`attendance/${studentData.classLevel}/2025-09`).once('value').then(snapshot => {
                const attData = snapshot.val() || {};
                let present = 0, total = 0;
                const tbody = document.getElementById('attendance-tbody');
                tbody.innerHTML = '';
                Object.keys(attData).forEach(date => {
                    const rec = attData[date][studentId];
                    if (rec) {
                        total++;
                        if (rec.daily === 'P') present++;
                        tbody.innerHTML += `<tr><td>${date}</td><td>${rec.daily === 'P' ? 'Present' : 'Absent'}</td></tr>`;
                    }
                });
                document.getElementById('attendance-present').textContent = present;
                document.getElementById('attendance-percent').textContent = total ? (present / total * 100).toFixed(1) + '%' : '0%';
            });
        }
       
        // Load Scores
        function loadScores() {
            db.ref(`scores/2025/${studentData.classLevel}/monthly/09/${studentId}`).once('value').then(snapshot => {
                const scores = snapshot.val() || {};
                const labels = [], data = [];
                const tbody = document.getElementById('scores-tbody');
                tbody.innerHTML = '';
                let sumPct = 0, count = 0;
                Object.keys(scores).forEach(sub => {
                    const s = scores[sub];
                    const pct = (s.score / s.max * 100).toFixed(1);
                    labels.push(sub);
                    data.push(pct);
                    sumPct += parseFloat(pct);
                    count++;
                    tbody.innerHTML += `<tr><td>${sub}</td><td>${s.score}</td><td>${s.max}</td><td>${pct}%</td></tr>`;
                });
                const avg = (sumPct / count).toFixed(1) || 0;
                document.getElementById('average-score').textContent = avg + '%';
                document.getElementById('grade').textContent = letterGrade(avg);
               
                if (scoresChart) scoresChart.destroy();
                scoresChart = new Chart(document.getElementById('chartScores'), {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Score %', data, backgroundColor: '#4caf50' }] },
                    options: { scales: { y: { beginAtZero: true, max: 100 } } }
                });
            });
        }
       
        // Load Payments (from finance style)
        function loadPayments() {
            db.ref(`payments/2025/${studentData.classLevel}/${studentId}`).once('value').then(snapshot => {
                const payments = snapshot.val() || {};
                const tbody = document.getElementById('payments-tbody');
                tbody.innerHTML = '';
                Object.values(payments).forEach(p => {
                    tbody.innerHTML += `<tr><td>${p.date}</td><td>${money(p.amount)}</td><td>${p.method}</td></tr>`;
                });
            });
        }
       
        // Export Functions
        function exportScoresCSV() {
            // Gather scores data and use XLSX to CSV
            const rows = [['Subject', 'Score', 'Max', '%']];
            document.querySelectorAll('#scores-tbody tr').forEach(tr => {
                const cells = Array.from(tr.children).map(td => td.textContent);
                rows.push(cells);
            });
            const ws = XLSX.utils.aoa_to_sheet(rows);
            const csv = XLSX.utils.sheet_to_csv(ws);
            const blob = new Blob([csv], { type: 'text/csv' });
            saveAs(blob, 'scores.csv');
        }
       
        function exportScoresPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.autoTable({ html: '#academics table' });
            doc.save('scores.pdf');
        }
       
        function exportPaymentsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.autoTable({ html: '#fees table' });
            doc.save('payments.pdf');
        }
       
        function generateReportCardPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Report Card for ${document.getElementById('student-name').textContent}`, 10, 10);
            doc.autoTable({ html: '#academics table', startY: 20 });
            doc.addPage();
            doc.text('Attendance', 10, 10);
            doc.autoTable({ html: '#attendance table', startY: 20 });
            doc.addPage();
            doc.text('Fees', 10, 10);
            doc.autoTable({ html: '#fees table', startY: 20 });
            doc.save('report_card.pdf');
        }
       
        function generateReportCardCSV() {
            // Combine all data into CSV
            const rows = [['Section', 'Details']];
            // Add scores, attendance, fees
            const blob = new Blob([rows.map(r => r.join(',')).join('\n')], { type: 'text/csv' });
            saveAs(blob, 'report_card.csv');
        }
       
        function letterGrade(pct) {
            if (pct >= 80) return 'A';
            if (pct >= 60) return 'B';
            if (pct >= 40) return 'C';
            if (pct >= 20) return 'D';
            return 'F';
        }
       
        function money(n) { return 'TSh ' + Number(n).toLocaleString(); }
       
        // Section Toggle
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
       
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
            document.querySelector('.main-content').style.marginLeft = sidebar.classList.contains('expanded') ? '270px' : '100px';
        }
       
        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>