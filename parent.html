<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Parent Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <!-- PDFs / CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Alerts / Charts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    /* ==== Theme (Codex vibe) ==== */
    :root{
      --glass: rgba(15, 23, 42, 0.82);
      --line: rgba(148, 163, 184, 0.22);
      --muted: rgba(226,232,240,0.75);
      --text: #e2e8f0;
      --title: #fff;
      --sky: #0ea5e9;
      --orchid: #8b5cf6;
      --emerald: #10b981;
      --amber: #f59e0b;
      --accent: #6366f1;
    }
    html { scroll-behavior:smooth; }
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at -10% -10%, rgba(14,165,233,.35), transparent 40%),
        radial-gradient(900px 700px at 110% -10%, rgba(139,92,246,.30), transparent 35%),
        linear-gradient(180deg, #020617 0%, #0b1220 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      touch-action: manipulation;
    }

    /* ==== Sidebar ==== */
    .sidebar{
      width:78px; position:fixed; inset:0 auto 0 0; z-index:40;
      background: linear-gradient(180deg, rgba(2,6,23,.8), rgba(2,6,23,.55));
      border-right:1px solid var(--line);
      backdrop-filter: blur(10px);
      padding:12px 10px; display:flex; flex-direction:column; align-items:center; gap:12px;
    }
    .sb-logo{ width:48px; height:48px; border-radius:12px; object-fit:cover; }
    .icon{
      width:56px; height:56px; border-radius:14px; color:#fff;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      background: rgba(148,163,184,0.08); border:1px solid transparent;
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
      user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .icon:hover{ transform: translateY(-3px); background: rgba(148,163,184,0.14); border-color: var(--line); }

    /* ==== Main / Cards ==== */
    .main{ margin-left:98px; padding:20px; }
    .glass{
      background:var(--glass);
      border:1px solid var(--line);
      border-radius:1.5rem;
      box-shadow: 0 30px 80px -40px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
    }
    .card{
      background:var(--glass);
      border:1px solid var(--line);
      border-radius:1.25rem;
      box-shadow:0 22px 40px -30px rgba(0,0,0,.55);
      padding:18px;
      transition: transform .16s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card:hover{ transform: translateY(-3px); border-color: rgba(148,163,184,.35); box-shadow:0 30px 60px -35px rgba(14,165,233,.35); }
    .muted{ color:var(--muted); }
    .title{ color:var(--title); }
    .divider{ border-top:1px dashed var(--line); }

    /* ==== Buttons ==== */
    .btn{
      background:linear-gradient(120deg, rgba(99,102,241,.9), rgba(14,165,233,.9));
      color:#fff; border:none; border-radius:12px; font-weight:800; letter-spacing:.2px;
      padding:10px 14px; box-shadow:0 10px 30px -12px rgba(14,165,233,.6);
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn-ghost{
      background:rgba(148,163,184,.12); color:#fff; border:1px solid var(--line); border-radius:12px; font-weight:700;
      padding:8px 12px;
    }

    /* ==== Stats ==== */
    .stat{
      background:linear-gradient(140deg, rgba(14,165,233,.18), rgba(99,102,241,.12));
      border:1px solid var(--line); border-radius:1.25rem; padding:16px;
    }
    .stat-label{ font-size:.85rem; letter-spacing:.15em; text-transform:uppercase; color:var(--muted); }
    .stat-value{ font-size:1.6rem; font-weight:800; color:#fff; letter-spacing:.2px; }
    .badge{
      display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .75rem; border-radius:999px;
      border:1px solid transparent; font-size:.78rem; font-weight:800; letter-spacing:.08em; text-transform:uppercase;
    }
    .badge-ok{ background:rgba(16,185,129,.15); color:#86efac; border-color:rgba(16,185,129,.35); }
    .badge-warn{ background:rgba(245,158,11,.12); color:#fcd34d; border-color:rgba(245,158,11,.35); }
    .badge-risk{ background:rgba(239,68,68,.12); color:#fca5a5; border-color:rgba(239,68,68,.35); }

    /* ==== Tables / Lists ==== */
    table{ width:100%; border-collapse:collapse; }
    thead th{ text-align:left; padding:10px 8px; color:rgba(226,232,240,.9); letter-spacing:.18em; font-size:.75rem; text-transform:uppercase; }
    tbody td{ padding:10px 8px; border-top:1px solid rgba(148,163,184,.18); color:#e5e7eb; }
    .payments-list li{ padding:12px 0; border-bottom:1px dashed var(--line); display:flex; justify-content:space-between; gap:10px; }

    /* ==== Skeleton ==== */
    .skeleton{ position:relative; overflow:hidden; background:rgba(148,163,184,.12); border-radius:10px; min-height:16px; }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent); animation:shimmer 1.4s infinite; }
    @keyframes shimmer{ 100%{ transform:translateX(100%);} }

    /* ==== Responsive improvements (ONLY spacing/flow) ==== */
    /* Replace inline 1fr/360px with a clean class */
    .two-col { grid-template-columns: 1fr; }
    @media (min-width: 1280px){
      .two-col { grid-template-columns: 1fr 360px; }
    }
    /* Tighter mobile spacing */
    @media (max-width:768px){
      .main{ padding:12px; }
      .card{ padding:14px; }
      .stat{ padding:12px; }
      section.grid.gap-4{ row-gap:12px; }
    }
    /* Long phone numbers won’t overflow */
    #detailParentPhone{ word-break: break-word; }

    /* Keep sidebar usable on small screens */
    @media (max-width:1024px){
      .main{ margin-left:0; padding:14px; }
      .sidebar{ position:sticky; top:0; width:100%; height:auto; flex-direction:row; justify-content:center; gap:10px; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <img src="images/somap-logo.png.jpg" alt="SoMAp" class="sb-logo">
    <div title="Market" class="icon" data-action="market"><i class="fas fa-store"></i></div>
    <div title="Attendance" class="icon" data-action="attendance"><i class="fas fa-calendar-check"></i></div>
    <div title="Fees" class="icon" data-action="fees"><i class="fas fa-money-bill-wave"></i></div>
    <div title="Books" class="icon" data-action="books"><i class="fas fa-book"></i></div>
    <div id="preform-icon" title="Preform One" class="icon" style="display:none;" onclick="if(localStorage.getItem('preformParentIcon')) window.location.href='preformonehtml/prefoneparent.html';"><i class="fas fa-graduation-cap"></i></div>
    <div style="flex:1"></div>
    <div id="icon-logout" class="icon" title="Logout"><i class="fas fa-sign-out-alt"></i></div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- HERO -->
    <section class="glass p-5 lg:p-7 mb-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <p class="uppercase tracking-[0.35em] text-xs muted">Parent Experience Hub</p>
          <h1 id="studentName" class="title text-3xl md:text-4xl font-extrabold">Parent Dashboard</h1>
          <p id="studentMeta" class="muted mt-1">Loading student details…</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-right">
            <p class="muted text-xs uppercase tracking-[0.35em]">Role</p>
            <p class="title font-extrabold">Parent</p>
          </div>
          <button class="btn" id="openMarketTop"><i class="fas fa-bag-shopping mr-2"></i>Open Market</button>
        </div>
      </div>
    </section>

    <!-- STATS (xl now fits 5 cards) -->
    <section class="grid gap-4 grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 mb-4">
      <article class="stat">
        <p class="stat-label">Total Fee (Year)</p>
        <p id="statFeeDue" class="stat-value">TSh 0</p>
        <p class="muted">Payment plan: <span id="statPaymentPlan">-</span></p>
      </article>

      <article class="stat">
        <p class="stat-label">Total Paid</p>
        <p id="statPaid" class="stat-value">TSh 0</p>
        <p class="muted">To date</p>
      </article>

      <article class="stat">
        <p class="stat-label">Balance <span id="balanceStatusBadge" class="badge badge-ok ml-2">PAID</span></p>
        <p id="statBalance" class="stat-value">TSh 0</p>
        <p class="muted">Outstanding</p>
      </article>

      <article class="stat">
        <p class="stat-label">Attendance (this student)</p>
        <p id="statAttendancePct" class="stat-value">0%</p>
        <p class="muted">Present / Total days</p>
      </article>

      <!-- NEW: RECEIPTS stat (child-only) -->
      <article class="stat">
        <p class="stat-label">Receipts</p>
        <p id="statReceiptCount" class="stat-value">0</p>
        <p id="statReceiptMeta" class="muted">No receipts yet</p>
        <div class="mt-2 flex gap-2">
          <button class="btn" id="openReceiptVaultTop">
            <i class="fas fa-file-invoice-dollar mr-2"></i>Open
          </button>
          <button class="btn-ghost" id="openReceiptNewTabTop">
            <i class="fas fa-up-right-from-square mr-2"></i>New tab
          </button>
        </div>
      </article>
    </section>

    <!-- GRID (responsive two-column) -->
    <section class="grid gap-4 two-col">
      <!-- LEFT COLUMN -->
      <div class="flex flex-col gap-4">

        <!-- RECENT PAYMENTS -->
        <article class="card">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="title text-xl font-extrabold m-0">Recent Payments</h3>
              <p class="muted text-sm">Last 10 payments</p>
            </div>
            <button class="btn-ghost" id="refreshPayments"><i class="fas fa-rotate"></i> Refresh</button>
          </div>

          <ul id="paymentsList" class="payments-list mt-3">
            <li><div class="skeleton h-4 w-40"></div></li>
            <li><div class="skeleton h-4 w-56"></div></li>
            <li><div class="skeleton h-4 w-48"></div></li>
          </ul>
        </article>

        <!-- SCORES -->
        <article class="card">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="title text-xl font-extrabold m-0">Exam Scores (latest)</h3>
              <p class="muted text-sm">Auto average • Exportable</p>
            </div>
            <div class="flex gap-2">
              <button class="btn-ghost" id="exportCsvBtn"><i class="fas fa-file-csv mr-2"></i>CSV</button>
              <button class="btn" id="exportPdfBtn"><i class="fas fa-file-pdf mr-2"></i>PDF</button>
            </div>
          </div>

          <div class="overflow-auto mt-3 rounded-xl border border-[var(--line)]">
            <table class="min-w-full" id="scoresTable">
              <thead class="bg-white/5">
                <tr><th>Subject</th><th>Score</th><th>Max</th><th>%</th></tr>
              </thead>
              <tbody id="scoresTbody">
                <tr><td colspan="4" class="muted p-4">No scores loaded.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="mt-3">
            <div class="card p-3">
              <canvas id="scoresChart" style="width:100%;height:200px;"></canvas>
            </div>
          </div>
        </article>

        <!-- REPORT CARD -->
        <article class="card">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="title text-xl font-extrabold m-0">Report Card</h3>
              <p class="muted text-sm">Generate downloadable report</p>
            </div>
            <div class="flex gap-2">
              <select id="reportExamSelect" class="btn-ghost px-3 py-2">
                <option value="monthly">Monthly</option>
                <option value="term">Term</option>
              </select>
              <select id="reportMonth" class="btn-ghost px-3 py-2">
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="01">January</option>
              </select>
              <button class="btn" id="genReportBtn"><i class="fas fa-download mr-2"></i>Download</button>
            </div>
          </div>
          <div id="reportPreview" class="muted mt-3">Preview not available — click Generate to create PDF.</div>
        </article>

      </div>

      <!-- RIGHT COLUMN -->
      <aside class="flex flex-col gap-4">

        <!-- PROFILE / DETAILS -->
        <article class="card">
          <h4 class="title text-lg font-extrabold m-0">Student Details</h4>
          <div class="grid grid-cols-1 gap-3 mt-3 text-sm">
            <div class="divider"></div>
            <div><strong class="muted">Class:</strong> <span id="detailClass">-</span></div>
            <div><strong class="muted">Stream:</strong> <span id="detailStream">-</span></div>
            <div><strong class="muted">Admission #:</strong> <span id="detailAdm">-</span></div>
            <div><strong class="muted">Parent phone:</strong> <span id="detailParentPhone">-</span></div>
          </div>
        </article>

        <!-- ATTENDANCE TREND -->
        <article class="card">
          <h4 class="title text-lg font-extrabold m-0">Attendance Trend</h4>
          <canvas id="attendanceChart" class="mt-3" style="width:100%;height:180px;"></canvas>
        </article>

        <!-- Receipt Vault (opens childreceipt.html) -->
        <article class="card">
          <h4 class="title text-lg font-extrabold m-0">Receipt Vault</h4>
          <p class="muted mt-1 text-sm">View all this child’s payments and download official receipts.</p>
          <div class="mt-3 flex gap-2">
            <button class="btn" id="openReceiptVault">
              <i class="fas fa-file-invoice-dollar mr-2"></i>Open Receipts
            </button>
            <button class="btn-ghost" id="openReceiptNewTab">
              <i class="fas fa-up-right-from-square mr-2"></i>Open in New Tab
            </button>
          </div>
        </article>

        <!-- QUICK ACTIONS -->
        <article class="card">
          <h4 class="title text-lg font-extrabold m-0">Quick Actions</h4>
          <div class="mt-3 flex flex-col gap-2">
            <button class="btn" id="quickGenerateId"><i class="fas fa-id-card-clip mr-2"></i>Generate ID</button>
            <button class="btn-ghost" id="quickReportCard"><i class="fas fa-file-pdf mr-2"></i>Open Current Report Card</button>
            <button class="btn-ghost" id="quickFees"><i class="fas fa-coins mr-2"></i>View Fees Info</button>
            <button class="btn-ghost" id="viewMarketSmall"><i class="fas fa-basket-shopping mr-2"></i>Open Market</button>
          </div>
        </article>

      </aside>
    </section>

    <p class="muted mt-4 text-sm">SoMAp — All monetary values are shown in Tanzanian shillings (TSh).</p>

    <!-- Embedded Receipt Modal -->
    <div id="receiptModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center">
      <div class="relative w-[90vw] h-[90vh] bg-slate-900 border border-white/10 rounded-2xl overflow-hidden">
        <iframe id="receiptFrame" class="w-full h-full border-0"></iframe>
        <button id="closeReceiptModal"
                class="absolute top-3 right-3 px-3 py-1.5 rounded-lg bg-red-500 text-white">
          Close
        </button>
      </div>
    </div>
  </main>

  <script>
  /*************************************************************************
   * Parent Dashboard (UI-upgraded, logic-compatible)
   *************************************************************************/
  const firebaseConfig = {
    apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
    authDomain: "somaptestt.firebaseapp.com",
    databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
    projectId: "somaptestt",
    storageBucket: "somaptestt.appspot.com",
    messagingSenderId: "105526245138",
    appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
    measurementId: "G-4HKX7KN6Q3"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Helpers
  const q = s => document.querySelector(s);
  const qa = s => Array.from(document.querySelectorAll(s));
  const safe = s => (s==null ? '' : String(s));
  const fmtTsh = n => 'TSh ' + (Number(n)||0).toLocaleString();

  // Refs
  const studentNameEl = q('#studentName');
  const studentMetaEl = q('#studentMeta');
  const statFeeDue = q('#statFeeDue');
  const statPaid = q('#statPaid');
  const statBalance = q('#statBalance');
  const statAttendancePct = q('#statAttendancePct');
  const statPaymentPlan = q('#statPaymentPlan');

  const paymentsList = q('#paymentsList');
  const scoresTbody = q('#scoresTbody');
  const scoresChartCanvas = q('#scoresChart');
  const attendanceChartCanvas = q('#attendanceChart');

  const exportCsvBtn = q('#exportCsvBtn');
  const exportPdfBtn = q('#exportPdfBtn');
  const genReportBtn = q('#genReportBtn');

  const detailClass = q('#detailClass');
  const detailStream = q('#detailStream');
  const detailAdm = q('#detailAdm');
  const detailParentPhone = q('#detailParentPhone');

  const quickGenerateId = q('#quickGenerateId');
  const quickReportCard = q('#quickReportCard');
  const quickFees = q('#quickFees');
  const openMarketTop = q('#openMarketTop');
  const viewMarketSmall = q('#viewMarketSmall');

  // NEW: Receipt stat refs
  const statReceiptCount = q('#statReceiptCount');
  const statReceiptMeta  = q('#statReceiptMeta');

  // Sidebar actions
  qa('.icon').forEach(el => el.addEventListener('click', (ev)=>handleAction(ev.currentTarget.dataset.action)));
  q('#icon-logout').addEventListener('click', ()=> {
    localStorage.removeItem('studentKey'); localStorage.removeItem('role'); window.location.href = 'index.html';
  });

  // State
  let currentStudentKey = null, currentStudent = null;
  let scoresChart = null, attendanceChart = null;
  let __allPaymentsSum = 0;
  const CURRENT_YEAR = new Date().getFullYear();

  // Init
  (async function init(){
    try{
      const urlParams = new URLSearchParams(window.location.search);
      currentStudentKey = urlParams.get('studentKey') || localStorage.getItem('studentKey');
      if (!currentStudentKey){ window.location.href='index.html'; return; }
      localStorage.setItem('studentKey', currentStudentKey);

      const snap = await db.ref('students/'+currentStudentKey).once('value');
      if (!snap.exists()){ localStorage.removeItem('studentKey'); window.location.href='index.html'; return; }
      currentStudent = snap.val();

      // Preform icon
      if (localStorage.getItem('preformParentIcon') === 'true') {
        document.getElementById('preform-icon').style.display = 'flex';
      }

      await showParentDashboard();
      bindUI();
    }catch(err){
      console.error(err);
      Swal.fire('Error','Failed to initialize dashboard. Please refresh the page.','error');
    }
  })();

  async function showParentDashboard(){
    if (!currentStudent){
      const s = await db.ref('students/'+currentStudentKey).once('value');
      if (!s.exists()){ window.location.href='index.html'; return; }
      currentStudent = s.val();
    }

    // Header
    studentNameEl.textContent = `${safe(currentStudent.firstName)} ${safe(currentStudent.middleName || '')} ${safe(currentStudent.lastName)}`.replace(/\s+/g,' ').trim();
    studentMetaEl.textContent = `School: ${safe(currentStudent.schoolName || '-')}`;

    // Stats
    const feeDue = Number(currentStudent.feePerYear || currentStudent.feeDue || 0);
    const paidLocal = Number(currentStudent.paidAmount || calculateTotalPayments(currentStudent) || 0);
    statFeeDue.textContent = fmtTsh(feeDue);
    statPaid.textContent = fmtTsh(paidLocal);
    statBalance.textContent = fmtTsh(Math.max(0, feeDue - paidLocal));
    applyFeeBadge(feeDue, paidLocal);
    statPaymentPlan.textContent = safe(currentStudent.paymentPlan || '-');

    detailClass.textContent = safe(currentStudent.classLevel || '-');
    detailStream.textContent = safe(currentStudent.stream || '-');
    detailAdm.textContent = safe(currentStudent.admissionNumber || currentStudent.pupilId || '-');
    detailParentPhone.textContent = safe(currentStudent.primaryParentContact || '-');

    await loadPaymentsAllSources(
      currentStudentKey,
      (currentStudent.admissionNumber || currentStudent.pupilId || currentStudentKey),
      (currentStudent.classLevel || ''),
      CURRENT_YEAR
    );
    await loadAttendanceForStudent(currentStudent.admissionNumber);
    await loadScoresForStudent(currentStudent.admissionNumber);

    renderAttendanceChart();
    renderScoresChart();
  }

  // Calculate local payments
  function calculateTotalPayments(student){
    const payments = student?.payments || {};
    let sum = 0; Object.values(payments).forEach(p => sum += Number(p.amount||0)); return sum;
  }

  // >>> Badge now belongs to BALANCE (no "DUE" on Total Paid)
  function applyFeeBadge(feeDue, paid){
    const bal = Math.max(0, feeDue - paid);
    const els = [q('#balanceStatusBadge'), q('#feeStatusBadge') /* legacy, if ever present */];
    els.forEach(el=>{
      if(!el) return;
      el.classList.remove('badge-ok','badge-warn','badge-risk');
      if (bal <= 0){ el.classList.add('badge-ok'); el.textContent = 'PAID'; }
      else if ((bal/Math.max(1,feeDue)) <= .25){ el.classList.add('badge-warn'); el.textContent = 'PARTIAL'; }
      else { el.classList.add('badge-risk'); el.textContent = 'OUTSTANDING'; }
    });
  }

  // Payments aggregator (pull from common finance paths)
  function normalizePayment(p, sourceKey){
    const amt = Number(p?.amount || 0);
    let ts = Number(p?.timestamp || 0);
    if (!ts && p?.date){ const t = Date.parse(p.date); if(!Number.isNaN(t)) ts=t; }
    if (!ts) ts = Date.now();
    return { amount:amt, timestamp:ts, method:p?.method || p?.mode || '-', note:p?.note || p?.remarks || '', _src:sourceKey||'unknown' };
  }
  async function tryPathOnce(path){ try{ const s=await db.ref(path).once('value'); return s.val()||null; }catch{return null;} }
  function dedupePayments(arr){
    const seen = new Set();
    return arr.filter(p=>{ const k = `${p.amount}|${new Date(p.timestamp).toDateString()}|${p.method}|${p.note}`; if(seen.has(k)) return false; seen.add(k); return true; });
  }
  async function loadPaymentsAllSources(studentKey, admNo, classLevel, year){
    paymentsList.innerHTML = `
      <li><div class="skeleton h-4 w-40"></div></li>
      <li><div class="skeleton h-4 w-56"></div></li>
      <li><div class="skeleton h-4 w-48"></div></li>`;

    const paths = [
      `students/${studentKey}/payments`,
      `finance/${year}/${classLevel}/${admNo}/payments`,
      `fees/${year}/${admNo}/payments`,
      `payments/${admNo}`,
      `feesPayments/${admNo}`
    ];
    const results = await Promise.all(paths.map(p=>tryPathOnce(p)));

    let merged = [];
    results.forEach((obj, idx) => {
      if (!obj) return;
      Object.values(obj).forEach(v => merged.push(normalizePayment(v, paths[idx])));
    });
    merged = dedupePayments(merged).sort((a,b)=> b.timestamp - a.timestamp);

    if (!merged.length){
      paymentsList.innerHTML = '<li class="muted">No payments recorded.</li>';
    }else{
      const max = Math.min(merged.length, 50);
      paymentsList.innerHTML = merged.slice(0,max).map(p => `
        <li>
          <div>
            <div class="title font-extrabold">${fmtTsh(p.amount)}</div>
            <div class="muted text-sm">${(p.method||'-')} • ${safe(p.note)}</div>
          </div>
          <div class="muted text-right text-sm">${new Date(p.timestamp).toLocaleString()}</div>
        </li>
      `).join('');
    }

    // Recompute with best total
    const aggSum = merged.reduce((s,p)=> s + (Number(p.amount)||0), 0);
    __allPaymentsSum = aggSum;
    const feeDue = Number(currentStudent?.feePerYear || currentStudent?.feeDue || 0);
    const paidLocal = Number(currentStudent?.paidAmount || calculateTotalPayments(currentStudent) || 0);
    const bestPaid = Math.max(aggSum, paidLocal);
    statPaid.textContent = fmtTsh(bestPaid);
    statBalance.textContent = fmtTsh(Math.max(0, feeDue - bestPaid));
    applyFeeBadge(feeDue, bestPaid);

    // ---- Update Receipts stat card
    const recCount = merged.length;
    const lastTs   = merged[0]?.timestamp || null; // merged is sorted desc above
    if (statReceiptCount) statReceiptCount.textContent = String(recCount);
    if (statReceiptMeta)  statReceiptMeta.textContent  = lastTs
      ? ('Last: ' + new Date(lastTs).toLocaleDateString())
      : 'No receipts yet';
  }

  // Attendance loader
  async function loadAttendanceForStudent(admNo){
    statAttendancePct.textContent = 'Calculating...';
    try{
      const snap = await db.ref('attendance').once('value');
      const obj = snap.val() || {};
      let present=0,total=0;
      const monthCounts = {};
      Object.values(obj).forEach(classObj=>{
        Object.values(classObj||{}).forEach(monthObj=>{
          Object.values(monthObj||{}).forEach(dayObj=>{
            Object.values(dayObj||{}).forEach(rec=>{
              try{
                const s = rec.snap;
                if (s && String(s.admissionNo) === String(admNo)){
                  total++;
                  const daily = rec.daily || '';
                  if (daily==='P'||daily==='PS'||daily==='PA'||daily==='PS') present++;
                  const ts = rec.timestamp || rec.ts || null;
                  if (ts){
                    const d = new Date(ts);
                    const m = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    monthCounts[m] = monthCounts[m]||{present:0,total:0};
                    monthCounts[m].total++;
                    if (daily==='P'||daily==='PS') monthCounts[m].present++;
                  }
                }
              }catch{}
            });
          });
        });
      });
      const pct = total ? Math.round((present/total)*100) : 0;
      statAttendancePct.textContent = pct + '%';
      window.__soMap_attendance_months = monthCounts;
      renderAttendanceChart();
    }catch(err){
      console.error('attendance error', err);
      statAttendancePct.textContent = '—';
    }
  }

  // Scores (latest)
  async function loadScoresForStudent(admNo){
    try{
      scoresTbody.innerHTML = '<tr><td colspan="4" class="muted p-3">Loading scores…</td></tr>';
      const snap = await db.ref('scores').once('value');
      const root = snap.val() || {};
      let found = null;
      outer:
      for (const year of Object.keys(root).sort().reverse()){
        const classes = root[year] || {};
        for (const className of Object.keys(classes||{})){
          const examKeys = classes[className] || {};
          for (const examKey of Object.keys(examKeys||{})){
            const months = examKeys[examKey] || {};
            for (const monthKey of Object.keys(months||{}).sort().reverse()){
              const mdata = months[monthKey] || {};
              if (mdata && mdata[admNo]){ found = {year,className,examKey,monthKey,data:mdata[admNo]}; break outer; }
            }
          }
        }
      }
      if (!found){
        scoresTbody.innerHTML = '<tr><td colspan="4" class="muted p-3">No scores found for this student.</td></tr>';
        window.__soMap_scores_for_chart = null; renderScoresChart(); return;
      }
      const labels=[], values=[]; let rows='';
      Object.keys(found.data).forEach(subject=>{
        const subj = found.data[subject] || {};
        const score = Number(subj.score||0), max = Number(subj.max||100);
        const pct = max ? (score/max)*100 : 0;
        rows += `<tr><td>${subject}</td><td>${score}</td><td>${max}</td><td>${pct.toFixed(1)}%</td></tr>`;
        labels.push(subject); values.push(Number(pct.toFixed(1)));
      });
      scoresTbody.innerHTML = rows || '<tr><td colspan="4" class="muted p-3">No subjects found.</td></tr>';
      window.__soMap_scores_for_chart = {labels, values, meta: found};
      renderScoresChart();
    }catch(err){
      console.error('scores error', err);
      scoresTbody.innerHTML = '<tr><td colspan="4" class="muted p-3">Error loading scores.</td></tr>';
    }
  }

  // Charts (dark ticks)
  function renderScoresChart(){
    const ctx = scoresChartCanvas.getContext('2d');
    if (scoresChart) scoresChart.destroy();
    const ds = window.__soMap_scores_for_chart || {labels:[],values:[]};
    scoresChart = new Chart(ctx, {
      type:'bar',
      data:{ labels: ds.labels, datasets:[{ label:'% (score / max)', data: ds.values, borderWidth:1,
        backgroundColor: ds.labels.map(()=> 'rgba(99,102,241,0.85)'), borderColor: ds.labels.map(()=> 'rgba(99,102,241,1)')}]
      },
      options:{
        responsive:true,
        scales:{
          y:{ beginAtZero:true, max:100, ticks:{ color:'#cbd5f5' } },
          x:{ ticks:{ color:'#cbd5f5' } }
        },
        plugins:{ legend:{ display:false } }
      }
    });
  }
  function renderAttendanceChart(){
    const ctx = attendanceChartCanvas.getContext('2d');
    if (attendanceChart) attendanceChart.destroy();
    const months = window.__soMap_attendance_months || {};
    const keys = Object.keys(months).sort();
    const labels = keys, values = keys.map(k => {
      const m=months[k]||{}; return (m.total && m.present) ? Math.round((m.present/m.total)*100) : 0;
    });
    attendanceChart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{ label:'Attendance %', data: values, tension:.35, fill:true,
        borderColor:'rgba(56,189,248,0.9)', backgroundColor:'rgba(14,165,233,0.22)', pointBackgroundColor:'#38bdf8', borderWidth:2 }]},
      options:{
        responsive:true,
        scales:{ y:{ beginAtZero:true, max:100, ticks:{ color:'#cbd5f5', callback:v=>v+'%' } }, x:{ ticks:{ color:'#cbd5f5' } } },
        plugins:{ legend:{ display:false } }
      }
    });
  }

  // Export buttons
  exportCsvBtn.addEventListener('click', ()=>{
    if (!window.__soMap_scores_for_chart){ Swal.fire('No data','No scores to export','info'); return; }
    const {labels, values} = window.__soMap_scores_for_chart;
    const arr = [['Subject','%']]; for(let i=0;i<labels.length;i++) arr.push([labels[i], values[i]]);
    const ws = XLSX.utils.aoa_to_sheet(arr), wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Scores');
    const wbout = XLSX.write(wb,{bookType:'csv',type:'array'});
    const blob = new Blob([wbout],{type:'text/csv;charset=utf-8;'});
    const name = `${currentStudent.admissionNumber||'student'}_scores.csv`;
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
  });
  exportPdfBtn.addEventListener('click', ()=>{
    if (!currentStudent){ Swal.fire('No student','Please sign in first','warning'); return; }
    const rows=[]; document.querySelectorAll('#scoresTbody tr').forEach(tr=>{
      const cols = Array.from(tr.querySelectorAll('td')).map(td=>td.textContent.trim());
      if (cols.length) rows.push(cols);
    });
    if (!rows.length){ Swal.fire('No scores','No scores to export','info'); return; }
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    doc.setFontSize(14); doc.text(`${safe(currentStudent.firstName)} ${safe(currentStudent.lastName)} — Scores`,14,20);
    doc.autoTable({startY:30, head:[['Subject','Score','Max','%']], body:rows, styles:{fontSize:10}});
    doc.save(`${currentStudent.admissionNumber||'student'}_scores.pdf`);
  });

  // Report card (same route as your Quick Action)
  genReportBtn.addEventListener('click', openReportCard);
  quickReportCard.addEventListener('click', openReportCard);
  function openReportCard(){
    if (!currentStudent){ Swal.fire('No student','Please sign in first','warning'); return; }
    const adm = encodeURIComponent(currentStudent.admissionNumber || currentStudent.pupilId || '');
    const name = encodeURIComponent(`${currentStudent.firstName || ''} ${currentStudent.lastName || ''}`.trim());
    const phone = encodeURIComponent(currentStudent.primaryParentContact || '');
    const url = `Toacademichtml/generatereportform.html?adm=${adm}&name=${name}&phone=${phone}`;
    window.open(url,'_blank');
  }

  // Quick actions
  quickGenerateId.addEventListener('click', ()=>{
    if (!currentStudent){ Swal.fire('No student','Please sign in first','warning'); return; }
    const phone = encodeURIComponent(currentStudent.primaryParentContact || '');
    const firstName = encodeURIComponent((currentStudent.firstName || '').toLowerCase().replace(/\s+/g,''));
    const lastName = encodeURIComponent((currentStudent.lastName || '').toLowerCase().replace(/\s+/g,''));
    window.open(`ToSchoolerp/generateid.html?phone=${phone}&firstName=${firstName}&lastName=${lastName}`,'_blank');
  });
  quickFees.addEventListener('click', ()=>{
    Swal.fire({ title:'Fees', html:`<div style="text-align:left">${statFeeDue.textContent}<br>${statPaid.textContent}<br>${statBalance.textContent}</div>` });
  });
  openMarketTop.addEventListener('click', ()=> window.open('market.html','_blank'));
  viewMarketSmall.addEventListener('click', ()=> window.open('market.html','_blank'));

  // Refresh payments
  q('#refreshPayments').addEventListener('click', ()=>{
    const adm = (currentStudent?.admissionNumber || currentStudent?.pupilId || currentStudentKey);
    loadPaymentsAllSources(currentStudentKey, adm, (currentStudent?.classLevel||''), CURRENT_YEAR);
  });

  function handleAction(action){
    switch(action){
      case 'market': window.open('market.html','_blank'); break;
      case 'attendance':
        if (!currentStudent){ Swal.fire('Error','Student data not loaded. Please sign in again.','error'); return; }
        const url = `Toattendancehtml/childattendance.html?class=${encodeURIComponent(currentStudent.classLevel || '')}&adm=${encodeURIComponent(currentStudent.admissionNumber || '')}`;
        const w = window.open(url,'_blank'); if (!w){ Swal.fire('Error','Allow pop-ups to view attendance.','error'); return; }
        w.addEventListener('load', ()=>{ w.document.documentElement.requestFullscreen?.().catch(()=>{}); }, {once:true});
        break;
      case 'fees': Swal.fire({ title:'Payments', html: paymentsList.innerHTML, width:800 }); break;
      case 'books': window.open('Bookshtml/childbook.html','_blank'); break;
    }
  }

  // Live updates
  db.ref('students').child(currentStudentKey).on('value', snap=>{
    if (!snap.exists()){
      Swal.fire('Student removed','Student data was removed. You will be redirected to the login page.','warning').then(()=>{
        localStorage.removeItem('studentKey'); window.location.href='index.html';
      });
      return;
    }
    currentStudent = snap.val();
    const feeDue = Number(currentStudent.feePerYear || currentStudent.feeDue || 0);
    const paidLocal = Number(currentStudent.paidAmount || calculateTotalPayments(currentStudent) || 0);
    const bestPaid = Math.max(paidLocal, __allPaymentsSum||0);
    statFeeDue.textContent = fmtTsh(feeDue);
    statPaid.textContent = fmtTsh(bestPaid);
    statBalance.textContent = fmtTsh(Math.max(0, feeDue - bestPaid));
    applyFeeBadge(feeDue, bestPaid);

    studentNameEl.textContent = `${safe(currentStudent.firstName)} ${safe(currentStudent.lastName)}`;
    detailClass.textContent = safe(currentStudent.classLevel || '-');
    detailStream.textContent = safe(currentStudent.stream || '-');
    detailAdm.textContent = safe(currentStudent.admissionNumber || '-');
    detailParentPhone.textContent = safe(currentStudent.primaryParentContact || '-');

    const adm = (currentStudent.admissionNumber || currentStudent.pupilId || currentStudentKey);
    loadPaymentsAllSources(currentStudentKey, adm, (currentStudent.classLevel || ''), CURRENT_YEAR);
  });

  function bindUI(){ /* all wired */ }

  // ===== Shared: build child receipt URL (used by stat + vault) =====
  function buildChildReceiptUrlGlobal(){
    const adm = currentStudent?.admissionNumber || currentStudent?.pupilId || '';
    return adm ? `Tofinancehtml/childreceipt.html?adm=${encodeURIComponent(adm)}`
               : `Tofinancehtml/childreceipt.html`;
  }

  // === Receipt Vault (Parent) ===
  (function(){
    const openBtn = document.getElementById('openReceiptVault');
    const openNewTabBtn = document.getElementById('openReceiptNewTab');
    const modal = document.getElementById('receiptModal');
    const frame = document.getElementById('receiptFrame');
    const closeBtn = document.getElementById('closeReceiptModal');

    function openModal(url){
      frame.src = url;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function closeModal(){
      frame.src = '';
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Right-side card buttons
    openBtn?.addEventListener('click', ()=> openModal(buildChildReceiptUrlGlobal()));
    openNewTabBtn?.addEventListener('click', ()=> window.open(buildChildReceiptUrlGlobal(), '_blank'));
    closeBtn?.addEventListener('click', closeModal);

    // TOP stat card buttons
    document.getElementById('openReceiptVaultTop')?.addEventListener('click', ()=>{
      openModal(buildChildReceiptUrlGlobal());
    });
    document.getElementById('openReceiptNewTabTop')?.addEventListener('click', ()=>{
      window.open(buildChildReceiptUrlGlobal(), '_blank');
    });
  })();
  </script>
</body>
</html>
