<!DOCTYPE html>
<html lang="en">
<head>
  <title>SoMAp — Preform One Academic</title>
  <!-- Same scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="prefonecommon.js"></script>
  <style> body { background: linear-gradient(to right, #667eea, #764ba2); } </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-400 to-purple-600 text-white p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6"><i class="fas fa-book"></i> Preform One Academic & Exams</h1>
    <a href="prefonedashboard.html" class="mb-4 inline-block bg-gray-500 p-2 rounded"><i class="fas fa-arrow-left"></i> Back</a>
    
    <!-- Filters -->
    <div class="grid grid-cols-4 gap-4 mb-6 bg-white/10 p-4 rounded">
      <select id="examType" class="p-2 rounded bg-white/20 text-white"><option>Monthly</option><option>Midterm 1</option><option>End Term</option><option>Midterm 2</option><option>Annual</option></select>
      <select id="month" class="p-2 rounded bg-white/20 text-white"><option>Sep</option><option>Oct</option><option>Nov</option><option>Dec</option></select>
      <select id="year" onchange="loadYear(this.value)" class="p-2 rounded bg-white/20 text-white">
        <!-- Populated dynamically -->
      </select>
      <button onclick="loadAcademicData()" class="bg-blue-500 p-2 rounded">Load</button>
    </div>
    
    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white/20 p-4 rounded">Top Student: <span id="topStudent"></span> — <span id="topScore"></span>%</div>
      <div class="bg-white/20 p-4 rounded">Bottom Student: <span id="bottomStudent"></span> — <span id="bottomScore"></span>%</div>
      <div class="bg-white/20 p-4 rounded">Class Max: <span id="classMax"></span>%</div>
      <div class="bg-white/20 p-4 rounded">Class Avg: <span id="classAvg"></span>%</div>
      <div class="bg-white/20 p-4 rounded">Attendance: <span id="attendance"></span>% Present</div>
      <div class="bg-white/20 p-4 rounded">Fee Summary: Required <span id="required"></span> | Paid <span id="paid"></span> | Balance <span id="bal"></span></div>
      <div class="bg-white/20 p-4 rounded">Best Subject Avg: <span id="bestSub"></span></div>
    </div>
    
    <!-- Scores Link -->
    <a href="prefonescoresheet.html" class="bg-yellow-500 p-3 rounded mb-4 inline-block"><i class="fas fa-table"></i> Scoresheet</a>
    
    <!-- Simple Graph Placeholder (use Chart.js if added; for now text) -->
    <div class="bg-white/10 p-4 rounded mb-4">Subject Performance Chart: [Auto-gen averages per subject]</div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };

    // Initialize Firebase (compat)
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // Ensure currentYear is available (from prefonecommon.js)
    if (typeof currentYear === 'undefined') {
      currentYear = new Date().getFullYear(); // Fallback to current year
    }

    const subjects = ['Physics', 'Chemistry', 'Biology', 'Historia ya Tanzania', 'French', 'Geography', 'Basic Math', 'English Language/Course', 'Computer Studies', 'Business Studies'];

    function populateYears() {
      const select = document.getElementById('year');
      for (let y = 2024; y <= 2030; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        if (y == currentYear) opt.selected = true;
        select.appendChild(opt);
      }
    }

    function loadYear(year) {
      currentYear = year;
      loadAcademicData();
      saveFilters();
    }

    function saveFilters() {
      localStorage.setItem('prefone_examType', document.getElementById('examType').value);
      localStorage.setItem('prefone_month', document.getElementById('month').value);
      localStorage.setItem('prefone_year', document.getElementById('year').value);
    }

    function loadAcademicData() {
      saveFilters();
      const examType = document.getElementById('examType').value;
      const month = document.getElementById('month').value;
      db.ref(`/schools/Socrates School Preform one/${currentYear}/students`).once('value').then(snap => {
        const studentsObj = snap.val() || {};
        const students = Object.values(studentsObj);
        let topScore = 0, bottomScore = 100, topName = '', bottomName = '', totalAvg = 0, presentDays = 0, totalDays = 0;
        let required = 0, paid = 0;
        const subAvgs = {};
        subjects.forEach(sub => subAvgs[sub] = 0);
        
        students.forEach(s => {
          // Scores
          const scoresArray = Object.values(s.scores || {});
          const scoreData = scoresArray.find(sc => sc.examType === examType && sc.month === month);
          const avg = scoreData ? Object.values(scoreData.subjects).reduce((sum, sub) => sum + (sub.score / sub.max * 100), 0) / subjects.length : 0;
          totalAvg += avg;
          if (avg > topScore) { topScore = avg; topName = `${s.firstName || ''} ${s.lastName || ''}`.trim(); }
          if (avg < bottomScore && avg > 0) { bottomScore = avg; bottomName = `${s.firstName || ''} ${s.lastName || ''}`.trim(); }
          
          // Attendance
          const attRecords = Object.values(s.attendance || {});
          attRecords.forEach(a => { 
            if (a.present) presentDays++; 
            totalDays++; 
          });
          
          // Fees
          required += Number(s.totalFee || 0);
          const paymentsArray = Object.values(s.payments || {});
          paid += paymentsArray.reduce((sum, p) => sum + Number(p.amount || 0), 0);
          
          // Subjects avgs
          if (scoreData) {
            Object.entries(scoreData.subjects).forEach(([sub, data]) => {
              subAvgs[sub] += (data.score / data.max * 100);
            });
          }
        });
        
        const numStudents = students.length;
        const classAvg = numStudents > 0 ? (totalAvg / numStudents).toFixed(2) : 0;
        const attPct = totalDays > 0 ? (presentDays / totalDays * 100).toFixed(1) : 0;
        const bestSub = numStudents > 0 ? Object.entries(subAvgs).reduce((max, [sub, totalAvg]) => (totalAvg / numStudents > max[1] ? [sub, totalAvg / numStudents] : max), ['', 0])[0] : 'N/A';
        
        document.getElementById('topStudent').textContent = topName || 'N/A';
        document.getElementById('topScore').textContent = topScore.toFixed(2);
        document.getElementById('bottomStudent').textContent = bottomName || 'N/A';
        document.getElementById('bottomScore').textContent = bottomScore.toFixed(2);
        document.getElementById('classMax').textContent = topScore.toFixed(2);
        document.getElementById('classAvg').textContent = classAvg;
        document.getElementById('attendance').textContent = attPct;
        document.getElementById('required').textContent = required.toLocaleString() + ' TSh';
        document.getElementById('paid').textContent = paid.toLocaleString() + ' TSh';
        document.getElementById('bal').textContent = (required - paid).toLocaleString() + ' TSh';
        document.getElementById('bestSub').textContent = bestSub || 'N/A';
      }).catch(err => {
        console.error('Load error:', err);
        Swal.fire('Error', 'Failed to load academic data: ' + err.message, 'error');
      });
    }

    document.getElementById('examType').addEventListener('change', saveFilters);
    document.getElementById('month').addEventListener('change', saveFilters);

    populateYears();
    loadAcademicData();
  </script>
</body>
</html>