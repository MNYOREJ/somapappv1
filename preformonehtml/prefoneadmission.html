<!DOCTYPE html>
<html lang="en">
<head>
  <title>SoMAp — Preform One Admissions</title>
  <!-- Same scripts as dashboard -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="prefonecommon.js"></script>
  <style> body { background: linear-gradient(to right, #667eea, #764ba2); } label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #f3f4f6; } </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-400 to-purple-600 text-white p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6"><i class="fas fa-user-plus"></i> Preform One Admissions</h1>
    <a href="prefonedashboard.html" class="mb-4 inline-block bg-gray-500 p-2 rounded"><i class="fas fa-arrow-left"></i> Back</a>
    
    <!-- Create New -->
    <button onclick="showForm()" class="bg-green-500 hover:bg-green-600 p-3 rounded mb-4">Create New Admission</button>
    
    <div id="admissionForm" style="display:none;" class="bg-white/10 p-6 rounded-lg">
      <form id="admForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="firstName">First Name *</label>
            <input type="text" id="firstName" class="p-2 rounded w-full bg-white/20 text-white" required>
          </div>
          <div>
            <label for="middleName">Middle Name (optional)</label>
            <input type="text" id="middleName" class="p-2 rounded w-full bg-white/20 text-white">
          </div>
          <div>
            <label for="lastName">Last Name *</label>
            <input type="text" id="lastName" class="p-2 rounded w-full bg-white/20 text-white" required>
          </div>
          <div>
            <label for="gender">Gender *</label>
            <select id="gender" class="p-2 rounded w-full bg-white/20 text-white" required>
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label for="dob">Date of Birth *</label>
            <input type="date" id="dob" class="p-2 rounded w-full bg-white/20 text-white" required title="Enter Date of Birth (e.g., 2012-05-15 for May 15, 2012—auto-converts from dd/mm/yyyy)">
          </div>
          <div>
            <label for="reportingDate">Date of Reporting *</label>
            <input type="date" id="reportingDate" class="p-2 rounded w-full bg-white/20 text-white" required title="Enter Reporting Date (when child joined Preform One, e.g., 2025-09-15 for mid-Sept—key for pro-rated fees)">
          </div>
          <div class="md:col-span-2">
            <label for="formerSchool">Former Primary School *</label>
            <input type="text" id="formerSchool" class="p-2 rounded w-full bg-white/20 text-white" required>
          </div>
          <div>
            <label for="parentContact">Parent Contact *</label>
            <input type="tel" id="parentContact" class="p-2 rounded w-full bg-white/20 text-white" placeholder="e.g., +255 712 345 678" required>
          </div>
          <div class="md:col-span-2">
            <label for="parentName">Parent Full Name *</label>
            <input type="text" id="parentName" class="p-2 rounded w-full bg-white/20 text-white" required>
          </div>
          <div class="md:col-span-2">
            <label for="photo">Passport Photo (optional, JPG/PNG <5MB)</label>
            <input type="file" id="photo" accept="image/*" class="p-2 rounded w-full bg-white/20 text-white">
          </div>
        </div>
        <button type="submit" class="mt-4 bg-blue-500 hover:bg-blue-600 p-3 rounded w-full md:w-auto">Register Student</button>
      </form>
    </div>
    
    <!-- Search Results -->
    <div id="searchResults" class="mt-8">
      <h2 class="text-xl mb-4">Quick Search (Live Students)</h2>
      <input type="text" id="searchInput" placeholder="Search by Name/ID/Parent Contact" class="p-2 rounded w-full mb-4" oninput="searchStudents()">
      <table class="w-full bg-white/10 rounded overflow-hidden">
        <thead><tr class="bg-white/20"><th>Name</th><th>ADM No</th><th>Reporting Date</th><th>Total Fee</th><th>Balance</th><th>Actions</th></tr></thead>
        <tbody id="resultsBody">
          <tr><td colspan="6" class="text-center p-4">No students registered yet. Create your first admission above.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function showForm() { 
      document.getElementById('admissionForm').style.display = 'block'; 
      document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' }); // Smooth scroll to form
    }
    
    document.getElementById('admForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Registering...';
      
      try {
        // Validate required fields
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const gender = document.getElementById('gender').value;
        const dob = document.getElementById('dob').value;
        const reportingDate = document.getElementById('reportingDate').value;
        const parentContact = document.getElementById('parentContact').value.trim();
        const parentName = document.getElementById('parentName').value.trim();
        const formerSchool = document.getElementById('formerSchool').value.trim();
        
        if (!firstName || !lastName || !gender || !dob || !reportingDate || !parentContact || !parentName || !formerSchool) {
          throw new Error('Please fill all required fields (marked with *).');
        }
        
        // Handle photo upload
        const photoFile = document.getElementById('photo').files[0];
        let photoUrl = '';
        if (photoFile) {
          try {
            photoUrl = await uploadToCloudinary(photoFile, 'preformone/photos');
          } catch (uploadErr) {
            console.warn('Photo upload failed:', uploadErr); // Optional—continue without photo
          }
        }
        
        // Generate ADM No and calculate fee
        const admNo = generateAdmNo();
        const totalFee = calculateTotalFee(reportingDate);
        
        // Student object
        const student = {
          firstName,
          middleName: document.getElementById('middleName').value.trim() || '',
          lastName,
          gender,
          dob,
          reportingDate,
          formerSchool,
          parentContact,
          parentName,
          photoUrl,
          totalFee,
          payments: [],
          attendance: [],
          scores: [],
          shifted: false
        };
        
        // Save to Firebase
        await db.ref(`/schools/Socrates School Preform one/${currentYear}/students/${admNo}`).set(student);
        
        // Success: Alert with details, reset form, refresh search
        Swal.fire({
          title: 'Success!',
          text: `Student "${firstName} ${lastName}" (ADM: ${admNo}) registered. Total Fee: TSh ${totalFee.toLocaleString()}.`,
          icon: 'success',
          confirmButtonText: 'OK'
        });
        document.getElementById('admForm').reset();
        document.getElementById('admissionForm').style.display = 'none';
        searchStudents(); // Auto-refresh list
        
      } catch (err) {
        console.error('Admission error:', err);
        Swal.fire('Error', err.message || 'Failed to register student. Check console for details.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Register Student';
      }
    });
    
    function searchStudents() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      db.ref(`/schools/Socrates School Preform one/${currentYear}/students`).once('value').then((snap) => {
        const studentsObj = snap.val() || {};
        const students = Object.entries(studentsObj);
        
        let filtered = students;
        if (query) {
          filtered = students.filter(([adm, s]) => 
            (s.firstName + ' ' + s.lastName + ' ' + s.parentName + ' ' + s.parentContact).toLowerCase().includes(query) ||
            adm.toLowerCase().includes(query)
          );
        }
        
        const tbody = document.getElementById('resultsBody');
        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">No students match your search. Try creating a new admission.</td></tr>';
          return;
        }
        
        tbody.innerHTML = filtered.map(([adm, s]) => {
          const paid = (s.payments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
          const balance = (s.totalFee || 0) - paid;
          return `<tr>
            <td>${s.firstName} ${s.lastName}</td>
            <td>${adm}</td>
            <td>${s.reportingDate || 'N/A'}</td>
            <td>TSh ${s.totalFee?.toLocaleString() || 0}</td>
            <td>TSh ${balance.toLocaleString()}</td>
            <td>
              <button class="bg-yellow-500 text-white px-2 py-1 rounded mr-1" onclick="editStudent('${adm}')">Edit</button>
              <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="deleteStudent('${adm}')">Delete</button>
            </td>
          </tr>`;
        }).join('');
      }).catch((err) => {
        console.error('Search error:', err);
        document.getElementById('resultsBody').innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-300">Error loading students. Try again.</td></tr>';
      });
    }
    
    function editStudent(adm) {
      Swal.fire('Edit Student', 'Edit functionality coming soon—contact admin for changes.', 'info');
      // TODO: Load form with student data, update on save
    }
    
    function deleteStudent(adm) {
      Swal.fire({
        title: 'Delete Student?',
        text: 'This removes the student record permanently.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Delete'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref(`/schools/Socrates School Preform one/${currentYear}/students/${adm}`).remove().then(() => {
            Swal.fire('Deleted!', 'Student removed.', 'success');
            searchStudents();
          }).catch((err) => {
            Swal.fire('Error', err.message, 'error');
          });
        }
      });
    }
    
    // Initial load
    searchStudents();
  </script>
</body>
</html>