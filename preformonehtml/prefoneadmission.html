<!DOCTYPE html>
<html lang="en">
<head>
  <title>SoMAp  -  Preform One Admissions</title>
  <!-- Firebase Compat SDKs (v9.6.10 for consistency with repo) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  
  <!-- UI Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <!-- Shared Preform One Logic -->
  <script src="prefonecommon.js"></script>
  
  <style>
    body {
      min-height: 100vh;
      background:
        radial-gradient(1200px circle at 10% 10%, rgba(56, 189, 248, 0.18), transparent 55%),
        radial-gradient(900px circle at 85% 15%, rgba(129, 140, 248, 0.22), transparent 60%),
        linear-gradient(135deg, #050713, #10172a 35%, #0b1120 70%, #1f2933);
      color: #e2e8f0;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    label {
      display: block;
      margin-bottom: 0.55rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: #e2e8f0;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .glass-panel {
      background: rgba(15, 23, 42, 0.58);
      border: 1px solid rgba(148, 163, 184, 0.12);
      border-radius: 1.75rem;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 24px 48px rgba(8, 11, 34, 0.35);
    }

    .glass-input {
      width: 100%;
      padding: 0.8rem 1rem;
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(15, 23, 42, 0.45);
      color: #f8fafc;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }

    .glass-input::placeholder {
      color: rgba(226, 232, 240, 0.55);
      letter-spacing: 0.01em;
    }

    .glass-input:focus {
      border-color: rgba(45, 212, 191, 0.6);
      box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.15);
      transform: translateY(-1px);
      outline: none;
    }

    .glass-input[type="file"] {
      cursor: pointer;
      color: rgba(226, 232, 240, 0.85);
    }

    #totalFeeDisplay {
      background: rgba(16, 185, 129, 0.12);
      color: #6ee7b7;
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      border-color: rgba(16, 185, 129, 0.35);
    }

    .stat-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.25rem;
      border-radius: 1.5rem;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.14);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04), 0 18px 40px rgba(8, 11, 34, 0.25);
    }

    .stat-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 3.2rem;
      height: 3.2rem;
      border-radius: 1rem;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: inset 0 0 20px rgba(15, 23, 42, 0.35);
      font-size: 1.35rem;
    }

    .stat-label {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      color: rgba(148, 163, 184, 0.75);
      margin-bottom: 0.25rem;
    }

    .stat-value {
      font-size: 1.65rem;
      font-weight: 700;
      color: #f8fafc;
    }

    .glass-table {
      border-radius: 1.5rem;
      border: 1px solid rgba(148, 163, 184, 0.12);
      background: rgba(15, 23, 42, 0.48);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .glass-table thead {
      background: rgba(148, 163, 184, 0.12);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.75rem;
      color: rgba(226, 232, 240, 0.85);
    }

    .glass-table tbody tr {
      border-top: 1px solid rgba(148, 163, 184, 0.08);
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .glass-table tbody tr:hover {
      background: rgba(148, 163, 184, 0.08);
      transform: translateY(-1px);
    }

    .form-group small {
      color: rgba(148, 163, 184, 0.7);
    }
  </style>
</head>
<body class="min-h-screen text-slate-100 px-4 py-10">
  <div class="max-w-6xl mx-auto space-y-8">
    <div class="glass-panel p-6 md:p-8 rounded-3xl shadow-2xl border border-white/10">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <div class="space-y-3">
          <h1 class="text-3xl md:text-4xl font-bold tracking-tight flex items-center gap-3"><span class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-300 backdrop-blur-sm"><i class="fas fa-user-plus"></i></span> Preform One Admissions</h1>
          <p class="max-w-2xl text-sm md:text-base text-slate-200/80">Register new Class 7 graduates for the Preform One transition program (Sep–Dec 2025). Program fees auto-calculate based on reporting date so your finance team stays in sync.</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
          <a href="prefonedashboard.html" class="inline-flex items-center justify-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-semibold text-slate-100 transition hover:bg-white/10"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
          <button onclick="showForm()" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-500 px-4 py-3 text-sm font-semibold text-slate-900 shadow-lg shadow-emerald-500/30 transition hover:shadow-emerald-400/50"><i class="fas fa-plus"></i> Create New Admission</button>
        </div>
      </div>
    </div>
    
    <!-- Admission Form -->
    <div id="admissionForm" style="display:none;" class="glass-panel p-6 md:p-8 rounded-3xl border border-white/10 shadow-xl">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-4">
        <div>
          <h2 id="formTitle" class="text-xl font-bold">New Student Details</h2>
          <p id="formSubtitle" class="text-sm text-white/80">Register a new Preform One candidate.</p>
        </div>
        <div id="editBadge" class="hidden text-xs md:text-sm bg-yellow-400/20 text-yellow-100 px-3 py-1 rounded-full border border-yellow-200/40 shadow-inner">
          Editing ADM <span id="editBadgeAdm" class="font-semibold"></span>
        </div>
      </div>
      <form id="admForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- First Name -->
          <div class="form-group">
            <label for="firstName">First Name *</label>
            <input type="text" id="firstName" class="glass-input" placeholder="e.g., Joseph" required maxlength="50">
          </div>
          
          <!-- Middle Name -->
          <div class="form-group">
            <label for="middleName">Middle Name (optional)</label>
            <input type="text" id="middleName" class="glass-input" placeholder="e.g., Otieno">
          </div>
          
          <!-- Last Name -->
          <div class="form-group">
            <label for="lastName">Last Name *</label>
            <input type="text" id="lastName" class="glass-input" placeholder="e.g., Omondi" required maxlength="50">
          </div>
          
          <!-- Gender -->
          <div class="form-group">
            <label for="gender">Gender *</label>
            <select id="gender" class="glass-input" required>
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <!-- Date of Birth -->
          <div class="form-group">
            <label for="dob">Date of Birth *</label>
            <input type="date" id="dob" class="glass-input" required title="Date of Birth (e.g., 2012-05-15 for May 15, 2012 - auto-converts from dd/mm/yyyy if typed)">
          </div>
          
          <!-- Date of Reporting -->
          <div class="form-group">
            <label for="reportingDate">Date of Reporting *</label>
            <input type="date" id="reportingDate" class="glass-input" required title="Reporting Date (when child joined Preform One, e.g., 2025-09-15 for mid-Sept - key for pro-rated fees)" oninput="handleDateInput(this)" onchange="updateTotalFee()">
          </div>
          
          <!-- Total Fee Display -->
          <div class="form-group md:col-span-2">
            <label for="totalFeeDisplay">Total Fee for Program (Auto-Calculated based on Reporting Date)</label>
            <input type="text" id="totalFeeDisplay" class="glass-input font-semibold text-lg text-emerald-200 tracking-wide" readonly value="TSh 0 (Enter Reporting Date to calculate)">
            <small class="block text-xs opacity-75 mt-1">Fee pro-rated: Full months TSh 15,000; December to 15th (days/30 * 15,000). Program ends Dec 15, 2025.</small>
          </div>
          
          <!-- Former School -->
          <div class="form-group md:col-span-2">
            <label for="formerSchool">Former Primary School *</label>
            <input type="text" id="formerSchool" class="glass-input" placeholder="e.g., Arusha Primary School" required maxlength="100">
          </div>
          
          <!-- Parent Contact -->
          <div class="form-group">
            <label for="parentContact">Parent Contact *</label>
            <input type="tel" id="parentContact" class="glass-input" placeholder="e.g., +255 712 345 678" required pattern="^\+255[6-7]\d{8}$" title="Tanzania format: +255 followed by 9 digits (e.g., +255712345678)">
          </div>
          
          <!-- Parent Name -->
          <div class="form-group md:col-span-2">
            <label for="parentName">Parent Full Name *</label>
            <input type="text" id="parentName" class="glass-input" placeholder="e.g., Asha Mnyore" required maxlength="100">
          </div>
          
          <!-- Photo -->
          <div class="form-group md:col-span-2">
            <label for="photo">Passport Photo (optional, JPG/PNG <5MB)</label>
            <input type="file" id="photo" accept="image/*" class="glass-input">
            <small id="photoNote" class="block text-xs opacity-75 mt-1">Upload child's passport photo for ID card generation.</small>
          </div>
        </div>
        <div class="mt-6 flex flex-col md:flex-row gap-3">
          <button type="submit" id="submitBtn" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-sky-500 via-indigo-500 to-purple-500 px-6 py-3 font-semibold text-white shadow-lg shadow-sky-500/40 transition hover:shadow-sky-400/60 hover:-translate-y-0.5">Register Student</button>
          <button type="button" id="cancelEditBtn" class="hidden inline-flex items-center justify-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-6 py-3 font-semibold text-slate-100 transition hover:bg-white/10" onclick="cancelEdit()">Cancel Edit</button>
        </div>
      </form>
    </div>
    
    <!-- Search Results -->
    <div id="searchResults" class="glass-panel p-6 md:p-8 rounded-3xl border border-white/10 shadow-xl">
      <h2 class="text-xl md:text-2xl font-semibold mb-4 flex items-center gap-3"><span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-sky-500/15 text-sky-300"><i class="fas fa-search"></i></span> Quick Search (Live Students)</h2>
      <p class="text-sm opacity-75 mb-6">Search registered Preform One students by name, ADM No, or parent contact.</p>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="summaryCards">
        <div class="stat-card">
          <div class="stat-icon bg-emerald-500/20 text-emerald-300">
            <i class="fas fa-users"></i>
          </div>
          <div>
            <p class="stat-label">Live Admissions</p>
            <p id="statTotalStudents" class="stat-value">--</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon bg-cyan-500/20 text-cyan-300">
            <i class="fas fa-coins"></i>
          </div>
          <div>
            <p class="stat-label">Total Program Fees</p>
            <p id="statTotalFees" class="stat-value">--</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon bg-amber-500/20 text-amber-300">
            <i class="fas fa-wallet"></i>
          </div>
          <div>
            <p class="stat-label">Outstanding Balance</p>
            <p id="statOutstanding" class="stat-value">--</p>
          </div>
        </div>
      </div>

      <div class="relative mb-6">
        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
        <input type="text" id="searchInput" placeholder="Search by Name, ADM No, or Parent Contact" class="glass-input pl-12" oninput="searchStudents()">
      </div>

      <table class="w-full glass-table overflow-hidden">
        <thead>
          <tr>
            <th class="p-3 text-left">Full Name</th>
            <th class="p-3 text-left">ADM No</th>
            <th class="p-3 text-left">Reporting Date</th>
            <th class="p-3 text-left">Total Fee</th>
            <th class="p-3 text-left">Balance</th>
            <th class="p-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
          <tr class="text-center p-4 opacity-75">
            <td colspan="6">No students registered yet. Create your first admission above.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const firebaseConfig = {
    apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
    authDomain: "somaptestt.firebaseapp.com",
    databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
    projectId: "somaptestt",
    storageBucket: "somaptestt.appspot.com",
    messagingSenderId: "105526245138",
    appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
    measurementId: "G-4HKX7KN6Q3"
  };

  // Initialize Firebase (compat)
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();
    // Ensure currentYear is available (from prefonecommon.js)
    if (typeof currentYear === 'undefined') {
      currentYear = new Date().getFullYear(); // Fallback to active calendar year
    }

    let studentsCache = {};
    let editingAdm = null;
    let editingStudentSnapshot = null;

    const formatTSh = (value) => {
      if (typeof formatCurrency === 'function') {
        return formatCurrency(value);
      }
      const amount = Number(value || 0);
      return `TSh ${amount.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
    };

    function resetFormState() {
      const form = document.getElementById('admForm');
      if (form) {
        form.reset();
      }
      const totalFeeDisplay = document.getElementById('totalFeeDisplay');
      if (totalFeeDisplay) {
        totalFeeDisplay.value = 'TSh 0 (Enter Reporting Date to calculate)';
      }
      const formTitle = document.getElementById('formTitle');
      if (formTitle) {
        formTitle.textContent = 'New Student Details';
      }
      const formSubtitle = document.getElementById('formSubtitle');
      if (formSubtitle) {
        formSubtitle.textContent = 'Register a new Preform One candidate.';
      }
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) {
        submitBtn.textContent = 'Register Student';
      }
      const editBadge = document.getElementById('editBadge');
      if (editBadge) {
        editBadge.classList.add('hidden');
      }
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      if (cancelEditBtn) {
        cancelEditBtn.classList.add('hidden');
      }
      const photoNote = document.getElementById('photoNote');
      if (photoNote) {
        photoNote.textContent = 'Upload child\'s passport photo for ID card generation.';
      }
      const photoInput = document.getElementById('photo');
      if (photoInput) {
        photoInput.value = '';
      }
    }

    function updateSummaryCards(studentsObj) {
      const totalEl = document.getElementById('statTotalStudents');
      const feeEl = document.getElementById('statTotalFees');
      const outstandingEl = document.getElementById('statOutstanding');
      if (!totalEl || !feeEl || !outstandingEl) return;

      const entries = Object.entries(studentsObj || {});
      const totalStudents = entries.length;
      let totalFees = 0;
      let outstanding = 0;

      entries.forEach(([, student]) => {
        if (!student) return;
        const fee = Number(student.totalFee || 0);
        totalFees += fee;
        const paymentsArray = Object.values(student.payments || {});
        const paid = paymentsArray.reduce((sum, payment) => sum + Number(payment.amount || 0), 0);
        const balance = fee - paid;
        if (balance > 0) {
          outstanding += balance;
        }
      });

      totalEl.textContent = totalStudents.toString();
      feeEl.textContent = formatTSh(totalFees);
      outstandingEl.textContent = formatTSh(outstanding);
    }
    
    // Handle date input for live updates (fires on every keystroke for type="date")
    function handleDateInput(input) {
      // For date inputs, oninput helps with partial typing, but onchange is main trigger
      if (input.value.length >= 8) { // Basic check for valid partial date
        setTimeout(updateTotalFee, 300); // Delay to avoid spam
      }
    }
    
    // Auto-calculate Total Fee on Reporting Date change (triggered by onchange/oninput)
    function updateTotalFee() {
      const reportingDateInput = document.getElementById('reportingDate');
      const totalFeeDisplay = document.getElementById('totalFeeDisplay');
      
      if (!reportingDateInput.value) {
        totalFeeDisplay.value = 'TSh 0 (Enter Reporting Date to calculate)';
        return;
      }
      
      const reportingDateStr = reportingDateInput.value; // YYYY-MM-DD
      const reportingDate = new Date(reportingDateStr + 'T00:00:00'); // Ensure full date
      
      // Program end: Dec 15, currentYear
      const endDate = new Date(currentYear, 11, 15, 23, 59, 59); // End of Dec 15
      
      if (isNaN(reportingDate.getTime()) || reportingDate > endDate) {
        totalFeeDisplay.value = 'TSh 0 (Invalid date or after program end)';
        return;
      }
      
      let totalFee = 0;
      let current = new Date(reportingDate.getFullYear(), reportingDate.getMonth(), reportingDate.getDate());
      
      while (current <= endDate) {
        const currentMonth = current.getMonth();
        const currentYearMonth = current.getFullYear();
        
        if (currentMonth === 11) { // December: Pro-rate to 15th
          const decDaysAvailable = 15; // Up to Dec 15
          const enrolledDecDays = Math.min(decDaysAvailable - current.getDate() + 1, decDaysAvailable);
          if (enrolledDecDays > 0) {
            totalFee += Math.round((enrolledDecDays / 30) * 15000);
          }
        } else {
          // Full month fee: 15,000 TSh (even if partial start in month, per your examples)
          totalFee += 15000;
        }
        
        // Move to start of next month
        current.setDate(1);
        current.setMonth(currentMonth + 1);
        if (current.getFullYear() !== currentYearMonth) break; // Stop if year changes
      }
      
      // Display with example breakdown for clarity
      const breakdown = reportingDateInput.value.startsWith('2025-09') ? ' (Full Sep + Oct + Pro Dec)' : 
                       reportingDateInput.value.startsWith('2025-10') ? ' (Full Oct + Nov + Pro Dec)' : 
                       ' (Pro-rated from start)';
      totalFeeDisplay.value = `TSh ${totalFee.toLocaleString()}${breakdown}`;
    }
    
    function showForm(student = null, admNo = '') {
      const formWrapper = document.getElementById('admissionForm');
      if (formWrapper) {
        formWrapper.style.display = 'block';
        formWrapper.scrollIntoView({ behavior: 'smooth' });
      }

      if (student && admNo) {
        editingAdm = admNo;
        editingStudentSnapshot = JSON.parse(JSON.stringify(student));

        const formTitle = document.getElementById('formTitle');
        if (formTitle) {
          formTitle.textContent = 'Edit Student Details';
        }
        const formSubtitle = document.getElementById('formSubtitle');
        if (formSubtitle) {
          formSubtitle.textContent = 'Update learner information below. Admission number stays the same.';
        }
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
          submitBtn.textContent = 'Save Changes';
        }
        const editBadge = document.getElementById('editBadge');
        if (editBadge) {
          editBadge.classList.remove('hidden');
        }
        const editBadgeAdm = document.getElementById('editBadgeAdm');
        if (editBadgeAdm) {
          editBadgeAdm.textContent = admNo;
        }
        const cancelBtn = document.getElementById('cancelEditBtn');
        if (cancelBtn) {
          cancelBtn.classList.remove('hidden');
        }

        document.getElementById('firstName').value = student.firstName || '';
        document.getElementById('middleName').value = student.middleName || '';
        document.getElementById('lastName').value = student.lastName || '';
        document.getElementById('gender').value = student.gender || '';
        document.getElementById('dob').value = (student.dob || '').substring(0, 10);
        document.getElementById('reportingDate').value = student.reportingDate || '';
        document.getElementById('formerSchool').value = student.formerSchool || '';
        document.getElementById('parentContact').value = student.parentContact || '';
        document.getElementById('parentName').value = student.parentName || '';

        const totalFeeDisplay = document.getElementById('totalFeeDisplay');
        if (totalFeeDisplay) {
          totalFeeDisplay.value = student.totalFee
            ? `${formatTSh(student.totalFee)} (current record)`
            : 'TSh 0 (Enter Reporting Date to calculate)';
        }

        const photoNote = document.getElementById('photoNote');
        if (photoNote) {
          photoNote.textContent = student.photoUrl
            ? 'Existing photo will be kept unless you upload a new one.'
            : 'Upload child\'s passport photo for ID card generation.';
        }
      } else {
        editingAdm = null;
        editingStudentSnapshot = null;
        resetFormState();
      }

      const photoInput = document.getElementById('photo');
      if (photoInput) {
        photoInput.value = '';
      }

      const reportingDate = document.getElementById('reportingDate');
      if (reportingDate) {
        setTimeout(() => reportingDate.focus(), 150);
      }
    }
    
    function cancelEdit() {
      editingAdm = null;
      editingStudentSnapshot = null;
      resetFormState();
      const formWrapper = document.getElementById('admissionForm');
      if (formWrapper) {
        formWrapper.style.display = 'none';
      }
    }
    
    document.getElementById('admForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById('submitBtn');
      const isEditing = Boolean(editingAdm);
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = isEditing ? 'Saving...' : 'Registering...';
      }
      
      try {
        const firstName = document.getElementById('firstName').value.trim();
        const middleName = document.getElementById('middleName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const gender = document.getElementById('gender').value;
        const dob = document.getElementById('dob').value;
        const reportingDate = document.getElementById('reportingDate').value;
        const parentContact = document.getElementById('parentContact').value.trim();
        const parentName = document.getElementById('parentName').value.trim();
        const formerSchool = document.getElementById('formerSchool').value.trim();
        
        if (!firstName || !lastName || !gender || !dob || !reportingDate || !parentContact || !parentName || !formerSchool) {
          throw new Error('Please fill all required fields (marked with *).');
        }
        
        const tanzaniaPhoneRegex = /^\+255[6-7]\d{8}$/;
        if (!tanzaniaPhoneRegex.test(parentContact)) {
          throw new Error('Parent Contact must be in Tanzania format (e.g., +255712345678).');
        }
        
        if (!Object.keys(studentsCache).length) {
          const snapshot = await db.ref(`/schools/Socrates School Preform one/${currentYear}/students`).once('value');
          studentsCache = snapshot.val() || {};
        }
        
        const normalize = (value = '') => value.toString().toLowerCase().replace(/\s+/g, ' ').trim();
        
        const targetName = normalize(`${firstName} ${middleName} ${lastName}`);
        const targetParentName = normalize(parentName);
        const targetParentContact = normalize(parentContact);
        const targetFormerSchool = normalize(formerSchool);
        
        const duplicateEntry = Object.entries(studentsCache).find(([adm, student]) => {
          if (!student) return false;
          if (editingAdm && adm === editingAdm) return false;
          const studentName = normalize(`${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`);
          const studentParentName = normalize(student.parentName || '');
          const studentParentContact = normalize(student.parentContact || '');
          const studentFormerSchool = normalize(student.formerSchool || '');
          return studentName === targetName &&
                 studentParentName === targetParentName &&
                 studentParentContact === targetParentContact &&
                 studentFormerSchool === targetFormerSchool;
        });
        
        if (duplicateEntry) {
          throw new Error(`This student is already registered under ADM ${duplicateEntry[0]}.`);
        }
        
        const photoInput = document.getElementById('photo');
        const photoFile = photoInput && photoInput.files ? photoInput.files[0] : null;
        let photoUrl = isEditing && editingStudentSnapshot ? (editingStudentSnapshot.photoUrl || '') : '';
        
        if (photoFile) {
          if (photoFile.size > 5 * 1024 * 1024) {
            throw new Error('Photo must be less than 5MB.');
          }
          try {
            photoUrl = await uploadToCloudinary(photoFile, 'preformone/photos');
          } catch (uploadErr) {
            console.warn('Photo upload failed:', uploadErr);
            Swal.fire({
              title: 'Photo Upload Failed',
              text: 'Registration will continue without updating the photo.',
              icon: 'warning',
              confirmButtonText: 'Continue'
            });
          }
        }
        
        const totalFee = calculateTotalFee(reportingDate);
        const admNo = editingAdm || generateAdmNo();
        const registrationDate = new Date().toISOString().split('T')[0];
        
        let studentPayload;
        
        if (isEditing) {
          const base = studentsCache[admNo] || editingStudentSnapshot || {};
          studentPayload = {
            ...base,
            firstName,
            middleName: middleName || '',
            lastName,
            gender,
            dob,
            reportingDate,
            formerSchool,
            parentContact,
            parentName,
            photoUrl: photoUrl || '',
            totalFee
          };
          if (!studentPayload.registrationDate) {
            studentPayload.registrationDate = registrationDate;
          }
        } else {
          studentPayload = {
            firstName,
            middleName: middleName || '',
            lastName,
            gender,
            dob,
            reportingDate,
            formerSchool,
            parentContact,
            parentName,
            photoUrl: photoUrl || '',
            totalFee,
            payments: [],
            attendance: [],
            scores: [],
            shifted: false,
            registrationDate,
            school: 'Socrates School Preform One'
          };
        }
        
        await db.ref(`/schools/Socrates School Preform one/${currentYear}/students/${admNo}`).set(studentPayload);
        
        studentsCache[admNo] = studentPayload;
        updateSummaryCards(studentsCache);
        
        Swal.fire({
          title: isEditing ? 'Changes Saved!' : 'Registration Successful!',
          html: `
            <div class="text-left">
              <p><strong>Student:</strong> ${firstName} ${lastName}</p>
              <p><strong>ADM No:</strong> ${admNo}</p>
              <p><strong>Total Fee:</strong> ${formatTSh(totalFee)} (from ${reportingDate})</p>
              <p><strong>Parent:</strong> ${parentName} (${parentContact})</p>
              <p><strong>Former School:</strong> ${formerSchool}</p>
            </div>
          `,
          icon: 'success',
          confirmButtonText: 'OK'
        });
        
        editingAdm = null;
        editingStudentSnapshot = null;
        resetFormState();
        const formWrapper = document.getElementById('admissionForm');
        if (formWrapper) {
          formWrapper.style.display = 'none';
        }
        
        searchStudents();
        document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
        
      } catch (err) {
        console.error('Admission error:', err);
        Swal.fire({
          title: 'Action Failed',
          text: err.message || 'An unexpected error occurred. Please try again or contact admin.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = editingAdm ? 'Save Changes' : 'Register Student';
        }
      }
    });
    
    function searchStudents() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const tbody = document.getElementById('resultsBody');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 opacity-75"><i class="fas fa-spinner fa-spin mr-2"></i>Loading students...</td></tr>';
      
      db.ref(`/schools/Socrates School Preform one/${currentYear}/students`).once('value').then((snap) => {
        const studentsObj = snap.val() || {};
        studentsCache = studentsObj;
        updateSummaryCards(studentsObj);
        const students = Object.entries(studentsObj);
        
        let filtered = students;
        if (query) {
          filtered = students.filter(([adm, s]) => 
            `${s.firstName} ${s.lastName} ${s.parentName} ${s.parentContact}`.toLowerCase().includes(query) ||
            adm.toLowerCase().includes(query)
          );
        }
        
        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 opacity-75">No students match your search. Try creating a new admission above.</td></tr>';
          return;
        }
        
        tbody.innerHTML = filtered.map(([adm, s]) => {
          const paymentsArray = Object.values(s.payments || {});
          const paid = paymentsArray.reduce((sum, p) => sum + Number(p.amount || 0), 0);
          const balance = Number(s.totalFee || 0) - paid;
          const fullName = `${s.firstName} ${s.lastName}`;
          const balanceClass = balance > 0 ? 'text-red-300' : 'text-green-300';
          return `<tr class="hover:bg-white/5 transition">
            <td class="p-3">${fullName}</td>
            <td class="p-3">${adm}</td>
            <td class="p-3">${s.reportingDate ? new Date(s.reportingDate).toLocaleDateString('en-GB') : 'N/A'}</td>
            <td class="p-3">${formatTSh(s.totalFee)}</td>
            <td class="p-3 ${balanceClass}">${formatTSh(balance)}</td>
            <td class="p-3">
              <button class="bg-yellow-500 text-white px-3 py-1 rounded mr-2 text-sm shadow-sm hover:bg-yellow-600" onclick="editStudent('${adm}')"><i class="fas fa-edit mr-1"></i>Edit</button>
              <button class="bg-red-500 text-white px-3 py-1 rounded text-sm shadow-sm hover:bg-red-600" onclick="deleteStudent('${adm}')"><i class="fas fa-trash mr-1"></i>Delete</button>
            </td>
          </tr>`;
        }).join('');
      }).catch((err) => {
        console.error('Search error:', err);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-300"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading students. Please try again.</td></tr>';
      });
    }        
        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 opacity-75">No students match your search. Try creating a new admission above.</td></tr>';
          return;
        }
        
        tbody.innerHTML = filtered.map(([adm, s]) => {
          const paymentsArray = Object.values(s.payments || {});
          const paid = paymentsArray.reduce((sum, p) => sum + Number(p.amount || 0), 0);
          const balance = Number(s.totalFee || 0) - paid;
          const fullName = `${s.firstName} ${s.lastName}`;
          return `<tr class="hover:bg-white/5">
            <td class="p-3">${fullName}</td>
            <td class="p-3">${adm}</td>
            <td class="p-3">${s.reportingDate ? new Date(s.reportingDate).toLocaleDateString('en-GB') : 'N/A'}</td>
            <td class="p-3">TSh ${Number(s.totalFee || 0).toLocaleString()}</td>
            <td class="p-3 ${balance > 0 ? 'text-red-300' : 'text-green-300'}">TSh ${balance.toLocaleString()}</td>
            <td class="p-3">
              <button class="bg-yellow-500 text-white px-3 py-1 rounded mr-2 text-sm" onclick="editStudent('${adm}')"><i class="fas fa-edit mr-1"></i>Edit</button>
              <button class="bg-red-500 text-white px-3 py-1 rounded text-sm" onclick="deleteStudent('${adm}')"><i class="fas fa-trash mr-1"></i>Delete</button>
            </td>
          </tr>`;
        }).join('');
      }).catch((err) => {
        console.error('Search error:', err);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-300"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading students. Please try again.</td></tr>';
      });
    }
    
    function editStudent(adm) {
      const cached = studentsCache[adm];
      if (cached) {
        showForm(cached, adm);
        return;
      }
      
      db.ref(`/schools/Socrates School Preform one/${currentYear}/students/${adm}`).once('value').then((snap) => {
        const student = snap.val();
        if (!student) {
          Swal.fire({
            title: 'Not Found',
            text: 'Unable to locate that student record. Refresh and try again.',
            icon: 'warning',
            confirmButtonText: 'OK'
          });
          return;
        }
        studentsCache[adm] = student;
        showForm(student, adm);
      }).catch((err) => {
        console.error('Load student error:', err);
        Swal.fire({
          title: 'Error',
          text: 'Unable to load student details. Please try again.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      });
    }    
    function deleteStudent(adm) {
      Swal.fire({
        title: 'Delete Student?',
        html: `Are you sure? This removes <strong>all data</strong> for ADM <strong>${adm}</strong> permanently (fees, attendance, scores).`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'Yes, Delete'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref(`/schools/Socrates School Preform one/${currentYear}/students/${adm}`).remove().then(() => {
            delete studentsCache[adm];
            if (editingAdm === adm) {
              cancelEdit();
            }
            updateSummaryCards(studentsCache);
            Swal.fire('Deleted!', 'Student record removed successfully.', 'success');
            searchStudents();
          }).catch((err) => {
            Swal.fire('Error', 'Delete failed: ' + err.message, 'error');
          });
        }
      });
    }      });
    }
    
    // Initial load: Search students
    searchStudents();
  </script>
</body>
</html>









