<!DOCTYPE html>
<html lang="en">
<head>
  <title>SoMAp — Preform One Admissions</title>
  <!-- Firebase Compat SDKs (v9.6.10 for consistency with repo) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  
  <!-- UI Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <!-- Shared Preform One Logic -->
  <script src="prefonecommon.js"></script>
  
  <style>
    body { 
      background: linear-gradient(to right, #667eea, #764ba2); 
    }
    label { 
      display: block; 
      margin-bottom: 0.5rem; 
      font-weight: bold; 
      color: #f3f4f6; 
    }
    #totalFeeDisplay { 
      background: linear-gradient(to right, #10b981, #059669); 
      font-size: 1.1rem; 
      font-weight: bold; 
      color: white !important;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    input:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-400 to-purple-600 text-white p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6"><i class="fas fa-user-plus"></i> Preform One Admissions</h1>
    <p class="mb-4 text-sm opacity-90">Register new Class 7 graduates for Preform One transition program (Sep-Dec 2025). Total fee auto-calculates based on reporting date (pro-rated to Dec 15).</p>
    <a href="prefonedashboard.html" class="mb-4 inline-block bg-gray-500 hover:bg-gray-600 p-2 rounded text-white"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    
    <!-- Create New Admission Button -->
    <button onclick="showForm()" class="bg-green-500 hover:bg-green-600 text-white p-3 rounded mb-4 transition-colors"><i class="fas fa-plus mr-2"></i>Create New Admission</button>
    
    <!-- Admission Form -->
    <div id="admissionForm" style="display:none;" class="bg-white/10 p-6 rounded-lg mb-8">
      <h2 class="text-xl font-bold mb-4">New Student Details</h2>
      <form id="admForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- First Name -->
          <div class="form-group">
            <label for="firstName">First Name *</label>
            <input type="text" id="firstName" class="p-2 rounded w-full bg-white/20 text-white" placeholder="e.g., Joseph" required maxlength="50">
          </div>
          
          <!-- Middle Name -->
          <div class="form-group">
            <label for="middleName">Middle Name (optional)</label>
            <input type="text" id="middleName" class="p-2 rounded w-full bg-white/20 text-white" placeholder="e.g., Otieno">
          </div>
          
          <!-- Last Name -->
          <div class="form-group">
            <label for="lastName">Last Name *</label>
            <input type="text" id="lastName" class="p-2 rounded w-full bg-white/20 text-white" placeholder="e.g., Omondi" required maxlength="50">
          </div>
          
          <!-- Gender -->
          <div class="form-group">
            <label for="gender">Gender *</label>
            <select id="gender" class="p-2 rounded w-full bg-white/20 text-white" required>
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <!-- Date of Birth -->
          <div class="form-group">
            <label for="dob">Date of Birth *</label>
            <input type="date" id="dob" class="p-2 rounded w-full bg-white/20 text-white" required title="Date of Birth (e.g., 2012-05-15 for May 15, 2012—auto-converts from dd/mm/yyyy if typed)">
          </div>
          
          <!-- Date of Reporting -->
          <div class="form-group">
            <label for="reportingDate">Date of Reporting *</label>
            <input type="date" id="reportingDate" class="p-2 rounded w-full bg-white/20 text-white" required title="Reporting Date (when child joined Preform One, e.g., 2025-09-15 for mid-Sept—key for pro-rated fees)" oninput="handleDateInput(this)" onchange="updateTotalFee()">
          </div>
          
          <!-- Total Fee Display -->
          <div class="form-group md:col-span-2">
            <label for="totalFeeDisplay">Total Fee for Program (Auto-Calculated based on Reporting Date)</label>
            <input type="text" id="totalFeeDisplay" class="p-2 rounded w-full bg-green-500/30 text-white font-bold text-lg" readonly value="TSh 0 (Enter Reporting Date to calculate)">
            <small class="block text-xs opacity-75 mt-1">Fee pro-rated: Full months TSh 15,000; December to 15th (days/30 * 15,000). Program ends Dec 15, 2025.</small>
          </div>
          
          <!-- Former School -->
          <div class="form-group md:col-span-2">
            <label for="formerSchool">Former Primary School *</label>
            <input type="text" id="formerSchool" class="p-2 rounded w-full bg-white/20 text-white" placeholder="e.g., Arusha Primary School" required maxlength="100">
          </div>
          
          <!-- Parent Contact -->
          <div class="form-group">
            <label for="parentContact">Parent Contact *</label>
            <input type="tel" id="parentContact" class="p-2 rounded w-full bg-white/20 text-white" placeholder="e.g., +255 712 345 678" required pattern="^\+255[6-7]\d{8}$" title="Tanzania format: +255 followed by 9 digits (e.g., +255712345678)">
          </div>
          
          <!-- Parent Name -->
          <div class="form-group md:col-span-2">
            <label for="parentName">Parent Full Name *</label>
            <input type="text" id="parentName" class="p-2 rounded w-full bg-white/20 text-white" placeholder="e.g., Asha Mnyore" required maxlength="100">
          </div>
          
          <!-- Photo -->
          <div class="form-group md:col-span-2">
            <label for="photo">Passport Photo (optional, JPG/PNG <5MB)</label>
            <input type="file" id="photo" accept="image/*" class="p-2 rounded w-full bg-white/20 text-white">
            <small class="block text-xs opacity-75 mt-1">Upload child's passport photo for ID card generation.</small>
          </div>
        </div>
        <button type="submit" class="mt-4 bg-blue-500 hover:bg-blue-600 p-3 rounded w-full md:w-auto text-white font-bold">Register Student</button>
      </form>
    </div>
    
    <!-- Search Results -->
    <div id="searchResults" class="mt-8">
      <h2 class="text-xl mb-4">Quick Search (Live Students)</h2>
      <p class="text-sm opacity-75 mb-2">Search registered Preform One students by name, ADM No, or parent contact.</p>
      <input type="text" id="searchInput" placeholder="Search by Name/ID/Parent Contact" class="p-2 rounded w-full mb-4" oninput="searchStudents()">
      <table class="w-full bg-white/10 rounded overflow-hidden">
        <thead class="bg-white/20">
          <tr>
            <th class="p-3 text-left">Full Name</th>
            <th class="p-3 text-left">ADM No</th>
            <th class="p-3 text-left">Reporting Date</th>
            <th class="p-3 text-left">Total Fee</th>
            <th class="p-3 text-left">Balance</th>
            <th class="p-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
          <tr class="text-center p-4 opacity-75">
            <td colspan="6">No students registered yet. Create your first admission above.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    window.db = db;
    console.log('Firebase init success, db ready'); // Temp test log
    
    // Ensure currentYear is available (from prefonecommon.js)
    if (typeof currentYear === 'undefined') {
      currentYear = new Date().getFullYear(); // Fallback to 2025
    }
    
    // Handle date input for live updates (fires on every keystroke for type="date")
    function handleDateInput(input) {
      // For date inputs, oninput helps with partial typing, but onchange is main trigger
      if (input.value.length >= 8) { // Basic check for valid partial date
        setTimeout(updateTotalFee, 300); // Delay to avoid spam
      }
    }
    
    // Auto-calculate Total Fee on Reporting Date change (triggered by onchange/oninput)
    function updateTotalFee() {
      const reportingDateInput = document.getElementById('reportingDate');
      const totalFeeDisplay = document.getElementById('totalFeeDisplay');
      
      if (!reportingDateInput.value) {
        totalFeeDisplay.value = 'TSh 0 (Enter Reporting Date to calculate)';
        return;
      }
      
      const reportingDateStr = reportingDateInput.value; // YYYY-MM-DD
      const reportingDate = new Date(reportingDateStr + 'T00:00:00'); // Ensure full date
      
      // Program end: Dec 15, currentYear
      const endDate = new Date(currentYear, 11, 15, 23, 59, 59); // End of Dec 15
      
      if (isNaN(reportingDate.getTime()) || reportingDate > endDate) {
        totalFeeDisplay.value = 'TSh 0 (Invalid date or after program end)';
        return;
      }
      
      let totalFee = 0;
      let current = new Date(reportingDate.getFullYear(), reportingDate.getMonth(), reportingDate.getDate());
      
      while (current <= endDate) {
        const currentMonth = current.getMonth();
        const currentYearMonth = current.getFullYear();
        
        if (currentMonth === 11) { // December: Pro-rate to 15th
          const decDaysAvailable = 15; // Up to Dec 15
          const enrolledDecDays = Math.min(decDaysAvailable - current.getDate() + 1, decDaysAvailable);
          if (enrolledDecDays > 0) {
            totalFee += Math.round((enrolledDecDays / 30) * 15000);
          }
        } else {
          // Full month fee: 15,000 TSh (even if partial start in month, per your examples)
          totalFee += 15000;
        }
        
        // Move to start of next month
        current.setDate(1);
        current.setMonth(currentMonth + 1);
        if (current.getFullYear() !== currentYearMonth) break; // Stop if year changes
      }
      
      // Display with example breakdown for clarity
      const breakdown = reportingDateInput.value.startsWith('2025-09') ? ' (Full Sep + Oct + Pro Dec)' : 
                       reportingDateInput.value.startsWith('2025-10') ? ' (Full Oct + Nov + Pro Dec)' : 
                       ' (Pro-rated from start)';
      totalFeeDisplay.value = `TSh ${totalFee.toLocaleString()}${breakdown}`;
    }
    
    function showForm() { 
      document.getElementById('admissionForm').style.display = 'block'; 
      document.getElementById('admissionForm').scrollIntoView({ behavior: 'smooth' }); // Smooth scroll to form
      document.getElementById('reportingDate').focus(); // Focus on key field
    }
    
    document.getElementById('admForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Registering...';
      
      try {
        // Validate required fields
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const gender = document.getElementById('gender').value;
        const dob = document.getElementById('dob').value;
        const reportingDate = document.getElementById('reportingDate').value;
        const parentContact = document.getElementById('parentContact').value.trim();
        const parentName = document.getElementById('parentName').value.trim();
        const formerSchool = document.getElementById('formerSchool').value.trim();
        
        if (!firstName || !lastName || !gender || !dob || !reportingDate || !parentContact || !parentName || !formerSchool) {
          throw new Error('Please fill all required fields (marked with *).');
        }
        
        // Validate parent contact (Tanzania format)
        const tanzaniaPhoneRegex = /^\+255[6-7]\d{8}$/;
        if (!tanzaniaPhoneRegex.test(parentContact)) {
          throw new Error('Parent Contact must be in Tanzania format (e.g., +255712345678).');
        }
        
        // Handle photo upload
        const photoFile = document.getElementById('photo').files[0];
        let photoUrl = '';
        if (photoFile) {
          if (photoFile.size > 5 * 1024 * 1024) { // 5MB limit
            throw new Error('Photo must be less than 5MB.');
          }
          try {
            photoUrl = await uploadToCloudinary(photoFile, 'preformone/photos');
          } catch (uploadErr) {
            console.warn('Photo upload failed:', uploadErr);
            // Continue without photo—non-blocking
          }
        }
        
        // Generate ADM No and calculate fee
        const admNo = generateAdmNo();
        const totalFee = calculateTotalFee(reportingDate);
        
        // Student object (full details)
        const student = {
          firstName,
          middleName: document.getElementById('middleName').value.trim() || '',
          lastName,
          gender,
          dob: dob, // Stored as YYYY-MM-DD
          reportingDate,
          formerSchool,
          parentContact,
          parentName,
          photoUrl: photoUrl || '', // Empty string if no photo
          totalFee,
          payments: [], // Array for future payments
          attendance: [], // Array for daily attendance
          scores: [], // Array for exam scores
          shifted: false, // Flag for kids who left
          registrationDate: new Date().toISOString().split('T')[0], // Auto-timestamp registration
          school: 'Socrates School Preform One' // Fixed for tracking
        };
        
        // Save to Firebase RTDB (parallel path, no conflict with existing /students)
        await db.ref(`/schools/Socrates School Preform one/${currentYear}/students/${admNo}`).set(student);
        
        // Success: Detailed alert, reset form, refresh search
        Swal.fire({
          title: 'Registration Successful!',
          html: `
            <div class="text-left">
              <p><strong>Student:</strong> ${firstName} ${lastName}</p>
              <p><strong>ADM No:</strong> ${admNo}</p>
              <p><strong>Total Fee:</strong> TSh ${totalFee.toLocaleString()} (pro-rated from ${reportingDate})</p>
              <p><strong>Parent:</strong> ${parentName} (${parentContact})</p>
              <p><strong>Former School:</strong> ${formerSchool}</p>
            </div>
          `,
          icon: 'success',
          confirmButtonText: 'Great!',
          timer: 5000 // Auto-close after 5s
        });
        
        // Reset and hide form
        document.getElementById('admForm').reset();
        document.getElementById('totalFeeDisplay').value = 'TSh 0 (Enter Reporting Date to calculate)';
        document.getElementById('admissionForm').style.display = 'none';
        
        // Auto-refresh search and scroll to results
        searchStudents();
        document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
        
      } catch (err) {
        console.error('Admission error:', err);
        Swal.fire({
          title: 'Registration Failed',
          text: err.message || 'An unexpected error occurred. Please try again or contact admin.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Register Student';
      }
    });
    
    function searchStudents() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const tbody = document.getElementById('resultsBody');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 opacity-75"><i class="fas fa-spinner fa-spin mr-2"></i>Loading students...</td></tr>';
      
      db.ref(`/schools/Socrates School Preform one/${currentYear}/students`).once('value').then((snap) => {
        const studentsObj = snap.val() || {};
        const students = Object.entries(studentsObj);
        
        let filtered = students;
        if (query) {
          filtered = students.filter(([adm, s]) => 
            `${s.firstName} ${s.lastName} ${s.parentName} ${s.parentContact}`.toLowerCase().includes(query) ||
            adm.toLowerCase().includes(query)
          );
        }
        
        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 opacity-75">No students match your search. Try creating a new admission above.</td></tr>';
          return;
        }
        
        tbody.innerHTML = filtered.map(([adm, s]) => {
          const paid = (s.payments || []).reduce((sum, p) => sum + Number(p.amount || 0), 0);
          const balance = Number(s.totalFee || 0) - paid;
          const fullName = `${s.firstName} ${s.lastName}`;
          return `<tr class="hover:bg-white/5">
            <td class="p-3">${fullName}</td>
            <td class="p-3">${adm}</td>
            <td class="p-3">${s.reportingDate ? new Date(s.reportingDate).toLocaleDateString('en-GB') : 'N/A'}</td>
            <td class="p-3">TSh ${Number(s.totalFee || 0).toLocaleString()}</td>
            <td class="p-3 ${balance > 0 ? 'text-red-300' : 'text-green-300'}">TSh ${balance.toLocaleString()}</td>
            <td class="p-3">
              <button class="bg-yellow-500 text-white px-3 py-1 rounded mr-2 text-sm" onclick="editStudent('${adm}')"><i class="fas fa-edit mr-1"></i>Edit</button>
              <button class="bg-red-500 text-white px-3 py-1 rounded text-sm" onclick="deleteStudent('${adm}')"><i class="fas fa-trash mr-1"></i>Delete</button>
            </td>
          </tr>`;
        }).join('');
      }).catch((err) => {
        console.error('Search error:', err);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-300"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading students. Please try again.</td></tr>';
      });
    }
    
    function editStudent(adm) {
      // Basic edit placeholder—expand later
      Swal.fire({
        title: 'Edit Student',
        text: `Edit details for ADM ${adm} (full edit form coming soon). Contact admin for immediate changes.`,
        icon: 'info',
        confirmButtonText: 'OK'
      });
    }
    
    function deleteStudent(adm) {
      Swal.fire({
        title: 'Delete Student?',
        html: `Are you sure? This removes <strong>all data</strong> for ADM <strong>${adm}</strong> permanently (fees, attendance, scores).`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'Yes, Delete'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref(`/schools/Socrates School Preform one/${currentYear}/students/${adm}`).remove().then(() => {
            Swal.fire('Deleted!', 'Student record removed successfully.', 'success');
            searchStudents(); // Refresh list
          }).catch((err) => {
            Swal.fire('Error', 'Delete failed: ' + err.message, 'error');
          });
        }
      });
    }
    
    // Initial load: Search students
    searchStudents();
  </script>
</body>
</html