<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoMAp &mdash; My Child Attendance</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- UI Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Shared helpers -->
  <script src="prefonecommon.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Poppins', 'Inter', 'system-ui', 'sans-serif']
          },
          colors: {
            somap: {
              midnight: '#020617',
              indigo: '#4f46e5',
              cyan: '#06b6d4',
              amber: '#f59e0b'
            }
          }
        }
      }
    };
  </script>

  <style>
    body {
      background: radial-gradient(circle at top, rgba(37, 99, 235, 0.35), rgba(15, 23, 42, 0.95) 60%);
      min-height: 100vh;
      font-family: 'Inter', system-ui, sans-serif;
      color: #e2e8f0;
    }
    .glass-card {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 1.75rem;
      box-shadow: 0 25px 55px -35px rgba(2, 6, 23, 0.9);
      backdrop-filter: blur(16px);
    }
    .stat-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 197, 253, 0.08));
      border-radius: 1.25rem;
      border: 1px solid rgba(59, 130, 246, 0.25);
      transition: transform 160ms ease, border-color 200ms ease;
    }
    .stat-card:hover {
      transform: translateY(-3px);
      border-color: rgba(59, 130, 246, 0.5);
    }
    .timeline {
      border-left: 2px dashed rgba(148, 163, 184, 0.35);
    }
    .timeline-item {
      position: relative;
      margin-left: 1.5rem;
      padding-left: 1.5rem;
      border-radius: 1rem;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.95rem;
      top: 1.25rem;
      width: 0.8rem;
      height: 0.8rem;
      border-radius: 999px;
      background: rgba(96, 165, 250, 0.85);
      border: 2px solid rgba(15, 23, 42, 1);
    }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto px-4 py-10 lg:py-14">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-10">
      <div>
        <p class="uppercase tracking-[0.4em] text-xs text-slate-300">Socrates School &mdash; Preform One</p>
        <h1 class="text-3xl lg:text-4xl font-bold font-display text-white">Attendance Journey</h1>
        <p class="text-sm text-slate-300 mt-2 max-w-xl">Visualise every school day captured by teachers, filter by period, and download official logs for your records.</p>
      </div>
      <div class="flex gap-3">
        <button onclick="window.location.href='prefoneparent.html'" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/15 text-sm text-slate-100 transition">
          <i class="fas fa-home mr-2"></i>Back to Dashboard
        </button>
        <button onclick="logout()" class="px-4 py-2 rounded-xl bg-red-500/80 hover:bg-red-500 text-sm text-white transition">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
    </header>

    <section class="glass-card p-6 lg:p-8 mb-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <div class="flex items-center gap-4">
          <div class="w-24 h-24 rounded-3xl overflow-hidden border-2 border-sky-400/70 shadow-xl bg-slate-900/60">
            <img id="childPhoto" src="" alt="Child passport" class="w-full h-full object-cover hidden">
            <div id="photoPlaceholder" class="w-full h-full flex items-center justify-center text-slate-300 text-2xl bg-slate-800/70">PF1</div>
          </div>
          <div>
            <h2 id="childName" class="text-2xl font-semibold text-white">Loading...</h2>
            <p id="childMeta" class="text-sm text-slate-300 mt-1">ADM - ...</p>
            <p id="reportingInfo" class="text-xs uppercase tracking-[0.4em] text-slate-500 mt-2">Reporting: --</p>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-4">
          <div class="flex items-center gap-2 bg-white/10 border border-white/15 px-3 py-2 rounded-xl">
            <i class="fas fa-calendar text-sky-300"></i>
            <div>
              <p class="text-xs uppercase tracking-widest text-slate-400">Filter range</p>
              <div class="flex items-center gap-2">
                <input type="date" id="startDate" class="bg-transparent border border-white/15 rounded-lg px-3 py-1 text-sm focus:outline-none">
                <span class="text-slate-400 text-sm">to</span>
                <input type="date" id="endDate" class="bg-transparent border border-white/15 rounded-lg px-3 py-1 text-sm focus:outline-none">
              </div>
            </div>
          </div>
          <button onclick="filterAttendance()" class="px-4 py-2 rounded-xl bg-sky-500/80 hover:bg-sky-500 text-white text-sm transition">
            Apply Range
          </button>
          <button onclick="resetFilters()" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/15 text-sm text-slate-100 transition">
            Reset
          </button>
        </div>
      </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-10">
      <article class="stat-card p-5">
        <div class="flex items-center justify-between mb-3">
          <span class="flex items-center gap-2 text-xs uppercase tracking-[0.35em] text-slate-300">
            <i class="fas fa-chart-simple text-sky-300"></i> Overall
          </span>
        </div>
        <p id="overallPercent" class="text-3xl font-semibold text-white">--%</p>
        <p id="overallSummary" class="text-xs text-slate-400 mt-3 uppercase tracking-[0.35em]">Total days marked</p>
      </article>
      <article class="stat-card p-5">
        <div class="flex items-center justify-between mb-3">
          <span class="flex items-center gap-2 text-xs uppercase tracking-[0.35em] text-slate-300">
            <i class="fas fa-calendar-week text-emerald-300"></i> This Month
          </span>
        </div>
        <p id="monthPercent" class="text-3xl font-semibold text-emerald-300">--%</p>
        <p id="monthSummary" class="text-xs text-slate-400 mt-3 uppercase tracking-[0.35em]">Marked days in period</p>
      </article>
      <article class="stat-card p-5">
        <div class="flex items-center justify-between mb-3">
          <span class="flex items-center gap-2 text-xs uppercase tracking-[0.35em] text-slate-300">
            <i class="fas fa-stopwatch text-amber-300"></i> Last Absence
          </span>
        </div>
        <p id="lastAbsent" class="text-3xl font-semibold text-white">--</p>
        <p id="lastAbsentReason" class="text-xs text-slate-400 mt-3 uppercase tracking-[0.35em]">When recorded</p>
      </article>
      <article class="stat-card p-5">
        <div class="flex items-center justify-between mb-3">
          <span class="flex items-center gap-2 text-xs uppercase tracking-[0.35em] text-slate-300">
            <i class="fas fa-medal text-indigo-300"></i> Streak
          </span>
        </div>
        <p id="bestStreak" class="text-3xl font-semibold text-white">-- days</p>
        <p id="streakSummary" class="text-xs text-slate-400 mt-3 uppercase tracking-[0.35em]">Best continuous presence</p>
      </article>
    </section>

    <section class="glass-card p-6 lg:p-8 mb-10">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-xl font-semibold text-white">Trend Insights</h3>
          <p class="text-sm text-slate-300">Monthly presence ratio to help you monitor consistency throughout the program.</p>
        </div>
        <button onclick="downloadChart()" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/15 text-sm text-slate-100 transition">
          <i class="fas fa-download mr-2"></i>Download Chart
        </button>
      </div>
      <canvas id="attendanceChart" height="240"></canvas>
    </section>

    <section class="glass-card p-6 lg:p-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <h3 class="text-xl font-semibold text-white">Daily Attendance Log</h3>
          <p class="text-sm text-slate-300">Tap any date to view teacher notes or export filtered entries.</p>
        </div>
        <div class="flex flex-wrap gap-3">
          <button onclick="exportLog('pdf')" class="px-4 py-2 rounded-xl bg-sky-500/80 hover:bg-sky-500 text-sm text-white transition">
            <i class="fas fa-file-pdf mr-2"></i>Export PDF
          </button>
          <button onclick="exportLog('csv')" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/15 text-sm text-slate-100 transition">
            <i class="fas fa-file-csv mr-2"></i>Export CSV
          </button>
        </div>
      </div>

      <div class="timeline space-y-4" id="attendanceTimeline">
        <p class="text-slate-400 text-sm">Attendance records will appear here once data loads.</p>
      </div>
    </section>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "74814528004",
      appId: "1:74814528004:web:54abda6ae3c75ed5f0677f"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    const childAdm = localStorage.getItem('currentChildAdm');
    const parentContact = localStorage.getItem('prefoneParentContact') || localStorage.getItem('parentContact');

    if (!childAdm || !parentContact) {
      Swal.fire('Login required', 'Please sign in again so we can load your child data.', 'warning')
        .then(() => window.location.href = '../index.html');
    } else {
      loadChildAttendance();
    }

    let rawRecords = [];
    let chartInstance = null;

    async function loadChildAttendance() {
      try {
        const snapshot = await db.ref(`/schools/Socrates School Preform one/${currentYear}/students/${childAdm}`).once('value');
        if (!snapshot.exists()) {
          Swal.fire('Not found', 'We could not locate data for this child. Contact the school office.', 'error');
          return;
        }
        const student = snapshot.val();
        hydrateProfile(student);
        rawRecords = toArray(student.attendance).filter(Boolean);
        renderAttendance(rawRecords);
      } catch (error) {
        console.error('Attendance load error', error);
        Swal.fire('Error', error.message || 'Unable to load attendance at the moment.', 'error');
      }
    }

    function hydrateProfile(student) {
      const name = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.replace(/\s+/g, ' ').trim() || 'Student';
      document.getElementById('childName').textContent = name;
      document.getElementById('childMeta').textContent = `ADM - ${student.adm || childAdm}`;
      document.getElementById('reportingInfo').textContent = `Reporting: ${formatDate(student.reportingDate)}`;

      if (student.photoUrl) {
        const img = document.getElementById('childPhoto');
        img.src = student.photoUrl;
        img.classList.remove('hidden');
        document.getElementById('photoPlaceholder').classList.add('hidden');
      }
    }

    function renderAttendance(records) {
      if (!records.length) {
        document.getElementById('attendanceTimeline').innerHTML = '<p class="text-slate-400 text-sm">No attendance records have been captured yet.</p>';
        setStatText('overallPercent', '--%', 'overallSummary', 'Awaiting first mark');
        setStatText('monthPercent', '--%', 'monthSummary', 'Awaiting first mark');
        setStatText('lastAbsent', '--', 'lastAbsentReason', 'No absence yet');
        setStatText('bestStreak', '-- days', 'streakSummary', 'Consistent records appear here');
        drawChart([]);
        return;
      }

      const sorted = records
        .map(rec => ({ ...rec }))
        .filter(rec => rec.date)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      drawChart(sorted);
      updateStats(sorted);
      renderTimeline(sorted);
    }

    function updateStats(records) {
      const total = records.length;
      const presentCount = records.filter(isPresentRecord).length;
      const overall = total ? Math.round((presentCount / total) * 100) : 0;
      setStatText('overallPercent', `${overall}%`, 'overallSummary', `${presentCount} present of ${total} marked days`);

      const monthKey = new Date().toLocaleString('en-US', { month: 'long', year: 'numeric' });
      const monthRecords = records.filter(rec => {
        const label = new Date(rec.date).toLocaleString('en-US', { month: 'long', year: 'numeric' });
        return label === monthKey;
      });
      const monthPresent = monthRecords.filter(isPresentRecord).length;
      const monthPercent = monthRecords.length ? Math.round((monthPresent / monthRecords.length) * 100) : 0;
      setStatText('monthPercent', `${monthPercent}%`, 'monthSummary', `${monthPresent} / ${monthRecords.length} days this month`);

      const lastAbsence = records.find(rec => !isPresentRecord(rec));
      if (lastAbsence) {
        setStatText('lastAbsent', formatDate(lastAbsence.date), 'lastAbsentReason', (lastAbsence.status || lastAbsence.notes || 'Marked absent'));
      } else {
        setStatText('lastAbsent', 'Never', 'lastAbsentReason', 'No absence recorded');
      }

      const bestStreak = calculateBestStreak(records);
      setStatText('bestStreak', `${bestStreak} days`, 'streakSummary', 'Longest consecutive presence');
    }

    function renderTimeline(records) {
      const container = document.getElementById('attendanceTimeline');
      container.innerHTML = records.map(rec => {
        const present = isPresentRecord(rec);
        const statusLabel = present ? 'Present' : (rec.status || rec.am || rec.pm || 'Absent');
        const badgeColor = present ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-400/40' : 'bg-rose-500/20 text-rose-300 border border-rose-400/40';
        return `
          <article class="timeline-item py-4 px-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div>
                <h4 class="text-lg font-semibold text-white">${formatDate(rec.date)}</h4>
                <p class="text-sm text-slate-300">${rec.notes || 'No additional note from teacher.'}</p>
              </div>
              <span class="px-3 py-1.5 rounded-full text-xs uppercase tracking-[0.3em] ${badgeColor}">
                ${statusLabel}
              </span>
            </div>
            <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-3 text-xs text-slate-400">
              <div><span class="font-semibold text-slate-200">AM:</span> ${formatSlot(rec.am)}</div>
              <div><span class="font-semibold text-slate-200">PM:</span> ${formatSlot(rec.pm)}</div>
              <div><span class="font-semibold text-slate-200">Marked by:</span> ${rec.markedBy || 'Teacher'}</div>
              <div><span class="font-semibold text-slate-200">Reason:</span> ${rec.reason || rec.status || (present ? 'Present' : 'Not provided')}</div>
            </div>
          </article>
        `;
      }).join('');
    }

    function drawChart(records) {
      const grouped = {};
      records.forEach(rec => {
        const date = new Date(rec.date);
        if (Number.isNaN(date.getTime())) return;
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (!grouped[key]) grouped[key] = { present: 0, total: 0, label: date.toLocaleString('en-US', { month: 'short', year: 'numeric' }) };
        grouped[key].total += 1;
        if (isPresentRecord(rec)) grouped[key].present += 1;
      });

      const keys = Object.keys(grouped).sort();
      const labels = keys.map(key => grouped[key].label);
      const values = keys.map(key => grouped[key].total ? Math.round((grouped[key].present / grouped[key].total) * 100) : 0);

      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(document.getElementById('attendanceChart').getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Attendance %',
            data: values,
            borderColor: 'rgba(14, 165, 233, 0.9)',
            backgroundColor: 'rgba(14, 165, 233, 0.25)',
            fill: true,
            tension: 0.35,
            pointBackgroundColor: '#38bdf8',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { color: '#cbd5f5', callback: value => `${value}%` }
            },
            x: { ticks: { color: '#cbd5f5' } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: context => ` ${context.parsed.y}% present`
              }
            }
          }
        }
      });
    }

    function filterAttendance() {
      if (!rawRecords.length) return;
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      if (!start && !end) {
        renderAttendance(rawRecords);
        return;
      }
      const startTime = start ? new Date(start).getTime() : -Infinity;
      const endTime = end ? new Date(end).getTime() : Infinity;
      const filtered = rawRecords.filter(rec => {
        const time = rec.date ? new Date(rec.date).getTime() : NaN;
        return !Number.isNaN(time) && time >= startTime && time <= endTime;
      });
      renderAttendance(filtered);
    }

    function resetFilters() {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      renderAttendance(rawRecords);
    }

    function exportLog(format) {
      if (!rawRecords.length) {
        Swal.fire('Nothing to export', 'No attendance records available yet.', 'info');
        return;
      }
      const data = rawRecords.map(rec => ({
        Date: formatDate(rec.date),
        AM: formatSlot(rec.am),
        PM: formatSlot(rec.pm),
        Present: isPresentRecord(rec) ? 'Yes' : 'No',
        Status: rec.status || rec.reason || '',
        Notes: rec.notes || ''
      }));

      if (format === 'csv') {
        const csv = Papa.unparse(data);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${childAdm}_attendance.csv`;
        link.click();
        URL.revokeObjectURL(url);
      } else {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text('Attendance Log', 14, 18);
        const headers = [['Date', 'AM', 'PM', 'Present', 'Status', 'Notes']];
        const body = data.map(row => [row.Date, row.AM, row.PM, row.Present, row.Status, row.Notes]);
        doc.autoTable({
          startY: 26,
          head: headers,
          body,
          styles: { fontSize: 10, cellWidth: 'wrap' },
          columnStyles: { 5: { cellWidth: 70 } }
        });
        doc.save(`${childAdm}_attendance.pdf`);
      }
    }

    function downloadChart() {
      if (!chartInstance) return;
      const link = document.createElement('a');
      link.href = chartInstance.toBase64Image();
      link.download = `${childAdm}_attendance_trend.png`;
      link.click();
    }

    function calculateBestStreak(records) {
      let best = 0;
      let current = 0;
      const sortedAsc = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
      sortedAsc.forEach(rec => {
        if (isPresentRecord(rec)) {
          current += 1;
          best = Math.max(best, current);
        } else {
          current = 0;
        }
      });
      return best;
    }

    function setStatText(valueId, valueText, noteId, noteText) {
      document.getElementById(valueId).textContent = valueText;
      document.getElementById(noteId).textContent = noteText;
    }

    function formatSlot(slot) {
      if (!slot) return '-';
      const normalized = String(slot).trim().toUpperCase();
      if (normalized === 'P') return 'Present';
      if (normalized === 'A') return 'Absent';
      return normalized;
    }

    function isPresentRecord(record) {
      if (record.present === true) return true;
      const am = String(record.am || '').toUpperCase();
      const pm = String(record.pm || '').toUpperCase();
      return am === 'P' && pm === 'P';
    }

  function logout() {
    localStorage.removeItem('prefoneParent');
    localStorage.removeItem('prefoneParentContact');
    localStorage.removeItem('prefoneParentName');
    localStorage.removeItem('prefoneParentIcon');
    localStorage.removeItem('prefoneCurrentChildName');
    localStorage.removeItem('currentChildAdm');
    window.location.href = '../index.html';
  }
  </script>
</body>
</html>
