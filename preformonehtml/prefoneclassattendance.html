<!DOCTYPE html>
<html lang="en">
<head>
  <title>SoMAp â€” Preform One Class Attendance Marking</title>
  <!-- Same scripts as dashboard -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="prefonecommon.js"></script>
  <style>
    body { background: linear-gradient(to right, #667eea, #764ba2); }
    .table th, .table td { padding: 1rem; }
    .status-select { background: white; color: black; border-radius: 0.25rem; padding: 0.25rem; }
    .mark-all-btn { transition: background 0.3s; }
    .mark-all-btn:hover { background: #16a34a; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-400 to-purple-600 text-white p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6"><i class="fas fa-users"></i> Preform One Class Attendance Marking</h1>
    <a href="prefoneattendance.html" class="bg-gray-500 p-2 rounded mb-4 inline-block"><i class="fas fa-arrow-left"></i> Back to Attendance Dashboard</a>
    
    <!-- Date Select -->
    <input type="date" id="attDate" class="p-2 rounded bg-white/20 text-white mb-4" onchange="loadClassAtt()">
    
    <table class="w-full bg-white/10 rounded table">
      <thead class="bg-white/20">
        <tr>
          <th>#</th>
          <th>ADM</th>
          <th>Name</th>
          <th>Fee Bal</th>
          <th>AM Status</th>
          <th>PM Status</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="classAttBody"></tbody>
    </table>
    
    <div class="flex gap-4 mt-4">
      <button onclick="markAllPresent()" class="bg-green-500 p-2 rounded mark-all-btn">Mark All Present</button>
      <button onclick="saveClassAtt()" class="bg-blue-500 p-2 rounded">Save Changes</button>
      <button onclick="exportClassPDF()" class="bg-purple-500 p-2 rounded">Export PDF</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };

    // Initialize Firebase (compat)
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    let classData = [];

    // Ensure currentYear is available (from prefonecommon.js)
    if (typeof currentYear === 'undefined') {
      currentYear = new Date().getFullYear(); // Fallback to current year
    }

    // Set default date to today
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('attDate').value = new Date().toISOString().split('T')[0];
      loadClassAtt();
    });

    function loadClassAtt() {
      const date = document.getElementById('attDate').value;
      if (!date) return;
      db.ref(`/schools/Socrates School Preform one/${currentYear}/students`).once('value').then(snap => {
        const studentsObj = snap.val() || {};
        const students = Object.entries(studentsObj);
        classData = students.map(([adm, s], idx) => {
          const attRecords = Object.values(s.attendance || {});
          const att = attRecords.find(a => a.date === date) || { am: 'P', pm: 'P', notes: '', present: true };
          const paymentsArray = Object.values(s.payments || {});
          const bal = Number(s.totalFee || 0) - paymentsArray.reduce((sum, p) => sum + Number(p.amount || 0), 0);
          return { idx: idx + 1, adm, name: `${s.firstName || ''} ${s.lastName || ''}`.trim(), bal, ...att };
        });
        renderClassTable();
      }).catch(err => {
        console.error('Load error:', err);
        Swal.fire('Error', 'Failed to load students: ' + err.message, 'error');
      });
    }

    function renderClassTable() {
      const tbody = document.getElementById('classAttBody');
      if (classData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 opacity-75">No students found. Register some in Admissions first.</td></tr>';
        return;
      }
      tbody.innerHTML = classData.map(row => `
        <tr>
          <td>${row.idx}</td>
          <td>${row.adm}</td>
          <td>${row.name}</td>
          <td ${row.bal > 0 ? 'class="text-yellow-300"' : ''}>TSh ${row.bal.toLocaleString()}</td>
          <td>
            <select class="status-select" onchange="updateStatus('${row.adm}', 'am', this.value)">
              <option ${row.am === 'P' ? 'selected' : ''}>P (Present)</option>
              <option ${row.am === 'A' ? 'selected' : ''}>A (Absent)</option>
              <option ${row.am === 'S' ? 'selected' : ''}>S (Sick)</option>
              <option ${row.am === 'L' ? 'selected' : ''}>L (Late)</option>
              <option ${row.am === 'E' ? 'selected' : ''}>E (Excused)</option>
              <option ${row.am === 'M' ? 'selected' : ''}>M (Medical)</option>
              <option ${row.am === 'T' ? 'selected' : ''}>T (Travel)</option>
              <option ${row.am === 'G' ? 'selected' : ''}>G (Guardian)</option>
            </select>
          </td>
          <td>
            <select class="status-select" onchange="updateStatus('${row.adm}', 'pm', this.value)">
              <option ${row.pm === 'P' ? 'selected' : ''}>P (Present)</option>
              <option ${row.pm === 'A' ? 'selected' : ''}>A (Absent)</option>
              <option ${row.pm === 'S' ? 'selected' : ''}>S (Sick)</option>
              <option ${row.pm === 'L' ? 'selected' : ''}>L (Late)</option>
              <option ${row.pm === 'E' ? 'selected' : ''}>E (Excused)</option>
              <option ${row.pm === 'M' ? 'selected' : ''}>M (Medical)</option>
              <option ${row.pm === 'T' ? 'selected' : ''}>T (Travel)</option>
              <option ${row.pm === 'G' ? 'selected' : ''}>G (Guardian)</option>
            </select>
          </td>
          <td><input type="text" class="p-1 rounded bg-white text-black" value="${row.notes || ''}" onchange="updateNotes('${row.adm}', this.value)"></td>
          <td><button class="bg-red-500 p-1 rounded text-xs text-white" onclick="clearAtt('${row.adm}')"><i class="fas fa-trash"></i></button></td>
        </tr>
      `).join('');
    }

    function updateStatus(adm, period, value) {
      const row = classData.find(r => r.adm === adm);
      if (row) {
        row[period] = value;
        row.present = (row.am === 'P' && row.pm === 'P');
        // Optionally check for shifted status
      }
    }

    function updateNotes(adm, notes) {
      const row = classData.find(r => r.adm === adm);
      if (row) row.notes = notes;
    }

    function markAllPresent() {
      classData.forEach(row => {
        row.am = 'P';
        row.pm = 'P';
        row.present = true;
      });
      renderClassTable();
      Swal.fire('Marked!', 'All students marked present.', 'success');
    }

    function saveClassAtt() {
      const date = document.getElementById('attDate').value;
      if (!date) return Swal.fire('Error', 'Select a date first.', 'error');
      
      let savedCount = 0;
      const total = classData.length;
      classData.forEach(row => {
        const attPath = `/schools/Socrates School Preform one/${currentYear}/students/${row.adm}/attendance`;
        // Remove existing for date
        db.ref(attPath).orderByChild('date').equalTo(date).once('value').then(snap => {
          snap.forEach(child => child.ref.remove());
        }).then(() => {
          // Push new
          db.ref(attPath).push({ date, am: row.am, pm: row.pm, present: row.present, notes: row.notes || '' }).then(() => {
            savedCount++;
            if (savedCount === total) {
              Swal.fire('Saved!', 'All attendance updated. Refresh the dashboard to see changes.', 'success');
            }
          });
        }).catch(err => {
          console.error('Save error for ' + row.adm + ':', err);
        });
      });
    }

    function clearAtt(adm) {
      const date = document.getElementById('attDate').value;
      if (!date) return;
      db.ref(`/schools/Socrates School Preform one/${currentYear}/students/${adm}/attendance`).orderByChild('date').equalTo(date).once('value', snap => {
        snap.forEach(child => child.ref.remove());
      }).then(() => {
        loadClassAtt();
        Swal.fire('Cleared!', 'Attendance for this student on selected date cleared.', 'success');
      }).catch(err => {
        console.error('Clear error:', err);
        Swal.fire('Error', 'Failed to clear attendance.', 'error');
      });
    }

    function exportClassPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');
      doc.autoTable({
        head: [['#', 'ADM', 'Name', 'Fee Bal', 'AM', 'PM', 'Notes']],
        body: classData.map(row => [row.idx, row.adm, row.name, `TSh ${row.bal.toLocaleString()}`, row.am, row.pm, row.notes || ''])
      });
      doc.save(`class_attendance_${document.getElementById('attDate').value}.pdf`);
    }

    // Initial load
    loadClassAtt();
  </script>
</body>
</html>