<!DOCTYPE html>
<html lang="en">
<head>
  <title>SoMAp â€” Preform One Class Journal</title>
  <!-- Same -->
  <script src="prefonecommon.js"></script>
  <style> body { background: linear-gradient(to right, #667eea, #764ba2); } table { border-collapse: collapse; } th, td { border: 1px solid white; padding: 4px; } </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-400 to-purple-600 text-white p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6"><i class="fas fa-journal-whills"></i> Preform One Class Journal</h1>
    <a href="prefonedashboard.html" class="bg-gray-500 p-2 rounded mb-4 inline-block">< Back</a>
    
    <div class="mb-4">Date: <input type="date" id="journalDate" onchange="loadJournal()"> Registered: <span id="regNum">0</span> Present: <span id="presNum">0</span></div>
    
    <table id="journalTable">
      <thead><tr><th>Sn</th><th>Trs. Name</th><th>Subject</th><th>Time In</th><th>Time Out</th><th>Topic</th><th>Sub Topic</th><th>Trs Comment</th><th>Signature</th><th>Kids Comment (Taught/Not)</th></tr></thead>
      <tbody id="journalBody"></tbody>
    </table>
    
    <button onclick="addJournalRow()" class="bg-blue-500 p-2 rounded mt-4">Add Row</button>
    <button onclick="saveJournal()" class="bg-green-500 p-2 rounded mt-4">Save</button>
    <button onclick="downloadJournal()" class="bg-purple-500 p-2 rounded mt-4">Download PDF (Day)</button>
  </div>

  <script>
    let journalRows = [];
    function loadJournal() {
      const date = document.getElementById('journalDate').value || new Date().toISOString().split('T')[0];
      db.ref(`/schools/Socrates School Preform one/${currentYear}/classjournals/${date}`).once('value', snap => {
        journalRows = snap.val()?.rows || [];
        db.ref(`/schools/Socrates School Preform one/${currentYear}/students`).once('value', sSnap => {
          document.getElementById('regNum').textContent = Object.keys(sSnap.val() || {}).length;
          // Pres from att
          let pres = 0;
          Object.values(sSnap.val()).forEach(st => {
            const att = st.attendance?.find(a => a.date === date);
            if (att?.present) pres++;
          });
          document.getElementById('presNum').textContent = pres;
        });
        
        const tbody = document.getElementById('journalBody');
        tbody.innerHTML = journalRows.map((row, idx) => `
          <tr>
            <td>${idx+1}</td><td><input value="${row.trsName || ''}" onchange="updateRow(${idx}, 'trsName', this.value)"></td>
            <td><select onchange="updateRow(${idx}, 'subject', this.value)"><option>${row.subject || ''}</option>${subjects.map(sub => `<option>${sub}</option>`).join('')}</select></td>
            <td><input type="time" value="${row.timeIn || ''}" onchange="updateRow(${idx}, 'timeIn', this.value)"></td>
            <td><input type="time" value="${row.timeOut || ''}" onchange="updateRow(${idx}, 'timeOut', this.value)"></td>
            <td><input value="${row.topic || ''}" onchange="updateRow(${idx}, 'topic', this.value)"></td>
            <td><input value="${row.subTopic || ''}" onchange="updateRow(${idx}, 'subTopic', this.value)"></td>
            <td><input value="${row.trsComment || ''}" onchange="updateRow(${idx}, 'trsComment', this.value)"></td>
            <td><input value="${row.signature || ''}" onchange="updateRow(${idx}, 'signature', this.value)"></td>
            <td><select onchange="updateRow(${idx}, 'kidsComment', this.value)"><option>${row.kidsComment || 'Taught'}</option><option>Taught</option><option>Not Taught</option></select></td>
          </tr>
        `).join('');
      });
    }
    
    function updateRow(idx, field, value) {
      journalRows[idx][field] = value;
    }
    
    function addJournalRow() {
      journalRows.push({ sn: journalRows.length + 1, trsName: '', subject: '', timeIn: '', timeOut: '', topic: '', subTopic: '', trsComment: '', signature: '', kidsComment: 'Taught' });
      loadJournal(); // Reload to show
    }
    
    function saveJournal() {
      const date = document.getElementById('journalDate').value;
      db.ref(`/schools/Socrates School Preform one/${currentYear}/classjournals/${date}`).set({ rows: journalRows }).then(() => {
        Swal.fire('Saved!', 'Journal updated.', 'success');
      });
    }
    
    function downloadJournal() {
      const date = document.getElementById('journalDate').value;
      const content = `Class Journal ${date}\nRegistered: ${document.getElementById('regNum').textContent} Present: ${document.getElementById('presNum').textContent}\n` + 
        journalRows.map(r => `Sn ${r.sn}: ${r.trsName} - ${r.subject} (${r.timeIn}-${r.timeOut}) - ${r.topic}/${r.subTopic} - Kids: ${r.kidsComment}`).join('\n');
      generatePDF(content, `journal_${date}.pdf`);
    }
    
    loadJournal();
  </script>
</body>
</html>