<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoMAp &mdash; Preform One Dashboard</title>

  <!-- Firebase Compat SDKs (aligned with rest of suite) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- UI Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Shared helpers -->
  <script src="prefonecommon.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Poppins', 'Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            somap: {
              midnight: '#020617',
              indigo: '#4338ca',
              teal: '#14b8a6',
              rose: '#fb7185'
            }
          }
        }
      }
    };
  </script>

  <style>
    body {
      background: #020617;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .glass-card {
      background: rgba(15, 23, 42, 0.82);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 35px 65px -30px rgba(2, 6, 23, 0.85);
      backdrop-filter: blur(18px);
      border-radius: 1.75rem;
    }
    .stat-card {
      background: rgba(148, 163, 184, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 1.25rem;
      padding: 1.2rem;
      transition: transform 160ms ease, border-color 200ms ease;
    }
    .stat-card:hover {
      transform: translateY(-4px);
      border-color: rgba(96, 165, 250, 0.45);
    }
    .stat-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      width: 2.5rem;
      height: 2.5rem;
      background: rgba(14, 165, 233, 0.18);
      color: #22d3ee;
    }
    .list-card {
      background: rgba(2, 6, 23, 0.72);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 1.25rem;
    }
    .list-title {
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.75rem;
      color: rgba(226, 232, 240, 0.7);
      font-weight: 600;
    }
    .list-empty {
      color: rgba(226, 232, 240, 0.6);
      font-style: italic;
    }
    .progress-track {
      height: 0.6rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.22);
      overflow: hidden;
    }
    .progress-value {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22d3ee 0%, #6366f1 48%, #a855f7 100%);
      transition: width 240ms ease-in-out;
    }
    .quick-link {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      border-radius: 1rem;
      padding: 1rem;
      background: rgba(148, 163, 184, 0.08);
      border: 1px solid transparent;
      transition: transform 160ms ease, border-color 200ms ease, box-shadow 200ms ease;
    }
    .quick-link:hover {
      transform: translateY(-4px);
      border-color: rgba(148, 163, 184, 0.45);
      box-shadow: 0 20px 35px -30px rgba(15, 23, 42, 0.9);
    }
    .badge-soft {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 0.15rem 0.5rem;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: rgba(148, 163, 184, 0.2);
      color: rgba(226, 232, 240, 0.85);
    }
    .loading-spinner {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 999px;
      border: 3px solid rgba(99, 102, 241, 0.2);
      border-top-color: #6366f1;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .gradient-blob {
      position: absolute;
      filter: blur(120px);
      opacity: 0.4;
      pointer-events: none;
    }
  </style>
</head>

<body class="min-h-screen text-slate-100 antialiased">
  <div class="gradient-blob -top-16 left-[-10%] h-72 w-72 rounded-full bg-sky-500/40"></div>
  <div class="gradient-blob top-1/3 right-[-12%] h-80 w-80 rounded-full bg-indigo-600/50"></div>

  <main class="relative z-10 mx-auto flex max-w-7xl flex-col gap-8 px-4 py-8 lg:px-6 lg:py-10">
    <section class="glass-card p-6 md:p-8">
      <div class="flex flex-col gap-6 md:flex-row md:justify-between md:gap-10">
        <div class="space-y-4">
          <span class="badge-soft">Socrates School</span>
          <div>
            <h1 class="font-display text-3xl font-semibold text-white md:text-4xl">
              Preform One Command Center
            </h1>
            <p class="mt-2 text-sm text-slate-300 md:text-base">
              Monitor admissions, finance, and classroom signals for Preform One in real time. Every card updates directly from Firebase.
            </p>
          </div>
          <div class="flex flex-wrap items-center gap-3 text-xs font-semibold uppercase tracking-widest text-slate-400">
            <span class="flex items-center gap-2">
              <i class="fa-solid fa-calendar-days text-slate-300"></i>
              <span id="dashboardYearLabel">2025</span>
            </span>
            <span class="flex items-center gap-2">
              <i class="fa-solid fa-clock text-rose-300"></i>
              <span id="lastUpdated">Loading&hellip;</span>
            </span>
          </div>
        </div>
        <div class="flex flex-col gap-3 rounded-2xl bg-slate-900/70 p-4 shadow-inner">
          <label for="yearSelect" class="text-xs font-semibold uppercase tracking-wider text-slate-400">
            Working Academic Year
          </label>
          <div class="flex flex-wrap items-center gap-3">
            <select id="yearSelect" class="rounded-xl border border-slate-600/60 bg-slate-900/80 px-3 py-2 text-sm text-slate-100 shadow-sm focus:border-sky-400 focus:outline-none">
            </select>
            <button id="refreshButton" class="inline-flex items-center gap-2 rounded-xl bg-sky-500/90 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-400/90">
              <i class="fa-solid fa-rotate-right"></i>
              Refresh
            </button>
          </div>
          <p id="statusMessage" class="text-sm text-slate-400">
            Fetching latest school insights&hellip;
          </p>
        </div>
      </div>
    </section>

    <section class="space-y-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-white">Today's Pulse</h2>
          <p class="text-sm text-slate-400">Attendance and enrollment story for the selected year.</p>
        </div>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3">
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Total Learners</span>
            <div class="stat-icon"><i class="fa-solid fa-children"></i></div>
          </div>
          <p id="metricTotalStudents" class="mt-3 text-2xl font-semibold text-white">0</p>
          <p class="text-sm text-slate-400">Registered for <span id="metricYearInline">2025</span></p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Present Today</span>
            <div class="stat-icon bg-emerald-500/20 text-emerald-300"><i class="fa-solid fa-user-check"></i></div>
          </div>
          <p id="metricPresentToday" class="mt-3 text-2xl font-semibold text-white">0</p>
          <p class="text-sm text-slate-400">Marked present in today's roll</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Not Present / Pending</span>
            <div class="stat-icon bg-rose-500/20 text-rose-300"><i class="fa-solid fa-user-xmark"></i></div>
          </div>
          <p id="metricAbsentToday" class="mt-3 text-2xl font-semibold text-white">0</p>
          <p class="text-sm text-slate-400">Absent or not yet marked</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Attendance Rate</span>
            <div class="stat-icon bg-indigo-500/20 text-indigo-300"><i class="fa-solid fa-chart-line"></i></div>
          </div>
          <p id="metricAttendanceRate" class="mt-3 text-2xl font-semibold text-white">0%</p>
          <p class="text-sm text-slate-400">Across recorded sessions</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Shifted Learners</span>
            <div class="stat-icon bg-amber-500/20 text-amber-300"><i class="fa-solid fa-exchange-alt"></i></div>
          </div>
          <p id="metricShifted" class="mt-3 text-2xl font-semibold text-white">0</p>
          <p class="text-sm text-slate-400">Moved to another class / school</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Gender Balance</span>
            <div class="stat-icon bg-purple-500/20 text-purple-300"><i class="fa-solid fa-venus-mars"></i></div>
          </div>
          <p id="metricGenderSplit" class="mt-3 text-2xl font-semibold text-white">0 &middot; 0</p>
          <p class="text-sm text-slate-400">Girls vs Boys</p>
        </div>
      </div>
    </section>

    <section class="space-y-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-white">Finance Overview</h2>
          <p class="text-sm text-slate-400">Collections, expectations, and running balance (TSh).</p>
        </div>
        <span class="badge-soft" id="collectionsProgressLabel">0% of yearly goal collected</span>
      </div>
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Expected Full Year</span>
            <div class="stat-icon bg-cyan-500/20 text-cyan-300"><i class="fa-solid fa-coins"></i></div>
          </div>
          <p id="metricExpectedFull" class="mt-3 text-2xl font-semibold text-white">TSh 0</p>
          <p class="text-sm text-slate-400">Projected from admissions</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Expected Till Today</span>
            <div class="stat-icon bg-teal-500/20 text-teal-300"><i class="fa-solid fa-calendar-check"></i></div>
          </div>
          <p id="metricExpectedNow" class="mt-3 text-2xl font-semibold text-white">TSh 0</p>
          <p class="text-sm text-slate-400">Based on reporting dates</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Collected To Date</span>
            <div class="stat-icon bg-emerald-500/20 text-emerald-300"><i class="fa-solid fa-vault"></i></div>
          </div>
          <p id="metricCollected" class="mt-3 text-2xl font-semibold text-white">TSh 0</p>
          <p class="text-sm text-slate-400">All payments posted</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Outstanding (Full)</span>
            <div class="stat-icon bg-rose-500/20 text-rose-300"><i class="fa-solid fa-triangle-exclamation"></i></div>
          </div>
          <p id="metricOutstandingFull" class="mt-3 text-2xl font-semibold text-white">TSh 0</p>
          <p class="text-sm text-slate-400">Compared to full year target</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Outstanding (To Date)</span>
            <div class="stat-icon bg-amber-500/20 text-amber-300"><i class="fa-solid fa-hourglass-half"></i></div>
          </div>
          <p id="metricOutstandingToday" class="mt-3 text-2xl font-semibold text-white">TSh 0</p>
          <p class="text-sm text-slate-400">Expected till today minus paid</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Expenses Logged</span>
            <div class="stat-icon bg-orange-500/20 text-orange-300"><i class="fa-solid fa-file-invoice-dollar"></i></div>
          </div>
          <p id="metricExpenses" class="mt-3 text-2xl font-semibold text-white">TSh 0</p>
          <p class="text-sm text-slate-400">Total from expense book</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Net Position</span>
            <div class="stat-icon bg-indigo-500/20 text-indigo-300"><i class="fa-solid fa-scale-balanced"></i></div>
          </div>
          <p id="metricNet" class="mt-3 text-2xl font-semibold text-white">TSh 0</p>
          <p class="text-sm text-slate-400">Collected minus expenses</p>
        </div>
        <div class="stat-card">
          <div class="flex items-center justify-between">
            <span class="text-xs uppercase tracking-wider text-slate-400">Collected Today</span>
            <div class="stat-icon bg-lime-500/20 text-lime-300"><i class="fa-solid fa-bolt"></i></div>
          </div>
          <p id="metricCollectedToday" class="mt-3 text-2xl font-semibold text-white">TSh 0</p>
          <p class="text-sm text-slate-400">Payments stamped with today</p>
        </div>
      </div>
      <div class="space-y-3 rounded-2xl bg-slate-900/70 p-5">
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold uppercase tracking-wider text-slate-400">Collections Progress</span>
          <span id="collectionsHeadline" class="text-sm text-slate-300">0 of 0 TSh</span>
        </div>
        <div class="progress-track">
          <div id="collectionsProgress" class="progress-value w-0"></div>
        </div>
      </div>
    </section>
    <section class="grid grid-cols-1 gap-5 lg:grid-cols-2">
      <div class="list-card p-5">
        <div class="flex items-center justify-between">
          <div>
            <span class="list-title">Outstanding accounts</span>
            <h3 class="text-lg font-semibold text-white">Top balances</h3>
          </div>
          <i class="fa-solid fa-arrow-trend-up text-slate-400"></i>
        </div>
        <div id="topOutstandingList" class="mt-4 space-y-3 text-sm"></div>
      </div>
      <div class="list-card p-5">
        <div class="flex items-center justify-between">
          <div>
            <span class="list-title">Attendance attention</span>
            <h3 class="text-lg font-semibold text-white">Today&rsquo;s alerts</h3>
          </div>
          <i class="fa-solid fa-bell text-slate-400"></i>
        </div>
        <div id="attendanceAlertsList" class="mt-4 space-y-3 text-sm"></div>
      </div>
    </section>

    <section class="grid grid-cols-1 gap-5 lg:grid-cols-2">
      <div class="list-card p-5">
        <div class="flex items-center justify-between">
          <div>
            <span class="list-title">Collections stream</span>
            <h3 class="text-lg font-semibold text-white">Latest payments</h3>
          </div>
          <i class="fa-solid fa-receipt text-slate-400"></i>
        </div>
        <div id="recentPaymentsList" class="mt-4 space-y-3 text-sm"></div>
      </div>
      <div class="list-card p-5">
        <div class="flex items-center justify-between">
          <div>
            <span class="list-title">Attendance trend</span>
            <h3 class="text-lg font-semibold text-white">Recent coverage</h3>
          </div>
          <i class="fa-solid fa-chart-area text-slate-400"></i>
        </div>
        <div id="attendanceTrend" class="mt-4 flex flex-wrap gap-3 text-sm"></div>
        <div class="mt-5">
          <span class="list-title">Absence reasons mix</span>
          <div id="absenceReasonsList" class="mt-3 flex flex-wrap gap-2 text-xs font-semibold"></div>
        </div>
      </div>
    </section>

    <section class="space-y-4 pb-10">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-white">Navigate Preform One</h2>
          <p class="text-sm text-slate-400">Jump into admissions, finance, reports, and more.</p>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5">
        <a href="prefoneadmission.html" class="quick-link">
          <i class="fa-solid fa-user-plus text-sky-300"></i>
          <span class="text-sm font-semibold text-white">Admissions</span>
          <span class="text-xs text-slate-400">Enroll new learners</span>
        </a>
        <a href="prefoneacademic.html" class="quick-link">
          <i class="fa-solid fa-book text-emerald-300"></i>
          <span class="text-sm font-semibold text-white">Academic</span>
          <span class="text-xs text-slate-400">Schemes &amp; grading</span>
        </a>
        <a href="prefonescoresheet.html" class="quick-link">
          <i class="fa-solid fa-chart-line text-yellow-300"></i>
          <span class="text-sm font-semibold text-white">Scoresheet</span>
          <span class="text-xs text-slate-400">Continuous assessment</span>
        </a>
        <a href="prefoneattendance.html" class="quick-link">
          <i class="fa-solid fa-calendar-check text-rose-300"></i>
          <span class="text-sm font-semibold text-white">Attendance</span>
          <span class="text-xs text-slate-400">Insights &amp; exports</span>
        </a>
        <a href="prefonefinance.html" class="quick-link">
          <i class="fa-solid fa-sack-dollar text-lime-300"></i>
          <span class="text-sm font-semibold text-white">Finance Hub</span>
          <span class="text-xs text-slate-400">Debtors &amp; receipts</span>
        </a>
        <a href="preoneexpenses.html" class="quick-link">
          <i class="fa-solid fa-file-invoice text-orange-300"></i>
          <span class="text-sm font-semibold text-white">Expenses</span>
          <span class="text-xs text-slate-400">Operations ledger</span>
        </a>
        <a href="prefonelessonplan.html" class="quick-link">
          <i class="fa-solid fa-clipboard-list text-indigo-300"></i>
          <span class="text-sm font-semibold text-white">Lesson Plans</span>
          <span class="text-xs text-slate-400">Weekly coverage</span>
        </a>
        <a href="prefoneteachersnames.html" class="quick-link">
          <i class="fa-solid fa-users-gear text-fuchsia-300"></i>
          <span class="text-sm font-semibold text-white">Teachers</span>
          <span class="text-xs text-slate-400">Staff directory</span>
        </a>
        <a href="prefoneclassjournal.html" class="quick-link">
          <i class="fa-solid fa-journal-whills text-cyan-300"></i>
          <span class="text-sm font-semibold text-white">Class Journal</span>
          <span class="text-xs text-slate-400">Daily narratives</span>
        </a>
        <a href="prefonebooks.html" class="quick-link">
          <i class="fa-solid fa-book-open text-amber-300"></i>
          <span class="text-sm font-semibold text-white">Bookshelf</span>
          <span class="text-xs text-slate-400">Digital books</span>
        </a>
        <a href="prefonereportform.html" class="quick-link">
          <i class="fa-solid fa-file-signature text-emerald-300"></i>
          <span class="text-sm font-semibold text-white">Report Forms</span>
          <span class="text-xs text-slate-400">Term performance</span>
        </a>
        <a href="prefoneshiftedkid.html" class="quick-link">
          <i class="fa-solid fa-people-arrows text-slate-300"></i>
          <span class="text-sm font-semibold text-white">Shifted Learners</span>
          <span class="text-xs text-slate-400">Transfers &amp; exits</span>
        </a>
        <a href="prefonegenerateid.html" class="quick-link">
          <i class="fa-solid fa-id-card-clip text-lime-300"></i>
          <span class="text-sm font-semibold text-white">Generate IDs</span>
          <span class="text-xs text-slate-400">Printable cards</span>
        </a>
      </div>
    </section>
  </main>

  <div id="loadingOverlay" class="pointer-events-none fixed inset-0 z-20 hidden items-center justify-center bg-slate-950/70 backdrop-blur">
    <div class="flex flex-col items-center gap-3 text-slate-200">
      <div class="loading-spinner"></div>
      <p class="text-sm font-semibold uppercase tracking-wider">Syncing with Firebase&hellip;</p>
    </div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    const YEAR_START = 2024;
    const YEAR_END = 2035;
    const FEE_PER_MONTH = 15000;
    const REASONS_MAP = {
      A: 'Absent',
      S: 'Sick',
      L: 'Late',
      E: 'Excused',
      M: 'Medical',
      T: 'Travel',
      G: 'Guardian',
      P: 'Present'
    };

    const dom = {
      yearSelect: document.getElementById('yearSelect'),
      refreshButton: document.getElementById('refreshButton'),
      statusMessage: document.getElementById('statusMessage'),
      lastUpdated: document.getElementById('lastUpdated'),
      dashboardYearLabel: document.getElementById('dashboardYearLabel'),
      metricYearInline: document.getElementById('metricYearInline'),
      totalStudents: document.getElementById('metricTotalStudents'),
      presentToday: document.getElementById('metricPresentToday'),
      absentToday: document.getElementById('metricAbsentToday'),
      attendanceRate: document.getElementById('metricAttendanceRate'),
      shifted: document.getElementById('metricShifted'),
      genderSplit: document.getElementById('metricGenderSplit'),
      expectedFull: document.getElementById('metricExpectedFull'),
      expectedNow: document.getElementById('metricExpectedNow'),
      collected: document.getElementById('metricCollected'),
      outstandingFull: document.getElementById('metricOutstandingFull'),
      outstandingToday: document.getElementById('metricOutstandingToday'),
      expenses: document.getElementById('metricExpenses'),
      net: document.getElementById('metricNet'),
      collectedToday: document.getElementById('metricCollectedToday'),
      collectionsProgress: document.getElementById('collectionsProgress'),
      collectionsLabel: document.getElementById('collectionsProgressLabel'),
      collectionsHeadline: document.getElementById('collectionsHeadline'),
      topOutstandingList: document.getElementById('topOutstandingList'),
      attendanceAlertsList: document.getElementById('attendanceAlertsList'),
      recentPaymentsList: document.getElementById('recentPaymentsList'),
      attendanceTrend: document.getElementById('attendanceTrend'),
      absenceReasonsList: document.getElementById('absenceReasonsList'),
      overlay: document.getElementById('loadingOverlay')
    };

    const state = {
      year: (typeof currentYear !== 'undefined' ? String(currentYear) : String(new Date().getFullYear())),
      loading: false
    };

    document.addEventListener('DOMContentLoaded', () => {
      initializeYearOptions();
      bindEvents();
      renderYearLabels();
      loadDashboard(state.year);
    });

    function initializeYearOptions() {
      dom.yearSelect.innerHTML = '';
      for (let year = YEAR_START; year <= YEAR_END; year++) {
        const option = document.createElement('option');
        option.value = String(year);
        option.textContent = year;
        if (String(year) === state.year) {
          option.selected = true;
        }
        dom.yearSelect.appendChild(option);
      }
    }

    function bindEvents() {
      dom.yearSelect.addEventListener('change', (event) => {
        const selectedYear = event.target.value;
        state.year = selectedYear;
        currentYear = selectedYear;
        renderYearLabels();
        loadDashboard(selectedYear);
      });
      dom.refreshButton.addEventListener('click', () => {
        loadDashboard(state.year);
      });
    }

    function renderYearLabels() {
      dom.dashboardYearLabel.textContent = state.year;
      dom.metricYearInline.textContent = state.year;
    }

    async function loadDashboard(year) {
      toggleLoading(true);
      dom.statusMessage.textContent = 'Syncing data from Firebase...';
      try {
        const basePath = `/schools/Socrates School Preform one/${year}`;
        const [studentsSnap, expensesSnap] = await Promise.all([
          db.ref(`${basePath}/students`).once('value'),
          db.ref(`${basePath}/expenses`).once('value')
        ]);
        const students = studentsSnap.val() || {};
        const expenses = expensesSnap.val() || {};
        const metrics = computeMetrics(students, expenses, year);
        hydrateDashboard(metrics);
        dom.statusMessage.textContent = `Live data captured for ${metrics.totals.registered} learners.`;
        dom.lastUpdated.textContent = new Date().toLocaleString('en-GB', {
          hour: '2-digit',
          minute: '2-digit',
          day: '2-digit',
          month: 'short'
        });
      } catch (error) {
        console.error('Dashboard load error:', error);
        dom.statusMessage.textContent = 'Unable to load data. Check your connection and try again.';
        if (window.Swal) {
          Swal.fire('Dashboard Error', error.message || 'Unknown error', 'error');
        }
      } finally {
        toggleLoading(false);
      }
    }
    function computeMetrics(studentsObj, expensesObj, year) {
      const entries = Object.entries(studentsObj || {});
      const todayKey = new Date().toISOString().split('T')[0];
      const totals = {
        registered: entries.length,
        presentToday: 0,
        absentToday: 0,
        notMarkedToday: 0,
        attendanceRecorded: 0,
        attendancePresent: 0,
        expectedFull: 0,
        expectedNow: 0,
        collected: 0,
        collectedToday: 0,
        shifted: 0,
        girls: 0,
        boys: 0
      };
      const outstandingRecords = [];
      const attendanceAlerts = [];
      const paymentsRecords = [];
      const monthlyAttendance = new Map();
      const absenceReasons = {};

      entries.forEach(([adm, student]) => {
        const name = `${student.firstName || ''} ${student.lastName || ''}`.trim() || adm;
        const totalFee = Number(student.totalFee || student.feePerYear || student.feeDue || student.required || 0);
        totals.expectedFull += totalFee;
        totals.expectedNow += calculateExpectedToDate(student.reportingDate, totalFee, year);
        if (student.shifted) totals.shifted += 1;
        const gender = (student.gender || '').toLowerCase();
        if (gender.startsWith('f')) totals.girls += 1;
        else if (gender.startsWith('m')) totals.boys += 1;

        const payments = normalizeCollection(student.payments).map((payment) => ({
          ...payment,
          amount: Number(payment.amount || 0),
          date: payment.date || '',
          method: payment.method || '',
          note: payment.note || '',
          timestamp: payment.timestamp || payment.createdAt || ''
        }));
        const paidSum = payments.reduce((sum, payment) => sum + payment.amount, 0);
        totals.collected += paidSum;
        totals.collectedToday += payments
          .filter((payment) => payment.date === todayKey)
          .reduce((sum, payment) => sum + payment.amount, 0);
        payments.forEach((payment) => paymentsRecords.push({ adm, name, ...payment }));

        const attendance = normalizeCollection(student.attendance);
        attendance.forEach((record) => {
          if (!record || !record.date) return;
          const present = isPresentRecord(record);
          totals.attendanceRecorded += 1;
          if (present) totals.attendancePresent += 1;
          const monthKey = monthKeyFromDate(record.date);
          if (!monthlyAttendance.has(monthKey.key)) {
            monthlyAttendance.set(monthKey.key, { label: monthKey.label, order: monthKey.order, present: 0, total: 0 });
          }
          const bucket = monthlyAttendance.get(monthKey.key);
          bucket.total += 1;
          if (present) bucket.present += 1;
          if (!present) {
            const reasonCode = deriveReason(record);
            absenceReasons[reasonCode] = (absenceReasons[reasonCode] || 0) + 1;
          }
        });

        const todaysRecord = attendance.find((record) => record && record.date === todayKey);
        if (todaysRecord) {
          if (isPresentRecord(todaysRecord)) {
            totals.presentToday += 1;
          } else {
            totals.absentToday += 1;
            attendanceAlerts.push(buildAttendanceAlert(adm, name, todaysRecord));
          }
        } else {
          totals.notMarkedToday += 1;
          attendanceAlerts.push({ adm, name, status: 'Not Marked', note: 'Awaiting roll call' });
        }

        const outstanding = Math.max(totalFee - paidSum, 0);
        if (outstanding > 0) {
          outstandingRecords.push({
            adm,
            name,
            outstanding,
            parent: student.parentName || '',
            contact: student.parentContact || ''
          });
        }
      });

      totals.absentToday += totals.notMarkedToday;
      const expensesTotal = Object.values(expensesObj || {}).reduce(
        (sum, expense) => sum + Number(expense.amount || 0),
        0
      );

      const attendanceRate = totals.attendanceRecorded
        ? (totals.attendancePresent / totals.attendanceRecorded) * 100
        : (totals.registered ? (totals.presentToday / totals.registered) * 100 : 0);

      const outstandingFull = Math.max(totals.expectedFull - totals.collected, 0);
      const outstandingToday = Math.max(totals.expectedNow - totals.collected, 0);
      const netBalance = totals.collected - expensesTotal;

      const monthlyTrend = Array.from(monthlyAttendance.values())
        .sort((a, b) => a.order - b.order)
        .map((bucket) => ({
          label: bucket.label,
          pct: bucket.total ? (bucket.present / bucket.total) * 100 : 0,
          total: bucket.total
        }));

      const absenceMix = Object.entries(absenceReasons)
        .map(([code, count]) => ({
          code,
          label: REASONS_MAP[code] || code,
          count
        }))
        .sort((a, b) => b.count - a.count);

      const outstandingTop = outstandingRecords
        .sort((a, b) => b.outstanding - a.outstanding)
        .slice(0, 6);

      const paymentsRecent = paymentsRecords
        .sort((a, b) => toTimestamp(b.timestamp, b.date) - toTimestamp(a.timestamp, a.date))
        .slice(0, 8);

      const attendanceAlertsSorted = attendanceAlerts
        .sort((a, b) => a.status.localeCompare(b.status))
        .slice(0, 8);

      return {
        totals: {
          ...totals,
          expenses: expensesTotal,
          attendanceRate,
          outstandingFull,
          outstandingToday,
          netBalance
        },
        outstandingTop,
        paymentsRecent,
        attendanceAlerts: attendanceAlertsSorted,
        monthlyTrend,
        absenceMix
      };
    }

    function hydrateDashboard(metrics) {
      const { totals } = metrics;
      dom.totalStudents.textContent = formatNumber(totals.registered);
      dom.presentToday.textContent = formatNumber(totals.presentToday);
      dom.absentToday.textContent = formatNumber(totals.absentToday);
      dom.attendanceRate.textContent = formatPercent(totals.attendanceRate);
      dom.shifted.textContent = formatNumber(totals.shifted);
      dom.genderSplit.textContent = `${formatNumber(totals.girls)} / ${formatNumber(totals.boys)}`;

      dom.expectedFull.textContent = formatCurrency(totals.expectedFull);
      dom.expectedNow.textContent = formatCurrency(totals.expectedNow);
      dom.collected.textContent = formatCurrency(totals.collected);
      dom.outstandingFull.textContent = formatCurrency(totals.outstandingFull);
      dom.outstandingToday.textContent = formatCurrency(totals.outstandingToday);
      dom.expenses.textContent = formatCurrency(totals.expenses);
      dom.net.textContent = formatCurrency(totals.netBalance);
      dom.collectedToday.textContent = formatCurrency(totals.collectedToday);

      const progressRatio = totals.expectedFull > 0 ? Math.min(totals.collected / totals.expectedFull, 1) : 0;
      dom.collectionsProgress.style.width = `${(progressRatio * 100).toFixed(1)}%`;
      dom.collectionsLabel.textContent = `${formatPercent(progressRatio * 100)} of yearly goal collected`;
      dom.collectionsHeadline.textContent = `${formatCurrency(totals.collected)} of ${formatCurrency(totals.expectedFull)}`;

      setList(dom.topOutstandingList, metrics.outstandingTop, (item) => `
        <div class="flex items-center justify-between rounded-xl bg-slate-900/70 px-3 py-2">
          <div>
            <p class="font-semibold text-slate-100">${item.name}</p>
            <p class="text-xs text-slate-400">${item.adm} &middot; ${item.parent || 'Parent N/A'}</p>
          </div>
          <div class="text-right">
            <p class="font-semibold text-rose-300">${formatCurrency(item.outstanding)}</p>
            <p class="text-xs text-slate-500">${item.contact || ''}</p>
          </div>
        </div>
      `, 'All accounts are clear for now.');

      setList(dom.attendanceAlertsList, metrics.attendanceAlerts, (alert) => `
        <div class="flex items-center justify-between rounded-xl bg-slate-900/70 px-3 py-2">
          <div>
            <p class="font-semibold text-slate-100">${alert.name}</p>
            <p class="text-xs text-slate-400">${alert.adm}</p>
          </div>
          <span class="badge-soft ${alert.status === 'Not Marked' ? 'bg-amber-500/20 text-amber-200' : 'bg-rose-500/20 text-rose-200'}">
            ${alert.status}
          </span>
        </div>
      `, 'Everyone is marked present today.');

      setList(dom.recentPaymentsList, metrics.paymentsRecent, (payment) => `
        <div class="flex items-center justify-between rounded-xl bg-slate-900/70 px-3 py-2">
          <div>
            <p class="font-semibold text-slate-100">${payment.name}</p>
            <p class="text-xs text-slate-400">${payment.adm} &middot; ${payment.method || 'Method N/A'}</p>
          </div>
          <div class="text-right">
            <p class="font-semibold text-emerald-300">${formatCurrency(payment.amount)}</p>
            <p class="text-xs text-slate-500">${formatDate(payment.date)}</p>
          </div>
        </div>
      `, 'No collections recorded yet.');

      dom.attendanceTrend.innerHTML = metrics.monthlyTrend.length
        ? metrics.monthlyTrend.slice(-8).map((bucket) => `
            <div class="rounded-xl bg-slate-900/70 px-3 py-2">
              <p class="text-xs uppercase tracking-wide text-slate-400">${bucket.label}</p>
              <p class="text-base font-semibold text-white">${formatPercent(bucket.pct)}</p>
              <p class="text-xs text-slate-500">${bucket.total} records</p>
            </div>
          `).join('')
        : '<p class="list-empty">Attendance records will appear here after marking.</p>';

      dom.absenceReasonsList.innerHTML = metrics.absenceMix.length
        ? metrics.absenceMix.slice(0, 6).map((item) => `
            <span class="badge-soft bg-slate-900/70 text-slate-100">
              ${item.label}: ${formatNumber(item.count)}
            </span>
          `).join('')
        : '<span class="list-empty">No absence reasons logged yet.</span>';
    }
    function toggleLoading(show) {
      state.loading = show;
      dom.overlay.classList.toggle('hidden', !show);
    }

    function normalizeCollection(collection) {
      if (!collection) return [];
      if (Array.isArray(collection)) {
        return collection.filter(Boolean);
      }
      return Object.values(collection);
    }

    function isPresentRecord(record) {
      if (!record) return false;
      if (typeof record.present === 'boolean') return record.present;
      const am = String(record.am || '').trim().toUpperCase();
      const pm = String(record.pm || '').trim().toUpperCase();
      return am === 'P' && pm === 'P';
    }

    function deriveReason(record) {
      if (!record) return 'A';
      const priority = [record.am, record.pm]
        .map((code) => String(code || '').trim().toUpperCase())
        .find((code) => code && code !== 'P');
      return priority || (record.present ? 'P' : 'A');
    }

    function calculateExpectedToDate(reportingDate, totalFee, year) {
      const total = Number(totalFee || 0);
      if (!reportingDate || !total) return total;
      const start = new Date(reportingDate);
      if (Number.isNaN(start.getTime())) return total;
      const programEnd = new Date(Number(year), 11, 15);
      const today = new Date();
      const effectiveEnd = today > programEnd ? programEnd : today;
      if (effectiveEnd < start) return 0;

      let expected = 0;
      let cursor = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      while (cursor <= effectiveEnd && expected < total + FEE_PER_MONTH) {
        const sameMonth = cursor.getFullYear() === effectiveEnd.getFullYear() && cursor.getMonth() === effectiveEnd.getMonth();
        const daysInMonth = new Date(cursor.getFullYear(), cursor.getMonth() + 1, 0).getDate();
        if (sameMonth) {
          const fraction = effectiveEnd.getDate() / daysInMonth;
          expected += fraction * FEE_PER_MONTH;
        } else if (cursor.getFullYear() === start.getFullYear() && cursor.getMonth() === start.getMonth()) {
          const fraction = (daysInMonth - cursor.getDate() + 1) / daysInMonth;
          expected += fraction * FEE_PER_MONTH;
        } else {
          expected += FEE_PER_MONTH;
        }
        cursor.setMonth(cursor.getMonth() + 1, 1);
      }
      return Math.min(Math.max(expected, 0), total);
    }

    function monthKeyFromDate(dateString) {
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) {
        return { key: dateString, label: dateString, order: Date.now() };
      }
      const label = date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
      const order = new Date(date.getFullYear(), date.getMonth(), 1).getTime();
      return { key: `${date.getFullYear()}-${date.getMonth() + 1}`, label, order };
    }

    function buildAttendanceAlert(adm, name, record) {
      if (!record) {
        return { adm, name, status: 'Not Marked', note: '' };
      }
      const reason = deriveReason(record);
      return {
        adm,
        name,
        status: REASONS_MAP[reason] || reason,
        note: record.notes || ''
      };
    }

    function toTimestamp(timestamp, date) {
      if (timestamp) {
        const numeric = Number(timestamp);
        if (!Number.isNaN(numeric) && numeric > 0) return numeric;
      }
      const parsed = new Date(date || Date.now());
      return parsed.getTime();
    }

    function setList(container, items, templateFn, emptyMessage) {
      if (!items || !items.length) {
        container.innerHTML = `<p class="list-empty">${emptyMessage}</p>`;
        return;
      }
      container.innerHTML = items.map(templateFn).join('');
    }

    function formatCurrency(value) {
      const amount = Number(value || 0);
      return `TSh ${amount.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
    }

    function formatNumber(value) {
      return Number(value || 0).toLocaleString('en-US');
    }

    function formatPercent(value) {
      return `${Number(value || 0).toFixed(1)}%`;
    }

    function formatDate(value) {
      if (!value) return 'Date N/A';
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) return value;
      return parsed.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
    }
  </script>
</body>
</html>
