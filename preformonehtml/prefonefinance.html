<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SoMAp — Pre‑Form One Finance</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- (Optional) shared logic if you use it elsewhere -->
  <!-- <script src="prefonecommon.js"></script> -->

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Poppins', 'Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            somap: {
              midnight: '#020617',
              ocean: '#0ea5e9',
              orchid: '#8b5cf6',
              mint: '#34d399',
              amber: '#fbbf24',
            },
          },
          boxShadow: {
            neon: '0 20px 60px -28px rgba(14,165,233,.7)',
          },
        },
      },
    };
  </script>
  <style>
    body{
      background: radial-gradient(circle at 20% -10%, rgba(79, 70, 229, 0.35), rgba(15, 23, 42, 0.96) 62%);
      min-height:100vh;color:#e2e8f0;font-family:'Inter',system-ui,sans-serif
    }
    .glass{background:rgba(15,23,42,.82);border-radius:1.75rem;border:1px solid rgba(148,163,184,.22);backdrop-filter:blur(16px);box-shadow:0 30px 80px -45px rgba(8,47,73,.85)}
    .stat{position:relative;border-radius:1.35rem;padding:1.35rem;background:linear-gradient(135deg, rgba(20,184,166,.22), rgba(59,130,246,.24));border:1px solid rgba(148,163,184,.28);box-shadow:0 25px 65px -50px rgba(20,184,166,.9);transition:transform .18s ease,border-color .2s ease, box-shadow .2s ease}
    .stat:hover{transform:translateY(-6px);border-color:rgba(96,165,250,.55);box-shadow:0 35px 80px -50px rgba(59,130,246,.75)}
    .pill{padding:.35rem .85rem;border-radius:999px;font-size:.75rem;font-weight:600;letter-spacing:.02em}
    .paid{background:rgba(34,197,94,.22);color:#86efac;border:1px solid rgba(34,197,94,.4)}
    .partial{background:rgba(250,204,21,.18);color:#facc15;border:1px solid rgba(250,204,21,.38)}
    .overdue{background:rgba(248,113,113,.2);color:#fca5a5;border:1px solid rgba(248,113,113,.45)}
    .chip{display:inline-flex;align-items:center;gap:.35rem;border-radius:999px;padding:.3rem .85rem;border:1px solid rgba(148,163,184,.24);background:rgba(148,163,184,.12);font-size:.75rem;color:rgba(226,232,240,.85);letter-spacing:.02em;text-transform:uppercase}
    .chip.over{border-color:rgba(248,113,113,.45);background:rgba(248,113,113,.12);color:#fca5a5}
    .chip.soon{border-color:rgba(250,204,21,.4);background:rgba(250,204,21,.12);color:#facc15}
    table thead th{text-transform:uppercase;letter-spacing:.04em;font-size:.68rem}
    table tbody td{border-bottom:1px solid rgba(148,163,184,.12)}
    table tfoot td{background:rgba(59,130,246,.12);border-top:1px solid rgba(59,130,246,.35)}
    .backdrop{display:none;position:fixed;inset:0;z-index:50;background:rgba(2,6,23,.65);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:1.5rem}
    .card{width:100%;max-width:460px;border-radius:1.5rem;background:rgba(15,23,42,.95);border:1px solid rgba(148,163,184,.25);box-shadow:0 35px 90px -45px rgba(14,165,233,.75);color:#e2e8f0}
    .card.wide{max-width:620px}
    .card input,.card select,.card textarea{background:rgba(30,41,59,.65);border:1px solid rgba(148,163,184,.28);border-radius:.9rem;color:#e2e8f0;width:100%}
    .card input:focus,.card select:focus{outline:none;border-color:rgba(14,165,233,.6);box-shadow:0 0 0 1px rgba(14,165,233,.25)}
  </style>
</head>
<body class="relative min-h-screen overflow-x-hidden">
  <!-- lighting -->
  <div class="pointer-events-none absolute inset-0 -z-10">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_80%_20%,rgba(99,102,241,0.24),transparent_40%)]"></div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_15%_25%,rgba(14,165,233,0.16),transparent_35%)]"></div>
    <div class="absolute inset-0 bg-[linear-gradient(140deg,rgba(2,6,23,0.85),rgba(15,23,42,0.95))]"></div>
  </div>

  <main class="relative mx-auto flex w-full max-w-7xl flex-col gap-10 px-4 py-10 sm:px-6 lg:px-10">
    <header class="flex flex-col gap-6 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <span class="inline-flex items-center gap-2 rounded-full border border-sky-500/30 bg-sky-500/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-sky-200/80">
          <i class="fas fa-coins text-sky-300"></i> Finance Desk
        </span>
        <h1 class="mt-4 text-3xl font-semibold text-slate-100 sm:text-4xl">Pre‑Form One — Finance Control Room</h1>
        <p class="mt-2 max-w-2xl text-sm text-slate-400 sm:text-base">Track collections, balances, and expenses with a calm, glass dashboard.
        </p>
      </div>
      <a href="prefonedashboard.html" class="inline-flex items-center gap-2 rounded-full border border-slate-500/40 bg-slate-900/40 px-4 py-2 text-sm font-medium text-slate-200 transition hover:border-sky-400/60 hover:bg-slate-900/70 hover:text-white">
        <i class="fas fa-arrow-left"></i>
        Back to Dashboard
      </a>
    </header>

    <!-- KPIs -->
    <section class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-5">
      <article class="stat"><span class="text-xs uppercase tracking-widest text-slate-300">Total Due</span><p id="totalDue" class="mt-2 text-2xl font-semibold text-sky-100">TSh 0</p><p class="mt-4 text-xs text-slate-400">Projected invoices.</p></article>
      <article class="stat"><span class="text-xs uppercase tracking-widest text-slate-300">Collected</span><p id="collected" class="mt-2 text-2xl font-semibold text-emerald-100">TSh 0</p><p class="mt-4 text-xs text-slate-400">Payments posted.</p></article>
      <article class="stat"><span class="text-xs uppercase tracking-widest text-slate-300">Outstanding</span><p id="outstanding" class="mt-2 text-2xl font-semibold text-amber-100">TSh 0</p><p class="mt-4 text-xs text-slate-400">Balances for follow‑up.</p></article>
      <article class="stat"><span class="text-xs uppercase tracking-widest text-slate-300">Expenses</span><p id="expensesTotal" class="mt-2 text-2xl font-semibold text-rose-100">TSh 0</p><p class="mt-4 text-xs text-slate-400">Approved spending.</p></article>
      <article class="stat"><span class="text-xs uppercase tracking-widest text-slate-300">Net Balance</span><p id="netBal" class="mt-2 text-2xl font-semibold text-indigo-100">TSh 0</p><p class="mt-4 text-xs text-slate-400">Collections − Expenses.</p></article>
    </section>

    <!-- Learners -->
    <section class="glass px-6 py-8 sm:px-8 sm:py-10">
      <div class="flex flex-col gap-5 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-white">Learner Collections</h2>
          <p class="mt-1 text-sm text-slate-400">Monitor fees per child, highlight debtors, and export registers.</p>
        </div>
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
          <label class="text-xs font-semibold uppercase tracking-widest text-slate-400 sm:text-right">Filter Cohort</label>
          <select id="classFilter" class="w-full rounded-full border border-slate-500/40 bg-slate-900/50 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 sm:w-56" onchange="renderTable()">
            <option value="">All Pre‑Form One</option>
            <option>September Joiners</option>
            <option>October Joiners</option>
            <option>November Joiners</option>
          </select>
        </div>
      </div>

      <div class="mt-6 flex flex-col gap-3 md:flex-row md:flex-wrap md:items-center md:justify-between">
        <button id="debtorsBtn" onclick="toggleDebtors()" class="inline-flex items-center gap-2 rounded-full border border-amber-400/50 bg-amber-500/15 px-4 py-2 text-sm font-medium text-amber-200 transition hover:border-amber-300 hover:bg-amber-500/25">
          <i class="fas fa-exclamation-triangle"></i>
          <span id="debtorsToggleLabel">Show Debtors</span>
        </button>
        <div class="flex flex-wrap gap-2">
          <button onclick="exportMainCSV()" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/15 px-4 py-2 text-sm font-medium text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-400/25"><i class="fas fa-file-csv"></i> Main CSV</button>
          <button onclick="exportMainPDF()" class="inline-flex items-center gap-2 rounded-full border border-rose-400/40 bg-rose-400/15 px-4 py-2 text-sm font-medium text-rose-100 transition hover:border-rose-300 hover:bg-rose-400/25"><i class="fas fa-file-pdf"></i> Main PDF</button>
          <button onclick="exportDebtorsCSV()" class="inline-flex items-center gap-2 rounded-full border border-amber-400/40 bg-amber-400/15 px-4 py-2 text-sm font-medium text-amber-100 transition hover:border-amber-300 hover:bg-amber-400/25"><i class="fas fa-file-csv"></i> Debtors CSV</button>
          <button onclick="exportDebtorsPDF()" class="inline-flex items-center gap-2 rounded-full border border-orange-400/40 bg-orange-400/15 px-4 py-2 text-sm font-medium text-orange-100 transition hover:border-orange-300 hover:bg-orange-400/25"><i class="fas fa-file-pdf"></i> Debtors PDF</button>
        </div>
      </div>

      <div class="mt-6 hidden items-center gap-2 text-slate-400" id="loadLine"><i class="fas fa-circle-notch fa-spin"></i><span>Loading learners…</span></div>

      <div class="mt-4 overflow-x-auto rounded-3xl border border-slate-500/30 bg-slate-900/35">
        <table class="min-w-full text-left text-sm text-slate-100">
          <thead class="border-b border-slate-500/30 bg-slate-900/60 text-xs text-slate-300">
            <tr>
              <th class="px-5 py-4">ADM No</th>
              <th class="px-5 py-4">Full Name</th>
              <th class="px-5 py-4">Parent Contact</th>
              <th class="px-5 py-4">Total Fee</th>
              <th class="px-5 py-4">Payment Plan</th>
              <th class="px-5 py-4">Paid</th>
              <th class="px-5 py-4">Balance</th>
              <th class="px-5 py-4">Debt Till</th>
              <th class="px-5 py-4">Status</th>
              <th class="px-5 py-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="financeBody" class="divide-y divide-slate-500/15"></tbody>
          <tfoot id="financeTotals"></tfoot>
        </table>
      </div>
    </section>

    <!-- Expenses -->
    <section class="glass px-6 py-8 sm:px-8 sm:py-10">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-white">Operations Expenses</h2>
          <p class="mt-1 text-sm text-slate-400">Log daily spending and export a clean register.</p>
        </div>
        <form id="expenseForm" class="flex w-full flex-col gap-3 rounded-2xl border border-slate-500/30 bg-slate-900/30 p-4 md:w-auto md:flex-row md:items-center md:gap-4">
          <select id="expenseCategory" class="w-full rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 md:w-44" required>
            <option value="">Category</option>
            <option>STATIONERY</option>
            <option>TRANSPORT</option>
            <option>PURCHASES</option>
            <option>SIL</option>
            <option>MAINTENANCE</option>
            <option>BOOKS</option>
            <option>EMERGENCY</option>
            <option>MISCELLANEOUS</option>
          </select>
          <input id="expenseDescription" type="text" placeholder="Description" class="w-full rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 md:w-56" required />
          <input id="expenseAmount" type="number" min="1" placeholder="Amount" class="w-full rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 md:w-40" required />
          <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-full border border-indigo-400/40 bg-indigo-500/20 px-4 py-2 text-sm font-semibold text-indigo-100 transition hover:border-indigo-300 hover:bg-indigo-500/30 md:w-auto"><i class="fas fa-plus-circle"></i> Add Expense</button>
        </form>
      </div>

      <div class="mt-6 flex flex-wrap gap-2">
        <button onclick="exportExpenseCSV()" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/15 px-4 py-2 text-sm font-medium text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-400/25"><i class="fas fa-file-csv"></i> Expenses CSV</button>
        <button onclick="exportExpensePDF()" class="inline-flex items-center gap-2 rounded-full border border-rose-400/40 bg-rose-400/15 px-4 py-2 text-sm font-medium text-rose-100 transition hover:border-rose-300 hover:bg-rose-400/25"><i class="fas fa-file-pdf"></i> Expenses PDF</button>
      </div>

      <div class="mt-8 overflow-x-auto rounded-3xl border border-slate-500/30 bg-slate-900/35">
        <table class="min-w-full text-left text-sm text-slate-100">
          <thead class="border-b border-slate-500/30 bg-slate-900/60 text-xs text-slate-300">
            <tr>
              <th class="px-5 py-4">Category</th>
              <th class="px-5 py-4">Description</th>
              <th class="px-5 py-4">Amount</th>
              <th class="px-5 py-4">Date</th>
            </tr>
          </thead>
          <tbody id="expenseBody" class="divide-y divide-slate-500/15"></tbody>
          <tfoot id="expenseTotals"></tfoot>
        </table>
      </div>
    </section>
  </main>

  <!-- Payment Modal -->
  <div id="paymentModal" class="backdrop">
    <div class="card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white"><i class="fas fa-money-check mr-2 text-sky-300"></i> Add Payment</h2>
        <button type="button" class="text-slate-400 transition hover:text-white" onclick="closeModal('paymentModal')"><i class="fas fa-times text-lg"></i></button>
      </div>
      <form id="paymentForm" class="mt-6 space-y-4">
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Amount Received</label>
          <input id="paymentAmount" type="number" min="1" class="px-4 py-3 text-sm" placeholder="Enter amount" required />
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Received On</label>
          <input id="paymentDate" type="date" class="px-4 py-3 text-sm" required />
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Payment Method</label>
          <select id="paymentMethod" class="px-4 py-3 text-sm">
            <option>Cash</option>
            <option>MPesa</option>
            <option>Airtel Money</option>
            <option>TigoPesa</option>
            <option>Bank Transfer</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Collector (who received)</label>
          <input id="paymentCollector" type="text" class="px-4 py-3 text-sm" placeholder="e.g., Faith / Mr. Mussa" />
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Notes (optional)</label>
          <textarea id="paymentNote" rows="2" class="px-4 py-3 text-sm" placeholder="Reference, receipt #, etc."></textarea>
        </div>
        <div class="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
          <button type="button" onclick="closeModal('paymentModal')" class="inline-flex items-center justify-center gap-2 rounded-full border border-slate-500/40 px-4 py-2 text-sm font-medium text-slate-300 transition hover:border-slate-300 hover:text-white">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-full border border-sky-400/40 bg-sky-500/25 px-5 py-2 text-sm font-semibold text-sky-100 transition hover:border-sky-300 hover:bg-sky-500/35"><i class="fas fa-save"></i> Save Payment</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="detailsModal" class="backdrop">
    <div class="card wide p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white"><i class="fas fa-user-circle mr-2 text-indigo-300"></i> Student Finance Details</h2>
        <button type="button" class="text-slate-400 transition hover:text-white" onclick="closeModal('detailsModal')"><i class="fas fa-times text-lg"></i></button>
      </div>
      <div id="detailsContent" class="mt-6 space-y-3 text-sm text-slate-300"></div>
    </div>
  </div>

  <script>
    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3",
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- State ---
    let financeData = [];
    let expensesCache = [];
    let showingDebtors = false;
    let selectedAdm = '';
    const todayStr = () => new Date().toISOString().split('T')[0];
    const resolveYear = () => (window.currentYear ?? new Date().getFullYear());

    const fmt = (v) => `TSh ${Number(v||0).toLocaleString()}`;
    const safe = (v='') => String(v).replace(/<[^>]*>/g,'');

    // --- Helpers: flexible school path detection (handles naming variations) ---
    async function detectPrefoneBase(){
      const year = resolveYear();
      try{
        const schoolsSnap = await db.ref('/schools').once('value');
        const schools = schoolsSnap.val() || {};
        // Try exact known key first
        let key = Object.keys(schools).find(k => k === 'Socrates School Preform one');
        if(!key){
          // Try fuzzy match: contains 'preform' and 'one'
          key = Object.keys(schools).find(k => /pre\s*form\s*one|preform\s*one/i.test(k));
        }
        if(!key){
          // Last resort: any key containing 'pre' and 'one'
          key = Object.keys(schools).find(k => /pre/i.test(k) && /one/i.test(k)) || 'Socrates School Preform one';
        }
        return `/schools/${key}/${year}`;
      }catch(e){
        console.warn('School detection failed, using default key.', e);
        return `/schools/Socrates School Preform one/${year}`;
      }
    }

    // --- Auth: sign in anonymously if rules require auth ---
    function ensureAuth(){
      return new Promise((resolve)=>{
        const done = ()=> resolve();
        firebase.auth().onAuthStateChanged(u=> u ? done() : null);
        firebase.auth().signInAnonymously().catch(()=>{}).finally(()=>{
          // Give onAuthStateChanged a tick; also resolve after short delay as fallback
          setTimeout(done, 600);
        });
      });
    }

    // --- Loaders ---
    async function loadAll(){
      document.getElementById('loadLine').classList.remove('hidden');
      await ensureAuth();
      const base = await detectPrefoneBase();
      await Promise.all([loadFinance(base), loadExpenses(base)]);
      document.getElementById('loadLine').classList.add('hidden');
    }

    async function loadFinance(base){
      try{
        const snap = await db.ref(`${base}/students`).once('value');
        const val = snap.val() || {};
        const list = Object.entries(val);
        let due=0, coll=0;

        financeData = list.map(([adm, s])=>{
          const payments = Object.values(s.payments || {}).map(p=>({
            amount: Number(p.amount||0),
            date: p.date || todayStr(),
            method: p.method || 'Cash',
            note: p.note || '',
            collector: p.collector || p.recorder || '',
          }));
          const paid = payments.reduce((t,p)=>t+Number(p.amount||0),0);
          const totalFee = Number(s.totalFee || s.required || 0);
          const bal = Math.max(0, totalFee - paid);
          due += totalFee; coll += paid;

          const planStart = s.reportingDate || s.planStart || s.joinDate || null;
          const nextDue = planStart ? new Date(planStart) : new Date();
          nextDue.setMonth(nextDue.getMonth()+1);
          const days = (nextDue - new Date())/(1000*60*60*24);
          const chipCls = days<0? 'chip over' : days<7? 'chip soon' : 'chip';
          const debtLabel = days<0? `Overdue ${Math.abs(days).toFixed(0)} days` : days<7? `Due in ${days.toFixed(0)} days` : `Due ${nextDue.toLocaleDateString('en-GB')}`;
          const status = bal<=0? 'paid' : (days<0? 'overdue' : 'partial');

          const name = `${s.firstName||s.firstname||''} ${s.lastName||s.lastname||''}`.trim() || (s.name||'Unnamed Learner');
          const contact = s.parentContact || s.parentPhone || s.guardianPhone || s.phone || '';

          return {
            adm, name, contact, totalFee, plan: planStart? `From ${new Date(planStart).toLocaleDateString('en-GB')}` : 'Full Program',
            paid, bal, debtTill:`<span class="${chipCls}">${safe(debtLabel)}</span>`, status,
            cohort: s.cohort || s.batch || '',
            photoUrl: s.photoUrl || '',
            rawDebtInfo:{ label:debtLabel },
            payments,
          }
        });

        // KPIs
        const baseExpSnap = await db.ref(`${base}/expenses`).once('value');
        const expArr = Object.values(baseExpSnap.val()||{});
        const expTotal = expArr.reduce((t, ex)=>t+Number(ex.amount||0),0);
        document.getElementById('totalDue').textContent = fmt(due);
        document.getElementById('collected').textContent = fmt(coll);
        document.getElementById('outstanding').textContent = fmt(Math.max(0, due-coll));
        document.getElementById('expensesTotal').textContent = fmt(expTotal);
        document.getElementById('netBal').textContent = fmt(coll-expTotal);

        renderTable();
      }catch(err){
        console.error(err);
        Swal.fire('Error', 'Failed to load finance data. Check DB path and rules.\n'+err.message, 'error');
      }
    }

    async function loadExpenses(base){
      try{
        const snap = await db.ref(`${base}/expenses`).once('value');
        const val = snap.val() || {};
        const list = Object.entries(val).map(([k,v])=>({
          id:k,
          category: v.category||'--',
          description: v.description||'--',
          amount: Number(v.amount||0),
          date: v.date || todayStr(),
        }));
        expensesCache = list;
        renderExpenses();
      }catch(err){
        console.error(err);
        Swal.fire('Error', 'Failed to load expenses. '+err.message, 'error');
      }
    }

    // --- Renderers ---
    function visibleRows(){
      const cohort = document.getElementById('classFilter').value;
      return financeData.filter(r=>{
        const okDebtors = showingDebtors ? r.bal>0 : true;
        const okCohort = cohort ? (String(r.cohort).toLowerCase()===cohort.toLowerCase()) : true;
        return okDebtors && okCohort;
      });
    }

    function renderTable(){
      const tbody = document.getElementById('financeBody');
      const tfoot = document.getElementById('financeTotals');
      tbody.innerHTML = ''; tfoot.innerHTML='';

      const rows = visibleRows();
      let tFee=0, tPaid=0, tBal=0;

      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="10" class="px-5 py-6 text-center text-sm text-slate-400">No learners found for this view.</td></tr>`;
      }else{
        rows.forEach(row=>{
          tFee += row.totalFee; tPaid += row.paid; tBal += row.bal;
          tbody.insertAdjacentHTML('beforeend', `
            <tr class="transition hover:bg-slate-900/45">
              <td class="px-5 py-4 font-semibold text-slate-200">${row.adm}</td>
              <td class="px-5 py-4">${safe(row.name)}</td>
              <td class="px-5 py-4">${safe(row.contact)}</td>
              <td class="px-5 py-4">${fmt(row.totalFee)}</td>
              <td class="px-5 py-4 text-xs text-slate-400">${safe(row.plan)}</td>
              <td class="px-5 py-4 text-emerald-200">${fmt(row.paid)}</td>
              <td class="px-5 py-4 text-amber-200">${fmt(row.bal)}</td>
              <td class="px-5 py-4">${row.debtTill}</td>
              <td class="px-5 py-4"><span class="pill ${row.status}">${row.status[0].toUpperCase()+row.status.slice(1)}</span></td>
              <td class="px-5 py-4 text-right">
                <div class="flex justify-end gap-2">
                  <button class="inline-flex items-center gap-1 rounded-full border border-slate-500/40 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-slate-300 hover:text-white" onclick="viewDetails('${row.adm}')"><i class="fas fa-eye"></i> View</button>
                  <button class="inline-flex items-center gap-1 rounded-full border border-emerald-400/50 bg-emerald-500/15 px-3 py-1 text-xs font-semibold text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-500/25" onclick="openPaymentModal('${row.adm}')"><i class="fas fa-money-bill"></i> Pay</button>
                </div>
              </td>
            </tr>`);
        });
      }

      tfoot.innerHTML = `
        <tr class="text-sm font-semibold text-slate-200">
          <td colspan="3" class="px-5 py-4 uppercase tracking-widest text-slate-300">Totals (${rows.length} learners)</td>
          <td class="px-5 py-4">${fmt(tFee)}</td>
          <td class="px-5 py-4 text-center text-slate-500">--</td>
          <td class="px-5 py-4 text-emerald-200">${fmt(tPaid)}</td>
          <td class="px-5 py-4 text-amber-200">${fmt(tBal)}</td>
          <td class="px-5 py-4 text-center text-slate-500">--</td>
          <td class="px-5 py-4 text-center text-slate-500">--</td>
          <td class="px-5 py-4 text-right text-slate-500">--</td>
        </tr>`;
    }

    function renderExpenses(){
      const tbody = document.getElementById('expenseBody');
      const tfoot = document.getElementById('expenseTotals');
      tbody.innerHTML=''; tfoot.innerHTML='';
      if(!expensesCache.length){
        tbody.innerHTML = `<tr><td colspan="4" class="px-5 py-6 text-center text-sm text-slate-400">No expenses recorded yet.</td></tr>`;
        return;
      }
      let total=0;
      expensesCache.forEach(ex=>{
        total += ex.amount;
        tbody.insertAdjacentHTML('beforeend', `
          <tr class="transition hover:bg-slate-900/45">
            <td class="px-5 py-4">${safe(ex.category)}</td>
            <td class="px-5 py-4 text-slate-300">${safe(ex.description)}</td>
            <td class="px-5 py-4 text-rose-200">${fmt(ex.amount)}</td>
            <td class="px-5 py-4">${safe(ex.date)}</td>
          </tr>`);
      });
      tfoot.innerHTML = `
        <tr class="text-sm font-semibold text-slate-200">
          <td colspan="2" class="px-5 py-4 uppercase tracking-widest text-slate-300">Total Expenses</td>
          <td class="px-5 py-4 text-rose-200">${fmt(total)}</td>
          <td class="px-5 py-4 text-right text-slate-500">--</td>
        </tr>`;
    }

    // --- Modals ---
    function openPaymentModal(adm){
      selectedAdm = adm;
      document.getElementById('paymentDate').value = todayStr();
      document.getElementById('paymentModal').style.display='flex';
    }
    function closeModal(id){ document.getElementById(id).style.display='none'; }

    document.getElementById('paymentForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const amount = parseInt(document.getElementById('paymentAmount').value,10);
      const method = document.getElementById('paymentMethod').value;
      const note = document.getElementById('paymentNote').value;
      const date = document.getElementById('paymentDate').value;
      const collector = document.getElementById('paymentCollector').value;
      if(!amount) return Swal.fire('Error','Enter amount','error');
      if(!date) return Swal.fire('Error','Select the date received','error');

      try{
        const base = await detectPrefoneBase();
        await db.ref(`${base}/students/${selectedAdm}/payments`).push({ amount, method, note, date, collector });
        await db.ref(`${base}/students/${selectedAdm}`).update({ updatedAt: Date.now() });
        Swal.fire('Success','Payment added','success');
        closeModal('paymentModal');
        e.target.reset();
        await loadFinance(base);
      }catch(err){
        Swal.fire('Error','Failed to add payment: '+err.message,'error');
      }
    });

    function viewDetails(adm){
      const row = financeData.find(r=>r.adm===adm); if(!row) return;
      const items = (row.payments||[]).map(p=>`
        <li class="grid grid-cols-4 gap-2 rounded-xl border border-slate-600/30 bg-slate-900/50 px-3 py-2 text-xs">
          <span>${new Date(p.date||todayStr()).toLocaleDateString('en-GB')}</span>
          <span class="font-semibold text-emerald-200">${fmt(p.amount)}</span>
          <span class="text-slate-300">${safe(p.method||'Cash')}</span>
          <span class="text-slate-400 truncate" title="${safe(p.collector||p.note||'')}">${safe(p.collector||p.note||'')}</span>
        </li>`).join('');
      const history = items? `<h3 class="pt-4 text-xs font-semibold uppercase tracking-widest text-slate-400">Recent Payments</h3><ul class="mt-2 space-y-2">${items}</ul>` : '<p class="pt-4 text-xs text-slate-500">No payments recorded yet.</p>';
      document.getElementById('detailsContent').innerHTML = `
        <p><strong class="text-slate-200">ADM:</strong> ${safe(row.adm)}</p>
        <p><strong class="text-slate-200">Name:</strong> ${safe(row.name)}</p>
        <p><strong class="text-slate-200">Contact:</strong> ${safe(row.contact||'--')}</p>
        <p><strong class="text-slate-200">Total Fee:</strong> ${fmt(row.totalFee)}</p>
        <p><strong class="text-slate-200">Paid:</strong> ${fmt(row.paid)}</p>
        <p><strong class="text-slate-200">Balance:</strong> ${fmt(row.bal)}</p>
        <p><strong class="text-slate-200">Debt Status:</strong> ${safe(row.rawDebtInfo.label)}</p>
        ${row.photoUrl? `<img src="${row.photoUrl}" alt="Learner photo" class="mt-4 h-28 w-28 rounded-2xl object-cover">` : ''}
        ${history}`;
      document.getElementById('detailsModal').style.display='flex';
    }

    // --- Expenses submit ---
    document.getElementById('expenseForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const category = document.getElementById('expenseCategory').value;
      const description = document.getElementById('expenseDescription').value;
      const amount = parseInt(document.getElementById('expenseAmount').value,10);
      if(!category || !description || !amount) return Swal.fire('Error','Fill all fields','error');
      try{
        const base = await detectPrefoneBase();
        await db.ref(`${base}/expenses`).push({ category, description, amount, date: todayStr() });
        Swal.fire('Success','Expense added','success');
        e.target.reset();
        await loadExpenses(base);
        await loadFinance(base);
      }catch(err){
        Swal.fire('Error','Failed to add expense: '+err.message,'error');
      }
    });

    // --- Toggles ---
    function toggleDebtors(){
      showingDebtors = !showingDebtors;
      document.getElementById('debtorsToggleLabel').textContent = showingDebtors? 'Show All Learners' : 'Show Debtors';
      renderTable();
    }

    // --- Exports (now with totals rows) ---
    function mainRows(){
      return visibleRows().map(r=>({
        ADM: r.adm,
        Name: r.name,
        Contact: r.contact,
        TotalFee: r.totalFee,
        Plan: r.plan,
        Paid: r.paid,
        Balance: r.bal,
        DebtTill: r.rawDebtInfo.label,
        Status: r.status.toUpperCase(),
      }));
    }

    function exportMainCSV(){
      const rows = mainRows();
      const totals = rows.reduce((a,r)=>({
        fee:a.fee+(+r.TotalFee||0), paid:a.paid+(+r.Paid||0), bal:a.bal+(+r.Balance||0)
      }),{fee:0,paid:0,bal:0});
      const csv = Papa.unparse([
        Object.keys(rows[0]||{ADM:'ADM',Name:'Name',Contact:'Contact',TotalFee:0,Plan:'',Paid:0,Balance:0,DebtTill:'',Status:''}),
        ...rows.map(r=>Object.values(r)),
        ['TOTALS','','',totals.fee,'',totals.paid,totals.bal,'',''],
      ]);
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='preform_finance.csv'; a.click();
    }

    function exportMainPDF(){
      const { jsPDF } = window.jspdf; const doc = new jsPDF('landscape');
      const rows = mainRows();
      const totals = rows.reduce((a,r)=>({
        fee:a.fee+(+r.TotalFee||0), paid:a.paid+(+r.Paid||0), bal:a.bal+(+r.Balance||0)
      }),{fee:0,paid:0,bal:0});
      doc.setFontSize(12); doc.text('Pre‑Form One Finance Register', 14, 14);
      doc.autoTable({
        startY: 18,
        head: [['ADM No','Full Name','Parent Contact','Total Fee','Plan','Paid','Balance','Debt Till','Status']],
        body: rows.map(r=>[
          r.ADM, r.Name, r.Contact, fmt(r.TotalFee), r.Plan, fmt(r.Paid), fmt(r.Balance), r.DebtTill, r.Status
        ]),
        foot: [['TOTALS','','', fmt(totals.fee),'', fmt(totals.paid), fmt(totals.bal),'','']],
        styles: { fontSize: 8 }, headStyles: { fillColor: [15,23,42] }, footStyles:{ fillColor:[30,41,59], textColor: [226,232,240] }
      });
      doc.save('preform_finance.pdf');
    }

    function exportDebtorsCSV(){
      const rows = visibleRows().filter(r=>r.bal>0).map(r=>({ADM:r.adm,Name:r.name,Contact:r.contact,Balance:r.bal,DebtTill:r.rawDebtInfo.label}));
      const totalBal = rows.reduce((t,r)=>t+(+r.Balance||0),0);
      const csv = Papa.unparse([
        ['ADM','Name','Contact','Balance','DebtTill'],
        ...rows.map(r=>[r.ADM,r.Name,r.Contact,r.Balance,r.DebtTill]),
        ['TOTALS','','', totalBal,'']
      ]);
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='preform_debtors.csv'; a.click();
    }

    function exportDebtorsPDF(){
      const { jsPDF } = window.jspdf; const doc = new jsPDF('landscape');
      const rows = visibleRows().filter(r=>r.bal>0).map(r=>[r.adm, r.name, r.contact, fmt(r.bal), r.rawDebtInfo.label]);
      const totalBal = visibleRows().filter(r=>r.bal>0).reduce((t,r)=>t+r.bal,0);
      doc.setFontSize(12); doc.text('Pre‑Form One Debtors List', 14, 14);
      doc.autoTable({
        startY:18,
        head:[['ADM No','Full Name','Parent Contact','Balance','Debt Till']],
        body: rows,
        foot: [['TOTALS','','', fmt(totalBal), '']],
        styles:{ fontSize:8 }, headStyles:{ fillColor:[88,28,135] }, footStyles:{ fillColor:[51,65,85], textColor:[226,232,240] }
      });
      doc.save('preform_debtors.pdf');
    }

    function exportExpenseCSV(){
      const rows = expensesCache.map(e=>[e.category,e.description,e.amount,e.date]);
      const total = expensesCache.reduce((t,e)=>t+e.amount,0);
      if(!rows.length) return Swal.fire('Info','No expenses to export yet.','info');
      const csv = Papa.unparse([
        ['Category','Description','Amount','Date'],
        ...rows,
        ['TOTAL','','', total]
      ]);
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='preform_expenses.csv'; a.click();
    }

    function exportExpensePDF(){
      const rows = expensesCache.map(e=>[e.category, e.description, fmt(e.amount), e.date]);
      const total = expensesCache.reduce((t,e)=>t+e.amount,0);
      if(!rows.length) return Swal.fire('Info','No expenses to export yet.','info');
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      doc.setFontSize(12); doc.text('Pre‑Form One Expense Register', 14, 14);
      doc.autoTable({
        startY:18,
        head:[['Category','Description','Amount','Date']],
        body: rows,
        foot:[['TOTAL','', fmt(total), '']],
        styles:{ fontSize:9 }, headStyles:{ fillColor:[15,23,42] }, footStyles:{ fillColor:[30,41,59], textColor:[226,232,240] }
      });
      doc.save('preform_expenses.pdf');
    }

    // Boot
    loadAll();
  </script>
</body>
</html>