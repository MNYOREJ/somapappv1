
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SoMAp - Preform One Lesson Planner</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="prefonecommon.js"></script>
  <style>
    body {
      background: radial-gradient(circle at top left, rgba(99,102,241,0.15), transparent 50%),
                  radial-gradient(circle at bottom right, rgba(56,189,248,0.12), transparent 50%),
                  linear-gradient(135deg, #0f172a, #1d4ed8);
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }
    .glass-card {
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(24px);
      border-radius: 1.25rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.45);
    }
    .metric-card {
      background: rgba(15, 23, 42, 0.55);
      border-radius: 1.25rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.35);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .metric-card .label {
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.75);
    }
    .metric-value {
      font-size: 1.9rem;
      font-weight: 700;
      color: #bae6fd;
      letter-spacing: -0.02em;
    }
    .metric-subtext {
      font-size: 0.75rem;
      color: rgba(203, 213, 225, 0.8);
      letter-spacing: 0.04em;
    }
    .input-label {
      color: rgba(226, 232, 240, 0.85);
      font-size: 0.78rem;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.08em;
    }
    .t-input {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid transparent;
      border-radius: 0.75rem;
      color: #f8fafc;
      padding: 0.75rem 1rem;
      transition: all 0.2s ease;
      width: 100%;
    }
    .t-input::placeholder {
      color: rgba(148, 163, 184, 0.65);
    }
    .t-input:focus {
      border-color: rgba(59, 130, 246, 0.8);
      outline: none;
      background: rgba(15, 23, 42, 0.65);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }
    .stage-row {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.12);
      transition: border 0.2s ease, transform 0.2s ease;
    }
    .stage-row:hover {
      border-color: rgba(94, 234, 212, 0.4);
      transform: translateY(-1px);
    }
    .stage-row textarea,
    .stage-row input {
      background: transparent;
      color: #f8fafc;
      border: none;
      resize: vertical;
      min-height: 44px;
    }
    .stage-row textarea:focus,
    .stage-row input:focus {
      outline: none;
    }
    .chip {
      border-radius: 9999px;
      background: rgba(59, 130, 246, 0.18);
      padding: 0.35rem 0.75rem;
      font-size: 0.75rem;
      color: #bfdbfe;
    }
    #plansContainer::-webkit-scrollbar {
      width: 6px;
    }
    #plansContainer::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.45);
      border-radius: 999px;
    }
    .board-card {
      background: rgba(15, 23, 42, 0.55);
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.14);
      padding: 1rem 1.25rem;
      transition: transform 0.2s ease, border 0.2s ease;
    }
    .board-card:hover {
      transform: translateY(-2px);
      border-color: rgba(94, 234, 212, 0.45);
    }
    .badge-soft {
      background: rgba(139, 92, 246, 0.25);
      border-radius: 9999px;
      padding: 0.25rem 0.7rem;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #ddd6fe;
    }
    .modal-backdrop {
      background: rgba(15, 23, 42, 0.82);
      backdrop-filter: blur(10px);
    }
  </style>
</head>
<body class="text-slate-100">
  <div class="max-w-7xl mx-auto px-4 py-10 lg:py-16 space-y-8">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-3">
        <div class="inline-flex items-center gap-3">
          <span class="badge-soft">Preform One</span>
          <span class="text-sm text-slate-200/80">Lesson design board</span>
        </div>
        <h1 class="text-4xl font-semibold tracking-tight leading-tight">Lesson Planner</h1>
        <p class="text-slate-200/80 max-w-2xl">Craft dynamic lesson plans, align with NECTA expectations, and keep every teacher accountable. Plans sync across staff dashboards instantly.</p>
      </div>
      <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
        <a href="prefonedashboard.html" class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-slate-800/60 border border-slate-500/40 text-slate-100 hover:bg-slate-700/70 transition">
          <i class="fas fa-arrow-left"></i>
          <span>Back to Dashboard</span>
        </a>
        <div class="glass-card px-4 py-3 flex items-center gap-3">
          <div class="flex flex-col gap-1">
            <label for="yearSelect" class="input-label">Academic Year</label>
            <select id="yearSelect" class="t-input text-sm bg-slate-900/40 border-slate-600/40 min-w-[140px]"></select>
          </div>
          <button id="refreshBtn" type="button" class="text-sky-300 hover:text-sky-100 transition text-xl" title="Reload data">
            <i class="fas fa-rotate-right"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <div class="metric-card">
        <span class="label">Registered Learners</span>
        <span class="metric-value" id="studentTotalStat">0</span>
        <span class="metric-subtext" id="studentBreakdownStat">M:0 ï¿½ F:0</span>
      </div>
      <div class="metric-card">
        <span class="label">My Plans This Month</span>
        <span class="metric-value" id="plansMonthStat">0</span>
        <span class="metric-subtext">Submitted under your login</span>
      </div>
      <div class="metric-card">
        <span class="label">All Plans</span>
        <span class="metric-value" id="plansTotalStat">0</span>
        <span class="metric-subtext">Preform One teachers</span>
      </div>
      <div class="metric-card">
        <span class="label">Last Submitted</span>
        <span class="metric-value text-emerald-200" id="lastPlanStat">-</span>
        <span class="metric-subtext" id="lastPlanTeacher">Waiting for the first plan</span>
      </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-[1.65fr,1fr]">
      <form id="lessonForm" class="glass-card p-6 md:p-8 space-y-7">
        <div class="flex flex-col gap-2">
          <h2 class="text-2xl font-semibold">Build a lesson plan</h2>
          <p class="text-sm text-slate-200/70">Fill in the core lesson data, align objectives, then capture each stage of the session.</p>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <div class="flex flex-col gap-2">
            <label for="subjectSelect" class="input-label">Subject</label>
            <select id="subjectSelect" class="t-input bg-slate-900/40 border-slate-700/40">
              <option value="">Loading subjects...</option>
            </select>
          </div>
          <div class="flex flex-col gap-2">
            <label for="planDate" class="input-label">Date</label>
            <input id="planDate" type="date" class="t-input" required>
          </div>
          <div class="flex flex-col gap-2">
            <label for="teacherName" class="input-label">Teacher name</label>
            <input id="teacherName" type="text" class="t-input" placeholder="e.g. Mr. Emmanuel John" required>
          </div>
          <div class="flex flex-col gap-2">
            <label for="teacherEmail" class="input-label">Teacher email</label>
            <input id="teacherEmail" type="email" class="t-input" placeholder="name@school.ac.tz">
          </div>
        </div>

        <div class="grid gap-4 md:grid-cols-3">
          <div class="flex flex-col gap-2">
            <label for="className" class="input-label">Class</label>
            <input id="className" type="text" class="t-input" value="Preform One" readonly>
          </div>
          <div class="flex flex-col gap-2">
            <label for="periodLabel" class="input-label">Period / Session</label>
            <input id="periodLabel" type="text" class="t-input" placeholder="Period 1">
          </div>
          <div class="flex flex-col gap-2">
            <label for="timeSlot" class="input-label">Time slot</label>
            <input id="timeSlot" type="text" class="t-input" placeholder="08:00 - 08:40">
          </div>
        </div>

        <div class="grid gap-4 md:grid-cols-3">
          <div class="flex flex-col gap-2">
            <label class="input-label">Learners registered</label>
            <input id="numStudents" type="number" class="t-input" value="0" readonly>
          </div>
          <div class="flex flex-col gap-2">
            <label class="input-label">Male</label>
            <input id="maleStudents" type="number" class="t-input" value="0" readonly>
          </div>
          <div class="flex flex-col gap-2">
            <label class="input-label">Female</label>
            <input id="femaleStudents" type="number" class="t-input" value="0" readonly>
          </div>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <div class="flex flex-col gap-2">
            <label for="competences" class="input-label">Competences</label>
            <textarea id="competences" class="t-input min-h-[110px]" placeholder="Key competences targeted this session"></textarea>
          </div>
          <div class="flex flex-col gap-2">
            <label for="generalObjective" class="input-label">General objective</label>
            <textarea id="generalObjective" class="t-input min-h-[110px]" placeholder="Lesson general objective"></textarea>
          </div>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <div class="flex flex-col gap-2">
            <label for="specificObjectives" class="input-label">Specific objectives</label>
            <textarea id="specificObjectives" class="t-input min-h-[110px]" placeholder="Use bullet style sentences for clarity"></textarea>
          </div>
          <div class="flex flex-col gap-2">
            <label for="teachingAids" class="input-label">Teaching aids / resources</label>
            <textarea id="teachingAids" class="t-input min-h-[110px]" placeholder="List apparatus, digital aids, references"></textarea>
          </div>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <div class="flex flex-col gap-2">
            <label for="mainTopic" class="input-label">Main topic</label>
            <input id="mainTopic" type="text" class="t-input" placeholder="Main syllabus topic">
          </div>
          <div class="flex flex-col gap-2">
            <label for="subTopic" class="input-label">Sub topic</label>
            <input id="subTopic" type="text" class="t-input" placeholder="Sub topic / strand">
          </div>
        </div>

        <div class="flex flex-col gap-3">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <h3 class="text-lg font-semibold">Lesson stages</h3>
              <p class="text-xs tracking-wide text-slate-300/80 uppercase">Sequence the lesson flow and assessment touchpoints</p>
            </div>
            <div class="flex items-center gap-3">
              <span class="chip">Total minutes: <span id="stageMinutesTotal">0</span></span>
              <button id="addStageBtn" type="button" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-800/70 text-slate-100 hover:bg-slate-700 transition">
                <i class="fas fa-plus"></i>
                <span>Add stage</span>
              </button>
            </div>
          </div>
          <div id="stagesContainer" class="space-y-4"></div>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <div class="flex flex-col gap-2">
            <label for="references" class="input-label">References</label>
            <textarea id="references" class="t-input min-h-[100px]" placeholder="Textbooks, NECTA docs, websites"></textarea>
          </div>
          <div class="flex flex-col gap-2">
            <label for="crossCutting" class="input-label">Cross-cutting issues</label>
            <textarea id="crossCutting" class="t-input min-h-[100px]" placeholder="Values, soft skills, inclusion, safety emphasis"></textarea>
          </div>
        </div>

        <div class="grid gap-4 md:grid-cols-3">
          <div class="flex flex-col gap-2">
            <label for="studentsEval" class="input-label">Learner evaluation</label>
            <textarea id="studentsEval" class="t-input min-h-[100px]" placeholder="How will learners demonstrate mastery?"></textarea>
          </div>
          <div class="flex flex-col gap-2">
            <label for="teachersEval" class="input-label">Teacher reflection</label>
            <textarea id="teachersEval" class="t-input min-h-[100px]" placeholder="Self-reflection and improvement notes"></textarea>
          </div>
          <div class="flex flex-col gap-2">
            <label for="remarks" class="input-label">Remarks</label>
            <textarea id="remarks" class="t-input min-h-[100px]" placeholder="Additional remarks, follow-up tasks"></textarea>
          </div>
        </div>

        <div class="flex flex-wrap gap-3 justify-end pt-4 border-t border-slate-700/50">
          <button id="resetFormBtn" type="button" class="px-4 py-2.5 rounded-xl bg-slate-800/60 border border-slate-600/40 text-slate-100 hover:bg-slate-700/80 transition">Reset</button>
          <button id="savePlanBtn" type="submit" class="px-5 py-2.5 rounded-xl bg-sky-500 text-slate-900 font-semibold hover:bg-sky-400 transition">Save lesson plan</button>
        </div>
      </form>

      <aside class="glass-card p-6 md:p-7 flex flex-col gap-4 max-h-[calc(100vh-220px)]">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Lesson plan board</h3>
          <span class="chip">Plans: <span id="plansCountLabel">0</span></span>
        </div>
        <p class="text-sm text-slate-300/80">Browse, filter, and reuse lesson plans across the team.</p>
        <div class="grid gap-3">
          <div class="flex flex-col gap-2">
            <label for="filterDate" class="input-label">Filter by date</label>
            <input id="filterDate" type="date" class="t-input">
          </div>
          <div class="flex flex-col gap-2">
            <label for="teacherFilter" class="input-label">Teacher</label>
            <select id="teacherFilter" class="t-input bg-slate-900/40 border-slate-700/40">
              <option value="mine">My plans</option>
              <option value="all">All teachers</option>
            </select>
          </div>
          <div class="flex flex-col gap-2">
            <label for="searchPlans" class="input-label">Search keywords</label>
            <input id="searchPlans" type="search" class="t-input" placeholder="Subject, topic, objective">
          </div>
          <button id="clearFiltersBtn" type="button" class="px-4 py-2.5 rounded-xl bg-slate-800/65 border border-slate-600/40 text-slate-100 hover:bg-slate-700/70 transition">Clear filters</button>
        </div>
        <div id="plansContainer" class="mt-2 space-y-4 overflow-y-auto pr-1.5"></div>
      </aside>
    </div>
  </div>

  <div id="planModal" class="fixed inset-0 z-50 hidden items-center justify-center px-4 modal-backdrop">
    <div class="max-w-3xl w-full glass-card p-6 md:p-8 relative">
      <button id="closePlanModal" type="button" class="absolute top-4 right-4 text-slate-300 hover:text-white text-2xl" title="Close">
        <i class="fas fa-times"></i>
      </button>
      <div id="planModalContent" class="space-y-5 max-h-[80vh] overflow-y-auto pr-2"></div>
    </div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const auth = firebase.auth();

    const SUBJECTS = Array.isArray(window.subjects) && window.subjects.length
      ? window.subjects
      : [
          "Physics",
          "Chemistry",
          "Biology",
          "Historia ya Tanzania",
          "French",
          "Geography",
          "Basic Mathematics",
          "English Course",
          "English Language",
          "Computer Course",
          "Business Studies"
        ];

    if (!Array.isArray(window.subjects) || !window.subjects.length) {
      window.subjects = SUBJECTS;
    }

    const PREFONE_YEAR_KEY = "prefone_year";
    const YEAR_START = 2024;
    const YEAR_END = 2030;
    const DEFAULT_YEAR = 2025;

    let currentYear = resolveSelectedYear();
    window.currentYear = currentYear;

    const state = {
      studentsMeta: { total: 0, male: 0, female: 0 },
      lessonPlans: [],
      stages: [],
      filters: { teacher: "mine", date: "", search: "" },
      currentUser: null
    };

    const defaultStages = [
      { title: "Introduction", time: 5, teaching: "", learning: "", assessment: "" },
      { title: "New Knowledge", time: 20, teaching: "", learning: "", assessment: "" },
      { title: "Application", time: 10, teaching: "", learning: "", assessment: "" },
      { title: "Reflection", time: 5, teaching: "", learning: "", assessment: "" },
      { title: "Conclusion", time: 5, teaching: "", learning: "", assessment: "" }
    ];

    let lessonPlansRef = null;

    document.addEventListener("DOMContentLoaded", () => {
      populateYearOptions();
      populateSubjectOptions();
      initStages();
      attachEventHandlers();
      authenticateUser();
    });

    function resolveSelectedYear() {
      const stored = parseInt(localStorage.getItem(PREFONE_YEAR_KEY), 10);
      if (!Number.isNaN(stored) && stored >= YEAR_START && stored <= YEAR_END) {
        return stored;
      }
      if (typeof window.currentYear === "number" && window.currentYear >= YEAR_START && window.currentYear <= YEAR_END) {
        return window.currentYear;
      }
      return DEFAULT_YEAR;
    }

    function populateYearOptions() {
      const select = document.getElementById("yearSelect");
      if (!select) return;
      select.innerHTML = "";
      for (let year = YEAR_START; year <= YEAR_END; year++) {
        const option = document.createElement("option");
        option.value = String(year);
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        select.appendChild(option);
      }
    }

    function populateSubjectOptions() {
      const select = document.getElementById("subjectSelect");
      if (!select) return;
      select.innerHTML = '<option value="">Select subject...</option>' + SUBJECTS.map(subject => '<option value="' + subject + '">' + subject + "</option>").join("");
    }

    function initStages() {
      state.stages = defaultStages.map(stage => ({ ...stage }));
      renderStages();
    }
    function renderStages() {
      const container = document.getElementById("stagesContainer");
      if (!container) return;
      const rows = state.stages.map((stage, index) => `
        <div class="stage-row p-4 space-y-3" data-index="${index}">
          <div class="flex flex-col md:flex-row md:items-center gap-3">
            <div class="flex-1 flex flex-col gap-1">
              <label class="input-label">Stage</label>
              <input type="text" class="t-input bg-transparent border border-slate-600/30" data-index="${index}" data-field="title" value="${escapeHTML(stage.title)}" placeholder="Stage title">
            </div>
            <div class="flex items-end gap-2 md:w-32">
              <div class="flex flex-col flex-1 gap-1">
                <label class="input-label">Time (min)</label>
                <input type="number" min="0" class="t-input bg-transparent border border-slate-600/30" data-index="${index}" data-field="time" value="${Number(stage.time) || 0}">
              </div>
              ${state.stages.length > 1 ? `<button type="button" class="text-rose-300/80 hover:text-rose-200 transition" data-remove="${index}" title="Remove stage"><i class="fas fa-times-circle text-xl"></i></button>` : ""}
            </div>
          </div>
          <div class="grid gap-3 md:grid-cols-3">
            <div class="flex flex-col gap-2">
              <label class="input-label">Teaching activities</label>
              <textarea class="t-input bg-transparent border border-slate-600/30" data-index="${index}" data-field="teaching" placeholder="Instructional steps">${escapeHTML(stage.teaching)}</textarea>
            </div>
            <div class="flex flex-col gap-2">
              <label class="input-label">Learning activities</label>
              <textarea class="t-input bg-transparent border border-slate-600/30" data-index="${index}" data-field="learning" placeholder="Learner actions">${escapeHTML(stage.learning)}</textarea>
            </div>
            <div class="flex flex-col gap-2">
              <label class="input-label">Assessment</label>
              <textarea class="t-input bg-transparent border border-slate-600/30" data-index="${index}" data-field="assessment" placeholder="Checks for understanding">${escapeHTML(stage.assessment)}</textarea>
            </div>
          </div>
        </div>
      `);
      container.innerHTML = rows.join("");
      updateStageTotals();
    }

    function updateStageTotals() {
      const total = state.stages.reduce((sum, stage) => sum + (Number(stage.time) || 0), 0);
      const totalLabel = document.getElementById("stageMinutesTotal");
      if (totalLabel) {
        totalLabel.textContent = total;
      }
    }

    function attachEventHandlers() {
      const yearSelect = document.getElementById("yearSelect");
      if (yearSelect) {
        yearSelect.addEventListener("change", event => {
          const parsed = parseInt(event.target.value, 10);
          if (Number.isNaN(parsed)) return;
          currentYear = parsed;
          window.currentYear = currentYear;
          localStorage.setItem(PREFONE_YEAR_KEY, currentYear);
          loadStudents();
          loadLessonPlans();
        });
      }

      const refreshBtn = document.getElementById("refreshBtn");
      if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
          loadStudents();
          loadLessonPlans();
        });
      }

      const stagesContainer = document.getElementById("stagesContainer");
      if (stagesContainer) {
        stagesContainer.addEventListener("input", event => {
          const index = event.target.dataset.index;
          const field = event.target.dataset.field;
          if (typeof index === "undefined" || typeof field === "undefined") return;
          if (!state.stages[index]) return;
          if (field === "time") {
            state.stages[index][field] = parseInt(event.target.value, 10) || 0;
          } else {
            state.stages[index][field] = event.target.value;
          }
          updateStageTotals();
        });

        stagesContainer.addEventListener("click", event => {
          const removeBtn = event.target.closest("[data-remove]");
          if (!removeBtn) return;
          const index = parseInt(removeBtn.getAttribute("data-remove"), 10);
          if (Number.isNaN(index)) return;
          if (state.stages.length <= 1) return;
          state.stages.splice(index, 1);
          renderStages();
        });
      }

      const addStageBtn = document.getElementById("addStageBtn");
      if (addStageBtn) {
        addStageBtn.addEventListener("click", () => {
          state.stages.push({ title: "New Stage", time: 5, teaching: "", learning: "", assessment: "" });
          renderStages();
          const container = document.getElementById("stagesContainer");
          if (container) {
            container.scrollTo({ top: container.scrollHeight, behavior: "smooth" });
          }
        });
      }

      const form = document.getElementById("lessonForm");
      if (form) {
        form.addEventListener("submit", async event => {
          event.preventDefault();
          await saveLessonPlan();
        });
      }

      const resetBtn = document.getElementById("resetFormBtn");
      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          resetForm();
        });
      }

      const filterDate = document.getElementById("filterDate");
      if (filterDate) {
        filterDate.addEventListener("change", event => {
          state.filters.date = event.target.value;
          renderLessonPlans();
        });
      }

      const teacherFilter = document.getElementById("teacherFilter");
      if (teacherFilter) {
        teacherFilter.addEventListener("change", event => {
          state.filters.teacher = event.target.value;
          renderLessonPlans();
        });
      }

      const searchPlans = document.getElementById("searchPlans");
      if (searchPlans) {
        searchPlans.addEventListener("input", event => {
          state.filters.search = event.target.value.trim().toLowerCase();
          renderLessonPlans();
        });
      }

      const clearFiltersBtn = document.getElementById("clearFiltersBtn");
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener("click", () => {
          state.filters = { teacher: state.currentUser ? "mine" : "all", date: "", search: "" };
          if (filterDate) filterDate.value = "";
          if (teacherFilter) teacherFilter.value = state.filters.teacher;
          if (searchPlans) searchPlans.value = "";
          renderLessonPlans();
        });
      }

      const plansContainer = document.getElementById("plansContainer");
      if (plansContainer) {
        plansContainer.addEventListener("click", event => {
          const actionBtn = event.target.closest("[data-action]");
          if (!actionBtn) return;
          const action = actionBtn.dataset.action;
          const key = actionBtn.dataset.key;
          const plan = state.lessonPlans.find(item => item.key === key);
          if (!plan) return;
          if (action === "view") {
            openPlanModal(plan);
          } else if (action === "use") {
            prefillForm(plan);
          } else if (action === "download") {
            downloadPlan(plan);
          }
        });
      }

      const modal = document.getElementById("planModal");
      const closeModalBtn = document.getElementById("closePlanModal");
      if (closeModalBtn) {
        closeModalBtn.addEventListener("click", () => closePlanModal());
      }
      if (modal) {
        modal.addEventListener("click", event => {
          if (event.target === modal) {
            closePlanModal();
          }
        });
      }

      document.addEventListener("keydown", event => {
        if (event.key === "Escape") {
          closePlanModal();
        }
      });
    }

    function authenticateUser() {
      auth.onAuthStateChanged(user => {
        state.currentUser = user || null;
        setupTeacherFields();
        if (!user) {
          state.filters.teacher = "all";
          const teacherFilter = document.getElementById("teacherFilter");
          if (teacherFilter) teacherFilter.value = "all";
        } else if (state.filters.teacher === "all") {
          state.filters.teacher = "mine";
          const teacherFilter = document.getElementById("teacherFilter");
          if (teacherFilter) teacherFilter.value = "mine";
        }
        loadStudents();
        loadLessonPlans();
      });
    }

    async function loadStudents() {
      try {
        const snapshot = await db.ref(`/schools/Socrates School Preform one/${currentYear}/students`).once("value");
        const students = snapshot.val() || {};
        let male = 0;
        let female = 0;
        Object.values(students).forEach(student => {
          const gender = (student.gender || "").toString().toLowerCase();
          if (gender.startsWith("m")) male += 1;
          else if (gender.startsWith("f")) female += 1;
        });
        state.studentsMeta = { total: Object.keys(students).length, male, female };
        updateStudentMetaUI();
      } catch (error) {
        console.error("Failed to load students:", error);
      }
    }

    function updateStudentMetaUI() {
      const { total, male, female } = state.studentsMeta;
      const numStudents = document.getElementById("numStudents");
      const maleStudents = document.getElementById("maleStudents");
      const femaleStudents = document.getElementById("femaleStudents");
      if (numStudents) numStudents.value = total;
      if (maleStudents) maleStudents.value = male;
      if (femaleStudents) femaleStudents.value = female;

      const totalStat = document.getElementById("studentTotalStat");
      const breakdownStat = document.getElementById("studentBreakdownStat");
      if (totalStat) totalStat.textContent = total;
      if (breakdownStat) breakdownStat.textContent = `M:${male} ï¿½ F:${female}`;
    }
    function loadLessonPlans() {
      if (lessonPlansRef) {
        lessonPlansRef.off();
      }
      lessonPlansRef = db.ref(`/schools/Socrates School Preform one/${currentYear}/lessonplans`);
      lessonPlansRef.on("value", snapshot => {
        const plans = snapshot.val() || {};
        const processed = Object.entries(plans).map(([key, value]) => ({
          key,
          ...value
        })).sort((a, b) => {
          const aTime = a.updatedAt || a.createdAt || 0;
          const bTime = b.updatedAt || b.createdAt || 0;
          return bTime - aTime;
        });
        state.lessonPlans = processed;
        refreshTeacherFilterOptions();
        renderLessonPlans();
      }, error => {
        console.error("Failed to load lesson plans:", error);
      });
    }

    function refreshTeacherFilterOptions() {
      const select = document.getElementById("teacherFilter");
      if (!select) return;
      const previous = state.filters.teacher || select.value || "mine";
      const options = new Map();
      state.lessonPlans.forEach(plan => {
        const key = plan.teacherUid || plan.teacherEmail;
        if (!key) return;
        const label = plan.teacherName || plan.teacherEmail || "Teacher";
        options.set(key, label);
      });

      let html = '<option value="mine">My plans</option><option value="all">All teachers</option>';
      options.forEach((label, key) => {
        html += `<option value="${escapeHTML(key)}">${escapeHTML(label)}</option>`;
      });
      select.innerHTML = html;

      if (!state.currentUser) {
        state.filters.teacher = "all";
        select.value = "all";
      } else if (previous && (previous === "mine" || previous === "all" || options.has(previous))) {
        state.filters.teacher = previous;
        select.value = previous;
      } else {
        state.filters.teacher = "mine";
        select.value = "mine";
      }
    }

    function renderLessonPlans() {
      const container = document.getElementById("plansContainer");
      if (!container) return;
      const countLabel = document.getElementById("plansCountLabel");

      const filtered = state.lessonPlans.filter(plan => {
        if (state.filters.date && plan.date !== state.filters.date) return false;

        const search = state.filters.search;
        if (search) {
          const haystack = [
            plan.subject,
            plan.teacherName,
            plan.mainTopic,
            plan.subTopic,
            plan.generalObjective
          ].filter(Boolean).join(" ").toLowerCase();
          if (!haystack.includes(search)) return false;
        }

        if (state.filters.teacher === "all") return true;
        if (state.filters.teacher === "mine") return isMyPlan(plan);
        return plan.teacherUid === state.filters.teacher || plan.teacherEmail === state.filters.teacher;
      });

      if (countLabel) countLabel.textContent = filtered.length;

      if (!filtered.length) {
        container.innerHTML = '<div class="text-sm text-slate-300/80 text-center py-6">No lesson plans match the current filters.</div>';
      } else {
        container.innerHTML = filtered.map(plan => {
          const myPlan = isMyPlan(plan);
          const stageCount = Array.isArray(plan.stages) ? plan.stages.length : 0;
          const minutes = plan.stageMinutesTotal || (Array.isArray(plan.stages) ? plan.stages.reduce((sum, stage) => sum + (Number(stage.time) || 0), 0) : 0);
          return `
            <div class="board-card space-y-3">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-xs uppercase tracking-wider text-slate-300/70">${formatDate(plan.date)}</div>
                  <h4 class="text-lg font-semibold">${escapeHTML(plan.subject || "Lesson plan")}</h4>
                </div>
                <span class="chip">${escapeHTML(plan.className || "Preform One")}</span>
              </div>
              <div class="grid gap-2 text-sm text-slate-300/85">
                <div class="flex items-center gap-2">
                  <i class="fas fa-user text-slate-400"></i>
                  <span>${escapeHTML(plan.teacherName || plan.teacherEmail || "Unknown teacher")}</span>
                </div>
                <div class="flex items-center gap-2">
                  <i class="fas fa-layer-group text-slate-400"></i>
                  <span>${stageCount} stages ï¿½ ${minutes} minutes</span>
                </div>
                ${plan.mainTopic ? `<div class="flex items-center gap-2"><i class="fas fa-book-open text-slate-400"></i><span>${escapeHTML(plan.mainTopic)}</span></div>` : ""}
              </div>
              <div class="flex flex-wrap gap-2 pt-2">
                <button type="button" class="px-3 py-1.5 rounded-lg bg-sky-500/90 text-slate-900 text-sm font-semibold hover:bg-sky-400" data-action="view" data-key="${plan.key}">
                  View
                </button>
                <button type="button" class="px-3 py-1.5 rounded-lg bg-emerald-500/80 text-slate-900 text-sm font-semibold hover:bg-emerald-400" data-action="use" data-key="${plan.key}">
                  Use this plan
                </button>
                <button type="button" class="px-3 py-1.5 rounded-lg bg-slate-800/70 text-slate-100 text-sm hover:bg-slate-700" data-action="download" data-key="${plan.key}">
                  <i class="fas fa-file-download mr-1"></i> PDF
                </button>
                ${myPlan ? '<span class="chip bg-emerald-400/30 text-emerald-100 border border-emerald-300/30">Mine</span>' : ""}
              </div>
            </div>
          `;
        }).join("");
      }

      updatePlanStats();
    }

    function updatePlanStats() {
      const totalStat = document.getElementById("plansTotalStat");
      const monthStat = document.getElementById("plansMonthStat");
      const lastPlanStat = document.getElementById("lastPlanStat");
      const lastPlanTeacher = document.getElementById("lastPlanTeacher");

      if (totalStat) totalStat.textContent = state.lessonPlans.length;

      const now = new Date();
      const myPlansThisMonth = state.lessonPlans.filter(plan => isMyPlan(plan) && sameMonth(plan.date, now)).length;
      if (monthStat) monthStat.textContent = myPlansThisMonth;

      if (!state.lessonPlans.length) {
        if (lastPlanStat) lastPlanStat.textContent = "-";
        if (lastPlanTeacher) lastPlanTeacher.textContent = "Waiting for the first plan";
        return;
      }

      const latest = state.lessonPlans[0];
      if (lastPlanStat) lastPlanStat.textContent = formatDate(latest.date);
      if (lastPlanTeacher) {
        const teacherName = latest.teacherName || latest.teacherEmail || "Unknown teacher";
        lastPlanTeacher.textContent = `By ${teacherName}`;
      }
    }

    function sameMonth(dateString, referenceDate) {
      if (!dateString) return false;
      const parsed = stringToDate(dateString);
      if (!parsed) return false;
      return parsed.getFullYear() === referenceDate.getFullYear() && parsed.getMonth() === referenceDate.getMonth();
    }
    function setupTeacherFields() {
      const user = state.currentUser;
      const nameInput = document.getElementById("teacherName");
      const emailInput = document.getElementById("teacherEmail");
      if (!nameInput || !emailInput) return;

      if (user) {
        if (user.displayName && !nameInput.value) {
          nameInput.value = user.displayName;
        }
        if (!nameInput.value && user.email) {
          nameInput.value = user.email.split("@")[0].replace(/[._]/g, " ");
        }
        emailInput.value = user.email || "";
        emailInput.readOnly = true;
        emailInput.classList.add("border-slate-600/40");
      } else {
        emailInput.readOnly = false;
        if (!emailInput.value) {
          emailInput.placeholder = "name@school.ac.tz";
        }
      }
    }

    function isMyPlan(plan) {
      const user = state.currentUser;
      if (!user) return false;
      if (plan.teacherUid && plan.teacherUid === user.uid) return true;
      if (plan.teacherEmail && user.email && plan.teacherEmail.toLowerCase() === user.email.toLowerCase()) return true;
      return false;
    }

    async function saveLessonPlan() {
      const saveBtn = document.getElementById("savePlanBtn");
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";
      }
      try {
        const payload = buildPlanPayload();
        const validationError = validatePlanPayload(payload);
        if (validationError) {
          Swal.fire("Missing details", validationError, "warning");
          return;
        }
        const plansRef = db.ref(`/schools/Socrates School Preform one/${currentYear}/lessonplans`);
        await plansRef.push(payload);
        Swal.fire("Saved", "Lesson plan saved successfully.", "success");
        resetForm(true);
      } catch (error) {
        console.error("Failed to save lesson plan:", error);
        Swal.fire("Error", "Failed to save lesson plan: " + error.message, "error");
      } finally {
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = "Save lesson plan";
        }
      }
    }

    function buildPlanPayload() {
      const subject = (document.getElementById("subjectSelect")?.value || "").trim();
      const date = document.getElementById("planDate")?.value || "";
      const teacherName = (document.getElementById("teacherName")?.value || "").trim();
      const teacherEmail = (document.getElementById("teacherEmail")?.value || "").trim();
      const className = (document.getElementById("className")?.value || "Preform One").trim();
      const periodLabel = (document.getElementById("periodLabel")?.value || "").trim();
      const timeSlot = (document.getElementById("timeSlot")?.value || "").trim();
      const competences = (document.getElementById("competences")?.value || "").trim();
      const generalObjective = (document.getElementById("generalObjective")?.value || "").trim();
      const specificObjectives = (document.getElementById("specificObjectives")?.value || "").trim();
      const teachingAids = (document.getElementById("teachingAids")?.value || "").trim();
      const mainTopic = (document.getElementById("mainTopic")?.value || "").trim();
      const subTopic = (document.getElementById("subTopic")?.value || "").trim();
      const references = (document.getElementById("references")?.value || "").trim();
      const crossCutting = (document.getElementById("crossCutting")?.value || "").trim();
      const studentsEval = (document.getElementById("studentsEval")?.value || "").trim();
      const teachersEval = (document.getElementById("teachersEval")?.value || "").trim();
      const remarks = (document.getElementById("remarks")?.value || "").trim();

      const stages = state.stages.map(stage => ({
        title: (stage.title || "").trim(),
        time: Number(stage.time) || 0,
        teaching: (stage.teaching || "").trim(),
        learning: (stage.learning || "").trim(),
        assessment: (stage.assessment || "").trim()
      }));
      const stageMinutesTotal = stages.reduce((sum, stage) => sum + (Number(stage.time) || 0), 0);

      return {
        subject,
        date,
        className,
        teacherName,
        teacherEmail,
        teacherUid: state.currentUser?.uid || "",
        period: periodLabel,
        timeSlot,
        competences,
        generalObjective,
        specificObjectives,
        teachingAids,
        mainTopic,
        subTopic,
        references,
        crossCutting,
        studentsEval,
        teachersEval,
        remarks,
        numStudents: state.studentsMeta.total,
        maleCount: state.studentsMeta.male,
        femaleCount: state.studentsMeta.female,
        stageMinutesTotal,
        stages,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      };
    }
    function validatePlanPayload(payload) {
      const missing = [];
      if (!payload.subject) missing.push("subject");
      if (!payload.date) missing.push("date");
      if (!payload.teacherName) missing.push("teacher name");
      if (!payload.teacherEmail) missing.push("teacher email");
      if (!payload.generalObjective) missing.push("general objective");
      if (!payload.mainTopic) missing.push("main topic");

      if (missing.length) {
        return "Please fill the following fields: " + missing.join(", ") + ".";
      }

      const hasStageContent = payload.stages.some(stage =>
        stage.title || stage.teaching || stage.learning || stage.assessment
      );
      if (!hasStageContent) {
        return "Add at least one stage with activities or assessment.";
      }
      return "";
    }

    function resetForm(keepTeacher = false) {
      const form = document.getElementById("lessonForm");
      if (!form) return;
      form.reset();
      document.getElementById("className").value = "Preform One";
      document.getElementById("numStudents").value = state.studentsMeta.total;
      document.getElementById("maleStudents").value = state.studentsMeta.male;
      document.getElementById("femaleStudents").value = state.studentsMeta.female;
      initStages();
      if (keepTeacher) {
        setupTeacherFields();
      }
    }

    function prefillForm(plan) {
      if (!plan) return;
      const subjectSelect = document.getElementById("subjectSelect");
      if (subjectSelect) {
        if (!SUBJECTS.includes(plan.subject)) {
          const option = document.createElement("option");
          option.value = plan.subject;
          option.textContent = plan.subject;
          subjectSelect.appendChild(option);
        }
        subjectSelect.value = plan.subject || "";
      }
      const map = new Map([
        ["planDate", plan.date || ""],
        ["periodLabel", plan.period || ""],
        ["timeSlot", plan.timeSlot || ""],
        ["competences", plan.competences || ""],
        ["generalObjective", plan.generalObjective || ""],
        ["specificObjectives", plan.specificObjectives || ""],
        ["teachingAids", plan.teachingAids || ""],
        ["mainTopic", plan.mainTopic || ""],
        ["subTopic", plan.subTopic || ""],
        ["references", plan.references || ""],
        ["crossCutting", plan.crossCutting || ""],
        ["studentsEval", plan.studentsEval || ""],
        ["teachersEval", plan.teachersEval || ""],
        ["remarks", plan.remarks || ""]
      ]);
      map.forEach((value, id) => {
        const element = document.getElementById(id);
        if (element) element.value = value;
      });
      if (plan.teacherName) {
        const teacherNameInput = document.getElementById("teacherName");
        if (teacherNameInput && !teacherNameInput.value) {
          teacherNameInput.value = plan.teacherName;
        }
      }
      if (plan.teacherEmail) {
        const teacherEmailInput = document.getElementById("teacherEmail");
        if (teacherEmailInput && !teacherEmailInput.value) {
          teacherEmailInput.value = plan.teacherEmail;
        }
      }
      if (Array.isArray(plan.stages) && plan.stages.length) {
        state.stages = plan.stages.map(stage => ({
          title: stage.title || "",
          time: Number(stage.time) || 0,
          teaching: stage.teaching || "",
          learning: stage.learning || "",
          assessment: stage.assessment || ""
        }));
      } else {
        initStages();
      }
      renderStages();
      Swal.fire("Loaded", "Plan copied to the form for editing.", "info");
    }
    function openPlanModal(plan) {
      const modal = document.getElementById("planModal");
      const content = document.getElementById("planModalContent");
      if (!modal || !content) return;
      const stageRows = Array.isArray(plan.stages) ? plan.stages.map((stage, index) => `
        <tr class="border-b border-slate-700/40">
          <td class="py-2 px-3 align-top text-sm text-slate-200/90">${index + 1}. ${escapeHTML(stage.title || "Stage")}</td>
          <td class="py-2 px-3 align-top text-sm text-slate-200/70">${stage.time ? stage.time + " min" : "-"}</td>
          <td class="py-2 px-3 align-top text-sm text-slate-200/80">${escapeHTML(stage.teaching || "-")}</td>
          <td class="py-2 px-3 align-top text-sm text-slate-200/80">${escapeHTML(stage.learning || "-")}</td>
          <td class="py-2 px-3 align-top text-sm text-slate-200/80">${escapeHTML(stage.assessment || "-")}</td>
        </tr>
      `).join("") : "";

      content.innerHTML = `
        <div class="space-y-3">
          <div class="flex flex-wrap items-center gap-3">
            <span class="badge-soft">${escapeHTML(plan.className || "Preform One")}</span>
            <span class="chip">${formatDate(plan.date)}</span>
          </div>
          <h2 class="text-2xl font-semibold">${escapeHTML(plan.subject || "Lesson plan")}</h2>
          <p class="text-sm text-slate-300/85">By ${escapeHTML(plan.teacherName || plan.teacherEmail || "Unknown teacher")}</p>
        </div>
        <div class="grid gap-4 md:grid-cols-2 text-sm text-slate-200/90">
          <div><span class="input-label block mb-1">Period</span><p>${escapeHTML(plan.period || "-")}</p></div>
          <div><span class="input-label block mb-1">Time slot</span><p>${escapeHTML(plan.timeSlot || "-")}</p></div>
          <div><span class="input-label block mb-1">Competences</span><p>${escapeHTML(plan.competences || "-")}</p></div>
          <div><span class="input-label block mb-1">General objective</span><p>${escapeHTML(plan.generalObjective || "-")}</p></div>
        </div>
        <div class="grid gap-4 md:grid-cols-2 text-sm text-slate-200/90">
          <div><span class="input-label block mb-1">Specific objectives</span><p>${escapeHTML(plan.specificObjectives || "-")}</p></div>
          <div><span class="input-label block mb-1">Teaching aids</span><p>${escapeHTML(plan.teachingAids || "-")}</p></div>
        </div>
        <div class="grid gap-4 md:grid-cols-2 text-sm text-slate-200/90">
          <div><span class="input-label block mb-1">Main topic</span><p>${escapeHTML(plan.mainTopic || "-")}</p></div>
          <div><span class="input-label block mb-1">Sub topic</span><p>${escapeHTML(plan.subTopic || "-")}</p></div>
        </div>
        <div>
          <span class="input-label block mb-2">Lesson stages</span>
          <div class="overflow-x-auto">
            <table class="min-w-full text-left text-sm">
              <thead class="text-xs uppercase tracking-wide text-slate-300/70">
                <tr>
                  <th class="py-2 px-3">Stage</th>
                  <th class="py-2 px-3">Time</th>
                  <th class="py-2 px-3">Teaching</th>
                  <th class="py-2 px-3">Learning</th>
                  <th class="py-2 px-3">Assessment</th>
                </tr>
              </thead>
              <tbody>${stageRows}</tbody>
            </table>
          </div>
        </div>
        <div class="grid gap-4 md:grid-cols-2 text-sm text-slate-200/90">
          <div><span class="input-label block mb-1">References</span><p>${escapeHTML(plan.references || "-")}</p></div>
          <div><span class="input-label block mb-1">Cross-cutting issues</span><p>${escapeHTML(plan.crossCutting || "-")}</p></div>
        </div>
        <div class="grid gap-4 md:grid-cols-3 text-sm text-slate-200/90">
          <div><span class="input-label block mb-1">Learner evaluation</span><p>${escapeHTML(plan.studentsEval || "-")}</p></div>
          <div><span class="input-label block mb-1">Teacher reflection</span><p>${escapeHTML(plan.teachersEval || "-")}</p></div>
          <div><span class="input-label block mb-1">Remarks</span><p>${escapeHTML(plan.remarks || "-")}</p></div>
        </div>
      `;
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    function closePlanModal() {
      const modal = document.getElementById("planModal");
      if (!modal) return;
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    function downloadPlan(plan) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
        doc.setFontSize(15);
        doc.text("Preform One Lesson Plan", 14, 18);
        doc.setFontSize(11);
        const details = [
          "Date: " + formatDate(plan.date),
          "Subject: " + (plan.subject || "-"),
          "Teacher: " + (plan.teacherName || plan.teacherEmail || "-"),
          "Class: " + (plan.className || "Preform One"),
          "Period: " + (plan.period || "-") + " | Time: " + (plan.timeSlot || "-")
        ];
        let y = 28;
        details.forEach(line => {
          doc.text(line, 14, y);
          y += 6;
        });
        const block = [
          "Competences: " + (plan.competences || "-"),
          "General Objective: " + (plan.generalObjective || "-"),
          "Specific Objectives: " + (plan.specificObjectives || "-"),
          "Teaching Aids: " + (plan.teachingAids || "-"),
          "Main Topic: " + (plan.mainTopic || "-"),
          "Sub Topic: " + (plan.subTopic || "-")
        ];
        block.forEach(line => {
          doc.text(line, 14, y);
          y += 6;
        });
        doc.autoTable({
          startY: y + 2,
          head: [["Stage", "Time", "Teaching Activities", "Learning Activities", "Assessment"]],
          body: (plan.stages || []).map(stage => [
            stage.title || "-",
            stage.time ? stage.time + " min" : "-",
            stage.teaching || "-",
            stage.learning || "-",
            stage.assessment || "-"
          ]),
          styles: { fontSize: 9, cellWidth: "wrap" },
          headStyles: { fillColor: [15, 23, 42] },
          theme: "grid"
        });
        let endY = doc.lastAutoTable.finalY || y + 10;
        const footer = [
          "References: " + (plan.references || "-"),
          "Cross-cutting issues: " + (plan.crossCutting || "-"),
          "Learner evaluation: " + (plan.studentsEval || "-"),
          "Teacher reflection: " + (plan.teachersEval || "-"),
          "Remarks: " + (plan.remarks || "-")
        ];
        footer.forEach(line => {
          doc.text(line, 14, endY + 6);
          endY += 6;
        });
        doc.save(`lesson_plan_${plan.date || "plan"}.pdf`);
      } catch (error) {
        console.error("Failed to generate PDF:", error);
        Swal.fire("Error", "Could not generate PDF: " + error.message, "error");
      }
    }

    function escapeHTML(value) {
      if (value === undefined || value === null) return "";
      return value.toString().replace(/[&<>"']/g, char => {
        const entities = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" };
        return entities[char] || char;
      });
    }

    function formatDate(dateString) {
      if (!dateString) return "-";
      const date = stringToDate(dateString);
      if (!date) return dateString;
      return date.toLocaleDateString("en-US", { weekday: "short", year: "numeric", month: "short", day: "numeric" });
    }

    function stringToDate(dateString) {
      if (!dateString) return null;
      const parts = dateString.split("-");
      if (parts.length !== 3) return new Date(dateString);
      const [year, month, day] = parts.map(part => parseInt(part, 10));
      if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) return new Date(dateString);
      return new Date(year, month - 1, day);
    }
  </script>
</body>
</html>
