<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SoMAp - Preform One Report Forms</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-8V8V6YibXrrl0tAonmPa/MHug116IhVQbKXtEOynpHdrU7xE5vVn1N3kXJX1+RdaqsjVem0NsH3X3Sxbi3+zYg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="prefonecommon.js"></script>
  <style>
    :root {
      color-scheme: only dark;
    }
    body {
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at top left, rgba(99,102,241,0.20), transparent 46%),
        radial-gradient(circle at bottom right, rgba(56,189,248,0.18), transparent 48%),
        linear-gradient(135deg, #0f172a, #1d4ed8 68%, #0f172a);
      color: #e2e8f0;
      padding-bottom: 4rem;
    }
    .glass {
      background: rgba(15,23,42,0.78);
      border-radius: 20px;
      border: 1px solid rgba(148,163,184,0.20);
      box-shadow: 0 22px 45px rgba(15,23,42,0.45);
      backdrop-filter: blur(24px);
    }
    .metric {
      background: rgba(15,23,42,0.62);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.16);
      padding: 1.2rem 1.4rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .metric .label {
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(148,163,184,0.74);
    }
    .metric-value {
      font-size: 1.9rem;
      font-weight: 700;
      color: #bae6fd;
    }
    .metric-sub {
      font-size: 0.75rem;
      color: rgba(203,213,225,0.78);
    }
    .t-field {
      background: rgba(255,255,255,0.08);
      border: 1px solid transparent;
      border-radius: 0.75rem;
      color: #f8fafc;
      padding: 0.65rem 0.9rem;
      transition: all 0.18s ease;
      width: 100%;
    }
    .t-field:focus {
      border-color: rgba(59,130,246,0.80);
      outline: none;
      background: rgba(15,23,42,0.66);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.22);
    }
    .btn-primary {
      background: linear-gradient(120deg, #38bdf8, #6366f1);
      color: #0f172a;
      padding: 0.55rem 0.95rem;
      border-radius: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.18s, box-shadow 0.18s;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 32px rgba(15,23,42,0.35);
    }
    .btn-outline {
      background: rgba(15,23,42,0.55);
      color: #e2e8f0;
      border: 1px solid rgba(148,163,184,0.32);
      padding: 0.5rem 0.95rem;
      border-radius: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    .report-card {
      background: linear-gradient(160deg, #ffffff, #f8fafc 55%, #e2e8f0 100%);
      color: #0f172a;
      border-radius: 18px;
      box-shadow: 0 32px 60px rgba(15,23,42,0.20);
      overflow: hidden;
      position: relative;
    }
    .report-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(14,116,144,0.08), rgba(99,102,241,0.08));
      pointer-events: none;
    }
    .report-card-inner {
      position: relative;
      padding: 1.8rem;
      display: flex;
      flex-direction: column;
      gap: 1.4rem;
    }
    .info-chip {
      background: rgba(226,232,240,0.7);
      border-radius: 0.75rem;
      padding: 0.55rem 0.7rem;
      font-size: 0.85rem;
      line-height: 1.2rem;
      color: #0f172a;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
    }
    .info-chip span {
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #475569;
      margin-bottom: 0.2rem;
      font-weight: 600;
    }
    .preview-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .badge {
      background: rgba(96,165,250,0.18);
      color: #1d4ed8;
      border-radius: 999px;
      padding: 0.25rem 0.55rem;
      font-size: 0.72rem;
      letter-spacing: 0.02em;
    }
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }
    .preview-table thead {
      background: rgba(15,23,42,0.08);
    }
    .preview-table th,
    .preview-table td {
      padding: 0.45rem 0.35rem;
      border-bottom: 1px solid rgba(148,163,184,0.28);
      text-align: left;
    }
    .preview-table th {
      font-size: 0.73rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #475569;
    }
    .preview-table tbody tr:nth-child(even) {
      background: rgba(248,250,252,0.6);
    }
    .table-card {
      background: rgba(15,23,42,0.62);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.18);
      box-shadow: 0 16px 36px rgba(15,23,42,0.35);
      overflow: hidden;
    }
    .status-pill {
      border-radius: 999px;
      padding: 0.25rem 0.55rem;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .status-pill.good { background: rgba(16,185,129,0.20); color: #10b981; }
    .status-pill.medium { background: rgba(245,158,11,0.22); color: #fbbf24; }
    .status-pill.low { background: rgba(248,113,113,0.22); color: #f87171; }
    .report-photo {
      width: 120px;
      height: 150px;
      border-radius: 18px;
      object-fit: cover;
      box-shadow: 0 12px 26px rgba(15,23,42,0.32);
      border: 3px solid rgba(148,163,184,0.35);
      background: #cbd5f5;
    }
    .divider {
      height: 1px;
      background: rgba(148,163,184,0.32);
      margin: 0.6rem 0;
    }
    .chips-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.45rem;
    }
    .chip {
      background: rgba(148,163,184,0.22);
      border-radius: 0.6rem;
      padding: 0.32rem 0.45rem;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .chip i { color: #475569; }
    .table-action {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      padding: 0.32rem 0.55rem;
      border-radius: 0.55rem;
      font-size: 0.72rem;
      font-weight: 600;
    }
    .table-action.primary {
      background: rgba(56,189,248,0.18);
      color: #38bdf8;
    }
    .table-action.alt {
      background: rgba(244,114,182,0.18);
      color: #f472b6;
    }
    .table-row-active {
      background: rgba(56,189,248,0.12);
    }
    @media (max-width: 768px) {
      body { padding: 1.2rem 0.6rem 4rem; }
      .report-card-inner { padding: 1.25rem; }
      .report-card { margin: 0 auto; }
      .report-photo { margin-inline: auto; }
    }
  </style>
</head>
<body class="px-4 py-8 lg:py-14">
  <div class="max-w-7xl mx-auto space-y-8">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-3">
        <span class="inline-flex items-center gap-3 text-sm text-slate-200/80">
          <span class="uppercase tracking-widest px-3 py-1 rounded-full bg-violet-500/40 text-violet-100">Preform One</span>
          Academic report center
        </span>
        <h1 class="text-4xl font-semibold text-slate-50">Student report forms</h1>
        <p class="text-slate-200/80 max-w-2xl">
          Generate decorated single A4 report cards, download bulk ready-to-print forms, and export analytic summaries for every learner in Preform One.
        </p>
        <div class="flex flex-wrap gap-2 text-xs text-slate-300/70">
          <span class="inline-flex items-center gap-1"><i class="fas fa-file-pdf"></i> Single & bulk PDFs</span>
          <span class="inline-flex items-center gap-1"><i class="fas fa-school"></i> Socrates branding</span>
          <span class="inline-flex items-center gap-1"><i class="fas fa-chart-line"></i> Positions & grades</span>
        </div>
      </div>
      <div class="glass px-5 py-4 flex flex-col gap-3 min-w-[240px]">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-300/80">Academic year</p>
            <p class="text-lg font-semibold" id="previewYear">2025</p>
          </div>
          <img src="../images/somap-logo.png.jpg" alt="Socrates School" class="w-12 h-12 rounded-xl object-cover shadow-lg border border-slate-500/40" />
        </div>
        <div class="flex items-center gap-2">
          <select id="yearSelect" class="t-field bg-slate-900/40 border-slate-600/50"></select>
          <button id="refreshBtn" class="btn-outline" title="Reload year data"><i class="fas fa-rotate"></i></button>
        </div>
      </div>
    </div>

    <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <div class="metric">
        <span class="label">Total learners</span>
        <span class="metric-value" id="metricStudents">0</span>
        <span class="metric-sub" id="metricGender">M:0 / F:0</span>
      </div>
      <div class="metric">
        <span class="label">Average score</span>
        <span class="metric-value" id="metricAverage">0%</span>
        <span class="metric-sub">Selected exam and month</span>
      </div>
      <div class="metric">
        <span class="label">Fee balance</span>
        <span class="metric-value" id="metricBalance">TSh 0</span>
        <span class="metric-sub">Outstanding total</span>
      </div>
      <div class="metric">
        <span class="label">Attendance rate</span>
        <span class="metric-value" id="metricAttendance">0%</span>
        <span class="metric-sub">Month attendance</span>
      </div>
    </div>

    <div class="glass p-6 space-y-5">
      <div class="grid gap-4 md:grid-cols-3 xl:grid-cols-6">
        <div class="flex flex-col gap-2">
          <label class="text-xs uppercase tracking-wide text-slate-300/80">Exam type</label>
          <select id="examType" class="t-field bg-slate-900/40 border-slate-700/40">
            <option value="Monthly">Monthly</option>
            <option value="Midterm">Midterm</option>
            <option value="End Term">End Term</option>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-xs uppercase tracking-wide text-slate-300/80">Month</label>
          <select id="monthSelect" class="t-field bg-slate-900/40 border-slate-700/40">
            <option value="Sep">September</option>
            <option value="Oct">October</option>
            <option value="Nov">November</option>
            <option value="Dec">December</option>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-xs uppercase tracking-wide text-slate-300/80">Search student</label>
          <input id="searchInput" type="search" class="t-field" placeholder="Adm no, name, phone" />
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-xs uppercase tracking-wide text-slate-300/80">Sort by</label>
          <select id="sortSelect" class="t-field bg-slate-900/40 border-slate-700/40">
            <option value="name">Name (A-Z)</option>
            <option value="score">Score (High-Low)</option>
            <option value="balance">Balance (High-Low)</option>
            <option value="position">Overall position</option>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-xs uppercase tracking-wide text-slate-300/80">Selected student</label>
          <select id="studentSelect" class="t-field bg-slate-900/40 border-slate-700/40"></select>
        </div>
        <div class="flex flex-col gap-3 md:justify-end">
          <button id="applyFilters" class="btn-primary justify-center"><i class="fas fa-sliders"></i> Apply filters</button>
        </div>
      </div>
      <div class="flex flex-wrap gap-3">
        <button id="downloadPreviewPdf" class="btn-primary"><i class="fas fa-file-pdf"></i> Download selected PDF</button>
        <button id="downloadBulkCards" class="btn-outline"><i class="fas fa-clone"></i> Bulk report PDFs</button>
        <button id="downloadSummaryPdf" class="btn-outline"><i class="fas fa-table"></i> Summary PDF</button>
        <button id="downloadBulkCsv" class="btn-outline"><i class="fas fa-file-csv"></i> Export CSV</button>
        <button id="printPreview" class="btn-outline"><i class="fas fa-print"></i> Print preview</button>
      </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-5">
      <div class="report-card lg:col-span-3">
        <div class="report-card-inner" id="reportCardPreview">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-4">
              <img id="previewLogo" src="../images/somap-logo.png.jpg" alt="Socrates School" class="w-14 h-14 rounded-xl object-cover border border-slate-300/60 shadow" />
              <div>
                <p class="text-xs uppercase tracking-[0.16em] font-semibold text-slate-500">Socrates School Tanzania</p>
                <h2 class="text-xl font-bold text-slate-900">Preform One Academic Report</h2>
                <div class="preview-badges">
                  <span class="badge" id="previewExam">Monthly</span>
                  <span class="badge" id="previewMonth">September</span>
                  <span class="badge" id="previewAdm">ADM -</span>
                </div>
              </div>
            </div>
            <img id="previewPhoto" src="https://via.placeholder.com/140x180.png?text=Photo" alt="Student" class="report-photo" />
          </div>
          <div class="divider"></div>
          <div class="grid gap-4 md:grid-cols-3">
            <div>
              <p class="text-xs uppercase tracking-wide text-slate-500">Student</p>
              <p class="text-lg font-semibold text-slate-900" id="previewStudentName">Select a student</p>
              <p class="text-sm text-slate-500" id="previewGender">Gender</p>
            </div>
            <div class="info-chip">
              <span>Date of birth</span>
              <strong id="previewDob">-</strong>
              <span class="mt-1">Reporting</span>
              <strong id="previewReporting">-</strong>
            </div>
            <div class="info-chip">
              <span>Parent contact</span>
              <strong id="previewParent">-</strong>
              <span class="mt-1">Phone</span>
              <strong id="previewPhone">-</strong>
            </div>
          </div>
          <div class="grid gap-3 md:grid-cols-3">
            <div class="info-chip">
              <span>Overall average</span>
              <strong id="previewAverage">0%</strong>
              <span class="mt-1">Grade</span>
              <strong id="previewGrade">-</strong>
            </div>
            <div class="info-chip">
              <span>Overall position</span>
              <strong id="previewPosition">-</strong>
              <span class="mt-1">Class size</span>
              <strong id="previewClassSize">-</strong>
            </div>
            <div class="info-chip">
              <span>Attendance</span>
              <strong id="previewAttendance">0%</strong>
              <span class="mt-1">Present / Absent</span>
              <strong id="previewAttendanceRaw">0 / 0</strong>
            </div>
          </div>
          <div class="info-chip">
            <span>Fee summary</span>
            <strong id="previewFee">Total: TSh 0</strong>
            <span class="mt-1">Paid / Balance</span>
            <strong id="previewFeeBreakdown">TSh 0 / TSh 0</strong>
          </div>
          <div class="chips-grid" id="previewHighlights"></div>
          <div class="overflow-x-auto">
            <table class="preview-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Subject</th>
                  <th>Score</th>
                  <th>Max</th>
                  <th>%</th>
                  <th>Pos</th>
                  <th>Teacher</th>
                </tr>
              </thead>
              <tbody id="previewSubjects"></tbody>
            </table>
          </div>
          <div class="info-chip">
            <span>Teacher remarks</span>
            <p id="previewComment" class="text-sm font-medium text-slate-700 leading-relaxed">Select a student to view comments and printable card.</p>
          </div>
          <div class="chips-grid">
            <div class="chip"><i class="fas fa-pen"></i> Class teacher signature __________________</div>
            <div class="chip"><i class="fas fa-user"></i> Head of school signature __________________</div>
          </div>
        </div>
      </div>
      <div class="glass p-5 space-y-4 lg:col-span-2">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-300/70">Quick actions</p>
            <h3 class="text-xl font-semibold">Single report workspace</h3>
          </div>
          <span class="status-pill good" id="previewStatus">Ready</span>
        </div>
        <div class="grid gap-3">
          <button id="copyParentContact" class="btn-outline justify-center"><i class="fas fa-phone"></i> Copy parent contact</button>
          <button id="viewStudentInScoresheet" class="btn-outline justify-center"><i class="fas fa-table"></i> Open in scoresheet</button>
        </div>
        <div class="divider"></div>
        <div class="space-y-2">
          <p class="text-xs uppercase tracking-wide text-slate-400">Highlights</p>
          <ul class="text-sm space-y-1" id="previewSummaryList">
            <li>No student selected.</li>
          </ul>
        </div>
        <div class="divider"></div>
        <div class="space-y-2">
          <p class="text-xs uppercase tracking-wide text-slate-400">Bulk queue</p>
          <p class="text-sm text-slate-300/80">Filtered learners: <span id="bulkCount">0</span></p>
          <p class="text-xs text-slate-400">Use the bulk button above to generate A4 cards for every filtered learner.</p>
        </div>
      </div>
    </div>

    <div class="table-card">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-slate-200">
          <thead class="bg-slate-900/60 text-xs uppercase tracking-wide text-slate-300">
            <tr>
              <th class="px-4 py-3 text-left">Pos</th>
              <th class="px-4 py-3 text-left">Adm</th>
              <th class="px-4 py-3 text-left">Student</th>
              <th class="px-4 py-3 text-left">Avg %</th>
              <th class="px-4 py-3 text-left">Grade</th>
              <th class="px-4 py-3 text-left">Fee</th>
              <th class="px-4 py-3 text-left">Attendance</th>
              <th class="px-4 py-3 text-left">Comment</th>
              <th class="px-4 py-3 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="reportTable" class="divide-y divide-slate-800/60 bg-slate-900/40"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    const PREFONE_YEAR_KEY = 'prefone_year';
    const YEAR_START = 2024;
    const YEAR_END = 2030;
    const DEFAULT_YEAR = 2025;
    const MONTH_LABELS = { Sep: 'September', Oct: 'October', Nov: 'November', Dec: 'December' };
    const SUBJECTS = Array.isArray(window.subjects) && window.subjects.length
      ? [...window.subjects]
      : ['Physics','Chemistry','Biology','Historia ya Tanzania','French','Geography','Basic Mathematics','English Course','English Language','Computer Course','Business Studies'];
    if (!window.subjects || !window.subjects.length) {
      window.subjects = SUBJECTS;
    }

    const LOGO_PATH = '../images/somap-logo.png.jpg';
    const PLACEHOLDER_PHOTO = 'https://via.placeholder.com/160x210.png?text=Passport';

    const state = {
      currentYear: resolveYear(),
      examType: 'Monthly',
      month: 'Sep',
      rawStudents: {},
      students: [],
      filtered: [],
      selectedAdm: null,
      teachers: new Map(),
      logoDataUrl: null
    };

    document.addEventListener('DOMContentLoaded', () => {
      populateYearOptions();
      attachListeners();
      preloadLogo();
      loadTeachers().then(loadStudents);
      updatePreview();
    });

    function resolveYear() {
      const stored = parseInt(localStorage.getItem(PREFONE_YEAR_KEY), 10);
      if (!Number.isNaN(stored) && stored >= YEAR_START && stored <= YEAR_END) return stored;
      if (typeof window.currentYear === 'number' && window.currentYear >= YEAR_START && window.currentYear <= YEAR_END) return window.currentYear;
      return DEFAULT_YEAR;
    }

    function populateYearOptions() {
      const select = document.getElementById('yearSelect');
      if (!select) return;
      select.innerHTML = '';
      for (let year = YEAR_START; year <= YEAR_END; year++) {
        const opt = document.createElement('option');
        opt.value = String(year);
        opt.textContent = year;
        if (year === state.currentYear) opt.selected = true;
        select.appendChild(opt);
      }
      document.getElementById('previewYear').textContent = state.currentYear;
    }

    function attachListeners() {
      document.getElementById('yearSelect').addEventListener('change', e => {
        state.currentYear = parseInt(e.target.value, 10);
        localStorage.setItem(PREFONE_YEAR_KEY, state.currentYear);
        document.getElementById('previewYear').textContent = state.currentYear;
        loadStudents();
      });
      document.getElementById('examType').addEventListener('change', e => {
        state.examType = e.target.value;
        recomputeStudents();
        applyFilters();
      });
      document.getElementById('monthSelect').addEventListener('change', e => {
        state.month = e.target.value;
        recomputeStudents();
        applyFilters();
      });
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('sortSelect').addEventListener('change', applyFilters);
      document.getElementById('studentSelect').addEventListener('change', e => {
        if (e.target.value) setSelectedStudent(e.target.value);
      });
      document.getElementById('applyFilters').addEventListener('click', applyFilters);
      document.getElementById('downloadPreviewPdf').addEventListener('click', () => {
        if (!state.selectedAdm) {
          Swal.fire('Select student', 'Please choose a student before downloading a report.', 'info');
          return;
        }
        generateSinglePdf(state.selectedAdm);
      });
      document.getElementById('downloadBulkCards').addEventListener('click', downloadBulkReportCards);
      document.getElementById('downloadBulkCsv').addEventListener('click', downloadBulkCsv);
      document.getElementById('downloadSummaryPdf').addEventListener('click', downloadSummaryPdf);
      document.getElementById('refreshBtn').addEventListener('click', loadStudents);
      document.getElementById('printPreview').addEventListener('click', () => window.print());
      document.getElementById('copyParentContact').addEventListener('click', copyParentContact);
      document.getElementById('viewStudentInScoresheet').addEventListener('click', () => {
        if (!state.selectedAdm) {
          Swal.fire('Select student', 'Pick a student to open the scoresheet.', 'info');
          return;
        }
        window.location.href = 'prefonescoresheet.html';
      });
    }

    async function preloadLogo() {
      state.logoDataUrl = await loadImageAsDataURL(LOGO_PATH);
      if (!state.logoDataUrl) {
        state.logoDataUrl = await loadImageAsDataURL('../images/somap-logo.png');
      }
      if (state.logoDataUrl) {
        const img = document.getElementById('previewLogo');
        if (img) img.src = state.logoDataUrl;
      }
    }

    async function loadTeachers() {
      try {
        const snap = await db.ref('/schools/Socrates School Preform one/teachers').once('value');
        const teachers = snap.val() || {};
        state.teachers = new Map();
        Object.entries(teachers).forEach(([id, value]) => {
          const subject = (value.subject || '').trim().toUpperCase();
          state.teachers.set(subject, {
            id,
            name: (value.name || id || '').toString().trim() || 'Teacher'
          });
        });
      } catch (error) {
        console.error('Failed to load teachers', error);
      }
    }

    async function loadStudents() {
      try {
        document.getElementById('bulkCount').textContent = '...';
        const snapshot = await db.ref(`/schools/Socrates School Preform one/${state.currentYear}/students`).once('value');
        state.rawStudents = snapshot.val() || {};
        recomputeStudents();
        applyFilters();
      } catch (error) {
        console.error('Failed to load students:', error);
        Swal.fire('Error', 'Failed to load students. Check your internet connection.', 'error');
      }
    }

    function recomputeStudents() {
      const entries = Object.entries(state.rawStudents || {});
      state.students = entries.map(([adm, data]) => composeStudentRecord(adm, data));
      assignPositions(state.students);
    }

    function composeStudentRecord(adm, data) {
      const payments = Object.values(data?.payments || {});
      const paid = payments.reduce((sum, payment) => sum + Number(payment.amount || 0), 0);
      const balance = Number(data.totalFee || 0) - paid;
      const attendance = Object.values(data?.attendance || {});
      const monthAttendance = attendance.filter(entry => isMonthMatch(entry.date, state.month));
      const presents = monthAttendance.filter(entry => entry.present).length;
      const absents = monthAttendance.length - presents;
      const attendancePercent = monthAttendance.length ? (presents / monthAttendance.length) * 100 : 0;
      const scoreEntry = findScoreEntry(data?.scores || [], state.examType, state.month);
      const subjectStats = buildSubjectStats(scoreEntry);
      const totalScore = subjectStats.totalScore;
      const totalMax = subjectStats.totalMax;
      const avg = totalMax ? (totalScore / totalMax) * 100 : 0;
      const grade = deriveGrade(avg);
      const comment = (scoreEntry && scoreEntry.comment) || autoComment(avg);
      const teacherComment = data.comment || comment;
      return {
        adm,
        firstName: data.firstName || '',
        middleName: data.middleName || '',
        lastName: data.lastName || '',
        gender: data.gender || '',
        dob: data.dob || '-',
        parentName: data.parentName || '-',
        parentContact: data.parentContact || data.parentPhone || '-',
        totalFee: Number(data.totalFee || 0),
        paid,
        balance,
        reportingDate: data.reportingDate || '-',
        photoUrl: data.photoUrl || '',
        subjectStats,
        totalScore,
        totalMax,
        avg,
        grade,
        comment: teacherComment,
        autoComment: comment,
        attendancePercent,
        presents,
        absents,
        attendanceDays: monthAttendance.length,
        scoreEntry,
        subjectPositions: {},
        overallPosition: 0,
        monthLabel: MONTH_LABELS[state.month] || state.month,
        examLabel: state.examType
      };
    }

    function isMonthMatch(date, shortMonth) {
      if (!date) return false;
      const months = { Sep: 8, Oct: 9, Nov: 10, Dec: 11 };
      const target = months[shortMonth];
      if (target === undefined) return false;
      const parsed = new Date(date);
      if (Number.isNaN(parsed.getTime())) return false;
      return parsed.getMonth() === target;
    }

    function findScoreEntry(entries, examType, month) {
      let collection = entries;
      if (entries && !Array.isArray(entries) && typeof entries === 'object') {
        collection = Object.values(entries);
      }
      if (!Array.isArray(collection)) return null;
      return collection.find(entry => entry?.examType === examType && entry?.month === month) || null;
    }

    function buildSubjectStats(scoreEntry) {
      const stats = { totalScore: 0, totalMax: 0, subjects: [], subjectMap: {} };
      SUBJECTS.forEach(subject => {
        const subEntry = scoreEntry?.subjects?.[subject] || {};
        const score = Number(subEntry.score || 0);
        const max = Number(subEntry.max || 0) || 100;
        const percent = max ? (score / max) * 100 : 0;
        const record = { subject, score, max, percent };
        stats.subjects.push(record);
        stats.subjectMap[subject] = record;
        stats.totalScore += score;
        stats.totalMax += max;
      });
      return stats;
    }

    function deriveGrade(avg) {
      if (avg >= 80) return 'A';
      if (avg >= 65) return 'B';
      if (avg >= 50) return 'C';
      if (avg >= 35) return 'D';
      return 'F';
    }

    function autoComment(avg) {
      if (avg >= 85) return 'Excellent progress. Keep pushing ahead with enrichment tasks.';
      if (avg >= 70) return 'Strong performance. Maintain steady revision and teamwork.';
      if (avg >= 55) return 'Good effort. Target core practice for the next milestone.';
      if (avg >= 40) return 'Showing potential. Add guided revision and parental follow up.';
      return 'Immediate academic support required. Schedule remedial sessions.';
    }

    function assignPositions(students) {
      const avgSorted = [...students].sort((a, b) => b.avg - a.avg);
      let lastScore = null;
      let lastPos = 0;
      avgSorted.forEach((student, idx) => {
        const rounded = Number(student.avg.toFixed(2));
        if (rounded === lastScore) {
          student.overallPosition = lastPos;
        } else {
          student.overallPosition = idx + 1;
          lastScore = rounded;
          lastPos = student.overallPosition;
        }
      });

      SUBJECTS.forEach(subject => {
        const subjectSorted = [...students].sort((a, b) => {
          const aScore = a.subjectStats.subjectMap[subject]?.score || 0;
          const bScore = b.subjectStats.subjectMap[subject]?.score || 0;
          return bScore - aScore;
        });
        let prev = null;
        let prevPos = 0;
        subjectSorted.forEach((student, idx) => {
          const val = Number(student.subjectStats.subjectMap[subject]?.score || 0);
          if (prev !== null && val === prev) {
            student.subjectPositions[subject] = prevPos;
          } else {
            student.subjectPositions[subject] = idx + 1;
            prevPos = student.subjectPositions[subject];
            prev = val;
          }
          student.subjectStats.subjectMap[subject].position = student.subjectPositions[subject];
          student.subjectStats.subjectMap[subject].teacher = getTeacherName(subject);
        });
      });

      students.forEach(student => {
        student.subjectStats.subjects = SUBJECTS.map(subject => {
          const record = student.subjectStats.subjectMap[subject];
          return {
            subject,
            score: record.score,
            max: record.max,
            percent: record.percent,
            position: record.position,
            teacher: record.teacher
          };
        });
      });
    }

    function getTeacherName(subject) {
      if (!subject) return 'Teacher';
      const entry = state.teachers.get(subject.trim().toUpperCase());
      return entry?.name || 'Teacher';
    }
    function applyFilters() {
      const search = document.getElementById('searchInput').value.trim().toLowerCase();
      const sortBy = document.getElementById('sortSelect').value;
      let filtered = state.students.filter(student => {
        const haystack = [
          student.adm,
          student.firstName,
          student.middleName,
          student.lastName,
          student.parentName,
          student.parentContact
        ].filter(Boolean).join(' ').toLowerCase();
        return haystack.includes(search);
      });

      filtered = sortStudents(filtered, sortBy);
      state.filtered = filtered;
      if (!state.selectedAdm || !filtered.some(student => student.adm === state.selectedAdm)) {
        state.selectedAdm = filtered.length ? filtered[0].adm : null;
      }
      renderStudentSelect();
      updateMetrics();
      renderTable();
      updatePreview();
    }

    function sortStudents(arr, sortBy) {
      const copy = [...arr];
      if (sortBy === 'score') {
        copy.sort((a, b) => b.avg - a.avg || a.adm.localeCompare(b.adm));
      } else if (sortBy === 'balance') {
        copy.sort((a, b) => (b.balance || 0) - (a.balance || 0));
      } else if (sortBy === 'position') {
        copy.sort((a, b) => a.overallPosition - b.overallPosition);
      } else {
        copy.sort((a, b) => {
          const aName = `${a.lastName || ''} ${a.firstName || ''}`.trim().toLowerCase();
          const bName = `${b.lastName || ''} ${b.firstName || ''}`.trim().toLowerCase();
          return aName.localeCompare(bName);
        });
      }
      return copy;
    }

    function renderStudentSelect() {
      const select = document.getElementById('studentSelect');
      select.innerHTML = '';
      if (!state.filtered.length) {
        const opt = document.createElement('option');
        opt.textContent = 'No records';
        opt.value = '';
        select.appendChild(opt);
        document.getElementById('bulkCount').textContent = 0;
        return;
      }
      state.filtered.forEach(student => {
        const opt = document.createElement('option');
        opt.value = student.adm;
        opt.textContent = `${student.adm} - ${student.firstName} ${student.lastName}`.trim();
        if (student.adm === state.selectedAdm) opt.selected = true;
        select.appendChild(opt);
      });
      document.getElementById('bulkCount').textContent = state.filtered.length;
    }

    function updateMetrics() {
      const total = state.filtered.length;
      const male = state.filtered.filter(s => (s.gender || '').toLowerCase().startsWith('m')).length;
      const female = state.filtered.filter(s => (s.gender || '').toLowerCase().startsWith('f')).length;
      const avg = total ? (state.filtered.reduce((sum, s) => sum + (s.avg || 0), 0) / total) : 0;
      const balance = state.filtered.reduce((sum, s) => sum + (s.balance || 0), 0);
      const attendance = total ? (state.filtered.reduce((sum, s) => sum + (s.attendancePercent || 0), 0) / total) : 0;
      document.getElementById('metricStudents').textContent = total;
      document.getElementById('metricGender').textContent = `M:${male} / F:${female}`;
      document.getElementById('metricAverage').textContent = `${avg.toFixed(1)}%`;
      document.getElementById('metricBalance').textContent = `TSh ${formatCurrency(balance)}`;
      document.getElementById('metricAttendance').textContent = `${attendance.toFixed(1)}%`;
    }

    function renderTable() {
      const table = document.getElementById('reportTable');
      if (!state.filtered.length) {
        table.innerHTML = `<tr><td colspan="9" class="px-4 py-6 text-center text-slate-400">No students found for the selected filters.</td></tr>`;
        return;
      }
      table.innerHTML = state.filtered.map(student => {
        const attendance = `${student.attendancePercent.toFixed(1)}% (${student.presents}/${student.absents + student.presents})`;
        const pillClass = student.avg >= 70 ? 'good' : student.avg >= 50 ? 'medium' : 'low';
        return `
          <tr class="${student.adm === state.selectedAdm ? 'table-row-active' : ''}">
            <td class="px-4 py-3">${student.overallPosition}</td>
            <td class="px-4 py-3 font-mono">${student.adm}</td>
            <td class="px-4 py-3">
              <div class="font-semibold text-slate-100">${escapeHtml(`${student.firstName || ''} ${student.lastName || ''}`.trim())}</div>
              <div class="text-xs text-slate-400">${escapeHtml(student.parentContact || '-')}</div>
            </td>
            <td class="px-4 py-3">${student.avg.toFixed(1)}%</td>
            <td class="px-4 py-3"><span class="status-pill ${pillClass}">Grade ${student.grade}</span></td>
            <td class="px-4 py-3">
              <div>TSh ${formatCurrency(student.paid)}</div>
              <div class="text-xs text-slate-400">Balance: TSh ${formatCurrency(student.balance)}</div>
            </td>
            <td class="px-4 py-3">${attendance}</td>
            <td class="px-4 py-3 text-xs">${escapeHtml(student.comment)}</td>
            <td class="px-4 py-3 text-right space-x-1">
              <button class="table-action primary" onclick="setSelectedStudent('${student.adm}')"><i class="fas fa-eye"></i> View</button>
              <button class="table-action alt" onclick="generateSinglePdf('${student.adm}')"><i class="fas fa-file-pdf"></i> PDF</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function setSelectedStudent(adm) {
      state.selectedAdm = adm;
      const select = document.getElementById('studentSelect');
      if (select && select.value !== adm) {
        select.value = adm;
      }
      updatePreview();
      renderTable();
    }

    function updatePreview() {
      const student = state.filtered.find(s => s.adm === state.selectedAdm);
      const cohortSize = state.students.length || state.filtered.length;
      if (!student) {
        document.getElementById('previewStudentName').textContent = 'Select a student';
        document.getElementById('previewGender').textContent = '';
        document.getElementById('previewAdm').textContent = 'ADM -';
        document.getElementById('previewExam').textContent = state.examType;
        document.getElementById('previewMonth').textContent = MONTH_LABELS[state.month] || state.month;
        document.getElementById('previewAverage').textContent = '0%';
        document.getElementById('previewGrade').textContent = '-';
        document.getElementById('previewPosition').textContent = '-';
        document.getElementById('previewClassSize').textContent = cohortSize;
        document.getElementById('previewAttendance').textContent = '0%';
        document.getElementById('previewAttendanceRaw').textContent = '0 / 0';
        document.getElementById('previewFee').textContent = 'Total: TSh 0';
        document.getElementById('previewFeeBreakdown').textContent = 'TSh 0 / TSh 0';
        document.getElementById('previewComment').textContent = 'Select a student to view comments and printable card.';
        document.getElementById('previewHighlights').innerHTML = '';
        document.getElementById('previewSummaryList').innerHTML = '<li>No student selected.</li>';
        document.getElementById('previewStatus').textContent = 'Waiting';
        document.getElementById('previewStatus').className = 'status-pill medium';
        document.getElementById('previewSubjects').innerHTML = '';
        document.getElementById('previewPhoto').src = PLACEHOLDER_PHOTO;
        return;
      }
      document.getElementById('previewStatus').textContent = 'Ready';
      document.getElementById('previewStatus').className = 'status-pill good';
      const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.replace(/\s+/g, ' ').trim();
      document.getElementById('previewStudentName').textContent = fullName || student.adm;
      document.getElementById('previewGender').textContent = student.gender || 'Gender';
      document.getElementById('previewAdm').textContent = `ADM ${student.adm}`;
      document.getElementById('previewExam').textContent = student.examLabel;
      document.getElementById('previewMonth').textContent = student.monthLabel;
      document.getElementById('previewDob').textContent = formatDate(student.dob);
      document.getElementById('previewReporting').textContent = formatDate(student.reportingDate);
      document.getElementById('previewParent').textContent = student.parentName || '-';
      document.getElementById('previewPhone').textContent = student.parentContact || '-';
      document.getElementById('previewAverage').textContent = `${student.avg.toFixed(1)}%`;
      document.getElementById('previewGrade').textContent = student.grade;
      document.getElementById('previewPosition').textContent = `#${student.overallPosition}`;
      document.getElementById('previewClassSize').textContent = cohortSize;
      document.getElementById('previewAttendance').textContent = `${student.attendancePercent.toFixed(1)}%`;
      document.getElementById('previewAttendanceRaw').textContent = `${student.presents} / ${student.attendanceDays}`;
      document.getElementById('previewFee').textContent = `Total: TSh ${formatCurrency(student.totalFee)}`;
      document.getElementById('previewFeeBreakdown').textContent = `TSh ${formatCurrency(student.paid)} / TSh ${formatCurrency(student.balance)}`;
      document.getElementById('previewComment').textContent = student.comment;
      const highlights = document.getElementById('previewHighlights');
      highlights.innerHTML = '';
      const highlightItems = [
        { icon: 'fa-trophy', label: `Class position ${student.overallPosition}` },
        { icon: 'fa-percent', label: `${student.avg.toFixed(1)}% overall` },
        { icon: 'fa-money-bill', label: `Balance TSh ${formatCurrency(student.balance)}` },
        { icon: 'fa-calendar-check', label: `${student.attendancePercent.toFixed(0)}% attendance` }
      ];
      highlightItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.innerHTML = `<i class="fas ${item.icon}"></i>${item.label}`;
        highlights.appendChild(div);
      });
      const summaryList = document.getElementById('previewSummaryList');
      summaryList.innerHTML = '';
      summaryList.innerHTML = `
        <li>Subjects recorded: ${SUBJECTS.length}</li>
        <li>Best subject: ${bestSubject(student)}</li>
        <li>Needs support: ${lowestSubject(student)}</li>
      `;
      document.getElementById('previewSubjects').innerHTML = student.subjectStats.subjects.map((entry, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td>${escapeHtml(entry.subject)}</td>
          <td>${formatNumber(entry.score)}</td>
          <td>${formatNumber(entry.max)}</td>
          <td>${entry.percent.toFixed(1)}%</td>
          <td>${entry.position || '-'}</td>
          <td>${escapeHtml(entry.teacher || 'Teacher')}</td>
        </tr>
      `).join('');
      const photo = student.photoUrl ? student.photoUrl : PLACEHOLDER_PHOTO;
      document.getElementById('previewPhoto').src = photo;
    }

    function bestSubject(student) {
      const subject = [...student.subjectStats.subjects].sort((a, b) => b.percent - a.percent)[0];
      return subject ? `${subject.subject} ${subject.percent.toFixed(0)}%` : '-';
    }

    function lowestSubject(student) {
      const subject = [...student.subjectStats.subjects].sort((a, b) => a.percent - b.percent)[0];
      return subject ? `${subject.subject} ${subject.percent.toFixed(0)}%` : '-';
    }

    function formatCurrency(value) {
      const number = Number(value || 0);
      return number.toLocaleString('en-US');
    }

    function formatNumber(value) {
      if (Number.isInteger(value)) return value;
      return Number(value || 0).toFixed(1);
    }

    function formatDate(input) {
      if (!input || input === '-') return '-';
      const date = new Date(input);
      if (Number.isNaN(date.getTime())) return input;
      return date.toLocaleDateString('en-GB');
    }

    function escapeHtml(str = '') {
      return str.replace(/[&<>\"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c] || c));
    }

    async function generateSinglePdf(adm) {
      const student = state.students.find(s => s.adm === adm);
      if (!student) {
        Swal.fire('Not found', 'Student could not be located.', 'info');
        return;
      }
      const doc = new window.jspdf.jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
      await drawReportCard(doc, student);
      doc.save(`prefone_report_${student.adm}_${state.month}_${state.examType}.pdf`);
    }

    async function downloadBulkReportCards() {
      if (!state.filtered.length) {
        Swal.fire('No students', 'Apply filters that return students before exporting.', 'info');
        return;
      }
      const doc = new window.jspdf.jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
      for (let i = 0; i < state.filtered.length; i++) {
        if (i > 0) doc.addPage();
        await drawReportCard(doc, state.filtered[i]);
      }
      doc.save(`prefone_bulk_report_cards_${state.currentYear}_${state.month}.pdf`);
    }

    async function drawReportCard(doc, student) {
      const margin = 14;
      const headerY = 14;
      const contentStartY = 48;
      doc.setFillColor(15, 23, 42);
      doc.rect(0, 0, 210, 32, 'F');
      if (state.logoDataUrl) {
        doc.addImage(state.logoDataUrl, 'PNG', margin, headerY - 2, 20, 20);
      }
      doc.setTextColor(226, 232, 240);
      doc.setFontSize(12);
      doc.text('Socrates School Tanzania', margin + 25, headerY + 2);
      doc.setFontSize(16);
      doc.text('Preform One Academic Report Card', margin + 25, headerY + 12);
      doc.setFontSize(10);
      doc.text(`Year ${state.currentYear}  |  Exam ${student.examLabel} (${student.monthLabel})`, margin + 25, headerY + 20);

      const photoData = student.photoUrl ? await loadImageAsDataURL(student.photoUrl) : null;
      if (photoData) {
        doc.addImage(photoData, 'JPEG', 160, headerY - 2, 30, 40);
      } else {
        doc.setDrawColor(148, 163, 184);
        doc.rect(160, headerY - 2, 30, 40);
        doc.text('Photo', 165, headerY + 18);
      }

      doc.setTextColor(15, 23, 42);
      doc.setFontSize(11);
      doc.text(`Student: ${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.replace(/\s+/g, ' ').trim(), margin, contentStartY);
      doc.text(`Admission: ${student.adm}`, margin, contentStartY + 6);
      doc.text(`Date of birth: ${formatDate(student.dob)}`, margin, contentStartY + 12);
      doc.text(`Reporting: ${formatDate(student.reportingDate)}`, margin, contentStartY + 18);
      doc.text(`Parent: ${student.parentName || '-'} (${student.parentContact || '-'})`, margin, contentStartY + 24);

      doc.text(`Average: ${student.avg.toFixed(1)}%`, 120, contentStartY);
      doc.text(`Grade: ${student.grade}`, 120, contentStartY + 6);
      const cohortSize = state.students.length || state.filtered.length || 0;
      doc.text(`Overall position: ${student.overallPosition} / ${cohortSize}`, 120, contentStartY + 12);
      doc.text(`Attendance: ${student.attendancePercent.toFixed(1)}% (${student.presents}/${student.attendanceDays})`, 120, contentStartY + 18);
      doc.text(`Fees: Due TSh ${formatCurrency(student.totalFee)} | Paid TSh ${formatCurrency(student.paid)} | Balance TSh ${formatCurrency(student.balance)}`, 120, contentStartY + 24);

      doc.autoTable({
        startY: contentStartY + 32,
        head: [["#","Subject","Score","Max","%","Pos","Teacher"]],
        body: student.subjectStats.subjects.map((entry, index) => [
          index + 1,
          entry.subject,
          formatNumber(entry.score),
          formatNumber(entry.max),
          entry.percent.toFixed(1),
          entry.position || '-',
          entry.teacher || 'Teacher'
        ]),
        styles: { fontSize: 9, textColor: [15, 23, 42] },
        headStyles: { fillColor: [30, 64, 175], textColor: 255, fontSize: 9 },
        alternateRowStyles: { fillColor: [241, 245, 249] },
        theme: 'grid',
        margin: { left: margin, right: margin }
      });
      const afterTable = doc.lastAutoTable.finalY + 6;
      doc.setFontSize(10);
      doc.text('Teacher comments:', margin, afterTable);
      doc.text(doc.splitTextToSize(student.comment || student.autoComment || '', 180), margin, afterTable + 6);
      doc.setDrawColor(148, 163, 184);
      doc.line(margin, afterTable + 30, 90, afterTable + 30);
      doc.text('Class teacher signature', margin, afterTable + 35);
      doc.line(120, afterTable + 30, 200, afterTable + 30);
      doc.text('Head of school signature', 120, afterTable + 35);
      return doc;
    }

    async function downloadSummaryPdf() {
      if (!state.filtered.length) {
        Swal.fire('No data', 'No students in the filtered list to export.', 'info');
        return;
      }
      const doc = new window.jspdf.jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      doc.setFontSize(13);
      doc.text('Preform One Report Summary', 14, 14);
      doc.setFontSize(9);
      doc.text(`Year ${state.currentYear} | Exam ${state.examType} (${MONTH_LABELS[state.month] || state.month})`, 14, 20);
      doc.autoTable({
        startY: 24,
        head: [["Pos","Adm","Student","Avg %","Grade","Paid","Balance","Attendance","Comment"]],
        body: state.filtered.map(student => [
          student.overallPosition,
          student.adm,
          `${student.firstName || ''} ${student.lastName || ''}`.trim(),
          student.avg.toFixed(1),
          student.grade,
          `TSh ${formatCurrency(student.paid)}`,
          `TSh ${formatCurrency(student.balance)}`,
          `${student.attendancePercent.toFixed(1)}%`,
          student.comment
        ]),
        styles: { fontSize: 8 },
        headStyles: { fillColor: [15, 23, 42], textColor: 255 },
        theme: 'grid'
      });
      doc.save(`prefone_summary_${state.currentYear}_${state.month}.pdf`);
    }

    function downloadBulkCsv() {
      if (!state.filtered.length) {
        Swal.fire('No data', 'No students in the filtered list to export.', 'info');
        return;
      }
      const csvRows = state.filtered.map(student => {
        const base = {
          Adm: student.adm,
          Student: `${student.firstName || ''} ${student.lastName || ''}`.trim(),
          Exam: student.examLabel,
          Month: student.monthLabel,
          AvgPercent: student.avg.toFixed(2),
          Grade: student.grade,
          FeeDue: student.totalFee,
          Paid: student.paid,
          Balance: student.balance,
          AttendancePercent: student.attendancePercent.toFixed(2),
          Presents: student.presents,
          Absents: student.absents,
          OverallPosition: student.overallPosition
        };
        SUBJECTS.forEach(subject => {
          const entry = student.subjectStats.subjectMap[subject];
          base[`${subject} Score`] = entry?.score || 0;
          base[`${subject} Max`] = entry?.max || 0;
          base[`${subject} %`] = entry ? Number(entry.percent.toFixed(2)) : 0;
          base[`${subject} Pos`] = student.subjectPositions[subject] || '';
        });
        base.Comment = student.comment;
        return base;
      });
      const csv = Papa.unparse(csvRows);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `prefone_report_${state.currentYear}_${state.month}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function copyParentContact() {
      const student = state.filtered.find(s => s.adm === state.selectedAdm);
      if (!student || !student.parentContact) {
        Swal.fire('No contact', 'The selected student does not have a parent contact recorded.', 'info');
        return;
      }
      navigator.clipboard.writeText(student.parentContact).then(() => {
        Swal.fire('Copied', 'Parent contact copied to clipboard.', 'success');
      }).catch(() => {
        Swal.fire('Failed', 'Could not copy parent contact.', 'error');
      });
    }

    async function loadImageAsDataURL(url) {
      if (!url) return null;
      try {
        const response = await fetch(url, { mode: 'cors' });
        if (!response.ok) return null;
        const blob = await response.blob();
        return await new Promise(resolve => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = () => resolve(null);
          reader.readAsDataURL(blob);
        });
      } catch (error) {
        console.warn('Unable to load image', url, error);
        return null;
      }
    }

    window.setSelectedStudent = setSelectedStudent;
    window.generateSinglePdf = generateSinglePdf;
  </script>
</body>
</html>