<!DOCTYPE html>
<html lang="en">
<head>
  <title>SoMAp â€” Preform One Scoresheet</title>
  <!-- Firebase Compat SDKs (v9.6.10 for consistency with repo) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  
  <!-- UI Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="prefonecommon.js"></script>
  
  <style>
    body { 
      background: linear-gradient(to right, #667eea, #764ba2); 
    }
    .card { border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); background: white; padding: 1.5rem; margin-bottom: 1.5rem; }
    .table { width: 100%; border-collapse: separate; border-spacing: 0; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.2); }
    .table th { background: rgba(255,255,255,0.1); font-weight: bold; }
    input[type="number"] { width: 60px; background: white; color: black; border-radius: 4px; padding: 2px; }
    .score-input { font-weight: bold; }
    .status-pill { padding: 0.25rem 0.5rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
    .grade-a { background: #dcfce7; color: #166534; }
    .grade-b { background: #fef9c3; color: #854d0e; }
    .grade-f { background: #fee2e2; color: #991b1b; }
    .avg-green { color: #10b981; }
    .avg-yellow { color: #f59e0b; }
    .avg-red { color: #ef4444; }
    .fade-in { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .attendance-card { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s; }
    .attendance-card:hover { transform: translateY(-5px); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-400 to-purple-600 text-white p-4">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold mb-6 text-center fade-in"><i class="fas fa-table mr-2"></i> Preform One Scoresheet</h1>
    <div class="flex justify-between mb-4">
      <a href="prefoneacademic.html" onclick="syncFiltersToAcademic()" class="bg-gray-500 hover:bg-gray-600 p-2 rounded text-white fade-in"><i class="fas fa-arrow-left mr-1"></i> Back to Academic</a>
      <button onclick="toggleFullscreen()" class="bg-gray-500 hover:bg-gray-600 p-2 rounded text-white fade-in"><i class="fas fa-expand mr-1"></i> Fullscreen</button>
    </div>
    
    <div class="flex gap-2 mb-4">
      <button onclick="saveScores()" class="bg-blue-500 hover:bg-blue-600 p-2 rounded text-white fade-in"><i class="fas fa-save mr-1"></i> Save All</button>
      <button onclick="exportCSV(allData, 'scores.csv')" class="bg-green-500 hover:bg-green-600 p-2 rounded text-white fade-in"><i class="fas fa-file-csv mr-1"></i> CSV</button>
      <button onclick="generateReportCards()" class="bg-purple-500 hover:bg-purple-600 p-2 rounded text-white fade-in"><i class="fas fa-file-pdf mr-1"></i> PDF Reports</button>
    </div>
    
    <!-- Filters (shared with academic via localStorage) -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 bg-white/10 p-4 rounded-lg shadow-md fade-in">
      <select id="examType" onchange="saveFiltersAndLoad()" class="p-2 rounded bg-white/20 text-white">
        <option value="Monthly">Monthly</option>
        <option value="Midterm">Midterm</option>
        <option value="End Term">End Term</option>
      </select>
      <select id="month" onchange="saveFiltersAndLoad()" class="p-2 rounded bg-white/20 text-white">
        <option value="Sep">Sep</option>
        <option value="Oct">Oct</option>
        <option value="Nov">Nov</option>
        <option value="Dec">Dec</option>
      </select>
      <select id="maxScore" onchange="loadScores()" class="p-2 rounded bg-white/20 text-white">
        <option value="50">Max 50</option>
        <option value="100">Max 100</option>
      </select>
      <select id="yearSelect" onchange="setYearAndLoad()" class="p-2 rounded bg-white/20 text-white">
        <!-- Populated dynamically -->
      </select>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading" class="text-center mb-4 fade-in"><i class="fas fa-spinner fa-spin mr-2"></i> Loading scoresheet...</div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="attendance-card fade-in">
        <h3 class="text-sm font-semibold mb-2"><i class="fas fa-users mr-1"></i> Total Students</h3>
        <p id="totalStudents" class="text-2xl font-bold">0</p>
      </div>
      <div class="attendance-card fade-in">
        <h3 class="text-sm font-semibold mb-2"><i class="fas fa-chart-line mr-1"></i> Class Avg</h3>
        <p id="classAvg" class="text-2xl font-bold">0%</p>
      </div>
      <div class="attendance-card fade-in">
        <h3 class="text-sm font-semibold mb-2"><i class="fas fa-trophy mr-1"></i> Top Grade</h3>
        <p id="topGrade" class="text-2xl font-bold">N/A</p>
      </div>
    </div>
    
    <div class="overflow-x-auto bg-white/10 rounded-lg shadow-md mb-8 fade-in">
      <table id="scoresTable" class="w-full text-sm table">
        <thead class="bg-white/20">
          <tr id="theadRow">
            <!-- Headers built dynamically in JS -->
          </tr>
        </thead>
        <tbody id="scoresBody" class="bg-white/5"></tbody>
      </table>
    </div>
    
    <p class="text-center mt-4 fade-in">Total Students: <span id="totalStudentsFooter">0</span> | Subjects: 10 | Class Avg: <span id="classAvgFooter">0</span>%</p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // Fallback for currentYear if common.js fails
    let currentYear = localStorage.getItem('prefone_year') || new Date().getFullYear();

    const subjects = ['Physics', 'Chemistry', 'Biology', 'Historia ya Tanzania', 'French', 'Geography', 'Basic Mathematics', 'English Course', 'English Language', 'Computer Course', 'Business Studies'];

    let allData = [], maxScore = 100;
    let editingData = {};

    function populateYears() {
      const select = document.getElementById('yearSelect');
      for (let y = 2024; y <= 2030; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        if (y == currentYear) opt.selected = true;
        select.appendChild(opt);
      }
      const savedYear = localStorage.getItem('prefone_year');
      if (savedYear) {
        select.value = savedYear;
        currentYear = parseInt(savedYear);
      }
    }

    function setYearAndLoad() {
      currentYear = parseInt(document.getElementById('yearSelect').value);
      localStorage.setItem('prefone_year', currentYear);
      loadScores();
    }

    function loadFilters() {
      const savedExamType = localStorage.getItem('prefone_examType') || 'Monthly';
      const savedMonth = localStorage.getItem('prefone_month') || 'Sep';
      document.getElementById('examType').value = savedExamType;
      document.getElementById('month').value = savedMonth;
    }

    function saveFilters() {
      localStorage.setItem('prefone_examType', document.getElementById('examType').value);
      localStorage.setItem('prefone_month', document.getElementById('month').value);
    }

    function saveFiltersAndLoad() {
      saveFilters();
      loadScores();
    }

    function syncFiltersToAcademic() {
      saveFilters();
      window.location.href = 'prefoneacademic.html';
    }

    function updateGlobalStats(allData) {
      const classAvg = allData.length > 0 ? allData.reduce((sum, row) => sum + row.avg, 0) / allData.length : 0;
      const topGrade = allData.length > 0 ? allData[0].grade : 'N/A';
      document.getElementById('totalStudents').textContent = allData.length;
      document.getElementById('classAvg').textContent = classAvg.toFixed(2) + '%';
      document.getElementById('topGrade').textContent = topGrade;
      document.getElementById('totalStudentsFooter').textContent = allData.length;
      document.getElementById('classAvgFooter').textContent = classAvg.toFixed(2) + '%';
    }

    function calculateSubjectPositions() {
      subjects.forEach(sub => {
        const sorted = [...allData].sort((a, b) => b.scoreData.subjects[sub].score - a.scoreData.subjects[sub].score);
        sorted.forEach((row, idx) => row.subjectPos[sub] = idx + 1);
      });
    }

    function loadScores() {
      document.getElementById('loading').style.display = 'block';
      maxScore = parseInt(document.getElementById('maxScore').value);
      const examType = document.getElementById('examType').value;
      const month = document.getElementById('month').value;
      const monthFull = { Sep: 'September', Oct: 'October', Nov: 'November', Dec: 'December' }[month] || month;
      saveFilters(); // Sync for academic

      db.ref(`/schools/Socrates School Preform one/${currentYear}/students`).once('value').then(snap => {
        try {
          const studentsObj = snap.val() || {};
          const students = Object.entries(studentsObj); // Match attendance
          let grandTotal = 0;
          allData = [];

          if (students.length === 0) {
            Swal.fire('No Students', 'No students found for the selected year. Check if students are added in the database for ' + currentYear + '.', 'info');
            updateGlobalStats([]);
            renderScoresTable();
            document.getElementById('loading').style.display = 'none';
            return;
          }

          allData = students.map(([adm, s]) => {
            try {
              const scoresArray = Object.values(s.scores || {});
              let scoreData = scoresArray.find(sc => sc.examType === examType && sc.month === month);
              if (!scoreData) {
                scoreData = { examType, month, subjects: {} };
                subjects.forEach(sub => scoreData.subjects[sub] = { score: 0, max: maxScore });
              } else {
                subjects.forEach(sub => { 
                  if (!scoreData.subjects[sub]) scoreData.subjects[sub] = { score: 0, max: maxScore }; 
                });
              }

              const total = Object.values(scoreData.subjects).reduce((sum, sub) => sum + sub.score, 0);
              const maxTotal = Object.values(scoreData.subjects).reduce((sum, sub) => sum + sub.max, 0);
              const avg = maxTotal > 0 ? (total / maxTotal * 100).toFixed(2) : 0;
              grandTotal += parseFloat(avg);

              const attRecords = Object.values(s.attendance || {});
              const monthAtt = attRecords.filter(a => {
                try {
                  return new Date(a.date).toLocaleString('en', { month: 'long' }) === monthFull;
                } catch {
                  return false;
                }
              });
              const pres = monthAtt.filter(a => a.present).length;
              const abs = monthAtt.length - pres;

              const paymentsArray = Object.values(s.payments || {});
              const paid = paymentsArray.reduce((sum, p) => sum + Number(p.amount || 0), 0);
              const bal = Number(s.totalFee || 0) - paid;

              const row = {
                adm, 
                name: `${s.firstName || ''} ${s.lastName || ''}`.trim(), 
                reportingDate: s.reportingDate || '', 
                due: Number(s.totalFee || 0), 
                paid, 
                bal, 
                scoreData, 
                total, 
                maxTotal, 
                avg: parseFloat(avg), 
                grade: avg >= 80 ? 'A' : avg >= 60 ? 'B' : 'F',
                pres, 
                abs,
                comment: s.comment || '',
                subjectPos: {}, // For per-subject positions
                photoUrl: s.photoUrl || ''
              };

              editingData[adm] = { ...row.scoreData.subjects };
              return row;
            } catch (loopErr) {
              console.error('Error processing student ' + adm + ':', loopErr);
              return null;
            }
          }).filter(row => row !== null).sort((a, b) => b.avg - a.avg).map((row, idx) => ({ ...row, pos: idx + 1 }));

          calculateSubjectPositions(); // Added for per-subject pos
          updateGlobalStats(allData);
          renderScoresTable();
        } catch (err) {
          console.error('Processing error:', err);
          Swal.fire('Error', 'Error processing data: ' + err.message, 'error');
        } finally {
          document.getElementById('loading').style.display = 'none';
        }
      }).catch(err => {
        console.error('Load error:', err);
        Swal.fire('Error', 'Failed to load scores: ' + err.message, 'error');
        document.getElementById('loading').style.display = 'none';
      });
    }

    function renderScoresTable() {
      const tbody = document.getElementById('scoresBody');
      if (allData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="20" class="text-center p-4 opacity-75">No students found. <a href="prefoneadmission.html" class="text-blue-300 underline">Register in Admissions</a>.</td></tr>';
        return;
      }
      tbody.innerHTML = allData.map(row => `
        <tr class="hover:bg-white/10">
          <td class="p-3">${row.pos}</td>
          <td class="p-3">${row.adm}</td>
          <td class="p-3">${row.name}${row.reportingDate ? `<br><small>${new Date(row.reportingDate).toLocaleDateString('en-GB')}</small>` : ''}</td>
          <td class="p-3">${row.due.toLocaleString()}/${row.paid.toLocaleString()}/${row.bal.toLocaleString()}</td>
          ${subjects.map(sub => `
            <td class="p-3">
              <input type="number" min="0" max="${maxScore}" value="${editingData[row.adm][sub].score || 0}" class="score-input" onchange="updateSubject('${row.adm}', '${sub}', this.value)">
              <br><small>/${editingData[row.adm][sub].max} (Pos: ${row.subjectPos[sub] || '-'})</small>
            </td>
          `).join('')}
          <td class="p-3 font-bold">${row.total}/${row.maxTotal}</td>
          <td class="p-3 font-bold ${row.avg >= 70 ? 'avg-green' : row.avg >= 50 ? 'avg-yellow' : 'avg-red'}">${row.avg}%</td>
          <td class="p-3">${row.pos}</td>
          <td class="p-3"><span class="status-pill ${row.grade === 'A' ? 'grade-a' : row.grade === 'B' ? 'grade-b' : 'grade-f'}">${row.grade}</span></td>
          <td class="p-3">${row.pres}/${row.abs}</td>
          <td class="p-3"><input type="text" value="${row.comment}" class="w-full p-1 bg-white/20 text-white rounded" onchange="updateComment('${row.adm}', this.value)"></td>
        </tr>
      `).join('');
    }

    document.getElementById('theadRow').innerHTML = `
      <th class="p-3">#</th>
      <th class="p-3">ADM</th>
      <th class="p-3">Student (Preform One)</th>
      <th class="p-3">Fee Due/Paid/Bal (TSh)</th>
      ${subjects.map(sub => `<th class="p-3">${sub}<br>(Score/Max/Pos)</th>`).join('')}
      <th class="p-3">Total/Max</th>
      <th class="p-3">% Avg</th>
      <th class="p-3">Pos</th>
      <th class="p-3">Grade</th>
      <th class="p-3">Pres/Abs (Month)</th>
      <th class="p-3">Comment</th>
    `;

    // Initial load (match attendance: populate, load filters, fetch)
    populateYears();
    loadFilters();
    loadScores();
  </script>
</body>
</html>