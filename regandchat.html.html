<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Student Management & Academic Prototype</title>
  <!-- Tailwind CDN for enhanced styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --blue: #0b69ff;
      --muted: #f5f7fa;
      --card: #ffffff;
      --muted-text: #6b7280;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, Arial, sans-serif;
      background: var(--muted);
      color: #0b2540;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: var(--blue);
      color: #fff;
      padding: 14px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header .title { font-weight: 700; }
    .wrap { max-width: 1200px; margin: 18px auto; padding: 12px; width: 95%; }
    .grid { display: grid; grid-template-columns: 1fr 380px; gap: 16px; }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px 24px;
      box-shadow: 0 8px 30px rgba(13, 38, 76, 0.06);
      border: 1px solid rgba(11, 22, 50, 0.04);
      margin-bottom: 20px;
    }
    h2, h3 { margin-top: 0; margin-bottom: 12px; color: var(--blue); }
    h3 { font-weight: 600; }
    .small { font-size: 13px; color: var(--muted-text); margin-bottom: 12px; }
    .tiny { font-size: 12px; color: var(--muted-text); }
    .form-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 14px; }
    label {
      flex-basis: 100%;
      font-weight: 600;
      margin-bottom: 6px;
      color: #0b2540;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="email"],
    select,
    textarea {
      padding: 10px;
      border: 1px solid #e6e9ef;
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
      font-family: inherit;
    }
    input[type="file"] { font-size: 14px; }
    select {
      appearance: none;
      background: white url('data:image/svg+xml;utf8,<svg fill="%230b69ff" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
      background-size: 16px;
      cursor: pointer;
    }
    textarea { resize: vertical; min-height: 80px; }
    button {
      background: var(--blue);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }
    button:hover { background: #074bd9; }
    button.ghost {
      background: none;
      border: 1px solid #e6e9ef;
      color: var(--blue);
    }
    button.green {
      background: #10b981;
    }
    button.green:hover { background: #059669; }
    .section { border-top: 1px solid #e6e9ef; padding-top: 20px; margin-top: 20px; }
    .grid-two-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .chat-box {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e6e9ef;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .chat-controls { display: flex; gap: 8px; }
    .msg { margin-bottom: 10px; }
    .msg.me { text-align: right; }
    .msg .meta { font-size: 12px; color: var(--muted-text); }
    .student-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e6e9ef;
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 20px;
    }
    .modal-content {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; text-align: left; }
    th { font-weight: 600; color: var(--muted-text); }
    tr { border-bottom: 1px solid #e6e9ef; }
    @media (max-width: 720px) {
      .grid-two-cols { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <div class="title text-xl font-bold">SoMAp — Student Management & Academic Prototype</div>
    <div class="tiny">Realtime • Firebase Realtime DB & Storage</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Left: Registration, Students, and Academic Modules -->
      <div>
        <!-- Student Registration & Profile Management -->
        <div class="card" id="studentRegistration">
          <h2 class="text-2xl font-semibold text-blue-600">Student Registration & Profile Management</h2>
          <p class="small">Complete the digital student profile form below. Data saved to <code>/students</code>.</p>
          <form id="registrationForm" enctype="multipart/form-data" novalidate class="space-y-4">
            <div class="section">
              <h3>Basic Information</h3>
              <div class="grid-two-cols">
                <div><label for="firstName">First Name *</label><input type="text" id="firstName" name="firstName" placeholder="First Name" required class="border p-2 rounded" /></div>
                <div><label for="middleName">Middle Name</label><input type="text" id="middleName" name="middleName" placeholder="Middle Name" class="border p-2 rounded" /></div>
                <div><label for="lastName">Last Name *</label><input type="text" id="lastName" name="lastName" placeholder="Last Name" required class="border p-2 rounded" /></div>
                <div>
                  <label for="gender">Gender *</label>
                  <select id="gender" name="gender" required class="border p-2 rounded">
                    <option value="" disabled selected>Select gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div><label for="dob">Date of Birth *</label><input type="date" id="dob" name="dob" required class="border p-2 rounded" /></div>
                <div><label for="admissionNumber">Admission Number (Auto-generated)</label><input type="text" id="admissionNumber" name="admissionNumber" placeholder="Auto-generated on save" disabled class="border p-2 rounded" /></div>
                <div><label for="pupilId">Pupil’s ID</label><input type="text" id="pupilId" name="pupilId" placeholder="Pupil's ID" class="border p-2 rounded" /></div>
                <div><label for="birthCertNumber">Birth Certificate Number</label><input type="text" id="birthCertNumber" name="birthCertNumber" placeholder="Birth Certificate Number" class="border p-2 rounded" /></div>
                <div><label for="religion">Religion</label><input type="text" id="religion" name="religion" placeholder="Religion" class="border p-2 rounded" /></div>
                <div><label for="tribe">Tribe / Ethnicity</label><input type="text" id="tribe" name="tribe" placeholder="Tribe or Ethnicity" class="border p-2 rounded" /></div>
              </div>
            </div>
            <div class="section">
              <h3>School Information</h3>
              <div class="grid-two-cols">
                <div><label for="schoolName">School Name *</label><input type="text" id="schoolName" name="schoolName" placeholder="School Name" required class="border p-2 rounded" /></div>
                <div>
                  <label for="classLevel">Class Level *</label>
                  <select id="classLevel" name="classLevel" required class="border p-2 rounded">
                    <option value="" disabled selected>Select class</option>
                    <option value="Baby Class">Baby Class</option>
                    <option value="Class 1">Class 1</option>
                    <option value="Class 2">Class 2</option>
                    <option value="Class 3">Class 3</option>
                    <option value="Class 4">Class 4</option>
                    <option value="Class 5">Class 5</option>
                    <option value="Class 6">Class 6</option>
                    <option value="Class 7">Class 7</option>
                  </select>
                </div>
                <div><label for="stream">Stream</label><input type="text" id="stream" name="stream" placeholder="e.g., 4B" class="border p-2 rounded" /></div>
                <div><label for="academicYear">Current Academic Year *</label><input type="text" id="academicYear" name="academicYear" placeholder="e.g., 2024" required class="border p-2 rounded" /></div>
                <div><label for="academicTrack">Academic Track</label><input type="text" id="academicTrack" name="academicTrack" placeholder="e.g., NECTA / SFNA" class="border p-2 rounded" /></div>
                <div>
                  <label for="boardingStatus">Boarding or Day Scholar *</label>
                  <select id="boardingStatus" name="boardingStatus" required class="border p-2 rounded">
                    <option value="" disabled selected>Select status</option>
                    <option value="Boarding">Boarding</option>
                    <option value="Day Scholar">Day Scholar</option>
                  </select>
                </div>
                <div style="grid-column: span 2;"><label for="shiftedFrom">Shifted From (for transfer-ins)</label><input type="text" id="shiftedFrom" name="shiftedFrom" placeholder="Previous school if transferred" class="border p-2 rounded" /></div>
              </div>
            </div>
            <div class="section">
              <h3>Parent / Guardian Details</h3>
              <div class="grid-two-cols">
                <div><label for="primaryParentName">Primary Parent Name *</label><input type="text" id="primaryParentName" name="primaryParentName" placeholder="Primary Parent or Guardian" required class="border p-2 rounded" /></div>
                <div><label for="primaryParentContact">Primary Parent Contact (Mobile, WhatsApp) *</label><input type="text" id="primaryParentContact" name="primaryParentContact" placeholder="+255 7xx xxx xxx" required class="border p-2 rounded" /></div>
                <div><label for="secondaryGuardian">Secondary Guardian (if any)</label><input type="text" id="secondaryGuardian" name="secondaryGuardian" placeholder="Secondary Guardian" class="border p-2 rounded" /></div>
                <div><label for="relationshipToStudent">Relationship to Student</label><input type="text" id="relationshipToStudent" name="relationshipToStudent" placeholder="e.g., Aunt, Uncle" class="border p-2 rounded" /></div>
                <div style="grid-column: span 2;"><label for="residentialAddress">Residential Address *</label><textarea id="residentialAddress" name="residentialAddress" placeholder="Residential Address" required class="border p-2 rounded"></textarea></div>
                <div style="grid-column: span 2;"><label for="employmentStatus">Employment Status (if needed for bursary qualification)</label><input type="text" id="employmentStatus" name="employmentStatus" placeholder="Employment Status" class="border p-2 rounded" /></div>
              </div>
            </div>
            <div class="section">
              <h3>Photos & Attachments</h3>
              <div class="grid-two-cols">
                <div><label for="passportPhoto">Passport Photo Upload</label><input type="file" id="passportPhoto" name="passportPhoto" accept="image/*" /></div>
                <div><label for="birthCertUpload">Birth Certificate Upload</label><input type="file" id="birthCertUpload" name="birthCertUpload" accept="image/*,application/pdf" /></div>
                <div><label for="reportCardUpload">Report Card (First Term, Ongoing)</label><input type="file" id="reportCardUpload" name="reportCardUpload" accept="image/*,application/pdf" /></div>
                <div><label for="joiningLetterUpload">Joining or Transfer Letter (PDF/Image)</label><input type="file" id="joiningLetterUpload" name="joiningLetterUpload" accept="image/*,application/pdf" /></div>
                <div><label for="medicalDocsUpload">Medical Documents (if applicable)</label><input type="file" id="medicalDocsUpload" name="medicalDocsUpload" accept="image/*,application/pdf" /></div>
              </div>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white">Register Student</button>
          </form>
        </div>

        <!-- Students List -->
<div class="card">
  <h3 class="text-xl font-semibold text-blue-600">Students</h3>
  <div class="mt-4 flex gap-2">
    <button id="exportCsvBtn" class="ghost px-4 py-2">Export CSV</button>
  </div>
  <div class="students-list mt-4" id="studentsList" aria-live="polite"></div>
</div>
        <!-- Academic & Exams Module -->
        <div class="card" id="academicModule">
          <div id="academicRoot"></div>
        </div>
      </div>

      <!-- Right: Chat & Debug -->
      <div>
        <div class="card">
          <h3 class="text-xl font-semibold text-blue-600">Live Chat</h3>
          <div class="small">Messages saved to <code>/messages</code>. Your messages show on the right.</div>
          <div class="mt-4 meta-row flex items-center gap-2">
            <input id="myName" type="text" placeholder="Your name (saved locally)" style="width:150px" class="border p-2 rounded" />
            <div class="tiny ml-auto">Status: <span id="status">—</span></div>
          </div>
          <div class="chat-wrapper mt-4">
            <div id="chat" class="chat-box" role="log" aria-live="polite"></div>
            <div class="chat-controls flex gap-2">
              <input id="msgInput" type="text" placeholder="Write a message..." class="flex-1 border p-2 rounded" />
              <button id="sendBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white">Send</button>
            </div>
          </div>
          <div class="mt-2 small">Tip: press Enter to send. Use the Firebase Console to view raw nodes under <code>/students</code> and <code>/messages</code>.</div>
        </div>
        <div class="card mt-4">
          <h3 class="text-xl font-semibold text-blue-600">Developer / Debug</h3>
          <div class="small">
            If you see <strong>permission_denied</strong>, set Realtime DB rules to:
            <pre class="bg-gray-100 p-2 rounded">{ "rules": { ".read": true, ".write": true } }</pre>
            And Storage rules to:
            <pre class="bg-gray-100 p-2 rounded">
{
  "rules": {
    "files": {
      "$uid": {
        ".read": true,
        ".write": true
      }
    }
  }
}
            </pre>
            (Only for testing — secure later.)
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-storage-compat.js"></script>
  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Firebase Configuration
    var firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.firebasestorage.app",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };
    firebase.initializeApp(firebaseConfig);
    if (typeof firebase.analytics === "function") {
      firebase.analytics();
    }

    const db = firebase.database();
    const storage = firebase.storage();
    document.getElementById('status').textContent = 'connected';
    initApp(db, storage);

    function initApp(db, storage) {
      // DOM Elements
      const registrationForm = document.getElementById('registrationForm');
      const studentsList = document.getElementById('studentsList');
      const exportCsvBtn = document.getElementById('exportCsvBtn');
      const chatEl = document.getElementById('chat');
      const myName = document.getElementById('myName');
      const msgInput = document.getElementById('msgInput');
      const sendBtn = document.getElementById('sendBtn');

      // Preserve name locally
      myName.value = localStorage.getItem('somap_name') || '';
      myName.addEventListener('change', () => localStorage.setItem('somap_name', myName.value.trim()));

      // Utility to escape HTML
      function escapeHtml(str = '') {
        return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
      }

      // File upload handler
      async function uploadFile(file, path) {
        if (!file) return null;
        try {
          const ref = storage.ref(path);
          await ref.put(file);
          return await ref.getDownloadURL();
        } catch (err) {
          console.error('File upload failed:', err);
          alert('File upload failed: ' + err.message);
          return null;
        }
      }

      // Student Registration Form Submission
      registrationForm.addEventListener('submit', async e => {
        e.preventDefault();
        const firstName = registrationForm.firstName.value.trim();
        const lastName = registrationForm.lastName.value.trim();
        const gender = registrationForm.gender.value;
        const dob = registrationForm.dob.value;
        const schoolName = registrationForm.schoolName.value.trim();
        const classLevel = registrationForm.classLevel.value;
        const academicYear = registrationForm.academicYear.value.trim();
        const boardingStatus = registrationForm.boardingStatus.value;
        const primaryParentName = registrationForm.primaryParentName.value.trim();
        const primaryParentContact = registrationForm.primaryParentContact.value.trim();
        const residentialAddress = registrationForm.residentialAddress.value.trim();

        if (!firstName || !lastName || !gender || !dob || !schoolName || !classLevel || !academicYear || !boardingStatus || !primaryParentName || !primaryParentContact || !residentialAddress) {
          alert('Please fill all required fields marked with *');
          return;
        }

        const admissionNumber = 'ADM' + Date.now();
        registrationForm.admissionNumber.value = admissionNumber;

        const studentProfile = {
          basicInfo: {
            firstName,
            middleName: registrationForm.middleName.value.trim(),
            lastName,
            gender,
            dob,
            admissionNumber,
            pupilId: registrationForm.pupilId.value.trim(),
            birthCertNumber: registrationForm.birthCertNumber.value.trim(),
            religion: registrationForm.religion.value.trim(),
            tribe: registrationForm.tribe.value.trim(),
            feesDue: 0
          },
          schoolInfo: {
            schoolName,
            classLevel,
            stream: registrationForm.stream.value.trim(),
            academicYear,
            academicTrack: registrationForm.academicTrack.value.trim(),
            boardingStatus,
            shiftedFrom: registrationForm.shiftedFrom.value.trim(),
            admissionDate: new Date().toISOString().split('T')[0]
          },
          parentGuardian: {
            primaryParentName,
            primaryParentContact,
            secondaryGuardian: registrationForm.secondaryGuardian.value.trim(),
            relationshipToStudent: registrationForm.relationshipToStudent.value.trim(),
            residentialAddress,
            employmentStatus: registrationForm.employmentStatus.value.trim()
          },
          attachments: {},
          scores: {},
          attendance: { '2025': { totalDays: 0, present: 0 } },
          createdAt: Date.now()
        };

        // Handle file uploads
        const files = {
          passportPhoto: registrationForm.passportPhoto.files[0],
          birthCertUpload: registrationForm.birthCertUpload.files[0],
          reportCardUpload: registrationForm.reportCardUpload.files[0],
          joiningLetterUpload: registrationForm.joiningLetterUpload.files[0],
          medicalDocsUpload: registrationForm.medicalDocsUpload.files[0]
        };
        for (const [key, file] of Object.entries(files)) {
          if (file) {
            const path = `files/students/${admissionNumber}/${key}_${Date.now()}`;
            const url = await uploadFile(file, path);
            if (url) studentProfile.attachments[key] = url;
          }
        }

        try {
          await db.ref('students').push(studentProfile);
          alert('Student registered successfully!');
          registrationForm.reset();
          registrationForm.admissionNumber.value = '';
        } catch (err) {
          alert('Registration failed: ' + err.message);
        }
      });

      db.ref('students').on('value', snap => {
        studentsList.innerHTML = '';
        const data = snap.val() || {};
        const keys = Object.keys(data);
        if (keys.length === 0) {
          studentsList.innerHTML = '<div class="small">No students yet.</div>';
          return;
        }
        keys.forEach(k => {
          const s = data[k];
          const row = document.createElement('div');
          row.className = 'student-row';
          row.innerHTML = `
            <div>
              <div class="student-meta font-semibold">${escapeHtml(s.basicInfo.firstName + ' ' + s.basicInfo.lastName)}</div>
              <div class="small">${escapeHtml(s.schoolInfo.classLevel)} • Fees: ${s.basicInfo.feesDue || 0}</div>
            </div>
            <div class="flex gap-2 items-center">
              <button class="ghost px-3 py-1" data-key="${k}" onclick="viewStudent(event)">View</button>
              <button class="px-3 py-1 bg-red-600 text-white rounded" data-key="${k}" onclick="deleteStudent(event)">Delete</button>
            </div>
          `;
          studentsList.appendChild(row);
        });
      });

      window.viewStudent = (e) => {
        const key = e.target.dataset.key;
        db.ref('students/' + key).once('value').then(snap => {
          const s = snap.val();
          alert(`Name: ${s.basicInfo.firstName} ${s.basicInfo.lastName}\nClass: ${s.schoolInfo.classLevel}\nFees Due: ${s.basicInfo.feesDue || 0}\nAdmission Date: ${s.schoolInfo.admissionDate || 'N/A'}\nDate of Birth: ${s.basicInfo.dob || 'N/A'}\nParent's Name: ${s.parentGuardian.primaryParentName || 'N/A'}\nParent's Contact: ${s.parentGuardian.primaryParentContact || 'N/A'}`);
        });
      };

      window.deleteStudent = (e) => {
        const key = e.target.dataset.key;
        if (!confirm('Delete this student from DB?')) return;
        db.ref('students/' + key).remove().catch(err => alert('Delete failed: ' + err.message));
      };

      exportCsvBtn.addEventListener('click', () => {
  db.ref('students').once('value').then(snap => {
    const data = snap.val() || {};
    const rows = [['Name', 'Administration Number', 'Class', 'Date of Registration', 'Date of Birth', 'Parents Contact', 'Parent\'s Name']];
    Object.values(data).forEach(s => rows.push([
      s.basicInfo.firstName + ' ' + s.basicInfo.lastName,
      s.basicInfo.admissionNumber,
      s.schoolInfo.classLevel,
      new Date(s.createdAt).toLocaleDateString(),
      s.basicInfo.dob,
      s.parentGuardian.primaryParentContact,
      s.parentGuardian.primaryParentName
    ]));
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'somap_students.csv';
    a.click();
    URL.revokeObjectURL(url);
  });
});

      // Chat Functionality
      function addMessageToUI(msgObj, key) {
        const el = document.createElement('div');
        const name = msgObj.name || 'Anon';
        const text = msgObj.text || '';
        const ts = msgObj.timestamp ? new Date(msgObj.timestamp) : new Date();
        const time = ts.toLocaleString();
        const me = (myName.value || '').trim() && (myName.value || '').trim().toLowerCase() === name.toLowerCase();
        el.className = 'msg' + (me ? ' me' : '');
        el.innerHTML = `<div class="meta"><strong>${escapeHtml(name)}</strong> • <span class="tiny">${escapeHtml(time)}</span></div><div>${escapeHtml(text)}</div>`;
        chatEl.appendChild(el);
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      sendBtn.addEventListener('click', sendMessage);
      msgInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      });

      function sendMessage() {
        const name = (myName.value || '').trim();
        const text = (msgInput.value || '').trim();
        if (!name) { alert('Enter your name'); return; }
        if (!text) return;
        sendBtn.disabled = true;
        const payload = { name, text, timestamp: Date.now() };
        db.ref('messages').push(payload)
          .then(() => { msgInput.value = ''; })
          .catch(err => alert('Send failed: ' + err.message))
          .finally(() => sendBtn.disabled = false);
      }

      db.ref('messages').limitToLast(200).on('child_added', snap => {
        addMessageToUI(snap.val(), snap.key);
      });

      // Academic Module React
      const { useState, useEffect } = React;
      const CURRICULUM_TEMPLATES = {
        'Baby Class': ['Arithmetic', 'Communication', 'Arts'],
        'Class 1': ['Writing Skills', 'Arithmetic', 'Kusoma', 'Listening'],
        'Class 2': ['Writing Skills', 'Arithmetic', 'Kusoma', 'Listening'],
        'Class 3': ['Math', 'English', 'Kiswahili', 'Science', 'Geography', 'Arts'],
        'Class 4': ['Math', 'English', 'Kiswahili', 'Science', 'Geography', 'Arts'],
        'Class 5': ['Math', 'English', 'Kiswahili', 'Science', 'History', 'French'],
        'Class 6': ['Math', 'English', 'Kiswahili', 'Science', 'Social Studies', 'Civics'],
        'Class 7': ['Math', 'English', 'Kiswahili', 'Science', 'Social Studies', 'Civics']
      };

      function AcademicApp() {
        const [profiles, setProfiles] = useState([]);
        const [role, setRole] = useState('DIRECTOR');
        const [selectedStudentId, setSelectedStudentId] = useState(null);
        const [currentMonth, setCurrentMonth] = useState('2025-03');
        const [filterClass, setFilterClass] = useState('');

        useEffect(() => {
          const ref = db.ref('students');
          ref.on('value', snap => {
            const data = snap.val() || {};
            const students = Object.entries(data).map(([id, s]) => ({
              id,
              fullName: `${s.basicInfo.firstName} ${s.basicInfo.lastName}`,
              firstName: s.basicInfo.firstName,
              lastName: s.basicInfo.lastName,
              gender: s.basicInfo.gender,
              dob: s.basicInfo.dob,
              admissionNumber: s.basicInfo.admissionNumber,
              pupilId: s.basicInfo.pupilId,
              birthCertNumber: s.basicInfo.birthCertNumber,
              religion: s.basicInfo.religion,
              tribe: s.basicInfo.tribe,
              feesDue: s.basicInfo.feesDue || 0,
              classLevel: s.schoolInfo.classLevel,
              stream: s.schoolInfo.stream,
              schoolName: s.schoolInfo.schoolName,
              academicYear: s.schoolInfo.academicYear,
              academicTrack: s.schoolInfo.academicTrack,
              boardingStatus: s.schoolInfo.boardingStatus,
              admissionDate: s.schoolInfo.admissionDate,
              shiftedFrom: s.schoolInfo.shiftedFrom,
              guardianPrimary: {
                name: s.parentGuardian.primaryParentName,
                mobile: s.parentGuardian.primaryParentContact,
                relationship: s.parentGuardian.relationshipToStudent
              },
              guardianSecondary: {
                name: s.parentGuardian.secondaryGuardian,
                mobile: '',
                relationship: ''
              },
              address: s.parentGuardian.residentialAddress,
              employmentStatus: s.parentGuardian.employmentStatus,
              attachments: s.attachments || {},
              scores: s.scores || {},
              attendance: s.attendance || { '2025': { totalDays: 0, present: 0 } },
              createdAt: s.createdAt
            }));
            setProfiles(students);
          });
          return () => ref.off();
        }, []);

        function updateProfile(id, patch) {
          const current = profiles.find(p => p.id === id);
          db.ref(`students/${id}`).update({
            basicInfo: {
              ...current,
              firstName: patch.fullName.split(' ')[0] || current.firstName,
              lastName: patch.fullName.split(' ').slice(1).join(' ') || current.lastName,
              gender: patch.gender || current.gender,
              dob: patch.dob || current.dob,
              admissionNumber: patch.admissionNumber || current.admissionNumber,
              pupilId: patch.pupilId || current.pupilId,
              birthCertNumber: patch.birthCertNumber || current.birthCertNumber,
              religion: patch.religion || current.religion,
              tribe: patch.tribe || current.tribe,
              feesDue: patch.feesDue || current.feesDue
            },
            schoolInfo: {
              ...current,
              schoolName: patch.schoolName || current.schoolName,
              classLevel: patch.classLevel || current.classLevel,
              stream: patch.stream || current.stream,
              academicYear: patch.academicYear || current.academicYear,
              academicTrack: patch.academicTrack || current.academicTrack,
              boardingStatus: patch.boardingStatus || current.boardingStatus,
              admissionDate: patch.admissionDate || current.admissionDate,
              shiftedFrom: patch.shiftedFrom || current.shiftedFrom
            },
            parentGuardian: {
              ...current,
              primaryParentName: patch.guardianPrimary.name || current.guardianPrimary.name,
              primaryParentContact: patch.guardianPrimary.mobile || current.guardianPrimary.mobile,
              relationshipToStudent: patch.guardianPrimary.relationship || current.guardianPrimary.relationship,
              secondaryGuardian: patch.guardianSecondary.name || current.guardianSecondary.name,
              residentialAddress: patch.address || current.address,
              employmentStatus: patch.employmentStatus || current.employmentStatus
            }
          }).catch(err => alert('Update failed: ' + err.message));
        }

        function saveScores(studentId, monthKey, subjectScores) {
          db.ref(`students/${studentId}/scores/${monthKey}`).set(subjectScores)
            .catch(err => alert('Save scores failed: ' + err.message));
        }

        function computeClassMetrics(classLevel, monthKey) {
          const classStudents = profiles.filter(p => p.classLevel === classLevel);
          const metrics = classStudents.map(p => {
            const marks = p.scores[monthKey] || {};
            const subjects = Object.keys(marks);
            const total = subjects.reduce((s, sub) => s + (marks[sub] || 0), 0);
            const avg = subjects.length ? (total / subjects.length) : 0;
            const attendanceYear = p.attendance['2025'] || { totalDays: 0, present: 0 };
            return {
              studentId: p.id,
              fullName: p.fullName,
              admissionNumber: p.admissionNumber,
              total,
              avg,
              subjectsCount: subjects.length,
              present: attendanceYear.present,
              feesDue: p.feesDue || 0
            };
          });
          metrics.sort((a, b) => {
            if (b.avg !== a.avg) return b.avg - a.avg;
            if (b.total !== a.total) return b.total - a.total;
            return b.present - a.present;
          });
          let lastAvg = null, pos = 0, tiedCount = 0;
          metrics.forEach((m, idx) => {
            pos = idx + 1;
            if (lastAvg !== null && m.avg === lastAvg) {
              tiedCount += 1;
            } else {
              tiedCount = 0;
            }
            m.position = pos - tiedCount;
            lastAvg = m.avg;
          });
          return metrics;
        }

        return React.createElement('div', null,
          React.createElement('div', { className: 'flex items-start justify-between gap-4 mb-4' },
            React.createElement('div', null,
              React.createElement('h2', { className: 'text-2xl font-semibold text-blue-600' }, 'Scoresheet & Reports'),
              React.createElement('p', { className: 'small' }, 'Enter monthly marks, generate report cards, and export CSV/PDF.')
            ),
            React.createElement('div', { className: 'form-row flex gap-2 items-center' },
              React.createElement('select', {
                className: 'border p-2 rounded',
                value: currentMonth,
                onChange: e => setCurrentMonth(e.target.value)
              },
                React.createElement('option', { value: '2025-03' }, 'Mar 2025'),
                React.createElement('option', { value: '2025-06' }, 'Jun 2025'),
                React.createElement('option', { value: '2025-11' }, 'Nov 2025')
              ),
              React.createElement('select', {
                className: 'border p-2 rounded',
                value: filterClass,
                onChange: e => setFilterClass(e.target.value)
              },
                React.createElement('option', { value: '' }, 'All classes'),
                ...Array.from(new Set(profiles.map(p => p.classLevel))).map(cl => React.createElement('option', { key: cl, value: cl }, cl))
              ),
              React.createElement('button', {
                className: 'ghost px-3 py-2 border rounded',
                onClick: () => {
                  const rows = [['Name', 'Administration Number', 'Class', 'Date of Registration', 'Date of Birth', 'Parents Contact', 'Parent\'s Name']];
                  profiles.forEach(p => rows.push([p.fullName, p.admissionNumber, p.classLevel, new Date(p.createdAt).toLocaleDateString(), p.dob, p.guardianPrimary.mobile, p.guardianPrimary.name]));
                  downloadCSV(rows, 'somap_students.csv');
                }
              }, 'Export Overview CSV')
            )
          ),
          React.createElement('table', { className: 'min-w-full text-left' },
            React.createElement('thead', null,
              React.createElement('tr', null,
                React.createElement('th', { className: 'p-2 small' }, 'Name'),
                React.createElement('th', { className: 'p-2 small' }, 'Class'),
                React.createElement('th', { className: 'p-2 small' }, 'Admission No'),
                React.createElement('th', { className: 'p-2 small' }, 'Adm. Date'),
                React.createElement('th', { className: 'p-2 small' }, 'Fees Due'),
                React.createElement('th', { className: 'p-2 small' }, 'Actions')
              )
            ),
            React.createElement('tbody', null,
              profiles.filter(p => !filterClass || p.classLevel === filterClass).map(p => (
                React.createElement('tr', { key: p.id, className: 'border-t' },
                  React.createElement('td', { className: 'p-2' }, p.fullName),
                  React.createElement('td', { className: 'p-2' }, p.classLevel),
                  React.createElement('td', { className: 'p-2' }, p.admissionNumber),
                  React.createElement('td', { className: 'p-2' }, p.admissionDate || ''),
                  React.createElement('td', { className: 'p-2 text-red-600' }, p.feesDue || 0),
                  React.createElement('td', { className: 'p-2' },
                    React.createElement('div', { className: 'form-row flex gap-2' },
                      React.createElement('button', {
                        className: 'ghost px-2 py-1 border rounded',
                        onClick: () => setSelectedStudentId(p.id)
                      }, 'View/Edit'),
                      React.createElement('button', {
                        className: 'ghost px-2 py-1 border rounded',
                        onClick: () => {
                          const subjects = CURRICULUM_TEMPLATES[p.classLevel] || ['Math', 'English'];
                          const current = p.scores[currentMonth] || {};
                          openScoresModal({
                            student: p,
                            monthKey: currentMonth,
                            subjects,
                            currentScores: current,
                            onSave: (scores) => saveScores(p.id, currentMonth, scores)
                          });
                        }
                      }, 'Enter Marks'),
                      React.createElement('button', {
                        className: 'px-2 py-1 green text-white rounded',
                        onClick: () => generatePdfReport(p, currentMonth)
                      }, 'PDF')
                    )
                  )
                )
              ))
            )
          ),
          React.createElement('aside', { className: 'mt-4' },
            React.createElement('div', { className: 'card' },
              React.createElement('h3', { className: 'font-semibold text-blue-600' }, 'Role / Dashboards'),
              React.createElement('div', { className: 'mt-2' },
                React.createElement('select', {
                  className: 'w-full border p-2 rounded',
                  value: role,
                  onChange: e => setRole(e.target.value)
                },
                  React.createElement('option', { value: 'DIRECTOR' }, 'Academic Director'),
                  React.createElement('option', { value: 'HEADTEACHER' }, 'Headteacher'),
                  React.createElement('option', { value: 'TEACHER' }, 'Class Teacher'),
                  React.createElement('option', { value: 'ACCOUNTANT' }, 'Accountant'),
                  React.createElement('option', { value: 'PARENT' }, 'Parent/Guardian')
                )
              ),
              React.createElement('div', { className: 'mt-2 small' }, 'Switch role to preview dashboards and access rights.')
            ),
            React.createElement('div', { className: 'card mt-4' },
              React.createElement('h3', { className: 'font-semibold text-blue-600' }, 'Class Insights (selected month)'),
              React.createElement('div', { className: 'mt-2' },
                Array.from(new Set(profiles.map(p => p.classLevel))).map(cl => {
                  const metrics = computeClassMetrics(cl, currentMonth);
                  if (!metrics.length) return null;
                  const top = metrics.slice(0, 3);
                  return React.createElement('div', { key: cl, className: 'mb-4' },
                    React.createElement('div', { className: 'font-medium' }, cl),
                    React.createElement('div', { className: 'small' }, 'Top: ' + top.map(t => `${t.fullName} (${Math.round(t.avg)})`).join(' • '))
                  );
                })
              )
            ),
            React.createElement('div', { className: 'card mt-4' },
              React.createElement('h3', { className: 'font-semibold text-blue-600' }, 'Utilities'),
              React.createElement('div', { className: 'mt-2 flex flex-col gap-2' },
                React.createElement('button', { className: 'border rounded p-2', onClick: () => {
                  const rows = [['AdmissionNo','FullName','Class','Subject','Score','Average']];
                  profiles.forEach(p => {
                    const subjObj = (p.scores[currentMonth] || {});
                    const subjKeys = Object.keys(subjObj);
                    const avg = subjKeys.length ? (Object.values(subjObj).reduce((a,b)=>a+b,0)/subjKeys.length) : '';
                    if (subjKeys.length) {
                      subjKeys.forEach(sj => rows.push([p.admissionNumber, p.fullName, p.classLevel, sj, subjObj[sj], avg]));
                    } else {
                      rows.push([p.admissionNumber, p.fullName, p.classLevel, '', '', '']);
                    }
                  });
                  downloadCSV(rows, 'somap_scores_' + currentMonth + '.csv');
                } }, 'Export Scores CSV (month)')
              )
            )
          ),
          selectedStudentId && React.createElement(ProfileModal, {
            id: selectedStudentId,
            profile: profiles.find(p => p.id === selectedStudentId),
            onClose: () => setSelectedStudentId(null),
            onSave: (patch) => {
              updateProfile(selectedStudentId, patch);
              setSelectedStudentId(null);
            }
          })
        );
      }

      function ProfileModal({ id, profile, onClose, onSave }) {
        const [form, setForm] = useState(profile || {});
        useEffect(() => setForm(profile), [profile]);

        if (!profile) return null;

        function setField(k, v) {
          setForm(prev => ({ ...prev, [k]: v }));
        }

        function save() {
          if (!form.fullName) { alert('Name required'); return; }
          onSave(form);
        }

        return React.createElement('div', { className: 'modal' },
          React.createElement('div', { className: 'modal-content' },
            React.createElement('div', { className: 'flex justify-between items-center mb-4' },
              React.createElement('h3', { className: 'text-xl font-semibold text-blue-600' }, `Student Profile — ${form.fullName || ''}`),
              React.createElement('div', null,
                React.createElement('button', { className: 'ghost px-3 py-1 mr-2', onClick: onClose }, 'Close'),
                React.createElement('button', { className: 'px-3 py-1 bg-blue-600 text-white rounded', onClick: save }, 'Save')
              )
            ),
            React.createElement('div', { className: 'grid-two-cols' },
              React.createElement('div', null,
                labeledInput('Full Name', form.fullName, v => setField('fullName', v)),
                labeledInput('Admission Number', form.admissionNumber, v => setField('admissionNumber', v)),
                labeledInput('Gender', form.gender, v => setField('gender', v)),
                labeledInput('Date of Birth', form.dob, v => setField('dob', v)),
                labeledInput('Admission Date', form.admissionDate, v => setField('admissionDate', v)),
                labeledInput('Class Level', form.classLevel, v => setField('classLevel', v))
              ),
              React.createElement('div', null,
                labeledInput('Stream', form.stream, v => setField('stream', v)),
                labeledInput('Fees Due', form.feesDue, v => setField('feesDue', Number(v))),
                labeledInput('Birth Certificate #', form.birthCertNumber, v => setField('birthCertNumber', v)),
                labeledInput('Religion', form.religion, v => setField('religion', v)),
                labeledInput('Tribe/Ethnicity', form.tribe, v => setField('tribe', v))
              )
            ),
            React.createElement('div', { className: 'section' },
              React.createElement('h3', { className: 'font-semibold text-blue-600' }, 'Guardian / Parent Details'),
              React.createElement('div', { className: 'grid-two-cols' },
                labeledInput('Primary Guardian Name', (form.guardianPrimary && form.guardianPrimary.name) || '', v => setField('guardianPrimary', { ...(form.guardianPrimary || {}), name: v })),
                labeledInput('Primary Mobile', (form.guardianPrimary && form.guardianPrimary.mobile) || '', v => setField('guardianPrimary', { ...(form.guardianPrimary || {}), mobile: v })),
                labeledInput('Relationship', (form.guardianPrimary && form.guardianPrimary.relationship) || '', v => setField('guardianPrimary', { ...(form.guardianPrimary || {}), relationship: v })),
                labeledInput('Secondary Guardian', (form.guardianSecondary && form.guardianSecondary.name) || '', v => setField('guardianSecondary', { ...(form.guardianSecondary || {}), name: v }))
              ),
              labeledInput('Address', form.address || '', v => setField('address', v)),
              labeledInput('Employment Status', form.employmentStatus || '', v => setField('employmentStatus', v))
            ),
            React.createElement('div', { className: 'section' },
              React.createElement('label', { className: 'small block mb-1' }, 'Attachments (URLs)'),
              React.createElement('textarea', {
                className: 'w-full border p-2 rounded',
                value: Object.values(form.attachments || {}).join(', '),
                readOnly: true
              })
            )
          )
        );
      }

      function labeledInput(label, value, onChange) {
        return React.createElement('div', { className: 'form-row mb-2' },
          React.createElement('label', { className: 'small block mb-1' }, label),
          React.createElement('input', {
            className: 'border p-2 rounded w-full',
            value: value || '',
            onChange: e => onChange(e.target.value)
          })
        );
      }

      function openScoresModal({ student, monthKey, subjects, currentScores, onSave }) {
        const scores = { ...currentScores };
        subjects.forEach(s => { if (scores[s] === undefined) scores[s] = ''; });
        const result = {};
        for (const s of subjects) {
          const prev = scores[s] || '';
          const input = prompt(`Enter score for ${student.fullName} — ${s} (0-100)`, String(prev));
          if (input === null) return;
          const n = Number(input);
          if (isNaN(n) || n < 0 || n > 100) {
            alert('Please enter a valid score between 0 and 100');
            return;
          }
          result[s] = n;
        }
        onSave(result);
        alert(`Scores saved for ${student.fullName} (${monthKey})`);
      }

      function downloadCSV(rows, filename) {
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      function generatePdfReport(student, monthKey) {
        const marks = student.scores[monthKey] || {};
        const subjects = Object.keys(marks);
        const total = subjects.reduce((s, sub) => s + (marks[sub] || 0), 0);
        const avg = subjects.length ? (total / subjects.length) : 0;
        const attendanceYear = student.attendance['2025'] || { totalDays: 0, present: 0 };
        const passMark = 50;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        doc.setFontSize(18);
        doc.text(student.schoolName || 'SoMAp School', 40, 50);
        doc.setFontSize(12);
        doc.text('Report — ' + monthKey, 40, 72);
        doc.setFontSize(14);
        doc.text(student.fullName || '', 40, 100);
        doc.setFontSize(10);
        doc.text('Admission No: ' + (student.admissionNumber || ''), 40, 118);
        doc.text('Class: ' + (student.classLevel || ''), 300, 118);
        doc.text('Admission Date: ' + (student.admissionDate || ''), 40, 134);
        doc.text('Fees Due: ' + (student.feesDue || 0), 300, 134);

        let y = 160;
        doc.setFontSize(11);
        doc.text('Subject', 40, y);
        doc.text('Score', 300, y);
        y += 12;
        subjects.forEach(sub => {
          doc.text(String(sub), 40, y);
          doc.text(String(marks[sub] || 0), 300, y);
          y += 14;
        });
        y += 10;
        doc.text('Average: ' + avg.toFixed(2), 40, y);
        doc.text('Total: ' + total, 160, y);
        y += 20;
        doc.text('Attendance (2025): Present ' + (attendanceYear.present || 0) + '/' + (attendanceYear.totalDays || 0), 40, y);
        y += 20;

        let comment = 'Good performance.';
        if (avg < 45) comment = 'Needs improvement — encourage revision and practice.';
        else if (avg < 60) comment = 'Satisfactory — can do better with extra practice.';
        else if (avg >= 90) comment = 'Excellent performance — well done.';
        doc.text('Teacher comment: ' + comment, 40, y);

        doc.save(`${student.fullName}_${monthKey}.pdf`);
      }

      ReactDOM.createRoot(document.getElementById('academicRoot')).render(React.createElement(AcademicApp));
    }
  </script>
</body>
</html>