<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp — School ERP</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: Inter, system-ui, Arial; background:#f8fafc; color:#0f172a; }
    .modal { display:none; position:fixed; inset:0; width:100%; height:100%;
             background-color: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { position:relative; background:#fff; margin:0 auto; padding:20px;
      border-radius:10px; width:95%; max-width:920px; height:90vh; overflow-y:auto; margin-top:20px; }
    .close { position:absolute; top:10px; right:16px; font-size:24px; cursor:pointer; }
    .tab-btn { transition: all .15s; }
    .tab-btn.active { color:#4f46e5; border-bottom-color:#4f46e5; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border:1px solid #e6e9ef; text-align:left; font-size:13px; }
    thead th { background:#eef2ff; color:#0b69ff; }
    .hidden { display:none !important; }
    .block { display:block !important; }
    .student-card { background:#fff; border:1px solid #e6e9ef; border-radius:8px; padding:10px; margin-bottom:10px; }
    .hint { font-size:12px; color:#6b7280; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:.5rem .85rem; border-radius:.5rem; }
  </style>
</head>
<body class="bg-gray-50 p-4">

  <div class="mb-4">
    <div class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm mb-4">
      Manage all academic and administrative aspects of your school with SoMAp ERP.
    </div>

    <!-- Top Tabs -->
    <div class="flex flex-wrap border-b mb-4 gap-2">
      <button class="erp-tab tab-btn px-4 py-2 font-medium border-b-2 border-indigo-500 text-indigo-600 active"
              data-tab="admissions">Admissions</button>

      <a href="academic.html"
         class="btn bg-white shadow rounded-lg hover:bg-gray-50 transition">
        <i class="fa-solid fa-graduation-cap"></i>
        <span>Academics</span>
      </a>

      <a href="attendance.html"
   class="btn bg-white shadow rounded-lg hover:bg-gray-50 transition">
  <i class="fa-solid fa-clipboard-check"></i>
  <span>Attendance</span>
</a>

      <button class="erp-tab tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700"
              data-tab="discipline">Discipline</button>

      <button class="erp-tab tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700"
              data-tab="students">Students List</button>
    </div>

    <!-- Admissions tab -->
    <div class="erp-tab-content active block bg-white rounded-lg shadow p-4" data-tab="admissions">
      <div class="space-y-4">
        <div>
          <h3 class="font-medium text-gray-800">New Applications</h3>
          <p class="text-sm text-gray-500 mb-3">Review and process new student applications.</p>
          <div class="flex justify-between">
            <span class="text-sm font-medium text-green-600">12 new applications</span>
            <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
          </div>
        </div>

        <div>
          <h3 class="font-medium text-gray-800">Quick Admission</h3>
          <p class="text-sm text-gray-500 mb-3">Register a new student directly.</p>
          <button id="openRegistrationModal"
                  class="w-full md:w-1/2 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            Create New Admission
          </button>
          <p class="hint mt-2">Admission number auto-fills when the form opens.</p>
        </div>

        <div>
          <h3 class="font-medium text-gray-800">Transfer Requests</h3>
          <p class="text-sm text-gray-500 mb-2">Students requesting transfer in/out</p>
          <div class="flex justify-between">
            <span class="text-sm font-medium text-yellow-600">3 pending requests</span>
            <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
          </div>
        </div>
      </div>
    </div>
    <!-- Discipline tab (placeholder) -->
    <div class="erp-tab-content hidden bg-white rounded-lg shadow p-4" data-tab="discipline">
      <h3 class="font-medium text-gray-800 mb-2">Discipline</h3>
      <p class="text-sm text-gray-500">Discipline features coming soon.</p>
    </div>

    <!-- Students List tab -->
    <div class="erp-tab-content hidden bg-white rounded-lg shadow p-4" data-tab="students">
      <h3 class="font-medium text-gray-800">Student List</h3>
      <p class="text-sm text-gray-500 mb-3">Filter by class and download the list.</p>

      <div class="mb-3 md:flex md:items-center md:gap-3">
        <select id="student-list-class" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
          <option value="">All Classes</option>
          <option>Baby Class</option>
          <option>Class 1</option>
          <option>Class 2</option>
          <option>Class 3</option>
          <option>Class 4</option>
          <option>Class 5</option>
          <option>Class 6</option>
          <option>Class 7</option>
        </select>

        <div class="ml-auto flex gap-2">
          <button id="downloadCsvBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            <i class="fa-solid fa-file-csv"></i> Download CSV
          </button>
          <button id="downloadPdfBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            <i class="fa-solid fa-file-pdf"></i> Download PDF
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="student-list-table" class="min-w-full text-sm">
          <thead>
            <tr>
              <th>Admission No</th>
              <th>Full Name</th>
              <th>Class</th>
              <th>Date of Registration</th>
              <th>Passport Photo</th>
              <th>Parent Contact</th>
              <th>Fee Total</th>
              <th>Payment Plan</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody id="studentListBody">
            <!-- filled by JS -->
          </tbody>
        </table>
      </div>

      <hr class="my-6">

      <h3 class="font-medium text-gray-800 mt-4">School Reports</h3>
      <p class="text-sm text-gray-500 mb-3">Download reports per school, class, month, term, year.</p>

      <div class="mb-3 md:flex md:items-center md:gap-3">
        <select id="school-report-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
          <option value="per-school">Per School</option>
          <option value="per-class">Per Class</option>
          <option value="per-month">Per Month</option>
          <option value="per-term">Per Term</option>
          <option value="per-year">Per Year</option>
        </select>
        <div class="ml-auto flex gap-2">
          <button id="schoolDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            <i class="fa-solid fa-file-csv"></i> Download CSV
          </button>
          <button id="schoolDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            <i class="fa-solid fa-file-pdf"></i> Download PDF
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="school-report-table" class="min-w-full text-sm">
          <thead>
            <tr>
              <th>Admission No</th>
              <th>Full Name</th>
              <th>Class</th>
              <th>Parents Contact</th>
              <th>Fee Per Year</th>
              <th>Paid Amount</th>
              <th>Debt</th>
            </tr>
          </thead>
          <tbody id="schoolReportBody"></tbody>
        </table>
      </div>

      <hr class="my-6">

      <h3 class="font-medium text-gray-800 mt-4">Report Forms</h3>
      <p class="text-sm text-gray-500 mb-3">Download report forms with student details.</p>

      <div class="mb-3 md:flex md:items-center md:gap-3">
        <select id="report-form-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
          <option value="per-student">Per Student</option>
          <option value="per-class">Per Class</option>
          <option value="per-term">Per Term</option>
        </select>
        <div class="ml-auto flex gap-2">
          <button id="reportDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            <i class="fa-solid fa-file-csv"></i> Download CSV
          </button>
          <button id="reportDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            <i class="fa-solid fa-file-pdf"></i> Download PDF
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="report-form-table" class="min-w-full text-sm">
          <thead>
            <tr>
              <th>Admission No</th>
              <th>Full Name</th>
              <th>Class</th>
              <th>Parents Contact</th>
              <th>Fee Per Year</th>
              <th>Paid Amount</th>
              <th>Debt</th>
            </tr>
          </thead>
        <tbody id="reportFormBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Registration Modal -->
  <div id="registrationModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span id="closeModal" class="close" title="Close">&times;</span>
      <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Student Registration</h2>

      <form id="registrationForm" enctype="multipart/form-data" novalidate class="space-y-4">
        <!-- BASIC INFO -->
        <div class="section">
          <h3 class="font-semibold">Basic Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="firstName" class="block text-sm text-gray-600">First Name *</label>
              <input type="text" id="firstName" name="firstName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="middleName" class="block text-sm text-gray-600">Middle Name</label>
              <input type="text" id="middleName" name="middleName" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="lastName" class="block text-sm text-gray-600">Last Name *</label>
              <input type="text" id="lastName" name="lastName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="gender" class="block text-sm text-gray-600">Gender *</label>
              <select id="gender" name="gender" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select gender</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label for="dob" class="block text-sm text-gray-600">Date of Birth *</label>
              <input type="date" id="dob" name="dob" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="admissionNumber" class="block text-sm text-gray-600">Admission Number (Auto-generated)</label>
              <input type="text" id="admissionNumber" name="admissionNumber" readonly class="border p-2 rounded w-full"/>
            </div>

            <!-- Fee fields -->
            <div>
              <label for="feePerYear" class="block text-sm text-gray-600">Fee Per Year (Tsh) *</label>
              <input type="number" id="feePerYear" name="feePerYear" placeholder="e.g., 600000" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="paymentPlan" class="block text-sm text-gray-600">Payment Plan *</label>
              <select id="paymentPlan" name="paymentPlan" required class="border p-2 rounded w-full">
                <option value="">-- Select Payment Plan --</option>
                <option value="monthly">Monthly (Jan–Oct)</option>
                <option value="6-instalments">6 Instalments</option>
                <option value="2-instalments">2 Instalments</option>
                <option value="yearly">Full Year at Once</option>
                <option value="other">Other (as agreed)</option>
              </select>
            </div>

            <div>
              <label for="pupilId" class="block text-sm text-gray-600">Pupil’s ID</label>
              <input type="text" id="pupilId" name="pupilId" placeholder="Pupil's ID" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="birthCertNumber" class="block text-sm text-gray-600">Birth Certificate Number</label>
              <input type="text" id="birthCertNumber" name="birthCertNumber" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="religion" class="block text-sm text-gray-600">Religion</label>
              <input type="text" id="religion" name="religion" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="tribe" class="block text-sm text-gray-600">Tribe / Ethnicity</label>
              <input type="text" id="tribe" name="tribe" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- SCHOOL INFO -->
        <div class="section">
          <h3 class="font-semibold">School Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="schoolName" class="block text-sm text-gray-600">School Name *</label>
              <input type="text" id="schoolName" name="schoolName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="classLevel" class="block text-sm text-gray-600">Class Level *</label>
              <select id="classLevel" name="classLevel" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select class</option>
                <option>Baby Class</option>
                <option>Class 1</option>
                <option>Class 2</option>
                <option>Class 3</option>
                <option>Class 4</option>
                <option>Class 5</option>
                <option>Class 6</option>
                <option>Class 7</option>
              </select>
            </div>
            <div>
              <label for="stream" class="block text-sm text-gray-600">Stream</label>
              <input type="text" id="stream" name="stream" placeholder="e.g., 4B" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="academicYear" class="block text-sm text-gray-600">Current Academic Year *</label>
              <input type="text" id="academicYear" name="academicYear" placeholder="e.g., 2025" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="academicTrack" class="block text-sm text-gray-600">Academic Track</label>
              <input type="text" id="academicTrack" name="academicTrack" placeholder="e.g., NECTA / SFNA" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="boardingStatus" class="block text-sm text-gray-600">Boarding or Day Scholar *</label>
              <select id="boardingStatus" name="boardingStatus" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select status</option>
                <option>Boarding</option>
                <option>Day Scholar</option>
              </select>
            </div>
            <div>
              <label for="shiftedFrom" class="block text-sm text-gray-600">Shifted From (for transfer-ins)</label>
              <input type="text" id="shiftedFrom" name="shiftedFrom" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- PARENT/GUARDIAN -->
        <div class="section">
          <h3 class="font-semibold">Parent / Guardian Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="primaryParentName" class="block text-sm text-gray-600">Primary Parent Name *</label>
              <input type="text" id="primaryParentName" name="primaryParentName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="primaryParentContact" class="block text-sm text-gray-600">Primary Parent Contact *</label>
              <input type="text" id="primaryParentContact" name="primaryParentContact" placeholder="+255 7xx xxx xxx"
                required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="secondaryGuardian" class="block text-sm text-gray-600">Secondary Guardian (if any)</label>
              <input type="text" id="secondaryGuardian" name="secondaryGuardian" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="relationshipToStudent" class="block text-sm text-gray-600">Relationship to Student</label>
              <input type="text" id="relationshipToStudent" name="relationshipToStudent" class="border p-2 rounded w-full"/>
            </div>
            <div class="md:col-span-2">
              <label for="residentialAddress" class="block text-sm text-gray-600">Residential Address *</label>
              <textarea id="residentialAddress" name="residentialAddress" required class="border p-2 rounded w-full"></textarea>
            </div>
            <div class="md:col-span-2">
              <label for="employmentStatus" class="block text-sm text-gray-600">Employment Status (if needed)</label>
              <input type="text" id="employmentStatus" name="employmentStatus" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- FILES -->
        <div class="section">
          <h3 class="font-semibold">Photos & Attachments</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="passportPhoto" class="block text-sm text-gray-600">Passport Photo Upload *</label>
              <input type="file" id="passportPhoto" name="passportPhoto" accept="image/*" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="birthCertUpload" class="block text-sm text-gray-600">Birth Certificate Upload *</label>
              <input type="file" id="birthCertUpload" name="birthCertUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="reportCardUpload" class="block text-sm text-gray-600">Report Card (First Term, Ongoing) *</label>
              <input type="file" id="reportCardUpload" name="reportCardUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="joiningLetterUpload" class="block text-sm text-gray-600">Joining or Transfer Letter (PDF/Image) *</label>
              <input type="file" id="joiningLetterUpload" name="joiningLetterUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"/>
            </div>
            <div class="md:col-span-2">
              <label for="medicalDocsUpload" class="block text-sm text-gray-600">Medical Documents (if applicable)</label>
              <input type="file" id="medicalDocsUpload" name="medicalDocsUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <button type="submit" id="registerBtn"
                class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
          Register Student
        </button>
      </form>

      <!-- Quick search (live) -->
      <div class="mt-8">
        <h3 class="font-semibold">Search Students</h3>
        <input type="text" id="search-box" placeholder="Search by name or ID"
               class="border p-2 rounded w-64 mt-2"/>
        <div id="student-list" class="mt-4"></div>
      </div>
    </div>
  </div>

  <!-- Student Details Modal -->
  <div id="detailsModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span id="closeDetailsModal" class="close" title="Close">&times;</span>
      <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Student Details</h2>
      <div id="studentDetails" class="space-y-2"></div>
      <div class="mt-4">
        <button id="generateIDCard" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          Generate ID Card (PDF)
        </button>
      </div>
    </div>
  </div>

  <!-- Third-party libraries (CSV + PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDKs (compat) + your config -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <!-- If you want analytics, you can add firebase-analytics-compat as well -->
  <script src="firebase.js"></script> <!-- ensure this file exists and initializes Firebase -->

  <!-- Main App Logic -->
  <script>
    (function () {
      // ---- Resolve Firebase handles gracefully ----
      const db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
      const storage = window.storage || (window.firebase && firebase.storage ? firebase.storage() : null);

      if (!db) {
        console.error('Firebase Realtime Database not available. Ensure firebase.js and Firebase SDKs are loaded.');
      }
      if (!storage) {
        console.warn('Firebase Storage not available. File uploads will be skipped.');
      }

      // ---- Tabs show/hide ----
      document.querySelectorAll('.erp-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.erp-tab').forEach(b => b.classList.remove('border-indigo-500','text-indigo-600','active'));
          btn.classList.add('border-indigo-500','text-indigo-600','active');

          const tab = btn.getAttribute('data-tab');
          document.querySelectorAll('.erp-tab-content').forEach(sec => {
            const match = sec.getAttribute('data-tab') === tab;
            sec.classList.toggle('hidden', !match);
            sec.classList.toggle('block', match);
          });

          if (tab === 'students') {
            renderAllTables(); // render with current cache + filter
          }
        });
      });

      // ---- Modal open/close ----
      const openModalBtn = document.getElementById('openRegistrationModal');
      const closeModalBtn = document.getElementById('closeModal');
      const modal = document.getElementById('registrationModal');
      const form = document.getElementById('registrationForm');
      const registerBtn = document.getElementById('registerBtn');

      if (openModalBtn) openModalBtn.addEventListener('click', () => {
        const adm = document.getElementById('admissionNumber');
        if (adm) adm.value = `AUTO-${Date.now()}`;
        modal.style.display = 'block';
        checkFormValidity();
      });
      if (closeModalBtn) closeModalBtn.addEventListener('click', () => closeRegistrationModal());
      window.addEventListener('click', (e) => { if (e.target === modal) closeRegistrationModal(); });

      function closeRegistrationModal() {
        modal.style.display = 'none';
        form.reset();
        registerBtn.disabled = true;
      }

      // ---- Required fields -> enable/disable register ----
      const requiredFields = [
        'firstName', 'lastName', 'gender', 'dob',
        'schoolName', 'classLevel', 'academicYear', 'boardingStatus',
        'primaryParentName', 'primaryParentContact', 'residentialAddress',
        'feePerYear', 'paymentPlan'
      ];
      const requiredFiles = ['passportPhoto','birthCertUpload','reportCardUpload','joiningLetterUpload'];

      function checkFormValidity() {
        const fieldsOk = requiredFields.every(id => {
          const el = document.getElementById(id);
          return el && String(el.value || '').trim() !== '';
        });
        const filesOk = requiredFiles.every(id => {
          const el = document.getElementById(id);
          return el && el.files && el.files.length > 0;
        });
        registerBtn.disabled = !(fieldsOk && filesOk);
      }
      [...requiredFields, ...requiredFiles].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', checkFormValidity);
        if (el && el.type === 'file') el.addEventListener('change', checkFormValidity);
      });
      registerBtn.disabled = true;

      // ---- Utils ----
      function escapeHtml(text) {
        if (text === undefined || text === null) return '';
        return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
      }

     async function uploadIfPresent(inputId, folder, newKey) {
  // Skip entirely if Storage handle is missing
  if (!storage) return null;

  const el = document.getElementById(inputId);
  if (!el || !el.files || el.files.length === 0) return null;

  try {
    const file = el.files[0];
    const path = `students/${newKey}/${folder}/${Date.now()}_${file.name}`;
    const sref = storage.ref(path);
    await sref.put(file);
    const url = await sref.getDownloadURL();
    return url;
  } catch (err) {
    console.warn(`[Storage] Skipping ${inputId} upload:`, err);
    return null; // <— IMPORTANT: do not throw, keep registration flowing
  }
}

      // ---- Registration submit ----
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          registerBtn.disabled = true;

          const fd = new FormData(form);
          const studentData = {
            firstName: fd.get('firstName'),
            middleName: fd.get('middleName') || '',
            lastName: fd.get('lastName'),
            gender: fd.get('gender'),
            dob: fd.get('dob'),
            admissionNumber: document.getElementById('admissionNumber').value || `AUTO-${Date.now()}`,
            pupilId: fd.get('pupilId') || '',
            birthCertNumber: fd.get('birthCertNumber') || '',
            religion: fd.get('religion') || '',
            tribe: fd.get('tribe') || '',
            schoolName: fd.get('schoolName'),
            classLevel: fd.get('classLevel'),
            stream: fd.get('stream') || '',
            academicYear: fd.get('academicYear'),
            academicTrack: fd.get('academicTrack') || '',
            boardingStatus: fd.get('boardingStatus'),
            shiftedFrom: fd.get('shiftedFrom') || '',
            primaryParentName: fd.get('primaryParentName'),
            primaryParentContact: fd.get('primaryParentContact'),
            secondaryGuardian: fd.get('secondaryGuardian') || '',
            relationshipToStudent: fd.get('relationshipToStudent') || '',
            residentialAddress: fd.get('residentialAddress'),
            employmentStatus: fd.get('employmentStatus') || '',
            feePerYear: Number(fd.get('feePerYear') || 0),
            paymentPlan: fd.get('paymentPlan'),
            timestamp: firebase.database.ServerValue.TIMESTAMP
          };

          try {
            if (!db) throw new Error('Database not available');

            // Duplicate check by (first,last,dob,class,parentContact)
            let duplicate = false;
            const dupSnap = await db.ref('students')
              .orderByChild('primaryParentContact')
              .equalTo(studentData.primaryParentContact)
              .once('value');
            dupSnap.forEach(child => {
              const s = child.val();
              if (s &&
                  (s.firstName||'') === studentData.firstName &&
                  (s.lastName||'') === studentData.lastName &&
                  (s.dob||'') === studentData.dob &&
                  (s.classLevel||'') === studentData.classLevel) {
                duplicate = true;
              }
            });
            if (duplicate) {
              alert("Duplicate student detected (same name, DOB, class & parent contact).");
              registerBtn.disabled = false;
              return;
            }

           // 1) Create DB record FIRST (so we never lose the student)
const newRef = db.ref('students').push();
const newKey = newRef.key;

await newRef.set({
  createdAt: firebase.database.ServerValue.TIMESTAMP,
  ...studentData
});

// 2) Try uploads AFTER — never fail registration if Storage errors
const urls = {};
urls.passportPhotoURL = await uploadIfPresent('passportPhoto','passport', newKey);
urls.birthCertURL     = await uploadIfPresent('birthCertUpload','birth-cert', newKey);
urls.reportCardURL    = await uploadIfPresent('reportCardUpload','report-card', newKey);
urls.joiningLetterURL = await uploadIfPresent('joiningLetterUpload','joining-letter', newKey);
urls.medicalDocsURL   = await uploadIfPresent('medicalDocsUpload','medical-docs', newKey);

// Only write non-null URLs
const clean = Object.fromEntries(Object.entries(urls).filter(([,v]) => !!v));
if (Object.keys(clean).length) {
  await newRef.update(clean);
}
            alert('✅ Student registered successfully!');
            closeRegistrationModal();
            renderAllTables(); // refresh if Students tab open
          } catch (err) {
            console.error(err);
            alert('❌ Error registering student: ' + (err.message || err));
            registerBtn.disabled = false;
          }
        });
      }

      // ---- Live cache + rendering ----
      let cachedStudents = []; // array of { key, ...data }

      if (db) {
        db.ref('students').on('value', (snapshot) => {
          const raw = snapshot.val() || {};
          cachedStudents = Object.entries(raw).map(([key, s]) => ({ key, ...s }));
          // update search list always
          renderSearchList(cachedStudents);
          // if Students tab is visible, render the tables
          const activeTab = document.querySelector('.erp-tab.active');
          if (activeTab && activeTab.getAttribute('data-tab') === 'students') {
            renderAllTables();
          }
        });
      }

      // ---- Students tab rendering ----
      function renderAllTables() {
        const classFilter = document.getElementById('student-list-class').value || '';
        const listBody = document.getElementById('studentListBody');
        const schoolReportBody = document.getElementById('schoolReportBody');
        const reportFormBody = document.getElementById('reportFormBody');
        if (!listBody || !schoolReportBody || !reportFormBody) return;

        listBody.innerHTML = '';
        const filtered = cachedStudents.filter(s => !classFilter || s.classLevel === classFilter);

        filtered.forEach(s => {
          const tr = document.createElement('tr');
          const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
          const dateReg = s.timestamp ? new Date(s.timestamp).toLocaleDateString() :
                          s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'N/A';
          const photoURL = s.passportPhotoURL || 'https://via.placeholder.com/50';
          tr.innerHTML = `
            <td>${escapeHtml(s.admissionNumber || 'N/A')}</td>
            <td>${escapeHtml(fullName)}</td>
            <td>${escapeHtml(s.classLevel || 'N/A')}</td>
            <td>${escapeHtml(dateReg)}</td>
            <td><img src="${escapeHtml(photoURL)}" alt="photo" style="width:50px;height:50px;object-fit:cover;border-radius:4px"/></td>
            <td>${escapeHtml(s.primaryParentContact || 'N/A')}</td>
            <td>${escapeHtml(String(s.feePerYear || 0))}</td>
            <td>${escapeHtml(s.paymentPlan || 'N/A')}</td>
            <td><button class="py-1 px-2 border rounded text-indigo-600" data-view="${s.key}">
                  <i class="fas fa-eye"></i>
                </button></td>
          `;
          listBody.appendChild(tr);
        });

        // Attach one delegated listener for view buttons
        listBody.onclick = (e) => {
          const btn = e.target.closest('button[data-view]');
          if (!btn) return;
          const key = btn.getAttribute('data-view');
          openDetails(key);
        };

        // School Reports + Report Forms (same structure)
        schoolReportBody.innerHTML = '';
        reportFormBody.innerHTML = '';
        cachedStudents.forEach(s => {
          const rowHtml = `
            <td>${escapeHtml(s.admissionNumber || 'N/A')}</td>
            <td>${escapeHtml((s.firstName || '') + ' ' + (s.lastName || ''))}</td>
            <td>${escapeHtml(s.classLevel || 'N/A')}</td>
            <td>${escapeHtml(s.primaryParentContact || 'N/A')}</td>
            <td>${escapeHtml(String(s.feePerYear || 0))}</td>
            <td>${escapeHtml(String(s.paidAmount || 0))}</td>
            <td>${escapeHtml(String(s.debt || 0))}</td>
          `;
          const tr1 = document.createElement('tr'); tr1.innerHTML = rowHtml;
          const tr2 = document.createElement('tr'); tr2.innerHTML = rowHtml;
          schoolReportBody.appendChild(tr1);
          reportFormBody.appendChild(tr2);
        });
      }

      document.getElementById('student-list-class')
        .addEventListener('change', renderAllTables);

      // ---- Details Modal ----
      async function openDetails(key) {
        if (!db) return alert('DB not ready');
        try {
          const snap = await db.ref('students/' + key).once('value');
          const s = snap.val() || {};
          const details = document.getElementById('studentDetails');
          const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.trim();
          const photoURL = s.passportPhotoURL || 'https://via.placeholder.com/120';
          details.innerHTML = `
            <p><strong>Full Name:</strong> ${escapeHtml(fullName)}</p>
            <p><strong>Class:</strong> ${escapeHtml(s.classLevel || 'N/A')}</p>
            <p><strong>Date of Registration:</strong> ${s.timestamp ? new Date(s.timestamp).toLocaleDateString() : (s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'N/A')}</p>
            <p><strong>Passport Photo:</strong><br/><img src="${escapeHtml(photoURL)}" alt="photo" style="width:120px;height:120px;object-fit:cover;border-radius:6px"/></p>
            <p><strong>Parent Contact:</strong> ${escapeHtml(s.primaryParentContact || 'N/A')}</p>
            <p><strong>Fee Total:</strong> ${escapeHtml(String(s.feePerYear || 0))}</p>
            <p><strong>Payment Plan:</strong> ${escapeHtml(s.paymentPlan || 'N/A')}</p>
            <p><strong>Residential Address:</strong> ${escapeHtml(s.residentialAddress || 'N/A')}</p>
            <p><strong>Admission Number:</strong> ${escapeHtml(s.admissionNumber || 'N/A')}</p>
          `;
          document.getElementById('generateIDCard').onclick = () => generateIDCard(s);
          document.getElementById('detailsModal').style.display = 'block';
        } catch (err) {
          console.error('Error fetching details:', err);
        }
      }
      document.getElementById('closeDetailsModal').addEventListener('click', () => {
        document.getElementById('detailsModal').style.display = 'none';
      });

      // ---- ID Card PDF ----
    function generateIDCard(student) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape", "mm", "credit-card");

  // Colors
  const primaryColor = "#0b3d91"; // dark blue
  const textColor = "#000000";

  // Background
  doc.setFillColor("#f5f5f5");
  doc.rect(0, 0, 85.6, 54, "F");

  // Top Bar
  doc.setFillColor(primaryColor);
  doc.rect(0, 0, 85.6, 10, "F");
  doc.setTextColor("#FFFFFF");
  doc.setFontSize(10);
  doc.text("STUDENT ID CARD", 42.8, 7, { align: "center" });

  // School Logo (already in your folder, e.g. "assets/logo.png")
  try {
    doc.addImage("images/somap-logo.png.jpg", "PNG", 2, 2, 15, 15);
  } catch (e) {
    console.warn("⚠️ Logo not found, ensure 'assets/logo.png' exists.");
  }

  // Student Photo
  if (student.passportPhotoURL) {
    try {
      doc.addImage(student.passportPhotoURL, "JPEG", 2, 12, 20, 25);
    } catch (e) {
      doc.setDrawColor(0);
      doc.rect(2, 12, 20, 25);
      doc.text("Photo", 12, 25, { align: "center" });
    }
  } else {
    doc.setDrawColor(0);
    doc.rect(2, 12, 20, 25);
    doc.text("Photo", 12, 25, { align: "center" });
  }

  // Student Details (correct mapping to your DB fields)
  const fullName = `${student.firstName || ""} ${student.middleName || ""} ${student.lastName || ""}`.trim();
  const admissionNo = student.admissionNumber || "N/A";
  const classLevel = student.classLevel || "N/A";
  const parentContact = student.primaryParentContact || "N/A";

  doc.setTextColor(textColor);
  doc.setFontSize(8);

  let startX = 25, startY = 15;
  doc.text(`Full Name: ${fullName}`, startX, startY);
  doc.text(`Class: ${classLevel}`, startX, startY + 6);
  doc.text(`Admission No: ${admissionNo}`, startX, startY + 12);
  doc.text(`Parent Contact: ${parentContact}`, startX, startY + 18);
  doc.text(`School Contact: +255686828732`, startX, startY + 24);
  doc.text(`Year: ${new Date().getFullYear()}`, startX, startY + 30);

  // Bottom Bar
  doc.setFillColor(primaryColor);
  doc.rect(0, 46, 85.6, 8, "F");
  doc.setTextColor("#FFFFFF");
  doc.setFontSize(7);
  doc.text("Issued by Socrates School", 42.8, 51, { align: "center" });

  // Save PDF
  const safeName = (fullName || "student").replace(/\s+/g, "_");
  doc.save(`${safeName}_ID.pdf`);
}

      // ---- CSV & PDF downloads for tables ----
      async function downloadCSVforTab(filenameBase) {
        if (!cachedStudents.length) return alert('No data to download');
        const classFilter = document.getElementById('student-list-class').value || '';
        const list = (filenameBase === 'student-list')
          ? cachedStudents.filter(s => !classFilter || s.classLevel === classFilter)
          : cachedStudents;

        const arr = list.map(s => ({
          'Admission No': s.admissionNumber || 'N/A',
          'Full Name': `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim(),
          'Class': s.classLevel || 'N/A',
          'Date of Registration': s.timestamp ? new Date(s.timestamp).toLocaleDateString() :
                                 (s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'N/A'),
          'Parent Contact': s.primaryParentContact || 'N/A',
          'Fee Total': s.feePerYear || 0,
          'Payment Plan': s.paymentPlan || 'N/A'
        }));

        const csv = Papa.unparse(arr);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filenameBase}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      async function downloadPDFforTab(filenameBase) {
        if (!cachedStudents.length) return alert('No data to download');
        const classFilter = document.getElementById('student-list-class').value || '';
        const list = (filenameBase === 'student-list')
          ? cachedStudents.filter(s => !classFilter || s.classLevel === classFilter)
          : cachedStudents;

        const rows = list.map(s => [
          s.admissionNumber || 'N/A',
          `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim(),
          s.classLevel || 'N/A',
          s.timestamp ? new Date(s.timestamp).toLocaleDateString() :
            (s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'N/A'),
          s.primaryParentContact || 'N/A',
          s.feePerYear || 0,
          s.paymentPlan || 'N/A'
        ]);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });
        doc.setFontSize(14);
        doc.text(`${filenameBase.replace('-', ' ')} Report`, 14, 10);
        doc.autoTable({
          head: [['Admission No','Full Name','Class','Date of Registration','Parent Contact','Fee Total','Payment Plan']],
          body: rows,
          startY: 18,
          styles: { fontSize: 8 }
        });
        doc.save(`${filenameBase}.pdf`);
      }

      document.getElementById('downloadCsvBtn').addEventListener('click', () => downloadCSVforTab('student-list'));
      document.getElementById('downloadPdfBtn').addEventListener('click', () => downloadPDFforTab('student-list'));
      document.getElementById('schoolDownloadCsv').addEventListener('click', () => downloadCSVforTab('school-reports'));
      document.getElementById('schoolDownloadPdf').addEventListener('click', () => downloadPDFforTab('school-reports'));
      document.getElementById('reportDownloadCsv').addEventListener('click', () => downloadCSVforTab('report-forms'));
      document.getElementById('reportDownloadPdf').addEventListener('click', () => downloadPDFforTab('report-forms'));

      // ---- Quick Search (live) ----
      const searchBox = document.getElementById('search-box');
      const searchList = document.getElementById('student-list');

      function renderSearchList(students) {
        if (!searchList) return;
        const term = (searchBox.value || '').toLowerCase();
        const filtered = !term ? students : students.filter(s =>
          ((s.firstName||'').toLowerCase().includes(term)) ||
          ((s.lastName||'').toLowerCase().includes(term)) ||
          ((s.pupilId||'').toLowerCase().includes(term)) ||
          ((s.admissionNumber||'').toLowerCase().includes(term))
        );
        searchList.innerHTML = '';
        filtered.forEach(stu => {
          const div = document.createElement('div');
          div.className = 'student-card';
          div.innerHTML = `
            <strong>${escapeHtml((stu.firstName||'') + ' ' + (stu.lastName||''))}</strong><br>
            ID: ${escapeHtml(stu.pupilId || stu.admissionNumber || 'N/A')}<br>
            Class: ${escapeHtml(stu.classLevel || 'N/A')}<br>
            Fee: ${escapeHtml(String(stu.feePerYear || 0))}
          `;
          searchList.appendChild(div);
        });
      }
      if (searchBox) searchBox.addEventListener('input', () => renderSearchList(cachedStudents));

      // ---- Connectivity sanity check (non-destructive) ----
      if (db) {
        db.ref('z_test_write').set({ ok: true, ts: Date.now() })
          .then(() => console.log('DB test write OK'))
          .catch(err => console.warn('DB test write failed (ignore if rules block):', err.message));
      }
    })();
  </script>
  <!-- SoMAp Attendance Tab Redirect -->
<script>
  (function(){
    function wireAttendanceLink(){
      // Find any tab or menu with data-tab="attendance"
      document.querySelectorAll('[data-tab="attendance"]').forEach(function(el){
        el.addEventListener('click', function(e){
          e.preventDefault();
          // Open attendance.html full screen
          window.location.href = "attendance.html";
        });
      });
    }
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", wireAttendanceLink);
    } else {
      wireAttendanceLink();
    }
  })();
</script>
</body>
</html>