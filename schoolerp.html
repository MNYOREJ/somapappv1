<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp — School ERP</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Layout & small UI tweaks */
    body { font-family: Inter, system-ui, Arial; background: #f8fafc; color: #0f172a; }
    .modal { display:none; position:fixed; inset:0; width:100%; height:100%;
      background-color: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { position:relative; background:#fff; margin:0 auto; padding:20px;
      border-radius:8px; width:90%; max-width:900px; height:90vh; overflow-y:auto; margin-top:20px; }
    .close { position:absolute; top:10px; right:20px; font-size:24px; cursor:pointer; }
    .section h3 { font-weight:600; color:#374151; margin:0.5rem 0 0.35rem; }
    .tab-btn { transition: all .2s; }
    .tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border:1px solid #e6e9ef; text-align:left; font-size:13px; }
    thead th { background:#eef2ff; color:#0b69ff; }
    .small { font-size:13px; color:#6b7280; }
    .hidden { display:none !important; }
    .block { display:block !important; }
  </style>
</head>
<body class="bg-gray-50 p-4">

  <div class="mb-4">
    <div class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm mb-4">
      Manage all academic and administrative aspects of your school with SoMAp ERP.
    </div>

    <!-- Top Tabs -->
    <div class="flex border-b mb-4 space-x-4">
      <button class="erp-tab tab-btn px-4 py-2 font-medium border-b-2 border-indigo-500 text-indigo-600 active"
              data-tab="admissions">Admissions</button>

      <a href="academic.html"
         class="block bg-white shadow rounded-lg px-4 py-2 hover:bg-gray-50 transition">
        <div class="text-left">
          <h2 class="text-lg font-semibold text-gray-700">Academics</h2>
          <p class="text-gray-500 text-sm">Manage exams, results, and reports.</p>
        </div>
      </a>

      <button class="erp-tab tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700"
              data-tab="attendance">Attendance</button>

      <button class="erp-tab tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700"
              data-tab="discipline">Discipline</button>

      <!-- NEW: Students List tab -->
      <button class="erp-tab tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700"
              data-tab="students">Students List</button>
    </div>

    <!-- Admissions tab content -->
    <div class="erp-tab-content active block bg-white rounded-lg shadow p-4" data-tab="admissions">
      <div class="space-y-3">
        <div>
          <h3 class="font-medium text-gray-800">New Applications</h3>
          <p class="text-sm text-gray-500 mb-3">Review and process new student applications</p>
          <div class="flex justify-between">
            <span class="text-sm font-medium text-green-600">12 new applications</span>
            <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
          </div>
        </div>

        <div>
          <h3 class="font-medium text-gray-800">Quick Admission</h3>
          <p class="text-sm text-gray-500 mb-3">Register a new student directly</p>
          <button id="openRegistrationModal"
                  class="w-full md:w-1/2 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            Create New Admission
          </button>
        </div>

        <div>
          <h3 class="font-medium text-gray-800">Transfer Requests</h3>
          <p class="text-sm text-gray-500 mb-2">Students requesting transfer in/out</p>
          <div class="flex justify-between">
            <span class="text-sm font-medium text-yellow-600">3 pending requests</span>
            <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance tab (placeholder) -->
    <div class="erp-tab-content hidden bg-white rounded-lg shadow p-4" data-tab="attendance">
      <h3 class="font-medium text-gray-800 mb-2">Attendance</h3>
      <p class="text-sm text-gray-500">Attendance features coming soon.</p>
    </div>

    <!-- Discipline tab (placeholder) -->
    <div class="erp-tab-content hidden bg-white rounded-lg shadow p-4" data-tab="discipline">
      <h3 class="font-medium text-gray-800 mb-2">Discipline</h3>
      <p class="text-sm text-gray-500">Discipline features coming soon.</p>
    </div>

    <!-- Students List tab (new merged content) -->
    <div class="erp-tab-content hidden bg-white rounded-lg shadow p-4" data-tab="students">
      <h3 class="font-medium text-gray-800">Student List</h3>
      <p class="text-sm text-gray-500 mb-3">Download list of all students with key details. Filter by class.</p>

      <div class="mb-3 md:flex md:items-center md:gap-3">
        <select id="student-list-class" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
          <option value="">All Classes</option>
          <option value="Baby Class">Baby Class</option>
          <option value="Class 1">Class 1</option>
          <option value="Class 2">Class 2</option>
          <option value="Class 3">Class 3</option>
          <option value="Class 4">Class 4</option>
          <option value="Class 5">Class 5</option>
          <option value="Class 6">Class 6</option>
          <option value="Class 7">Class 7</option>
        </select>

        <div class="ml-auto flex gap-2">
          <button id="downloadCsvBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Download CSV</button>
          <button id="downloadPdfBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Download PDF</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="student-list-table" class="min-w-full text-sm">
          <thead>
            <tr>
              <th>Admission No</th>
              <th>Full Name</th>
              <th>Class</th>
              <th>Date of Registration</th>
              <th>Passport Photo</th>
              <th>Parent Contact</th>
              <th>Fee Total</th>
              <th>Payment Plan</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody id="studentListBody">
            <!-- filled by JS -->
          </tbody>
        </table>
      </div>

      <hr class="my-6">

      <h3 class="font-medium text-gray-800 mt-4">School Reports</h3>
      <p class="text-sm text-gray-500 mb-3">Download reports per school, class, month, term, year.</p>

      <div class="mb-3 md:flex md:items-center md:gap-3">
        <select id="school-report-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
          <option value="per-school">Per School</option>
          <option value="per-class">Per Class</option>
          <option value="per-month">Per Month</option>
          <option value="per-term">Per Term</option>
          <option value="per-year">Per Year</option>
        </select>
        <div class="ml-auto flex gap-2">
          <button id="schoolDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Download CSV</button>
          <button id="schoolDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Download PDF</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="school-report-table" class="min-w-full text-sm">
          <thead>
            <tr>
              <th>Admission No</th>
              <th>Full Name</th>
              <th>Class</th>
              <th>Parents Contact</th>
              <th>Fee Per Year</th>
              <th>Paid Amount</th>
              <th>Debt</th>
            </tr>
          </thead>
          <tbody id="schoolReportBody">
            <!-- filled by JS -->
          </tbody>
        </table>
      </div>

      <hr class="my-6">

      <h3 class="font-medium text-gray-800 mt-4">Report Forms</h3>
      <p class="text-sm text-gray-500 mb-3">Download report forms with student details.</p>

      <div class="mb-3 md:flex md:items-center md:gap-3">
        <select id="report-form-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
          <option value="per-student">Per Student</option>
          <option value="per-class">Per Class</option>
          <option value="per-term">Per Term</option>
        </select>
        <div class="ml-auto flex gap-2">
          <button id="reportDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Download CSV</button>
          <button id="reportDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Download PDF</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="report-form-table" class="min-w-full text-sm">
          <thead>
            <tr>
              <th>Admission No</th>
              <th>Full Name</th>
              <th>Class</th>
              <th>Parents Contact</th>
              <th>Fee Per Year</th>
              <th>Paid Amount</th>
              <th>Debt</th>
            </tr>
          </thead>
          <tbody id="reportFormBody">
            <!-- filled by JS -->
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Registration Modal (kept as you provided) -->
  <div id="registrationModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span id="closeModal" class="close" title="Close">&times;</span>
      <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Student Registration</h2>

      <form id="registrationForm" enctype="multipart/form-data" novalidate class="space-y-4">
        <!-- BASIC INFO -->
        <div class="section">
          <h3>Basic Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="firstName" class="block text-sm text-gray-600">First Name *</label>
              <input type="text" id="firstName" name="firstName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="middleName" class="block text-sm text-gray-600">Middle Name</label>
              <input type="text" id="middleName" name="middleName" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="lastName" class="block text-sm text-gray-600">Last Name *</label>
              <input type="text" id="lastName" name="lastName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="gender" class="block text-sm text-gray-600">Gender *</label>
              <select id="gender" name="gender" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select gender</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label for="dob" class="block text-sm text-gray-600">Date of Birth *</label>
              <input type="date" id="dob" name="dob" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="admissionNumber" class="block text-sm text-gray-600">Admission Number (Auto-generated)</label>
              <input type="text" id="admissionNumber" name="admissionNumber" readonly class="border p-2 rounded w-full"/>
            </div>

            <!-- Fee fields -->
            <div>
              <label for="feePerYear" class="block text-sm text-gray-600">Fee Per Year (Tsh) *</label>
              <input type="number" id="feePerYear" name="feePerYear" placeholder="e.g., 600000" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="paymentPlan" class="block text-sm text-gray-600">Payment Plan *</label>
              <select id="paymentPlan" name="paymentPlan" required class="border p-2 rounded w-full">
                <option value="">-- Select Payment Plan --</option>
                <option value="monthly">Monthly (Jan–Oct)</option>
                <option value="6-instalments">6 Instalments</option>
                <option value="2-instalments">2 Instalments</option>
                <option value="yearly">Full Year at Once</option>
                <option value="other">Other (as agreed)</option>
              </select>
            </div>

            <div>
              <label for="pupilId" class="block text-sm text-gray-600">Pupil’s ID</label>
              <input type="text" id="pupilId" name="pupilId" placeholder="Pupil's ID" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="birthCertNumber" class="block text-sm text-gray-600">Birth Certificate Number</label>
              <input type="text" id="birthCertNumber" name="birthCertNumber" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="religion" class="block text-sm text-gray-600">Religion</label>
              <input type="text" id="religion" name="religion" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="tribe" class="block text-sm text-gray-600">Tribe / Ethnicity</label>
              <input type="text" id="tribe" name="tribe" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- SCHOOL INFO -->
        <div class="section">
          <h3>School Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="schoolName" class="block text-sm text-gray-600">School Name *</label>
              <input type="text" id="schoolName" name="schoolName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="classLevel" class="block text-sm text-gray-600">Class Level *</label>
              <select id="classLevel" name="classLevel" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select class</option>
                <option>Baby Class</option>
                <option>Class 1</option>
                <option>Class 2</option>
                <option>Class 3</option>
                <option>Class 4</option>
                <option>Class 5</option>
                <option>Class 6</option>
                <option>Class 7</option>
              </select>
            </div>
            <div>
              <label for="stream" class="block text-sm text-gray-600">Stream</label>
              <input type="text" id="stream" name="stream" placeholder="e.g., 4B" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="academicYear" class="block text-sm text-gray-600">Current Academic Year *</label>
              <input type="text" id="academicYear" name="academicYear" placeholder="e.g., 2025" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="academicTrack" class="block text-sm text-gray-600">Academic Track</label>
              <input type="text" id="academicTrack" name="academicTrack" placeholder="e.g., NECTA / SFNA" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="boardingStatus" class="block text-sm text-gray-600">Boarding or Day Scholar *</label>
              <select id="boardingStatus" name="boardingStatus" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select status</option>
                <option>Boarding</option>
                <option>Day Scholar</option>
              </select>
            </div>
            <div>
              <label for="shiftedFrom" class="block text-sm text-gray-600">Shifted From (for transfer-ins)</label>
              <input type="text" id="shiftedFrom" name="shiftedFrom" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- PARENT/GUARDIAN -->
        <div class="section">
          <h3>Parent / Guardian Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="primaryParentName" class="block text-sm text-gray-600">Primary Parent Name *</label>
              <input type="text" id="primaryParentName" name="primaryParentName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="primaryParentContact" class="block text-sm text-gray-600">Primary Parent Contact *</label>
              <input type="text" id="primaryParentContact" name="primaryParentContact" placeholder="+255 7xx xxx xxx"
                required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="secondaryGuardian" class="block text-sm text-gray-600">Secondary Guardian (if any)</label>
              <input type="text" id="secondaryGuardian" name="secondaryGuardian" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="relationshipToStudent" class="block text-sm text-gray-600">Relationship to Student</label>
              <input type="text" id="relationshipToStudent" name="relationshipToStudent" class="border p-2 rounded w-full"/>
            </div>
            <div class="md:col-span-2">
              <label for="residentialAddress" class="block text-sm text-gray-600">Residential Address *</label>
              <textarea id="residentialAddress" name="residentialAddress" required class="border p-2 rounded w-full"></textarea>
            </div>
            <div class="md:col-span-2">
              <label for="employmentStatus" class="block text-sm text-gray-600">Employment Status (if needed)</label>
              <input type="text" id="employmentStatus" name="employmentStatus" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- FILES -->
        <div class="section">
          <h3>Photos & Attachments</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="passportPhoto" class="block text-sm text-gray-600">Passport Photo Upload *</label>
              <input type="file" id="passportPhoto" name="passportPhoto" accept="image/*" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="birthCertUpload" class="block text-sm text-gray-600">Birth Certificate Upload *</label>
              <input type="file" id="birthCertUpload" name="birthCertUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="reportCardUpload" class="block text-sm text-gray-600">Report Card (First Term, Ongoing) *</label>
              <input type="file" id="reportCardUpload" name="reportCardUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="joiningLetterUpload" class="block text-sm text-gray-600">Joining or Transfer Letter (PDF/Image) *</label>
              <input type="file" id="joiningLetterUpload" name="joiningLetterUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"/>
            </div>
            <div class="md:col-span-2">
              <label for="medicalDocsUpload" class="block text-sm text-gray-600">Medical Documents (if applicable)</label>
              <input type="file" id="medicalDocsUpload" name="medicalDocsUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <button type="submit" id="registerBtn"
                class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
          Register Student
        </button>
      </form>
    </div>
  </div>

  <!-- Student Details Modal (used by Students List) -->
  <div id="detailsModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span id="closeDetailsModal" class="close" title="Close">&times;</span>
      <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Student Details</h2>
      <div id="studentDetails" class="space-y-2"></div>
      <div class="mt-4">
        <button id="generateIDCard" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Generate ID Card (PDF)</button>
      </div>
    </div>
  </div>

  <!-- Third-party libraries for exports (PDF/Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Your firebase config file (single source of truth) -->
  <script src="firebase.js"></script>

  <!-- Main app logic -->
  <script>
    (function () {
      // Resolve db/storage gracefully (works whether firebase.js sets window.db / window.storage or not)
      const db = window.db || (window.firebase ? (window.firebase.database ? firebase.database() : null) : (window.firebaseDatabase ? firebaseDatabase : null));
      const storage = window.storage || (window.firebase ? (window.firebase.storage ? firebase.storage() : null) : null);

      if (!db) {
        console.error('Firebase Realtime Database not available. Ensure firebase.js and Firebase SDKs are loaded.');
      } else {
        console.log('Firebase DB ready:', db.ref().toString && db.ref().toString());
      }

      if (!storage) {
        console.warn('Firebase Storage not available. File uploads will fail if storage not initialized.');
      }

      // ---------- Tabs show/hide ----------
      document.querySelectorAll('.erp-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.erp-tab').forEach(b => b.classList.remove('border-indigo-500','text-indigo-600','active'));
          btn.classList.add('border-indigo-500','text-indigo-600','active');

          const tab = btn.getAttribute('data-tab');
          document.querySelectorAll('.erp-tab-content').forEach(sec => {
            if (sec.getAttribute('data-tab') === tab) {
              sec.classList.remove('hidden'); sec.classList.add('block');
            } else if (sec.classList.contains('erp-tab-content')) {
              sec.classList.add('hidden'); sec.classList.remove('block');
            }
          });

          // If students tab opened, refresh data
          if (tab === 'students') {
            loadDataForAllTables();
          }
        });
      });

      // ---------- Modal open/close ----------
      const openModalBtn = document.getElementById('openRegistrationModal');
      const closeModalBtn = document.getElementById('closeModal');
      const modal = document.getElementById('registrationModal');
      const form = document.getElementById('registrationForm');
      const registerBtn = document.getElementById('registerBtn');

      if (openModalBtn && closeModalBtn && modal) {
        openModalBtn.addEventListener('click', () => {
          const adm = document.getElementById('admissionNumber');
          if (adm) adm.value = `AUTO-${Date.now()}`;
          modal.style.display = 'block';
        });
        closeModalBtn.addEventListener('click', () => {
          modal.style.display = 'none';
          form.reset();
          registerBtn.disabled = true;
        });
        window.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
            form.reset();
            registerBtn.disabled = true;
          }
        });
      }

      // ---------- Required fields & enabling register button ----------
      const requiredFields = [
        'firstName', 'lastName', 'gender', 'dob',
        'schoolName', 'classLevel', 'academicYear', 'boardingStatus',
        'primaryParentName', 'primaryParentContact', 'residentialAddress',
        'feePerYear', 'paymentPlan'
      ];
      const requiredFiles = ['passportPhoto', 'birthCertUpload', 'reportCardUpload', 'joiningLetterUpload'];

      function checkFormValidity() {
        const fieldsOk = requiredFields.every(id => {
          const el = document.getElementById(id);
          return el && String(el.value || '').trim() !== '';
        });
        const filesOk = requiredFiles.every(id => {
          const el = document.getElementById(id);
          return el && el.files && el.files.length > 0;
        });
        registerBtn.disabled = !(fieldsOk && filesOk);
      }
      requiredFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', checkFormValidity);
      });
      requiredFiles.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', checkFormValidity);
      });
      registerBtn.disabled = true;

      // ---------- Registration submit ----------
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          registerBtn.disabled = true;

          const fd = new FormData(form);
          const studentData = {
            firstName: fd.get('firstName'),
            middleName: fd.get('middleName') || '',
            lastName: fd.get('lastName'),
            gender: fd.get('gender'),
            dob: fd.get('dob'),
            admissionNumber: `AUTO-${Date.now()}`,
            pupilId: fd.get('pupilId') || '',
            birthCertNumber: fd.get('birthCertNumber') || '',
            religion: fd.get('religion') || '',
            tribe: fd.get('tribe') || '',
            schoolName: fd.get('schoolName'),
            classLevel: fd.get('classLevel'),
            stream: fd.get('stream') || '',
            academicYear: fd.get('academicYear'),
            academicTrack: fd.get('academicTrack') || '',
            boardingStatus: fd.get('boardingStatus'),
            shiftedFrom: fd.get('shiftedFrom') || '',
            primaryParentName: fd.get('primaryParentName'),
            primaryParentContact: fd.get('primaryParentContact'),
            secondaryGuardian: fd.get('secondaryGuardian') || '',
            relationshipToStudent: fd.get('relationshipToStudent') || '',
            residentialAddress: fd.get('residentialAddress'),
            employmentStatus: fd.get('employmentStatus') || '',
            feePerYear: Number(fd.get('feePerYear') || 0),
            paymentPlan: fd.get('paymentPlan'),
            timestamp: firebase.database.ServerValue.TIMESTAMP
          };

          try {
            // Duplicate check by parent contact + name + DOB + class (light)
            let duplicate = false;
            if (db) {
              const snap = await db.ref('students').orderByChild('primaryParentContact')
                .equalTo(studentData.primaryParentContact).once('value');
              snap.forEach(child => {
                const s = child.val();
                if (s.firstName === studentData.firstName &&
                    s.lastName === studentData.lastName &&
                    s.dob === studentData.dob &&
                    s.classLevel === studentData.classLevel) duplicate = true;
              });
            }
            if (duplicate) {
              alert("Duplicate student detected (same name, DOB, class & parent contact).");
              registerBtn.disabled = false;
              return;
            }

            // Create record
            const newRef = db ? db.ref('students').push() : null;
            if (!newRef) throw new Error('Database not available');

            await newRef.set(studentData);

            // Upload files to Storage (if available)
            const fileIds = ['passportPhoto','birthCertUpload','reportCardUpload','joiningLetterUpload','medicalDocsUpload'];
            const uploads = [];
            for (const id of fileIds) {
              const el = document.getElementById(id);
              if (el && el.files && el.files.length > 0) {
                if (!storage) {
                  console.warn('Storage not available; skipping file upload for', id);
                  continue;
                }
                const file = el.files[0];
                const path = `students/${newRef.key}/${id}/${Date.now()}_${file.name}`;
                const sref = storage.ref(path);
                await sref.put(file);
                const url = await sref.getDownloadURL();
                uploads.push({ [id]: url });
              }
            }
            if (uploads.length) {
              const updateData = Object.assign({}, ...uploads);
              await newRef.update(updateData);
            }

            alert('✅ Student registered successfully!');
            modal.style.display = 'none';
            form.reset();
            registerBtn.disabled = true;
            // If students tab is open, refresh immediately
            const activeTab = document.querySelector('.erp-tab.active');
            if (activeTab && activeTab.getAttribute('data-tab') === 'students') {
              loadDataForAllTables();
            }
          } catch (err) {
            console.error(err);
            alert('❌ Error registering student: ' + (err.message || err));
          } finally {
            registerBtn.disabled = true;
          }
        });
      }

      // ---------- Load students for Students List / Reports / Report Forms ----------
      async function loadDataForAllTables() {
        if (!db) return;
        try {
          const snap = await db.ref('students').once('value');
          const raw = snap.val() || {};
          const entries = Object.entries(raw); // [ [key, student], ... ]

          // Student List table
          const classFilter = document.getElementById('student-list-class').value || '';
          const studentListBody = document.getElementById('studentListBody');
          studentListBody.innerHTML = '';
          entries.forEach(([key, s]) => {
            if (classFilter && s.classLevel !== classFilter) return;
            const tr = document.createElement('tr');
            const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
            const dateReg = s.timestamp ? new Date(s.timestamp).toLocaleDateString() : (s.timestamp === undefined && s.createdAt ? new Date(s.createdAt).toLocaleDateString() : 'N/A');
            tr.innerHTML = `
              <td>${s.admissionNumber || 'N/A'}</td>
              <td>${escapeHtml(fullName)}</td>
              <td>${escapeHtml(s.classLevel || 'N/A')}</td>
              <td>${escapeHtml(dateReg)}</td>
              <td><img src="${escapeHtml(s.passportPhoto || s.passportPhotoURL || 'https://via.placeholder.com/50')}" alt="photo" style="width:50px;height:50px;object-fit:cover;border-radius:4px"/></td>
              <td>${escapeHtml(s.primaryParentContact || 'N/A')}</td>
              <td>${escapeHtml(String(s.feePerYear || 0))}</td>
              <td>${escapeHtml(s.paymentPlan || 'N/A')}</td>
              <td><button class="py-1 px-2 border rounded text-indigo-600" onclick="viewDetails('${key}')"><i class="fas fa-eye"></i></button></td>
            `;
            studentListBody.appendChild(tr);
          });

          // School Reports table & Report Forms table share similar data
          const schoolReportBody = document.getElementById('schoolReportBody');
          const reportFormBody = document.getElementById('reportFormBody');
          schoolReportBody.innerHTML = '';
          reportFormBody.innerHTML = '';
          entries.forEach(([key, s], idx) => {
            const rowHtml = `
              <td>${s.admissionNumber || 'N/A'}</td>
              <td>${escapeHtml((s.firstName || '') + ' ' + (s.lastName || ''))}</td>
              <td>${escapeHtml(s.classLevel || 'N/A')}</td>
              <td>${escapeHtml(s.primaryParentContact || 'N/A')}</td>
              <td>${escapeHtml(String(s.feePerYear || 0))}</td>
              <td>${escapeHtml(String(s.paidAmount || 0))}</td>
              <td>${escapeHtml(String(s.debt || 0))}</td>
            `;
            const tr1 = document.createElement('tr'); tr1.innerHTML = rowHtml;
            const tr2 = document.createElement('tr'); tr2.innerHTML = rowHtml;
            schoolReportBody.appendChild(tr1);
            reportFormBody.appendChild(tr2);
          });

        } catch (err) {
          console.error('Error loading students:', err);
        }
      }

      // Class filter event
      const studentListClassEl = document.getElementById('student-list-class');
      if (studentListClassEl) studentListClassEl.addEventListener('change', () => loadDataForAllTables());

      // ---------- Details modal helpers (exposed globally for onclick in markup) ----------
      window.viewDetails = async function (key) {
        if (!db) return alert('DB not ready');
        try {
          const snap = await db.ref('students/' + key).once('value');
          const s = snap.val() || {};
          const details = document.getElementById('studentDetails');
          const fullName = `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.trim();
          details.innerHTML = `
            <p><strong>Full Name:</strong> ${escapeHtml(fullName)}</p>
            <p><strong>Class:</strong> ${escapeHtml(s.classLevel || 'N/A')}</p>
            <p><strong>Date of Registration:</strong> ${s.timestamp ? new Date(s.timestamp).toLocaleDateString() : 'N/A'}</p>
            <p><strong>Passport Photo:</strong><br/><img src="${escapeHtml(s.passportPhoto || s.passportPhotoURL || 'https://via.placeholder.com/120')}" alt="photo" style="width:120px;height:120px;object-fit:cover;border-radius:6px"/></p>
            <p><strong>Parent Contact:</strong> ${escapeHtml(s.primaryParentContact || 'N/A')}</p>
            <p><strong>Fee Total:</strong> ${escapeHtml(String(s.feePerYear || 0))}</p>
            <p><strong>Payment Plan:</strong> ${escapeHtml(s.paymentPlan || 'N/A')}</p>
            <p><strong>Residential Address:</strong> ${escapeHtml(s.residentialAddress || 'N/A')}</p>
            <p><strong>Admission Number:</strong> ${escapeHtml(s.admissionNumber || 'N/A')}</p>
          `;
          // prepare ID generation
          document.getElementById('generateIDCard').onclick = () => generateIDCard(s);
          document.getElementById('detailsModal').style.display = 'block';
        } catch (err) {
          console.error('Error fetching details:', err);
        }
      };

      document.getElementById('closeDetailsModal').addEventListener('click', () => {
        document.getElementById('detailsModal').style.display = 'none';
      });

      // ---------- PDF & CSV generation ----------
      function generateIDCard(student) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text('Student ID Card', 105, 20, { align: 'center' });
        doc.setFontSize(11);
        doc.text(`Full Name: ${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`, 14, 40);
        doc.text(`Admission No: ${student.admissionNumber || 'N/A'}`, 14, 50);
        doc.text(`Class: ${student.classLevel || 'N/A'}`, 14, 60);
        doc.text(`Parent Contact: ${student.primaryParentContact || 'N/A'}`, 14, 70);
        if (student.passportPhoto) {
          // try to add image (needs data URL or URL with CORS)
          try {
            doc.addImage(student.passportPhoto, 'JPEG', 150, 40, 40, 40);
          } catch (err) {
            console.warn('Could not add passport image to PDF (CORS / format)', err);
          }
        }
        doc.save('student-id-card.pdf');
      }

      async function downloadCSVforTab(tab) {
        if (!db) return alert('DB not ready');
        const snap = await db.ref('students').once('value');
        const students = snap.val() || {};
        const arr = Object.values(students).map(s => {
          return {
            'Admission No': s.admissionNumber || 'N/A',
            'Full Name': `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim(),
            'Class': s.classLevel || 'N/A',
            'Date of Registration': s.timestamp ? new Date(s.timestamp).toLocaleDateString() : 'N/A',
            'Parent Contact': s.primaryParentContact || 'N/A',
            'Fee Total': s.feePerYear || 0,
            'Payment Plan': s.paymentPlan || 'N/A'
          };
        });
        if (arr.length === 0) return alert('No data to download');
        const ws = XLSX.utils.json_to_sheet(arr);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, tab);
        XLSX.writeFile(wb, `${tab}.xlsx`);
      }

      async function downloadPDFforTab(tab) {
        if (!db) return alert('DB not ready');
        const snap = await db.ref('students').once('value');
        const students = snap.val() || {};
        const rows = Object.values(students).map(s => [
          s.admissionNumber || 'N/A',
          `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim(),
          s.classLevel || 'N/A',
          s.timestamp ? new Date(s.timestamp).toLocaleDateString() : 'N/A',
          s.primaryParentContact || 'N/A',
          s.feePerYear || 0,
          s.paymentPlan || 'N/A'
        ]);
        if (rows.length === 0) return alert('No data to download');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });
        doc.setFontSize(14);
        doc.text(`${tab} Report`, 14, 10);
        doc.autoTable({
          head: [['Admission No','Full Name','Class','Date of Registration','Parent Contact','Fee Total','Payment Plan']],
          body: rows,
          startY: 18,
          styles: { fontSize: 8 }
        });
        doc.save(`${tab}.pdf`);
      }

      // Buttons for downloads
      document.getElementById('downloadCsvBtn').addEventListener('click', () => downloadCSVforTab('student-list'));
      document.getElementById('downloadPdfBtn').addEventListener('click', () => downloadPDFforTab('student-list'));

      document.getElementById('schoolDownloadCsv').addEventListener('click', () => downloadCSVforTab('school-reports'));
      document.getElementById('schoolDownloadPdf').addEventListener('click', () => downloadPDFforTab('school-reports'));

      document.getElementById('reportDownloadCsv').addEventListener('click', () => downloadCSVforTab('report-forms'));
      document.getElementById('reportDownloadPdf').addEventListener('click', () => downloadPDFforTab('report-forms'));

      // Utility: escape HTML
      function escapeHtml(text) {
        if (text === undefined || text === null) return '';
        return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
      }

      // Initialise: if Students tab selected by default, load data
      // (default active tab is Admissions; data loads when Students is opened)
      // But we'll still run a small test write if db exists to ensure connectivity (non-destructive)
      if (db) {
        db.ref('z_test_write').set({ ok: true, ts: Date.now() })
          .then(() => console.log('DB test write OK'))
          .catch(err => console.warn('DB test write failed (ok if rules block):', err.message));
      }

      // Expose load function for manual refresh if needed
      window.loadDataForAllTables = loadDataForAllTables;
    })();
  </script>

</body>
</html>