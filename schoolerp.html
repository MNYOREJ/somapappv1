<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SoMAp — School ERP</title>

    <!-- Icons + Tailwind -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: Inter, system-ui, Arial; background:#f8fafc; color:#0f172a; }
        .modal { display:none; position:fixed; inset:0; width:100%; height:100%;
                background-color: rgba(0,0,0,0.5); z-index:1000; }
        .modal-content { position:relative; background:#fff; margin:0 auto; padding:20px;
          border-radius:10px; width:95%; max-width:920px; height:90vh; overflow-y:auto; margin-top:20px; }
        .close { position:absolute; top:10px; right:16px; font-size:24px; cursor:pointer; }
        .tab-btn { transition: all .15s; }
        .tab-btn.active { color:#4f46e5; border-bottom-color:#4f46e5; }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:8px; border:1px solid #e6e9ef; text-align:left; font-size:13px; }
        thead th { background:#eef2ff; color:#0b69ff; }
        .hidden { display:none !important; }
        .block { display:block !important; }
        .student-card { background:#fff; border:1px solid #e6e9ef; border-radius:8px; padding:10px; margin-bottom:10px; }
        .hint { font-size:12px; color:#6b7280; }
        .btn { display:inline-flex; align-items:center; gap:8px; padding:.5rem .85rem; border-radius:.5rem; }
    </style>
</head>
<body class="bg-gray-50 p-4">

    <div class="mb-4">
        <div class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm mb-4">
            Manage all academic and administrative aspects of your school with SoMAp ERP.
        </div>

        <!-- Top Tabs -->
        <div class="flex flex-wrap border-b mb-4 gap-2">
            <button class="erp-tab tab-btn px-4 py-2 font-medium border-b-2 border-indigo-500 text-indigo-600 active"
                    data-tab="admissions">Admissions</button>

            <a href="academic.html"
              class="btn bg-white shadow rounded-lg hover:bg-gray-50 transition">
                <i class="fa-solid fa-graduation-cap"></i>
                <span>Academics</span>
            </a>

            <button class="erp-tab tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700"
                    data-tab="attendance">Attendance</button>

            <button class="erp-tab tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700"
                    data-tab="discipline">Discipline</button>

            <button class="erp-tab tab-btn px-4 py-2 font-medium text-gray-500 hover:text-gray-700"
                    data-tab="students">Students List</button>
        </div>

        <!-- Admissions tab -->
        <div class="erp-tab-content active block bg-white rounded-lg shadow p-4" data-tab="admissions">
            <div class="space-y-4">
                <div>
                    <h3 class="font-medium text-gray-800">New Applications</h3>
                    <p class="text-sm text-gray-500 mb-3">Review and process new student applications.</p>
                    <div class="flex justify-between">
                        <span class="text-sm font-medium text-green-600">12 new applications</span>
                        <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
                    </div>
                </div>

                <div>
                    <h3 class="font-medium text-gray-800">Quick Admission</h3>
                    <p class="text-sm text-gray-500 mb-3">Register a new student directly.</p>
                    <button id="openRegistrationModal"
                            class="w-full md:w-1/2 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Create New Admission
                    </button>
                    <p class="hint mt-2">Admission number auto-fills when the form opens.</p>
                </div>

                <div>
                    <h3 class="font-medium text-gray-800">Transfer Requests</h3>
                    <p class="text-sm text-gray-500 mb-2">Students requesting transfer in/out</p>
                    <div class="flex justify-between">
                        <span class="text-sm font-medium text-yellow-600">3 pending requests</span>
                        <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance tab (placeholder) -->
        <div class="erp-tab-content hidden bg-white rounded-lg shadow p-4" data-tab="attendance">
            <h3 class="font-medium text-gray-800 mb-2">Attendance</h3>
            <p class="text-sm text-gray-500">Attendance features coming soon.</p>
        </div>

        <!-- Discipline tab (placeholder) -->
        <div class="erp-tab-content hidden bg-white rounded-lg shadow p-4" data-tab="discipline">
            <h3 class="font-medium text-gray-800 mb-2">Discipline</h3>
            <p class="text-sm text-gray-500">Discipline features coming soon.</p>
        </div>

        <!-- Students List tab -->
        <div class="erp-tab-content hidden bg-white rounded-lg shadow p-4" data-tab="students">
            <h3 class="font-medium text-gray-800">Student List</h3>
            <p class="text-sm text-gray-500 mb-3">Filter by class and download the list.</p>

            <div class="mb-3 md:flex md:items-center md:gap-3">
                <select id="student-list-class" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
                    <option value="">All Classes</option>
                    <option>Baby Class</option>
                    <option>Class 1</option>
                    <option>Class 2</option>
                    <option>Class 3</option>
                    <option>Class 4</option>
                    <option>Class 5</option>
                    <option>Class 6</option>
                    <option>Class 7</option>
                </select>

                <div class="ml-auto flex gap-2">
                    <button id="downloadCsvBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fa-solid fa-file-csv"></i> Download CSV
                    </button>
                    <button id="downloadPdfBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fa-solid fa-file-pdf"></i> Download PDF
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table id="student-list-table" class="min-w-full text-sm">
                    <thead>
                        <tr>
                            <th>Admission No</th>
                            <th>Full Name</th>
                            <th>Class</th>
                            <th>Date of Registration</th>
                            <th>Passport Photo</th>
                            <th>Parent Contact</th>
                            <th>Fee Total</th>
                            <th>Payment Plan</th>
                            <th>View</th>
                        </tr>
                    </thead>
                    <tbody id="studentListBody">
                        <!-- filled by JS -->
                    </tbody>
                </table>
            </div>

            <hr class="my-6">

            <h3 class="font-medium text-gray-800 mt-4">School Reports</h3>
            <p class="text-sm text-gray-500 mb-3">Download reports per school, class, month, term, year.</p>

            <div class="mb-3 md:flex md:items-center md:gap-3">
                <select id="school-report-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
                    <option value="per-school">Per School</option>
                    <option value="per-class">Per Class</option>
                    <option value="per-month">Per Month</option>
                    <option value="per-term">Per Term</option>
                    <option value="per-year">Per Year</option>
                </select>
                <div class="ml-auto flex gap-2">
                    <button id="schoolDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fa-solid fa-file-csv"></i> Download CSV
                    </button>
                    <button id="schoolDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fa-solid fa-file-pdf"></i> Download PDF
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table id="school-report-table" class="min-w-full text-sm">
                    <thead>
                        <tr>
                            <th>Admission No</th>
                            <th>Full Name</th>
                            <th>Class</th>
                            <th>Parents Contact</th>
                            <th>Fee Per Year</th>
                            <th>Paid Amount</th>
                            <th>Debt</th>
                        </tr>
                    </thead>
                    <tbody id="schoolReportBody"></tbody>
                </table>
            </div>

            <hr class="my-6">

            <h3 class="font-medium text-gray-800 mt-4">Report Forms</h3>
            <p class="text-sm text-gray-500 mb-3">Download report forms with student details.</p>

            <div class="mb-3 md:flex md:items-center md:gap-3">
                <select id="report-form-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
                    <option value="per-student">Per Student</option>
                    <option value="per-class">Per Class</option>
                    <option value="per-term">Per Term</option>
                </select>
                <div class="ml-auto flex gap-2">
                    <button id="reportDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fa-solid fa-file-csv"></i> Download CSV
                    </button>
                    <button id="reportDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fa-solid fa-file-pdf"></i> Download PDF
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table id="report-form-table" class="min-w-full text-sm">
                    <thead>
                        <tr>
                            <th>Admission No</th>
                            <th>Full Name</th>
                            <th>Class</th>
                            <th>Parents Contact</th>
                            <th>Fee Per Year</th>
                            <th>Paid Amount</th>
                            <th>Debt</th>
                        </tr>
                    </thead>
                <tbody id="reportFormBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <span id="closeModal" class="close" title="Close">&times;</span>
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Student Registration</h2>
            
            <!-- Status message area -->
            <div id="statusMessage" class="hidden text-center text-sm font-medium py-2 rounded-lg mb-4"></div>

            <form id="registrationForm" enctype="multipart/form-data" novalidate class="space-y-4">
                <!-- BASIC INFO -->
                <div class="section">
                    <h3 class="font-semibold">Basic Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="firstName" class="block text-sm text-gray-600">First Name *</label>
                            <input type="text" id="firstName" name="firstName" required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="middleName" class="block text-sm text-gray-600">Middle Name</label>
                            <input type="text" id="middleName" name="middleName" class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="lastName" class="block text-sm text-gray-600">Last Name *</label>
                            <input type="text" id="lastName" name="lastName" required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="gender" class="block text-sm text-gray-600">Gender *</label>
                            <select id="gender" name="gender" required class="border p-2 rounded w-full">
                                <option value="" disabled selected>Select gender</option>
                                <option>Male</option>
                                <option>Female</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="dob" class="block text-sm text-gray-600">Date of Birth *</label>
                            <input type="date" id="dob" name="dob" required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="admissionNumber" class="block text-sm text-gray-600">Admission Number (Auto-generated)</label>
                            <input type="text" id="admissionNumber" name="admissionNumber" readonly class="border p-2 rounded w-full"/>
                        </div>

                        <!-- Fee fields -->
                        <div>
                            <label for="feePerYear" class="block text-sm text-gray-600">Fee Per Year (Tsh) *</label>
                            <input type="number" id="feePerYear" name="feePerYear" placeholder="e.g., 600000" required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="paymentPlan" class="block text-sm text-gray-600">Payment Plan *</label>
                            <select id="paymentPlan" name="paymentPlan" required class="border p-2 rounded w-full">
                                <option value="">-- Select Payment Plan --</option>
                                <option value="monthly">Monthly (Jan–Oct)</option>
                                <option value="6-instalments">6 Instalments</option>
                                <option value="2-instalments">2 Instalments</option>
                                <option value="yearly">Full Year at Once</option>
                                <option value="other">Other (as agreed)</option>
                            </select>
                        </div>

                        <div>
                            <label for="pupilId" class="block text-sm text-gray-600">Pupil’s ID</label>
                            <input type="text" id="pupilId" name="pupilId" placeholder="Pupil's ID" class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="birthCertNumber" class="block text-sm text-gray-600">Birth Certificate Number</label>
                            <input type="text" id="birthCertNumber" name="birthCertNumber" class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="religion" class="block text-sm text-gray-600">Religion</label>
                            <input type="text" id="religion" name="religion" class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="tribe" class="block text-sm text-gray-600">Tribe / Ethnicity</label>
                            <input type="text" id="tribe" name="tribe" class="border p-2 rounded w-full"/>
                        </div>
                    </div>
                </div>

                <!-- SCHOOL INFO -->
                <div class="section">
                    <h3 class="font-semibold">School Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="schoolName" class="block text-sm text-gray-600">School Name *</label>
                            <input type="text" id="schoolName" name="schoolName" required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="classLevel" class="block text-sm text-gray-600">Class Level *</label>
                            <select id="classLevel" name="classLevel" required class="border p-2 rounded w-full">
                                <option value="" disabled selected>Select class</option>
                                <option>Baby Class</option>
                                <option>Class 1</option>
                                <option>Class 2</option>
                                <option>Class 3</option>
                                <option>Class 4</option>
                                <option>Class 5</option>
                                <option>Class 6</option>
                                <option>Class 7</option>
                            </select>
                        </div>
                        <div>
                            <label for="stream" class="block text-sm text-gray-600">Stream</label>
                            <input type="text" id="stream" name="stream" placeholder="e.g., 4B" class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="academicYear" class="block text-sm text-gray-600">Current Academic Year *</label>
                            <input type="text" id="academicYear" name="academicYear" placeholder="e.g., 2025" required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="academicTrack" class="block text-sm text-gray-600">Academic Track</label>
                            <input type="text" id="academicTrack" name="academicTrack" placeholder="e.g., NECTA / SFNA" class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="boardingStatus" class="block text-sm text-gray-600">Boarding or Day Scholar *</label>
                            <select id="boardingStatus" name="boardingStatus" required class="border p-2 rounded w-full">
                                <option value="" disabled selected>Select status</option>
                                <option>Boarding</option>
                                <option>Day Scholar</option>
                            </select>
                        </div>
                        <div>
                            <label for="shiftedFrom" class="block text-sm text-gray-600">Shifted From (for transfer-ins)</label>
                            <input type="text" id="shiftedFrom" name="shiftedFrom" class="border p-2 rounded w-full"/>
                        </div>
                    </div>
                </div>

                <!-- PARENT/GUARDIAN -->
                <div class="section">
                    <h3 class="font-semibold">Parent / Guardian Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="primaryParentName" class="block text-sm text-gray-600">Primary Parent Name *</label>
                            <input type="text" id="primaryParentName" name="primaryParentName" required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="primaryParentContact" class="block text-sm text-gray-600">Primary Parent Contact *</label>
                            <input type="text" id="primaryParentContact" name="primaryParentContact" placeholder="+255 7xx xxx xxx"
                              required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="secondaryGuardian" class="block text-sm text-gray-600">Secondary Guardian (if any)</label>
                            <input type="text" id="secondaryGuardian" name="secondaryGuardian" class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="relationshipToStudent" class="block text-sm text-gray-600">Relationship to Student</label>
                            <input type="text" id="relationshipToStudent" name="relationshipToStudent" class="border p-2 rounded w-full"/>
                        </div>
                        <div class="md:col-span-2">
                            <label for="residentialAddress" class="block text-sm text-gray-600">Residential Address *</label>
                            <textarea id="residentialAddress" name="residentialAddress" required class="border p-2 rounded w-full"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="employmentStatus" class="block text-sm text-gray-600">Employment Status (if needed)</label>
                            <input type="text" id="employmentStatus" name="employmentStatus" class="border p-2 rounded w-full"/>
                        </div>
                    </div>
                </div>

                <!-- FILES -->
                <div class="section">
                    <h3 class="font-semibold">Photos & Attachments</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="passportPhoto" class="block text-sm text-gray-600">Passport Photo Upload *</label>
                            <input type="file" id="passportPhoto" name="passportPhoto" accept="image/*" required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="birthCertUpload" class="block text-sm text-gray-600">Birth Certificate Upload *</label>
                            <input type="file" id="birthCertUpload" name="birthCertUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="reportCardUpload" class="block text-sm text-gray-600">Report Card (First Term, Ongoing) *</label>
                            <input type="file" id="reportCardUpload" name="reportCardUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"/>
                        </div>
                        <div>
                            <label for="joiningLetterUpload" class="block text-sm text-gray-600">Joining or Transfer Letter (PDF/Image) *</label>
                            <input type="file" id="joiningLetterUpload" name="joiningLetterUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"/>
                        </div>
                        <div class="md:col-span-2">
                            <label for="medicalDocsUpload" class="block text-sm text-gray-600">Medical Documents (if applicable)</label>
                            <input type="file" id="medicalDocsUpload" name="medicalDocsUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
                        </div>
                    </div>
                </div>

                <button type="submit" id="registerBtn"
                        class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    Register Student
                </button>
            </form>

            <!-- Quick search (live) -->
            <div class="mt-8">
                <h3 class="font-semibold">Search Students</h3>
                <input type="text" id="search-box" placeholder="Search by name or ID"
                      class="border p-2 rounded w-64 mt-2"/>
                <div id="student-list" class="mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div id="detailsModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <span id="closeDetailsModal" class="close" title="Close">&times;</span>
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Student Details</h2>
            <div id="studentDetails" class="space-y-2"></div>
            <div class="mt-4">
                <button id="generateIDCard" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    Generate ID Card (PDF)
                </button>
            </div>
        </div>
    </div>

    <!-- Third-party libraries (CSV + PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase SDKs (compat) + your config -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <!-- If you want analytics, you can add firebase-analytics-compat as well -->
    <!-- You MUST ensure this file exists and contains your Firebase config and initialization. -->
    <!-- Example: const firebaseConfig = { ... }; firebase.initializeApp(firebaseConfig); window.db = firebase.database(); window.storage = firebase.storage(); -->
    <script src="firebase.js"></script> 

    <!-- Main App Logic -->
    <script>
        (function () {
            // ---- Resolve Firebase handles gracefully ----
            const db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
            const storage = window.storage || (window.firebase && firebase.storage ? firebase.storage() : null);

            if (!db) {
                console.error('Firebase Realtime Database not available. Ensure firebase.js and Firebase SDKs are loaded.');
            }
            if (!storage) {
                console.warn('Firebase Storage not available. File uploads will be skipped.');
            }

            // ---- Tabs show/hide ----
            document.querySelectorAll('.erp-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.erp-tab').forEach(b => b.classList.remove('border-indigo-500','text-indigo-600','active'));
                    btn.classList.add('border-indigo-500','text-indigo-600','active');

                    const tab = btn.getAttribute('data-tab');
                    document.querySelectorAll('.erp-tab-content').forEach(sec => {
                        const match = sec.getAttribute('data-tab') === tab;
                        sec.classList.toggle('hidden', !match);
                        sec.classList.toggle('block', match);
                    });

                    if (tab === 'students') {
                        renderAllTables(); // render with current cache + filter
                    }
                });
            });

            // ---- Modal open/close ----
            const openModalBtn = document.getElementById('openRegistrationModal');
            const closeModalBtn = document.getElementById('closeModal');
            const modal = document.getElementById('registrationModal');
            const form = document.getElementById('registrationForm');
            const registerBtn = document.getElementById('registerBtn');
            const statusMessageDiv = document.getElementById('statusMessage');

            if (openModalBtn) openModalBtn.addEventListener('click', () => {
                const adm = document.getElementById('admissionNumber');
                if (adm) adm.value = `AUTO-${Date.now()}`;
                modal.style.display = 'block';
                checkFormValidity();
                hideStatusMessage();
            });
            if (closeModalBtn) closeModalBtn.addEventListener('click', () => closeRegistrationModal());
            window.addEventListener('click', (e) => { if (e.target === modal) closeRegistrationModal(); });

            function closeRegistrationModal() {
                modal.style.display = 'none';
                form.reset();
                registerBtn.disabled = true;
                hideStatusMessage();
            }

            // ---- Status message functions (replaces alert()) ----
            /**
             * Displays a status message to the user.
             * @param {string} message The message to display.
             * @param {string} type The type of message ('success' or 'error').
             */
            function showStatusMessage(message, type) {
                statusMessageDiv.textContent = message;
                statusMessageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
                if (type === 'success') {
                    statusMessageDiv.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    statusMessageDiv.classList.add('bg-red-100', 'text-red-800');
                }
            }

            function hideStatusMessage() {
                statusMessageDiv.classList.add('hidden');
                statusMessageDiv.textContent = '';
            }

            // ---- Required fields -> enable/disable register ----
            const requiredFields = [
                'firstName', 'lastName', 'gender', 'dob',
                'schoolName', 'classLevel', 'academicYear', 'boardingStatus',
                'primaryParentName', 'primaryParentContact', 'residentialAddress',
                'feePerYear', 'paymentPlan'
            ];
            const requiredFiles = ['passportPhoto','birthCertUpload','reportCardUpload','joiningLetterUpload'];

            function checkFormValidity() {
                const fieldsOk = requiredFields.every(id => {
                    const el = document.getElementById(id);
                    return el && String(el.value || '').trim() !== '';
                });
                const filesOk = requiredFiles.every(id => {
                    const el = document.getElementById(id);
                    return el && el.files && el.files.length > 0;
                });
                registerBtn.disabled = !(fieldsOk && filesOk);
            }
            [...requiredFields, ...requiredFiles].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', checkFormValidity);
                if (el && el.type === 'file') el.addEventListener('change', checkFormValidity);
            });
            registerBtn.disabled = true;

            // ---- Utils ----
            function escapeHtml(text) {
                if (text === undefined || text === null) return '';
                return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
            }

            async function uploadIfPresent(inputId, destFolder, newKey) {
                const el = document.getElementById(inputId);
                if (!el || !el.files || el.files.length === 0 || !storage) {
                    console.warn(`Skipping upload for ${inputId}: Storage not available or no file selected.`);
                    return null;
                }
                const file = el.files[0];
                const path = `students/${newKey}/${destFolder}/${Date.now()}_${file.name}`;
                const sref = storage.ref(path);
                await sref.put(file);
                return sref.getDownloadURL();
            }

            // ---- Registration submit (COMPLETED LOGIC) ----
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    registerBtn.disabled = true;
                    showStatusMessage('Registering student, please wait...', 'info');

                    const fd = new FormData(form);
                    const studentData = {
                        firstName: fd.get('firstName'),
                        middleName: fd.get('middleName') || '',
                        lastName: fd.get('lastName'),
                        gender: fd.get('gender'),
                        dob: fd.get('dob'),
                        admissionNumber: document.getElementById('admissionNumber').value || `AUTO-${Date.now()}`,
                        pupilId: fd.get('pupilId') || '',
                        birthCertNumber: fd.get('birthCertNumber') || '',
                        religion: fd.get('religion') || '',
                        tribe: fd.get('tribe') || '',
                        schoolName: fd.get('schoolName'),
                        classLevel: fd.get('classLevel'),
                        stream: fd.get('stream') || '',
                        academicYear: fd.get('academicYear'),
                        academicTrack: fd.get('academicTrack') || '',
                        boardingStatus: fd.get('boardingStatus'),
                        shiftedFrom: fd.get('shiftedFrom') || '',
                        primaryParentName: fd.get('primaryParentName'),
                        primaryParentContact: fd.get('primaryParentContact'),
                        secondaryGuardian: fd.get('secondaryGuardian') || '',
                        relationshipToStudent: fd.get('relationshipToStudent') || '',
                        residentialAddress: fd.get('residentialAddress'),
                        employmentStatus: fd.get('employmentStatus') || '',
                        feePerYear: Number(fd.get('feePerYear') || 0),
                        paymentPlan: fd.get('paymentPlan'),
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    try {
                        if (!db) throw new Error('Database not available');

                        // Check for duplicate student
                        let duplicate = false;
                        const dupSnap = await db.ref('students')
                            .orderByChild('primaryParentContact')
                            .equalTo(studentData.primaryParentContact)
                            .once('value');
                        dupSnap.forEach(child => {
                            const s = child.val();
                            if (s &&
                                (s.firstName||'') === studentData.firstName &&
                                (s.lastName||'') === studentData.lastName &&
                                (s.dob||'') === studentData.dob &&
                                (s.classLevel||'') === studentData.classLevel) {
                                duplicate = true;
                            }
                        });
                        if (duplicate) {
                            showStatusMessage("❌ Duplicate student detected (same name, DOB, class & parent contact).", 'error');
                            registerBtn.disabled = false;
                            return;
                        }

                        // Create a new unique key for the student record
                        const newRef = db.ref('students').push();
                        const newKey = newRef.key;

                        // Upload files if storage is configured
                        const urls = {};
                        if (storage) {
                            showStatusMessage('Uploading files...', 'info');
                            urls.passportPhotoURL   = await uploadIfPresent('passportPhoto','passport', newKey);
                            urls.birthCertURL       = await uploadIfPresent('birthCertUpload','birth-cert', newKey);
                            urls.reportCardURL      = await uploadIfPresent('reportCardUpload','report-card', newKey);
                            urls.joiningLetterURL   = await uploadIfPresent('joiningLetterUpload','joining-letter', newKey);
                            urls.medicalDocsURL     = await uploadIfPresent('medicalDocsUpload','medical-docs', newKey);
                        } else {
                            console.warn("Firebase Storage not available. Files will not be uploaded.");
                        }
                        
                        // Set the data in the database with the new key
                        await newRef.set(Object.assign({ createdAt: firebase.database.ServerValue.TIMESTAMP }, studentData, urls));

                        showStatusMessage('✅ Student registered successfully!', 'success');
                        closeRegistrationModal();
                        renderAllTables(); // Refresh the student list table
                    } catch (err) {
                        console.error("Error registering student:", err);
                        showStatusMessage('❌ Error registering student: ' + (err.message || err), 'error');
                        registerBtn.disabled = false;
                    }
                });
            }

            // ---- Live cache + rendering ----
            let cachedStudents = []; // array of { key, ...data }
            const studentListBody = document.getElementById('studentListBody');

            if (db) {
                // Listen for data changes in real-time
                db.ref('students').on('value', (snapshot) => {
                    const raw = snapshot.val() || {};
                    cachedStudents = Object.entries(raw).map(([key, s]) => ({ key, ...s }));
                    // Update search list always
                    renderSearchList(cachedStudents);
                    // If Students tab is visible, render the tables
                    const activeTab = document.querySelector('.erp-tab.active');
                    if (activeTab && activeTab.getAttribute('data-tab') === 'students') {
                        renderAllTables();
                    }
                }, (error) => {
                    console.error("Firebase data listener error:", error);
                    studentListBody.innerHTML = `<tr><td colspan="9" class="text-center text-red-500">Error loading data. Check console for details.</td></tr>`;
                });
            }

            // ---- Students tab rendering ----
            function renderAllTables() {
                const classFilter = document.getElementById('student-list-class').value || '';
                const schoolReportBody = document.getElementById('schoolReportBody');
                const reportFormBody = document.getElementById('reportFormBody');
                
                if (!studentListBody || !schoolReportBody || !reportFormBody) return;

                studentListBody.innerHTML = '';
                schoolReportBody.innerHTML = '';
                reportFormBody.innerHTML = '';

                const filtered = cachedStudents.filter(s => !classFilter || s.classLevel === classFilter);

                filtered.forEach(s => {
                    const fullName = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.trim();
                    const dateReg = s.timestamp ? new Date(s.timestamp).toLocaleDateString() : 'N/A';
                    
                    // Render Student List Table
                    const listRow = document.createElement('tr');
                    listRow.innerHTML = `
                        <td>${escapeHtml(s.admissionNumber)}</td>
                        <td>${escapeHtml(fullName)}</td>
                        <td>${escapeHtml(s.classLevel)}</td>
                        <td>${escapeHtml(dateReg)}</td>
                        <td>
                            ${s.passportPhotoURL ? `<a href="${escapeHtml(s.passportPhotoURL)}" target="_blank" class="text-blue-500 hover:underline">View</a>` : 'N/A'}
                        </td>
                        <td>${escapeHtml(s.primaryParentContact)}</td>
                        <td>${(s.feePerYear || 0).toLocaleString()}</td>
                        <td>${escapeHtml(s.paymentPlan)}</td>
                        <td>
                            <button class="text-indigo-600 hover:text-indigo-900 view-details-btn" data-key="${s.key}">View</button>
                        </td>
                    `;
                    studentListBody.appendChild(listRow);

                    // Render School Reports Table (using dummy data for now)
                    const schoolReportRow = document.createElement('tr');
                    schoolReportRow.innerHTML = `
                        <td>${escapeHtml(s.admissionNumber)}</td>
                        <td>${escapeHtml(fullName)}</td>
                        <td>${escapeHtml(s.classLevel)}</td>
                        <td>${escapeHtml(s.primaryParentContact)}</td>
                        <td>${(s.feePerYear || 0).toLocaleString()}</td>
                        <td>${(Math.random() * s.feePerYear).toFixed(0).toLocaleString()}</td>
                        <td>${(s.feePerYear - Math.random() * s.feePerYear).toFixed(0).toLocaleString()}</td>
                    `;
                    schoolReportBody.appendChild(schoolReportRow);
                    
                    // Render Report Forms Table (using dummy data for now)
                    const reportFormRow = document.createElement('tr');
                    reportFormRow.innerHTML = `
                        <td>${escapeHtml(s.admissionNumber)}</td>
                        <td>${escapeHtml(fullName)}</td>
                        <td>${escapeHtml(s.classLevel)}</td>
                        <td>${escapeHtml(s.primaryParentContact)}</td>
                        <td>${(s.feePerYear || 0).toLocaleString()}</td>
                        <td>${(Math.random() * s.feePerYear).toFixed(0).toLocaleString()}</td>
                        <td>${(s.feePerYear - Math.random() * s.feePerYear).toFixed(0).toLocaleString()}</td>
                    `;
                    reportFormBody.appendChild(reportFormRow);
                });
            }

            // Listen for changes on the class filter
            const classFilterSelect = document.getElementById('student-list-class');
            if (classFilterSelect) {
                classFilterSelect.addEventListener('change', renderAllTables);
            }
            
            // ---- Search functionality ----
            const searchBox = document.getElementById('search-box');
            const studentListDiv = document.getElementById('student-list');

            function renderSearchList(students) {
                if (!searchBox || !studentListDiv) return;
                const query = searchBox.value.toLowerCase();
                studentListDiv.innerHTML = '';
                
                if (query.length < 2) return;

                const results = students.filter(s => 
                    (s.firstName && s.firstName.toLowerCase().includes(query)) ||
                    (s.lastName && s.lastName.toLowerCase().includes(query)) ||
                    (s.admissionNumber && s.admissionNumber.toLowerCase().includes(query))
                );

                if (results.length === 0) {
                    studentListDiv.innerHTML = `<p class="text-gray-500">No results found.</p>`;
                    return;
                }

                results.forEach(s => {
                    const card = document.createElement('div');
                    card.className = 'student-card cursor-pointer hover:bg-gray-50';
                    card.setAttribute('data-key', s.key);
                    const fullName = `${s.firstName} ${s.lastName}`;
                    card.innerHTML = `
                        <p class="font-medium text-gray-800">${escapeHtml(fullName)}</p>
                        <p class="text-sm text-gray-500">${escapeHtml(s.admissionNumber)} | Class: ${escapeHtml(s.classLevel)}</p>
                    `;
                    card.addEventListener('click', () => {
                        showStudentDetails(s.key);
                    });
                    studentListDiv.appendChild(card);
                });
            }

            if (searchBox) {
                searchBox.addEventListener('input', () => renderSearchList(cachedStudents));
            }
            
            // ---- Student Details Modal ----
            const detailsModal = document.getElementById('detailsModal');
            const closeDetailsBtn = document.getElementById('closeDetailsModal');
            const studentDetailsDiv = document.getElementById('studentDetails');
            
            if (closeDetailsBtn) {
                closeDetailsBtn.addEventListener('click', () => {
                    detailsModal.style.display = 'none';
                    studentDetailsDiv.innerHTML = '';
                });
            }

            window.addEventListener('click', (e) => {
                if (e.target === detailsModal) {
                    detailsModal.style.display = 'none';
                    studentDetailsDiv.innerHTML = '';
                }
            });

            // Handle both table view and search view "view" button/card clicks
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-details-btn')) {
                    const key = e.target.getAttribute('data-key');
                    if (key) showStudentDetails(key);
                }
            });

            function showStudentDetails(key) {
                const student = cachedStudents.find(s => s.key === key);
                if (!student) {
                    studentDetailsDiv.innerHTML = '<p class="text-red-500">Student not found.</p>';
                    detailsModal.style.display = 'block';
                    return;
                }

                const dob = student.dob ? new Date(student.dob).toLocaleDateString() : 'N/A';
                const registeredAt = student.timestamp ? new Date(student.timestamp).toLocaleString() : 'N/A';
                const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();

                const detailsHtml = `
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p><strong>Full Name:</strong> ${escapeHtml(fullName)}</p>
                        <p><strong>Admission No:</strong> ${escapeHtml(student.admissionNumber)}</p>
                        <p><strong>Class:</strong> ${escapeHtml(student.classLevel)}</p>
                        <p><strong>Date of Birth:</strong> ${escapeHtml(dob)}</p>
                        <p><strong>Gender:</strong> ${escapeHtml(student.gender)}</p>
                        <p><strong>Registered At:</strong> ${escapeHtml(registeredAt)}</p>
                    </div>
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p><strong>Parent Name:</strong> ${escapeHtml(student.primaryParentName)}</p>
                        <p><strong>Parent Contact:</strong> ${escapeHtml(student.primaryParentContact)}</p>
                        <p><strong>Address:</strong> ${escapeHtml(student.residentialAddress)}</p>
                    </div>
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p><strong>Fee Per Year:</strong> ${(student.feePerYear || 0).toLocaleString()} Tsh</p>
                        <p><strong>Payment Plan:</strong> ${escapeHtml(student.paymentPlan)}</p>
                        <p><strong>Passport Photo:</strong> ${student.passportPhotoURL ? `<a href="${escapeHtml(student.passportPhotoURL)}" target="_blank" class="text-blue-500 hover:underline">View Photo</a>` : 'N/A'}</p>
                        <p><strong>Birth Cert:</strong> ${student.birthCertURL ? `<a href="${escapeHtml(student.birthCertURL)}" target="_blank" class="text-blue-500 hover:underline">View Document</a>` : 'N/A'}</p>
                    </div>
                `;
                studentDetailsDiv.innerHTML = detailsHtml;
                detailsModal.style.display = 'block';
            }
            
            // ---- PDF/CSV Download Logic ----
            const downloadCsvBtn = document.getElementById('downloadCsvBtn');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            const schoolDownloadCsvBtn = document.getElementById('schoolDownloadCsv');
            const schoolDownloadPdfBtn = document.getElementById('schoolDownloadPdf');
            const reportDownloadCsvBtn = document.getElementById('reportDownloadCsv');
            const reportDownloadPdfBtn = document.getElementById('reportDownloadPdf');

            function downloadTable(tableId, format) {
                const table = document.getElementById(tableId);
                if (!table) return;

                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
                const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
                    return Array.from(tr.querySelectorAll('td')).map(td => {
                        const link = td.querySelector('a');
                        return link ? link.href : td.innerText.trim();
                    });
                });

                if (format === 'csv') {
                    const csv = Papa.unparse({ fields: headers, data: rows });
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.setAttribute('download', `${tableId}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else if (format === 'pdf') {
                    const doc = new jspdf.jsPDF();
                    doc.autoTable({
                        head: [headers],
                        body: rows,
                        startY: 10,
                        theme: 'grid',
                    });
                    doc.save(`${tableId}.pdf`);
                }
            }

            if (downloadCsvBtn) downloadCsvBtn.addEventListener('click', () => downloadTable('student-list-table', 'csv'));
            if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', () => downloadTable('student-list-table', 'pdf'));
            if (schoolDownloadCsvBtn) schoolDownloadCsvBtn.addEventListener('click', () => downloadTable('school-report-table', 'csv'));
            if (schoolDownloadPdfBtn) schoolDownloadPdfBtn.addEventListener('click', () => downloadTable('school-report-table', 'pdf'));
            if (reportDownloadCsvBtn) reportDownloadCsvBtn.addEventListener('click', () => downloadTable('report-form-table', 'csv'));
            if (reportDownloadPdfBtn) reportDownloadPdfBtn.addEventListener('click', () => downloadTable('report-form-table', 'pdf'));

            // Example for ID Card Generation (You can expand this)
            const generateIDCardBtn = document.getElementById('generateIDCard');
            if (generateIDCardBtn) {
                generateIDCardBtn.addEventListener('click', () => {
                    const doc = new jspdf.jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a7'
                    });
                    doc.text('Student ID Card', 10, 10);
                    // Add more details here
                    doc.save('ID_Card.pdf');
                });
            }

            // Initial rendering of the main table
            if (document.querySelector('.erp-tab.active')?.getAttribute('data-tab') === 'students') {
                renderAllTables();
            }

        })();
    </script>
</body>
</html>