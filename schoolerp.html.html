<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School ERP</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    .modal-content {
      position: relative;
      background-color: white;
      margin: 0 auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      height: 90vh;
      overflow-y: auto;
      margin-top: 20px;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
    }
    .section h3 {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 1rem;
      color: #4b5563;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #6b7280;
    }
  </style>
  <script src="firebase.js"></script>
</head>
<body class="bg-gray-50 p-4">
  <div class="mb-4">
    <div class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm mb-4">
      Manage all academic and administrative aspects of your school with our comprehensive ERP system.
    </div>
    <div class="flex border-b mb-4">
      <button class="erp-tab px-4 py-2 font-medium border-b-2 border-indigo-500 text-indigo-600 active" data-tab="admissions">Admissions</button>
      <a href="academic.html" class="block bg-white shadow rounded-lg p-4 hover:bg-gray-50 transition">
        <h2 class="text-lg font-semibold text-gray-700">Academics</h2>
        <p class="text-gray-500">Manage exams, results, and reports.</p>
      </a>
      <button class="erp-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="attendance">Attendance</button>
      <button class="erp-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700" data-tab="discipline">Discipline</button>
    </div>

    <!-- Admissions tab -->
    <div class="erp-tab-content active" data-tab="admissions">
      <div class="space-y-3">
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-medium text-gray-800">New Applications</h3>
          <p class="text-sm text-gray-500 mb-3">Review and process new student applications</p>
          <div class="flex justify-between">
            <span class="text-sm font-medium text-green-600">12 new applications</span>
            <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-medium text-gray-800">Quick Admission</h3>
          <p class="text-sm text-gray-500 mb-3">Register a new student directly</p>
          <button id="openRegistrationModal" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Create New Admission</button>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-medium text-gray-800">Transfer Requests</h3>
          <p class="text-sm text-gray-500 mb-2">Students requesting transfer in/out</p>
          <div class="flex justify-between">
            <span class="text-sm font-medium text-yellow-600">3 pending requests</span>
            <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal">
      <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Student Registration</h2>
        <form id="registrationForm" enctype="multipart/form-data" novalidate class="space-y-4">
          <div class="section">
            <h3>Basic Information</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="form-group"><label for="firstName">First Name *</label><input type="text" id="firstName" name="firstName" required class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="middleName">Middle Name</label><input type="text" id="middleName" name="middleName" class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="lastName">Last Name *</label><input type="text" id="lastName" name="lastName" required class="border p-2 rounded w-full"></div>
              <div class="form-group">
                <label for="gender">Gender *</label>
                <select id="gender" name="gender" required class="border p-2 rounded w-full">
                  <option value="" disabled selected>Select gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="form-group"><label for="dob">Date of Birth *</label><input type="date" id="dob" name="dob" required class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="admissionNumber">Admission Number (Auto-generated)</label><input type="text" id="admissionNumber" name="admissionNumber" disabled class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="feePerYear">Fee Per Year (Tsh)</label><input type="number" id="feePerYear" name="feePerYear" class="border p-2 rounded w-full" placeholder="e.g., 600000" required></div>
              <div class="form-group">
                <label for="paymentPlan">Payment Plan</label>
                <select id="paymentPlan" name="paymentPlan" class="border p-2 rounded w-full" required>
                  <option value="">-- Select Payment Plan --</option>
                  <option value="monthly">Monthly (Jan–Oct)</option>
                  <option value="6-instalments">6 Instalments</option>
                  <option value="2-instalments">2 Instalments</option>
                  <option value="yearly">Full Year at Once</option>
                  <option value="other">Other (as agreed)</option>
                </select>
              </div>
              <div class="form-group"><label for="pupilId">Pupil’s ID</label><input type="text" id="pupilId" name="pupilId" placeholder="Pupil's ID" class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="birthCertNumber">Birth Certificate Number</label><input type="text" id="birthCertNumber" name="birthCertNumber" placeholder="Birth Certificate Number" class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="religion">Religion</label><input type="text" id="religion" name="religion" placeholder="Religion" class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="tribe">Tribe / Ethnicity</label><input type="text" id="tribe" name="tribe" placeholder="Tribe or Ethnicity" class="border p-2 rounded w-full"></div>
            </div>
          </div>
          <div class="section">
            <h3>School Information</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="form-group"><label for="schoolName">School Name *</label><input type="text" id="schoolName" name="schoolName" placeholder="School Name" required class="border p-2 rounded w-full"></div>
              <div class="form-group">
                <label for="classLevel">Class Level *</label>
                <select id="classLevel" name="classLevel" required class="border p-2 rounded w-full">
                  <option value="" disabled selected>Select class</option>
                  <option value="Baby Class">Baby Class</option>
                  <option value="Class 1">Class 1</option>
                  <option value="Class 2">Class 2</option>
                  <option value="Class 3">Class 3</option>
                  <option value="Class 4">Class 4</option>
                  <option value="Class 5">Class 5</option>
                  <option value="Class 6">Class 6</option>
                  <option value="Class 7">Class 7</option>
                </select>
              </div>
              <div class="form-group"><label for="stream">Stream</label><input type="text" id="stream" name="stream" placeholder="e.g., 4B" class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="academicYear">Current Academic Year *</label><input type="text" id="academicYear" name="academicYear" placeholder="e.g., 2024" required class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="academicTrack">Academic Track</label><input type="text" id="academicTrack" name="academicTrack" placeholder="e.g., NECTA / SFNA" class="border p-2 rounded w-full"></div>
              <div class="form-group">
                <label for="boardingStatus">Boarding or Day Scholar *</label>
                <select id="boardingStatus" name="boardingStatus" required class="border p-2 rounded w-full">
                  <option value="" disabled selected>Select status</option>
                  <option value="Boarding">Boarding</option>
                  <option value="Day Scholar">Day Scholar</option>
                </select>
              </div>
              <div class="form-group"><label for="shiftedFrom">Shifted From (for transfer-ins)</label><input type="text" id="shiftedFrom" name="shiftedFrom" placeholder="Previous school if transferred" class="border p-2 rounded w-full"></div>
            </div>
          </div>
          <div class="section">
            <h3>Parent / Guardian Details</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="form-group"><label for="primaryParentName">Primary Parent Name *</label><input type="text" id="primaryParentName" name="primaryParentName" placeholder="Primary Parent or Guardian" required class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="primaryParentContact">Primary Parent Contact (Mobile, WhatsApp) *</label><input type="text" id="primaryParentContact" name="primaryParentContact" placeholder="+255 7xx xxx xxx" required class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="secondaryGuardian">Secondary Guardian (if any)</label><input type="text" id="secondaryGuardian" name="secondaryGuardian" placeholder="Secondary Guardian" class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="relationshipToStudent">Relationship to Student</label><input type="text" id="relationshipToStudent" name="relationshipToStudent" placeholder="e.g., Aunt, Uncle" class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="residentialAddress">Residential Address *</label><textarea id="residentialAddress" name="residentialAddress" placeholder="Residential Address" required class="border p-2 rounded w-full"></textarea></div>
              <div class="form-group"><label for="employmentStatus">Employment Status (if needed for bursary qualification)</label><input type="text" id="employmentStatus" name="employmentStatus" placeholder="Employment Status" class="border p-2 rounded w-full"></div>
            </div>
          </div>
          <div class="section">
            <h3>Photos & Attachments</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="form-group"><label for="passportPhoto">Passport Photo Upload *</label><input type="file" id="passportPhoto" name="passportPhoto" accept="image/*" required class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="birthCertUpload">Birth Certificate Upload *</label><input type="file" id="birthCertUpload" name="birthCertUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="reportCardUpload">Report Card (First Term, Ongoing) *</label><input type="file" id="reportCardUpload" name="reportCardUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="joiningLetterUpload">Joining or Transfer Letter (PDF/Image) *</label><input type="file" id="joiningLetterUpload" name="joiningLetterUpload" accept="image/*,application/pdf" required class="border p-2 rounded w-full"></div>
              <div class="form-group"><label for="medicalDocsUpload">Medical Documents (if applicable)</label><input type="file" id="medicalDocsUpload" name="medicalDocsUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"></div>
            </div>
          </div>
          <button type="submit" id="registerBtn" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" disabled>Register Student</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const openModalBtn = document.getElementById('openRegistrationModal');
      const closeModalBtn = document.getElementById('closeModal');
      const modal = document.getElementById('registrationModal');
      const form = document.getElementById('registrationForm');
      const registerBtn = document.getElementById('registerBtn');
      const requiredFields = [
        'firstName', 'lastName', 'gender', 'dob', 'schoolName', 'classLevel',
        'academicYear', 'boardingStatus', 'primaryParentName', 'primaryParentContact',
        'residentialAddress'
      ];
      const requiredFiles = ['passportPhoto', 'birthCertUpload', 'reportCardUpload', 'joiningLetterUpload'];

      // Modal toggle
      if (openModalBtn && closeModalBtn && modal) {
        openModalBtn.addEventListener('click', () => {
          modal.style.display = 'block';
        });

        closeModalBtn.addEventListener('click', () => {
          modal.style.display = 'none';
          form.reset();
          registerBtn.disabled = true;
        });

        window.addEventListener('click', (event) => {
          if (event.target === modal) {
            modal.style.display = 'none';
            form.reset();
            registerBtn.disabled = true;
          }
        });
      } else {
        console.error('One or more modal elements not found');
      }

      // Form validation
      function checkFormValidity() {
        const allFieldsValid = requiredFields.every(field => {
          const input = document.getElementById(field);
          return input && input.value.trim() !== '';
        });

        const allFilesValid = requiredFiles.every(file => {
          const input = document.getElementById(file);
          return input && input.files.length > 0;
        });

        if (registerBtn) registerBtn.disabled = !(allFieldsValid && allFilesValid);
      }

      requiredFields.forEach(field => {
        const input = document.getElementById(field);
        if (input) input.addEventListener('input', checkFormValidity);
      });

      requiredFiles.forEach(file => {
        const input = document.getElementById(file);
        if (input) input.addEventListener('change', checkFormValidity);
      });

      // Use firebase.js initialized db
      if (!window.db) {
        console.error('Firebase database not initialized. Ensure firebase.js is loaded and configured.');
        return;
      }
      const db = window.db;
      const storage = firebase.storage();

      // Form submission
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (registerBtn) registerBtn.disabled = true;

          const formData = new FormData(form);
          const studentData = {
            firstName: formData.get('firstName'),
            middleName: formData.get('middleName'),
            lastName: formData.get('lastName'),
            fullName: `${formData.get('firstName')} ${formData.get('lastName') || ''}`,
            gender: formData.get('gender'),
            dob: formData.get('dob'),
            admissionNumber: `ADM-${Date.now()}`,
            pupilId: formData.get('pupilId'),
            birthCertNumber: formData.get('birthCertNumber'),
            religion: formData.get('religion'),
            tribe: formData.get('tribe'),
            schoolName: formData.get('schoolName'),
            classLevel: formData.get('classLevel'),
            stream: formData.get('stream'),
            academicYear: formData.get('academicYear'),
            academicTrack: formData.get('academicTrack'),
            boardingStatus: formData.get('boardingStatus'),
            shiftedFrom: formData.get('shiftedFrom'),
            primaryParentName: formData.get('primaryParentName'),
            parentsContact: formData.get('primaryParentContact'),
            secondaryGuardian: formData.get('secondaryGuardian'),
            relationshipToStudent: formData.get('relationshipToStudent'),
            residentialAddress: formData.get('residentialAddress'),
            employmentStatus: formData.get('employmentStatus'),
            feePerYear: formData.get('feePerYear') || '0',
            paymentPlan: formData.get('paymentPlan') || 'N/A',
            paidAmount: formData.get('paidAmount') || '0',
            debt: (parseFloat(formData.get('feePerYear') || 0) - parseFloat(formData.get('paidAmount') || 0)).toFixed(2) || '0.00',
            timestamp: firebase.database.ServerValue.TIMESTAMP
          };

          try {
            const checkRef = db.ref('students');
            const snapshot = await checkRef.once('value');
            let isDuplicate = false;
            snapshot.forEach(childSnapshot => {
              const existingData = childSnapshot.val();
              if (existingData.firstName === studentData.firstName &&
                  existingData.lastName === studentData.lastName &&
                  existingData.dob === studentData.dob &&
                  existingData.primaryParentName === studentData.primaryParentName &&
                  existingData.parentsContact === studentData.parentsContact &&
                  existingData.classLevel === studentData.classLevel) {
                isDuplicate = true;
              }
            });
            if (isDuplicate) {
              alert('MNYORE DOESN\'T LIKE DUPLICATES');
              if (registerBtn) registerBtn.disabled = false;
              return;
            }

            const dbRef = db.ref('students');
            const newStudentRef = dbRef.push();
            await newStudentRef.set(studentData);

            const uploadPromises = requiredFiles.map(async fileId => {
              const fileInput = document.getElementById(fileId);
              if (fileInput && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const storageRef = storage.ref(`students/${newStudentRef.key}/${fileId}/${file.name}`);
                await storageRef.put(file);
                const downloadURL = await storageRef.getDownloadURL();
                return { [fileId]: downloadURL };
              }
              return {};
            });

            const uploadResults = await Promise.all(uploadPromises);
            const uploadData = Object.assign({}, ...uploadResults);
            await newStudentRef.update(uploadData);

            alert('Student registered successfully! Data is now available for download in Student List.');
            modal.style.display = 'none';
            form.reset();
            if (registerBtn) registerBtn.disabled = true;
          } catch (error) {
            console.error('Registration error:', error);
            alert('Error registering student: ' + error.message);
          } finally {
            if (registerBtn) registerBtn.disabled = false;
          }
        });
      }
    });
  </script>
</body>
</html>