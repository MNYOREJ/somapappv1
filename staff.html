<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoMAp - Teacher Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Global Styles - Professional, Colorful, Responsive Theme */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #007bff, #6610f2); /* Vibrant blue-purple gradient */
            min-height: 100vh;
            margin: 0;
            color: #fff;
            overflow: hidden;
        }
        .sidebar {
            background: linear-gradient(to bottom, #007bff, #6610f2);
            height: 100vh;
            padding: 20px;
            position: fixed;
            width: 64px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: width 0.3s ease;
            z-index: 10;
        }
        .sidebar-expanded .sidebar {
            width: 250px;
        }
        .sidebar-icon {
            position: relative;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            w-10 h-10 rounded-lg text-white mx-auto mb-4;
        }
        .sidebar-icon:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .sidebar-icon.active {
            background-color: #6610f2;
        }
        .sidebar-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s;
            z-index: 100;
            white-space: nowrap;
        }
        .sidebar-icon:hover .sidebar-tooltip {
            opacity: 1;
            transform: translateY(-50%) translateX(8px);
        }
        .sidebar-expanded .sidebar-icon {
            justify-content: flex-start;
            padding: 0 1rem;
        }
        .sidebar-expanded .sidebar-icon span {
            margin-left: 1rem;
        }
        .sidebar-expanded .sidebar-tooltip {
            display: none;
        }
        .main-content {
            margin-left: 64px;
            padding: 2rem;
            transition: margin-left 0.3s ease;
            overflow-y: auto;
            min-height: 100vh;
        }
        .sidebar-expanded .main-content {
            margin-left: 250px;
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s;
            background: linear-gradient(135deg, #ffffff, #e5e7eb); /* Light gradient for cards */
            color: #000;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .stat-card {
            background: linear-gradient(135deg, #20c997, #0dcaf0); /* Teal gradient for stats */
            color: #fff;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-card h5 {
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .stat-card p {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .events-list {
            list-style: none;
            padding: 0;
        }
        .events-list li {
            background: #f8f9fa;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .events-list li:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .chart-container {
            background: #fff;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .form-control {
            border-radius: 0.75rem;
            border: 1px solid #dadce0;
            padding: 0.5rem;
            width: 100%;
            margin-bottom: 1rem;
            background: #fff;
            color: #000;
        }
        .form-label {
            font-weight: bold;
            color: #fff;
            margin-bottom: 0.5rem;
            display: block;
        }
        .hidden {
            display: none;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            border: none;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        /* Modal for Full Page Embed */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 95%;
            height: 95%;
            border-radius: 1rem;
            overflow: hidden;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* Additional Styles for Beauty and Responsiveness */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .main-content {
                margin-left: 0;
            }
            .grid {
                grid-template-columns: 1fr;
            }
            .table {
                font-size: 0.875rem;
            }
            .chart-container {
                height: 300px;
            }
        }
        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hover-scale {
            transition: transform 0.3s ease;
        }
        .hover-scale:hover {
            transform: scale(1.05);
        }
        .gradient-text {
            background: linear-gradient(135deg, #fff, #ddd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .graph-card {
            background: linear-gradient(135deg, #20c997, #0dcaf0);
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        /* Clear Graph Colors */
        canvas {
            background: transparent;
        }
    </style>
</head>
<body>
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar flex flex-col h-full shadow-md p-1 relative z-10" style="width: 64px; transition: width 0.3s ease;">
            <div class="flex items-center justify-center h-14 mb-2">
                <img src="images/somap-logo.png.jpg" alt="SoMAp Logo" class="sidebar-logo h-10">
            </div>
            <div class="flex-1 overflow-y-auto">
                <div class="flex flex-col space-y-1">
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto active" data-module="dashboard">
                        <i class="fas fa-th-large text-xl"></i>
                        <span class="sidebar-tooltip">Dashboard</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium">Dashboard</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="academic">
                        <i class="fas fa-book-open text-xl"></i>
                        <span class="sidebar-tooltip">Academic & Exams</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium">Academic</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="attendance">
                        <i class="fas fa-check-circle text-xl"></i>
                        <span class="sidebar-tooltip">Attendance</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium">Attendance</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="discipline">
                        <i class="fas fa-exclamation-circle text-xl"></i>
                        <span class="sidebar-tooltip">Discipline</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium">Discipline</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" data-module="students-list">
                        <i class="fas fa-users text-xl"></i>
                        <span class="sidebar-tooltip">Students List</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium">Students List</span>
                    </button>
                    <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" onclick="logout()">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                        <span class="sidebar-tooltip">Logout</span>
                        <span class="sidebar-expanded hidden ml-3 text-sm font-medium">Logout</span>
                    </button>
                </div>
            </div>
            <div class="mt-2 mb-1">
                <button id="toggle-sidebar" class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto">
                    <i class="fas fa-chevron-right text-sm sidebar-collapsed"></i>
                    <i class="fas fa-chevron-left text-sm sidebar-expanded hidden"></i>
                    <span class="sidebar-tooltip">Toggle Menu</span>
                </button>
                <div class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto mt-1">
                    <img src="https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png" alt="Profile" class="rounded-full h-8 w-8 object-cover">
                    <span class="sidebar-tooltip">Profile</span>
                    <span class="sidebar-expanded hidden ml-3 text-sm font-medium">Teacher</span>
                </div>
            </div>
        </div>
        <!-- Main Workspace -->
        <div class="main-content transition-all fade-in">
            <h1 class="text-3xl font-bold mb-6 gradient-text">Teacher Dashboard</h1>
            <!-- Stream Selector - Restricted to Teacher's Class -->
            <select id="stream-select" class="form-control mb-4 w-1/4">
                <option value="A">Stream A</option>
                <option value="B">Stream B</option>
                <option value="Red">Stream Red</option>
            </select>
            <!-- Academic Management Card -->
            <section id="academic" class="card fade-in hover-scale">
                <h2 class="text-2xl font-semibold mb-4">Academic Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="stat-card">
                        <h5>Scores</h5>
                        <p id="class-scores">Loading scores...</p>
                    </div>
                    <div class="stat-card">
                        <h5>Top/Bottom Students</h5>
                        <p id="top-bottom">Loading top/bottom students...</p>
                    </div>
                </div>
                <button class="btn mt-4" onclick="saveScores()">Save Scores</button>
            </section>
            <!-- Attendance Card -->
            <section id="attendance" class="card fade-in hover-scale">
                <h2 class="text-2xl font-semibold mb-4">Attendance</h2>
                <p id="attendance-stats">Loading attendance stats...</p>
            </section>
            <!-- Discipline Card -->
            <section id="discipline" class="card fade-in hover-scale">
                <h2 class="text-2xl font-semibold mb-4">Discipline</h2>
                <p id="discipline-stats">Loading discipline records...</p>
            </section>
            <!-- Students List Card -->
            <section id="students-list" class="card fade-in hover-scale">
                <h2 class="text-2xl font-semibold mb-4">Students List</h2>
                <p id="students-list-data">Loading students list...</p>
            </section>
            <!-- Academic & Exams Module Integration (from academic.html, pre-set to teacher's class) -->
            <section id="academic-module" class="card fade-in hover-scale hidden">
                <h2 class="text-2xl font-semibold mb-4">Academic & Exams Module</h2>
                <p>Scores • Rankings • Reports</p>
                <button class="btn mt-2">Save Scores</button>
                <button class="btn mt-2">CSV</button>
                <button class="btn mt-2">Excel</button>
                <button class="btn mt-2">PDF</button>
                <button class="btn mt-2">Print</button>
                <button class="btn mt-2">Load</button>
                <!-- Pre-set to Teacher's Class -->
                <div class="mb-4">
                    <label class="form-label">School Branch</label>
                    <input type="text" class="form-control" value="Socrates — Main (optional)" disabled>
                </div>
                <div class="mb-4">
                    <label class="form-label">Class</label>
                    <input type="text" id="academic-class" class="form-control" disabled>
                </div>
                <div class="mb-4">
                    <label class="form-label">Stream</label>
                    <select id="academic-stream" class="form-control">
                        <option value="A / B / Red">A / B / Red</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Exam Type</label>
                    <select id="exam-type" class="form-control">
                        <option value="Monthly">Monthly</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Month</label>
                    <select id="month" class="form-control">
                        <option value="January">January</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Academic Year</label>
                    <input type="text" class="form-control" value="e.g., 2025">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="stat-card">
                        <h5>Top Student</h5>
                        <p id="top-student">– –</p>
                    </div>
                    <div class="stat-card">
                        <h5>Bottom Student</h5>
                        <p id="bottom-student">– –</p>
                    </div>
                    <div class="stat-card">
                        <h5>Class Max</h5>
                        <p id="class-max">– Highest overall avg</p>
                    </div>
                    <div class="stat-card">
                        <h5>Class Grade</h5>
                        <p id="class-grade">– Avg grade</p>
                    </div>
                    <div class="stat-card">
                        <h5>% Present</h5>
                        <p id="percent-present">– Attendance</p>
                    </div>
                    <div class="stat-card">
                        <h5>% Absent</h5>
                        <p id="percent-absent">– Attendance</p>
                    </div>
                    <div class="stat-card">
                        <h5>Fee: Required</h5>
                        <p id="fee-required">– Class/year</p>
                    </div>
                    <div class="stat-card">
                        <h5>Fee: Paid</h5>
                        <p id="fee-paid">– Aggregated</p>
                    </div>
                    <div class="stat-card">
                        <h5>Fee: Balance</h5>
                        <p id="fee-balance">– Outstanding</p>
                    </div>
                </div>
                <div class="graph-card chart-container">
                    <h3>Subject Performance (Class)</h3>
                    <canvas id="subject-performance-chart"></canvas>
                    <p>Average per subject</p>
                </div>
                <div class="graph-card chart-container">
                    <h3>Student Averages (Top 10)</h3>
                    <canvas id="student-averages-chart"></canvas>
                    <p>Overall %</p>
                </div>
                <!-- Scoresheet -->
                <section id="scoresheet">
                    <h2 class="text-2xl font-semibold mb-4">Scoresheet</h2>
                    <p>Enter marks per subject • Auto averages • Positions • Grades</p>
                    <div class="mb-4">
                        <label class="form-label">Max/100</label>
                        <input type="number" class="form-control w-1/4" value="100">
                        <button class="btn mt-2">Set all Max</button>
                        <button class="btn mt-2">Recalculate</button>
                    </div>
                    <table class="table w-full text-sm">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Adm</th>
                                <th>Student</th>
                                <th>Fee Due</th>
                                <th>Paid</th>
                                <th>Balance</th>
                                <th>Total</th>
                                <th>Max</th>
                                <th>% Avg</th>
                                <th>Overall Pos</th>
                                <th>Grade</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Teacher Comment</th>
                            </tr>
                        </thead>
                        <tbody id="scoresheet-table">
                            <tr>
                                <td colspan="14" class="text-center">0 students • 0 subjects</td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn mt-4">Generate Report Cards (PDF)</button>
                    <button class="btn mt-4">Email/SMS Links</button>
                </section>
            </section>
            <!-- Attendance Analytics from Attendance Module -->
            <section id="attendance-analytics" class="card fade-in hover-scale">
                <h2 class="text-2xl font-semibold mb-4">Attendance Analytics</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="stat-card">
                        <h5>Class Days (excl. weekends & holidays)</h5>
                        <p id="class-days">—</p>
                    </div>
                    <div class="stat-card">
                        <h5>% Present (Class Avg)</h5>
                        <p id="percent-present-class">—</p>
                    </div>
                    <div class="stat-card">
                        <h5>Yellow Alerts (≥ 10 absent days/month)</h5>
                        <p id="yellow-alerts">—</p>
                    </div>
                    <div class="stat-card">
                        <h5>Archived query</h5>
                        <p>09/15/2025 - 09/15/2025</p>
                        <button class="btn mt-2">Load</button>
                    </div>
                </div>
            </section>
            <!-- Modal for SchoolERP Integration (Modified to Hide Admissions) -->
            <div id="schoolerp-modal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeModal('schoolerp-modal')">&times;</span>
                    <div id="schoolerp-content">
                        <!-- SchoolERP Content - Hide Admissions -->
                        <h2 class="text-2xl font-bold mb-4">Manage Academic and Administrative Aspects</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- Hide Admissions Section -->
                            <!-- Academics Section -->
                            <div class="card hover-scale">
                                <h3 class="text-xl font-semibold mb-4">Academics</h3>
                                <p>Manage classes, timetables, examinations, and student records.</p>
                                <button class="btn mt-4">Manage Academics</button>
                            </div>
                            <!-- Attendance Section -->
                            <div class="card hover-scale">
                                <h3 class="text-xl font-semibold mb-4">Attendance</h3>
                                <p>Mark and track student attendance.</p>
                                <button class="btn mt-4">Mark Attendance</button>
                            </div>
                            <!-- Discipline Section -->
                            <div class="card hover-scale">
                                <h3 class="text-xl font-semibold mb-4">Discipline</h3>
                                <p>Record and manage student discipline cases.</p>
                                <button class="btn mt-4">Add Incident</button>
                            </div>
                            <!-- Students List Section -->
                            <div class="card hover-scale">
                                <h3 class="text-xl font-semibold mb-4">Students List</h3>
                                <p>View and manage student profiles.</p>
                                <button class="btn mt-4">View Students</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
            authDomain: "somaptestt.firebaseapp.com",
            databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
            projectId: "somaptestt",
            storageBucket: "somaptestt.appspot.com",
            messagingSenderId: "105526245138",
            appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let teacherClass = '';

        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            db.ref('users/' + user.email.replace('.', '_')).once('value').then(snapshot => {
                const userData = snapshot.val();
                if (!userData || userData.role !== 'teacher') {
                    Swal.fire('Error', 'Unauthorized access', 'error');
                    auth.signOut();
                    window.location.href = 'index.html';
                    return;
                }
                teacherClass = userData.class;
                document.getElementById('sidebar').classList.remove('hidden');
                loadTeacherDashboard();
            });
        });

        // Sidebar Toggle
        document.getElementById('toggle-sidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('sidebar-expanded');
            document.querySelectorAll('.sidebar-collapsed').forEach(el => el.classList.toggle('hidden'));
            document.querySelectorAll('.sidebar-expanded').forEach(el => el.classList.toggle('hidden'));
            document.querySelector('.main-content').classList.toggle('sidebar-expanded');
        });

        // Sidebar Clicks
        document.querySelector('[data-module="dashboard"]').addEventListener('click', () => {
            document.querySelectorAll('.module-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('academic').classList.remove('hidden');
            document.getElementById('attendance').classList.remove('hidden');
            document.getElementById('discipline').classList.remove('hidden');
            document.getElementById('students-list').classList.remove('hidden');
            document.querySelectorAll('.sidebar-icon').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        });

        document.querySelector('[data-module="academic"]').addEventListener('click', () => {
            openModal('academic-module');
            document.querySelectorAll('.sidebar-icon').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        });

        document.querySelector('[data-module="attendance"]').addEventListener('click', () => {
            openModal('attendance-analytics');
            document.querySelectorAll('.sidebar-icon').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        });

        document.querySelector('[data-module="discipline"]').addEventListener('click', () => {
            // Load discipline data for teacher's class
            loadDisciplineData();
            document.getElementById('discipline').classList.remove('hidden');
            document.querySelectorAll('.sidebar-icon').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        });

        document.querySelector('[data-module="students-list"]').addEventListener('click', () => {
            // Load students list for teacher's class
            loadStudentsList();
            document.getElementById('students-list').classList.remove('hidden');
            document.querySelectorAll('.sidebar-icon').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        });

        // Modal Functions
        function openModal(sectionId) {
            document.getElementById(sectionId).classList.remove('hidden');
        }
        function closeModal(sectionId) {
            document.getElementById(sectionId).classList.add('hidden');
        }

        // Logout
        function logout() {
            auth.signOut().then(() => {
                localStorage.removeItem('role');
                localStorage.removeItem('class');
                Swal.fire('Success', 'You have been signed out.', 'success');
                window.location.href = 'index.html';
            }).catch(err => {
                Swal.fire('Error', 'Sign-out failed: ' + err.message, 'error');
            });
        }

        // Load Teacher Dashboard - Restricted to Teacher's Class
        function loadTeacherDashboard() {
            loadScores();
            loadTopBottomStudents();
            loadAttendanceStats();
            loadDisciplineData();
            loadStudentsList();
            // Pre-set academic module to teacher's class
            document.getElementById('academic-class').value = teacherClass;
            // Load graphs for subject performance and student averages
            loadSubjectPerformanceChart();
            loadStudentAveragesChart();
            loadScoresheetTable();
        }

        // Load Scores for Teacher's Class
        function loadScores() {
            db.ref(`scores/2025/${teacherClass}/monthly/08`).on('value', snapshot => {
                const scores = snapshot.val() || {};
                let html = '';
                Object.entries(scores).forEach(([id, s]) => {
                    html += `${id}: Fee Due TSh ${s.feeDue || 0}, Paid TSh ${s.paid || 0}, Balance TSh ${s.balance || 0}<br>`;
                });
                document.getElementById('class-scores').innerHTML = html || 'No scores found.';
            });
        }

        // Load Top/Bottom Students for Teacher's Class
        function loadTopBottomStudents() {
            db.ref(`scores/2025/${teacherClass}/monthly/08`).on('value', snapshot => {
                const scores = snapshot.val() ? Object.entries(snapshot.val()).map(([id, s]) => ({
                    name: id, // Replace with actual name from students
                    avg: Object.values(s).reduce((sum, sub) => sum + (sub.score / sub.max * 100), 0) / Object.keys(s).length
                })) : [];
                const top = scores.sort((a, b) => b.avg - a.avg)[0];
                const bottom = scores.sort((a, b) => a.avg - b.avg)[0];
                document.getElementById('top-bottom').innerHTML = `Top: ${top?.name || 'N/A'} (${top?.avg.toFixed(1) || 0}%)<br>Bottom: ${bottom?.name || 'N/A'} (${bottom?.avg.toFixed(1) || 0}%)`;
            });
        }

        // Load Attendance Stats for Teacher's Class
        function loadAttendanceStats() {
            db.ref(`attendance/${teacherClass}/2025-09`).on('value', snapshot => {
                const attendance = snapshot.val() ? Object.values(snapshot.val()).flatMap(day => Object.values(day)) : [];
                let present = attendance.filter(a => a.daily === 'P').length;
                let total = attendance.length;
                document.getElementById('attendance-stats').innerHTML = `Present: ${present}/${total} (${total ? (present/total*100).toFixed(1) : 0}%)`;
            });
        }

        // Load Discipline Data for Teacher's Class
        function loadDisciplineData() {
            db.ref('discipline').on('value', snapshot => {
                const discipline = snapshot.val() || {};
                let html = '';
                Object.entries(discipline).forEach(([id, d]) => {
                    if (d.class === teacherClass) {
                        html += `${d.studentName}: ${d.incident} - ${new Date(d.timestamp).toLocaleString()}<br>`;
                    }
                });
                document.getElementById('discipline-stats').innerHTML = html || 'No discipline records.';
            });
        }

        // Load Students List for Teacher's Class
        function loadStudentsList() {
            db.ref('students').on('value', snapshot => {
                const students = snapshot.val() ? Object.values(snapshot.val()).filter(s => s.classLevel === teacherClass) : [];
                let html = students.map(s => `${s.firstName} ${s.lastName} - Fee Due: TSh ${s.feePerYear}, Paid: TSh ${s.paidAmount}, Balance: TSh ${s.balance}<br>`).join('');
                document.getElementById('students-list-data').innerHTML = html || 'No students found.';
            });
        }

        // Load Subject Performance Chart
        function loadSubjectPerformanceChart() {
            const ctx = document.getElementById('subject-performance-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Math', 'Science', 'English'], // Example subjects
                    datasets: [{
                        label: 'Average per Subject',
                        data: [85, 90, 80], // Placeholder
                        backgroundColor: '#20c997'
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // Load Student Averages Chart
        function loadStudentAveragesChart() {
            const ctx = document.getElementById('student-averages-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Student 1', 'Student 2', 'Student 3'], // Example
                    datasets: [{
                        label: 'Overall %',
                        data: [95, 85, 75], // Placeholder
                        backgroundColor: '#0dcaf0'
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // Load Scoresheet Table for Teacher's Class
        function loadScoresheetTable() {
            db.ref('students').on('value', snapshot => {
                const students = snapshot.val() ? Object.values(snapshot.val()).filter(s => s.classLevel === teacherClass) : [];
                const tableBody = document.getElementById('scoresheet-table');
                let html = '';
                students.forEach((s, index) => {
                    html += `<tr>
                        <td>${index + 1}</td>
                        <td>${s.admissionNumber}</td>
                        <td>${s.firstName} ${s.lastName}</td>
                        <td>TSh ${s.feePerYear}</td>
                        <td>TSh ${s.paidAmount}</td>
                        <td>TSh ${s.balance}</td>
                        <td>${s.total || 0}</td>
                        <td>${s.max || 100}</td>
                        <td>${s.avg || 0}%</td>
                        <td>${s.pos || '-'}</td>
                        <td>${s.grade || '-'}</td>
                        <td>${s.present || 0}</td>
                        <td>${s.absent || 0}</td>
                        <td><input type="text" class="form-control w-full" placeholder="Comment"></td>
                    </tr>`;
                });
                tableBody.innerHTML = html || '<tr><td colspan="14" class="text-center">0 students • 0 subjects</td></tr>';
            });
        }

        // Save Scores Function (Placeholder)
        function saveScores() {
            Swal.fire('Success', 'Scores saved!', 'success');
        }

        // SchoolERP Modal - Load Modified SchoolERP Content
        document.querySelector('[data-module="academic"]').addEventListener('click', () => {
            openModal('schoolerp-modal');
            // Hide admissions in loaded content
            document.querySelector('#schoolerp-content .admissions-section').style.display = 'none';
        });
    </script>
</body>
</html>