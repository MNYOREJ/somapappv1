<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Teacher Dashboard</title>

  <!-- Tailwind CDN (for quick visuals) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Firebase compat (same as your previous file) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    /* Custom visuals on top of Tailwind for consistent look */
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,#f6f8ff 0%, #f4f4f9 100%); min-height: 100vh; }
    .sidebar { width: 72px; min-width:72px; background: linear-gradient(180deg, #0f172a, #0b1220); color: #fff; height: 100vh; position: fixed; left:0; top:0; padding-top:18px; z-index:40; box-shadow: 4px 0 18px rgba(2,6,23,0.2); }
    .sidebar .icon { width:48px; height:48px; display:flex; align-items:center; justify-content:center; margin:10px auto; border-radius:10px; cursor:pointer; transition: all .15s ease; }
    .sidebar .icon:hover { transform: translateY(-3px); box-shadow: 0 6px 18px rgba(2,6,23,0.25); }
    .sidebar .icon.active { background: linear-gradient(135deg,#4f46e5,#06b6d4); color: #fff; }
    .main { margin-left: 92px; padding: 28px; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(12,17,46,0.06); padding: 18px; }
    .ghost { color: #9aa4c4; }
    .tiny { font-size: 0.78rem; color:#94a3b8; }

    /* Scoresheet grid */
    .scoresheet-table { width:100%; border-collapse: collapse; font-size:0.92rem; }
    .scoresheet-table th, .scoresheet-table td { padding: 8px 10px; border-bottom: 1px solid #eef2ff; text-align: left; }
    .scoresheet-table th { background: linear-gradient(90deg,#f8fbff,#fff); font-weight:600; }
    .input-mini { width:68px; padding:6px 8px; border:1px solid #e6e9f2; border-radius:6px; }
    .btn { background: linear-gradient(90deg,#4f46e5,#06b6d4); color: #fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
    .btn-alt { background: #fff; color: #344054; border: 1px solid #e6e9f2; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .muted { color:#64748b; }
    .chip { display:inline-flex; gap:8px; padding:6px 10px; border-radius:999px; background:#f1f5f9; align-items:center; }
    .overflow-panel { max-height:520px; overflow:auto; padding-right:6px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="flex">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="text-center mb-6">
        <img src="images/somap-logo.png.jpg" alt="SoMAp" class="mx-auto w-10 h-10 rounded" />
      </div>

      <div id="icon-dashboard" class="icon active" title="Dashboard">
        <i class="fa-solid fa-house text-xl"></i>
      </div>

      <div id="icon-academic" class="icon" title="Academic (ERP view)">
        <i class="fa-solid fa-graduation-cap text-xl"></i>
      </div>

      <div id="icon-scores" class="icon" title="Scores / Scoresheet">
        <i class="fa-solid fa-file-pen text-xl"></i>
      </div>

      <div id="icon-attendance" class="icon" title="Attendance (ERP)">
        <i class="fa-solid fa-calendar-check text-xl"></i>
      </div>

      <div id="icon-reports" class="icon" title="Reports">
        <i class="fa-solid fa-chart-simple text-xl"></i>
      </div>

      <div id="icon-admin-erp" class="icon" title="School ERP (restricted)">
        <i class="fa-solid fa-gear text-xl"></i>
      </div>

      <div id="icon-logout" class="icon mt-auto" style="margin-top:30px;" title="Logout">
        <i class="fa-solid fa-right-from-bracket text-xl"></i>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main w-full">
      <!-- Header area -->
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-semibold">Teacher Dashboard</h1>
          <div class="tiny mt-1">Welcome — view & manage your class academic data, attendance and reports.</div>
        </div>

        <div class="flex items-center gap-3">
          <div id="teacher-info" class="chip">
            <div id="teacher-email" class="tiny">loading...</div>
          </div>
          <div class="chip" id="class-chip">Class: —</div>
        </div>
      </div>

      <!-- Dashboard container: we'll swap content here -->
      <div id="content-area">
        <!-- DASHBOARD HOME (default) -->
        <section id="panel-dashboard" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Left column cards -->
          <div class="space-y-6 lg:col-span-2">
            <div class="card">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h3 class="text-lg font-semibold">Academic Management — Quick Overview</h3>
                  <div class="tiny">Class-only view for what matters to your teaching.</div>
                </div>
                <div class="tiny muted">As signed in: <span id="signed-role">loading</span></div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card p-4">
                  <h4 class="font-medium">Scores</h4>
                  <div id="class-scores-brief" class="tiny mt-2">Loading...</div>
                </div>

                <div class="card p-4">
                  <h4 class="font-medium">Top / Bottom</h4>
                  <div id="top-bottom-brief" class="tiny mt-2">Loading...</div>
                </div>

                <div class="card p-4">
                  <h4 class="font-medium">Attendance</h4>
                  <div id="attendance-brief" class="tiny mt-2">Loading...</div>
                </div>

                <div class="card p-4">
                  <h4 class="font-medium">Fees Summary</h4>
                  <div id="fees-brief" class="tiny mt-2">Loading...</div>
                </div>
              </div>
            </div>

            <div class="card">
              <h3 class="text-lg font-semibold mb-2">Recent Activity</h3>
              <div class="tiny text-slate-600">Recent saves, uploads and attendance changes (class only)</div>
              <div id="activity-log" class="overflow-panel mt-3">
                <ul id="activity-list" class="list-disc pl-5 static tiny">
                  <li>No recent activity.</li>
                </ul>
              </div>
            </div>

            <div class="card">
              <h3 class="text-lg font-semibold mb-2">Announcements</h3>
              <div id="announcements" class="tiny">
                No announcements yet. Admin posts and school notices will appear here.
              </div>
            </div>
          </div>

          <!-- Right column: quick actions & reports -->
          <aside class="space-y-6">
            <div class="card">
              <h4 class="font-medium">Quick Actions</h4>
              <div class="mt-3 space-y-2">
                <button id="btn-open-academic" class="btn w-full">Open Academic (ERP view)</button>
                <button id="btn-open-scores" class="btn-alt w-full">Open Scoresheet</button>
                <button id="btn-open-attendance" class="btn-alt w-full">Open Attendance (ERP)</button>
              </div>
            </div>

            <div class="card">
              <h4 class="font-medium">Export / Share</h4>
              <div class="mt-3 space-y-2">
                <button id="btn-export-csv" class="btn w-full">Export Scoresheet CSV</button>
                <button id="btn-generate-report" class="btn-alt w-full">Generate Report Cards (PDF)</button>
                <button id="btn-email-all" class="btn-alt w-full">Email / SMS Links</button>
              </div>
            </div>

            <div class="card">
              <h4 class="font-medium">Attendance Analytics</h4>
              <div class="tiny mt-2" id="attendance-analytics">
                Loading analytics...
              </div>
            </div>
          </aside>
        </section>

        <!-- ACADEMIC / ERP container (will be filled by fetching schoolerp.html and sanitizing) -->
        <section id="panel-academic" class="hidden card">
          <div class="flex items-start justify-between mb-4">
            <div>
              <h3 class="text-lg font-semibold">School ERP — Academic</h3>
              <div class="tiny">Showing ERP content, with Admissions hidden (teacher access only).</div>
            </div>

            <div class="flex gap-2">
              <button id="btn-refresh-erp" class="btn-alt">Refresh ERP View</button>
              <button id="btn-back-dashboard" class="btn">Back</button>
            </div>
          </div>

          <div id="erp-container" class="overflow-panel"></div>
        </section>

        <!-- SCORESHEET panel -->
        <section id="panel-scoresheet" class="hidden">
          <div class="card">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="text-lg font-semibold">Scoresheet — Enter Marks (Class view only)</h3>
                <div class="tiny">Enter per-subject marks, auto averages, positions & grades for your class.</div>
              </div>
              <div class="tiny muted">Academic Year: <span id="academic-year">2025</span></div>
            </div>

            <div class="mb-4 flex items-center gap-3">
              <label class="tiny">Class</label>
              <select id="scores-class-select" class="input-mini">
                <!-- populated from signed-in teacher class -->
              </select>

              <label class="tiny">Stream</label>
              <select id="scores-stream-select" class="input-mini">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="Red">Red</option>
              </select>

              <label class="tiny">Exam Type</label>
              <select id="scores-examtype-select" class="input-mini">
                <option value="monthly">Monthly</option>
                <option value="term">Term</option>
                <option value="exam">Exam</option>
              </select>

              <label class="tiny">Month</label>
              <select id="scores-month-select" class="input-mini">
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08" selected>August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>

              <button id="btn-load-scoresheet" class="btn">Load</button>
            </div>

            <div id="scoresheet-area" class="overflow-panel">
              <table class="scoresheet-table w-full">
                <thead>
                  <tr>
                    <th style="width:48px;">#</th>
                    <th>Adm</th>
                    <th>Student</th>
                    <th>Fee Due</th>
                    <th>Paid</th>
                    <th>Balance</th>
                    <th>Total</th>
                    <th>Max</th>
                    <th>% Avg</th>
                    <th>Overall Pos</th>
                    <th>Grade</th>
                    <th>Present</th>
                    <th>Absent</th>
                    <th>Teacher Comment</th>
                  </tr>
                </thead>
                <tbody id="scoresheet-body">
                  <tr><td colspan="14" class="tiny p-6 text-center muted">No students loaded. Select class & click Load.</td></tr>
                </tbody>
              </table>
            </div>

            <div class="mt-4 flex items-center gap-2 justify-between">
              <div class="flex items-center gap-2">
                <label>Max /100</label>
                <input id="input-max" class="input-mini" value="100" />
                <button id="btn-set-all-max" class="btn-alt">Set all Max</button>
                <button id="btn-recalculate" class="btn">Recalculate</button>
              </div>

              <div class="flex gap-2">
                <button id="btn-save-scores" class="btn">Save Scores</button>
                <button id="btn-export-scores" class="btn-alt">Export</button>
              </div>
            </div>
          </div>
        </section>

        <!-- ATTENDANCE panel (ERP fetched but with admissions hidden and editing limited to teacher's class) -->
        <section id="panel-attendance" class="hidden card">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="text-lg font-semibold">Attendance — Class View (ERP attendance)</h3>
              <div class="tiny">Full ERP attendance view, editing restricted to your class only.</div>
            </div>
            <div class="tiny">You can view entire school's attendance report but edit only your class.</div>
          </div>

          <div id="attendance-erp-container" class="overflow-panel"></div>
        </section>

        <!-- REPORTS -->
        <section id="panel-reports" class="hidden card">
          <h3 class="text-lg font-semibold mb-2">Reports & Analytics</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="card p-4">
              <h4 class="font-medium">Class Summary</h4>
              <div id="report-class-summary" class="tiny mt-2">Loading...</div>
            </div>

            <div class="card p-4">
              <h4 class="font-medium">Subject Performance</h4>
              <div id="report-subject-performance" class="tiny mt-2">Loading...</div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
  /******************************************
   * Firebase config (same as your provided)
   ******************************************/
  const firebaseConfig = {
    apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
    authDomain: "somaptestt.firebaseapp.com",
    databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
    projectId: "somaptestt",
    storageBucket: "somaptestt.appspot.com",
    messagingSenderId: "105526245138",
    appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  /******************************************
   * Global UI refs
   ******************************************/
  const ui = {
    icons: {
      dashboard: document.getElementById('icon-dashboard'),
      academic: document.getElementById('icon-academic'),
      scores: document.getElementById('icon-scores'),
      attendance: document.getElementById('icon-attendance'),
      reports: document.getElementById('icon-reports'),
      adminErp: document.getElementById('icon-admin-erp'),
      logout: document.getElementById('icon-logout'),
    },
    panels: {
      dashboard: document.getElementById('panel-dashboard'),
      academic: document.getElementById('panel-academic'),
      scoresheet: document.getElementById('panel-scoresheet'),
      attendance: document.getElementById('panel-attendance'),
      reports: document.getElementById('panel-reports'),
    },
    contentArea: document.getElementById('content-area'),
    erpContainer: document.getElementById('erp-container'),
    attendanceErpContainer: document.getElementById('attendance-erp-container'),
    teacherEmail: document.getElementById('teacher-email'),
    classChip: document.getElementById('class-chip'),
    signedRole: document.getElementById('signed-role'),
    activityList: document.getElementById('activity-list'),
    classScoresBrief: document.getElementById('class-scores-brief'),
    topBottomBrief: document.getElementById('top-bottom-brief'),
    attendanceBrief: document.getElementById('attendance-brief'),
    feesBrief: document.getElementById('fees-brief'),
    btnOpenAcademic: document.getElementById('btn-open-academic'),
    btnOpenScores: document.getElementById('btn-open-scores'),
    btnOpenAttendance: document.getElementById('btn-open-attendance'),
    btnBackDashboard: document.getElementById('btn-back-dashboard'),
    btnRefreshErp: document.getElementById('btn-refresh-erp'),
    btnLoadScoresheet: document.getElementById('btn-load-scoresheet'),
    scoresClassSelect: document.getElementById('scores-class-select'),
    scoresStreamSelect: document.getElementById('scores-stream-select'),
    scoresBody: document.getElementById('scoresheet-body'),
    inputMax: document.getElementById('input-max'),
    btnSetAllMax: document.getElementById('btn-set-all-max'),
    btnRecalculate: document.getElementById('btn-recalculate'),
    btnSaveScores: document.getElementById('btn-save-scores'),
    btnExportScores: document.getElementById('btn-export-scores'),
    btnExportCSV: document.getElementById('btn-export-csv'),
    btnGenerateReport: document.getElementById('btn-generate-report'),
    btnEmailAll: document.getElementById('btn-email-all'),
    btnLogoutIcon: document.getElementById('icon-logout'),
    erpContainerInner: document.getElementById('erp-container'),
    attendanceAnalytics: document.getElementById('attendance-analytics'),
    reportClassSummary: document.getElementById('report-class-summary'),
    reportSubjectPerformance: document.getElementById('report-subject-performance'),
  };

  // local app state
  const state = {
    user: null,         // firebase user object
    userData: null,     // users/<email> object from db (role, class)
    class: null,        // e.g., "Class 4"
    stream: 'A',
    students: [],       // students list of teacher's class+stream
    scores: {},         // current loaded scores
    activity: [],       // activity log
  };

  /******************************************
   * Utility helpers
   ******************************************/
  function toKey(email) {
    return email.replace(/\./g, '_');
  }

  function qs(selector, root = document) { return root.querySelector(selector); }
  function qsa(selector, root = document) { return Array.from((root || document).querySelectorAll(selector)); }

  function switchPanel(panelName) {
    // deactivate icons
    Object.values(ui.icons).forEach(el => el.classList.remove('active'));
    // show/hide panels
    Object.values(ui.panels).forEach(p => p.classList.add('hidden'));
    // set active icon
    switch (panelName) {
      case 'dashboard':
        ui.icons.dashboard.classList.add('active');
        ui.panels.dashboard.classList.remove('hidden'); break;
      case 'academic':
        ui.icons.academic.classList.add('active');
        ui.panels.academic.classList.remove('hidden'); break;
      case 'scoresheet':
        ui.icons.scores.classList.add('active');
        ui.panels.scoresheet.classList.remove('hidden'); break;
      case 'attendance':
        ui.icons.attendance.classList.add('active');
        ui.panels.attendance.classList.remove('hidden'); break;
      case 'reports':
        ui.icons.reports.classList.add('active');
        ui.panels.reports.classList.remove('hidden'); break;
      default:
        ui.icons.dashboard.classList.add('active');
        ui.panels.dashboard.classList.remove('hidden');
    }
  }

  function addActivity(text) {
    const ts = new Date().toLocaleString();
    state.activity.unshift({ text, ts });
    if (state.activity.length > 30) state.activity.pop();
    renderActivity();
  }

  function renderActivity() {
    ui.activityList.innerHTML = '';
    if (!state.activity.length) {
      ui.activityList.innerHTML = '<li>No recent activity.</li>';
      return;
    }
    state.activity.forEach(a => {
      const li = document.createElement('li');
      li.className = 'tiny';
      li.textContent = `${a.ts} — ${a.text}`;
      ui.activityList.appendChild(li);
    });
  }

  /******************************************
   * Auth + initial load
   ******************************************/
  auth.onAuthStateChanged(async firebaseUser => {
    if (!firebaseUser) {
      // redirect to login page
      window.location.href = 'index.html';
      return;
    }
    state.user = firebaseUser;
    ui.teacherEmail.innerText = firebaseUser.email;
    // fetch user role & class
    const key = toKey(firebaseUser.email);
    const userSnap = await db.ref('users/' + key).once('value');
    const userData = userSnap.val();
    if (!userData) {
      alert('User profile not found in database — contact admin.');
      await auth.signOut();
      window.location.href = 'index.html';
      return;
    }
    state.userData = userData;
    state.class = userData.class || userData.classLevel || userData.className || null;
    ui.classChip.innerText = 'Class: ' + (state.class || '—');
    ui.signedRole.innerText = userData.role || '—';
    // if teacher, load their class data
    if (userData.role === 'teacher') {
      addActivity(`Signed in as teacher (${firebaseUser.email}) for ${state.class || 'unknown class'}.`);
      await loadInitialClassData();
    } else {
      addActivity(`Signed in as ${userData.role}. You might have wider access.`);
    }

    // attach UI listeners
    attachUIListeners();
  });

  /******************************************
   * Load initial class data (students, attendance, scores)
   ******************************************/
  async function loadInitialClassData() {
    // fetch students for the class
    const className = state.class;
    if (!className) return;

    const studentsSnap = await db.ref('students').once('value');
    const studentsObj = studentsSnap.val() || {};
    // filter students for teacher's class (all streams by default)
    state.students = Object.values(studentsObj).filter(s => s.classLevel === className);
    // compute brief summaries
    renderClassBriefs();

    // fetch scores (example: monthly 2025/08)
    await loadScoresForClass({ year: '2025', month: '08', examType: 'monthly' });

    // fetch attendance summary
    await loadAttendanceSummary(className);

    // populate scoresheet class select (teacher should only be able to pick own class)
    ui.scoresClassSelect.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = className;
    opt.innerText = className;
    ui.scoresClassSelect.appendChild(opt);

    // default stream
    ui.scoresStreamSelect.value = state.stream;

    renderActivity();
  }

  function renderClassBriefs() {
    // fees summary
    let feeDue = 0, feePaid = 0, balance = 0;
    state.students.forEach(s => {
      feeDue += Number(s.feePerYear || 0);
      feePaid += Number(s.paidAmount || 0);
      balance += Number(s.balance || 0);
    });
    ui.feesBrief.innerHTML = `Fee: Required <strong>${feeDue}</strong><br>Paid <strong>${feePaid}</strong><br>Balance <strong>${balance}</strong>`;

    // students list with fee snapshot in class-scores-brief
    ui.classScoresBrief.innerHTML = state.students.length ? state.students.map(s => `${s.firstName} ${s.lastName}: Fee Due TSh ${s.feePerYear || 0}, Paid TSh ${s.paidAmount || 0}, Balance TSh ${s.balance || 0}`).join('<br>') : 'No students found.';

    // top/bottom from loaded scores (if available)
    if (state.scores && state.scores.list && state.scores.list.length) {
      const list = state.scores.list;
      const top = list[0];
      const bottom = list[list.length - 1];
      ui.topBottomBrief.innerHTML = `Top: ${top?.name || 'N/A'} (${top?.avg?.toFixed(1) || '0'}%)<br>Bottom: ${bottom?.name || 'N/A'} (${bottom?.avg?.toFixed(1) || '0'}%)`;
    } else {
      ui.topBottomBrief.innerHTML = 'No score data loaded.';
    }
  }

  /******************************************
   * Load scores for class
   ******************************************/
  async function loadScoresForClass({ year='2025', month='08', examType='monthly' } = {}) {
    const className = state.class;
    if (!className) return;
    // example path: scores/2025/Class 4/monthly/08
    const path = `scores/${year}/${className}/${examType}/${month}`;
    const snap = await db.ref(path).once('value');
    const scoresObj = snap.val() || {};
    // convert to array with student info
    const studentsByAdmission = {};
    state.students.forEach(s => { studentsByAdmission[s.admissionNumber] = s; });
    const list = Object.entries(scoresObj).map(([adm, scoreData]) => {
      const st = studentsByAdmission[adm] || {};
      // compute average across subjects in this record
      const subjects = Object.values(scoreData || {});
      let avg = 0;
      if (subjects.length) {
        avg = subjects.reduce((sum, subj) => {
          const score = Number(subj.score || 0);
          const max = Number(subj.max || 100);
          return sum + (score / (max || 100) * 100);
        }, 0) / subjects.length;
      }
      return {
        adm,
        name: st.firstName ? `${st.firstName} ${st.lastName}` : (scoreData.name || adm),
        avg,
        raw: scoreData
      };
    });
    // sort
    list.sort((a,b) => b.avg - a.avg);
    // store in state
    state.scores = { year, month, examType, path, raw: scoresObj, list };
    renderClassBriefs();
    addActivity(`Loaded scores for ${className} (${examType} ${month}/${year}).`);
    return list;
  }

  /******************************************
   * Load attendance summary for class
   ******************************************/
  async function loadAttendanceSummary(className) {
    // assume monthly attendance keys attendance/<className>/YYYY-MM/<date>/<admission>
    const monthKey = '2025-09';
    const snap = await db.ref(`attendance/${className}/${monthKey}`).once('value');
    const monthData = snap.val() || {};
    const dayEntries = Object.values(monthData || {});
    const attendanceRecords = dayEntries.flatMap(d => Object.values(d || {}));
    const total = attendanceRecords.length;
    const present = attendanceRecords.filter(r => r.daily === 'P').length;
    ui.attendanceBrief.innerHTML = `Present: ${present}/${total} (${total ? ((present/total*100).toFixed(1)) : '0'}%)`;
    // analytics: % present class avg
    ui.attendanceAnalytics.innerHTML = `Class Days: —<br> % Present (Class Avg): ${total ? ((present/total*100).toFixed(1)) : '—'}%`;
  }

  /******************************************
   * UI events and handlers
   ******************************************/
  function attachUIListeners() {
    // icon clicks
    ui.icons.dashboard.addEventListener('click', () => switchPanel('dashboard'));
    ui.icons.academic.addEventListener('click', () => { openAcademicERP(); });
    ui.icons.scores.addEventListener('click', () => switchPanel('scoresheet'));
    ui.icons.attendance.addEventListener('click', () => openAttendanceERP());
    ui.icons.reports.addEventListener('click', () => switchPanel('reports'));

    ui.btnOpenAcademic.addEventListener('click', e => openAcademicERP());
    ui.btnOpenScores.addEventListener('click', e => switchPanel('scoresheet'));
    ui.btnOpenAttendance.addEventListener('click', e => openAttendanceERP());
    ui.btnBackDashboard.addEventListener('click', () => switchPanel('dashboard'));
    ui.btnRefreshErp.addEventListener('click', () => openAcademicERP(true));

    // scoresheet
    ui.btnLoadScoresheet.addEventListener('click', async () => {
      await loadScoresheetUI();
      switchPanel('scoresheet');
    });
    ui.btnSetAllMax.addEventListener('click', () => setAllMax());
    ui.btnRecalculate.addEventListener('click', () => recalculateScoresheet());
    ui.btnSaveScores.addEventListener('click', () => saveScoresheetToFirebase());
    ui.btnExportScores.addEventListener('click', () => exportScoresheetCSV());
    ui.btnExportCSV.addEventListener('click', () => exportScoresheetCSV());
    ui.btnGenerateReport.addEventListener('click', () => alert('Report generation placeholder - integrate server-side or client PDF generator.'));
    ui.btnEmailAll.addEventListener('click', () => alert('Email/SMS links placeholder.'));

    ui.btnLogoutIcon.addEventListener('click', async () => {
      await auth.signOut();
      window.location.href = 'index.html';
    });

    // admin icon restricted
    ui.icons.adminErp.addEventListener('click', () => {
      // only admin & accountant allowed
      const role = state.userData?.role;
      if (role === 'admin' || role === 'accountant') {
        window.location.href = 'schoolerp.html';
      } else {
        alert('Access denied. Admissions and admin-level ERP operations are restricted. Contact admin.');
      }
    });

    // permit clicking inside ERP container but prevent admission clicks
    ui.erpContainer.addEventListener('click', (e) => {
      // if click target or ancestor has data-admission-trigger attribute, restrict.
      const el = e.target.closest('[data-admission-link]');
      if (el) {
        e.preventDefault();
        alert('Admission actions are restricted for teachers. Contact admin to perform admissions.');
        return false;
      }
      // other clicks should function as in loaded ERP (where possible)
    });
  }

  /******************************************
   * Load and sanitize schoolerp.html into ERP container
   * - fetch schoolerp.html (must be accessible)
   * - remove / hide nodes related to Admissions
   * - provide "Contact admin" overlay where admission controls were
   ******************************************/
  async function openAcademicERP(forceReload=false) {
    switchPanel('academic');
    ui.erpContainer.innerHTML = '<div class="tiny muted p-4">Loading ERP academic view...</div>';
    try {
      // fetch schoolerp.html (must be on same domain)
      const res = await fetch('/schoolerp.html', { cache: 'no-store' });
      if (!res.ok) throw new Error('Could not fetch schoolerp.html. Make sure it is at the same path.');
      const htmlText = await res.text();
      // parse
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, 'text/html');

      // Remove admission sections:
      // strategy: remove nodes with id/class containing 'admit'/'admission'/'new-application'/'create-admission' etc.
      const removeSelectors = [
        '[id*="admiss"]',
        '[class*="admiss"]',
        '[id*="admit"]',
        '[class*="admit"]',
        '[data-module*="admission"]',
        '[data-role*="admission"]',
        'a[href*="admission"]',
        'button[data-action*="admission"]',
        'button[data-action*="admit"]',
        'a[data-action*="admission"]'
      ];
      removeSelectors.forEach(sel => {
        qsa(sel, doc).forEach(n => {
          // If it's a container, replace with a friendly message; if small control, remove and add a blocked link
          const placeholder = doc.createElement('div');
          placeholder.className = 'card tiny';
          placeholder.innerHTML = '<strong>Admissions</strong><div class="tiny muted">Admissions are restricted for teachers. Contact admin to perform admissions.</div>';
          // replace full containers, else just remove
          if (n.parentNode) n.parentNode.replaceChild(placeholder, n);
        });
      });

      // Replace any links/buttons that would perform an admission action with a disabled element and data-admission-link attribute
      qsa('a, button', doc).forEach(node => {
        const text = (node.innerText || '').toLowerCase();
        if (text.includes('admit') || text.includes('admission') || text.includes('new application') || text.includes('create new admission') || text.includes('quick admission')) {
          const disabled = doc.createElement(node.tagName.toLowerCase());
          disabled.setAttribute('data-admission-link', 'true');
          disabled.className = 'tiny muted';
          disabled.innerText = 'Admissions (restricted)';
          if (node.parentNode) node.parentNode.replaceChild(disabled, node);
        }
      });

      // Hide any elements with the word 'admission' in headings
      qsa('h1, h2, h3, h4, h5, h6', doc).forEach(h => {
        if ((h.innerText||'').toLowerCase().includes('admission')) {
          const ph = doc.createElement('div');
          ph.className = 'tiny muted';
          ph.innerHTML = '<strong>Admissions</strong> — restricted for teachers. Contact admin.';
          if (h.parentNode) h.parentNode.replaceChild(ph, h);
        }
      });

      // Now inject sanitized content into the ERP container
      ui.erpContainer.innerHTML = '';
      // take body children of schoolerp and append them
      Array.from(doc.body.children).forEach(child => {
        // small sanitization: remove scripts to avoid double Firebase init
        if (child.tagName === 'SCRIPT') return;
        // import node
        ui.erpContainer.appendChild(document.importNode(child, true));
      });

      // Add a top-level notice
      const notice = document.createElement('div');
      notice.className = 'card tiny mb-3';
      notice.innerHTML = '<strong>Teacher ERP View</strong>: Admissions & admin-level controls are hidden. You can view Academics, Attendance and Discipline entries relevant to your class.';
      ui.erpContainer.prepend(notice);

      // Now restrict any attendance edit forms so teacher can edit only his class
      // If the ERP contains an attendance table, add a small script to disable editing of other classes' rows
      restrictErpInteractions();

      addActivity('Opened Academic (sanitized ERP view).');
    } catch (err) {
      ui.erpContainer.innerHTML = `<div class="tiny text-red-600 p-4">Could not load ERP: ${err.message}</div>`;
      console.error(err);
    }
  }

  function restrictErpInteractions() {
    // Will try to find tables/forms inside erpContainer and add restrictions
    // This is heuristic — real schoolerp structure may require adjustments
    try {
      const container = ui.erpContainer;
      // Find any attendance tables
      qsa('table', container).forEach(table => {
        // mark class column cells and disable editing for rows not in teacher's class
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        rows.forEach(row => {
          // look for a cell containing class name or admission number + class
          const rowText = row.innerText || '';
          // if row contains teacher class
          if (!state.class || !rowText.includes(state.class)) {
            // add muted style and prevent inputs inside this row
            row.style.opacity = 0.6;
            row.querySelectorAll('input, button, select, textarea').forEach(inp => {
              inp.setAttribute('disabled', 'disabled');
              inp.title = 'Editing restricted to class teacher';
            });
          } else {
            // allow editing for this class only
            row.querySelectorAll('input, button, select, textarea').forEach(inp => {
              inp.removeAttribute('disabled');
            });
          }
        });
      });

      // any links/buttons that would attempt to navigate to admission must show alert
      qsa('a, button', container).forEach(el => {
        if ((el.innerText || '').toLowerCase().includes('admit')) {
          el.addEventListener('click', (e) => { e.preventDefault(); alert('Admissions are restricted. Contact admin.'); });
        }
      });
    } catch (err) {
      console.warn('restrictErpInteractions error', err);
    }
  }

  /******************************************
   * Open Attendance ERP (similar to academic but loads the attendance section)
   ******************************************/
  async function openAttendanceERP() {
    // reuse academic fetch, but show only attendance related elements
    switchPanel('attendance');
    ui.attendanceErpContainer.innerHTML = '<div class="tiny muted p-4">Loading ERP attendance view...</div>';
    try {
      const res = await fetch('/schoolerp.html', { cache: 'no-store' });
      if (!res.ok) throw new Error('Could not fetch schoolerp.html');
      const htmlText = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, 'text/html');

      // Try to find attendance section by searching text
      let attendanceNodes = qsa('*', doc).filter(n => (n.innerText||'').toLowerCase().includes('attendance'));
      // if none, show whole sanitized ERP (we still hide admissions)
      if (!attendanceNodes || attendanceNodes.length === 0) {
        // fallback: reuse openAcademicERP logic
        await openAcademicERP();
        ui.attendanceErpContainer.innerHTML = ui.erpContainer.innerHTML;
        restrictErpInteractions();
        return;
      }

      // Create container and append clones of attendanceSections
      ui.attendanceErpContainer.innerHTML = '';
      const header = document.createElement('div');
      header.className = 'card tiny mb-3';
      header.innerHTML = `<strong>ERP Attendance — Sanitized</strong><div class="tiny muted">You can edit only your class's attendance rows.</div>`;
      ui.attendanceErpContainer.appendChild(header);

      // find the nearest containers for these nodes and append them
      const appended = new Set();
      attendanceNodes.slice(0, 12).forEach(n => {
        let candidate = n;
        // find an ancestor container that groups the section
        while (candidate && candidate.tagName !== 'SECTION' && candidate.tagName !== 'DIV' && candidate.tagName !== 'MAIN' && candidate.parentNode) {
          candidate = candidate.parentNode;
        }
        if (!candidate) candidate = n;
        if (!appended.has(candidate)) {
          ui.attendanceErpContainer.appendChild(document.importNode(candidate, true));
          appended.add(candidate);
        }
      });

      // hide admissions in the attendance view as well
      qsa('[id*="admiss"], [class*="admiss"], [id*="admit"], [class*="admit"]', ui.attendanceErpContainer).forEach(n => {
        const ph = document.createElement('div');
        ph.className = 'tiny muted card';
        ph.innerHTML = '<strong>Admissions</strong><div class="tiny muted">Admissions are restricted for teachers.</div>';
        if (n.parentNode) n.parentNode.replaceChild(ph, n);
      });

      // Restrict edits to other classes
      restrictErpInteractions();

      addActivity('Opened attendance ERP view (sanitized).');
    } catch (err) {
      ui.attendanceErpContainer.innerHTML = `<div class="tiny text-red-600 p-4">Could not load attendance ERP: ${err.message}</div>`;
      console.error(err);
    }
  }

  /******************************************
   * Scoresheet UI: load students and build table rows
   ******************************************/
  async function loadScoresheetUI() {
    const className = ui.scoresClassSelect.value || state.class;
    const stream = ui.scoresStreamSelect.value || 'A';
    // filter students for class+stream
    const students = state.students.filter(s => s.stream === stream || !s.stream);
    if (!students.length) {
      ui.scoresBody.innerHTML = '<tr><td colspan="14" class="tiny p-6 muted text-center">No students in this stream.</td></tr>';
      return;
    }
    // try to load subjects list from db or use placeholder subjects
    let subjects = [];
    try {
      const subjSnap = await db.ref('subjects').once('value');
      subjects = subjSnap.val() ? Object.values(subjSnap.val()) : [];
    } catch (err) {
      subjects = ['Mathematics','English','Science','Social Studies'];
    }
    // Build header (we keep original header but ensure Max/subject could be added)
    // Build table rows
    ui.scoresBody.innerHTML = '';
    students.forEach((s, idx) => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${s.admissionNumber || '—'}</td>
        <td>${s.firstName || ''} ${s.lastName || ''}</td>
        <td>${s.feePerYear || '0'}</td>
        <td>${s.paidAmount || '0'}</td>
        <td>${s.balance || '0'}</td>
        <td><input class="input-mini total-input" data-adm="${s.admissionNumber}" value="0"></td>
        <td><input class="input-mini max-input" data-adm="${s.admissionNumber}" value="${ui.inputMax.value || 100}"></td>
        <td><input class="input-mini pct-input" data-adm="${s.admissionNumber}" value="0" readonly></td>
        <td><input class="input-mini pos-input" data-adm="${s.admissionNumber}" value="0" readonly></td>
        <td><input class="input-mini grade-input" data-adm="${s.admissionNumber}" value="-" readonly></td>
        <td><input class="input-mini present-input" data-adm="${s.admissionNumber}" value="P"></td>
        <td><input class="input-mini absent-input" data-adm="${s.admissionNumber}" value="0"></td>
        <td><input class="input-mini comment-input" data-adm="${s.admissionNumber}" value=""></td>
      `;
      ui.scoresBody.appendChild(tr);
    });

    // attach change listeners
    qsa('.total-input').forEach(el => el.addEventListener('input', () => recalculateScoresheet()));
    qsa('.max-input').forEach(el => el.addEventListener('input', () => recalculateScoresheet()));

    recalculateScoresheet();
    addActivity(`Loaded scoresheet for ${className} ${stream}`);
  }

  function setAllMax() {
    const max = Number(ui.inputMax.value || 100);
    qsa('.max-input').forEach(inp => { inp.value = max; });
    recalculateScoresheet();
    addActivity(`Set all Max to ${max}`);
  }

  function recalculateScoresheet() {
    // compute % avg based on Total/Max and set grade/position
    const rows = Array.from(document.querySelectorAll('#scoresheet-body tr'));
    const entries = rows.map(row => {
      const adm = row.querySelector('.total-input')?.getAttribute('data-adm');
      const total = Number(row.querySelector('.total-input')?.value || 0);
      const max = Number(row.querySelector('.max-input')?.value || 100);
      const pct = max ? ((total / max) * 100) : 0;
      return { adm, total, max, pct, row };
    });
    // sort by pct desc to decide positions
    entries.sort((a,b) => b.pct - a.pct);
    entries.forEach((e, idx) => {
      const pos = idx + 1;
      e.row.querySelector('.pct-input').value = e.pct.toFixed(1);
      e.row.querySelector('.pos-input').value = pos;
      e.row.querySelector('.grade-input').value = gradeFromPercent(e.pct);
    });
    addActivity('Recalculated scoresheet (autos).');
  }

  function gradeFromPercent(p) {
    if (p >= 80) return 'A';
    if (p >= 65) return 'B';
    if (p >= 50) return 'C';
    if (p >= 35) return 'D';
    return 'E';
  }

  async function saveScoresheetToFirebase() {
    // gather entries and write to path: scores/2025/<class>/<examType>/<month>/<admission>/<subjectid>...
    const year = '2025';
    const examType = document.getElementById('scores-examtype-select').value || 'monthly';
    const month = document.getElementById('scores-month-select').value || '08';
    const className = ui.scoresClassSelect.value || state.class;
    const stream = ui.scoresStreamSelect.value || state.stream;
    const pathBase = `scores/${year}/${className}/${examType}/${month}`;

    const rows = Array.from(document.querySelectorAll('#scoresheet-body tr'));
    if (!rows.length) {
      alert('No rows to save.');
      return;
    }
    const updates = {};
    rows.forEach(row => {
      const adm = row.querySelector('.total-input')?.getAttribute('data-adm');
      if (!adm) return;
      // For this simple implementation we will save a single "aggregate" record with total & meta.
      const total = Number(row.querySelector('.total-input')?.value || 0);
      const max = Number(row.querySelector('.max-input')?.value || 100);
      const pct = Number(row.querySelector('.pct-input')?.value || 0);
      const grade = row.querySelector('.grade-input')?.value || '-';
      const present = row.querySelector('.present-input')?.value || 'P';
      const absent = Number(row.querySelector('.absent-input')?.value || 0);
      const comment = row.querySelector('.comment-input')?.value || '';

      // Save as a 'total' subject record. Full subject-level save would require per-subject inputs
      updates[`${pathBase}/${adm}/TOTAL`] = {
        score: total,
        max,
        pct,
        grade,
        present,
        absent,
        comment,
        updatedBy: state.user.email,
        updatedAt: Date.now()
      };
    });

    try {
      await db.ref().update(updates);
      addActivity(`Saved scoresheet: ${Object.keys(updates).length} student records updated.`);
      alert('Scores saved successfully.');
    } catch (err) {
      console.error(err);
      alert('Error saving scores: ' + err.message);
    }
  }

  function exportScoresheetCSV() {
    // compose CSV from current table
    const rows = Array.from(document.querySelectorAll('#scoresheet-body tr'));
    if (!rows.length) { alert('No data to export.'); return; }
    const headers = ['Adm','Student','Fee Due','Paid','Balance','Total','Max','% Avg','Overall Pos','Grade','Present','Absent','Teacher Comment'];
    const csv = [headers.join(',')];
    rows.forEach(row => {
      const cells = [];
      cells.push(row.cells[1]?.innerText || ''); // adm
      cells.push(row.cells[2]?.innerText || ''); // student name
      cells.push(row.cells[3]?.innerText || '');
      cells.push(row.cells[4]?.innerText || '');
      cells.push(row.cells[5]?.innerText || '');
      cells.push(row.querySelector('.total-input')?.value || '');
      cells.push(row.querySelector('.max-input')?.value || '');
      cells.push(row.querySelector('.pct-input')?.value || '');
      cells.push(row.querySelector('.pos-input')?.value || '');
      cells.push(row.querySelector('.grade-input')?.value || '');
      cells.push(row.querySelector('.present-input')?.value || '');
      cells.push(row.querySelector('.absent-input')?.value || '');
      cells.push(row.querySelector('.comment-input')?.value || '');
      csv.push(cells.map(c => `"${String(c).replace(/"/g,'""')}"`).join(','));
    });
    const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `scoresheet-${state.class || 'class'}-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    addActivity('Exported scoresheet CSV.');
  }

  /******************************************
   * Small helpful bootstrapping: Try to auto-load initial data again in case of slow DB
   ******************************************/
  setTimeout(() => {
    if (!state.user) return;
    if (state.userData?.role === 'teacher' && (!state.students || !state.students.length)) {
      loadInitialClassData();
    }
  }, 2500);

  /******************************************
   * Convenience: show dashboard at first
   ******************************************/
  switchPanel('dashboard');

  </script>
</body>
</html>