<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoMAp — Teacher Dashboard</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Firebase (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    /* Custom visual polish */
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,#f6f8fb 0%, #eef2ff 100%); }
    .sidebar { width: 72px; min-width:72px; background: linear-gradient(180deg,#0f172a,#312e81); height:100vh; position:fixed; left:0; top:0; padding:1rem 0; display:flex; flex-direction:column; align-items:center; gap:0.75rem; z-index:40 }
    .sidebar .icon { width:48px; height:48px; border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; cursor:pointer; }
    .sidebar .icon:hover { background: rgba(255,255,255,0.06); transform: translateY(-2px); }
    .tooltip { position:absolute; left:80px; padding:6px 10px; background:rgba(15,23,42,0.95); color:#fff; font-size:13px; border-radius:6px; display:none; }
    .main { margin-left:96px; padding:1.5rem; }
    .card { background: white; border-radius:12px; box-shadow: 0 6px 18px rgba(16,24,40,0.06); padding:1rem; }
    .accent { background: linear-gradient(90deg,#06b6d4,#7c3aed); color:white }
    .muted { color:#6b7280 }
    .small { font-size:13px }
    /* Responsive big table styles */
    .table { width:100%; border-collapse:collapse }
    .table th, .table td { padding:0.6rem 0.6rem; border-bottom:1px solid #eef2ff; text-align:left; font-size:13px }
    .sticky-top { position:sticky; top:0; background:white; z-index:10 }
    .badge { display:inline-block; padding:6px 10px; border-radius:9999px; font-weight:600; font-size:12px }
    .hidden-by-teacher { opacity:0.45; pointer-events:none }
    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:60 }
    .modal { background:white; border-radius:12px; padding:1.25rem; width:560px; max-width:94% }
  </style>
</head>
<body>
  <div class="sidebar" id="leftSidebar">
    <img src="images/somap-logo.png.jpg" alt="SoMAp" class="w-10 h-10 rounded-md" style="object-fit:cover;">

    <div title="Dashboard" class="icon" id="nav-dashboard">
      <i class="fa-solid fa-chart-simple fa-lg"></i>
    </div>

    <div title="Academic (ERP view)" class="icon" id="nav-academic">
      <i class="fa-solid fa-graduation-cap fa-lg"></i>
    </div>

    <div title="Attendance" class="icon" id="nav-attendance">
      <i class="fa-solid fa-calendar-check fa-lg"></i>
    </div>

    <div title="School ERP (restricted admissions)" class="icon" id="nav-schoolerp">
      <i class="fa-solid fa-building-columns fa-lg"></i>
    </div>

    <div title="Messages" class="icon" id="nav-messages">
      <i class="fa-solid fa-comment-dots fa-lg"></i>
    </div>

    <div title="Logout" class="icon" id="nav-logout">
      <i class="fa-solid fa-right-from-bracket fa-lg"></i>
    </div>

  </div>

  <main class="main">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">Teacher Dashboard</h1>
        <p class="muted small">Personalised view for your class, connected realtime with SoMAp ERP</p>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <div id="teacher-name" class="font-semibold">Loading...</div>
          <div id="teacher-class" class="muted small">—</div>
        </div>
      </div>
    </div>

    <!-- Top quick cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <div class="muted small">Class</div>
            <div id="card-class" class="font-semibold text-lg">—</div>
          </div>
          <div>
            <div class="muted small">Stream</div>
            <div id="card-stream" class="font-semibold">—</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div>
          <div class="muted small">% Present (This month)</div>
          <div id="card-present" class="font-semibold text-lg">—</div>
          <div class="muted small mt-1" id="present-details">—</div>
        </div>
      </div>
      <div class="card">
        <div>
          <div class="muted small">Fee Summary (Class)</div>
          <div id="card-fee-summary" class="font-semibold text-lg">—</div>
          <div class="muted small mt-1" id="fees-details">—</div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left column: Academic controls -->
      <section class="card lg:col-span-2" id="academicSection">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h2 class="text-xl font-semibold">Academic & Exams</h2>
            <p class="muted small">Scores • Rankings • Reports — only for your class</p>
          </div>
          <div class="flex items-center gap-2">
            <select id="select-exam-type" class="form-select small p-2 rounded border" style="min-width:140px">
              <option value="monthly">Monthly</option>
              <option value="term">Term</option>
              <option value="annual">Annual</option>
            </select>
            <select id="select-month" class="form-select small p-2 rounded border">
              <option value="">Select Month</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            <input id="academic-year" type="number" class="form-input small p-2 rounded border" placeholder="2025" style="width:100px" />
          </div>
        </div>

        <div class="mb-4 flex items-center gap-3">
          <button id="btn-save-scores" class="btn accent px-4 py-2 rounded shadow">Save Scores</button>
          <button id="btn-export-csv" class="px-4 py-2 rounded border">CSV</button>
          <button id="btn-export-excel" class="px-4 py-2 rounded border">Excel</button>
          <button id="btn-print" class="px-4 py-2 rounded border">Print</button>
          <div class="ml-auto muted small">Top Student: <span id="top-student">—</span></div>
        </div>

        <!-- Scoresheet table -->
        <div class="overflow-x-auto">
          <table class="table" id="scoresheetTable">
            <thead class="sticky-top">
              <tr>
                <th>#</th>
                <th>Adm</th>
                <th>Student</th>
                <th class="text-center">Fee Due</th>
                <th class="text-center">Paid</th>
                <th class="text-center">Balance</th>
                <th class="text-center">Total</th>
                <th class="text-center">Max</th>
                <th class="text-center">% Avg</th>
                <th class="text-center">Overall Pos</th>
                <th class="text-center">Grade</th>
                <th class="text-center">Present</th>
                <th class="text-center">Absent</th>
                <th>Teacher Comment</th>
              </tr>
            </thead>
            <tbody id="scoresheetBody">
              <tr><td colspan="14" class="muted small p-4">Loading scores for your class…</td></tr>
            </tbody>
          </table>
        </div>

      </section>

      <!-- Right column: Analytics & quick stats -->
      <aside class="space-y-6">
        <div class="card">
          <h3 class="font-semibold">Subject Performance (Class)</h3>
          <div id="subject-performance" class="mt-2 muted small">Calculating…</div>
        </div>

        <div class="card">
          <h3 class="font-semibold">Attendance Snapshot</h3>
          <div id="attendanceSnapshot">Loading…</div>
          <div class="mt-3">
            <button id="openFullAttendance" class="px-3 py-2 rounded border small">Open Attendance (ERP)</button>
          </div>
        </div>

        <div class="card">
          <h3 class="font-semibold">Fee quick actions</h3>
          <div class="mt-2 muted small" id="feeQuick">Loading…</div>
        </div>
      </aside>
    </div>

    <!-- School ERP embedded view (but with Admissions hidden for teachers) -->
    <section id="schoolerpView" class="card mt-6 hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">SoMAp ERP (limited for teachers)</h2>
        <div class="muted small">Manage academic and admin parts (Admissions restricted)</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card">
          <h4 class="font-semibold">Admissions</h4>
          <p class="muted small">Admissions area is restricted for Teacher accounts.</p>
          <div class="mt-3">
            <button id="openAdmissions" class="px-3 py-2 rounded border hidden-by-teacher">Open Admissions</button>
            <button id="openAdmissionsRestricted" class="px-3 py-2 rounded border">Request Access</button>
          </div>
        </div>
        <div class="card">
          <h4 class="font-semibold">Academics</h4>
          <p class="muted small">Open full academic module (read/write for your class only).</p>
          <div class="mt-3">
            <button id="openERPAcademic" class="px-3 py-2 rounded border">Open Academics</button>
          </div>
        </div>
        <div class="card">
          <h4 class="font-semibold">Attendance</h4>
          <p class="muted small">View class attendance analytics and mark for your class.</p>
          <div class="mt-3">
            <button id="openERPAttendance" class="px-3 py-2 rounded border">Open Attendance</button>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <h4 class="font-semibold">Quick links</h4>
        <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="card small">Students List <span class="muted">(view only)</span></div>
          <div class="card small">Discipline <span class="muted">(view & comment)</span></div>
          <div class="card small">Transfer Requests <span class="muted">(3 pending)</span></div>
        </div>
      </div>
    </section>

  </main>

  <!-- Modal area -->
  <div id="modalRoot" style="display:none"></div>

  <script>
    // ---------- Firebase config (same project used by your earlier file) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ---------- Local state ----------
    let currentUser = null;
    let teacherClass = null;
    let teacherEmailKey = null;
    let currentStream = 'A';
    let currentExamType = 'monthly';
    let currentMonth = (new Date()).toISOString().slice(5,7); // e.g. '09'
    let currentYear = (new Date()).getFullYear().toString();

    // Utility: convert email to firebase key used in your DB
    function emailToKey(email) {
      return email.replaceAll('.', '_');
    }

    // Tiny modal utility
    function showModal(title, html) {
      const root = document.getElementById('modalRoot');
      root.innerHTML = `<div class="modal-backdrop"><div class="modal"><div class='flex items-center justify-between mb-2'><h3 class='font-semibold'>${title}</h3><button id='closeModal' class='px-2 py-1 rounded border'>Close</button></div><div>${html}</div></div></div>`;
      root.style.display = 'block';
      document.getElementById('closeModal').onclick = () => { root.style.display='none'; root.innerHTML=''; };
    }

    // On auth state change: ensure teacher role, load class
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // Not signed in - redirect to login
        window.location.href = 'index.html';
        return;
      }
      currentUser = user;
      teacherEmailKey = emailToKey(user.email || user.providerData?.[0]?.email || 'unknown');

      const userRef = db.ref('users/' + teacherEmailKey);
      const snap = await userRef.once('value');
      const userData = snap.val();
      if (!userData) {
        alert('No user record found. Contact admin.');
        auth.signOut();
        return;
      }
      if (!userData.role || userData.role !== 'teacher') {
        alert('Unauthorized: you are not a teacher.');
        auth.signOut();
        return;
      }

      teacherClass = userData.class || userData.classLevel || userData.className || null;
      if (!teacherClass) {
        alert('No class assigned to your teacher account. Contact admin.');
        auth.signOut();
        return;
      }

      // Set up UI header
      document.getElementById('teacher-name').innerText = (user.displayName || user.email).split('@')[0];
      document.getElementById('teacher-class').innerText = teacherClass;
      document.getElementById('card-class').innerText = teacherClass;
      currentStream = 'A';
      document.getElementById('card-stream').innerText = currentStream;

      // Save to local storage for other components
      localStorage.setItem('class', teacherClass);

      // Default year and month
      document.getElementById('academic-year').value = currentYear;
      document.getElementById('select-month').value = currentMonth;

      // Load initial data
      subscribeToClassData();
    });

    // Subscription: listens for students, scores, attendance and updates UI in realtime
    function subscribeToClassData() {
      if (!teacherClass) return;

      // Students
      db.ref('students').on('value', (snap) => {
        const all = snap.val() || {};
        // Filter by class and stream
        const students = Object.values(all).filter(s => s.classLevel === teacherClass && (s.stream || 'A') === currentStream);
        window.__classStudents = students; // global for debugging
        renderScoresheet(students);
        renderFeeSummary(students);
      });

      // Scores: listen on many possible paths (flexible) — we'll listen to scores/<year>/<class> and scores/<year>/<class>/<exam>
      db.ref('scores').on('value', (snap) => {
        // We'll just re-render metrics; scoresheet will pull when needed
        computeTopBottom();
        renderSubjectPerformance();
      });

      // Attendance: listen to relevant class month
      db.ref('attendance').on('value', (snap) => {
        renderAttendanceSnapshot();
        computeTopBottom();
      });
    }

    // ---------- Core renderers ----------
    async function renderScoresheet(students) {
      const tbody = document.getElementById('scoresheetBody');
      tbody.innerHTML = '';

      // Determine subjects by looking at existing 'scores' entries for this class/year/exam
      const year = document.getElementById('academic-year').value || currentYear;
      const examType = document.getElementById('select-exam-type').value || currentExamType;
      const month = document.getElementById('select-month').value || currentMonth;

      // Try to find subjects from DB (scores structure is flexible in your project). We'll attempt multiple paths.
      let subjects = [];
      try {
        const snapshots = [];
        // monthly path
        const monthlyRef = db.ref(`scores/${year}/${teacherClass}/${examType}/${month}`);
        const snapMonthly = await monthlyRef.once('value');
        if (snapMonthly.exists()) snapshots.push(snapMonthly.val());
        // maybe scores stored as scores/<year>/<class>/monthly/<month>/<admissionNo>
        const alternativeRef = db.ref(`scores/${year}/${teacherClass}/${examType}`);
        const snapAlt = await alternativeRef.once('value');
        if (snapAlt.exists()) snapshots.push(snapAlt.val());
        // General fallback: entire scores/year/class
        const generalRef = db.ref(`scores/${year}/${teacherClass}`);
        const snapGen = await generalRef.once('value');
        if (snapGen.exists()) snapshots.push(snapGen.val());

        // Extract keys out of nested objects
        snapshots.forEach(obj => {
          if (!obj) return;
          Object.values(obj).forEach(p => {
            if (typeof p !== 'object') return;
            Object.values(p).forEach(record => {
              if (typeof record === 'object') {
                Object.keys(record).forEach(subject => {
                  if (!subjects.includes(subject) && subject !== 'snap') subjects.push(subject);
                });
              }
            });
          });
        });
      } catch (err) {
        console.warn('Unable to detect subjects automatically', err);
      }

      // If no subjects found, make a small default placeholder so teacher can enter
      if (subjects.length === 0) {
        subjects = ['Math', 'English', 'Science'];
      }

      // Build header columns dynamically: We'll insert columns for each subject between student and Total
      // For simplicity we will not change the original header but we will include total and max etc.

      // Render rows
      if (!students || students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="14" class="muted small p-4">0 students • ${subjects.length} subjects</td></tr>`;
        return;
      }

      students.sort((a,b)=> (a.lastName || '').localeCompare(b.lastName || ''));

      // We'll fetch current scores snapshot for each student to prefill if available
      const yearRef = db.ref(`scores/${year}/${teacherClass}/${examType}`);
      const yearSnap = await yearRef.once('value');
      const scoresData = yearSnap.val() || {};

      // Create row for each student
      students.forEach((s, idx) => {
        const admissionNo = s.admissionNumber || `ADM-${idx+1}`;
        const row = document.createElement('tr');

        // Basic columns
        row.innerHTML = `
          <td class="small">${idx+1}</td>
          <td class="small">${admissionNo}</td>
          <td>${s.firstName || ''} ${s.lastName || ''}</td>
          <td class="text-center small">${s.feePerYear || 0}</td>
          <td class="text-center small">${s.paidAmount || 0}</td>
          <td class="text-center small">${s.balance || 0}</td>
          <td class="text-center small"><input data-adm="${admissionNo}" class="score-total small p-1 text-center" value="0" style="width:70px"/></td>
          <td class="text-center small"><input data-adm-max="${admissionNo}" class="score-max small p-1 text-center" value="100" style="width:70px"/></td>
          <td class="text-center small"><span class="pct-avg">0%</span></td>
          <td class="text-center small pos-col">-</td>
          <td class="text-center small grade-col">-</td>
          <td class="text-center small present-col">-</td>
          <td class="text-center small absent-col">-</td>
          <td><input data-adm-comment="${admissionNo}" class="comment-input small p-1" placeholder="Comment" style="width:100%"/></td>
        `;

        tbody.appendChild(row);

        // Pre-fill totals if there is saved data: try to compute from scoresData
        const adScores = findStudentScoreForAdmission(scoresData, admissionNo);
        if (adScores) {
          // adScores expected to have individual subject keys with {score:..., max:...}
          let total = 0; let maxTotal = 0; let count = 0;
          Object.keys(adScores).forEach(k => {
            if (k === 'snap') return;
            const val = adScores[k];
            if (val && typeof val === 'object' && val.score != null) {
              total += Number(val.score || 0);
              maxTotal += Number(val.max != null ? val.max : 100);
              count++;
            }
          });
          const pct = maxTotal ? (total / maxTotal * 100) : 0;
          row.querySelector('.score-total').value = total.toFixed(1);
          row.querySelector('.score-max').value = maxTotal;
          row.querySelector('.pct-avg').innerText = pct.toFixed(1) + '%';
          row.querySelector('.comment-input').value = (adScores.snap && adScores.snap.teacherComment) || '';
        }

      });

      // After rows created compute present/absent
      renderPresentAbsentForRows();
      computeOverallPositions();
      renderSubjectPerformance();
    }

    // Helper: find student score block in scoresData for a given admissionNo
    function findStudentScoreForAdmission(scoresData, admissionNo) {
      // ScoresData can be nested several levels depending on how the DB was structured.
      // We'll search recursively for an object that has a key matching admissionNo.

      if (!scoresData || typeof scoresData !== 'object') return null;
      // Direct child by admissionNo
      if (scoresData[admissionNo]) return scoresData[admissionNo];

      // Otherwise search nested
      for (const k of Object.keys(scoresData)) {
        const v = scoresData[k];
        if (typeof v === 'object') {
          if (v[admissionNo]) return v[admissionNo];
          // one more level
          for (const k2 of Object.keys(v)) {
            const w = v[k2];
            if (w && typeof w === 'object' && w[admissionNo]) return w[admissionNo];
          }
        }
      }
      return null;
    }

    // Render present/absent info for rows by checking attendance DB
    async function renderPresentAbsentForRows() {
      const tbody = document.getElementById('scoresheetBody');
      const rows = tbody.querySelectorAll('tr');
      const year = document.getElementById('academic-year').value || currentYear;
      const month = document.getElementById('select-month').value || currentMonth;

      // Build a simple map of admission -> {present, absent}
      const attRef = db.ref(`attendance/${teacherClass}/${year}-${month}`);
      const attSnap = await attRef.once('value');
      const attData = attSnap.val() || {};
      // attData may contain days -> admissions
      const perStudent = {};
      Object.values(attData).forEach(dayBlock => {
        if (!dayBlock) return;
        Object.values(dayBlock).forEach(entry => {
          if (!entry || !entry.snap) return;
          const adm = entry.snap.admissionNo || entry.admissionNo || 'unknown';
          perStudent[adm] = perStudent[adm] || {present:0, absent:0};
          if (entry.daily === 'P' || entry.am === 'P' || entry.pm === 'P') perStudent[adm].present += 1;
          else perStudent[adm].absent += 1;
        });
      });

      rows.forEach(row => {
        const adm = row.querySelector('[data-adm]')?.getAttribute('data-adm') || row.querySelector('[data-adm]')?.value;
        const presentCol = row.querySelector('.present-col');
        const absentCol = row.querySelector('.absent-col');
        const stats = perStudent[adm] || {present:0, absent:0};
        if (presentCol) presentCol.innerText = stats.present;
        if (absentCol) absentCol.innerText = stats.absent;
      });
    }

    // Compute overall positions (simple sort by percent) and grades
    function computeOverallPositions() {
      const tbody = document.getElementById('scoresheetBody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const students = [];
      rows.forEach(r => {
        const admInput = r.querySelector('[data-adm]');
        if (!admInput) return;
        const adm = admInput.getAttribute('data-adm');
        const total = Number(r.querySelector('.score-total')?.value || 0);
        const max = Number(r.querySelector('.score-max')?.value || 100);
        const pct = max ? (total / max * 100) : 0;
        students.push({adm, row:r, total, max, pct});
      });
      // Sort by pct desc
      students.sort((a,b) => b.pct - a.pct);
      students.forEach((s, idx) => {
        s.row.querySelector('.pos-col').innerText = idx+1;
        s.row.querySelector('.grade-col').innerText = percentToGrade(s.pct);
        s.row.querySelector('.pct-avg').innerText = s.pct.toFixed(1) + '%';
      });
      // Update top-student
      document.getElementById('top-student').innerText = students[0] ? students[0].row.children[2].innerText : '—';
    }

    function percentToGrade(p) {
      if (p >= 90) return 'A+';
      if (p >= 80) return 'A';
      if (p >= 70) return 'B';
      if (p >= 60) return 'C';
      if (p >= 50) return 'D';
      return 'E';
    }

    // Compute top and bottom students from scores DB
    async function computeTopBottom() {
      const year = document.getElementById('academic-year').value || currentYear;
      const examType = document.getElementById('select-exam-type').value || currentExamType;
      const month = document.getElementById('select-month').value || currentMonth;

      try {
        const ref = db.ref(`scores/${year}/${teacherClass}/${examType}`);
        const snap = await ref.once('value');
        const data = snap.val() || {};
        const scores = [];
        // Flatten
        function walk(obj) {
          if (!obj || typeof obj !== 'object') return;
          Object.keys(obj).forEach(k => {
            const v = obj[k];
            if (v && typeof v === 'object' && (v.score !== undefined || v.snap)) {
              // assume this is a student-level object
              let total = 0; let maxTotal = 0; let count = 0;
              Object.keys(v).forEach(sub => {
                if (sub === 'snap') return;
                const sc = v[sub];
                if (sc && typeof sc === 'object' && sc.score != null) {
                  total += Number(sc.score || 0);
                  maxTotal += Number(sc.max != null ? sc.max : 100);
                  count++;
                }
              });
              const pct = maxTotal ? (total / maxTotal * 100) : 0;
              scores.push({key:k, total, max: maxTotal, pct});
            } else if (typeof v === 'object') {
              walk(v);
            }
          });
        }
        walk(data);
        scores.sort((a,b)=> b.pct - a.pct);
        const top = scores[0];
        const bottom = scores[scores.length-1];
        const topText = top ? `${top.key} (${top.pct.toFixed(1)}%)` : '—';
        const bottomText = bottom ? `${bottom.key} (${bottom.pct.toFixed(1)}%)` : '—';
        // Try to resolve student names if possible
        document.getElementById('top-student').innerText = topText;
      } catch (err) {
        console.warn('Top/bottom compute error', err);
      }
    }

    // Render subject performance (quick averages)
    async function renderSubjectPerformance() {
      const year = document.getElementById('academic-year').value || currentYear;
      const examType = document.getElementById('select-exam-type').value || currentExamType;
      const month = document.getElementById('select-month').value || currentMonth;
      const subjectDiv = document.getElementById('subject-performance');
      subjectDiv.innerHTML = 'Calculating…';

      try {
        const ref = db.ref(`scores/${year}/${teacherClass}/${examType}`);
        const snap = await ref.once('value');
        const data = snap.val() || {};
        const subjTotals = {}; // subj -> {sum, maxSum, count}
        function walk(o) {
          if (!o || typeof o !== 'object') return;
          Object.values(o).forEach(v => {
            if (v && typeof v === 'object') {
              // assume v contains subjects
              const keys = Object.keys(v).filter(k => k !== 'snap');
              if (keys.length > 0 && keys.some(k => v[k] && v[k].score != null)) {
                keys.forEach(k => {
                  const sc = v[k];
                  if (!sc || typeof sc !== 'object') return;
                  subjTotals[k] = subjTotals[k] || {sum:0, max:0, count:0};
                  subjTotals[k].sum += Number(sc.score || 0);
                  subjTotals[k].max += Number(sc.max != null ? sc.max : 100);
                  subjTotals[k].count++;
                });
              } else {
                walk(v);
              }
            }
          });
        }
        walk(data);
        const lines = [];
        Object.keys(subjTotals).forEach(sub => {
          const s = subjTotals[sub];
          const avg = s.max ? (s.sum / s.max * 100) : 0;
          lines.push(`<div><strong>${sub}</strong> — Avg: ${avg.toFixed(1)}% (${Math.round(s.sum/s.count || 0)} / avg of ${Math.round(s.max/s.count || 100)})</div>`);
        });
        subjectDiv.innerHTML = lines.length ? lines.join('') : '<div class="muted small">No subjects found yet</div>';
      } catch (err) {
        subjectDiv.innerHTML = '<div class="muted small">Error fetching subject performance</div>';
      }
    }

    // Attendance snapshot
    async function renderAttendanceSnapshot() {
      const year = document.getElementById('academic-year').value || currentYear;
      const month = document.getElementById('select-month').value || currentMonth;
      const snapshotDiv = document.getElementById('attendanceSnapshot');
      snapshotDiv.innerHTML = 'Loading…';

      try {
        const attRef = db.ref(`attendance/${teacherClass}/${year}-${month}`);
        const attSnap = await attRef.once('value');
        const att = attSnap.val() || {};
        let present = 0, total = 0;
        Object.values(att).forEach(day => {
          if (!day) return;
          Object.values(day).forEach(entry => {
            if (!entry) return;
            total++;
            if (entry.daily === 'P' || entry.am === 'P' || entry.pm === 'P') present++;
          });
        });
        const pct = total ? (present / total * 100) : 0;
        snapshotDiv.innerHTML = `<div class="font-semibold text-lg">${present}/${total} present</div><div class="muted small">${pct.toFixed(1)}% present this month</div>`;
        document.getElementById('card-present').innerText = `${pct.toFixed(1)}%`;
        document.getElementById('present-details').innerText = `${present} present • ${total-present} absent`;
      } catch (err) {
        snapshotDiv.innerHTML = '<div class="muted small">Unable to load attendance</div>';
      }
    }

    // Fee summary
    function renderFeeSummary(students) {
      const el = document.getElementById('card-fee-summary');
      const feesDetails = document.getElementById('fees-details');
      if (!students) { el.innerText = '—'; feesDetails.innerText='—'; return; }
      let due = 0, paid = 0;
      students.forEach(s => { due += Number(s.feePerYear||0); paid += Number(s.paidAmount||0); });
      const bal = due - paid;
      el.innerText = `${due.toLocaleString()} TSh due • ${paid.toLocaleString()} paid`;
      feesDetails.innerText = `Balance: ${bal.toLocaleString()} TSh`;
      document.getElementById('feeQuick').innerText = `${students.length} students • Balance ${bal.toLocaleString()} TSh`;
    }

    // ---------- Actions: Save scores, export CSV, print ----------
    document.getElementById('btn-save-scores').addEventListener('click', async () => {
      if (!teacherClass) return alert('Teacher class not loaded');
      const year = document.getElementById('academic-year').value || currentYear;
      const examType = document.getElementById('select-exam-type').value || currentExamType;
      const month = document.getElementById('select-month').value || currentMonth;
      const tbody = document.getElementById('scoresheetBody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      if (rows.length === 0) return alert('No data to save');

      const updates = {};
      rows.forEach(r => {
        const adm = r.querySelector('[data-adm]')?.getAttribute('data-adm');
        if (!adm) return;
        // Here we save a compact structure: scores/<year>/<class>/<examType>/<month>/<adm>/snap and totals
        const total = Number(r.querySelector('.score-total')?.value || 0);
        const max = Number(r.querySelector('.score-max')?.value || 0);
        const pctText = r.querySelector('.pct-avg')?.innerText || '0%';
        const pct = Number(pctText.replace('%','')) || 0;
        const comment = r.querySelector('.comment-input')?.value || '';
        // For simplicity we only save 'snapshot' totals at the admission key. Real per-subject saves would require subject inputs.
        const path = `scores/${year}/${teacherClass}/${examType}/${month}/${adm}`;
        updates[path] = { snap: { admissionNo: adm, total, max, pct, teacherComment: comment } };
      });

      // Push updates in one batch
      const promises = [];
      Object.keys(updates).forEach(p => {
        promises.push(db.ref(p).set(updates[p]));
      });
      Promise.all(promises).then(() => {
        alert('Scores saved successfully');
        computeTopBottom();
      }).catch(err => {
        console.error(err);
        alert('Error saving scores');
      });
    });

    // CSV export (simple) — exports current visible scoresheet
    document.getElementById('btn-export-csv').addEventListener('click', () => {
      const rows = Array.from(document.querySelectorAll('#scoresheetBody tr'));
      if (!rows || rows.length === 0) return alert('Nothing to export');
      const lines = [];
      lines.push(['#','Adm','Student','Fee Due','Paid','Balance','Total','Max','% Avg','Position','Grade','Present','Absent','Comment'].join(','));
      rows.forEach(r => {
        const cols = Array.from(r.children).map(td => td.innerText.replace(/,/g,' '));
        lines.push(cols.join(','));
      });
      const csv = lines.join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${teacherClass || 'class'}-scores.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Excel: same CSV but .xls extension for quick open in Excel
    document.getElementById('btn-export-excel').addEventListener('click', () => {
      const rows = Array.from(document.querySelectorAll('#scoresheetBody tr'));
      if (!rows || rows.length === 0) return alert('Nothing to export');
      const lines = [];
      lines.push(['#','Adm','Student','Fee Due','Paid','Balance','Total','Max','% Avg','Position','Grade','Present','Absent','Comment'].join('\t'));
      rows.forEach(r => {
        const cols = Array.from(r.children).map(td => td.innerText.replace(/\t/g,' '));
        lines.push(cols.join('\t'));
      });
      const tsv = lines.join('\n');
      const blob = new Blob([tsv], { type: 'application/vnd.ms-excel' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${teacherClass || 'class'}-scores.xls`;
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('btn-print').addEventListener('click', () => {
      window.print();
    });

    // ---------- Navigation and ERP View logic ----------
    document.getElementById('nav-dashboard').addEventListener('click', () => {
      // Scroll to top/main dashboard
      window.scrollTo({top:0, behavior:'smooth'});
    });
    document.getElementById('nav-academic').addEventListener('click', () => {
      // Show academic section and hide schoolerp view
      document.getElementById('academicSection').scrollIntoView({behavior:'smooth'});
    });
    document.getElementById('nav-attendance').addEventListener('click', () => {
      // Scroll to attendance snapshot
      document.getElementById('attendanceSnapshot').scrollIntoView({behavior:'smooth'});
    });
    document.getElementById('nav-schoolerp').addEventListener('click', () => {
      // Toggle embedded limited ERP view (admissions hidden)
      const v = document.getElementById('schoolerpView');
      v.classList.toggle('hidden');
      if (!v.classList.contains('hidden')) v.scrollIntoView({behavior:'smooth'});
    });

    // Buttons inside ERP area
    document.getElementById('openERPAcademic').addEventListener('click', () => {
      document.getElementById('academicSection').scrollIntoView({behavior:'smooth'});
    });
    document.getElementById('openERPAttendance').addEventListener('click', () => {
      document.getElementById('attendanceSnapshot').scrollIntoView({behavior:'smooth'});
    });
    document.getElementById('openAdmissionsRestricted').addEventListener('click', () => {
      showModal('Admissions Restricted', `<p class='muted small'>Admissions is restricted for Teacher accounts. Please contact the school administrator to request access. Email: socratesschool2020@gmail.com</p>`);
    });

    // Open full attendance view (same as ERP attendance but focused)
    document.getElementById('openFullAttendance').addEventListener('click', () => {
      document.getElementById('schoolerpView').classList.remove('hidden');
      document.getElementById('schoolerpView').scrollIntoView({behavior:'smooth'});
    });

    // Logout
    document.getElementById('nav-logout').addEventListener('click', () => {
      auth.signOut().then(()=> window.location.href = 'index.html');
    });

    // When exam/year/month change, re-render
    document.getElementById('select-exam-type').addEventListener('change', () => { computeTopBottom(); renderSubjectPerformance(); renderScoresheet(window.__classStudents || []); });
    document.getElementById('select-month').addEventListener('change', () => { renderAttendanceSnapshot(); renderScoresheet(window.__classStudents || []); });
    document.getElementById('academic-year').addEventListener('change', () => { renderScoresheet(window.__classStudents || []); renderAttendanceSnapshot(); });

    // Helper: compute grades and other operations can be added here

    // Initial small actions: focus
    document.addEventListener('DOMContentLoaded', () => {
      // show a one-time tip for teachers
      const tip = `<div class='muted small'>Tip: Use the Academic icon (left) to open the full ERP academic view. Admissions actions are disabled for teacher accounts.</div>`;
      //console.log(tip);
    });

  </script>
</body>
</html>
