<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoMAp - Teacher Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: 'Roboto', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            min-height: 100vh; 
        }
        .sidebar { 
            width: 80px; 
            background: linear-gradient(to bottom, #007bff, #6610f2); 
            height: 100vh; 
            position: fixed; 
            padding: 1rem 0; 
            transition: width 0.3s ease; 
        }
        .sidebar.expanded { width: 250px; }
        .sidebar-icon { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 50px; 
            height: 50px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px; 
            color: white; 
            margin: 10px auto; 
            cursor: pointer; 
            transition: all 0.3s; 
            position: relative; 
        }
        .sidebar-icon:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .sidebar-tooltip { 
            position: absolute; 
            left: 60px; 
            background: #333; 
            color: white; 
            padding: 5px 10px; 
            border-radius: 5px; 
            white-space: nowrap; 
            opacity: 0; 
            transition: opacity 0.3s; 
            font-size: 12px; 
        }
        .sidebar-icon:hover .sidebar-tooltip { opacity: 1; }
        .main-content { 
            margin-left: 100px; 
            padding: 1rem; 
            transition: margin-left 0.3s ease; 
        }
        .card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            padding: 1.5rem; 
            margin-bottom: 1rem; 
            border-left: 4px solid #007bff; 
        }
        .card.academic { border-left-color: #28a745; }
        .card.attendance { border-left-color: #ffc107; }
        .card.finance { border-left-color: #17a2b8; }
        .card.discipline { border-left-color: #dc3545; }
        .btn { 
            background: linear-gradient(45deg, #007bff, #0056b3); 
            color: white; 
            padding: 0.75rem 1.5rem; 
            border-radius: 6px; 
            border: none; 
            cursor: pointer; 
            transition: all 0.3s; 
            font-weight: 500; 
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        .btn-secondary { background: linear-gradient(45deg, #6c757d, #495057); }
        .btn-secondary:hover { box-shadow: 0 4px 8px rgba(108,117,125,0.3); }
        .form-control { 
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid #e9ecef; 
            border-radius: 6px; 
            margin-bottom: 0.5rem; 
            transition: border-color 0.3s; 
        }
        .form-control:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25); }
        .table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 1rem; 
        }
        .table th, .table td { 
            padding: 0.75rem; 
            text-align: left; 
            border-bottom: 1px solid #dee2e6; 
        }
        .table th { background: #f8f9fa; font-weight: 600; }
        .table tr:hover { background: #f8f9fa; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .stat-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 1.5rem; 
            border-radius: 10px; 
            text-align: center; 
        }
        .stat-card h3 { font-size: 2rem; margin-bottom: 0.5rem; }
        .hidden { display: none; }
        .section { display: none; }
        .section.active { display: block; }
        #sidebar-toggle { 
            position: fixed; 
            left: 90px; 
            top: 20px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            cursor: pointer; 
            z-index: 1000; 
        }
        .sticky-th th { position: sticky; top:0; background:#fff; z-index:2; }
        .scroll-shadow { box-shadow: inset 0 10px 8px -10px rgba(2,6,23,0.12); }
        #chartSubjects, #chartTop10 { max-width:100%; height:260px; display:block; }
        .bg-white.rounded-2xl.p-4 { overflow:hidden; }
        .min-w-table { min-width:1200px; }
        .grid-tight { gap: 0.5rem; }
        .mb-tight { margin-bottom: 0.5rem; }
        .attendance-table { max-height: 400px; overflow-y: auto; }
        .attendance-checkbox { width: 20px; height: 20px; }
    </style>
</head>
<body>
    <button id="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    
    <div class="flex">
        <div id="sidebar" class="sidebar">
            <img src="images/somap-logo.png.jpg" alt="SoMAp Logo" class="h-12 mx-auto mb-6 rounded-full shadow-lg">
            
            <!-- Dashboard Icon (Default View) -->
            <div class="sidebar-icon" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt text-xl"></i>
                <span class="sidebar-tooltip">Dashboard</span>
            </div>
            
            <!-- Academic Icon -->
            <div class="sidebar-icon" onclick="showSection('academic')">
                <i class="fas fa-book text-xl"></i>
                <span class="sidebar-tooltip">Academic Management</span>
            </div>
            
            <!-- School ERP Icon -->
            <div class="sidebar-icon" onclick="showSection('schoolerp')">
                <i class="fas fa-school text-xl"></i>
                <span class="sidebar-tooltip">School ERP</span>
            </div>
            
            <!-- Attendance Sub-Icon under ERP -->
            <div class="sidebar-icon hidden" id="attendance-icon">
                <i class="fas fa-calendar-check text-xl"></i>
                <span class="sidebar-tooltip">Attendance</span>
            </div>
            
            <!-- Discipline Sub-Icon -->
            <div class="sidebar-icon hidden" id="discipline-icon">
                <i class="fas fa-exclamation-triangle text-xl"></i>
                <span class="sidebar-tooltip">Discipline</span>
            </div>
            
            <!-- Students List Sub-Icon -->
            <div class="sidebar-icon hidden" id="students-icon">
                <i class="fas fa-users text-xl"></i>
                <span class="sidebar-tooltip">Students List</span>
            </div>
            
            <!-- Logout -->
            <div class="sidebar-icon mt-auto" onclick="logout()">
                <i class="fas fa-sign-out-alt text-xl"></i>
                <span class="sidebar-tooltip">Logout</span>
            </div>
        </div>
        
        <div class="main-content">
            <header class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Teacher Dashboard</h1>
                <div class="text-sm text-gray-600">
                    Welcome, <span id="user-name"></span> | Class: <span id="user-class"></span>
                </div>
            </header>
            
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 grid-tight">
                    <!-- Stream Select -->
                    <div class="card mb-tight">
                        <h2 class="text-xl font-semibold mb-2 flex items-center">
                            <i class="fas fa-stream mr-2"></i> Select Stream
                        </h2>
                        <select id="stream-select" class="form-control">
                            <option value="A">Stream A</option>
                            <option value="B">Stream B</option>
                            <option value="Red">Red Stream</option>
                        </select>
                    </div>
                    
                    <!-- Academic Management Card -->
                    <div class="card academic lg:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-graduation-cap mr-2"></i> Academic Management
                        </h2>
                        <div class="stats-grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="stat-card">
                                <h3 id="class-scores-count">-</h3>
                                <p class="text-xs">Average Score</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="top-student">-</h3>
                                <p class="text-xs">Top Student (%)</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="bottom-student">-</h3>
                                <p class="text-xs">Bottom Student (%)</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="class-grade">-</h3>
                                <p class="text-xs">Class Average Grade</p>
                            </div>
                        </div>
                        <button class="btn mt-2" onclick="saveScores()">Save Scores</button>
                    </div>
                    
                    <!-- Attendance Stats -->
                    <div class="card attendance lg:col-span-3">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-calendar mr-2"></i> Attendance Overview
                        </h2>
                        <div class="stats-grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="stat-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                                <h3 id="percent-present">-</h3>
                                <p class="text-xs">% Present (Class Avg)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                                <h3 id="percent-absent">-</h3>
                                <p class="text-xs">% Absent</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                                <h3 id="yellow-alerts">-</h3>
                                <p class="text-xs">Yellow Alerts (≥10 absent days)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);">
                                <h3 id="class-days">-</h3>
                                <p class="text-xs">Class Days (excl. weekends/holidays)</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fee Overview -->
                    <div class="card finance lg:col-span-3">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-money-bill mr-2"></i> Fee Status
                        </h2>
                        <div class="stats-grid grid-cols-1 md:grid-cols-3 gap-2">
                            <div class="stat-card" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                                <h3 id="fee-required">-</h3>
                                <p class="text-xs">Required (Class/Year)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">
                                <h3 id="fee-paid">-</h3>
                                <p class="text-xs">Paid (Aggregated)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                                <h3 id="fee-balance">-</h3>
                                <p class="text-xs">Balance (Outstanding)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Academic Section -->
            <section id="academic" class="section">
                <div class="bg-white rounded-2xl shadow overflow-hidden" style="max-height: 90vh; overflow-y: auto;">
                    <div class="px-4 py-3 border-b flex items-center justify-between sticky top-0 bg-white z-10">
                        <div>
                            <h1 class="text-2xl font-bold">SoMAp — Academic & Exams Module</h1>
                            <p class="text-gray-600">Scores • Rankings • Reports</p>
                            <a href="#" onclick="showSection('dashboard')" class="text-blue-500 hover:underline flex items-center">
                                ← Back <i class="fas fa-arrow-left ml-1"></i>
                            </a>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btnLoad" class="btn text-sm">Load Data</button>
                            <button id="btnSaveAll" class="btn">Save Scores</button>
                            <div class="hidden sm:flex gap-2">
                                <button id="btnExportCSV" class="btn btn-secondary text-xs px-2 py-1">CSV</button>
                                <button id="btnExportXLSX" class="btn btn-secondary text-xs px-2 py-1">Excel</button>
                                <button id="btnExportPDF" class="btn btn-secondary text-xs px-2 py-1">PDF</button>
                                <button id="btnPrint" class="btn btn-secondary text-xs px-2 py-1">Print</button>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <section class="grid grid-cols-1 md:grid-cols-5 gap-3 px-4 py-4 bg-gray-50">
                        <div class="bg-white rounded-2xl p-2 shadow">
                            <label class="text-xs text-slate-500 block mb-1">Class</label>
                            <input id="classInput" class="w-full border rounded px-2 py-1 text-sm" readonly>
                        </div>
                        <div class="bg-white rounded-2xl p-2 shadow">
                            <label class="text-xs text-slate-500 block mb-1">Stream</label>
                            <select id="academic-stream" class="w-full border rounded px-2 py-1 text-sm"></select>
                        </div>
                        <div class="bg-white rounded-2xl p-2 shadow">
                            <label class="text-xs text-slate-500 block mb-1">Exam Type</label>
                            <select id="examType" class="w-full border rounded px-2 py-1 text-sm">
                                <option>Monthly</option><option>Midterm 1</option><option>End Term</option><option>Midterm 2</option><option>Annual</option>
                            </select>
                        </div>
                        <div class="bg-white rounded-2xl p-2 shadow">
                            <label class="text-xs text-slate-500 block mb-1">Month</label>
                            <select id="monthSelect" class="w-full border rounded px-2 py-1 text-sm">
                                <option value="01">January</option><option value="02">February</option><option value="03">March</option>
                                <option value="04">April</option><option value="05">May</option><option value="06">June</option>
                                <option value="07">July</option><option value="08">August</option><option value="09" selected>September</option>
                                <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                            </select>
                        </div>
                        <div class="bg-white rounded-2xl p-2 shadow">
                            <label class="text-xs text-slate-500 block mb-1">Academic Year</label>
                            <input id="yearInput" class="w-full border rounded px-2 py-1 text-sm" value="2025">
                        </div>
                    </section>

                    <!-- KPI + Charts -->
                    <section class="px-4 py-4 grid lg:grid-cols-12 gap-4">
                        <div class="lg:col-span-6 grid grid-cols-2 sm:grid-cols-3 gap-2">
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Top Student</p>
                                <h3 id="kpiTopStudent" class="text-lg font-semibold mt-1">–</h3>
                                <p id="kpiTopScore" class="text-xs text-slate-500">–</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Bottom Student</p>
                                <h3 id="kpiBottomStudent" class="text-lg font-semibold mt-1">–</h3>
                                <p id="kpiBottomScore" class="text-xs text-slate-500">–</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Class Max</p>
                                <h3 id="kpiClassMax" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Highest overall avg</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Class Grade</p>
                                <h3 id="kpiClassGrade" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Avg grade</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">% Present</p>
                                <h3 id="kpiPresent" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Attendance</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">% Absent</p>
                                <h3 id="kpiAbsent" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Attendance</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Fee: Required</p>
                                <h3 id="kpiFeeRequired" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Class/year</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Fee: Paid</p>
                                <h3 id="kpiFeePaid" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Aggregated</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Fee: Balance</p>
                                <h3 id="kpiFeeBalance" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Outstanding</p>
                            </div>
                        </div>

                        <div class="lg:col-span-6 grid gap-2">
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm font-medium">Subject Performance (Class)</p>
                                    <div class="text-xs text-slate-500">Average per subject</div>
                                </div>
                                <canvas id="chartSubjects" class="mt-1"></canvas>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm font-medium">Student Averages (Top 10)</p>
                                    <div class="text-xs text-slate-500">Overall %</div>
                                </div>
                                <canvas id="chartTop10" class="mt-1"></canvas>
                            </div>
                        </div>
                    </section>

                    <!-- Scoresheet -->
                    <section class="px-4 py-3 border-t">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h2 class="text-base font-semibold">Scoresheet</h2>
                                <p class="text-xs text-slate-500">Enter marks per subject • Auto averages • Positions • Grades</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-slate-500 flex items-center gap-1">
                                    Max/100
                                    <input id="globalMaxInput" type="number" min="1" max="100" value="100" class="w-16 px-1 py-1 border rounded">
                                </label>
                                <button id="btnSetAllMax" class="btn text-xs px-2 py-1">Set all Max</button>
                                <button id="btnRecalc" class="btn btn-secondary text-xs px-2 py-1">Recalculate</button>
                            </div>
                        </div>

                        <div class="overflow-auto scroll-shadow" style="max-height:40vh">
                            <table id="scoresTable" class="w-full min-w-table text-sm">
                                <thead class="sticky-th">
                                    <tr class="bg-slate-50">
                                        <th class="p-2 border">#</th>
                                        <th class="p-2 border">Adm</th>
                                        <th class="p-2 border text-left">Student</th>
                                        <th class="p-2 border">Fee Due</th>
                                        <th class="p-2 border">Paid</th>
                                        <th class="p-2 border">Balance</th>
                                        <!-- Dynamic subject headers inserted here -->
                                        <th class="p-2 border">Total</th>
                                        <th class="p-2 border">Max</th>
                                        <th class="p-2 border">% Avg</th>
                                        <th class="p-2 border">Overall Pos</th>
                                        <th class="p-2 border">Grade</th>
                                        <th class="p-2 border">Present</th>
                                        <th class="p-2 border">Absent</th>
                                        <th class="p-2 border">Teacher Comment</th>
                                    </tr>
                                </thead>
                                <tbody id="scoresBody"></tbody>
                            </table>
                        </div>

                        <div class="px-4 py-3 border-t flex items-center justify-between">
                            <div class="text-xs text-slate-500">
                                <span id="lblCount">0</span> students • <span id="lblSubjects">0</span> subjects
                            </div>
                            <div class="flex gap-2">
                                <button id="btnGenerateReports" class="btn text-xs px-2 py-1">Generate Report Cards (PDF)</button>
                                <button id="btnEmailReports" class="btn btn-secondary text-xs px-2 py-1">Email/SMS Links</button>
                            </div>
                        </div>
                    </section>
                </div>
            </section>
            
            <!-- School ERP Section -->
            <section id="schoolerp" class="section">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold">SoMAp ERP - Manage Academic & Administrative Aspects</h1>
                        <a href="#" onclick="showSection('dashboard')" class="text-blue-500 hover:underline flex items-center">
                            ← Back <i class="fas fa-arrow-left ml-1"></i>
                        </a>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <!-- Admissions - Restricted -->
                        <div class="card p-3 text-center" onclick="showAdmissionWarning()">
                            <i class="fas fa-users text-2xl text-gray-400 mb-2"></i>
                            <h3 class="font-semibold text-sm">Admissions</h3>
                            <p class="text-xs">New Applications: 12</p>
                            <p class="text-xs text-gray-500">Contact Admin</p>
                        </div>
                        
                        <!-- Academics -->
                        <div class="card p-3 cursor-pointer hover:bg-gray-50" onclick="showSection('academic')">
                            <i class="fas fa-book text-2xl text-blue-500 mb-2"></i>
                            <h3 class="font-semibold text-sm">Academics</h3>
                            <p class="text-xs">Scores & Reports</p>
                        </div>
                        
                        <!-- Attendance -->
                        <div class="card p-3 cursor-pointer hover:bg-gray-50" onclick="showErpSubsection('attendance')">
                            <i class="fas fa-calendar-check text-2xl text-green-500 mb-2"></i>
                            <h3 class="font-semibold text-sm">Attendance</h3>
                            <p class="text-xs">Mark & View</p>
                        </div>
                        
                        <!-- Discipline -->
                        <div class="card p-3 cursor-pointer hover:bg-gray-50" onclick="showErpSubsection('discipline')">
                            <i class="fas fa-exclamation-triangle text-2xl text-red-500 mb-2"></i>
                            <h3 class="font-semibold text-sm">Discipline</h3>
                            <p class="text-xs">Incidents Log</p>
                        </div>
                    </div>
                    
                    <!-- Students List -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Students List</h2>
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr>
                                        <th>Adm No</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Stream</th>
                                        <th>Fee Due</th>
                                        <th>Paid</th>
                                        <th>Balance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="students-list-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- ERP Subsections -->
                <div id="erp-subsections">
                    <!-- Attendance Subsection - Full Table Style -->
                    <div id="erp-attendance" class="section hidden card mt-4">
                        <h2 class="text-xl font-semibold mb-4">Attendance Management</h2>
                        <div class="flex justify-between mb-4">
                            <div class="flex gap-2">
                                <input type="month" id="attendance-month" value="2025-09" class="form-control w-32">
                                <button class="btn" onclick="loadAttendanceSheet()">Load Month</button>
                            </div>
                            <button class="btn btn-secondary" onclick="saveAttendanceSheet()">Save All</button>
                        </div>
                        <div class="overflow-x-auto attendance-table">
                            <table class="table w-full">
                                <thead class="sticky-th">
                                    <tr>
                                        <th>Student</th>
                                        <!-- Dynamic days headers -->
                                        <th>Present Total</th>
                                        <th>Absent Total</th>
                                        <th>% Present</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-sheet-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Discipline Subsection -->
                    <div id="erp-discipline" class="section hidden card mt-4">
                        <h2 class="text-xl font-semibold mb-4">Discipline Incidents</h2>
                        <form class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4" onsubmit="logIncident(event)">
                            <input type="text" id="incident-student" placeholder="Student Name" class="form-control" required>
                            <textarea id="incident-desc" placeholder="Description" class="form-control" rows="2" required></textarea>
                            <select id="incident-type" class="form-control">
                                <option>Misconduct</option><option>Late</option><option>Other</option>
                            </select>
                            <button type="submit" class="btn">Log Incident</button>
                        </form>
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr><th>Date</th><th>Student</th><th>Type</th><th>Description</th><th>Actions</th></tr>
                                </thead>
                                <tbody id="discipline-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <script>
        // Firebase Config and Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
            authDomain: "somaptestt.firebaseapp.com",
            databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
            projectId: "somaptestt",
            storageBucket: "somaptestt.appspot.com",
            messagingSenderId: "105526245138",
            appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // Global Variables
        let currentUserClass = '';
        let currentStream = 'A';
        let students = [];
        let academicState = {
            students: [], attendance: {}, fees: {}, scores: {}, subjectList: [],
            rowsByAdm: {}, className: '', stream: '', month: '09', year: '2025', examKey: 'monthly', schoolBranch: ''
        };
        let attendanceState = {
            month: '2025-09',
            days: [],
            attendanceData: {},
            rowsByAdm: {}
        };
        let subjectsChart = null, top10Chart = null;
        
        // Subject Configuration by Class - Extended for completeness
        const SUBJECTS_BY_CLASS = {
            'Baby Class': ['Arithmetic', 'Communication', 'Relation', 'CRN', 'Healthcare', 'Arts'],
            'Middle Class': ['Arithmetic', 'Communication', 'Relation', 'CRN', 'Healthcare', 'Arts'],
            'Pre-Unit': ['Arithmetic', 'Communication', 'Relation', 'CRN', 'Healthcare', 'Arts'],
            'Class 1 AB': ['Writing Skills', 'Arithmetic', 'Developing Sports & Arts', 'Health.AREC', 'Kusoma', 'Listening'],
            'Class 2 AB': ['Writing Skills', 'Arithmetic', 'Developing Sports & Arts', 'Health.AREC', 'Kusoma', 'Listening'],
            'Class 3': ['Math', 'English', 'Kiswahili', 'Science', 'Geography', 'Arts', 'History', 'French'],
            'Class 4': ['Math', 'English', 'Kiswahili', 'Science', 'Geography', 'Arts', 'History', 'French'],
            'Class 5': ['Math', 'English', 'Kiswahili', 'Science', 'Geography', 'Arts', 'History', 'French'],
            'Class 6': ['Math', 'English', 'Kiswahili', 'Science', 'Social Studies', 'Civics & Morals'],
            'Class 7': ['Math', 'English', 'Kiswahili', 'Science', 'Social Studies', 'Civics & Morals']
        };
        
        // Exam Type Keys
        const EXAM_KEYS = {
            'Monthly': 'monthly',
            'Midterm 1': 'midterm1',
            'End Term': 'endterm',
            'Midterm 2': 'midterm2',
            'Annual': 'annual'
        };
        
        // Utility Functions
        function letterGrade(pct) {
            const p = Number(pct);
            if (p >= 80.5) return 'A';
            if (p >= 60.5) return 'B';
            if (p >= 40.5) return 'C';
            if (p >= 20.5) return 'D';
            return 'F';
        }
        
        function money(n) {
            n = Number(n || 0);
            return 'TSh ' + n.toLocaleString();
        }
        
        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
        }
        
        // Authentication Handler
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            const userRef = db.ref('users/' + user.email.replace('.', '_'));
            userRef.once('value').then(snapshot => {
                const userData = snapshot.val();
                if (!userData || userData.role !== 'teacher') {
                    alert('Unauthorized access');
                    auth.signOut();
                    window.location.href = 'index.html';
                    return;
                }
                document.getElementById('user-name').textContent = user.email.split('@')[0];
                currentUserClass = userData.class || 'Class 4';
                document.getElementById('user-class').textContent = currentUserClass;
                document.getElementById('classInput').value = currentUserClass;
                localStorage.setItem('class', currentUserClass);
                document.getElementById('stream-select').value = currentStream;
                document.getElementById('academic-stream').value = currentStream;
                loadTeacherData();
            }).catch(error => {
                console.error('Error loading user data:', error);
                alert('Error loading user data. Please log in again.');
                auth.signOut();
            });
        });
        
        // Main Data Loader for Teacher
        function loadTeacherData() {
            // Load students for the teacher's class
            db.ref('students').once('value').then(snapshot => {
                const allStudents = snapshot.val() ? Object.values(snapshot.val()) : [];
                students = allStudents.filter(s => s.classLevel === currentUserClass);
                if (students.length === 0) {
                    alert('No students found for your class. Contact admin.');
                    return;
                }
                updateDashboard();
                updateStudentsList();
                populateAcademicStream();
                loadFeeData();
                loadAttendanceData();
                loadDisciplineData();
            }).catch(error => {
                console.error('Error loading students:', error);
            });
        }
        
        // Populate Academic Stream Select
        function populateAcademicStream() {
            const select = document.getElementById('academic-stream');
            select.innerHTML = '';
            const streams = [...new Set(students.map(s => s.stream || 'A'))].sort();
            streams.forEach(stream => {
                const opt = document.createElement('option');
                opt.value = stream;
                opt.textContent = stream;
                select.appendChild(opt);
            });
            select.value = currentStream;
            select.addEventListener('change', (e) => {
                academicState.stream = e.target.value;
                if (document.getElementById('academic').classList.contains('active')) {
                    loadAcademicData();
                }
            });
        }
        
        // Update Dashboard Stats
        function updateDashboard() {
            const streamStudents = students.filter(s => (s.stream || 'A') === currentStream);
            if (streamStudents.length === 0) {
                document.getElementById('class-scores-count').textContent = 'No Data';
                return;
            }
            
            // Calculate average score from existing scores if available, else mock
            let totalScore = 0;
            streamStudents.forEach(s => {
                // Fetch quick avg from summaries if available, else use placeholder
                totalScore += s.avgScore || 70;
            });
            const avgScore = Math.round(totalScore / streamStudents.length);
            document.getElementById('class-scores-count').textContent = avgScore + '%';
            
            // Top and Bottom Students
            const sortedStudents = streamStudents.sort((a, b) => (b.avgScore || 0) - (a.avgScore || 0));
            const top = sortedStudents[0];
            const bottom = sortedStudents[sortedStudents.length - 1];
            document.getElementById('top-student').innerHTML = top ? `${top.firstName} ${top.lastName}<br><small>${(top.avgScore || 0).toFixed(1)}%</small>` : 'N/A';
            document.getElementById('bottom-student').innerHTML = bottom ? `${bottom.firstName} ${bottom.lastName}<br><small>${(bottom.avgScore || 0).toFixed(1)}%</small>` : 'N/A';
            
            document.getElementById('class-grade').textContent = avgScore + '%';
            
            // Attendance Stats - Fetch real
            const presentPercent = calculateAttendancePercent(streamStudents);
            document.getElementById('percent-present').textContent = presentPercent + '%';
            document.getElementById('percent-absent').textContent = (100 - parseFloat(presentPercent)) + '%';
            document.getElementById('yellow-alerts').textContent = calculateYellowAlerts(streamStudents);
            document.getElementById('class-days').textContent = '20'; // Mock or fetch holidays
            
            // Fee Stats - Using summed fees
            let totalDue = 0, totalPaid = 0, totalBalance = 0;
            streamStudents.forEach(s => {
                const fee = getStudentFee(s.admissionNumber);
                totalDue += fee.required;
                totalPaid += fee.paid;
                totalBalance += fee.balance;
            });
            document.getElementById('fee-required').textContent = money(totalDue);
            document.getElementById('fee-paid').textContent = money(totalPaid);
            document.getElementById('fee-balance').textContent = money(totalBalance);
        }
        
        // Helper to get student fee with fallback
        function getStudentFee(adm) {
            const feeFromState = academicState.fees[adm];
            if (feeFromState) return feeFromState;
            const student = students.find(s => s.admissionNumber === adm);
            if (student) {
                return {
                    required: student.feePerYear || 600000,
                    paid: student.paidAmount || 0,
                    balance: student.balance || (student.feePerYear - student.paidAmount)
                };
            }
            return { required: 0, paid: 0, balance: 0 };
        }
        
        // Calculate Attendance Percent
        function calculateAttendancePercent(streamStudents) {
            // Mock or from state
            return 85.0;
        }
        
        // Calculate Yellow Alerts
        function calculateYellowAlerts(streamStudents) {
            // Mock
            return 2;
        }
        
        // Stream Change Handler
        document.getElementById('stream-select').addEventListener('change', (e) => {
            currentStream = e.target.value;
            updateDashboard();
            if (document.getElementById('academic').classList.contains('active')) {
                loadAcademicData();
            }
            updateStudentsList();
        });
        
        // Load Fee Data with Sum from Payments and Fallback to Students
        function loadFeeData() {
            const year = academicState.year || '2025';
            db.ref(`payments/${year}`).once('value').then(snapshot => {
                const payments = snapshot.val() || {};
                students.forEach(s => {
                    const adm = s.admissionNumber;
                    let paidFromPayments = 0;
                    // Sum payments for this student across all classes if needed
                    Object.keys(payments).forEach(classKey => {
                        const classPayments = payments[classKey];
                        if (classPayments && classPayments[adm]) {
                            paidFromPayments += Object.values(classPayments[adm]).reduce((sum, p) => sum + (p.amount || 0), 0);
                        }
                    });
                    const paid = paidFromPayments || s.paidAmount || 0;
                    const due = s.feePerYear || 600000;
                    const balance = Math.max(0, due - paid);
                    academicState.fees[adm] = { required: due, paid, balance };
                });
                updateDashboard();
                updateStudentsList();
            }).catch(error => {
                console.error('Error loading fees:', error);
                // Fallback to students data
                students.forEach(s => {
                    const adm = s.admissionNumber;
                    academicState.fees[adm] = {
                        required: s.feePerYear || 600000,
                        paid: s.paidAmount || 0,
                        balance: s.balance || 0
                    };
                });
                updateDashboard();
                updateStudentsList();
            });
        }
        
        // Load Attendance Data
        function loadAttendanceData() {
            const year = '2025';
            const month = '09';
            db.ref(`attendance/${currentUserClass}/${year}-${month}`).once('value').then(snapshot => {
                const attData = snapshot.val() || {};
                let totalDays = Object.keys(attData).length || 0;
                let presentDays = 0;
                Object.values(attData).forEach(dayData => {
                    Object.values(dayData).forEach(rec => {
                        if (rec.daily === 'P') presentDays++;
                    });
                });
                const numStudents = students.filter(s => (s.stream || 'A') === currentStream).length;
                const percentPresent = (totalDays > 0 && numStudents > 0) ? (presentDays / (totalDays * numStudents) * 100).toFixed(1) : '0.0';
                document.getElementById('percent-present').textContent = percentPresent + '%';
                document.getElementById('percent-absent').textContent = (100 - parseFloat(percentPresent)) + '%';
                academicState.attendance = attData;
                if (document.getElementById('erp-attendance').classList.contains('active')) {
                    loadAttendanceSheet();
                }
            }).catch(error => {
                console.error('Error loading attendance:', error);
            });
        }
        
        // Load Academic Data
        async function loadAcademicData() {
            try {
                academicState.className = currentUserClass;
                academicState.stream = document.getElementById('academic-stream').value || currentStream;
                academicState.month = document.getElementById('monthSelect').value;
                academicState.year = document.getElementById('yearInput').value;
                academicState.examKey = EXAM_KEYS[document.getElementById('examType').value] || 'monthly';
                
                // Fetch students for stream
                academicState.students = students.filter(s => (s.stream || 'A') === academicState.stream);
                
                // Fetch attendance
                academicState.attendance = await fetchAttendance(academicState.year, academicState.month, academicState.className);
                
                // Fees already loaded
                academicState.scores = await fetchScores({
                    year: academicState.year, 
                    className: academicState.className, 
                    examKey: academicState.examKey, 
                    month: academicState.month
                });
                
                academicState.subjectList = SUBJECTS_BY_CLASS[academicState.className] || [];
                
                if (academicState.students.length === 0) {
                    alert('No students in this stream. Select another.');
                    return;
                }
                
                buildAcademicTable();
                recomputeAll();
                drawCharts();
                updateKPIs();
            } catch (error) {
                console.error('Error loading academic data:', error);
                alert('Error loading data. Check console.');
            }
        }
        
        // Fetch Attendance Helper
        function fetchAttendance(year, month, className) {
            return db.ref(`/attendance/${className}/${year}-${month}`).once('value').then(snapshot => {
                const out = {};
                if (snapshot.exists()) {
                    const val = snapshot.val();
                    Object.keys(val || {}).forEach(adm => {
                        const dayData = val[adm] || {};
                        const present = Object.values(dayData).filter(d => d.daily === 'P').length;
                        const total = Object.keys(dayData).length;
                        out[adm] = { present, absent: total - present, days: total };
                    });
                }
                return out;
            });
        }
        
        // Fetch Scores Helper
        function fetchScores({year, className, examKey, month}) {
            return db.ref(`/scores/${year}/${className}/${examKey}/${month}`).once('value').then(snapshot => {
                const out = {};
                if (snapshot.exists()) {
                    const val = snapshot.val();
                    Object.keys(val || {}).forEach(adm => {
                        out[adm] = {};
                        const subjObj = val[adm] || {};
                        Object.keys(subjObj).forEach(sub => {
                            const o = subjObj[sub] || {};
                            out[adm][sub] = { score: Number(o.score || 0), max: Number(o.max || 100) };
                        });
                    });
                }
                return out;
            });
        }
        
        // Build Academic Table
        function buildAcademicTable() {
            const scoresTable = document.getElementById('scoresTable');
            const theadRow = scoresTable.querySelector('thead tr');
            
            // Clear dynamic subject headers (keep first 6 fixed: # Adm Student FeeDue Paid Balance)
            let totalIndex = 6; // After balance
            while (theadRow.children.length > totalIndex + 3) { // Keep Total Max %Avg
                theadRow.removeChild(theadRow.children[totalIndex]);
            }
            
            // Insert subject triplets
            academicState.subjectList.forEach(subject => {
                const thSubject = document.createElement('th');
                thSubject.className = 'p-2 border';
                thSubject.textContent = subject;
                theadRow.insertBefore(thSubject, theadRow.children[totalIndex]);
                
                const thMax = document.createElement('th');
                thMax.className = 'p-2 border text-center';
                thMax.textContent = 'Max';
                theadRow.insertBefore(thMax, theadRow.children[totalIndex + 1]);
                
                const thPos = document.createElement('th');
                thPos.className = 'p-2 border text-center';
                thPos.textContent = 'Pos';
                theadRow.insertBefore(thPos, theadRow.children[totalIndex + 2]);
                
                totalIndex += 3;
            });
            
            // Build body rows
            const scoresBody = document.getElementById('scoresBody');
            scoresBody.innerHTML = '';
            academicState.rowsByAdm = {};
            
            academicState.students.forEach((s, idx) => {
                const tr = document.createElement('tr');
                tr.className = idx % 2 === 0 ? 'bg-slate-50' : 'bg-white';
                
                // Fixed columns
                tr.innerHTML = `
                    <td class="p-2 border text-center">${idx + 1}</td>
                    <td class="p-2 border text-center">${s.admissionNumber}</td>
                    <td class="p-2 border">
                        <div class="font-medium">${escapeHtml(s.firstName + ' ' + s.lastName)}</div>
                        <div class="text-xs text-slate-500">${s.classLevel} ${s.stream ? `(${s.stream})` : ''}</div>
                    </td>
                `;
                
                const fee = getStudentFee(s.admissionNumber);
                tr.innerHTML += `
                    <td class="p-2 border text-center">${money(fee.required)}</td>
                    <td class="p-2 border text-center">${money(fee.paid)}</td>
                    <td class="p-2 border text-center">${money(fee.balance)}</td>
                `;
                
                // Subject cells
                const subjectCells = {};
                academicState.subjectList.forEach(subject => {
                    const sc = academicState.scores[s.admissionNumber]?.[subject] || { score: '', max: 100 };
                    tr.innerHTML += `
                        <td class="p-1.5 border"><input type="number" min="0" step="0.01" class="w-20 px-2 py-1 border rounded score-input" value="${sc.score}"></td>
                        <td class="p-1.5 border"><input type="number" min="1" class="w-16 px-2 py-1 border rounded max-input" value="${sc.max}"></td>
                        <td class="p-1.5 border text-center"><span class="inline-block w-10 text-center pstn-cell">–</span></td>
                    `;
                    const cells = tr.children[tr.children.length - 3]; // Last three tds
                    const scoreInput = cells.querySelector('.score-input');
                    const maxInput = cells.nextSibling.querySelector('.max-input');
                    const pstnSpan = cells.nextSibling.nextSibling.querySelector('.pstn-cell');
                    scoreInput.addEventListener('input', recomputeAll);
                    maxInput.addEventListener('input', recomputeAll);
                    subjectCells[subject] = { scoreInput, maxInput, pstnSpan };
                });
                
                // Computed columns
                tr.innerHTML += `
                    <td class="p-2 border text-center font-medium">0</td>
                    <td class="p-2 border text-center">0</td>
                    <td class="p-2 border text-center">0.00%</td>
                    <td class="p-2 border text-center">–</td>
                    <td class="p-2 border text-center">–</td>
                `;
                
                // Attendance
                const att = academicState.attendance[s.admissionNumber] || { present: 0, absent: 0 };
                tr.innerHTML += `
                    <td class="p-2 border text-center">${att.present}</td>
                    <td class="p-2 border text-center">${att.absent}</td>
                    <td class="p-2 border"><textarea class="w-full h-10 p-2 border rounded text-xs" placeholder="Teacher comment..."></textarea></td>
                `;
                
                scoresBody.appendChild(tr);
                
                // Store row data
                const rowTds = tr.querySelectorAll('td');
                academicState.rowsByAdm[s.admissionNumber] = {
                    tr,
                    subjectCells,
                    tdTotal: rowTds[totalIndex],
                    tdMax: rowTds[totalIndex + 1],
                    tdAvg: rowTds[totalIndex + 2],
                    tdPstn: rowTds[totalIndex + 3],
                    tdGrade: rowTds[totalIndex + 4],
                    tdPresent: rowTds[rowTds.length - 3],
                    tdAbsent: rowTds[rowTds.length - 2],
                    tdComment: rowTds[rowTds.length - 1].querySelector('textarea'),
                    meta: s
                };
            });
            
            document.getElementById('lblCount').textContent = academicState.students.length;
            document.getElementById('lblSubjects').textContent = academicState.subjectList.length;
        }
        
        // Recompute All for Academic
        function recomputeAll() {
            let perSubject = {};
            Object.keys(academicState.rowsByAdm).forEach(adm => {
                const row = academicState.rowsByAdm[adm];
                let sumScore = 0, sumMax = 0;
                academicState.subjectList.forEach(subject => {
                    const cell = row.subjectCells[subject];
                    const score = Number(cell.scoreInput.value || 0);
                    const max = Math.max(1, Number(cell.maxInput.value || 100));
                    sumScore += score;
                    sumMax += max;
                    const pct = (score / max) * 100;
                    perSubject[subject] = perSubject[subject] || [];
                    perSubject[subject].push({ adm, pct });
                });
                const avgPct = sumMax ? (sumScore / sumMax) * 100 : 0;
                row.tdTotal.textContent = sumScore.toFixed(2);
                row.tdMax.textContent = sumMax.toFixed(0);
                row.tdAvg.textContent = avgPct.toFixed(2) + '%';
                row.tdGrade.textContent = letterGrade(avgPct);
                row._avgPct = avgPct;
            });
            
            // Per subject positions
            academicState.subjectList.forEach(subject => {
                const list = (perSubject[subject] || []).sort((a, b) => b.pct - a.pct);
                list.forEach((item, idx) => {
                    const row = academicState.rowsByAdm[item.adm];
                    row.subjectCells[subject].pstnSpan.textContent = idx + 1;
                });
            });
            
            // Overall positions
            const ranked = Object.keys(academicState.rowsByAdm).map(adm => ({
                adm,
                avg: academicState.rowsByAdm[adm]._avgPct || 0,
                total: parseFloat(academicState.rowsByAdm[adm].tdTotal.textContent) || 0,
                attendance: parseInt(academicState.rowsByAdm[adm].tdPresent.textContent) || 0
            })).sort((a, b) => b.avg - a.avg || b.total - a.total || b.attendance - a.attendance);
            ranked.forEach((r, i) => academicState.rowsByAdm[r.adm].tdPstn.textContent = i + 1);
            
            updateKPIs();
            drawCharts();
        }
        
        // Update KPIs for Academic
        function updateKPIs() {
            const list = Object.values(academicState.rowsByAdm).map(r => ({ name: r.meta.firstName + ' ' + r.meta.lastName, avg: r._avgPct || 0 }));
            if (list.length === 0) return;
            const sorted = [...list].sort((a, b) => b.avg - a.avg);
            const top = sorted[0];
            const bottom = sorted[sorted.length - 1];
            document.getElementById('kpiTopStudent').textContent = top ? top.name : '–';
            document.getElementById('kpiTopScore').textContent = top ? (top.avg).toFixed(2) + '%' : '–';
            document.getElementById('kpiBottomStudent').textContent = bottom ? bottom.name : '–';
            document.getElementById('kpiBottomScore').textContent = bottom ? (bottom.avg).toFixed(2) + '%' : '–';
            document.getElementById('kpiClassMax').textContent = top ? (top.avg).toFixed(2) + '%' : '–';
            const classAvg = sorted.reduce((sum, student) => sum + student.avg, 0) / sorted.length;
            document.getElementById('kpiClassGrade').textContent = letterGrade(classAvg);
            
            // Attendance KPIs
            let sumPresent = 0, sumAbsent = 0, sumDays = 0;
            Object.values(academicState.rowsByAdm).forEach(r => {
                sumPresent += parseInt(r.tdPresent.textContent || 0);
                sumAbsent += parseInt(r.tdAbsent.textContent || 0);
                sumDays += sumPresent + sumAbsent;
            });
            const pctPresent = sumDays ? (sumPresent / sumDays * 100).toFixed(1) : 0;
            const pctAbsent = sumDays ? (sumAbsent / sumDays * 100).toFixed(1) : 0;
            document.getElementById('kpiPresent').textContent = pctPresent + '%';
            document.getElementById('kpiAbsent').textContent = pctAbsent + '%';
            
            // Fee KPIs
            let totalReq = 0, totalPd = 0, totalBal = 0;
            Object.values(academicState.rowsByAdm).forEach(r => {
                const fee = getStudentFee(r.meta.admissionNumber);
                totalReq += fee.required;
                totalPd += fee.paid;
                totalBal += fee.balance;
            });
            document.getElementById('kpiFeeRequired').textContent = money(totalReq);
            document.getElementById('kpiFeePaid').textContent = money(totalPd);
            document.getElementById('kpiFeeBalance').textContent = money(totalBal);
        }
        
        // Draw Charts
        function drawCharts() {
            // Destroy existing charts
            if (subjectsChart) subjectsChart.destroy();
            if (top10Chart) top10Chart.destroy();
            
            const subjects = academicState.subjectList.slice(0, 10); // Limit for chart
            const avgPerSubject = subjects.map(sub => {
                let sum = 0, cnt = 0;
                Object.keys(academicState.rowsByAdm).forEach(adm => {
                    const row = academicState.rowsByAdm[adm];
                    if (row.subjectCells[sub]) {
                        const s = Number(row.subjectCells[sub].scoreInput.value || 0);
                        const m = Math.max(1, Number(row.subjectCells[sub].maxInput.value || 100));
                        sum += (s / m) * 100;
                        cnt++;
                    }
                });
                return cnt ? sum / cnt : 0;
            });
            
            subjectsChart = new Chart(document.getElementById('chartSubjects'), {
                type: 'bar',
                data: { labels: subjects, datasets: [{ label: 'Avg %', data: avgPerSubject, backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
            });
            
            const topList = Object.values(academicState.rowsByAdm).map(r => ({ name: r.meta.firstName + ' ' + r.meta.lastName, avg: r._avgPct || 0 })).sort((a, b) => b.avg - a.avg).slice(0, 10);
            top10Chart = new Chart(document.getElementById('chartTop10'), {
                type: 'bar',
                data: { labels: topList.map(x => x.name), datasets: [{ label: 'Overall %', data: topList.map(x => x.avg), backgroundColor: 'rgba(153, 102, 255, 0.2)', borderColor: 'rgba(153, 102, 255, 1)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }
        
        // Save All Scores
        async function saveAllScores() {
            if (Object.keys(academicState.rowsByAdm).length === 0) {
                alert('No data to save. Load data first.');
                return;
            }
            try {
                const baseRef = db.ref(`/scores/${academicState.year}/${academicState.className}/${academicState.examKey}/${academicState.month}`);
                const payload = {};
                Object.keys(academicState.rowsByAdm).forEach(adm => {
                    payload[adm] = {};
                    academicState.subjectList.forEach(subject => {
                        const cell = academicState.rowsByAdm[adm].subjectCells[subject];
                        const score = Number(cell.scoreInput.value || 0);
                        const max = Number(cell.maxInput.value || 100);
                        payload[adm][subject] = { score, max };
                    });
                });
                await baseRef.set(payload);
                alert('Scores saved successfully!');
            } catch (error) {
                console.error('Error saving scores:', error);
                alert('Error saving scores.');
            }
        }
        
        // Event Listeners for Academic Controls
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnLoad').addEventListener('click', loadAcademicData);
            document.getElementById('btnSaveAll').addEventListener('click', saveAllScores);
            document.getElementById('btnRecalc').addEventListener('click', recomputeAll);
            document.getElementById('btnSetAllMax').addEventListener('click', () => {
                const v = Number(document.getElementById('globalMaxInput').value || 100);
                Object.values(academicState.rowsByAdm).forEach(row => {
                    academicState.subjectList.forEach(subject => {
                        row.subjectCells[subject].maxInput.value = v;
                    });
                });
                recomputeAll();
            });
            document.getElementById('examType').addEventListener('change', () => loadAcademicData());
            document.getElementById('monthSelect').addEventListener('change', () => loadAcademicData());
            document.getElementById('yearInput').addEventListener('change', () => loadAcademicData());
            // Export listeners
            document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
            document.getElementById('btnExportXLSX').addEventListener('click', exportXLSX);
            document.getElementById('btnExportPDF').addEventListener('click', exportPDF);
            document.getElementById('btnPrint').addEventListener('click', () => window.print());
            document.getElementById('btnGenerateReports').addEventListener('click', bulkGenerateReportCards);
            document.getElementById('btnEmailReports').addEventListener('click', () => alert('Email/SMS integration pending.'));
        });
        
        // Export Functions
        function gatherRowsForExport() {
            const rows = [];
            const header = ['#', 'Adm', 'Student', 'Fee Due', 'Paid', 'Balance'];
            academicState.subjectList.forEach(s => header.push(s, 'Max', 'Pos'));
            header.push('Total', 'Max', '% Avg', 'Pos', 'Grade', 'Present', 'Absent', 'Comment');
            rows.push(header);
            Object.keys(academicState.rowsByAdm).forEach(adm => {
                const r = academicState.rowsByAdm[adm];
                let arr = [r.tr.cells[0].textContent, adm, r.meta.firstName + ' ' + r.meta.lastName, r.tdFeeDue.textContent, r.tdPaid.textContent, r.tdBal.textContent];
                academicState.subjectList.forEach(sub => {
                    const c = r.subjectCells[sub];
                    arr.push(c.scoreInput.value || 0, c.maxInput.value || 100, c.pstnSpan.textContent || '');
                });
                arr.push(r.tdTotal.textContent, r.tdMax.textContent, r.tdAvg.textContent, r.tdPstn.textContent, r.tdGrade.textContent, r.tdPresent.textContent, r.tdAbsent.textContent, r.tdComment.value || '');
                rows.push(arr);
            });
            return rows;
        }
        
        function exportCSV() {
            const rows = gatherRowsForExport();
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `Scoresheet_${academicState.className}_${academicState.examKey}_${academicState.year}-${academicState.month}.csv`);
        }
        
        function exportXLSX() {
            const rows = gatherRowsForExport();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Scoresheet');
            XLSX.writeFile(wb, `Scoresheet_${academicState.className}_${academicState.examKey}_${academicState.year}-${academicState.month}.xlsx`);
        }
        
        function exportPDF() {
            const rows = gatherRowsForExport();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'l', unit: 'pt', format: 'a4' });
            const title = `Scoresheet ${academicState.className} ${academicState.examKey} ${academicState.year}/${academicState.month}`;
            doc.setFontSize(14);
            doc.text(title, 40, 40);
            doc.autoTable({
                startY: 60,
                head: [rows[0]],
                body: rows.slice(1),
                styles: { fontSize: 7, cellPadding: 3 },
                headStyles: { fillColor: [37, 99, 235] }
            });
            doc.save(title.replace(/[^A-Za-z0-9_\- ]/g, '_') + '.pdf');
        }
        
        async function bulkGenerateReportCards() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
            const margin = 36;
            const headerColor = [37, 99, 235];
            for (let i = 0; i < academicState.students.length; i++) {
                if (i > 0) doc.addPage();
                const s = academicState.students[i];
                const r = academicState.rowsByAdm[s.admissionNumber];
                doc.setFillColor(...headerColor);
                doc.rect(0, 0, 595, 80, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.text(`${s.schoolName || 'SoMAp School'} — Academic Report`, margin, 40);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.text(`Name: ${s.firstName} ${s.lastName}`, margin, 110);
                doc.text(`Admission: ${s.admissionNumber}`, margin, 130);
                const att = academicState.attendance[s.admissionNumber] || { present: 0, absent: 0, days: 0 };
                const days = att.days || att.present + att.absent;
                const pct = days ? ((att.present / days) * 100).toFixed(1) : '0.0';
                doc.text(`Attendance: ${att.present}/${days} (${pct}%)`, margin, 150);
                const fee = getStudentFee(s.admissionNumber);
                doc.text(`Fees: Required ${fee.required} | Paid ${fee.paid} | Balance ${fee.balance}`, margin, 170);
                
                const tableHead = ['Subject', 'Score', 'Max', '%', 'Pos', 'Grade'];
                const tableBody = academicState.subjectList.map(sub => {
                    const c = r.subjectCells[sub];
                    const sc = Number(c.scoreInput.value || 0);
                    const mx = Number(c.maxInput.value || 100);
                    const pctS = (sc / mx) * 100;
                    const g = letterGrade(pctS);
                    const pstn = c.pstnSpan.textContent || '';
                    return [sub, sc.toFixed(2), mx, pctS.toFixed(2), pstn, g];
                });
                doc.autoTable({
                    head: [tableHead],
                    body: tableBody,
                    startY: 200,
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: headerColor }
                });
                
                const after = doc.lastAutoTable.finalY + 20;
                doc.text(`Overall Average: ${(r._avgPct || 0).toFixed(2)}%`, margin, after);
                doc.text(`Overall Position: ${r.tdPstn.textContent}`, margin, after + 18);
                doc.text(`Overall Grade: ${r.tdGrade.textContent}`, margin, after + 36);
                const comment = r.tdComment.value || '—';
                doc.text('Teacher Comment:', margin, after + 64);
                doc.text(comment, margin, after + 82, { maxWidth: 595 - margin * 2 });
            }
            doc.save(`ReportCards_${academicState.className}_${academicState.examKey}_${academicState.year}.pdf`);
        }
        
        // Attendance Sheet Functions
        function loadAttendanceSheet() {
            const [year, month] = document.getElementById('attendance-month').value.split('-');
            attendanceState.month = document.getElementById('attendance-month').value;
            const daysInMonth = new Date(year, month, 0).getDate();
            attendanceState.days = Array.from({ length: daysInMonth }, (_, i) => String(i + 1).padStart(2, '0'));
            
            db.ref(`attendance/${currentUserClass}/${attendanceState.month}`).once('value').then(snapshot => {
                attendanceState.attendanceData = snapshot.val() || {};
                buildAttendanceSheet();
            });
        }
        
        function buildAttendanceSheet() {
            const tbody = document.getElementById('attendance-sheet-tbody');
            tbody.innerHTML = '';
            const streamStudents = students.filter(s => (s.stream || 'A') === currentStream);
            attendanceState.rowsByAdm = {};
            
            streamStudents.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = Object.keys(attendanceState.rowsByAdm).length % 2 === 0 ? 'bg-slate-50' : 'bg-white';
                
                // Student name
                const tdStudent = document.createElement('td');
                tdStudent.className = 'p-2 border font-medium';
                tdStudent.textContent = s.firstName + ' ' + s.lastName;
                tr.appendChild(tdStudent);
                
                // Day checkboxes
                const dayCells = {};
                attendanceState.days.forEach(day => {
                    const tdDay = document.createElement('td');
                    tdDay.className = 'p-1 border text-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'attendance-checkbox';
                    const dateKey = `${attendanceState.month}-${day}`;
                    const existing = attendanceState.attendanceData[s.admissionNumber]?.[dateKey]?.daily === 'P';
                    checkbox.checked = existing;
                    checkbox.addEventListener('change', () => updateAttendanceTotal(s.admissionNumber));
                    tdDay.appendChild(checkbox);
                    tr.appendChild(tdDay);
                    dayCells[day] = checkbox;
                });
                
                // Totals
                const tdPresent = document.createElement('td');
                tdPresent.className = 'p-2 border text-center font-bold';
                tdPresent.textContent = '0';
                tr.appendChild(tdPresent);
                
                const tdAbsent = document.createElement('td');
                tdAbsent.className = 'p-2 border text-center font-bold';
                tdAbsent.textContent = '0';
                tr.appendChild(tdAbsent);
                
                const tdPercent = document.createElement('td');
                tdPercent.className = 'p-2 border text-center';
                tdPercent.textContent = '0%';
                tr.appendChild(tdPercent);
                
                tbody.appendChild(tr);
                
                attendanceState.rowsByAdm[s.admissionNumber] = {
                    tr,
                    dayCells,
                    tdPresent,
                    tdAbsent,
                    tdPercent,
                    meta: s
                };
                
                updateAttendanceTotal(s.admissionNumber);
            });
        }
        
        function updateAttendanceTotal(adm) {
            const row = attendanceState.rowsByAdm[adm];
            if (!row) return;
            
            let presentCount = 0;
            attendanceState.days.forEach(day => {
                if (row.dayCells[day].checked) presentCount++;
            });
            const totalDays = attendanceState.days.length;
            const absentCount = totalDays - presentCount;
            const percent = totalDays ? (presentCount / totalDays * 100).toFixed(1) : 0;
            
            row.tdPresent.textContent = presentCount;
            row.tdAbsent.textContent = absentCount;
            row.tdPercent.textContent = percent + '%';
        }
        
        async function saveAttendanceSheet() {
            const payload = {};
            Object.keys(attendanceState.rowsByAdm).forEach(adm => {
                const row = attendanceState.rowsByAdm[adm];
                payload[adm] = {};
                attendanceState.days.forEach(day => {
                    const dateKey = `${attendanceState.month}-${day}`;
                    const mark = row.dayCells[day].checked ? 'P' : 'A';
                    payload[adm][dateKey] = {
                        am: mark,
                        pm: mark,
                        daily: mark,
                        snap: {
                            admissionNo: adm,
                            name: row.meta.firstName + ' ' + row.meta.lastName,
                            class: row.meta.classLevel,
                            feeDue: row.meta.feePerYear,
                            feePaid: getStudentFee(adm).paid,
                            balance: getStudentFee(adm).balance
                        }
                    };
                });
            });
            try {
                await db.ref(`attendance/${currentUserClass}/${attendanceState.month}`).set(payload);
                alert('Attendance saved!');
                loadAttendanceData(); // Refresh stats
            } catch (error) {
                console.error('Error saving attendance:', error);
                alert('Error saving attendance.');
            }
        }
        
        // Update Students List with Real Fees
        function updateStudentsList() {
            const tbody = document.getElementById('students-list-tbody');
            tbody.innerHTML = '';
            const streamStudents = students.filter(s => (s.stream || 'A') === currentStream);
            streamStudents.forEach(s => {
                const fee = getStudentFee(s.admissionNumber);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${s.admissionNumber}</td>
                    <td>${s.firstName} ${s.lastName}</td>
                    <td>${s.classLevel}</td>
                    <td>${s.stream || 'A'}</td>
                    <td>${money(fee.required)}</td>
                    <td>${money(fee.paid)}</td>
                    <td>${money(fee.balance)}</td>
                    <td><button class="btn btn-secondary text-xs" onclick="viewStudent('${s.admissionNumber}')">View</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function viewStudent(adm) {
            const student = students.find(s => s.admissionNumber === adm);
            if (student) {
                alert(`Student Details:\nName: ${student.firstName} ${student.lastName}\nClass: ${student.classLevel}\nStream: ${student.stream || 'A'}\nFee Due: ${money(student.feePerYear || 0)}\nPaid: ${money(getStudentFee(adm).paid)}\nBalance: ${money(getStudentFee(adm).balance)}`);
            }
        }
        
        // Load Discipline Data
        function loadDisciplineData() {
            db.ref('discipline').orderByChild('class').equalTo(currentUserClass).once('value').then(snapshot => {
                const tbody = document.getElementById('discipline-tbody');
                tbody.innerHTML = '';
                if (snapshot.exists()) {
                    Object.values(snapshot.val() || {}).forEach(inc => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${inc.date || new Date(inc.timestamp).toISOString().split('T')[0]}</td>
                            <td>${inc.student}</td>
                            <td>${inc.type}</td>
                            <td>${inc.desc}</td>
                            <td><button class="btn btn-secondary text-xs" onclick="editIncident('${inc.key}')">Edit</button></td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">No incidents</td></tr>';
                }
            }).catch(error => {
                console.error('Error loading discipline:', error);
            });
        }
        
        function editIncident(key) {
            // Prompt for edit
            const newDesc = prompt('Edit description:');
            if (newDesc !== null) {
                db.ref(`discipline/${key}`).update({ desc: newDesc });
                loadDisciplineData();
            }
        }
        
        // Log Incident
        function logIncident(e) {
            e.preventDefault();
            const student = document.getElementById('incident-student').value;
            const desc = document.getElementById('incident-desc').value;
            const type = document.getElementById('incident-type').value;
            const date = new Date().toISOString().split('T')[0];
            db.ref('discipline').push({
                date,
                student,
                type,
                desc,
                class: currentUserClass,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                alert('Incident logged successfully!');
                e.target.reset();
                loadDisciplineData();
            }).catch(error => {
                console.error('Error logging incident:', error);
                alert('Error logging incident.');
            });
        }
        
        // Section Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            // Show/hide sub-icons
            const subIcons = ['attendance-icon', 'discipline-icon', 'students-icon'];
            if (sectionId === 'schoolerp') {
                subIcons.forEach(id => document.getElementById(id).classList.remove('hidden'));
            } else {
                subIcons.forEach(id => document.getElementById(id).classList.add('hidden'));
            }
            // Load specific data
            if (sectionId === 'academic') {
                populateAcademicStream();
                loadAcademicData();
            } else if (sectionId === 'schoolerp') {
                updateStudentsList();
                loadDisciplineData();
                loadAttendanceSheet(); // Load current month
            }
        }
        
        function showErpSubsection(subId) {
            document.querySelectorAll('#erp-subsections .section').forEach(sec => {
                sec.classList.remove('active');
                sec.classList.add('hidden');
            });
            const subSec = document.getElementById(`erp-${subId}`);
            subSec.classList.remove('hidden');
            subSec.classList.add('active');
            if (subId === 'attendance') {
                loadAttendanceSheet();
            } else if (subId === 'discipline') {
                loadDisciplineData();
            }
        }
        
        // Save Scores Alias
        function saveScores() {
            saveAllScores();
        }
        
        // Restricted Access
        function showAdmissionWarning() {
            alert('Access to Admissions is restricted for teachers. Please contact the admin for new applications.');
        }
        
        // Logout Function
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Logout error:', error);
            });
        }
        
        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
            const mainContent = document.querySelector('.main-content');
            mainContent.style.marginLeft = sidebar.classList.contains('expanded') ? '300px' : '100px';
        }
        
        // Initial Setup
        document.addEventListener('DOMContentLoaded', () => {
            showSection('dashboard');
        });
    </script>
</body>
</html>