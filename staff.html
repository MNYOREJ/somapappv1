<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - SoMApV2.1</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Chart.js for Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tailwind CSS for Styling (bright, modern dashboard) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for Bright Colors and Animations */
        .welcome-flash {
            animation: flash 2s ease-in-out;
        }
        @keyframes flash {
            0% { opacity: 0; transform: scale(1.1); color: #3b82f6; }
            50% { opacity: 1; transform: scale(1); color: #10b981; }
            100% { opacity: 0; transform: scale(1.1); color: #f59e0b; }
        }
        .sidebar-hidden { transform: translateX(-100%); }
        .sidebar-visible { transform: translateX(0); }
        .card-hover { transition: transform 0.2s, box-shadow 0.2s; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        /* Bright Color Scheme */
        .bg-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-success { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .bg-warning { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .bg-danger { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Sidebar (Hidden by default) -->
    <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg sidebar-hidden transition-transform duration-300 ease-in-out">
        <div class="p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-6">Navigation</h2>
            <ul class="space-y-2">
                <li><a href="academic.html" class="flex items-center p-2 text-blue-600 hover:bg-blue-50 rounded"><span class="mr-3">üìö</span>Academic</a></li>
                <li><a href="#" class="flex items-center p-2 text-green-600 hover:bg-green-50 rounded"><span class="mr-3">üìä</span>Attendance</a></li>
                <li><a href="#" class="flex items-center p-2 text-purple-600 hover:bg-purple-50 rounded"><span class="mr-3">üë•</span>Student List</a></li>
                <li><a href="#" class="flex items-center p-2 text-red-600 hover:bg-red-50 rounded"><span class="mr-3">‚ö†Ô∏è</span>Discipline</a></li>
            </ul>
        </div>
    </div>

    <!-- Overlay for Sidebar -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <!-- Main Dashboard -->
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <!-- Top Bar -->
        <nav class="bg-white shadow-md p-4 flex justify-between items-center">
            <button id="menuBtn" class="text-2xl text-gray-600 focus:outline-none">‚ãÆ</button> <!-- Three dots -->
            <div class="flex items-center space-x-4">
                <span id="userInfo" class="text-sm text-gray-600"></span>
                <button id="signOutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Sign Out</button>
            </div>
        </nav>

        <!-- Welcome Flash -->
        <div id="welcomeDiv" class="text-center py-8 welcome-flash hidden">
            <h1 id="welcomeText" class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600"></h1>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 p-6">
            <div class="bg-primary text-white p-6 rounded-lg card-hover">
                <h3 class="text-lg font-semibold">Attendance Rate</h3>
                <p id="attendanceRate" class="text-3xl font-bold mt-2">95%</p>
            </div>
            <div class="bg-success text-white p-6 rounded-lg card-hover">
                <h3 class="text-lg font-semibold">Avg Academic Score</h3>
                <p id="avgScore" class="text-3xl font-bold mt-2">85</p>
            </div>
            <div class="bg-warning text-white p-6 rounded-lg card-hover">
                <h3 class="text-lg font-semibold">Students</h3>
                <p id="totalStudents" class="text-3xl font-bold mt-2">30</p>
            </div>
            <div class="bg-danger text-white p-6 rounded-lg card-hover">
                <h3 class="text-lg font-semibold">Discipline Incidents</h3>
                <p id="incidents" class="text-3xl font-bold mt-2">2</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
            <!-- Attendance Chart -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">Attendance Trend (Last 7 Days)</h3>
                <canvas id="attendanceChart" width="400" height="200"></canvas>
            </div>
            <!-- Academic Performance Chart -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">Subject Scores</h3>
                <canvas id="scoresChart" width="400" height="200"></canvas>
            </div>
            <!-- Discipline Chart -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">Discipline Categories</h3>
                <canvas id="disciplineChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config (Replace with your actual config from Firebase Console)
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "somaptestt.firebaseapp.com",
            databaseURL: "https://somaptestt-default-rtdb.firebaseio.com/",
            projectId: "somaptestt",
            storageBucket: "somaptestt.appspot.com",
            messagingSenderId: "your-sender-id",
            appId: "your-app-id"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentClass = '';
        let userName = '';
        let attendanceChart, scoresChart, disciplineChart;

        // Google Sign-In
        function initGoogleSignIn() {
            google.accounts.id.initialize({
                client_id: 'your-google-client-id', // From Google Cloud Console
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(document.body, { theme: 'outline', size: 'large' });
            google.accounts.id.prompt();
        }

        function handleCredentialResponse(response) {
            const credential = google.accounts.id.parseTokenForCredential(response.credential);
            const email = credential.email;
            userName = credential.given_name || credential.name;
            signInWithEmail(email);
        }

        function signInWithEmail(email) {
            // For simplicity, assume email is used directly; in production, use Firebase Auth
            const safeEmail = email.replace(/\./g, '_');
            database.ref(`users/${safeEmail}`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    currentClass = userData.class;
                    document.getElementById('userInfo').textContent = `${userName} - ${currentClass}`;
                    showWelcome();
                    loadDashboardData();
                } else {
                    alert('User not found. Please contact admin.');
                }
            });
        }

        function showWelcome() {
            const welcomeDiv = document.getElementById('welcomeDiv');
            const welcomeText = document.getElementById('welcomeText');
            welcomeText.textContent = `WELCOME ${userName} - ${currentClass}`;
            welcomeDiv.classList.remove('hidden');
            setTimeout(() => welcomeDiv.classList.add('hidden'), 2000);
        }

        function loadDashboardData() {
            // Live listeners for data filtered by class
            // Attendance Rate (example: average over last 7 days)
            database.ref(`attendance/${currentClass}`).on('value', snapshot => {
                let totalDays = 0, presentDays = 0;
                snapshot.forEach(child => {
                    const dayData = child.val();
                    const present = Object.values(dayData || {}).filter(s => s.present).length;
                    const totalStudents = Object.keys(dayData || {}).length;
                    if (totalStudents > 0) {
                        presentDays += present / totalStudents * 100;
                        totalDays++;
                    }
                });
                const rate = totalDays > 0 ? (presentDays / totalDays).toFixed(0) : 0;
                document.getElementById('attendanceRate').textContent = `${rate}%`;
                updateAttendanceChart(snapshot.val());
            });

            // Avg Score
            database.ref(`academic/${currentClass}`).on('value', snapshot => {
                let totalScores = 0, count = 0;
                snapshot.forEach(subjectSnap => {
                    subjectSnap.forEach(studentSnap => {
                        const scores = studentSnap.val();
                        totalScores += Object.values(scores || {}).reduce((a, b) => a + b, 0);
                        count += Object.keys(scores || {}).length;
                    });
                });
                const avg = count > 0 ? (totalScores / count).toFixed(0) : 0;
                document.getElementById('avgScore').textContent = avg;
                updateScoresChart(snapshot.val());
            });

            // Total Students
            database.ref(`students/${currentClass}`).once('value', snapshot => {
                const total = snapshot.numChildren();
                document.getElementById('totalStudents').textContent = total;
            });

            // Incidents
            database.ref(`discipline/${currentClass}`).on('value', snapshot => {
                const count = snapshot.numChildren();
                document.getElementById('incidents').textContent = count;
                updateDisciplineChart(snapshot.val());
            });
        }

        function updateAttendanceChart(data) {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            if (attendanceChart) attendanceChart.destroy();
            // Assume data structure for last 7 days; adapt as needed
            const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const values = labels.map(() => Math.floor(Math.random() * 20) + 80); // Placeholder; use real data
            attendanceChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Attendance %', data: values, borderColor: '#10b981', tension: 0.1 }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        function updateScoresChart(data) {
            const ctx = document.getElementById('scoresChart').getContext('2d');
            if (scoresChart) scoresChart.destroy();
            // Assume subjects; adapt
            const labels = ['Math', 'English', 'Science', 'History'];
            const values = labels.map(() => Math.floor(Math.random() * 20) + 70); // Placeholder
            scoresChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Avg Score', data: values, backgroundColor: '#3b82f6' }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        function updateDisciplineChart(data) {
            const ctx = document.getElementById('disciplineChart').getContext('2d');
            if (disciplineChart) disciplineChart.destroy();
            // Assume categories; adapt
            const labels = ['Tardiness', 'Misbehavior', 'Bullying'];
            const values = [5, 3, 2]; // Placeholder
            disciplineChart = new Chart(ctx, {
                type: 'pie',
                data: { labels, datasets: [{ data: values, backgroundColor: ['#f59e0b', '#ef4444', '#dc2626'] }] },
                options: { responsive: true }
            });
        }

        // Menu Toggle
        document.getElementById('menuBtn').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('sidebar-hidden');
            sidebar.classList.toggle('sidebar-visible');
            overlay.classList.toggle('hidden');
        });

        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('sidebar-hidden');
            document.getElementById('overlay').classList.add('hidden');
        });

        // Sign Out
        document.getElementById('signOutBtn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'index.html'; // Redirect to login
            });
        });

        // Initialize
        auth.onAuthStateChanged(user => {
            if (user) {
                signInWithEmail(user.email);
            } else {
                initGoogleSignIn();
            }
        });

        // For navigation links, pass class as query param, e.g., academic.html?class=${encodeURIComponent(currentClass)}
        // In academic.html, read from URL and filter data similarly.
        // For scoresheet.html integration: In academic.html, include or iframe scoresheet.html, passing class.
    </script>
</body>
</html>