<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoMAp - Teacher Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .sidebar {
            width: 80px;
            background: linear-gradient(to bottom, #007bff, #6610f2);
            height: 100vh;
            position: fixed;
            padding: 1rem 0;
            transition: width 0.3s ease;
        }
        .sidebar.expanded { width: 250px; }
        .sidebar-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            margin: 10px auto;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .sidebar-icon:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .sidebar-tooltip {
            position: absolute;
            left: 60px;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .sidebar-icon:hover .sidebar-tooltip { opacity: 1; }
        .main-content {
            margin-left: 100px;
            padding: 1rem;
            transition: margin-left 0.3s ease;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }
        .card.academic { border-left-color: #28a745; }
        .card.attendance { border-left-color: #ffc107; }
        .card.finance { border-left-color: #17a2b8; }
        .card.discipline { border-left-color: #dc3545; }
        .btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        .btn-secondary { background: linear-gradient(45deg, #6c757d, #495057); }
        .btn-secondary:hover { box-shadow: 0 4px 8px rgba(108,117,125,0.3); }
        .events-list { list-style: none; padding: 0; }
        .events-list li {
            background: #f8f9fa;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            transition: border-color 0.3s;
        }
        .form-control:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25); }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .table th, .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .table th { background: #f8f9fa; font-weight: 600; }
        .table tr:hover { background: #f8f9fa; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 { font-size: 2rem; margin-bottom: 0.5rem; }
        .hidden { display: none; }
        .section { display: none; }
        .section.active { display: block; }
        #sidebar-toggle {
            position: fixed;
            left: 90px;
            top: 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1000;
        }
        .sticky-th th { position: sticky; top:0; background:#fff; z-index:2; }
        .scroll-shadow { box-shadow: inset 0 10px 8px -10px rgba(2,6,23,0.12); }
        #chartSubjects, #chartTop10 { max-width:100%; height:260px; display:block; }
        .bg-white.rounded-2xl.p-4 { overflow:hidden; }
        .min-w-table { min-width:1200px; }
        .grid-tight { gap: 0.5rem; }
        .mb-tight { margin-bottom: 0.5rem; }
        .disabled-card { cursor: not-allowed; opacity: 0.6; }
    </style>
</head>
<body>
    <button id="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
   
    <div class="flex">
        <div id="sidebar" class="sidebar">
            <img src="images/somap-logo.png.jpg" alt="SoMAp Logo" class="h-12 mx-auto mb-6 rounded-full shadow-lg">
           
            <!-- Dashboard Icon (Default View) -->
            <div class="sidebar-icon" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt text-xl"></i>
                <span class="sidebar-tooltip">Dashboard</span>
            </div>
           
            <!-- Academic Icon -->
            <div class="sidebar-icon" onclick="showSection('academic')">
                <i class="fas fa-book text-xl"></i>
                <span class="sidebar-tooltip">Academic Management</span>
            </div>
           
            <!-- School ERP Icon -->
            <div class="sidebar-icon" onclick="showSection('schoolerp')">
                <i class="fas fa-school text-xl"></i>
                <span class="sidebar-tooltip">School ERP</span>
            </div>
           
            <!-- Attendance Sub-Icon under ERP -->
            <div class="sidebar-icon hidden" id="attendance-icon" onclick="showErpSubsection('attendance')">
                <i class="fas fa-calendar-check text-xl"></i>
                <span class="sidebar-tooltip">Attendance</span>
            </div>
           
            <!-- Discipline Sub-Icon -->
            <div class="sidebar-icon hidden" id="discipline-icon" onclick="showErpSubsection('discipline')">
                <i class="fas fa-exclamation-triangle text-xl"></i>
                <span class="sidebar-tooltip">Discipline</span>
            </div>
           
            <!-- Students List Sub-Icon -->
            <div class="sidebar-icon hidden" id="students-icon" onclick="showErpSubsection('students')">
                <i class="fas fa-users text-xl"></i>
                <span class="sidebar-tooltip">Students List</span>
            </div>
           
            <!-- Logout -->
            <div class="sidebar-icon mt-auto" onclick="logout()">
                <i class="fas fa-sign-out-alt text-xl"></i>
                <span class="sidebar-tooltip">Logout</span>
            </div>
        </div>
       
        <div class="main-content">
            <header class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Teacher Dashboard</h1>
                <div class="text-sm text-gray-600">
                    Welcome, <span id="user-name"></span> | Class: <span id="user-class"></span>
                </div>
            </header>
           
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 grid-tight">
                    <!-- Stream Select -->
                    <div class="card mb-tight">
                        <h2 class="text-xl font-semibold mb-2 flex items-center">
                            <i class="fas fa-stream mr-2"></i> Select Stream
                        </h2>
                        <select id="stream-select" class="form-control">
                            <option value="A">Stream A</option>
                            <option value="B">Stream B</option>
                            <option value="Red">Red Stream</option>
                        </select>
                    </div>
                   
                    <!-- Academic Management Card -->
                    <div class="card academic lg:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-graduation-cap mr-2"></i> Academic Management
                        </h2>
                        <div class="stats-grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="stat-card">
                                <h3 id="class-scores-count">-</h3>
                                <p class="text-xs">Average Score</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="top-student">-</h3>
                                <p class="text-xs">Top Student (%)</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="bottom-student">-</h3>
                                <p class="text-xs">Bottom Student (%)</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="class-grade">-</h3>
                                <p class="text-xs">Class Average Grade</p>
                            </div>
                        </div>
                        <button class="btn mt-2" onclick="showSection('academic')">View Details</button>
                    </div>
                   
                    <!-- Attendance Stats -->
                    <div class="card attendance lg:col-span-3">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-calendar mr-2"></i> Attendance Overview
                        </h2>
                        <div class="stats-grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="stat-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                                <h3 id="percent-present">-</h3>
                                <p class="text-xs">% Present (Class Avg)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                                <h3 id="percent-absent">-</h3>
                                <p class="text-xs">% Absent</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                                <h3 id="yellow-alerts">-</h3>
                                <p class="text-xs">Yellow Alerts (≥10 absent days)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);">
                                <h3 id="class-days">-</h3>
                                <p class="text-xs">Class Days (excl. weekends/holidays)</p>
                            </div>
                        </div>
                        <button class="btn mt-2" onclick="showSection('schoolerp'); showErpSubsection('attendance')">View Details</button>
                    </div>
                   
                    <!-- Fee Overview -->
                    <div class="card finance lg:col-span-3">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-money-bill mr-2"></i> Fee Status
                        </h2>
                        <div class="stats-grid grid-cols-1 md:grid-cols-3 gap-2">
                            <div class="stat-card" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                                <h3 id="fee-required">-</h3>
                                <p class="text-xs">Required (Class/Year)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">
                                <h3 id="fee-paid">-</h3>
                                <p class="text-xs">Paid (Aggregated)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                                <h3 id="fee-balance">-</h3>
                                <p class="text-xs">Balance (Outstanding)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
           
            <!-- Academic Section -->
            <section id="academic" class="section">
                <div class="bg-white rounded-2xl shadow overflow-hidden">
                    <div class="px-4 py-3 border-b flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold">SoMAp — Academic & Exams Module</h1>
                            <p class="text-gray-600 mb-6">Scores • Rankings • Reports</p>
                            <a href="#" onclick="showSection('dashboard')" class="text-blue-500 hover:underline flex items-center">
                                ← Back <i class="fas fa-arrow-left ml-1"></i>
                            </a>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btnSaveAll" class="btn">Save Scores</button>
                            <div class="hidden sm:flex gap-2">
                                <button id="btnExportCSV" class="btn btn-secondary text-xs px-2 py-1">CSV</button>
                                <button id="btnExportXLSX" class="btn btn-secondary text-xs px-2 py-1">Excel</button>
                                <button id="btnExportPDF" class="btn btn-secondary text-xs px-2 py-1">PDF</button>
                                <button id="btnPrint" class="btn btn-secondary text-xs px-2 py-1">Print</button>
                            </div>
                        </div>
                    </div>
                    <!-- Controls (Class fixed, Stream selectable) -->
                    <section class="grid grid-cols-1 md:grid-cols-5 gap-3 px-4 py-4 bg-gray-50">
                        <div class="bg-white rounded-2xl p-2 shadow">
                            <label class="text-xs text-slate-500 block mb-1">Class</label>
                            <input id="classInput" class="w-full border rounded px-2 py-1 text-sm" value="" readonly>
                        </div>
                        <div class="bg-white rounded-2xl p-2 shadow">
                            <label class="text-xs text-slate-500 block mb-1">Stream</label>
                            <select id="academic-stream" class="w-full border rounded px-2 py-1 text-sm"></select>
                        </div>
                        <div class="bg-white rounded-2xl p-2 shadow">
                            <label class="text-xs text-slate-500 block mb-1">Exam Type</label>
                            <select id="examType" class="w-full border rounded px-2 py-1 text-sm">
                                <option>Monthly</option><option>Midterm 1</option><option>End Term</option><option>Midterm 2</option><option>Annual</option>
                            </select>
                        </div>
                        <div class="bg-white rounded-2xl p-2 shadow">
                            <label class="text-xs text-slate-500 block mb-1">Month</label>
                            <select id="monthSelect" class="w-full border rounded px-2 py-1 text-sm">
                                <option value="01">January</option><option value="02">February</option><option value="03">March</option>
                                <option value="04">April</option><option value="05">May</option><option value="06">June</option>
                                <option value="07">July</option><option value="08">August</option><option value="09" selected>September</option>
                                <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                            </select>
                        </div>
                        <div class="bg-white rounded-2xl p-2 shadow">
                            <label class="text-xs text-slate-500 block mb-1">Academic Year</label>
                            <input id="yearInput" class="w-full border rounded px-2 py-1 text-sm" value="2025">
                        </div>
                    </section>
                    <!-- KPI + Charts -->
                    <section class="px-4 py-4 grid lg:grid-cols-12 gap-4">
                        <div class="lg:col-span-6 grid grid-cols-2 sm:grid-cols-3 gap-2">
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Top Student</p>
                                <h3 id="kpiTopStudent" class="text-lg font-semibold mt-1">–</h3>
                                <p id="kpiTopScore" class="text-xs text-slate-500">–</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Bottom Student</p>
                                <h3 id="kpiBottomStudent" class="text-lg font-semibold mt-1">–</h3>
                                <p id="kpiBottomScore" class="text-xs text-slate-500">–</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Class Max</p>
                                <h3 id="kpiClassMax" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Highest overall avg</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Class Grade</p>
                                <h3 id="kpiClassGrade" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Avg grade</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">% Present</p>
                                <h3 id="kpiPresent" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Attendance</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">% Absent</p>
                                <h3 id="kpiAbsent" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Attendance</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Fee: Required</p>
                                <h3 id="kpiFeeRequired" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Class/year</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Fee: Paid</p>
                                <h3 id="kpiFeePaid" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Aggregated</p>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <p class="text-xs text-slate-500">Fee: Balance</p>
                                <h3 id="kpiFeeBalance" class="text-lg font-semibold mt-1">–</h3>
                                <p class="text-xs text-slate-500">Outstanding</p>
                            </div>
                        </div>
                        <div class="lg:col-span-6 grid gap-2">
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm font-medium">Subject Performance (Class)</p>
                                    <div class="text-xs text-slate-500">Average per subject</div>
                                </div>
                                <canvas id="chartSubjects" class="mt-1"></canvas>
                            </div>
                            <div class="bg-white rounded-2xl p-2 shadow">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm font-medium">Student Averages (Top 10)</p>
                                    <div class="text-xs text-slate-500">Overall %</div>
                                </div>
                                <canvas id="chartTop10" class="mt-1"></canvas>
                            </div>
                        </div>
                    </section>
                    <!-- Scoresheet -->
                    <section class="px-4 py-3 border-t">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h2 class="text-base font-semibold">Scoresheet</h2>
                                <p class="text-xs text-slate-500">Enter marks per subject • Auto averages • Positions • Grades</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-slate-500 flex items-center gap-1">
                                    Max/100
                                    <input id="globalMaxInput" type="number" min="1" max="100" value="100" class="w-16 px-1 py-1 border rounded">
                                </label>
                                <button id="btnSetAllMax" class="btn text-xs px-2 py-1">Set all Max</button>
                                <button id="btnRecalc" class="btn btn-secondary text-xs px-2 py-1">Recalculate</button>
                            </div>
                        </div>
                        <div class="overflow-auto scroll-shadow" style="max-height:50vh">
                            <table id="scoresTable" class="w-full min-w-table text-sm">
                                <thead class="sticky-th">
                                    <tr class="bg-slate-50">
                                        <th class="p-2 border">#</th>
                                        <th class="p-2 border">Adm</th>
                                        <th class="p-2 border text-left">Student</th>
                                        <th class="p-2 border">Fee Due</th>
                                        <th class="p-2 border">Paid</th>
                                        <th class="p-2 border">Balance</th>
                                        <th class="p-2 border">Total</th>
                                        <th class="p-2 border">Max</th>
                                        <th class="p-2 border">% Avg</th>
                                        <th class="p-2 border">Overall Pos</th>
                                        <th class="p-2 border">Grade</th>
                                        <th class="p-2 border">Present</th>
                                        <th class="p-2 border">Absent</th>
                                        <th class="p-2 border">Teacher Comment</th>
                                    </tr>
                                </thead>
                                <tbody id="scoresBody"></tbody>
                            </table>
                        </div>
                        <div class="px-4 py-3 border-t flex items-center justify-between">
                            <div class="text-xs text-slate-500">
                                <span id="lblCount">0</span> students • <span id="lblSubjects">0</span> subjects
                            </div>
                            <div class="flex gap-2">
                                <button id="btnGenerateReports" class="btn text-xs px-2 py-1">Generate Report Cards (PDF)</button>
                                <button id="btnEmailReports" class="btn btn-secondary text-xs px-2 py-1">Email/SMS Links</button>
                            </div>
                        </div>
                    </section>
                </div>
            </section>
           
            <!-- School ERP Section -->
            <section id="schoolerp" class="section">
                <div class="card col-span-full">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold">SoMAp ERP - Manage Academic & Administrative Aspects</h1>
                        <a href="#" onclick="showSection('dashboard')" class="text-blue-500 hover:underline flex items-center">
                            ← Back <i class="fas fa-arrow-left ml-1"></i>
                        </a>
                    </div>
                   
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <!-- Admissions - Restricted -->
                        <div class="card p-3 text-center disabled-card" onclick="showAdmissionWarning()">
                            <i class="fas fa-users text-2xl text-gray-400 mb-2"></i>
                            <h3 class="font-semibold text-sm">Admissions</h3>
                            <p class="text-xs">New Applications: 12</p>
                            <p class="text-xs text-gray-500">Contact Admin</p>
                        </div>
                       
                        <!-- Academics -->
                        <div class="card p-3 cursor-pointer hover:bg-gray-50" onclick="showSection('academic')">
                            <i class="fas fa-book text-2xl text-blue-500 mb-2"></i>
                            <h3 class="font-semibold text-sm">Academics</h3>
                            <p class="text-xs">Scores & Reports</p>
                        </div>
                       
                        <!-- Attendance -->
                        <div class="card p-3 cursor-pointer hover:bg-gray-50" onclick="showErpSubsection('attendance')">
                            <i class="fas fa-calendar-check text-2xl text-green-500 mb-2"></i>
                            <h3 class="font-semibold text-sm">Attendance</h3>
                            <p class="text-xs">Mark & View</p>
                        </div>
                       
                        <!-- Discipline -->
                        <div class="card p-3 cursor-pointer hover:bg-gray-50" onclick="showErpSubsection('discipline')">
                            <i class="fas fa-exclamation-triangle text-2xl text-red-500 mb-2"></i>
                            <h3 class="font-semibold text-sm">Discipline</h3>
                            <p class="text-xs">Incidents Log</p>
                        </div>
                    </div>
                   
                    <!-- Students List Subsection -->
                    <div id="erp-students" class="section card hidden mt-4">
                        <h2 class="text-xl font-semibold mb-4">Students List</h2>
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr>
                                        <th>Adm No</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Stream</th>
                                        <th>Fee Due</th>
                                        <th>Paid</th>
                                        <th>Balance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="students-list-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
               
                <!-- ERP Subsections -->
                <div id="erp-subsections">
                    <!-- Attendance Subsection -->
                    <div id="erp-attendance" class="section hidden card mt-4">
                        <h2 class="text-xl font-semibold mb-4">Attendance Management</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input type="text" id="erp-student-name" placeholder="Student Name" class="form-control" required>
                            <input type="date" id="erp-date" value="2025-09-16" class="form-control" required>
                            <select id="erp-mark" class="form-control">
                                <option value="P">Present</option>
                                <option value="A">Absent</option>
                            </select>
                            <button type="button" class="btn" onclick="markErpAttendance()">Mark Attendance</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr><th>Student</th><th>Date</th><th>AM</th><th>PM</th><th>Daily</th><th>Actions</th></tr>
                                </thead>
                                <tbody id="erp-attendance-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                   
                    <!-- Discipline Subsection -->
                    <div id="erp-discipline" class="section hidden card mt-4">
                        <h2 class="text-xl font-semibold mb-4">Discipline Incidents</h2>
                        <form class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4" onsubmit="logIncident(event)">
                            <input type="text" id="incident-student" placeholder="Student Name" class="form-control" required>
                            <textarea id="incident-desc" placeholder="Description" class="form-control" rows="2" required></textarea>
                            <select id="incident-type" class="form-control">
                                <option>Misconduct</option><option>Late</option><option>Other</option>
                            </select>
                            <button type="submit" class="btn">Log Incident</button>
                        </form>
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr><th>Date</th><th>Student</th><th>Type</th><th>Description</th><th>Actions</th></tr>
                                </thead>
                                <tbody id="discipline-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
   
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
            authDomain: "somaptestt.firebaseapp.com",
            databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
            projectId: "somaptestt",
            storageBucket: "somaptestt.appspot.com",
            messagingSenderId: "105526245138",
            appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
       
        let currentUserClass = '';
        let currentStream = 'A';
        let students = [];
        let academicState = {
            students: [], attendance: {}, fees: {}, scores: {}, subjectList: [],
            rowsByAdm: {}, className:'', stream:'', month:'09', year:'2025', examKey:'monthly', schoolBranch:''
        };
        let subjectsChart = null, top10Chart = null;
       
        const SUBJECTS_BY_CLASS = {
            'Baby Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
            'Middle Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
            'Pre-Unit': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
            'Class 1 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
            'Class 2 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
            'Class 3': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
            'Class 4': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
            'Class 5': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
            'Class 6': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals'],
            'Class 7': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals']
        };
       
        const EXAM_KEYS = {
            'Monthly': 'monthly','Midterm 1':'midterm1','End Term':'endterm','Midterm 2':'midterm2','Annual':'annual'
        };
       
        function letterGrade(pct) {
            const p = Number(pct);
            if (p >= 80.5) return 'A';
            if (p >= 60.5) return 'B';
            if (p >= 40.5) return 'C';
            if (p >= 20.5) return 'D';
            return 'F';
        }
       
        function money(n){ n = Number(n||0); return 'TSh ' + n.toLocaleString(); }
       
        function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
       
        // Auth State Change
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            const userRef = db.ref('users/' + user.email.replace('.', '_'));
            userRef.once('value').then(snapshot => {
                const userData = snapshot.val();
                if (!userData || userData.role !== 'teacher') {
                    alert('Unauthorized access');
                    auth.signOut();
                    window.location.href = 'index.html';
                    return;
                }
                document.getElementById('user-name').textContent = user.email.split('@')[0];
                currentUserClass = userData.class || 'Class 4';
                document.getElementById('user-class').textContent = currentUserClass;
                document.getElementById('classInput').value = currentUserClass;
                localStorage.setItem('class', currentUserClass);
                document.getElementById('stream-select').value = currentStream;
                document.getElementById('academic-stream').value = currentStream;
                loadTeacherData();
            });
        });
       
        // Load Teacher Data
        function loadTeacherData() {
            db.ref('students').once('value').then(snapshot => {
                const allStudents = snapshot.val() ? Object.values(snapshot.val()) : [];
                students = allStudents.filter(s => s.classLevel === currentUserClass);
                updateDashboard();
                updateStudentsList();
                loadAcademicData();
                loadAttendanceData();
                loadFeeData(true);
                loadDisciplineData();
                populateAcademicStream();
            });
        }
       
        function populateAcademicStream() {
            const select = document.getElementById('academic-stream');
            select.innerHTML = '';
            const streams = [...new Set(students.map(s => s.stream))].sort();
            streams.forEach(stream => {
                const opt = document.createElement('option');
                opt.value = stream;
                opt.textContent = stream;
                select.appendChild(opt);
            });
            select.value = currentStream;
            select.addEventListener('change', (e) => {
                academicState.stream = e.target.value;
                loadAcademicData();
                updateDashboard();
            });
        }
       
        // Update Dashboard
        function updateDashboard() {
            const streamStudents = students.filter(s => s.stream === currentStream);
            if (streamStudents.length === 0) return;
           
            // Academic Summary
            const avgScore = Math.round(streamStudents.reduce((sum, s) => sum + (s.avgScore || 70), 0) / streamStudents.length);
            document.getElementById('class-scores-count').textContent = avgScore + '%';
           
            const top = streamStudents.sort((a, b) => (b.avgScore || 0) - (a.avgScore || 0))[0];
            const bottom = streamStudents.sort((a, b) => (a.avgScore || 0) - (b.avgScore || 0))[0];
            document.getElementById('top-student').innerHTML = top ? `${top.firstName} ${top.lastName}<br><small>${(top.avgScore || 0).toFixed(1)}%</small>` : 'N/A';
            document.getElementById('bottom-student').innerHTML = bottom ? `${bottom.firstName} ${bottom.lastName}<br><small>${(bottom.avgScore || 0).toFixed(1)}%</small>` : 'N/A';
           
            document.getElementById('class-grade').textContent = letterGrade(avgScore);
           
            // Attendance Summary
            let totalDays = 0, presentDays = 0, yellowAlerts = 0, classDays = 0;
            Object.values(academicState.attendance || {}).forEach(att => {
                const days = att.days || att.present + att.absent;
                classDays = Math.max(classDays, days);
                presentDays += att.present || 0;
                totalDays += days;
                if (att.absent >= 10) yellowAlerts++;
            });
            const percentPresent = totalDays ? (presentDays / totalDays * 100).toFixed(1) : 0;
            document.getElementById('percent-present').textContent = percentPresent + '%';
            document.getElementById('percent-absent').textContent = (100 - parseFloat(percentPresent)) + '%';
            document.getElementById('yellow-alerts').textContent = yellowAlerts;
            document.getElementById('class-days').textContent = classDays;
           
            // Fee Summary (summed from payments)
            let totalDue = 0, totalPaid = 0, totalBalance = 0;
            streamStudents.forEach(s => {
                const fee = academicState.fees[s.admissionNumber] || { required: s.feePerYear || 0, paid: 0, balance: s.feePerYear || 0 };
                totalDue += fee.required;
                totalPaid += fee.paid;
                totalBalance += fee.balance;
            });
            document.getElementById('fee-required').textContent = money(totalDue);
            document.getElementById('fee-paid').textContent = money(totalPaid);
            document.getElementById('fee-balance').textContent = money(totalBalance);
        }
       
        // Load Attendance Data
        function loadAttendanceData() {
            const year = academicState.year;
            const month = academicState.month;
            db.ref(`attendance/${currentUserClass}/${year}-${month}`).once('value').then(snapshot => {
                academicState.attendance = snapshot.val() || {};
                updateErpAttendanceTable();
                updateDashboard();
            });
        }
       
        // Load Fee Data (summed from payments, synced with finance)
        function loadFeeData(init = false) {
            const year = academicState.year;
            db.ref(`payments/${year}/${currentUserClass}`).once('value').then(snapshot => {
                const payments = snapshot.val() || {};
                const fees = {};
                students.forEach(s => {
                    const adm = s.admissionNumber;
                    const paid = Object.values(payments[adm] || {}).reduce((sum, p) => sum + (p.amount || 0), 0);
                    const due = s.feePerYear || 600000;
                    const balance = Math.max(0, due - paid);
                    fees[adm] = { required: due, paid, balance };
                });
                academicState.fees = fees;
                if (init) updateDashboard();
            });
        }
       
        // Load Academic Data (restricted to class)
        async function loadAcademicData() {
            academicState.className = currentUserClass;
            academicState.stream = document.getElementById('academic-stream').value;
            academicState.month = document.getElementById('monthSelect').value;
            academicState.year = document.getElementById('yearInput').value;
            academicState.examKey = EXAM_KEYS[document.getElementById('examType').value] || 'monthly';
           
            academicState.students = await fetchStudents(academicState.className, academicState.stream);
            academicState.attendance = await fetchAttendance(academicState.year, academicState.month, academicState.className);
            academicState.fees = await fetchFees(academicState.year, academicState.className); // Synced with summed payments
            loadFeeData(); // Ensure sync
            academicState.scores = await fetchScores({year: academicState.year, className: academicState.className, examKey: academicState.examKey, month: academicState.month});
           
            academicState.subjectList = SUBJECTS_BY_CLASS[academicState.className] || [];
            buildAcademicTable();
            recomputeAll();
            drawCharts();
            updateKPIs();
            updateDashboard(); // Reflect in dashboard
        }
       
        // Fetch Functions (restricted)
        async function fetchStudents(className, stream) {
            const snap = await db.ref('students').once('value');
            if (snap.exists()) {
                const data = snap.val();
                const arr = Object.values(data).filter(s => s.classLevel === className && s.stream === stream);
                arr.forEach(s => {
                    s.adm = s.admissionNumber;
                    s.name = `${s.firstName} ${s.lastName}`;
                });
                arr.sort((a,b) => a.name.localeCompare(b.name));
                return arr;
            }
            return [];
        }
       
        async function fetchAttendance(year, month, className) {
            const snap = await db.ref(`/attendance/${className}/${year}-${month}`).once('value');
            const out = {};
            if (snap.exists()) {
                const val = snap.val();
                Object.keys(val || {}).forEach(date => {
                    const dayData = val[date] || {};
                    Object.keys(dayData).forEach(adm => {
                        const rec = dayData[adm];
                        out[adm] = out[adm] || { present: 0, absent: 0, days: 0 };
                        out[adm].days++;
                        if (rec.daily === 'P') out[adm].present++;
                        else out[adm].absent++;
                    });
                });
            }
            return out;
        }
       
        async function fetchFees(year, className) {
            return academicState.fees; // From summed payments
        }
       
        async function fetchScores({year, className, examKey, month}) {
            const snap = await db.ref(`/scores/${year}/${className}/${examKey}/${month}`).once('value');
            const out = {};
            if (snap.exists()) {
                const val = snap.val();
                Object.keys(val || {}).forEach(adm => {
                    out[adm] = {};
                    const subjObj = val[adm] || {};
                    Object.keys(subjObj).forEach(sub => {
                        const o = subjObj[sub] || {};
                        out[adm][sub] = { score: Number(o.score || 0), max: Number(o.max || 100) };
                    });
                });
            }
            return out;
        }
       
        // Build Academic Table
        function buildAcademicTable() {
            const theadRow = document.querySelector('#scoresTable thead tr');
            let totalIndex = 6; // Fixed: # Adm Student FeeDue Paid Balance
            while (theadRow.children.length > totalIndex) theadRow.removeChild(theadRow.lastChild);
           
            academicState.subjectList.forEach(subject => {
                const thSubject = document.createElement('th'); thSubject.className = 'p-2 border'; thSubject.textContent = subject; theadRow.appendChild(thSubject);
                const thMax = document.createElement('th'); thMax.className = 'p-2 border'; thMax.textContent = 'Max'; theadRow.appendChild(thMax);
                const thPos = document.createElement('th'); thPos.className = 'p-2 border'; thPos.textContent = 'Pos'; theadRow.appendChild(thPos);
            });
            const scoresBody = document.getElementById('scoresBody');
            scoresBody.innerHTML = '';
            academicState.rowsByAdm = {};
           
            academicState.students.forEach((s, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 border text-center">${idx + 1}</td>
                    <td class="p-2 border text-center">${s.adm}</td>
                    <td class="p-2 border">${escapeHtml(s.name)}</td>
                    <td class="p-2 border text-center">${money(academicState.fees[s.adm]?.required || 0)}</td>
                    <td class="p-2 border text-center">${money(academicState.fees[s.adm]?.paid || 0)}</td>
                    <td class="p-2 border text-center">${money(academicState.fees[s.adm]?.balance || 0)}</td>
                `;
               
                const subjectCells = {};
                academicState.subjectList.forEach(subject => {
                    const scoreVal = academicState.scores[s.adm]?.[subject]?.score || '';
                    const maxVal = academicState.scores[s.adm]?.[subject]?.max || 100;
                    tr.innerHTML += `
                        <td class="p-2 border"><input type="number" value="${scoreVal}" class="w-20 px-2 py-1 border rounded score-input" onchange="recomputeAll()"></td>
                        <td class="p-2 border"><input type="number" value="${maxVal}" class="w-16 px-2 py-1 border rounded max-input" onchange="recomputeAll()"></td>
                        <td class="p-2 border text-center pos-cell">–</td>
                    `;
                    subjectCells[subject] = { scoreInput: tr.querySelector('.score-input:last-of-type'), maxInput: tr.querySelector('.max-input:last-of-type'), posCell: tr.querySelector('.pos-cell:last-of-type') };
                });
               
                tr.innerHTML += `
                    <td class="p-2 border text-center total-cell">0</td>
                    <td class="p-2 border text-center max-total-cell">0</td>
                    <td class="p-2 border text-center avg-cell">0%</td>
                    <td class="p-2 border text-center overall-pos-cell">–</td>
                    <td class="p-2 border text-center grade-cell">–</td>
                    <td class="p-2 border text-center present-cell">${academicState.attendance[s.adm]?.present || 0}</td>
                    <td class="p-2 border text-center absent-cell">${academicState.attendance[s.adm]?.absent || 0}</td>
                    <td class="p-2 border"><textarea class="w-full p-2 border rounded comment-input"></textarea></td>
                `;
                scoresBody.appendChild(tr);
               
                academicState.rowsByAdm[s.adm] = {
                    totalCell: tr.querySelector('.total-cell'),
                    maxTotalCell: tr.querySelector('.max-total-cell'),
                    avgCell: tr.querySelector('.avg-cell'),
                    overallPosCell: tr.querySelector('.overall-pos-cell'),
                    gradeCell: tr.querySelector('.grade-cell'),
                    presentCell: tr.querySelector('.present-cell'),
                    absentCell: tr.querySelector('.absent-cell'),
                    commentInput: tr.querySelector('.comment-input'),
                    subjectCells
                };
            });
            document.getElementById('lblCount').textContent = academicState.students.length;
            document.getElementById('lblSubjects').textContent = academicState.subjectList.length;
        }
       
        // Recompute All
        function recomputeAll() {
            const perSubjectScores = {};
            Object.keys(academicState.rowsByAdm).forEach(adm => {
                const row = academicState.rowsByAdm[adm];
                let totalScore = 0, totalMax = 0;
                academicState.subjectList.forEach(sub => {
                    const cell = row.subjectCells[sub];
                    const score = Number(cell.scoreInput.value || 0);
                    const max = Number(cell.maxInput.value || 100);
                    totalScore += score;
                    totalMax += max;
                    perSubjectScores[sub] = perSubjectScores[sub] || [];
                    perSubjectScores[sub].push({ adm, pct: (score / max) * 100 });
                });
                const avgPct = (totalScore / totalMax) * 100 || 0;
                row.totalCell.textContent = totalScore.toFixed(2);
                row.maxTotalCell.textContent = totalMax.toFixed(0);
                row.avgCell.textContent = avgPct.toFixed(2) + '%';
                row.gradeCell.textContent = letterGrade(avgPct);
                row._avgPct = avgPct;
            });
           
            // Subject Positions
            Object.keys(perSubjectScores).forEach(sub => {
                const sorted = perSubjectScores[sub].sort((a, b) => b.pct - a.pct);
                let pos = 1;
                sorted.forEach((item, i) => {
                    if (i > 0 && sorted[i].pct < sorted[i-1].pct) pos = i + 1;
                    academicState.rowsByAdm[item.adm].subjectCells[sub].posCell.textContent = pos;
                });
            });
           
            // Overall Positions
            const sortedStudents = Object.entries(academicState.rowsByAdm).sort(([,a], [,b]) => b._avgPct - a._avgPct);
            let pos = 1;
            sortedStudents.forEach(([,row], i) => {
                if (i > 0 && row._avgPct < sortedStudents[i-1][1]._avgPct) pos = i + 1;
                row.overallPosCell.textContent = pos;
            });
           
            updateKPIs();
            drawCharts();
            updateDashboard();
        }
       
        // Update KPIs
        function updateKPIs() {
            const avgs = Object.values(academicState.rowsByAdm).map(row => row._avgPct || 0);
            if (avgs.length === 0) return;
            const maxAvg = Math.max(...avgs);
            const minAvg = Math.min(...avgs);
            const classAvg = avgs.reduce((sum, v) => sum + v, 0) / avgs.length;
            const topRow = Object.values(academicState.rowsByAdm).find(row => row._avgPct === maxAvg);
            const bottomRow = Object.values(academicState.rowsByAdm).find(row => row._avgPct === minAvg);
            document.getElementById('kpiTopStudent').textContent = topRow ? students.find(s => s.adm === Object.keys(academicState.rowsByAdm).find(adm => academicState.rowsByAdm[adm] === topRow)).name : '–';
            document.getElementById('kpiTopScore').textContent = maxAvg.toFixed(2) + '%';
            document.getElementById('kpiBottomStudent').textContent = bottomRow ? students.find(s => s.adm === Object.keys(academicState.rowsByAdm).find(adm => academicState.rowsByAdm[adm] === bottomRow)).name : '–';
            document.getElementById('kpiBottomScore').textContent = minAvg.toFixed(2) + '%';
            document.getElementById('kpiClassMax').textContent = maxAvg.toFixed(2) + '%';
            document.getElementById('kpiClassGrade').textContent = letterGrade(classAvg);
           
            let sumPresent = 0, sumDays = 0;
            Object.values(academicState.attendance).forEach(att => {
                sumPresent += att.present;
                sumDays += att.days;
            });
            const pctPresent = (sumPresent / sumDays * 100).toFixed(1) || 0;
            document.getElementById('kpiPresent').textContent = pctPresent + '%';
            document.getElementById('kpiAbsent').textContent = (100 - parseFloat(pctPresent)) + '%';
           
            let totalReq = 0, totalPaid = 0, totalBal = 0;
            Object.values(academicState.fees).forEach(fee => {
                totalReq += fee.required;
                totalPaid += fee.paid;
                totalBal += fee.balance;
            });
            document.getElementById('kpiFeeRequired').textContent = money(totalReq);
            document.getElementById('kpiFeePaid').textContent = money(totalPaid);
            document.getElementById('kpiFeeBalance').textContent = money(totalBal);
        }
       
        // Draw Charts
        function drawCharts() {
            const avgPerSub = academicState.subjectList.map(sub => {
                const pcts = Object.values(academicState.rowsByAdm).map(row => {
                    const cell = row.subjectCells[sub];
                    return (Number(cell.scoreInput.value || 0) / Number(cell.maxInput.value || 100)) * 100;
                });
                return pcts.reduce((sum, v) => sum + v, 0) / pcts.length || 0;
            });
           
            const top10 = Object.values(academicState.rowsByAdm).sort((a, b) => b._avgPct - a._avgPct).slice(0, 10).map(row => ({
                name: students.find(s => s.adm === Object.keys(academicState.rowsByAdm).find(adm => academicState.rowsByAdm[adm] === row)).name,
                avg: row._avgPct
            }));
           
            if (subjectsChart) subjectsChart.destroy();
            subjectsChart = new Chart(document.getElementById('chartSubjects'), {
                type: 'bar', data: { labels: academicState.subjectList, datasets: [{ label: 'Avg %', data: avgPerSub, backgroundColor: '#007bff' }] },
                options: { scales: { y: { beginAtZero: true, max: 100 } } }
            });
           
            if (top10Chart) top10Chart.destroy();
            top10Chart = new Chart(document.getElementById('chartTop10'), {
                type: 'bar', data: { labels: top10.map(t => t.name), datasets: [{ label: 'Avg %', data: top10.map(t => t.avg), backgroundColor: '#28a745' }] },
                options: { scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }
       
        // Save All Scores
        function saveAllScores() {
            const path = `/scores/${academicState.year}/${academicState.className}/${academicState.examKey}/${academicState.month}`;
            const payload = {};
            Object.keys(academicState.rowsByAdm).forEach(adm => {
                payload[adm] = {};
                academicState.subjectList.forEach(sub => {
                    const cell = academicState.rowsByAdm[adm].subjectCells[sub];
                    payload[adm][sub] = { score: Number(cell.scoreInput.value || 0), max: Number(cell.maxInput.value || 100) };
                });
            });
            db.ref(path).set(payload).then(() => alert('Scores saved!'));
        }
       
        // Event Listeners for Academic
        document.getElementById('btnSaveAll').addEventListener('click', saveAllScores);
        document.getElementById('btnRecalc').addEventListener('click', recomputeAll);
        document.getElementById('btnSetAllMax').addEventListener('click', () => {
            const max = Number(document.getElementById('globalMaxInput').value || 100);
            document.querySelectorAll('.max-input').forEach(input => input.value = max);
            recomputeAll();
        });
        document.getElementById('btnExportCSV').addEventListener('click', exportToCSV);
        document.getElementById('btnExportXLSX').addEventListener('click', exportToXLSX);
        document.getElementById('btnExportPDF').addEventListener('click', exportToPDF);
        document.getElementById('btnPrint').addEventListener('click', () => window.print());
        document.getElementById('btnGenerateReports').addEventListener('click', generateReportCards);
        document.getElementById('btnEmailReports').addEventListener('click', () => alert('Email/SMS feature coming soon.'));
       
        // Export Functions
        function gatherTableData() {
            const headers = ['#', 'Adm', 'Student', 'Fee Due', 'Paid', 'Balance'];
            academicState.subjectList.forEach(sub => headers.push(sub, `${sub} Max`, `${sub} Pos`));
            headers.push('Total', 'Max Total', '% Avg', 'Overall Pos', 'Grade', 'Present', 'Absent', 'Comment');
            const rows = [headers];
            Object.values(academicState.rowsByAdm).forEach((row, idx) => {
                const adm = Object.keys(academicState.rowsByAdm).find(k => academicState.rowsByAdm[k] === row);
                const student = students.find(s => s.adm === adm);
                let data = [idx + 1, adm, student.name, money(academicState.fees[adm].required), money(academicState.fees[adm].paid), money(academicState.fees[adm].balance)];
                academicState.subjectList.forEach(sub => {
                    const cell = row.subjectCells[sub];
                    data.push(cell.scoreInput.value, cell.maxInput.value, cell.posCell.textContent);
                });
                data.push(row.totalCell.textContent, row.maxTotalCell.textContent, row.avgCell.textContent, row.overallPosCell.textContent, row.gradeCell.textContent, row.presentCell.textContent, row.absentCell.textContent, row.commentInput.value);
                rows.push(data);
            });
            return rows;
        }
       
        function exportToCSV() {
            const rows = gatherTableData();
            const csv = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            saveAs(blob, 'scoresheet.csv');
        }
       
        function exportToXLSX() {
            const ws = XLSX.utils.aoa_to_sheet(gatherTableData());
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Scores');
            XLSX.writeFile(wb, 'scoresheet.xlsx');
        }
       
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4');
            doc.autoTable({ html: '#scoresTable' });
            doc.save('scoresheet.pdf');
        }
       
        function generateReportCards() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            academicState.students.forEach((s, idx) => {
                if (idx > 0) doc.addPage();
                doc.text(`Report for ${s.name}`, 10, 10);
                // Add more details...
            });
            doc.save('report_cards.pdf');
        }
       
        // ERP Functions
        function markErpAttendance() {
            const name = document.getElementById('erp-student-name').value;
            const date = document.getElementById('erp-date').value;
            const mark = document.getElementById('erp-mark').value;
            const student = students.find(s => s.name.toLowerCase().includes(name.toLowerCase()) && s.stream === currentStream);
            if (student) {
                db.ref(`attendance/${currentUserClass}/${date.substring(0,7)}/${date}/${student.adm}`).set({
                    am: mark, pm: mark, daily: mark,
                    snap: { admissionNo: student.adm, name: student.name, class: currentUserClass, feeDue: academicState.fees[student.adm].required, paid: academicState.fees[student.adm].paid, balance: academicState.fees[student.adm].balance }
                }).then(() => {
                    alert('Marked!');
                    loadAttendanceData();
                });
            } else alert('Student not found.');
        }
       
        function updateErpAttendanceTable() {
            const tbody = document.getElementById('erp-attendance-tbody');
            tbody.innerHTML = '';
            Object.entries(academicState.attendance || {}).forEach(([date, dayData]) => {
                Object.entries(dayData).forEach(([adm, rec]) => {
                    const student = students.find(s => s.adm === adm);
                    if (student && student.stream === currentStream) {
                        tbody.innerHTML += `
                            <tr>
                                <td>${student.name}</td>
                                <td>${date}</td>
                                <td>${rec.am}</td>
                                <td>${rec.pm}</td>
                                <td>${rec.daily}</td>
                                <td><button class="btn btn-secondary text-xs" onclick="editAttendance('${adm}', '${date}')">Edit</button></td>
                            </tr>
                        `;
                    }
                });
            });
        }
       
        function editAttendance(adm, date) {
            const mark = prompt('New mark (P/A):');
            if (['P', 'A'].includes(mark)) {
                db.ref(`attendance/${currentUserClass}/${date.substring(0,7)}/${date}/${adm}`).update({ am: mark, pm: mark, daily: mark }).then(() => loadAttendanceData());
            }
        }
       
        function logIncident(e) {
            e.preventDefault();
            const student = document.getElementById('incident-student').value;
            const desc = document.getElementById('incident-desc').value;
            const type = document.getElementById('incident-type').value;
            const date = new Date().toISOString().split('T')[0];
            db.ref('discipline').push({ date, student, type, desc, class: currentUserClass }).then(() => {
                alert('Logged!');
                loadDisciplineData();
            });
        }
       
        function loadDisciplineData() {
            db.ref('discipline').orderByChild('class').equalTo(currentUserClass).once('value').then(snap => {
                const tbody = document.getElementById('discipline-tbody');
                tbody.innerHTML = '';
                if (snap.exists()) {
                    snap.forEach(child => {
                        const inc = child.val();
                        tbody.innerHTML += `
                            <tr>
                                <td>${inc.date}</td>
                                <td>${inc.student}</td>
                                <td>${inc.type}</td>
                                <td>${inc.desc}</td>
                                <td><button class="btn btn-secondary text-xs">Edit</button></td>
                            </tr>
                        `;
                    });
                }
            });
        }
       
        function updateStudentsList() {
            const tbody = document.getElementById('students-list-tbody');
            tbody.innerHTML = '';
            students.filter(s => s.stream === currentStream).forEach(s => {
                const fee = academicState.fees[s.adm] || { required: 0, paid: 0, balance: 0 };
                tbody.innerHTML += `
                    <tr>
                        <td>${s.adm}</td>
                        <td>${s.name}</td>
                        <td>${currentUserClass}</td>
                        <td>${s.stream}</td>
                        <td>${money(fee.required)}</td>
                        <td>${money(fee.paid)}</td>
                        <td>${money(fee.balance)}</td>
                        <td><button class="btn btn-secondary text-xs">View</button></td>
                    </tr>
                `;
            });
        }
       
        // Section Toggle
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'schoolerp') {
                document.querySelectorAll('#attendance-icon, #discipline-icon, #students-icon').forEach(el => el.classList.remove('hidden'));
            } else {
                document.querySelectorAll('#attendance-icon, #discipline-icon, #students-icon').forEach(el => el.classList.add('hidden'));
            }
            if (id === 'academic') loadAcademicData();
            if (id === 'schoolerp') {
                updateStudentsList();
                loadAttendanceData();
                loadDisciplineData();
            }
        }
       
        function showErpSubsection(sub) {
            document.querySelectorAll('#erp-subsections .section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`erp-${sub}`).classList.remove('hidden');
            if (sub === 'attendance') updateErpAttendanceTable();
            if (sub === 'discipline') loadDisciplineData();
            if (sub === 'students') updateStudentsList();
        }
       
        function showAdmissionWarning() {
            alert('Access restricted. Contact Admin.');
        }
       
        function logout() {
            auth.signOut().then(() => window.location.href = 'index.html');
        }
       
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
            document.querySelector('.main-content').style.marginLeft = sidebar.classList.contains('expanded') ? '270px' : '100px';
        }
       
        // Init
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('stream-select').addEventListener('change', (e) => {
                currentStream = e.target.value;
                updateDashboard();
            });
            document.getElementById('examType').addEventListener('change', loadAcademicData);
            document.getElementById('monthSelect').addEventListener('change', loadAcademicData);
            document.getElementById('yearInput').addEventListener('change', loadAcademicData);
            showSection('dashboard');
        });
    </script>
</body>
</html>