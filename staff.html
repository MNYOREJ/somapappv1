<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SoMApV2 â€” Academic Management</title>
    <!-- Firebase compat (consistent with project) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <!-- Assume firebase.js is in root -->
    <script src="firebase.js"></script>
    <!-- Tailwind + FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        body { 
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: linear-gradient(135deg, #fef3c7 0%, #fff7ed 40%, #e0f2fe 100%);
        }
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 18px; 
            box-shadow: 0 8px 20px rgba(16,24,40,0.06); 
        }
        .table th, .table td { padding: 12px; }
        .table th { background: #eff6ff; }
        .toast{ position:fixed; right:20px; bottom:20px; background:rgba(0,0,0,0.75); color:white; padding:10px 14px; border-radius:8px; z-index:90; display:none; }
    </style>
</head>
<body class="p-6">
    <header class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold">Academic Management</h1>
            <p class="text-sm text-gray-700" id="class-info">Loading class...</p>
        </div>
        <div class="flex gap-4">
            <button onclick="navigateToScoresheet()" class="px-4 py-2 bg-indigo-600 text-white rounded shadow">Open Scoresheet</button>
            <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded shadow">Logout</button>
        </div>
    </header>

    <!-- Student List Table (filtered by class) -->
    <div class="card mb-6">
        <h3 class="font-semibold mb-4">Students in Class</h3>
        <table class="table w-full border-collapse">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Admission No.</th>
                    <th>Payments (Balance)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="students-table"></tbody>
        </table>
    </div>

    <!-- Scores Summary or other sections -->
    <div class="card">
        <h3 class="font-semibold mb-4">Class Scores Overview</h3>
        <div id="scores-summary" class="grid grid-cols-2 gap-4">
            <!-- Dynamically populated -->
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const auth = firebase.auth();
        const dbRef = firebase.database();
        let currentUserClass = null;
        let students = [];

        function showToast(msg, t=3000){ 
            const toast = document.getElementById('toast');
            toast.textContent = msg; 
            toast.style.display = 'block'; 
            setTimeout(()=>{ toast.style.display='none'; }, t); 
        }

        function logout(){ 
            auth.signOut().then(()=> window.location.href='index.html'); 
        }

        function navigateToScoresheet(){ 
            window.location.href = 'Toacademichtml/scoresheet.html?class=' + encodeURIComponent(currentUserClass); 
        }

        auth.onAuthStateChanged(user => {
            if (!user) { 
                window.location.href = 'index.html'; 
                return; 
            }
            const safeEmail = user.email.replace('.', '_');
            dbRef.ref('users/' + safeEmail).once('value').then(snap => {
                const ud = snap.val() || {};
                if (ud.role !== 'teacher') { 
                    alert('Unauthorized: only teachers allowed'); 
                    auth.signOut(); 
                    window.location.href = 'index.html'; 
                    return; 
                }
                currentUserClass = ud.class || 'Unknown';
                document.getElementById('class-info').textContent = `Managing ${currentUserClass} only`;
                loadFilteredData();
            });
        });

        function loadFilteredData() {
            // Filter students by class
            dbRef.ref('students').once('value').then(snap => {
                const allStudents = snap.val() || {};
                students = Object.entries(allStudents).reduce((acc, [key, s]) => {
                    if ((s.classLevel === currentUserClass) || (s.class === currentUserClass)) {
                        acc.push({ id: key, ...s });
                    }
                    return acc;
                }, []);
                renderStudents();
            });

            // Load scores filtered by class (assuming path scores/year/class)
            const year = new Date().getFullYear();
            dbRef.ref(`scores/${year}/${currentUserClass}`).on('value', snap => {
                const classScores = snap.val() || {};
                renderScoresSummary(classScores);
                showToast('Scores updated');
            });

            // If payments are under students or separate, filter accordingly
            // Assuming payments are per student, already filtered in students
        }

        function renderStudents() {
            const tbody = document.getElementById('students-table');
            tbody.innerHTML = '';
            students.forEach(s => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${s.name || 'N/A'}</td>
                    <td>${s.admissionNumber || s.admission || 'N/A'}</td>
                    <td>${s.paymentBalance || '0'} (Balance)</td>
                    <td><button class="text-blue-600" onclick="viewDetails('${s.id}')">View</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderScoresSummary(scores) {
            const summary = document.getElementById('scores-summary');
            summary.innerHTML = '';
            // Example: average per subject
            const subjects = new Set();
            let aggregates = {};
            // Parse scores structure (adapt based on actual DB)
            Object.values(scores).forEach(exam => {
                Object.values(exam).forEach(month => {
                    Object.entries(month).forEach(([adm, subs]) => {
                        Object.entries(subs).forEach(([sub, val]) => {
                            subjects.add(sub);
                            aggregates[sub] = aggregates[sub] || { sum: 0, count: 0 };
                            aggregates[sub].sum += Number(val.score || 0);
                            aggregates[sub].count++;
                        });
                    });
                });
            });
            subjects.forEach(sub => {
                const agg = aggregates[sub] || { sum: 0, count: 0 };
                const avg = agg.count ? (agg.sum / agg.count).toFixed(1) : 'N/A';
                const div = document.createElement('div');
                div.innerHTML = `<strong>${sub}</strong>: Avg ${avg}`;
                summary.appendChild(div);
            });
        }

        function viewDetails(studentId) {
            // Implement details view, perhaps modal or link
            showToast(`Viewing details for student ${studentId}`);
        }
    </script>
</body>
</html>