<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoMAp - Teacher Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Roboto', sans-serif; background: #f4f4f9; min-height: 100vh; }
        .sidebar { width: 64px; background: linear-gradient(to bottom, #007bff, #6610f2); height: 100vh; position: fixed; padding: 1rem; }
        .main-content { margin-left: 80px; padding: 2rem; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .btn { background: #007bff; color: white; padding: 0.75rem 1.5rem; border-radius: 4px; border: none; }
        .btn:hover { background: #0056b3; }
        .events-list { list-style: none; padding: 0; }
        .events-list li { background: #f8f9fa; padding: 0.75rem; margin: 0.5rem 0; border-radius: 4px; }
        .form-control { width: 100%; padding: 0.5rem; border: 1px solid #dadce0; border-radius: 4px; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="flex">
        <div id="sidebar" class="sidebar">
            <img src="images/somap-logo.png.jpg" alt="SoMAp Logo" class="h-10 mb-4 mx-auto">
            <button class="sidebar-icon flex items-center justify-center w-10 h-10 rounded-lg text-white mx-auto" onclick="window.location.href='index.html'">
                <i class="fas fa-sign-out-alt text-xl"></i>
                <span class="sidebar-tooltip">Logout</span>
            </button>
        </div>
        <div class="main-content">
            <h1 class="text-2xl font-bold mb-4">Teacher Dashboard</h1>
            <select id="stream-select" class="form-control mb-4">
                <option value="A">Stream A</option>
                <option value="B">Stream B</option>
            </select>
            <!-- Academic Management -->
            <section id="academic" class="card">
                <h2 class="text-xl font-semibold mb-2">Academic Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card">
                        <h5>Scores</h5>
                        <p id="class-scores">Loading...</p>
                    </div>
                    <div class="card">
                        <h5>Top/Bottom Students</h5>
                        <p id="top-bottom">Loading...</p>
                    </div>
                </div>
                <button class="btn mt-2">Save Scores</button>
            </section>
            <!-- Attendance -->
            <section id="attendance" class="card">
                <h2 class="text-xl font-semibold mb-2">Attendance</h2>
                <p id="attendance-stats">Loading...</p>
                <form id="attendance-form" class="mt-4">
                    <div class="mb-3">
                        <label class="block text-sm font-medium">Student Name</label>
                        <input type="text" id="attendance-student" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium">Date</label>
                        <input type="date" id="attendance-date" class="form-control" value="2025-09-15" required>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium">Mark</label>
                        <select id="attendance-mark" class="form-control">
                            <option value="P">Present</option>
                            <option value="A">Absent</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">Mark Attendance</button>
                </form>
            </section>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
            authDomain: "somaptestt.firebaseapp.com",
            databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
            projectId: "somaptestt",
            storageBucket: "somaptestt.appspot.com",
            messagingSenderId: "105526245138",
            appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            db.ref('users/' + user.email.replace('.', '_')).once('value').then(snapshot => {
                const userData = snapshot.val();
                if (!userData || userData.role !== 'teacher') {
                    alert('Unauthorized access');
                    auth.signOut();
                    window.location.href = 'index.html';
                    return;
                }
                loadTeacherData(userData.class);
            });
        });

        function loadTeacherData(className) {
            db.ref('students').on('value', snapshot => {
                const stream = document.getElementById('stream-select').value;
                const students = snapshot.val() ? Object.values(snapshot.val()).filter(s => s.classLevel === className && s.stream === stream) : [];
                let html = students.map(s => `${s.firstName} ${s.lastName}: Fee Due TSh ${s.feePerYear}, Paid TSh ${s.paidAmount}, Balance TSh ${s.balance}`).join('<br>');
                document.getElementById('class-scores').innerHTML = html || 'No students found.';
                
                db.ref(`scores/2025/${className}/monthly/08`).once('value').then(scoreSnapshot => {
                    const scores = scoreSnapshot.val() ? Object.entries(scoreSnapshot.val()).map(([id, s]) => ({
                        name: students.find(st => st.admissionNumber === id)?.firstName + ' ' + students.find(st => st.admissionNumber === id)?.lastName,
                        avg: Object.values(s).reduce((sum, sub) => sum + (sub.score / sub.max * 100), 0) / Object.keys(s).length
                    })) : [];
                    const top = scores.sort((a, b) => b.avg - a.avg)[0];
                    const bottom = scores.sort((a, b) => a.avg - b.avg)[0];
                    document.getElementById('top-bottom').innerHTML = `Top: ${top?.name || 'N/A'} (${top?.avg.toFixed(1) || 0}%)<br>Bottom: ${bottom?.name || 'N/A'} (${bottom?.avg.toFixed(1) || 0}%)`;
                });

                db.ref(`attendance/${className}/2025-09`).once('value').then(attSnapshot => {
                    const attendance = attSnapshot.val() ? Object.values(attSnapshot.val()).flatMap(day => Object.values(day)) : [];
                    let present = attendance.filter(a => a.daily === 'P').length;
                    let total = attendance.length;
                    document.getElementById('attendance-stats').innerHTML = `Present: ${present}/${total} (${total ? (present/total*100).toFixed(1) : 0}%)`;
                });
            });
        }

        document.getElementById('stream-select').addEventListener('change', () => loadTeacherData(localStorage.getItem('class')));

        document.getElementById('attendance-form').addEventListener('submit', e => {
            e.preventDefault();
            const studentName = document.getElementById('attendance-student').value;
            const date = document.getElementById('attendance-date').value;
            const mark = document.getElementById('attendance-mark').value;
            const className = localStorage.getItem('class');
            db.ref('students').orderByChild('firstName').equalTo(studentName.split(' ')[0]).once('value').then(snapshot => {
                const student = snapshot.val() ? Object.values(snapshot.val())[0] : null;
                if (student && student.classLevel === className) {
                    db.ref(`attendance/${student.classLevel}/2025-09/${date}/${student.admissionNumber}`).set({
                        am: mark,
                        pm: mark,
                        daily: mark,
                        snap: {
                            admissionNo: student.admissionNumber,
                            name: student.firstName + ' ' + student.lastName,
                            class: student.classLevel,
                            feeDue: student.feePerYear,
                            feePaid: student.paidAmount,
                            balance: student.balance
                        }
                    }).then(() => alert('Attendance marked!'));
                } else {
                    alert('Student not found in your class.');
                }
            });
        });
    </script>
</body>
</html>