<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoMAp â€” Teacher Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">
  
  <!-- Sidebar -->
  <aside class="w-64 bg-blue-900 text-white flex flex-col">
    <div class="p-6 text-2xl font-bold tracking-wide">SoMAp Teacher</div>
    <nav class="flex-1">
      <ul>
        <li>
          <button onclick="showDashboard()" class="w-full flex items-center p-4 hover:bg-blue-700">
            <span class="material-icons mr-2">dashboard</span>
            Dashboard
          </button>
        </li>
        <li>
          <button onclick="loadAcademic()" class="w-full flex items-center p-4 hover:bg-blue-700">
            <span class="material-icons mr-2">school</span>
            Academic
          </button>
        </li>
        <li>
          <button onclick="logout()" class="w-full flex items-center p-4 hover:bg-blue-700">
            <span class="material-icons mr-2">logout</span>
            Logout
          </button>
        </li>
      </ul>
    </nav>
    <footer class="p-4 text-sm bg-blue-800 text-center">
      &copy; 2025 SoMAp
    </footer>
  </aside>

  <!-- Main Content -->
  <main id="mainContent" class="flex-1 overflow-y-auto p-6">
    <!-- Dashboard Overview -->
    <section id="dashboardSection">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Teacher Dashboard</h1>
      
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-gray-600 text-sm">Total Students</h2>
          <p id="totalStudents" class="text-2xl font-bold text-blue-800">0</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-gray-600 text-sm">Avg Attendance</h2>
          <p id="avgAttendance" class="text-2xl font-bold text-green-600">0%</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-gray-600 text-sm">Total Fee Collected</h2>
          <p id="feeCollected" class="text-2xl font-bold text-purple-600">TSh 0</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-gray-600 text-sm">Outstanding Balance</h2>
          <p id="feeOutstanding" class="text-2xl font-bold text-red-600">TSh 0</p>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-lg font-semibold mb-4">Class Performance</h2>
          <canvas id="performanceChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-lg font-semibold mb-4">Attendance Trend</h2>
          <canvas id="attendanceChart"></canvas>
        </div>
      </div>

      <!-- Top & Bottom Students -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <div class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-lg font-semibold mb-4">Top Student</h2>
          <p id="topStudent" class="text-gray-700 font-medium">No data</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow">
          <h2 class="text-lg font-semibold mb-4">Bottom Student</h2>
          <p id="bottomStudent" class="text-gray-700 font-medium">No data</p>
        </div>
      </div>
    </section>

    <!-- Academic Section -->
    <section id="academicSection" class="hidden">
      <iframe src="academic.html" class="w-full h-[80vh] rounded-2xl shadow"></iframe>
    </section>
  </main>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let teacherClass = localStorage.getItem("teacherClass") || "Class 7";

    // Sidebar Navigation
    function showDashboard() {
      document.getElementById("dashboardSection").classList.remove("hidden");
      document.getElementById("academicSection").classList.add("hidden");
    }
    function loadAcademic() {
      document.getElementById("dashboardSection").classList.add("hidden");
      document.getElementById("academicSection").classList.remove("hidden");
    }
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = "index.html";
      });
    }

    // Load Dashboard Data
    function loadDashboardData() {
      db.ref("students").orderByChild("class").equalTo(teacherClass).on("value", snapshot => {
        let students = snapshot.val() || {};
        let totalStudents = Object.keys(students).length;
        document.getElementById("totalStudents").textContent = totalStudents;

        let totalAttendance = 0;
        let totalPayments = 0;
        let totalDue = 0;
        let scores = [];

        Object.values(students).forEach(stu => {
          if (stu.attendance) {
            let daysPresent = Object.values(stu.attendance).filter(a => a === "Present").length;
            let daysTotal = Object.keys(stu.attendance).length;
            totalAttendance += (daysPresent / daysTotal) * 100;
          }
          if (stu.fee) {
            totalPayments += stu.fee.paid || 0;
            totalDue += stu.fee.total || 0;
          }
          if (stu.scores) {
            let avgScore = Object.values(stu.scores).reduce((a,b)=>a+b,0) / Object.keys(stu.scores).length;
            scores.push({ name: stu.name, score: avgScore });
          }
        });

        document.getElementById("avgAttendance").textContent = totalStudents ? (totalAttendance/totalStudents).toFixed(1)+"%" : "0%";
        document.getElementById("feeCollected").textContent = "TSh " + totalPayments.toLocaleString();
        document.getElementById("feeOutstanding").textContent = "TSh " + (totalDue - totalPayments).toLocaleString();

        // Top & Bottom Student
        scores.sort((a,b)=>b.score-a.score);
        if (scores.length) {
          document.getElementById("topStudent").textContent = scores[0].name + " (" + scores[0].score.toFixed(1) + "%)";
          document.getElementById("bottomStudent").textContent = scores[scores.length-1].name + " (" + scores[scores.length-1].score.toFixed(1) + "%)";
        }

        // Charts
        let labels = scores.map(s=>s.name);
        let dataScores = scores.map(s=>s.score);
        new Chart(document.getElementById("performanceChart"), {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{ label: "Scores", data: dataScores, backgroundColor: "#2563eb" }]
          }
        });

        new Chart(document.getElementById("attendanceChart"), {
          type: "line",
          data: {
            labels: labels,
            datasets: [{ label: "Attendance %", data: dataScores.map(x=>Math.min(100,x+10)), borderColor: "#16a34a", fill: false }]
          }
        });
      });
    }
    loadDashboardData();
  </script>
</body>
</html>
