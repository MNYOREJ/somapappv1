<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoMAp - Teacher Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { 
            font-family: 'Roboto', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            min-height: 100vh; 
        }
        .sidebar { 
            width: 80px; 
            background: linear-gradient(to bottom, #007bff, #6610f2); 
            height: 100vh; 
            position: fixed; 
            padding: 1rem 0; 
            transition: width 0.3s ease; 
        }
        .sidebar.expanded { width: 250px; }
        .sidebar-icon { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 50px; 
            height: 50px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px; 
            color: white; 
            margin: 10px auto; 
            cursor: pointer; 
            transition: all 0.3s; 
            position: relative; 
        }
        .sidebar-icon:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .sidebar-tooltip { 
            position: absolute; 
            left: 60px; 
            background: #333; 
            color: white; 
            padding: 5px 10px; 
            border-radius: 5px; 
            white-space: nowrap; 
            opacity: 0; 
            transition: opacity 0.3s; 
            font-size: 12px; 
        }
        .sidebar-icon:hover .sidebar-tooltip { opacity: 1; }
        .main-content { 
            margin-left: 100px; 
            padding: 2rem; 
            transition: margin-left 0.3s ease; 
        }
        .card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            padding: 1.5rem; 
            margin-bottom: 2rem; 
            border-left: 4px solid #007bff; 
        }
        .card.academic { border-left-color: #28a745; }
        .card.attendance { border-left-color: #ffc107; }
        .card.finance { border-left-color: #17a2b8; }
        .card.discipline { border-left-color: #dc3545; }
        .btn { 
            background: linear-gradient(45deg, #007bff, #0056b3); 
            color: white; 
            padding: 0.75rem 1.5rem; 
            border-radius: 6px; 
            border: none; 
            cursor: pointer; 
            transition: all 0.3s; 
            font-weight: 500; 
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        .btn-secondary { background: linear-gradient(45deg, #6c757d, #495057); }
        .btn-secondary:hover { box-shadow: 0 4px 8px rgba(108,117,125,0.3); }
        .events-list { list-style: none; padding: 0; }
        .events-list li { 
            background: #f8f9fa; 
            padding: 1rem; 
            margin: 0.5rem 0; 
            border-radius: 8px; 
            border-left: 3px solid #007bff; 
        }
        .form-control { 
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid #e9ecef; 
            border-radius: 6px; 
            margin-bottom: 1rem; 
            transition: border-color 0.3s; 
        }
        .form-control:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25); }
        .table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 1rem; 
        }
        .table th, .table td { 
            padding: 0.75rem; 
            text-align: left; 
            border-bottom: 1px solid #dee2e6; 
        }
        .table th { background: #f8f9fa; font-weight: 600; }
        .table tr:hover { background: #f8f9fa; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .stat-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 1.5rem; 
            border-radius: 10px; 
            text-align: center; 
        }
        .stat-card h3 { font-size: 2rem; margin-bottom: 0.5rem; }
        .hidden { display: none; }
        .section { display: none; }
        .section.active { display: block; }
        #sidebar-toggle { 
            position: fixed; 
            left: 90px; 
            top: 20px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            cursor: pointer; 
            z-index: 1000; 
        }
    </style>
</head>
<body>
    <button id="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    
    <div class="flex">
        <div id="sidebar" class="sidebar">
            <img src="images/somap-logo.png.jpg" alt="SoMAp Logo" class="h-12 mx-auto mb-6 rounded-full shadow-lg">
            
            <!-- Dashboard Icon (Default View) -->
            <div class="sidebar-icon" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt text-xl"></i>
                <span class="sidebar-tooltip">Dashboard</span>
            </div>
            
            <!-- Academic Icon -->
            <div class="sidebar-icon" onclick="showSection('academic')">
                <i class="fas fa-book text-xl"></i>
                <span class="sidebar-tooltip">Academic Management</span>
            </div>
            
            <!-- School ERP Icon -->
            <div class="sidebar-icon" onclick="showSection('schoolerp')">
                <i class="fas fa-school text-xl"></i>
                <span class="sidebar-tooltip">School ERP</span>
            </div>
            
            <!-- Attendance Sub-Icon under ERP (but shown in ERP) -->
            <div class="sidebar-icon hidden" id="attendance-icon">
                <i class="fas fa-calendar-check text-xl"></i>
                <span class="sidebar-tooltip">Attendance</span>
            </div>
            
            <!-- Discipline Sub-Icon -->
            <div class="sidebar-icon hidden" id="discipline-icon">
                <i class="fas fa-exclamation-triangle text-xl"></i>
                <span class="sidebar-tooltip">Discipline</span>
            </div>
            
            <!-- Students List Sub-Icon -->
            <div class="sidebar-icon hidden" id="students-icon">
                <i class="fas fa-users text-xl"></i>
                <span class="sidebar-tooltip">Students List</span>
            </div>
            
            <!-- Logout -->
            <div class="sidebar-icon mt-auto" onclick="logout()">
                <i class="fas fa-sign-out-alt text-xl"></i>
                <span class="sidebar-tooltip">Logout</span>
            </div>
        </div>
        
        <div class="main-content">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Teacher Dashboard</h1>
                <div class="text-sm text-gray-600">
                    Welcome, <span id="user-name"></span> | Class: <span id="user-class"></span>
                </div>
            </header>
            
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Stream Select -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-stream mr-2"></i> Select Stream
                        </h2>
                        <select id="stream-select" class="form-control">
                            <option value="A">Stream A</option>
                            <option value="B">Stream B</option>
                            <option value="Red">Red Stream</option>
                        </select>
                    </div>
                    
                    <!-- Academic Management Card -->
                    <div class="card academic">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-graduation-cap mr-2"></i> Academic Management
                        </h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3 id="class-scores-count">-</h3>
                                <p>Average Score</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="top-student">-</h3>
                                <p>Top Student (%)</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="bottom-student">-</h3>
                                <p>Bottom Student (%)</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="class-grade">-</h3>
                                <p>Class Average Grade</p>
                            </div>
                        </div>
                        <button class="btn mt-4" onclick="saveScores()">Save Scores</button>
                    </div>
                    
                    <!-- Attendance Stats -->
                    <div class="card attendance col-span-full">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-calendar mr-2"></i> Attendance Overview
                        </h2>
                        <div class="stats-grid">
                            <div class="stat-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                                <h3 id="percent-present">-</h3>
                                <p>% Present (Class Avg)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                                <h3 id="percent-absent">-</h3>
                                <p>% Absent</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                                <h3 id="yellow-alerts">-</h3>
                                <p>Yellow Alerts (≥10 absent days)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);">
                                <h3 id="class-days">-</h3>
                                <p>Class Days (excl. weekends/holidays)</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fee Overview -->
                    <div class="card finance col-span-full">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-money-bill mr-2"></i> Fee Status
                        </h2>
                        <div class="stats-grid">
                            <div class="stat-card" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                                <h3 id="fee-required">-</h3>
                                <p>Required (Class/Year)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">
                                <h3 id="fee-paid">-</h3>
                                <p>Paid (Aggregated)</p>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                                <h3 id="fee-balance">-</h3>
                                <p>Balance (Outstanding)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Academic Section (Embedded from academic.html style) -->
            <section id="academic" class="section">
                <div class="card academic col-span-full">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold">SoMAp — Academic & Exams Module</h1>
                        <a href="#" onclick="showSection('dashboard')" class="text-blue-500 hover:underline flex items-center">
                            ← Back <i class="fas fa-arrow-left ml-1"></i>
                        </a>
                    </div>
                    <p class="text-gray-600 mb-6">Scores • Rankings • Reports</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="card">
                            <h3 class="font-semibold">Top Student</h3>
                            <p id="top-student-detail" class="text-2xl font-bold text-green-600">-</p>
                        </div>
                        <div class="card">
                            <h3 class="font-semibold">Bottom Student</h3>
                            <p id="bottom-student-detail" class="text-2xl font-bold text-red-600">-</p>
                        </div>
                        <div class="card">
                            <h3 class="font-semibold">Class Max</h3>
                            <p id="class-max" class="text-xl">-</p>
                        </div>
                        <div class="card">
                            <h3 class="font-semibold">Class Grade</h3>
                            <p id="class-grade-detail" class="text-xl">-</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="card">
                            <h3>% Present</h3>
                            <p id="present-detail" class="text-xl">-</p>
                        </div>
                        <div class="card">
                            <h3>% Absent</h3>
                            <p id="absent-detail" class="text-xl">-</p>
                        </div>
                        <div class="card">
                            <h3 class="font-semibold">Fee Status</h3>
                            <p>Required: <span id="fee-req">-</span></p>
                            <p>Paid: <span id="fee-pd">-</span></p>
                            <p>Balance: <span id="fee-bal">-</span></p>
                        </div>
                    </div>
                    
                    <!-- Subject Performance -->
                    <div class="card mb-6">
                        <h2 class="text-xl font-semibold mb-4">Subject Performance (Class)</h2>
                        <p class="text-gray-600">Average per subject</p>
                        <div id="subject-perf" class="mt-4">
                            <!-- Dynamic table or list -->
                            <table class="table w-full">
                                <thead>
                                    <tr><th>Subject</th><th>Average Score</th></tr>
                                </thead>
                                <tbody id="subject-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Student Averages Top 10 -->
                    <div class="card mb-6">
                        <h2 class="text-xl font-semibold mb-4">Student Averages (Top 10)</h2>
                        <p class="text-gray-600">Overall %</p>
                        <div id="student-avg" class="mt-4">
                            <table class="table w-full">
                                <thead>
                                    <tr><th>Rank</th><th>Student</th><th>%</th></tr>
                                </thead>
                                <tbody id="student-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Scoresheet -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Scoresheet</h2>
                        <p class="text-gray-600 mb-4">Enter marks per subject • Auto averages • Positions • Grades</p>
                        
                        <div class="flex justify-between mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Exam Type: <select id="exam-type" class="form-control inline-block w-32"><option>Monthly</option></select></label>
                                <label class="block text-sm font-medium mb-2 ml-4">Month: <select id="month-select" class="form-control inline-block w-32"><option>September</option></select></label>
                                <label class="block text-sm font-medium mb-2 ml-4">Academic Year: <input type="text" id="year-input" value="2025" class="form-control inline-block w-24"></label>
                            </div>
                            <div class="flex space-x-2">
                                <button class="btn">Save Scores</button>
                                <button class="btn btn-secondary">CSV</button>
                                <button class="btn btn-secondary">Excel</button>
                                <button class="btn btn-secondary">PDF</button>
                                <button class="btn btn-secondary">Print</button>
                                <button class="btn btn-secondary">Load</button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Adm</th>
                                        <th>Student</th>
                                        <th>Fee Due</th>
                                        <th>Paid</th>
                                        <th>Balance</th>
                                        <th>Total</th>
                                        <th>Max</th>
                                        <th>% Avg</th>
                                        <th>Overall Pos</th>
                                        <th>Grade</th>
                                        <th>Present</th>
                                        <th>Absent</th>
                                        <th>Teacher Comment</th>
                                    </tr>
                                </thead>
                                <tbody id="scoresheet-tbody">
                                    <!-- Dynamic rows -->
                                </tbody>
                            </table>
                        </div>
                        <p id="students-count" class="mt-2 text-gray-600">0 students • 0 subjects</p>
                        
                        <div class="flex justify-between mt-4">
                            <button class="btn">Set all Max 100</button>
                            <button class="btn btn-secondary">Recalculate</button>
                            <button class="btn btn-secondary">Generate Report Cards (PDF)</button>
                        </div>
                        <div class="mt-4">
                            <a href="#" class="text-blue-500 hover:underline">Email/SMS Links</a>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- School ERP Section -->
            <section id="schoolerp" class="section">
                <div class="card col-span-full">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold">SoMAp ERP - Manage Academic & Administrative Aspects</h1>
                        <a href="#" onclick="showSection('dashboard')" class="text-blue-500 hover:underline flex items-center">
                            ← Back <i class="fas fa-arrow-left ml-1"></i>
                        </a>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- Admissions - Restricted -->
                        <div class="card p-4 text-center" onclick="showAdmissionWarning()">
                            <i class="fas fa-users text-3xl text-gray-400 mb-2"></i>
                            <h3 class="font-semibold">Admissions</h3>
                            <p>New Applications: 12</p>
                            <p class="text-sm text-gray-500">Contact Admin for Access</p>
                        </div>
                        
                        <!-- Academics - Link to Academic Section -->
                        <div class="card p-4 cursor-pointer hover:bg-gray-50" onclick="showSection('academic')">
                            <i class="fas fa-book text-3xl text-blue-500 mb-2"></i>
                            <h3 class="font-semibold">Academics</h3>
                            <p>Scores & Reports</p>
                        </div>
                        
                        <!-- Attendance -->
                        <div class="card p-4 cursor-pointer hover:bg-gray-50" onclick="showErpSubsection('attendance')">
                            <i class="fas fa-calendar-check text-3xl text-green-500 mb-2"></i>
                            <h3 class="font-semibold">Attendance</h3>
                            <p>Mark & View</p>
                        </div>
                        
                        <!-- Discipline -->
                        <div class="card p-4 cursor-pointer hover:bg-gray-50" onclick="showErpSubsection('discipline')">
                            <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-2"></i>
                            <h3 class="font-semibold">Discipline</h3>
                            <p>Incidents Log</p>
                        </div>
                    </div>
                    
                    <!-- Students List -->
                    <div class="card col-span-full">
                        <h2 class="text-xl font-semibold mb-4">Students List</h2>
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr>
                                        <th>Adm No</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Stream</th>
                                        <th>Fee Due</th>
                                        <th>Paid</th>
                                        <th>Balance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="students-list-tbody">
                                    <!-- Dynamic -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- ERP Subsections -->
                <div id="erp-subsections">
                    <!-- Attendance Subsection -->
                    <div id="erp-attendance" class="section hidden card col-span-full mt-6">
                        <h2 class="text-xl font-semibold mb-4">Attendance Management</h2>
                        <p id="erp-attendance-stats" class="mb-4">Loading...</p>
                        <!-- Simple form for marking, but restricted -->
                        <form id="erp-attendance-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input type="text" id="erp-student-name" placeholder="Student Name" class="form-control" required>
                            <input type="date" id="erp-date" value="2025-09-15" class="form-control" required>
                            <select id="erp-mark" class="form-control">
                                <option value="P">Present</option>
                                <option value="A">Absent</option>
                            </select>
                            <button type="submit" class="btn">Mark Attendance</button>
                        </form>
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr><th>Student</th><th>Date</th><th>Status</th></tr>
                                </thead>
                                <tbody id="erp-attendance-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Discipline Subsection -->
                    <div id="erp-discipline" class="section hidden card col-span-full mt-6">
                        <h2 class="text-xl font-semibold mb-4">Discipline Incidents</h2>
                        <form class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" id="incident-student" placeholder="Student Name" class="form-control" required>
                            <textarea id="incident-desc" placeholder="Description" class="form-control" rows="3" required></textarea>
                            <select id="incident-type" class="form-control">
                                <option>Misconduct</option>
                                <option>Late</option>
                                <option>Other</option>
                            </select>
                            <button type="submit" class="btn">Log Incident</button>
                        </form>
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr><th>Date</th><th>Student</th><th>Type</th><th>Description</th><th>Actions</th></tr>
                                </thead>
                                <tbody id="discipline-tbody">
                                    <!-- Dynamic -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
            authDomain: "somaptestt.firebaseapp.com",
            databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
            projectId: "somaptestt",
            storageBucket: "somaptestt.appspot.com",
            messagingSenderId: "105526245138",
            appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        let currentUserClass = '';
        let currentStream = 'A';
        let students = [];
        
        // Auth State Change
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            const userRef = db.ref('users/' + user.email.replace('.', '_'));
            userRef.once('value').then(snapshot => {
                const userData = snapshot.val();
                if (!userData || userData.role !== 'teacher') {
                    alert('Unauthorized access');
                    auth.signOut();
                    window.location.href = 'index.html';
                    return;
                }
                document.getElementById('user-name').textContent = user.email;
                currentUserClass = userData.class || 'Class 4'; // Default if not set
                document.getElementById('user-class').textContent = currentUserClass;
                localStorage.setItem('class', currentUserClass);
                loadTeacherData();
                // Preselect stream if needed
                document.getElementById('stream-select').value = currentStream;
            });
        });
        
        // Load Teacher Data
        function loadTeacherData() {
            db.ref('students').once('value').then(snapshot => {
                const allStudents = snapshot.val() ? Object.values(snapshot.val()) : [];
                students = allStudents.filter(s => s.classLevel === currentUserClass);
                updateDashboard();
                updateStudentsList();
                updateScoresheet();
                updateSubjectPerformance();
                updateStudentAverages();
                loadAttendanceData();
                loadFeeData();
                loadDisciplineData();
            });
        }
        
        // Update Dashboard
        function updateDashboard() {
            const streamStudents = students.filter(s => s.stream === currentStream);
            if (streamStudents.length === 0) {
                document.getElementById('class-scores-count').textContent = 'No Data';
                return;
            }
            
            // Mock scores calculation - in real, fetch from scores path
            const avgScore = Math.round(streamStudents.reduce((sum, s) => sum + (s.avgScore || 70), 0) / streamStudents.length);
            document.getElementById('class-scores-count').textContent = avgScore + '%';
            
            // Top/Bottom - mock
            const top = streamStudents.sort((a, b) => (b.avgScore || 0) - (a.avgScore || 0))[0];
            const bottom = streamStudents.sort((a, b) => (a.avgScore || 0) - (b.avgScore || 0))[0];
            document.getElementById('top-student').innerHTML = top ? `${top.firstName} ${top.lastName}<br><small>${(top.avgScore || 0).toFixed(1)}%</small>` : 'N/A';
            document.getElementById('bottom-student').innerHTML = bottom ? `${bottom.firstName} ${bottom.lastName}<br><small>${(bottom.avgScore || 0).toFixed(1)}%</small>` : 'N/A';
            
            document.getElementById('class-grade').textContent = avgScore + '%';
            
            // Attendance mock
            const presentPercent = 85; // Fetch real
            document.getElementById('percent-present').textContent = presentPercent + '%';
            document.getElementById('percent-absent').textContent = (100 - presentPercent) + '%';
            document.getElementById('yellow-alerts').textContent = '2';
            document.getElementById('class-days').textContent = '20';
            
            // Fee mock
            const totalDue = streamStudents.reduce((sum, s) => sum + (s.feePerYear || 600000), 0);
            const totalPaid = streamStudents.reduce((sum, s) => sum + (s.paidAmount || 88000), 0);
            const balance = totalDue - totalPaid;
            document.getElementById('fee-required').textContent = 'TSh ' + totalDue.toLocaleString();
            document.getElementById('fee-paid').textContent = 'TSh ' + totalPaid.toLocaleString();
            document.getElementById('fee-balance').textContent = 'TSh ' + balance.toLocaleString();
            
            // Update details
            if (top) {
                document.getElementById('top-student-detail').textContent = `${top.firstName} ${top.lastName} - ${(top.avgScore || 0).toFixed(1)}%`;
                document.getElementById('bottom-student-detail').textContent = `${bottom.firstName} ${bottom.lastName} - ${(bottom.avgScore || 0).toFixed(1)}%`;
            }
            document.getElementById('class-max').textContent = '100%';
            document.getElementById('class-grade-detail').textContent = avgScore + '%';
            document.getElementById('present-detail').textContent = presentPercent + '%';
            document.getElementById('absent-detail').textContent = (100 - presentPercent) + '%';
            document.getElementById('fee-req').textContent = 'TSh ' + totalDue.toLocaleString();
            document.getElementById('fee-pd').textContent = 'TSh ' + totalPaid.toLocaleString();
            document.getElementById('fee-bal').textContent = 'TSh ' + balance.toLocaleString();
        }
        
        // Stream Change
        document.getElementById('stream-select').addEventListener('change', (e) => {
            currentStream = e.target.value;
            updateDashboard();
        });
        
        // Load Attendance Data
        function loadAttendanceData() {
            const today = new Date().toISOString().split('T')[0];
            db.ref(`attendance/${currentUserClass}/${today.substring(0,7)}`).once('value').then(snapshot => {
                const attData = snapshot.val() || {};
                let totalDays = Object.keys(attData).length;
                let presentDays = 0;
                Object.values(attData).forEach(day => {
                    Object.values(day).forEach(rec => {
                        if (rec.daily === 'P') presentDays++;
                    });
                });
                const percentPresent = totalDays > 0 ? (presentDays / (totalDays * students.filter(s => s.stream === currentStream).length) * 100).toFixed(1) : 0;
                document.getElementById('percent-present').textContent = percentPresent + '%';
                document.getElementById('percent-absent').textContent = (100 - parseFloat(percentPresent)) + '%';
                document.getElementById('erp-attendance-stats').textContent = `Class Attendance: ${percentPresent}% Present`;
                updateErpAttendanceTable();
            });
        }
        
        // Load Fee Data
        function loadFeeData() {
            // Already in updateDashboard, but can expand
        }
        
        // Update Students List
        function updateStudentsList() {
            const tbody = document.getElementById('students-list-tbody');
            tbody.innerHTML = '';
            students.filter(s => s.stream === currentStream).forEach(s => {
                const row = `<tr>
                    <td>${s.admissionNumber}</td>
                    <td>${s.firstName} ${s.lastName}</td>
                    <td>${s.classLevel}</td>
                    <td>${s.stream}</td>
                    <td>TSh ${s.feePerYear?.toLocaleString()}</td>
                    <td>TSh ${s.paidAmount?.toLocaleString()}</td>
                    <td>TSh ${s.balance?.toLocaleString()}</td>
                    <td><button class="btn btn-secondary text-xs">View</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }
        
        // Update Scoresheet
        function updateScoresheet() {
            const tbody = document.getElementById('scoresheet-tbody');
            tbody.innerHTML = '';
            const streamStudents = students.filter(s => s.stream === currentStream);
            streamStudents.forEach((s, index) => {
                const row = `<tr>
                    <td>${index + 1}</td>
                    <td>${s.admissionNumber}</td>
                    <td>${s.firstName} ${s.lastName}</td>
                    <td>TSh ${s.feePerYear?.toLocaleString()}</td>
                    <td>TSh ${s.paidAmount?.toLocaleString()}</td>
                    <td>TSh ${s.balance?.toLocaleString()}</td>
                    <td><input type="number" class="form-control w-16" value="0"></td>
                    <td>100</td>
                    <td>0%</td>
                    <td>-</td>
                    <td>-</td>
                    <td>15</td>
                    <td>5</td>
                    <td><textarea class="form-control w-full" rows="1" placeholder="Comment"></textarea></td>
                </tr>`;
                tbody.innerHTML += row;
            });
            document.getElementById('students-count').textContent = `${streamStudents.length} students • 5 subjects`; // Mock subjects
        }
        
        // Update Subject Performance
        function updateSubjectPerformance() {
            const subjects = ['Math', 'English', 'Science', 'History', 'Geography']; // Mock
            const tbody = document.getElementById('subject-tbody');
            tbody.innerHTML = '';
            subjects.forEach(sub => {
                const avg = Math.round(Math.random() * 100); // Mock
                tbody.innerHTML += `<tr><td>${sub}</td><td>${avg}%</td></tr>`;
            });
        }
        
        // Update Student Averages Top 10
        function updateStudentAverages() {
            const streamStudents = students.filter(s => s.stream === currentStream).sort((a, b) => (b.avgScore || 0) - (a.avgScore || 0)).slice(0, 10);
            const tbody = document.getElementById('student-tbody');
            tbody.innerHTML = '';
            streamStudents.forEach((s, index) => {
                tbody.innerHTML += `<tr><td>${index + 1}</td><td>${s.firstName} ${s.lastName}</td><td>${(s.avgScore || 0).toFixed(1)}%</td></tr>`;
            });
        }
        
        // ERP Attendance Table
        function updateErpAttendanceTable() {
            const tbody = document.getElementById('erp-attendance-tbody');
            tbody.innerHTML = '';
            // Mock data
            students.slice(0, 5).forEach(s => {
                tbody.innerHTML += `<tr><td>${s.firstName} ${s.lastName}</td><td>2025-09-15</td><td><span class="text-green-600">Present</span></td></tr>`;
            });
        }
        
        // Discipline Data Mock
        function loadDisciplineData() {
            const tbody = document.getElementById('discipline-tbody');
            tbody.innerHTML = '';
            // Mock incidents
            const incidents = [
                { date: '2025-09-10', student: 'John Doe', type: 'Late', desc: 'Arrived late' },
                { date: '2025-09-12', student: 'Jane Smith', type: 'Misconduct', desc: 'Class disruption' }
            ];
            incidents.forEach(inc => {
                tbody.innerHTML += `<tr><td>${inc.date}</td><td>${inc.student}</td><td>${inc.type}</td><td>${inc.desc}</td><td><button class="btn btn-secondary text-xs">Edit</button></td></tr>`;
            });
        }
        
        // Section Show/Hide
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'schoolerp') {
                document.getElementById('attendance-icon').classList.remove('hidden');
                document.getElementById('discipline-icon').classList.remove('hidden');
                document.getElementById('students-icon').classList.remove('hidden');
            } else {
                document.getElementById('attendance-icon').classList.add('hidden');
                document.getElementById('discipline-icon').classList.add('hidden');
                document.getElementById('students-icon').classList.add('hidden');
            }
            loadSectionData(sectionId);
        }
        
        function showErpSubsection(subId) {
            document.querySelectorAll('#erp-subsections .section').forEach(sec => sec.classList.remove('active', 'hidden'));
            const subSec = document.getElementById(`erp-${subId}`);
            subSec.classList.remove('hidden');
            subSec.classList.add('active');
        }
        
        function loadSectionData(sectionId) {
            if (sectionId === 'academic') {
                updateScoresheet();
                updateSubjectPerformance();
                updateStudentAverages();
            } else if (sectionId === 'schoolerp') {
                updateStudentsList();
                loadAttendanceData();
                loadDisciplineData();
            }
        }
        
        // Save Scores Mock
        function saveScores() {
            alert('Scores saved successfully!');
            // In real: db.ref(`scores/2025/${currentUserClass}/monthly/09`).set(data);
        }
        
        // ERP Attendance Form
        document.getElementById('erp-attendance-form').addEventListener('submit', e => {
            e.preventDefault();
            const studentName = document.getElementById('erp-student-name').value;
            const date = document.getElementById('erp-date').value;
            const mark = document.getElementById('erp-mark').value;
            // Find student by name, restrict to class
            const student = students.find(s => `${s.firstName} ${s.lastName}`.toLowerCase().includes(studentName.toLowerCase()) && s.classLevel === currentUserClass);
            if (student) {
                db.ref(`attendance/${currentUserClass}/${date.substring(0,7)}/${date}/${student.admissionNumber}`).set({
                    am: mark,
                    pm: mark,
                    daily: mark,
                    snap: {
                        admissionNo: student.admissionNumber,
                        name: `${student.firstName} ${student.lastName}`,
                        class: student.classLevel,
                        feeDue: student.feePerYear,
                        feePaid: student.paidAmount,
                        balance: student.balance
                    }
                }).then(() => {
                    alert('Attendance marked!');
                    loadAttendanceData();
                    updateErpAttendanceTable();
                });
            } else {
                alert('Student not found in your class.');
            }
        });
        
        // Discipline Form Mock
        const disciplineForm = document.querySelector('#erp-discipline form');
        disciplineForm.addEventListener('submit', e => {
            e.preventDefault();
            alert('Incident logged!');
            loadDisciplineData();
        });
        
        // Admission Warning
        function showAdmissionWarning() {
            alert('Access to Admissions restricted. Contact Admin for new applications.');
        }
        
        // Logout
        function logout() {
            auth.signOut();
        }
        
        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
            const main = document.querySelector('.main-content');
            main.style.marginLeft = sidebar.classList.contains('expanded') ? '300px' : '100px';
        }
        
        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            showSection('dashboard');
        });
    </script>
</body>
</html>