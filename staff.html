<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoMApV2 — Teacher Dashboard (Staff) — Locked Academic</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Your firebase config file (must be present in same folder) -->
  <script src="firebase.js"></script>

  <!-- Tailwind, FontAwesome, Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    html,body { height:100%; }
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background: linear-gradient(135deg,#fef3c7 0%, #fff7ed 40%, #e0f2fe 100%); }
    .sidebar { position:fixed; left:0; top:0; height:100vh; width:0; overflow:hidden; transition:width .35s ease; background:linear-gradient(180deg,#0ea5e9,#6366f1); z-index:60; }
    .sidebar.expanded{ width:260px; }
    .sidebar .item{ color:white; padding:14px 18px; display:flex; gap:12px; align-items:center; cursor:pointer; }
    .sidebar .item:hover{ background: rgba(255,255,255,0.06); }
    #menu-dots{ position:fixed; top:16px; left:16px; z-index:70; background:transparent; border-radius:999px; padding:10px; }
    .main { transition: margin-left .35s ease; margin-left:0; padding:28px; }
    .main.shifted{ margin-left:260px; }
    .card { background:white; border-radius:12px; padding:18px; box-shadow:0 8px 20px rgba(16,24,40,0.06); }
    .welcome-modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:80; }
    .welcome-card{ background:linear-gradient(90deg,#60a5fa,#a78bfa); color:white; padding:22px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.25); text-align:center; }
    .toast{ position:fixed; right:20px; bottom:20px; background:rgba(0,0,0,0.75); color:white; padding:10px 14px; border-radius:8px; z-index:90; display:none; }
    /* Academic panel styles */
    #academic-panel { display:none; position:fixed; inset:8vh 6vw auto auto; width:84vw; max-height:84vh; overflow:auto; background:white; border-radius:12px; box-shadow:0 20px 50px rgba(0,0,0,.25); z-index:200; padding:18px; }
    #academic-panel .close { position:absolute; right:12px; top:10px; cursor:pointer; color:#374151; }
    table { width:100%; border-collapse:collapse; }
    table th, table td { padding:8px 10px; border-bottom:1px solid #e6e6e6; text-align:left; font-size:0.95rem; }
    .btn { cursor:pointer; padding:6px 10px; border-radius:8px; background:#4f46e5; color:white; font-weight:600; }
    .muted { color:#6b7280; font-size:0.9rem; }
  </style>
</head>
<body>

  <!-- three dots to open sidebar -->
  <button id="menu-dots" aria-label="open menu" title="open menu" class="text-white">
    <i class="fas fa-ellipsis-vertical fa-2x"></i>
  </button>

  <!-- sidebar -->
  <nav id="sidebar" class="sidebar" aria-hidden="true">
    <div class="p-4">
      <img src="images/somap-logo.png.jpg" alt="SoMAp" class="w-20 h-20 mx-auto rounded-full shadow-lg mb-3"/>
      <div class="text-white text-center font-semibold mb-4">SoMAp — Teacher</div>
      <!-- IMPORTANT: academic opens internal locked panel (no navigation) -->
      <div class="item" id="nav-academic"><i class="fas fa-book"></i><span>Academic</span></div>
      <div class="item" id="nav-attendance"><i class="fas fa-calendar-check"></i><span>Attendance</span></div>
      <div class="item" id="nav-discipline"><i class="fas fa-exclamation-triangle"></i><span>Discipline</span></div>
      <div class="item" id="nav-students"><i class="fas fa-users"></i><span>Student List</span></div>
      <div class="item mt-6" onclick="logout()"><i class="fas fa-right-from-bracket"></i><span>Logout</span></div>
    </div>
  </nav>

  <!-- main content -->
  <main id="main" class="main">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-bold">Teacher Dashboard</h1>
        <p class="text-sm text-gray-700">Live, class-filtered view for the signed-in teacher</p>
      </div>
      <div class="flex items-center gap-4">
        <div id="user-badge" class="text-sm text-gray-700"></div>
      </div>
    </div>

    <div id="grid" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="card">
        <h3 class="font-semibold">Academic Summary</h3>
        <div class="mt-3 text-2xl font-bold" id="class-score">-</div>
        <div class="text-sm text-gray-500">Class Average</div>
      </div>
      <div class="card">
        <h3 class="font-semibold">Attendance</h3>
        <div class="mt-3 text-2xl font-bold" id="present-percent">-</div>
        <div class="text-sm text-gray-500">% Present (monthly)</div>
      </div>
      <div class="card">
        <h3 class="font-semibold">Discipline</h3>
        <div class="mt-3 text-2xl font-bold" id="incidents-count">-</div>
        <div class="text-sm text-gray-500">Incidents logged</div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card">
        <h3 class="font-semibold mb-2">Subject Performance</h3>
        <canvas id="subjectsChart"></canvas>
      </div>
      <div class="card">
        <h3 class="font-semibold mb-2">Attendance Trend</h3>
        <canvas id="attendanceChart"></canvas>
      </div>
    </div>

    <div class="mt-6">
      <!-- We still keep external academic link, but the main access is the locked internal panel -->
      <button id="open-academic-inline" class="btn">Open Academic (inline, locked)</button>
      <span class="muted ml-3">(External academic.html link is available but internal view is stricter.)</span>
    </div>
  </main>

  <!-- Academic inline panel (locked to class) -->
  <div id="academic-panel" role="dialog" aria-modal="true" aria-labelledby="academic-title">
    <span class="close" id="close-academic" title="Close panel"><i class="fas fa-times fa-lg"></i></span>
    <h2 id="academic-title" class="text-lg font-bold mb-2">Academic — <span id="academic-class-name"></span></h2>

    <div class="mb-3 flex items-center gap-3">
      <input id="student-search" placeholder="Search student by name or admission no" class="p-2 rounded border w-1/3" />
      <select id="subject-filter" class="p-2 rounded border">
        <option value="">All subjects</option>
      </select>
      <button id="refresh-academic" class="btn">Refresh</button>
    </div>

    <div id="academic-summary" class="mb-4 muted"></div>

    <table id="academic-table" class="bg-white rounded">
      <thead>
        <tr>
          <th>Admission</th>
          <th>Name</th>
          <th>Avg %</th>
          <th>Last Scores (subjects)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="academic-tbody"></tbody>
    </table>
  </div>

  <!-- Welcome modal -->
  <div id="welcome" class="welcome-modal" style="display:none">
    <div class="welcome-card">
      <h2 id="welcome-msg" class="text-2xl font-bold">WELCOME</h2>
      <p id="welcome-sub" class="mt-2 opacity-90">...</p>
      <div class="mt-4"><button id="welcome-close" class="px-4 py-2 bg-white text-indigo-700 rounded">Continue</button></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Firebase refs
    const auth = firebase.auth();
    const db = firebase.database();

    // UI refs
    const sidebar = document.getElementById('sidebar');
    const main = document.getElementById('main');
    const menu = document.getElementById('menu-dots');
    const userBadge = document.getElementById('user-badge');
    const toast = document.getElementById('toast');

    // Academic panel refs
    const academicPanel = document.getElementById('academic-panel');
    const academicClassName = document.getElementById('academic-class-name');
    const academicTbody = document.getElementById('academic-tbody');
    const academicSummary = document.getElementById('academic-summary');
    const subjectFilter = document.getElementById('subject-filter');
    const studentSearch = document.getElementById('student-search');

    // state
    let currentUserClass = null;
    let teacherDisplay = null;
    let inStudents = {};       // keyed by studentKey or admission
    let inScores = {};         // scores for year/class
    let subjectsList = new Set();

    // charts
    let subjectsChart = null, attendanceChart = null;

    // helpers
    function showToast(msg, t=3000){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=>{ toast.style.display='none'; }, t); }
    function speak(msg){ if(!window.speechSynthesis) return; try{ const u=new SpeechSynthesisUtterance(msg); window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);}catch(e){console.warn(e)} }

    // toggle sidebar
    menu.addEventListener('click', ()=>{
      sidebar.classList.toggle('expanded');
      main.classList.toggle('shifted');
    });

    // nav items mapped (attendance/disc/students still navigate to pages)
    document.getElementById('nav-academic').addEventListener('click', openAcademicInline);
    document.getElementById('nav-attendance').addEventListener('click', ()=> window.location.href='attendance.html');
    document.getElementById('nav-discipline').addEventListener('click', ()=> window.location.href='dashboard.html');
    document.getElementById('nav-students').addEventListener('click', ()=> window.location.href='schoolerp.html');

    document.getElementById('open-academic-inline').addEventListener('click', openAcademicInline);
    document.getElementById('close-academic').addEventListener('click', ()=> academicPanel.style.display='none');
    document.getElementById('refresh-academic').addEventListener('click', ()=> loadClassAcademic(currentUserClass));

    // search + filter
    studentSearch.addEventListener('input', () => renderAcademicTable());
    subjectFilter.addEventListener('change', () => renderAcademicTable());

    function logout(){ auth.signOut().then(()=> window.location.href='index.html'); }

    // Auth flow - get user, then establish class and attach listeners
    auth.onAuthStateChanged(user=>{
      if(!user){ window.location.href='index.html'; return; }
      teacherDisplay = user.displayName || user.email.split('@')[0];
      // legacy: your users are keyed by email with '.' replaced by '_' (as provided)
      const safeEmail = (user.email || '').replace(/\./g, '_');
      db.ref('users/'+safeEmail).once('value').then(snap=>{
        const ud = snap.val() || {};
        if(ud.role !== 'teacher'){ alert('Unauthorized: only teachers allowed'); auth.signOut(); window.location.href='index.html'; return; }
        currentUserClass = ud.class || ud['class'] || ud.classLevel || '';
        if(!currentUserClass){
          alert('No class assigned to your account; contact admin.');
          auth.signOut(); return;
        }
        userBadge.innerHTML = `<strong>${teacherDisplay}</strong> · <span class="text-sm text-gray-600">${currentUserClass}</span>`;
        document.getElementById('welcome-msg').textContent = `WELCOME ${teacherDisplay.toUpperCase()}`;
        document.getElementById('welcome-sub').textContent = `You are viewing ${currentUserClass}`;
        document.getElementById('welcome').style.display = 'flex';
        setTimeout(()=>{ document.getElementById('welcome').style.display='none'; }, 1800);

        // attach listeners for summary cards & charts
        attachLockedListeners();
      }).catch(err=>{
        console.error('User lookup failed', err);
        alert('Account lookup failed. Contact admin.');
        auth.signOut();
      });
    });

    // Attach only class-scoped listeners (no global fetches)
    function attachLockedListeners(){
      // 1. students: query by class OR classLevel (some entries may use different field)
      // We keep two queries and merge their results by admission or key.
      const studentsByClassRef = db.ref('students').orderByChild('class').equalTo(currentUserClass);
      const studentsByClassLevelRef = db.ref('students').orderByChild('classLevel').equalTo(currentUserClass);

      function mergeStudentSnapshots() {
        // We'll re-run both queries' .once to rebuild merged students for simplicity
        Promise.all([
          db.ref('students').orderByChild('class').equalTo(currentUserClass).once('value'),
          db.ref('students').orderByChild('classLevel').equalTo(currentUserClass).once('value')
        ]).then(([snap1,snap2])=>{
          const a = snap1.val() || {};
          const b = snap2.val() || {};
          const merged = {};
          Object.entries(a).forEach(([k,v])=> merged[k]=v);
          Object.entries(b).forEach(([k,v])=> merged[k]=v);
          // Normalize keys - use admissionNumber if present else key
          inStudents = {};
          Object.entries(merged).forEach(([k,v])=>{
            const adm = v.admissionNumber || v.admission || k;
            inStudents[adm] = Object.assign({ _key:k, admission:adm }, v);
          });
          updateSummary(); // recalc cards & charts
        }).catch(err=> console.error('student merge err', err));
      }

      // Listen to changes: call merge on 'value' events
      studentsByClassRef.on('value', mergeStudentSnapshots);
      studentsByClassLevelRef.on('value', mergeStudentSnapshots);

      // 2. attendance for the current class ONLY
      db.ref(`attendance/${currentUserClass}`).on('value', snap=>{
        const att = snap.val() || {};
        window._lockedAttendance = att; // for updateSummary
        updateSummary();
      });

      // 3. scores for current year + class only
      const year = new Date().getFullYear();
      db.ref(`scores/${year}/${currentUserClass}`).on('value', snap=>{
        inScores = snap.val() || {};
        // compute set of subjects for the filter dropdown
        subjectsList = new Set();
        // traverse and add any subject keys we find
        Object.values(inScores||{}).forEach(exam=>{
          Object.values(exam||{}).forEach(monthObj=>{
            Object.values(monthObj||{}).forEach(studentRow=>{
              Object.keys(studentRow||{}).forEach(sub => subjectsList.add(sub));
            });
          });
        });
        populateSubjectFilter();
        updateSummary();
      });

      // 4. discipline incidents filtered by class (index by child 'class')
      db.ref('discipline').orderByChild('class').equalTo(currentUserClass).on('value', snap=>{
        window._lockedDiscipline = snap.val() || {};
        updateSummary();
      });
    }

    // Populate subject filter control
    function populateSubjectFilter(){
      const current = subjectFilter.value || '';
      subjectFilter.innerHTML = '<option value="">All subjects</option>';
      Array.from(subjectsList).sort().forEach(s=>{
        const o = document.createElement('option');
        o.value = s; o.textContent = s;
        subjectFilter.appendChild(o);
      });
      if(current) subjectFilter.value = current;
    }

    // Update dashboard cards & charts and keep academic table ready
    function updateSummary(){
      // Academic average across students & subjects
      let totalAvg=0, count=0; const subjectAggregates = {};
      const studentsArr = Object.values(inStudents || {});
      studentsArr.forEach(s=>{
        const adm = s.admission || s._key;
        // navigate inScores: exam -> month -> adm -> {subject: {score,max} or number}
        Object.values(inScores || {}).forEach(exam=>{
          Object.values(exam || {}).forEach(monthObj=>{
            const studentRow = monthObj[adm] || {};
            Object.entries(studentRow).forEach(([subject, val])=>{
              let score = 0, max = 100;
              if(val != null && typeof val === 'object'){
                score = Number(val.score || val.marks || 0);
                if(val.max) max = Number(val.max);
                else if(val.total) max = Number(val.total);
              } else if(typeof val === 'number' || !isNaN(Number(val))){
                score = Number(val);
              }
              const pct = max? (score/max)*100 : 0;
              subjectAggregates[subject] = subjectAggregates[subject] || { sum:0, n:0 };
              subjectAggregates[subject].sum += pct; subjectAggregates[subject].n += 1;
              totalAvg += pct; count++;
            });
          });
        });
      });

      const classAvg = count? (totalAvg/count): 0;
      document.getElementById('class-score').textContent = classAvg? classAvg.toFixed(1)+'%':'-';

      // Subject chart
      const subjects = Object.keys(subjectAggregates).sort();
      const subjData = subjects.map(s => (subjectAggregates[s].sum/subjectAggregates[s].n).toFixed(1));
      drawBar('subjectsChart', subjects, subjData);

      // Attendance percent for current class
      let presentSum=0, totalSum=0;
      const att = window._lockedAttendance || {};
      Object.values(att).forEach(month=>{
        Object.values(month||{}).forEach(rec => {
          if(rec.present != null && rec.total != null){
            presentSum += Number(rec.present);
            totalSum += Number(rec.total);
          } else if(rec.present != null && rec.absent != null){
            presentSum += Number(rec.present);
            totalSum += Number(rec.present) + Number(rec.absent);
          }
        });
      });
      const presentPct = totalSum? Math.round((presentSum/totalSum)*100): 0;
      document.getElementById('present-percent').textContent = presentPct? presentPct+'%':'-';

      // attendance trend
      const months = Object.keys(att).sort();
      const monthVals = months.map(m=>{
        const mm = att[m] || {}; let p=0,t=0;
        Object.values(mm).forEach(r=>{ if(r.present != null && r.total != null){ p+=Number(r.present); t+=Number(r.total); } else if(r.present!=null && r.absent!=null){ p+=Number(r.present); t+=Number(r.present)+Number(r.absent); } });
        return t? Math.round((p/t)*100) : 0;
      });
      drawLine('attendanceChart', months, monthVals);

      // Discipline incidents count
      const disc = window._lockedDiscipline || {};
      document.getElementById('incidents-count').textContent = Object.keys(disc).length || 0;

      // If academic panel is open, re-render table
      if(academicPanel.style.display === 'block') renderAcademicTable();
    }

    // Chart helpers
    function drawBar(el, labels, data){
      const ctx = document.getElementById(el).getContext('2d');
      if(window[el]) window[el].destroy();
      window[el] = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Avg %', data }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, max:100 } } }});
    }
    function drawLine(el, labels, data){
      const ctx = document.getElementById(el).getContext('2d');
      if(window[el]) window[el].destroy();
      window[el] = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'% Present', data, tension:0.2, fill:false }] }, options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }});
    }

    // ---------------------------
    // Academic inline functionality
    // ---------------------------
    function openAcademicInline(){
      if(!currentUserClass){ showToast('No class found for the signed-in account'); return; }
      academicClassName.textContent = currentUserClass;
      academicPanel.style.display = 'block';
      // load latest class academic data (listeners already attached by attachLockedListeners)
      renderAcademicTable();
    }

    // Build table rows for class students + computed averages & last scores
    function renderAcademicTable(){
      // Build array of students sorted by name or admission
      const studentsArr = Object.values(inStudents || {}).sort((a,b)=> {
        const an = (a.name||a.fullname||a.firstName||'').toLowerCase();
        const bn = (b.name||b.fullname||b.firstName||'').toLowerCase();
        if(an === bn) return (a.admission||'').localeCompare(b.admission||'');
        return an.localeCompare(bn);
      });

      const q = (studentSearch.value || '').toLowerCase().trim();
      const subjectFilterVal = (subjectFilter.value || '').trim();

      // Populate summary area
      academicSummary.textContent = `${studentsArr.length} student(s) found for ${currentUserClass}.`;

      // Clear table
      academicTbody.innerHTML = '';

      studentsArr.forEach(s=>{
        const adm = s.admission || s.admissionNumber || s._key;
        const name = s.name || s.fullname || `${s.firstName || ''} ${s.lastName || ''}` || adm;
        if(q){
          const hay = (adm + ' ' + name).toLowerCase();
          if(!hay.includes(q)) return;
        }

        // Compute student average and last scores:
        const studentRowScores = {}; // subject -> array of percentages (latest)
        const lastScoresSummary = {}; // subject -> last numeric score (or score/max)
        // traverse inScores: exam->month->adm->{subject: val}
        Object.keys(inScores||{}).forEach(examKey=>{
          const exam = inScores[examKey] || {};
          // we want the latest month/exam entries; but structure may vary. We'll aggregate all and use the last seen.
          Object.keys(exam).forEach(monthKey=>{
            const monthObj = exam[monthKey] || {};
            const stuRecord = monthObj[adm] || monthObj[adm.toString()] || monthObj[adm.toLowerCase()] || {};
            if(stuRecord && Object.keys(stuRecord).length){
              Object.entries(stuRecord).forEach(([sub, val])=>{
                let score = 0, max = 100;
                if(val != null && typeof val === 'object'){
                  score = Number(val.score || val.marks || 0);
                  if(val.max) max = Number(val.max);
                  else if(val.total) max = Number(val.total);
                } else if(!isNaN(Number(val))){
                  score = Number(val);
                }
                const pct = max ? (score/max)*100 : 0;
                // if subject filter is set, skip others
                if(subjectFilterVal && subjectFilterVal !== sub) return;
                studentRowScores[sub] = studentRowScores[sub] || [];
                studentRowScores[sub].push(pct);
                // last score summary (overwrite so last-seen stays)
                lastScoresSummary[sub] = `${Math.round(pct)}%`;
              });
            }
          });
        });

        // compute average across subjects (take averages of collected percentages)
        let total = 0, cc = 0;
        Object.values(studentRowScores).forEach(arr => { arr.forEach(v => { total += v; cc++; }); });
        const avg = cc ? (total/cc) : null;

        // Build lastScores string
        const lastScoresText = Object.keys(lastScoresSummary).length ? Object.entries(lastScoresSummary).map(([sub,val]) => `${sub}: ${val}`).join(' | ') : '-';

        // Build row
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${adm}</td>
          <td>${escapeHtml(name)}</td>
          <td>${avg !== null ? (avg.toFixed(1) + '%') : '-'}</td>
          <td>${escapeHtml(lastScoresText)}</td>
          <td>
            <button class="btn" data-adm="${adm}">View</button>
          </td>`;
        academicTbody.appendChild(tr);

        // attach view button handler
        tr.querySelector('button').addEventListener('click', (ev)=>{
          const admKey = ev.currentTarget.getAttribute('data-adm');
          // open scoresheet.html in new window with query params so instructor can view full record in that page
          // NOTE: this does not grant cross-class access because staff.html is the gatekeeper; still recommend DB rules
          const url = `Toacademichtml/scoresheet.html?class=${encodeURIComponent(currentUserClass)}&admission=${encodeURIComponent(admKey)}`;
          window.open(url, '_blank');
        });
      });

      // if no rows
      if(academicTbody.children.length === 0){
        academicTbody.innerHTML = `<tr><td colspan="5" class="muted">No students match your search / filters.</td></tr>`;
      }
    }

    // helper sanitize
    function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // load initial academic (no navigation)
    function loadClassAcademic(cls){
      // This just triggers listeners already set — invoked with refresh button.
      if(!cls) { showToast('No class assigned.'); return; }
      showToast('Refreshing academic view for ' + cls, 1500);
      // listeners update inScores & inStudents; call render
      renderAcademicTable();
    }

    // ------------------------------
    // On unload / notes
    // ------------------------------
    window.addEventListener('beforeunload', ()=>{
      // detach any heavy listeners if desired
      // (we left them attached for real-time updates; if you prefer manual refresh, remove listeners above)
    });

    // Security reminder (non-blocking):
    // This client-only locking prevents the staff UI from showing other classes.
    // For strong protection, use Firebase Realtime Database security rules that restrict reads/writes by auth.
    // (I can give the exact rules and migration steps when you're ready.)
  </script>
</body>
</html>
