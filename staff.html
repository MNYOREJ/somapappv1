<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoMAp - Teacher Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Retained styles from original, with enhancements for attractiveness */
        body { font-family: 'Roboto', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1rem; border-left: 4px solid #007bff; transition: transform 0.3s; }
        .card:hover { transform: scale(1.02); }
        .card.academic { border-left-color: #28a745; }
        .card.attendance { border-left-color: #ffc107; }
        .card.finance { border-left-color: #17a2b8; }
        .btn { background: linear-gradient(45deg, #007bff, #0056b3); color: white; padding: 0.75rem 1.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 10px; text-align: center; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="main-content p-4">
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold text-gray-800">Teacher Dashboard</h1>
            <div class="text-sm text-gray-600">
                Welcome, <span id="user-name"></span> | Class: <span id="user-class"></span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Stream Select -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-2 flex items-center">
                    <i class="fas fa-stream mr-2"></i> Select Stream
                </h2>
                <select id="stream-select" class="w-full p-2 border rounded">
                    <option value="A">Stream A</option>
                    <option value="B">Stream B</option>
                    <option value="Red">Red Stream</option>
                </select>
            </div>

            <!-- Academic Management Card -->
            <div class="card academic lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-graduation-cap mr-2"></i> Academic Management
                </h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="class-scores-count">-</h3>
                        <p>Average Score</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="top-student">-</h3>
                        <p>Top Student (%)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="bottom-student">-</h3>
                        <p>Bottom Student (%)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="class-grade">-</h3>
                        <p>Class Average Grade</p>
                    </div>
                </div>
                <a href="Tostaffhtml/teacherscoresheet.html" class="btn mt-2 block text-center">View Details</a>
            </div>

            <!-- Attendance Overview -->
            <div class="card attendance lg:col-span-3">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-calendar mr-2"></i> Attendance Overview
                </h2>
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                        <h3 id="percent-present">-</h3>
                        <p>% Present (Class Avg)</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <h3 id="percent-absent">-</h3>
                        <p>% Absent</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                        <h3 id="yellow-alerts">-</h3>
                        <p>Yellow Alerts (â‰¥10 absent days)</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);">
                        <h3 id="class-days">-</h3>
                        <p>Class Days (excl. weekends/holidays)</p>
                    </div>
                </div>
                <a href="Tostaffhtml/teacherclassattendance.html" class="btn mt-2 block text-center">View Details</a>
            </div>

            <!-- Fee Overview -->
            <div class="card finance lg:col-span-3">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-money-bill mr-2"></i> Fee Status
                </h2>
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                        <h3 id="fee-required">-</h3>
                        <p>Required (Class/Year)</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">
                        <h3 id="fee-paid">-</h3>
                        <p>Paid (Aggregated)</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                        <h3 id="fee-balance">-</h3>
                        <p>Balance (Outstanding)</p>
                    </div>
                </div>
            </div>

            <!-- Quick Links to Other Sections -->
            <div class="card lg:col-span-3">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-school mr-2"></i> Other Management Tools
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <a href="Tostaffhtml/teacherclassdiscipline.html" class="btn">Discipline Management</a>
                    <a href="Tostaffhtml/teacherstudentlist.html" class="btn">Student List</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { /* Same as original */ };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUserClass = '';
        let currentStream = 'A';
        let students = [];
        let attendance = {};
        let fees = {};

        auth.onAuthStateChanged(user => {
            if (!user) { window.location.href = 'index.html'; return; }
            const userRef = db.ref('users/' + user.email.replace('.', '_'));
            userRef.once('value').then(snapshot => {
                const userData = snapshot.val();
                if (!userData || userData.role !== 'teacher') { alert('Unauthorized'); auth.signOut(); window.location.href = 'index.html'; return; }
                document.getElementById('user-name').textContent = user.email.split('@')[0];
                currentUserClass = userData.class || 'Class 4';
                document.getElementById('user-class').textContent = currentUserClass;
                document.getElementById('stream-select').value = currentStream;
                loadData();
            });
        });

        function loadData() {
            db.ref('students').once('value').then(snapshot => {
                const allStudents = snapshot.val() ? Object.values(snapshot.val()) : [];
                students = allStudents.filter(s => s.classLevel === currentUserClass);
                loadAttendance();
                loadFees();
                updateDashboard();
            });
        }

        function loadAttendance() {
            // Simplified for dashboard overview, full in teacherclassattendance.html
            db.ref(`attendance/${currentUserClass}`).on('value', snapshot => {
                attendance = snapshot.val() || {};
                updateDashboard();
            });
        }

        function loadFees() {
            const year = new Date().getFullYear();
            db.ref(`payments/${year}/${currentUserClass}`).on('value', snapshot => {
                const payments = snapshot.val() || {};
                fees = {};
                students.forEach(s => {
                    const adm = s.admissionNumber;
                    const paid = Object.values(payments[adm] || {}).reduce((sum, p) => sum + (p.amount || 0), 0);
                    const due = s.feePerYear || 600000;
                    fees[adm] = { required: due, paid, balance: Math.max(0, due - paid) };
                });
                updateDashboard();
            });
        }

        function updateDashboard() {
            const streamStudents = students.filter(s => s.stream === currentStream);
            if (streamStudents.length === 0) return;

            // Academic Summary (simplified; full calc in teacherscoresheet.html)
            const avgScore = Math.round(streamStudents.reduce((sum, s) => sum + (s.avgScore || 70), 0) / streamStudents.length);
            document.getElementById('class-scores-count').textContent = avgScore + '%';
            const top = streamStudents.sort((a, b) => (b.avgScore || 0) - (a.avgScore || 0))[0];
            const bottom = streamStudents.sort((a, b) => (a.avgScore || 0) - (b.avgScore || 0))[0];
            document.getElementById('top-student').innerHTML = top ? `${top.firstName} ${top.lastName}<br><small>${(top.avgScore || 0).toFixed(1)}%</small>` : 'N/A';
            document.getElementById('bottom-student').innerHTML = bottom ? `${bottom.firstName} ${bottom.lastName}<br><small>${(bottom.avgScore || 0).toFixed(1)}%</small>` : 'N/A';
            document.getElementById('class-grade').textContent = letterGrade(avgScore);

            // Attendance Summary
            let totalDays = 0, presentDays = 0, yellowAlerts = 0, classDays = 0;
            Object.values(attendance).forEach(monthData => {
                Object.values(monthData || {}).forEach(dayData => {
                    Object.values(dayData || {}).forEach(rec => {
                        const days = rec.present + rec.absent;
                        classDays = Math.max(classDays, days);
                        presentDays += rec.present || 0;
                        totalDays += days;
                        if (rec.absent >= 10) yellowAlerts++;
                    });
                });
            });
            const percentPresent = totalDays ? (presentDays / totalDays * 100).toFixed(1) : 0;
            document.getElementById('percent-present').textContent = percentPresent + '%';
            document.getElementById('percent-absent').textContent = (100 - parseFloat(percentPresent)) + '%';
            document.getElementById('yellow-alerts').textContent = yellowAlerts;
            document.getElementById('class-days').textContent = classDays;

            // Fee Summary
            let totalDue = 0, totalPaid = 0, totalBalance = 0;
            streamStudents.forEach(s => {
                const fee = fees[s.admissionNumber] || { required: 600000, paid: 0, balance: 600000 };
                totalDue += fee.required;
                totalPaid += fee.paid;
                totalBalance += fee.balance;
            });
            document.getElementById('fee-required').textContent = money(totalDue);
            document.getElementById('fee-paid').textContent = money(totalPaid);
            document.getElementById('fee-balance').textContent = money(totalBalance);
        }

        function letterGrade(pct) { /* Same as original */ }
        function money(n) { /* Same as original */ }

        document.getElementById('stream-select').addEventListener('change', (e) => {
            currentStream = e.target.value;
            updateDashboard();
        });
    </script>
</html>