<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoMAp - Student List</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    .modal-content {
      position: relative;
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      height: 80vh;
      overflow-y: auto;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body class="bg-gray-50 p-4">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
    <h2 class="text-2xl font-bold mb-4">Live Student List</h2>
    <p class="text-sm text-gray-500 mb-4">View and manage registered students. Filter by class.</p>
    <select id="classFilter" class="w-full p-2 border rounded-lg mb-4">
      <option value="">All Classes</option>
      <option value="Baby Class">Baby Class</option>
      <option value="Class 1">Class 1</option>
      <option value="Class 2">Class 2</option>
      <option value="Class 3">Class 3</option>
      <option value="Class 4">Class 4</option>
      <option value="Class 5">Class 5</option>
      <option value="Class 6">Class 6</option>
      <option value="Class 7">Class 7</option>
    </select>
    <table id="studentTable">
      <thead>
        <tr>
          <th>Full Name (First, Middle, Last)</th>
          <th>Class</th>
          <th>Date of Registration</th>
          <th>Passport Photo</th>
          <th>Parent Contact</th>
          <th>Fee Total</th>
          <th>Payment Plan</th>
          <th>View Details</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="downloadCSV" class="mt-4 py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Download CSV</button>
    <button id="downloadPDF" class="mt-4 py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Download PDF</button>
  </div>

  <!-- Details Modal -->
  <div id="detailsModal" class="modal">
    <div class="modal-content">
      <span id="closeDetailsModal" class="close">&times;</span>
      <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Student Details</h2>
      <div id="studentDetails"></div>
      <button id="generateIDCard" class="mt-4 py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Generate ID Card</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.firebasestorage.app",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Load students
    db.ref('students').on('value', (snapshot) => {
      const students = snapshot.val() || {};
      const tableBody = document.querySelector('#studentTable tbody');
      tableBody.innerHTML = '';
      Object.entries(students).forEach(([id, student]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}</td>
          <td>${student.classLevel || 'N/A'}</td>
          <td>${student.timestamp ? new Date(student.timestamp).toLocaleDateString() : 'N/A'}</td>
          <td><img src="${student.passportPhoto || 'https://via.placeholder.com/50'}" alt="Photo" style="width: 50px; height: 50px;"></td>
          <td>${student.primaryParentContact || 'N/A'}</td>
          <td>${student.feePerYear || '0'}</td>
          <td>${student.paymentPlan || 'N/A'}</td>
          <td><i class="fas fa-eye cursor-pointer" onclick="viewDetails('${id}')"></i></td>
        `;
        tableBody.appendChild(row);
      });
    });

    // Filter by class
    document.getElementById('classFilter').addEventListener('change', (e) => {
      const classLevel = e.target.value;
      const rows = document.querySelectorAll('#studentTable tbody tr');
      rows.forEach(row => {
        row.style.display = classLevel === '' || row.cells[1].textContent === classLevel ? '' : 'none';
      });
    });

    // View Details Modal
    function viewDetails(id) {
      db.ref('students/' + id).once('value').then((snapshot) => {
        const student = snapshot.val() || {};
        const details = document.getElementById('studentDetails');
        details.innerHTML = `
          <p><strong>Full Name:</strong> ${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}</p>
          <p><strong>Class:</strong> ${student.classLevel || 'N/A'}</p>
          <p><strong>Date of Registration:</strong> ${student.timestamp ? new Date(student.timestamp).toLocaleDateString() : 'N/A'}</p>
          <p><strong>Passport Photo:</strong> <img src="${student.passportPhoto || 'https://via.placeholder.com/100'}" alt="Photo" style="width: 100px; height: 100px;"></p>
          <p><strong>Parent Contact:</strong> ${student.primaryParentContact || 'N/A'}</p>
          <p><strong>Fee Total:</strong> ${student.feePerYear || '0'}</p>
          <p><strong>Payment Plan:</strong> ${student.paymentPlan || 'N/A'}</p>
          <p><strong>Residential Address:</strong> ${student.residentialAddress || 'N/A'}</p>
          <p><strong>Admission Number:</strong> ${student.admissionNumber || 'N/A'}</p>
        `;
        document.getElementById('generateIDCard').onclick = () => generateIDCard(student);
        document.getElementById('detailsModal').style.display = 'block';
      });
    }

    document.getElementById('closeDetailsModal').addEventListener('click', () => {
      document.getElementById('detailsModal').style.display = 'none';
    });

    // Generate ID Card PDF
    function generateIDCard(student) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.addImage('images/somap-logo.png.jpg', 'PNG', 10, 10, 50, 50); // Ensure logo is in /images folder
      doc.setFontSize(16);
      doc.text('Student ID Card', 70, 20);
      doc.setFontSize(12);
      doc.text(`Full Name: ${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`, 10, 70);
      doc.text(`Admission Number: ${student.admissionNumber || 'N/A'}`, 10, 80);
      doc.text(`Class: ${student.classLevel || 'N/A'}`, 10, 90);
      doc.text(`Parent Contact: ${student.primaryParentContact || 'N/A'}`, 10, 100);
      doc.text(`School Contact: +255686828732`, 10, 110);
      doc.text(`Residential Address: ${student.residentialAddress || 'N/A'}`, 10, 120);
      if (student.passportPhoto) {
        doc.addImage(student.passportPhoto, 'JPEG', 10, 130, 50, 50);
      }
      doc.save('student-id-card.pdf');
    }

    // Download CSV
    document.getElementById('downloadCSV').addEventListener('click', () => {
      db.ref('students').once('value').then(snapshot => {
        const students = snapshot.val() || {};
        const data = Object.values(students).map(student => ({
          'Full Name': `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`,
          'Class': student.classLevel || 'N/A',
          'Date of Registration': student.timestamp ? new Date(student.timestamp).toLocaleDateString() : 'N/A',
          'Passport Photo': student.passportPhoto || 'N/A',
          'Parent Contact': student.primaryParentContact || 'N/A',
          'Fee Total': student.feePerYear || '0',
          'Payment Plan': student.paymentPlan || 'N/A'
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Students');
        XLSX.writeFile(wb, 'student-list.csv');
      });
    });

    // Download PDF
    document.getElementById('downloadPDF').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');
      doc.setFontSize(16);
      doc.text('Student List', 10, 10);
      db.ref('students').once('value').then(snapshot => {
        const students = snapshot.val() || {};
        const rows = Object.values(students).map(student => [
          `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`,
          student.classLevel || 'N/A',
          student.timestamp ? new Date(student.timestamp).toLocaleDateString() : 'N/A',
          student.passportPhoto || 'N/A',
          student.primaryParentContact || 'N/A',
          student.feePerYear || '0',
          student.paymentPlan || 'N/A'
        ]);
        doc.autoTable({
          head: [['Full Name', 'Class', 'Date of Registration', 'Passport Photo', 'Parent Contact', 'Fee Total', 'Payment Plan']],
          body: rows,
          startY: 20,
          styles: { fontSize: 8 }
        });
        doc.save('student-list.pdf');
      });
    });
  </script>
</body>
</html>