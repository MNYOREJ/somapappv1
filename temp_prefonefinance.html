<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoMAp - Preform One Finance</title>

  <!-- Firebase Compat SDKs (v9.6.10 for consistency with repo) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- UI Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Shared Preform One Logic -->
  <script src="prefonecommon.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Poppins', 'Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            somap: {
              midnight: '#020617',
              ocean: '#0ea5e9',
              orchid: '#8b5cf6',
              mint: '#34d399',
              amber: '#fbbf24'
            }
          },
          boxShadow: {
            neon: '0 20px 60px -28px rgba(14, 165, 233, 0.7)',
          }
        }
      }
    };
  </script>

  <style>
    body {
      background: radial-gradient(circle at 20% -10%, rgba(79, 70, 229, 0.35), rgba(15, 23, 42, 0.96) 62%);
      min-height: 100vh;
      color: #e2e8f0;
      font-family: 'Inter', system-ui, sans-serif;
    }
    .glass-panel {
      background: rgba(15, 23, 42, 0.82);
      border-radius: 1.75rem;
      border: 1px solid rgba(148, 163, 184, 0.22);
      backdrop-filter: blur(16px);
      box-shadow: 0 30px 80px -45px rgba(8, 47, 73, 0.85);
    }
    .stat-card {
      position: relative;
      border-radius: 1.35rem;
      padding: 1.35rem;
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.22), rgba(59, 130, 246, 0.24));
      border: 1px solid rgba(148, 163, 184, 0.28);
      box-shadow: 0 25px 65px -50px rgba(20, 184, 166, 0.9);
      transition: transform 180ms ease, border-color 200ms ease, box-shadow 200ms ease;
    }
    .stat-card:hover {
      transform: translateY(-6px);
      border-color: rgba(96, 165, 250, 0.55);
      box-shadow: 0 35px 80px -50px rgba(59, 130, 246, 0.75);
    }
    .status-pill {
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .status-paid { background: rgba(34, 197, 94, 0.22); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.4); }
    .status-partial { background: rgba(250, 204, 21, 0.18); color: #facc15; border: 1px solid rgba(250, 204, 21, 0.38); }
    .status-overdue { background: rgba(248, 113, 113, 0.2); color: #fca5a5; border: 1px solid rgba(248, 113, 113, 0.45); }
    .debt-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      padding: 0.3rem 0.85rem;
      border: 1px solid rgba(148, 163, 184, 0.24);
      background: rgba(148, 163, 184, 0.12);
      font-size: 0.75rem;
      color: rgba(226, 232, 240, 0.85);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .debt-chip.overdue {
      border-color: rgba(248, 113, 113, 0.45);
      background: rgba(248, 113, 113, 0.12);
      color: #fca5a5;
    }
    .debt-chip.due-soon {
      border-color: rgba(250, 204, 21, 0.4);
      background: rgba(250, 204, 21, 0.12);
      color: #facc15;
    }
    table thead th {
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.68rem;
    }
    table tbody td {
      border-bottom: 1px solid rgba(148, 163, 184, 0.12);
    }
    table tfoot td {
      background: rgba(59, 130, 246, 0.12);
      border-top: 1px solid rgba(59, 130, 246, 0.35);
    }
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 50;
      background: rgba(2, 6, 23, 0.65);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }
    .modal-card {
      width: 100%;
      max-width: 420px;
      border-radius: 1.5rem;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 35px 90px -45px rgba(14, 165, 233, 0.75);
      color: #e2e8f0;
    }
    .details-card {
      max-width: 560px;
      background: rgba(15, 23, 42, 0.96);
    }
    .modal-card input,
    .modal-card select,
    .modal-card textarea {
      background: rgba(30, 41, 59, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: 0.9rem;
      color: #e2e8f0;
      width: 100%;
    }
    .modal-card input:focus,
    .modal-card select:focus {
      outline: none;
      border-color: rgba(14, 165, 233, 0.6);
      box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25);
    }
  </style>
</head>
<body class="relative min-h-screen overflow-x-hidden">
  <div class="pointer-events-none absolute inset-0 -z-10">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_80%_20%,rgba(99,102,241,0.24),transparent_40%)]"></div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_15%_25%,rgba(14,165,233,0.16),transparent_35%)]"></div>
    <div class="absolute inset-0 bg-[linear-gradient(140deg,rgba(2,6,23,0.85),rgba(15,23,42,0.95))]"></div>
  </div>

  <main class="relative mx-auto flex w-full max-w-7xl flex-col gap-10 px-4 py-10 sm:px-6 lg:px-10">
    <header class="flex flex-col gap-6 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <span class="inline-flex items-center gap-2 rounded-full border border-sky-500/30 bg-sky-500/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-sky-200/80">
          <i class="fas fa-coins text-sky-300"></i> Finance Desk
        </span>
        <h1 class="mt-4 text-3xl font-semibold text-slate-100 sm:text-4xl">Preform One - Finance Control Room</h1>
        <p class="mt-2 max-w-2xl text-sm text-slate-400 sm:text-base">Track collections, outstanding balances, and expenses with a calm, glassmorphic dashboard built for Preform One.</p>
      </div>
      <a href="prefonedashboard.html" class="inline-flex items-center gap-2 rounded-full border border-slate-500/40 bg-slate-900/40 px-4 py-2 text-sm font-medium text-slate-200 transition hover:border-sky-400/60 hover:bg-slate-900/70 hover:text-white">
        <i class="fas fa-arrow-left"></i>
        Back to Dashboard
      </a>
    </header>

    <section class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-5">
      <article class="stat-card">
        <span class="text-xs uppercase tracking-widest text-slate-300">Total Due</span>
        <p id="totalDue" class="mt-2 text-2xl font-semibold text-sky-100">TSh 0</p>
        <p class="mt-4 text-xs text-slate-400">Projected invoices across enrolled learners.</p>
      </article>
      <article class="stat-card">
        <span class="text-xs uppercase tracking-widest text-slate-300">Collected</span>
        <p id="collected" class="mt-2 text-2xl font-semibold text-emerald-100">TSh 0</p>
        <p class="mt-4 text-xs text-slate-400">Payments recorded in the system this academic year.</p>
      </article>
      <article class="stat-card">
        <span class="text-xs uppercase tracking-widest text-slate-300">Outstanding</span>
        <p id="outstanding" class="mt-2 text-2xl font-semibold text-amber-100">TSh 0</p>
        <p class="mt-4 text-xs text-slate-400">Balances still open for follow-up.</p>
      </article>
      <article class="stat-card">
        <span class="text-xs uppercase tracking-widest text-slate-300">Expenses</span>
        <p id="expensesTotal" class="mt-2 text-2xl font-semibold text-rose-100">TSh 0</p>
        <p class="mt-4 text-xs text-slate-400">Approved spending posted by the bursar.</p>
      </article>
      <article class="stat-card">
        <span class="text-xs uppercase tracking-widest text-slate-300">Net Balance</span>
        <p id="netBal" class="mt-2 text-2xl font-semibold text-indigo-100">TSh 0</p>
        <p class="mt-4 text-xs text-slate-400">Collections minus posted expenditure.</p>
      </article>
    </section>

    <section class="glass-panel px-6 py-8 sm:px-8 sm:py-10">
      <div class="flex flex-col gap-5 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-white">Learner Collections</h2>
          <p class="mt-1 text-sm text-slate-400">Monitor fees intake per child, highlight debtors, and export up-to-date registers.</p>
        </div>
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
          <label class="text-xs font-semibold uppercase tracking-widest text-slate-400 sm:text-right">Filter Cohort</label>
          <select id="classFilter" class="w-full rounded-full border border-slate-500/40 bg-slate-900/50 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 sm:w-56" onchange="loadFinance()">
            <option value="">All Preform One</option>
            <option>September Joiners</option>
            <option>October Joiners</option>
            <option>November Joiners</option>
          </select>
        </div>
      </div>

      <div class="mt-6 flex flex-col gap-3 md:flex-row md:flex-wrap md:items-center md:justify-between">
        <button onclick="toggleDebtors()" class="inline-flex items-center gap-2 rounded-full border border-amber-400/50 bg-amber-500/15 px-4 py-2 text-sm font-medium text-amber-200 transition hover:border-amber-300 hover:bg-amber-500/25">
          <i class="fas fa-exclamation-triangle"></i>
          <span id="debtorsToggleLabel">Show Debtors</span>
        </button>
        <div class="flex flex-wrap gap-2">
          <button onclick="exportMainCSV()" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/15 px-4 py-2 text-sm font-medium text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-400/25">
            <i class="fas fa-file-csv"></i> Main CSV
          </button>
          <button onclick="exportMainPDF()" class="inline-flex items-center gap-2 rounded-full border border-rose-400/40 bg-rose-400/15 px-4 py-2 text-sm font-medium text-rose-100 transition hover:border-rose-300 hover:bg-rose-400/25">
            <i class="fas fa-file-pdf"></i> Main PDF
          </button>
          <button onclick="exportDebtorsCSV()" class="inline-flex items-center gap-2 rounded-full border border-amber-400/40 bg-amber-400/15 px-4 py-2 text-sm font-medium text-amber-100 transition hover:border-amber-300 hover:bg-amber-400/25">
            <i class="fas fa-file-csv"></i> Debtors CSV
          </button>
          <button onclick="exportDebtorsPDF()" class="inline-flex items-center gap-2 rounded-full border border-orange-400/40 bg-orange-400/15 px-4 py-2 text-sm font-medium text-orange-100 transition hover:border-orange-300 hover:bg-orange-400/25">
            <i class="fas fa-file-pdf"></i> Debtors PDF
          </button>
        </div>
      </div>

      <div class="mt-8 overflow-x-auto rounded-3xl border border-slate-500/30 bg-slate-900/35">
        <table class="min-w-full text-left text-sm text-slate-100">
          <thead class="border-b border-slate-500/30 bg-slate-900/60 text-xs text-slate-300">
            <tr>
              <th class="px-5 py-4">ADM No</th>
              <th class="px-5 py-4">Full Name</th>
              <th class="px-5 py-4">Parent Contact</th>
              <th class="px-5 py-4">Total Fee</th>
              <th class="px-5 py-4">Payment Plan</th>
              <th class="px-5 py-4">Paid</th>
              <th class="px-5 py-4">Balance</th>
              <th class="px-5 py-4">Debt Till</th>
              <th class="px-5 py-4">Status</th>
              <th class="px-5 py-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="financeBody" class="divide-y divide-slate-500/15"></tbody>
          <tfoot id="financeTotals"></tfoot>
        </table>
      </div>
    </section>

    <section class="glass-panel px-6 py-8 sm:px-8 sm:py-10">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-white">Operations Expenses</h2>
          <p class="mt-1 text-sm text-slate-400">Log day-to-day spending alongside income to maintain an always-fresh picture of cash flow.</p>
        </div>
        <form id="expenseForm" class="flex w-full flex-col gap-3 rounded-2xl border border-slate-500/30 bg-slate-900/30 p-4 md:w-auto md:flex-row md:items-center md:gap-4">
          <select id="expenseCategory" class="w-full rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 md:w-44" required>
            <option value="">Category</option>
            <option>STATIONERY</option>
            <option>TRANSPORT</option>
            <option>PURCHASES</option>
            <option>SIL</option>
            <option>MAINTENANCE</option>
            <option>BOOKS</option>
            <option>EMERGENCY</option>
            <option>MISCELLANEOUS</option>
          </select>
          <input id="expenseDescription" type="text" placeholder="Description" class="w-full rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 md:w-56" required>
          <input id="expenseAmount" type="number" min="1" placeholder="Amount" class="w-full rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 md:w-40" required>
          <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-full border border-indigo-400/40 bg-indigo-500/20 px-4 py-2 text-sm font-semibold text-indigo-100 transition hover:border-indigo-300 hover:bg-indigo-500/30 md:w-auto">
            <i class="fas fa-plus-circle"></i> Add Expense
          </button>
        </form>
      </div>

      <div class="mt-6 flex flex-wrap gap-2">
        <button onclick="exportExpenseCSV()" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/15 px-4 py-2 text-sm font-medium text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-400/25">
          <i class="fas fa-file-csv"></i> Expenses CSV
        </button>
        <button onclick="exportExpensePDF()" class="inline-flex items-center gap-2 rounded-full border border-rose-400/40 bg-rose-400/15 px-4 py-2 text-sm font-medium text-rose-100 transition hover:border-rose-300 hover:bg-rose-400/25">
          <i class="fas fa-file-pdf"></i> Expenses PDF
        </button>
      </div>

      <div class="mt-8 overflow-x-auto rounded-3xl border border-slate-500/30 bg-slate-900/35">
        <table class="min-w-full text-left text-sm text-slate-100">
          <thead class="border-b border-slate-500/30 bg-slate-900/60 text-xs text-slate-300">
            <tr>
              <th class="px-5 py-4">Category</th>
              <th class="px-5 py-4">Description</th>
              <th class="px-5 py-4">Amount</th>
              <th class="px-5 py-4">Date</th>
            </tr>
          </thead>
          <tbody id="expenseBody" class="divide-y divide-slate-500/15"></tbody>
          <tfoot id="expenseTotals"></tfoot>
        </table>
      </div>
    </section>
  </main>

  <div id="paymentModal" class="modal-backdrop">
    <div class="modal-card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white"><i class="fas fa-money-check mr-2 text-sky-300"></i> Add Payment</h2>
        <button type="button" class="text-slate-400 transition hover:text-white" onclick="closeModal('paymentModal')">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
      <form id="paymentForm" class="mt-6 space-y-4">
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Amount Received</label>
          <input id="paymentAmount" type="number" min="1" class="px-4 py-3 text-sm" placeholder="Enter amount" required>
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Received On</label>
          <input id="paymentDate" type="date" class="px-4 py-3 text-sm" required>
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Payment Method</label>
          <select id="paymentMethod" class="px-4 py-3 text-sm">
            <option>Cash</option>
            <option>MPesa</option>
            <option>Airtel Money</option>
            <option>TigoPesa</option>
            <option>Bank Transfer</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Notes (optional)</label>
          <textarea id="paymentNote" rows="2" class="px-4 py-3 text-sm" placeholder="Reference, receipt, or collector name"></textarea>
        </div>
        <div class="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
          <button type="button" onclick="closeModal('paymentModal')" class="inline-flex items-center justify-center gap-2 rounded-full border border-slate-500/40 px-4 py-2 text-sm font-medium text-slate-300 transition hover:border-slate-300 hover:text-white">
            Cancel
          </button>
          <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-full border border-sky-400/40 bg-sky-500/25 px-5 py-2 text-sm font-semibold text-sky-100 transition hover:border-sky-300 hover:bg-sky-500/35">
            <i class="fas fa-save"></i> Save Payment
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="detailsModal" class="modal-backdrop">
    <div class="modal-card details-card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white"><i class="fas fa-user-circle mr-2 text-indigo-300"></i> Student Finance Details</h2>
        <button type="button" class="text-slate-400 transition hover:text-white" onclick="closeModal('detailsModal')">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
      <div id="detailsContent" class="mt-6 space-y-3 text-sm text-slate-300"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    let financeData = [];
    let showingDebtors = false;
    let selectedAdm = '';

    const formatCurrency = (value) => {
      const amount = Number(value || 0);
      return `TSh ${amount.toLocaleString()}`;
    };

    function loadFinance() {
      db.ref(`/schools/Socrates School Preform one/${currentYear}/students`).once('value').then(snap => {
        const students = Object.entries(snap.val() || {});
        let due = 0, coll = 0;
        financeData = students.map(([adm, s]) => {
          const paymentsArray = Object.values(s.payments || {});
          const paid = paymentsArray.reduce((sum, p) => sum + Number(p.amount || 0), 0);
          const bal = Number(s.totalFee || 0) - paid;
          due += Number(s.totalFee || 0);
          coll += paid;
          const nextDue = new Date(s.reportingDate || new Date());
          nextDue.setMonth(nextDue.getMonth() + 1);
          const daysToDue = (nextDue - new Date()) / (1000 * 60 * 60 * 24);
          const debtClass = daysToDue < 0 ? 'debt-chip overdue' : daysToDue < 7 ? 'debt-chip due-soon' : 'debt-chip';
          const debtLabel = daysToDue < 0
            ? `Overdue ${Math.abs(daysToDue).toFixed(0)} days`
            : daysToDue < 7
              ? `Due in ${daysToDue.toFixed(0)} days`
              : `Due ${nextDue.toLocaleDateString('en-GB')}`;
          const status = bal <= 0 ? 'paid' : daysToDue < 0 ? 'overdue' : 'partial';
          return {
            adm,
            name: `${s.firstName || ''} ${s.lastName || ''}`.trim() || 'Unnamed Learner',
            contact: s.parentContact || '',
            totalFee: Number(s.totalFee || 0),
            plan: s.reportingDate ? `From ${new Date(s.reportingDate).toLocaleDateString('en-GB')}` : 'Full Program',
            paid,
            bal,
            debtTill: `<span class="${debtClass}">${debtLabel}</span>`,
            status,
            photoUrl: s.photoUrl || '',
            rawDebtInfo: { debtClass, debtLabel },
            payments: paymentsArray
          };
        });

        db.ref(`/schools/Socrates School Preform one/${currentYear}/expenses`).once('value').then(eSnap => {
          const expensesArray = Object.values(eSnap.val() || {});
          const exp = expensesArray.reduce((sum, ex) => sum + Number(ex.amount || 0), 0);
          document.getElementById('totalDue').textContent = formatCurrency(due);
          document.getElementById('collected').textContent = formatCurrency(coll);
          document.getElementById('outstanding').textContent = formatCurrency(due - coll);
          document.getElementById('expensesTotal').textContent = formatCurrency(exp);
          document.getElementById('netBal').textContent = formatCurrency(coll - exp);
        }).catch(err => {
          console.error('Expenses load error:', err);
        });

        renderTable();
      }).catch(err => {
        console.error('Load error:', err);
        Swal.fire('Error', 'Failed to load finance data: ' + err.message, 'error');
      });
    }

    function renderTable() {
      const tbody = document.getElementById('financeBody');
      const tfoot = document.getElementById('financeTotals');
      tbody.innerHTML = '';
      tfoot.innerHTML = '';

      const rows = financeData.filter(row => !(showingDebtors && row.bal <= 0));
      let totalFee = 0;
      let totalPaid = 0;
      let totalBal = 0;

      if (!rows.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="px-5 py-6 text-center text-sm text-slate-400">No learners found for this view.</td>
          </tr>
        `;
      } else {
        rows.forEach(row => {
          totalFee += row.totalFee;
          totalPaid += row.paid;
          totalBal += row.bal;
          tbody.innerHTML += `
            <tr class="transition hover:bg-slate-900/45">
              <td class="px-5 py-4 font-semibold text-slate-200">${row.adm}</td>
              <td class="px-5 py-4">${row.name}</td>
              <td class="px-5 py-4">${row.contact}</td>
              <td class="px-5 py-4">${formatCurrency(row.totalFee)}</td>
              <td class="px-5 py-4 text-xs text-slate-400">${row.plan}</td>
              <td class="px-5 py-4 text-emerald-200">${formatCurrency(row.paid)}</td>
              <td class="px-5 py-4 text-amber-200">${formatCurrency(row.bal)}</td>
              <td class="px-5 py-4">${row.debtTill}</td>
              <td class="px-5 py-4"><span class="status-pill status-${row.status}">${row.status.charAt(0).toUpperCase() + row.status.slice(1)}</span></td>
              <td class="px-5 py-4 text-right">
                <div class="flex justify-end gap-2">
                  <button class="inline-flex items-center gap-1 rounded-full border border-slate-500/40 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-slate-300 hover:text-white" onclick="viewDetails('${row.adm}')">
                    <i class="fas fa-eye"></i> View
                  </button>
                  <button class="inline-flex items-center gap-1 rounded-full border border-emerald-400/50 bg-emerald-500/15 px-3 py-1 text-xs font-semibold text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-500/25" onclick="openPaymentModal('${row.adm}')">
                    <i class="fas fa-money-bill"></i> Pay
                  </button>
                </div>
              </td>
            </tr>
          `;
        });
      }

      tfoot.innerHTML = `
        <tr class="text-sm font-semibold text-slate-200">
          <td colspan="3" class="px-5 py-4 uppercase tracking-widest text-slate-300">Totals (${rows.length} learners)</td>
          <td class="px-5 py-4">${formatCurrency(totalFee)}</td>
          <td class="px-5 py-4 text-center text-slate-500">—</td>
          <td class="px-5 py-4 text-emerald-200">${formatCurrency(totalPaid)}</td>
          <td class="px-5 py-4 text-amber-200">${formatCurrency(totalBal)}</td>
          <td class="px-5 py-4 text-center text-slate-500">—</td>
          <td class="px-5 py-4 text-center text-slate-500">—</td>
          <td class="px-5 py-4 text-right text-slate-500">—</td>
        </tr>
      `;
    }

    function openPaymentModal(adm) {
      selectedAdm = adm;
      document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('paymentModal').style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const amount = parseInt(document.getElementById('paymentAmount').value, 10);
      const method = document.getElementById('paymentMethod').value;
      const note = document.getElementById('paymentNote').value;
      const date = document.getElementById('paymentDate').value;
      if (!amount) {
        return Swal.fire('Error', 'Enter amount', 'error');
      }
      if (!date) {
        return Swal.fire('Error', 'Select the date received', 'error');
      }
      try {
        await db.ref(`/schools/Socrates School Preform one/${currentYear}/students/${selectedAdm}/payments`).push({ amount, method, note, date });
        Swal.fire('Success', 'Payment added', 'success');
        closeModal('paymentModal');
        document.getElementById('paymentForm').reset();
        loadFinance();
      } catch (err) {
        Swal.fire('Error', 'Failed to add payment: ' + err.message, 'error');
      }
    });

    function viewDetails(adm) {
      const row = financeData.find(r => r.adm === adm);
      if (!row) return;
      const paymentsList = (row.payments || []).map(pay => `
        <li class="flex items-center justify-between rounded-xl border border-slate-600/30 bg-slate-900/50 px-3 py-2 text-xs">
          <span>${new Date(pay.date || new Date()).toLocaleDateString('en-GB')}</span>
          <span class="font-semibold text-emerald-200">${formatCurrency(pay.amount)}</span>
          <span class="text-slate-400">${pay.method || 'Method'}</span>
        </li>
      `).join('');
      const historyHtml = paymentsList
        ? `<h3 class="pt-4 text-xs font-semibold uppercase tracking-widest text-slate-400">Recent Payments</h3><ul class="mt-2 space-y-2">${paymentsList}</ul>`
        : '<p class="pt-4 text-xs text-slate-500">No payments recorded yet.</p>';
      const detailsHtml = `
        <p><strong class="text-slate-200">Name:</strong> ${row.name}</p>
        <p><strong class="text-slate-200">Contact:</strong> ${row.contact || '—'}</p>
        <p><strong class="text-slate-200">Total Fee:</strong> ${formatCurrency(row.totalFee)}</p>
        <p><strong class="text-slate-200">Paid:</strong> ${formatCurrency(row.paid)}</p>
        <p><strong class="text-slate-200">Balance:</strong> ${formatCurrency(row.bal)}</p>
        <p><strong class="text-slate-200">Debt Status:</strong> ${row.rawDebtInfo.debtLabel}</p>
        ${row.photoUrl ? `<img src="${row.photoUrl}" alt="Learner photo" class="mt-4 h-28 w-28 rounded-2xl object-cover">` : ''}
        ${historyHtml}
      `;
      document.getElementById('detailsContent').innerHTML = detailsHtml;
      document.getElementById('detailsModal').style.display = 'flex';
    }

    function loadExpenses() {
      db.ref(`/schools/Socrates School Preform one/${currentYear}/expenses`).once('value').then(snap => {
        const expenses = Object.entries(snap.val() || {});
        const tbody = document.getElementById('expenseBody');
        const tfoot = document.getElementById('expenseTotals');
        tbody.innerHTML = '';
        tfoot.innerHTML = '';

        if (!expenses.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" class="px-5 py-6 text-center text-sm text-slate-400">No expenses recorded yet.</td>
            </tr>
          `;
          return;
        }

        let total = 0;
        expenses.forEach(([key, ex]) => {
          const amount = Number(ex.amount || 0);
          total += amount;
          tbody.innerHTML += `
            <tr class="transition hover:bg-slate-900/45">
              <td class="px-5 py-4">${ex.category || '—'}</td>
              <td class="px-5 py-4 text-slate-300">${ex.description || '—'}</td>
              <td class="px-5 py-4 text-rose-200">${formatCurrency(amount)}</td>
              <td class="px-5 py-4">${ex.date || '—'}</td>
            </tr>
          `;
        });

        tfoot.innerHTML = `
          <tr class="text-sm font-semibold text-slate-200">
            <td colspan="2" class="px-5 py-4 uppercase tracking-widest text-slate-300">Total Expenses</td>
            <td class="px-5 py-4 text-rose-200">${formatCurrency(total)}</td>
            <td class="px-5 py-4 text-right text-slate-500">—</td>
          </tr>
        `;
      }).catch(err => {
        console.error('Expenses load error:', err);
      });
    }

    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const category = document.getElementById('expenseCategory').value;
      const description = document.getElementById('expenseDescription').value;
      const amount = parseInt(document.getElementById('expenseAmount').value, 10);
      if (!category || !description || !amount) {
        return Swal.fire('Error', 'Fill all fields', 'error');
      }
      try {
        await db.ref(`/schools/Socrates School Preform one/${currentYear}/expenses`).push({ category, description, amount, date: new Date().toISOString().split('T')[0] });
        Swal.fire('Success', 'Expense added', 'success');
        document.getElementById('expenseForm').reset();
        loadFinance();
        loadExpenses();
      } catch (err) {
        Swal.fire('Error', 'Failed to add expense: ' + err.message, 'error');
      }
    });

    function toggleDebtors() {
      showingDebtors = !showingDebtors;
      document.getElementById('debtorsToggleLabel').textContent = showingDebtors ? 'Show All Learners' : 'Show Debtors';
      renderTable();
    }

    function exportMainCSV() {
      const data = financeData
        .filter(row => !(showingDebtors && row.bal <= 0))
        .map(row => ({
          ADM: row.adm,
          Name: row.name,
          Contact: row.contact,
          TotalFee: row.totalFee,
          Plan: row.plan,
          Paid: row.paid,
          Balance: row.bal,
          DebtTill: row.rawDebtInfo.debtLabel,
          Status: row.status
        }));
      const csv = Papa.unparse(data);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'preform_finance.csv';
      a.click();
    }

    function exportMainPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');
      doc.setFontSize(12);
      doc.text('Preform One Finance Register', 14, 14);
      doc.autoTable({
        startY: 18,
        head: [['ADM No', 'Full Name', 'Parent Contact', 'Total Fee', 'Plan', 'Paid', 'Balance', 'Debt Till', 'Status']],
        body: financeData
          .filter(row => !(showingDebtors && row.bal <= 0))
          .map(row => [
            row.adm,
            row.name,
            row.contact,
            formatCurrency(row.totalFee),
            row.plan,
            formatCurrency(row.paid),
            formatCurrency(row.bal),
            row.rawDebtInfo.debtLabel,
            row.status.toUpperCase()
          ]),
        styles: { fontSize: 8 },
        headStyles: { fillColor: [15, 23, 42] }
      });
      doc.save('preform_finance.pdf');
    }

    function exportDebtorsCSV() {
      const debtors = financeData.filter(row => row.bal > 0);
      const csv = Papa.unparse(debtors.map(row => ({
        ADM: row.adm,
        Name: row.name,
        Contact: row.contact,
        Balance: row.bal,
        DebtTill: row.rawDebtInfo.debtLabel
      })));
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'preform_debtors.csv';
      a.click();
    }

    function exportDebtorsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');
      doc.setFontSize(12);
      doc.text('Preform One Debtors List', 14, 14);
      doc.autoTable({
        startY: 18,
        head: [['ADM No', 'Full Name', 'Parent Contact', 'Balance', 'Debt Till']],
        body: financeData
          .filter(row => row.bal > 0)
          .map(row => [
            row.adm,
            row.name,
            row.contact,
            formatCurrency(row.bal),
            row.rawDebtInfo.debtLabel
          ]),
        styles: { fontSize: 8 },
        headStyles: { fillColor: [88, 28, 135] }
      });
      doc.save('preform_debtors.pdf');
    }

    function exportExpenseCSV() {
      const data = [];
      document.getElementById('expenseBody').querySelectorAll('tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td')).map(td => td.textContent);
        if (cells.length) data.push(cells);
      });
      if (!data.length) {
        return Swal.fire('Info', 'No expenses to export yet.', 'info');
      }
      const csv = Papa.unparse([['Category', 'Description', 'Amount', 'Date'], ...data]);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'preform_expenses.csv';
      a.click();
    }

    function exportExpensePDF() {
      const rows = [];
      document.getElementById('expenseBody').querySelectorAll('tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td')).map(td => td.textContent);
        if (cells.length) rows.push(cells);
      });
      if (!rows.length) {
        return Swal.fire('Info', 'No expenses to export yet.', 'info');
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(12);
      doc.text('Preform One Expense Register', 14, 14);
      doc.autoTable({
        startY: 18,
        head: [['Category', 'Description', 'Amount', 'Date']],
        body: rows,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [15, 23, 42] }
      });
      doc.save('preform_expenses.pdf');
    }

    loadFinance();
    loadExpenses();
  </script>
</body>
</html>
