<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Driver Maintenance Request</title>
    <link rel="stylesheet" href="../../css/transport.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <div id="contextBar" class="bar"></div>
    <main style="padding:1.5rem; max-width:720px; margin:0 auto;">
      <section class="card">
        <h2>Maintenance request</h2>
        <p class="muted">Ripoti sehemu iliyoharibika kabisa na gharama inayokadiriwa.</p>
        <form id="maintForm" class="grid two">
          <div>
            <label>Vehicle</label>
            <input id="vehicleInput" readonly />
          </div>
          <div>
            <label>Part / Issue</label>
            <input id="partInput" required />
          </div>
          <div>
            <label>Estimated cost (TZS)</label>
            <input id="costInput" type="number" required />
          </div>
          <div>
            <label>Odometer</label>
            <input id="odoInput" type="number" />
          </div>
          <div style="grid-column: span 2;">
            <label>Notes</label>
            <textarea id="notesInput" rows="3"></textarea>
          </div>
          <div style="grid-column: span 2;">
            <label>Photo (optional)</label>
            <input id="photoInput" type="file" accept="image/*" capture="environment" />
          </div>
          <div style="grid-column: span 2; text-align:right;">
            <button class="btn" type="submit">Submit request</button>
          </div>
        </form>
        <div id="formError" class="alert red hidden"></div>
      </section>
    </main>
    <div id="toast" class="toast hidden"></div>

    <script src="../../modules/transport_helpers.js"></script>
    <script src="../../modules/transport_context.js"></script>
    <script>
      const toast = document.getElementById("toast");
      const formError = document.getElementById("formError");

      const refs = {
        form: document.getElementById("maintForm"),
        vehicle: document.getElementById("vehicleInput"),
        part: document.getElementById("partInput"),
        cost: document.getElementById("costInput"),
        odo: document.getElementById("odoInput"),
        notes: document.getElementById("notesInput"),
        photo: document.getElementById("photoInput"),
      };

      const state = {
        user: null,
        profile: null,
        vehicleId: null,
        context: TransportContext.getContext(),
      };

      function showToast(message) {
        toast.textContent = message;
        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), 3200);
      }

      function ensureAuth() {
        firebase.auth().onAuthStateChanged((user) => {
          if (!user) {
            showToast("Sign in first");
            return;
          }
          state.user = user;
          firebase
            .database()
            .ref(`users/${user.uid}`)
            .once("value")
            .then((snapshot) => {
              const profile = snapshot.val() || {};
              if (profile.role !== "driver") {
                showToast("Driver role required", "bad");
                refs.form.classList.add("hidden");
                return;
              }
              state.profile = profile;
              resolveVehicle();
            });
        });
      }

      async function resolveVehicle() {
        const path = TransportHelpers.paths.deviceVehicle(state.user.uid);
        const snapshot = await firebase.database().ref(path).get();
        state.vehicleId =
          snapshot.val() ||
          localStorage.getItem("somap_vehicleId") ||
          "";
        if (!state.vehicleId) {
          refs.vehicle.value = "assign via hub";
          showToast("No vehicle assigned. Use driver hub.");
        } else {
          refs.vehicle.value = state.vehicleId;
        }
      }

      async function computeRepeatFlags(partSlug) {
        const path = `${TransportHelpers.paths.maintLedger(
          state.vehicleId
        )}/partsHistory/${partSlug}`;
        const snapshot = await firebase.database().ref(path).get();
        const history = snapshot.val() || [];
        const now = Date.now();
        let repeatPart = false;
        history.forEach((entry) => {
          const age = now - Number(entry.ts || 0);
          if (age <= 30 * 24 * 60 * 60 * 1000) {
            repeatPart = true;
          }
        });
        const times90 = history.filter(
          (entry) => now - Number(entry.ts || 0) <= 90 * 24 * 60 * 60 * 1000
        ).length;
        if (times90 >= 2) repeatPart = true;
        return repeatPart;
      }

      async function uploadPhoto(requestId) {
        const file = refs.photo.files[0];
        if (!file) return null;
        const ref = firebase
          .storage()
          .ref(`maintenance/${state.vehicleId}/${requestId}-${file.name}`);
        await ref.put(file);
        return ref.getDownloadURL();
      }

      refs.form.addEventListener("submit", async (event) => {
        event.preventDefault();
        formError.classList.add("hidden");
        if (!state.vehicleId) {
          formError.textContent = "Vehicle missing.";
          formError.classList.remove("hidden");
          return;
        }
        const partName = refs.part.value.trim();
        if (!partName) {
          formError.textContent = "Part is required.";
          formError.classList.remove("hidden");
          return;
        }
        try {
          const partSlug = TransportHelpers.slug(partName);
          const repeatPart = await computeRepeatFlags(partSlug);
          const highCost = Number(refs.cost.value || 0) > 250000;
          const requestRef = firebase.database().ref("maintenance_requests").push();
          const requestId = requestRef.key;
          const payload = {
            vehicleId: state.vehicleId,
            driverUid: state.user.uid,
            driverName: state.profile?.name || "",
            part: partName,
            estCost: Number(refs.cost.value || 0),
            odoKm: Number(refs.odo.value || 0),
            notes: refs.notes.value.trim(),
            repeatPart,
            highCost,
            status: "PENDING",
            createdAt: Date.now(),
            school: state.profile?.school || state.context.school,
            year: state.context.year,
            month: state.context.month,
          };
          const photoUrl = await uploadPhoto(requestId);
          if (photoUrl) payload.photoUrl = photoUrl;
          await requestRef.set(payload);
          showToast("Maintenance request sent");
          refs.form.reset();
          resolveVehicle();
        } catch (err) {
          console.error(err);
          formError.textContent = "Failed to submit maintenance.";
          formError.classList.remove("hidden");
        }
      });

      TransportContext.attachContextSelectors(
        document.getElementById("contextBar"),
        (ctx) => (state.context = ctx)
      );
      ensureAuth();
    </script>
  </body>
</html>
