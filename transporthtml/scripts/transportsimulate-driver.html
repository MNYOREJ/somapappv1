<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transport Driver Simulator</title>
    <link rel="stylesheet" href="../css/transport.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <main style="padding:1.5rem; max-width:640px; margin:0 auto;">
      <section class="card">
        <h2>Driver GPS Simulator</h2>
        <p class="muted">
          Use this when demonstrating transport tracking without a driver phone.
        </p>
        <label for="vehicleInput">Vehicle ID</label>
        <input id="vehicleInput" value="mzee_yasin" />
        <label class="mt-1" for="speedInput">Update every (seconds)</label>
        <input id="speedInput" type="number" value="8" />
        <div class="flex mt-2">
          <button class="btn" id="startBtn" type="button">Start simulation</button>
          <button class="btn secondary" id="stopBtn" type="button">Stop</button>
        </div>
        <div id="status" class="mt-2 muted"></div>
      </section>
    </main>

    <script src="../modules/transport_helpers.js"></script>
    <script>
      const pathCoordinates = [
        [-3.3651, 36.6804],
        [-3.3681, 36.6815],
        [-3.3733, 36.6859],
        [-3.3778, 36.6882],
        [-3.3824, 36.6906],
        [-3.3864, 36.6948],
        [-3.3909, 36.7001],
        [-3.3945, 36.7055],
        [-3.3988, 36.7089],
        [-3.4036, 36.7132],
      ];

      let timer = null;
      let index = 0;

      function writeLocation(vehicleId, coords) {
        return firebase
          .database()
          .ref(TransportHelpers.paths.busLatest(vehicleId))
          .set({
            lat: coords[0],
            lng: coords[1],
            speed: 12,
            heading: 90,
            accuracy: 10,
            ts: Date.now(),
            status: "online",
          });
      }

      function startSimulation() {
        const vehicleId = document.getElementById("vehicleInput").value.trim();
        const seconds = Number(document.getElementById("speedInput").value || 10);
        if (!vehicleId) {
          alert("Provide vehicle id");
          return;
        }
        if (timer) clearInterval(timer);
        index = 0;
        writeLocation(vehicleId, pathCoordinates[index]);
        document.getElementById("status").textContent = "Simulation runningâ€¦";
        timer = setInterval(() => {
          index = (index + 1) % pathCoordinates.length;
          writeLocation(vehicleId, pathCoordinates[index]);
        }, seconds * 1000);
      }

      function stopSimulation() {
        if (timer) clearInterval(timer);
        timer = null;
        document.getElementById("status").textContent = "Simulation stopped.";
      }

      document.getElementById("startBtn").addEventListener("click", startSimulation);
      document.getElementById("stopBtn").addEventListener("click", stopSimulation);
    </script>
  </body>
</html>
