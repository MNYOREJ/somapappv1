<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SoMAp Transport Hub ¬∑ Dashboard</title>
    <link rel="stylesheet" href="./css/transport_dark.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="../Todashboardhtml/yearContext.js"></script>
    <script>
      /** Year range + anchor **/
      const SOMAP_ALLOWED_YEARS = Array.from({ length: 20 }, (_, i) => 2023 + i); // 2023..2042
      const SOMAP_DEFAULT_YEAR = 2025;

      /** Tanzania class ladder (no Class 8). Keep labels EXACTLY. */
      const CLASS_ORDER = ['Baby Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
      const L = s => String(s || '').trim().toLowerCase();

      /** Shift a base class by delta years relative to anchor (2025). */
      function shiftClass(baseClass, deltaYears){
        const i = CLASS_ORDER.findIndex(c => L(c) === L(baseClass));
        if (i < 0) return baseClass || '';
        const j = i + Number(deltaYears || 0);
        if (j < 0) return 'PRE-ADMISSION';
        if (j >= CLASS_ORDER.length) return 'GRADUATED';
        return CLASS_ORDER[j];
      }
    </script>
    <script>
      /** Reuse shared year context if present, else create a light fallback. */
      window.somapYearContext = window.somapYearContext || (function(){
        let selected = (sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR) + '';
        const listeners = new Set();
        return {
          getSelectedYear(){ return selected; },
          setSelectedYear(y){
            y = String(y);
            if (selected === y) return;
            selected = y;
            try{ sessionStorage.setItem('somap_selected_year', y); }catch{}
            listeners.forEach(fn => { try{ fn(y); }catch{} });
          },
          onYearChanged(fn){ if (typeof fn === 'function') listeners.add(fn); }
        };
      })();
    </script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
    </script>
  </head>
  <body>
    <!-- Context Bar with Year Selection and Date Display -->
    <div id="contextBar" class="bar">
      <div>
        <h1>üöå SoMAp Transport Hub</h1>
        <small>Advanced Transport Management System</small>
      </div>
      <div class="context-selectors">
        <div class="date-time-display">
          <span class="label">Today</span>
          <span class="value" id="currentDate">‚Äî</span>
        </div>
        <div>
          <label style="margin-bottom: 0.25rem; font-size: 0.75rem;">Academic Year</label>
          <select id="yearSelect" data-somap-year-select data-somap-year-min="2023" style="min-width: 100px; padding: 0.5rem;">
          </select>
        </div>
      </div>
    </div>

    <main>
      <!-- KPI Cards Row -->
      <section class="row" id="kpiRow">
        <article class="card stat-card">
          <div class="stat-label">Loading...</div>
          <div class="stat-value">‚è≥</div>
          <div class="stat-label" style="font-size: 0.75rem; margin-top: 0.5rem;">Please wait</div>
        </article>
      </section>

      <!-- Management Cards Row -->
      <section class="row" id="startCards">
        <article class="card">
          <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
            <p>Loading Transport Hub...</p>
          </div>
        </article>
      </section>

      <!-- Alerts Section -->
      <section class="mt-3" id="alerts"></section>
    </main>

    <!-- Students on Transport Modal -->
    <div id="studentsModal" class="modal hidden">
      <div class="modal-content" style="max-width: 1400px;">
        <div class="flex space center mb-2">
          <h2 style="margin: 0;">Students on Transport Registry</h2>
          <button class="btn secondary" id="closeStudentsModal">Close</button>
        </div>
        
        <div class="filter-bar">
          <select id="classFilterModal">
            <option value="">All Classes</option>
            <option>Baby Class</option>
            <option>Middle Class</option>
            <option>Pre Unit Class</option>
            <option>Class 1</option>
            <option>Class 2</option>
            <option>Class 3</option>
            <option>Class 4</option>
            <option>Class 5</option>
            <option>Class 6</option>
            <option>Class 7</option>
          </select>
          <input id="searchStudent" type="text" placeholder="Search student..." style="max-width: 300px;" />
          <button class="btn success" id="exportStudentsCsv">üì• Export CSV</button>
        </div>

        <div style="overflow-x: auto; margin-top: 1.5rem;">
          <table class="table" id="studentsTransportTable">
            <thead>
              <tr>
                <th>Admission No</th>
                <th>Full Name</th>
                <th>Class</th>
                <th>Date Registered</th>
                <th>Parent Contact</th>
                <th>Fee Total</th>
                <th>Paid Amount</th>
                <th>Debt</th>
                <th>Debt Till</th>
                <th>Transport Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="studentsTransportBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
          <div id="emptyStudents" class="empty hidden">No students found</div>
        </div>
      </div>
    </div>

    <!-- Transport Assignment Modal -->
    <div id="transportAssignModal" class="modal hidden">
      <div class="modal-content">
        <div class="flex space center mb-2">
          <h2 style="margin: 0;">Assign Transport</h2>
          <button class="btn secondary" id="closeTransportAssign">Close</button>
        </div>

        <div id="assignAlert" class="alert hidden"></div>

        <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Student Information</h3>
          <p id="assignStudentInfo" style="margin: 0; color: var(--text-secondary);"></p>
        </div>

        <div class="grid two">
          <div class="card">
            <h3 style="margin-top: 0;">Route Selection</h3>
            <label for="assignRouteSelect">Select Route/Drop Point</label>
            <select id="assignRouteSelect" required>
              <option value="">-- Select Route --</option>
            </select>
          </div>

          <div class="card">
            <h3 style="margin-top: 0;">Time Period</h3>
            <label for="assignPeriod">When will student use transport?</label>
            <select id="assignPeriod" required>
              <option value="">-- Select Period --</option>
              <option value="morning">Morning Only (Asubuhi)</option>
              <option value="evening">Evening Only (Jioni)</option>
              <option value="both">Morning & Evening (Both)</option>
            </select>
          </div>
        </div>

        <div class="grid two mt-2" id="dropOffSection" style="display: none;">
          <div class="card" id="morningDropSection" style="display: none;">
            <h3 style="margin-top: 0;">Morning Drop-off Point</h3>
            <label for="assignMorningDrop">Where to drop in the morning?</label>
            <select id="assignMorningDrop">
              <!-- Same options as route select -->
            </select>
          </div>

          <div class="card" id="eveningDropSection" style="display: none;">
            <h3 style="margin-top: 0;">Evening Drop-off Point</h3>
            <label for="assignEveningDrop">Where to drop in the evening?</label>
            <select id="assignEveningDrop">
              <!-- Same options as route select -->
            </select>
          </div>
        </div>

        <div class="card mt-2" id="startDateSection" style="display: none;">
          <h3 style="margin-top: 0;">Start Date</h3>
          <label for="transportStartDate">Start Date (first day student uses transport) *</label>
          <input type="date" id="transportStartDate" required />
        </div>

        <div class="card mt-2" id="farePreview" style="display: none;">
          <h3 style="margin-top: 0;">Monthly Fee Preview</h3>
          <div id="fareBreakdown" style="font-size: 0.875rem; line-height: 1.8;"></div>
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: 600; font-size: 1.125rem;">Total Monthly Fee:</span>
              <span id="totalFareDisplay" style="font-weight: 800; font-size: 1.5rem; color: var(--accent-success);"></span>
            </div>
            <div id="startMonthDueWrap" style="margin-top: .5rem; display:none;">
              <div style="display:flex; justify-content: space-between; align-items:center;">
                <span style="font-size:.9rem;">Start month due (prorated):</span>
                <span id="startMonthDueDisplay" style="font-weight:700;"></span>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-2" id="vehicleAssignSection" style="display: none;">
          <h3 style="margin-top: 0;">üöê Vehicle & Driver Assignment</h3>
          <div id="vehicleInfo" style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
            <p style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-secondary);">
              Vehicle and driver are automatically assigned based on the selected route(s).
            </p>
            <div id="autoAssignInfo"></div>
          </div>
        </div>

        <div class="flex mt-2" style="justify-content: flex-end; gap: 1rem;">
          <button class="btn secondary" id="cancelAssign">Cancel</button>
          <button class="btn success" id="saveTransportAssign">üíæ Save Assignment</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script src="./modules/transport_roles.js"></script>
    <script src="./modules/transport_context.js"></script>
    <script src="./modules/transport_helpers.js"></script>
    <script src="./modules/transport_pricing.js"></script>
    <script>
      // Global State
      const state = {
        user: null,
        role: null,
        year: (() => {
            const rawYear = window.somapYearContext?.getSelectedYear?.();
            const parsed = parseInt(rawYear, 10);
            return Number.isFinite(parsed) ? parsed : new Date().getFullYear();
          })(),
        month: new Date().getMonth() + 1,
        school: (typeof TransportContext !== 'undefined' && TransportContext.getContext) ? TransportContext.getContext().school : "socrates",
        students: {},
        vehicles: {},
        transportEnrollments: {},
        transportPayments: {},
        financeData: {},
        currentAssignStudentId: null,
        drivers: [],
        routeVehicleValidation: {}, // Track which routes have vehicles assigned
        stops: [],
        stopMap: {},
        stopNameMap: {},
        monthMultipliers: (typeof TransportPricing !== 'undefined' && TransportPricing.DEFAULT_MULTIPLIERS) ? { ...TransportPricing.DEFAULT_MULTIPLIERS } : {},
      };
      
      // Verify required modules
      console.log('üì¶ Module check:', {
        TransportContext: typeof TransportContext !== 'undefined',
        TransportPricing: typeof TransportPricing !== 'undefined',
        TransportRoles: typeof TransportRoles !== 'undefined',
        TransportHelpers: typeof TransportHelpers !== 'undefined',
        Firebase: typeof firebase !== 'undefined'
      });

      const toast = document.getElementById("toast");
      const startCardsEl = document.getElementById("startCards");
      const kpiRowEl = document.getElementById("kpiRow");
      const alertsEl = document.getElementById("alerts");
      const yearSelect = document.getElementById("yearSelect");
      const currentDateEl = document.getElementById("currentDate");
      const MONTH_NAMES = ["January","February","March","April","May","June","July","August","September","October","November","December"];

      // Modal elements
      const studentsModal = document.getElementById("studentsModal");
      const closeStudentsModal = document.getElementById("closeStudentsModal");
      const studentsTransportBody = document.getElementById("studentsTransportBody");
      const classFilterModal = document.getElementById("classFilterModal");
      const searchStudent = document.getElementById("searchStudent");

      const transportAssignModal = document.getElementById("transportAssignModal");
      const closeTransportAssign = document.getElementById("closeTransportAssign");
      const assignRouteSelect = document.getElementById("assignRouteSelect");
      const assignPeriod = document.getElementById("assignPeriod");
      const assignMorningDrop = document.getElementById("assignMorningDrop");
      const assignEveningDrop = document.getElementById("assignEveningDrop");
      const saveTransportAssign = document.getElementById("saveTransportAssign");

      // Utility Functions
      function showToast(message, tone = "ok") {
        toast.textContent = message;
        toast.classList.remove("hidden");
        toast.style.background = tone === "bad" ? "#ef4444" : "#1f2937";
        setTimeout(() => toast.classList.add("hidden"), 3500);
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-TZ', { style: 'currency', currency: 'TZS' }).format(amount || 0);
      }

      function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-GB');
      }

      function normalizeStopKey(value) {
        return String(value || '').trim().toLowerCase();
      }

      function setStopCatalog(stops) {
        state.stops = Array.isArray(stops) ? stops.slice().sort((a, b) => a.name.localeCompare(b.name)) : [];
        
        if (typeof TransportPricing !== 'undefined' && TransportPricing.indexStopsById) {
          state.stopMap = TransportPricing.indexStopsById(state.stops);
        } else {
          // Fallback: create index manually
          state.stopMap = {};
          state.stops.forEach(stop => { state.stopMap[stop.id] = stop; });
        }
        
        state.stopNameMap = {};
        state.stops.forEach(stop => {
          state.stopNameMap[normalizeStopKey(stop.name)] = stop;
        });
        populateStopSelects();
      }

      function getStopRecord(value) {
        if (!value) return null;
        const id = String(value);
        return state.stopMap[id] || state.stopNameMap[normalizeStopKey(value)];
      }

      function getStopName(value) {
        const rec = getStopRecord(value);
        return rec ? rec.name : (value || '');
      }

      function getStopBaseFee(value) {
        const rec = getStopRecord(value);
        return rec ? Number(rec.baseFee) || 0 : 0;
      }

      function computeBaseMonthlyFee(morningId, eveningId) {
        return getStopBaseFee(morningId) + getStopBaseFee(eveningId);
      }

      function populateStopSelects() {
        const selects = [assignRouteSelect, assignMorningDrop, assignEveningDrop];
        const options = ['<option value="">-- Select Route --</option>'];
        state.stops.forEach(stop => {
          const label = `${stop.name} - TSh ${Number(stop.baseFee || 0).toLocaleString()}`;
          options.push(`<option value="${stop.id}" data-stop-name="${stop.name}" data-base-fee="${Number(stop.baseFee || 0)}">${label}</option>`);
        });
        const html = options.join('');
        selects.forEach(sel => {
          if (!sel) return;
          sel.innerHTML = html;
        });
      }

      // Update current date display
      function updateDateDisplay() {
        const now = new Date();
        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        currentDateEl.textContent = now.toLocaleDateString('en-US', options);
      }

      // Initialize date display and update every second
      updateDateDisplay();
      setInterval(updateDateDisplay, 1000);

      // Apply URL params for school/year if present (keeps pages in sync)
      (function applyUrlParams(){
        const params = new URLSearchParams(window.location.search);
        const y = parseInt(params.get('year'), 10);
        const sch = params.get('school');
        if (Number.isFinite(y)) state.year = y;
        if (sch) state.school = sch;
      })();

      // Year selection handler
      if (yearSelect && window.somapYearContext) {
        window.somapYearContext.attachYearDropdown(yearSelect);
        const synchronizeYear = (yearValue) => {
          const normalized = parseInt(yearValue, 10);
          if (!Number.isFinite(normalized)) return;
          state.year = normalized;
          if (String(normalized) !== yearSelect.value) {
            yearSelect.value = String(normalized);
          }
          if (state.user) {
            studentsLoaded = false; // Reset students cache on year change
            loadCriticalData();
            loadStopsAndMultipliers(); // Reload stops and multipliers for new year
          }
        };
        synchronizeYear(window.somapYearContext.getSelectedYear());
        window.somapYearContext.onYearChanged((nextYear) => {
          synchronizeYear(nextYear);
        });
        yearSelect.addEventListener('change', (event) => {
          window.somapYearContext.setSelectedYear(event.target.value);
        });
      } else if (yearSelect) {
        yearSelect.value = state.year;
        yearSelect.addEventListener('change', (event) => {
          const normalized = parseInt(event.target.value, 10);
          if (!Number.isFinite(normalized) || normalized === state.year) return;
          state.year = normalized;
          studentsLoaded = false; // Reset students cache on year change
          loadCriticalData();
          loadStopsAndMultipliers(); // Reload stops and multipliers for new year
          // Reload students if modal is open
          if (studentsModal && !studentsModal.classList.contains('hidden')) {
            loadStudentsIfNeeded().then(() => renderStudentsTable());
          }
        });
      }

      // Render KPI Cards
      function renderKpis() {
        console.log('üîÑ Rendering KPIs...');
        const totalStudents = Object.keys(state.students || {}).length;
        const studentsOnTransport = Object.keys(state.transportEnrollments || {}).length;
        const notOnTransport = totalStudents > 0 ? totalStudents - studentsOnTransport : '‚Äî';
        console.log(`üìä KPI Data: ${studentsOnTransport} on transport, ${totalStudents} total students`);

        // Calculate financial KPIs (matching transportpayments.html logic)
        let expectedThisMonth = 0;
        let totalCollected = 0;
        let totalDebt = 0;

        const enrollments = state.transportEnrollments || {};
        const payments = state.transportPayments || {};
        const MONTH_NAMES = ["", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        Object.entries(enrollments).forEach(([studentId, enrollment]) => {
          if (!enrollment) return;
          
          const amStop = enrollment.amStop || '';
          const pmStop = enrollment.pmStop || '';
          
          // Current month expected (with multiplier) - for "Expected This Month" KPI
          try {
            const currentMonthExpected = TransportPricing.expectedForMonth(amStop, pmStop, state.month);
            expectedThisMonth += currentMonthExpected;
          } catch (err) {
            console.warn(`Failed to calculate expected for student ${studentId}:`, err);
          }

          // Calculate total expected and total paid across ALL months (like transportpayments.html)
          let totalExpected = 0;
          let totalPaid = 0;
          
          const studentPayments = payments[studentId] || {};
          const paymentsArray = Array.isArray(studentPayments) ? studentPayments : Object.values(studentPayments || {});
          
          for (let month = 1; month <= 12; month++) {
            try {
              const monthlyExpected = TransportPricing.expectedForMonth(amStop, pmStop, month);
              totalExpected += monthlyExpected;
            } catch (err) {
              console.warn(`Failed to calculate expected for month ${month}:`, err);
            }
            
            // Handle both number and month name formats for payments
            const monthPayments = paymentsArray.filter(p => {
              if (!p || !p.month) return false;
              if (typeof p.month === 'number') return p.month === month;
              if (typeof p.month === 'string') return MONTH_NAMES[month] === p.month;
              return false;
            });
            
            const monthPaid = monthPayments.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
            totalPaid += monthPaid;
          }
          
          totalCollected += totalPaid;
          totalDebt += Math.max(0, totalExpected - totalPaid);
        });

        const cards = [
          {
            id: "students-transport",
            label: "Students on Transport",
            value: studentsOnTransport,
            description: `${totalStudents} total students`,
            color: "primary",
            clickable: true,
          },
          {
            id: "not-transport",
            label: "Not Using Transport",
            value: notOnTransport,
            description: totalStudents > 0 ? "Available for enrollment" : "Loading...",
            color: "info",
          },
          {
            id: "expected-month",
            label: `Expected ${getMonthName(state.month)} ${state.year}`,
            value: formatCurrency(expectedThisMonth),
            description: "Monthly target",
            color: "success",
          },
          {
            id: "paid-month",
            label: "Total Collected",
            value: formatCurrency(totalCollected),
            description: "All transport payments",
            color: "success",
          },
          {
            id: "debt-month",
            label: "Total Transport Debt",
            value: formatCurrency(totalDebt),
            description: "Unpaid amounts",
            color: "danger",
          },
        ];

        kpiRowEl.innerHTML = cards
          .map(
            (card) => `
            <article class="card stat-card ${card.clickable ? 'clickable' : '}" ${card.clickable ? `onclick="openStudentsModal()"` : '} style="cursor: ${card.clickable ? 'pointer' : 'default'};">
              <div class="stat-label">${card.label}</div>
              <div class="stat-value">${card.value}</div>
              <div class="stat-label" style="font-size: 0.75rem; margin-top: 0.5rem;">${card.description}</div>
            </article>
          `
          )
          .join("");
        console.log('‚úÖ KPIs rendered successfully');
      }

      function getMonthName(monthIndex) {
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        return months[monthIndex - 1] || "";
      }

      // Render Management Cards
      function renderStartCards() {
        const cards = [
          {
            title: "Payments Queue",
            description: "Approve transport fee claims and ledgers",
            href: "transportpayments.html",
            icon: "üí∞",
          },
          {
            title: "Vehicle Registry",
            description: "Fleet, owners, insurance expiries",
            href: "transportbuses.html",
            icon: "üöê",
          },
          {
            title: "Routes & Stops",
            description: "Manage routes, stops, and schedules",
            href: "transportroutes.html",
            icon: "üó∫Ô∏è",
          },
          {
            title: "Fuel Requests",
            description: "Review, approve & flag fuel usage",
            href: "transportfuel.html",
            icon: "‚õΩ",
          },
          {
            title: "Maintenance Desk",
            description: "Repairs, parts history and approvals",
            href: "transportmaintenance.html",
            icon: "üîß",
          },
          {
            title: "Boarding Gate",
            description: "No Pay ¬∑ No Board control centre",
            href: "transportattendance.html",
            icon: "üö™",
          },
          {
            title: "Reports & Exports",
            description: "Monthly KPIs and CSV/PDF exports",
            href: "transportreports.html",
            icon: "üìä",
          },
          {
            title: "Operations & Toggles",
            description: "Windows, active days, km-per-litre controls",
            href: "transportops.html",
            icon: "‚öôÔ∏è",
          },
        ];

        startCardsEl.innerHTML = cards
          .map(
            (card) => `
            <article class="card">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">${card.icon}</div>
              <h2>${card.title}</h2>
              <p class="muted">${card.description}</p>
              <a class="btn mt-2" href="${card.href}?school=${state.school}&year=${state.year}" style="display: block;">
                Open ‚Üí
              </a>
            </article>
          `
          )
          .join("");
      }

      // Open Students on Transport Modal
      async function openStudentsModal() {
        studentsModal.classList.remove("hidden");
        // Show loading state
        studentsTransportBody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 2rem;">Loading students...</td></tr>';
        
        // Load students data if not already loaded
        await loadStudentsIfNeeded();
        renderStudentsTable();
      }

      closeStudentsModal.addEventListener("click", () => {
        studentsModal.classList.add("hidden");
      });

      // Render Students Table
      function renderStudentsTable() {
        const filterClass = classFilterModal.value;
        const searchTerm = searchStudent.value.toLowerCase();

        const filtered = Object.entries(state.students).filter(([id, student]) => {
          const matchesClass = !filterClass || student.classLevel === filterClass;
          const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.toLowerCase();
          const matchesSearch = !searchTerm || 
            fullName.includes(searchTerm) || 
            (student.admissionNumber || '').toLowerCase().includes(searchTerm);
          return matchesClass && matchesSearch;
        });

        if (filtered.length === 0) {
          studentsTransportBody.innerHTML = '';
          document.getElementById('emptyStudents').classList.remove('hidden');
          return;
        }

        document.getElementById('emptyStudents').classList.add('hidden');

        studentsTransportBody.innerHTML = filtered
          .map(([id, student]) => {
            const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();
            const enrollment = state.transportEnrollments[id];
            const isUsingTransport = !!enrollment;

            // Get finance data
            const financeData = state.financeData[id] || {};
            const feeTotal = financeData.feePerYear || 0;
            const payments = financeData.payments || {};
            const paidAmount = Object.values(payments).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
            const debt = Math.max(0, feeTotal - paidAmount);
            const debtTill = financeData.debtTill || '‚Äî';

            const statusBadge = isUsingTransport 
              ? '<span class="chip ok">Using</span>'
              : '<span class="chip warn">Not Using</span>';

            const actionBtn = isUsingTransport
              ? `<button class="btn secondary" onclick="editTransportAssignment('${id}')">Edit</button>`
              : `<button class="btn success" onclick="assignTransport('${id}')">Assign Transport</button>`;

            return `
              <tr>
                <td>${student.admissionNumber || 'N/A'}</td>
                <td>${fullName}</td>
                <td>${student.classLevel || 'N/A'}</td>
                <td>${formatDate(student.timestamp || student.createdAt)}</td>
                <td>${student.primaryParentContact || 'N/A'}</td>
                <td>${formatCurrency(feeTotal)}</td>
                <td>${formatCurrency(paidAmount)}</td>
                <td style="color: ${debt > 0 ? 'var(--accent-danger)' : 'var(--accent-success)'};">${formatCurrency(debt)}</td>
                <td>${debtTill}</td>
                <td>${statusBadge}</td>
                <td class="table-actions">${actionBtn}</td>
              </tr>
            `;
          })
          .join("");
      }

      // Debounce search for better performance
      let searchTimeout = null;
      classFilterModal.addEventListener('change', renderStudentsTable);
      searchStudent.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => renderStudentsTable(), 300); // Wait 300ms after typing stops
      });

      // Assign Transport Function
      async function assignTransport(studentId) {
        state.currentAssignStudentId = studentId;
        
        // Ensure students are loaded
        await loadStudentsIfNeeded();
        
        const student = state.students[studentId];
        if (!student) {
          showToast('Student not found', 'bad');
          return;
        }

        const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();
        document.getElementById('assignStudentInfo').textContent = 
          `${fullName} - ${student.admissionNumber} - ${student.classLevel}`;

        // Copy route options to drop-off selects
        const routeOptions = assignRouteSelect.innerHTML;
        assignMorningDrop.innerHTML = routeOptions;
        assignEveningDrop.innerHTML = routeOptions;

        // Reset form
        assignRouteSelect.value = '';
        assignPeriod.value = '';
        assignMorningDrop.value = '';
        assignEveningDrop.value = '';
        document.getElementById('dropOffSection').style.display = 'none';
        document.getElementById('farePreview').style.display = 'none';
        document.getElementById('vehicleAssignSection').style.display = 'none';
        state.routeVehicleValidation = {};

        // Reset save button
        const saveBtn = document.getElementById('saveTransportAssign');
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.style.opacity = '0.6';
          saveBtn.style.cursor = 'not-allowed';
          saveBtn.title = 'Please complete all required fields';
        }

        transportAssignModal.classList.remove('hidden');
      }

      async function editTransportAssignment(studentId) {
        await assignTransport(studentId);
        const enrollment = state.transportEnrollments[studentId];
        if (enrollment) {
          assignRouteSelect.value = enrollment.route || '';
          assignPeriod.value = enrollment.period || '';
          if (enrollment.amStop) assignMorningDrop.value = enrollment.amStop;
          if (enrollment.pmStop) assignEveningDrop.value = enrollment.pmStop;
          calculateFare();
          updateSaveButtonState();
        }
      }

      // Period change handler
      assignPeriod.addEventListener('change', () => {
        const period = assignPeriod.value;
        const dropSection = document.getElementById('dropOffSection');
        const morningSection = document.getElementById('morningDropSection');
        const eveningSection = document.getElementById('eveningDropSection');

        if (period === 'morning') {
          dropSection.style.display = 'grid';
          morningSection.style.display = 'block';
          eveningSection.style.display = 'none';
          assignEveningDrop.value = '';
        } else if (period === 'evening') {
          dropSection.style.display = 'grid';
          morningSection.style.display = 'none';
          eveningSection.style.display = 'block';
          assignMorningDrop.value = '';
        } else if (period === 'both') {
          dropSection.style.display = 'grid';
          morningSection.style.display = 'block';
          eveningSection.style.display = 'block';
        } else {
          dropSection.style.display = 'none';
        }

        calculateFare();
        // reveal start date when period/routes selected
        const hasAny = assignMorningDrop.value || assignEveningDrop.value;
        document.getElementById('startDateSection').style.display = hasAny ? 'block' : 'none';
        updateSaveButtonState();
      });

      assignMorningDrop.addEventListener('change', () => {
        calculateFare();
        const hasAny = assignMorningDrop.value || assignEveningDrop.value;
        document.getElementById('startDateSection').style.display = hasAny ? 'block' : 'none';
        updateSaveButtonState();
      });
      assignEveningDrop.addEventListener('change', () => {
        calculateFare();
        const hasAny = assignMorningDrop.value || assignEveningDrop.value;
        document.getElementById('startDateSection').style.display = hasAny ? 'block' : 'none';
        updateSaveButtonState();
      });

      // Recalculate when start date changes (to update proration preview)
      document.getElementById('transportStartDate')?.addEventListener('change', () => {
        calculateFare();
      });

      // Calculate and display fare with vehicle/driver info
            function calculateFare() {
        const period = assignPeriod.value;
        if (!period) {
          document.getElementById('farePreview').style.display = 'none';
          document.getElementById('vehicleAssignSection').style.display = 'none';
          return;
        }

        const morningStopId = assignMorningDrop.value;
        const eveningStopId = assignEveningDrop.value;
        const morningStop = getStopRecord(morningStopId);
        const eveningStop = getStopRecord(eveningStopId);

        const morningPrice = morningStop ? Number(morningStop.baseFee || 0) : 0;
        const eveningPrice = eveningStop ? Number(eveningStop.baseFee || 0) : 0;
        const baseFee = morningPrice + eveningPrice;

        let breakdown = '<div style="display: grid; gap: 0.5rem;">';
        if (morningStop) {
          breakdown += `<div style="display: flex; justify-content: space-between;">
            <span>Morning (${morningStop.name}):</span>
            <span style="font-weight: 600;">${formatCurrency(morningPrice)}</span>
          </div>`;
        }
        if (eveningStop) {
          breakdown += `<div style="display: flex; justify-content: space-between;">
            <span>Evening (${eveningStop.name}):</span>
            <span style="font-weight: 600;">${formatCurrency(eveningPrice)}</span>
          </div>`;
        }

        const multiplierSummary = Object.entries(state.monthMultipliers || {})
          .filter(([m, mult]) => Number(mult) !== 1)
          .sort((a, b) => Number(a[0]) - Number(b[0]))
          .map(([m, mult]) => {
            const label = MONTH_NAMES[Number(m) - 1] || `Month ${m}`;
            const value = Number(mult);
            return `${label}: x${value.toFixed(2).replace(/\.00$/, '')}`;
          })
          .join(', ');

        breakdown += `</div>
          <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
            <p style="margin: 0; font-size: 0.75rem; color: var(--text-muted);">
              Note: This is the base monthly fee. Actual monthly fees vary with the ${state.year} multipliers:
              ${multiplierSummary || 'all months x1.00'}.
            </p>
          </div>`;

        document.getElementById('fareBreakdown').innerHTML = breakdown;
        document.getElementById('totalFareDisplay').textContent = formatCurrency(baseFee);
        document.getElementById('farePreview').style.display = 'block';

        const sd = document.getElementById('transportStartDate')?.value;
        const y = state.year;
        if (sd) {
          const parts = String(sd).split('-');
          const sy = Number(parts[0] || y);
          const sm = Number(parts[1] || 1);
          const due = TransportPricing.dueForMonth({
            year: sy,
            month: sm,
            baseMonthlyFee: baseFee,
            startDate: sd,
            multipliers: state.monthMultipliers
          });
          const wrap = document.getElementById('startMonthDueWrap');
          const disp = document.getElementById('startMonthDueDisplay');
          if (wrap && disp) {
            wrap.style.display = 'block';
            disp.textContent = formatCurrency(Math.round(due));
          }
        } else {
          const wrap = document.getElementById('startMonthDueWrap');
          if (wrap) wrap.style.display = 'none';
        }

        updateVehicleDriverInfo(morningStopId, eveningStopId);
        document.getElementById('vehicleAssignSection').style.display = 'block';
      }

      // Update vehicle and driver information based on selected routes
            function updateVehicleDriverInfo(morningStopId, eveningStopId) {
        const selectedStops = [morningStopId, eveningStopId]
          .filter(Boolean)
          .map(id => {
            const record = getStopRecord(id);
            return {
              id,
              name: record ? record.name : getStopName(id),
              key: normalizeStopKey(record ? record.name : id)
            };
          });

        if (!selectedStops.length) {
          document.getElementById('autoAssignInfo').innerHTML = '<p style="margin: 0; color: var(--text-muted);">No routes selected</p>';
          state.routeVehicleValidation = {};
          updateSaveButtonState();
          return;
        }

        state.routeVehicleValidation = {};
        let vehicleDriverInfo = '<div style="display: grid; gap: 1rem;">';
        let allRoutesHaveVehicles = true;

        selectedStops.forEach(stop => {
          const vehiclesForRoute = Object.values(state.vehicles || {}).filter(v => {
            if (!v) return false;
            const rawAssigned = v.assignedRoutes;
            const assigned = Array.isArray(rawAssigned)
              ? rawAssigned
              : (rawAssigned && typeof rawAssigned === 'object')
                ? Object.values(rawAssigned)
                : [];
            return assigned.some(r => {
              if (!r) return false;
              const val = (typeof r === 'string') ? r : (r.route || r.name || r.id || '');
              return normalizeStopKey(val) === stop.key;
            });
          });

          if (vehiclesForRoute.length > 0) {
            state.routeVehicleValidation[stop.id] = true;

            vehiclesForRoute.forEach(vehicle => {
              const driver = state.drivers.find(d => d.id === vehicle.assignedDriverUid);
              const driverName = driver ? driver.fullName : 'Driver not assigned';
              const driverPhone = driver ? (driver.phone || '') : '';
              vehicleDriverInfo += `
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                  <div style="display: grid; gap: 0.5rem; font-size: 0.875rem;">
                    <div><strong>Route:</strong> ${stop.name}</div>
                    <div><strong>Vehicle:</strong> ${vehicle.plate || 'N/A'}${vehicle.makeModel ? ` (${vehicle.makeModel})` : ''}</div>
                    <div><strong>Driver:</strong> ${driverName}${driverPhone ? ` (${driverPhone})` : ''}</div>
                    <div><strong>Capacity:</strong> ${vehicle.capacity || 'N/A'} seats</div>
                  </div>
                </div>
              `;
            });
          } else {
            state.routeVehicleValidation[stop.id] = false;
            allRoutesHaveVehicles = false;
            vehicleDriverInfo += `
              <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
                <div style="font-size: 0.875rem;">
                  <strong>Route:</strong> ${stop.name}<br/>
                  <span style="color: var(--accent-danger);">No vehicle assigned to this route yet. Please assign a vehicle in Vehicle Registry.</span>
                </div>
              </div>
            `;
          }
        });

        vehicleDriverInfo += '</div>';
        document.getElementById('autoAssignInfo').innerHTML = vehicleDriverInfo;
        updateSaveButtonState(allRoutesHaveVehicles);
      }

      // Update save button state based on vehicle assignment validation
      function updateSaveButtonState(allRoutesHaveVehicles = false) {
        const saveBtn = document.getElementById('saveTransportAssign');
        if (!saveBtn) return;

        const period = assignPeriod.value;
        const morningRoute = assignMorningDrop.value;
        const eveningRoute = assignEveningDrop.value;
        const hasRoutes = morningRoute || eveningRoute;

        // Check if all selected routes have vehicles
        const routes = [morningRoute, eveningRoute].filter(r => r);
        const allValid = routes.length > 0 && routes.every(route => state.routeVehicleValidation[route] === true);

        if (!period || !hasRoutes || !allValid) {
          saveBtn.disabled = true;
          saveBtn.style.opacity = '0.6';
          saveBtn.style.cursor = 'not-allowed';
          if (hasRoutes && !allValid) {
            saveBtn.title = 'Cannot save: No vehicle assigned to one or more selected routes';
          } else {
            saveBtn.title = 'Please complete all required fields';
          }
        } else {
          saveBtn.disabled = false;
          saveBtn.style.opacity = '1';
          saveBtn.style.cursor = 'pointer';
          saveBtn.title = '';
        }
      }

      // Save transport assignment
        saveTransportAssign.addEventListener('click', async () => {
          const studentId = state.currentAssignStudentId;
          const period = assignPeriod.value;
          const morningStopId = assignMorningDrop.value;
          const eveningStopId = assignEveningDrop.value;
          const startDate = (document.getElementById('transportStartDate') || {}).value;
          const morningStop = getStopRecord(morningStopId);
          const eveningStop = getStopRecord(eveningStopId);

          if (!period || (!morningStopId && !eveningStopId)) {
            showToast('Please complete all required fields', 'bad');
            return;
          }

          if (!startDate) {
            showToast('Please select Start Date', 'bad');
            return;
          }

          const selectedStopIds = [morningStopId, eveningStopId].filter(Boolean);
          const missingVehicles = selectedStopIds.filter(id => state.routeVehicleValidation[id] !== true);

          if (missingVehicles.length > 0) {
            const missingNames = missingVehicles.map(id => getStopName(id)).join(', ');
            showToast('Cannot save: No vehicle assigned to route(s): ' + missingNames + '. Please assign vehicles in Vehicle Registry first.', 'bad');
            return;
          }

          try {
            const stopInfos = selectedStopIds.map(id => ({
              id,
              name: getStopName(id),
              key: normalizeStopKey(getStopName(id))
            }));

            const routeVehicleMap = {};
            stopInfos.forEach(stop => {
              const vehiclesForRoute = Object.values(state.vehicles || {}).filter(v => {
                if (!v || !v.assignedRoutes) return false;
                const raw = v.assignedRoutes;
                const list = Array.isArray(raw)
                  ? raw
                  : (typeof raw === 'object' ? Object.values(raw) : []);
                return list.some(r => {
                  if (!r) return false;
                  const val = typeof r === 'string' ? r : (r.route || r.name || r.id || '');
                  return normalizeStopKey(val) === stop.key;
                });
              });

              if (vehiclesForRoute.length > 0) {
                const vehicle = vehiclesForRoute[0];
                const driver = state.drivers.find(d => d.id === vehicle.assignedDriverUid);
                routeVehicleMap[stop.id] = {
                  vehicleId: vehicle.id || null,
                  vehiclePlate: vehicle.plate || '',
                  driverId: vehicle.assignedDriverUid || null,
                  driverName: driver ? driver.fullName : 'Not assigned',
                  driverPhone: driver ? (driver.phone || '') : ''
                };
              }
            });

            const baseMorningFee = morningStop ? Number(morningStop.baseFee || 0) : 0;
            const baseEveningFee = eveningStop ? Number(eveningStop.baseFee || 0) : 0;
            const baseMonthlyFee = baseMorningFee + baseEveningFee;

            const enrollment = {
              studentId,
              school: state.school,
              year: state.year,
              period,
              amStop: morningStop ? morningStop.name : '',
              pmStop: eveningStop ? eveningStop.name : '',
              morningStopId: morningStopId || '',
              eveningStopId: eveningStopId || '',
              route: morningStop ? morningStop.name : (eveningStop ? eveningStop.name : ''),
              morningVehicle: morningStopId ? routeVehicleMap[morningStopId] || null : null,
              eveningVehicle: eveningStopId ? routeVehicleMap[eveningStopId] || null : null,
              updatedAt: Date.now(),
              updatedBy: state.user?.uid || null
            };

            await firebase.database()
              .ref(`transport_enrollments/${studentId}`)
              .set(enrollment);

            const prefix = window.currentSchoolId ? `schools/${window.currentSchoolId}/` : '';
            const assignPayload = {
              status: 'Using',
              period,
              morningStopId: morningStopId || null,
              morningStopName: morningStop ? morningStop.name : '',
              eveningStopId: eveningStopId || null,
              eveningStopName: eveningStop ? eveningStop.name : '',
              baseMorningFee,
              baseEveningFee,
              baseMonthlyFee,
              startDate,
              dateRegistered: Date.now(),
              parentContact: state.students[studentId]?.primaryParentContact || '',
              className: state.students[studentId]?.classLevel || '',
              admissionNo: state.students[studentId]?.admissionNumber || '',
              fullName: `${state.students[studentId]?.firstName || ''} ${state.students[studentId]?.middleName || ''} ${state.students[studentId]?.lastName || ''}`.replace(/\s+/g, ' ').trim()
            };

            await firebase.database()
              .ref(`${prefix}transportAssignments/${state.year}/${studentId}`)
              .set(assignPayload);

            showToast('Transport assignment saved successfully!');
            transportAssignModal.classList.add('hidden');

            state.transportEnrollments[studentId] = {
              ...assignPayload,
              period,
              amStop: morningStop ? morningStop.name : '',
              pmStop: eveningStop ? eveningStop.name : '',
              morningVehicle: morningStopId ? routeVehicleMap[morningStopId] || null : null,
              eveningVehicle: eveningStopId ? routeVehicleMap[eveningStopId] || null : null
            };

            loadCriticalData().then(() => {
              if (studentsModal && !studentsModal.classList.contains('hidden')) {
                renderStudentsTable();
              }
            });

            renderKpis();
          } catch (error) {
            console.error('Error saving assignment:', error);
            showToast('Failed to save assignment', 'bad');
          }
        });

        document.getElementById('cancelAssign').addEventListener('click', () => {
        transportAssignModal.classList.add('hidden');
      });

      // Cache for drivers (rarely changes)
      let driversCache = null;
      let driversCacheTime = 0;
      const DRIVERS_CACHE_TTL = 5 * 60 * 1000; // 5 minutes

      // Load critical data first (for KPIs and UI)
      async function loadCriticalData() {
        try {
          // Show loading state
          kpiRowEl.innerHTML = '<article class="card stat-card"><div class="stat-label">Loading...</div><div class="stat-value">‚è≥</div></article>';
          
          // Load critical data in parallel
          const [enrollSnap, vehiclesSnap] = await Promise.all([
            firebase.database().ref('transport_enrollments').once('value'),
            firebase.database().ref(`transport/${state.school}/${state.year}/buses`).once('value')
          ]);

          state.transportEnrollments = enrollSnap.val() || {};
          
          // Process vehicles
          state.vehicles = {};
          if (vehiclesSnap.exists()) {
            vehiclesSnap.forEach(child => {
              state.vehicles[child.key] = { id: child.key, ...(child.val() || {}) };
            });
          }

          // Load drivers (with caching)
          await loadDriversCached();

          // Load payments in background (needed for KPI calculations)
          // Use same data source as transportpayments.html (transportLedgers)
          const prefix = window.currentSchoolId ? `schools/${window.currentSchoolId}/` : ';
          const year = String(state.year);
          
          Promise.all([
            firebase.database().ref(`${prefix}transportLedgers/${year}`).once('value').catch(() => ({ val: () => null })),
            firebase.database().ref(`${prefix}transport_payments`).once('value').catch(() => ({ val: () => null }))
          ]).then(([ledgersSnap, legacySnap]) => {
            // New format: transportLedgers/{year}/{studentId}/payments
            const paymentsData = {};
            const ledgers = ledgersSnap.val() || {};
            Object.entries(ledgers).forEach(([studentId, ledger]) => {
              if (ledger && ledger.payments) {
                paymentsData[studentId] = Object.values(ledger.payments);
              }
            });
            
            // Also check legacy path for backward compatibility
            const legacyPayments = legacySnap.val() || {};
            Object.entries(legacyPayments).forEach(([studentId, payments]) => {
              if (!paymentsData[studentId]) {
                paymentsData[studentId] = Array.isArray(payments) ? payments : Object.values(payments || {});
              }
            });
            
            state.transportPayments = paymentsData;
            renderKpis(); // Re-render KPIs when payments load
          }).catch(err => {
            console.warn('Failed to load payments:', err);
            state.transportPayments = {};
            renderKpis();
          });

          // Render UI immediately with available data
          renderKpis();
        } catch (error) {
          console.error('Error loading critical data:', error);
          showToast('Error loading data', 'bad');
          kpiRowEl.innerHTML = '<article class="card stat-card"><div class="stat-label">Error</div><div class="stat-value">‚ùå</div></article>';
        }
      }

      // Load drivers with caching
      async function loadDriversCached() {
        const now = Date.now();
        if (driversCache && (now - driversCacheTime) < DRIVERS_CACHE_TTL) {
          state.drivers = driversCache;
          return;
        }

        try {
          const workersSnap = await firebase.database().ref('workers').once('value');
          state.drivers = [];
          if (workersSnap.exists()) {
            workersSnap.forEach(workerSnap => {
              const worker = workerSnap.val();
              if (worker.profile && worker.profile.role === 'driver' && worker.profile.active !== false) {
                state.drivers.push({
                  id: workerSnap.key,
                  fullName: worker.profile.fullNameUpper || `${worker.profile.firstName} ${worker.profile.middleName} ${worker.profile.lastName}`,
                  phone: worker.profile.phone,
                  firstName: worker.profile.firstName,
                  middleName: worker.profile.middleName,
                  lastName: worker.profile.lastName
                });
              }
            });
          }
          driversCache = state.drivers;
          driversCacheTime = now;
        } catch (error) {
          console.warn('Error loading drivers:', error);
          state.drivers = driversCache || [];
        }
      }

      // Lazy load students data (only when needed)
      let studentsLoaded = false;
      async function loadStudentsIfNeeded() {
        if (studentsLoaded && Object.keys(state.students).length > 0) {
          return; // Already loaded
        }

        try {
          const studentsSnap = await firebase.database().ref('students').once('value');
          state.students = studentsSnap.val() || {};
          
          // Process finance data
          state.financeData = {};
          Object.entries(state.students).forEach(([id, student]) => {
            state.financeData[id] = {
              feePerYear: student.feePerYear || 0,
              payments: student.payments || {},
              debtTill: student.debtTill || '‚Äî',
            };
          });
          
          studentsLoaded = true;
          
          // Update KPIs with student count
          renderKpis();
        } catch (error) {
          console.error('Error loading students:', error);
          state.students = {};
          state.financeData = {};
        }
      }

      // Load all data (backward compatibility)
      async function loadAllData() {
        await loadCriticalData();
        await loadStudentsIfNeeded();
        await loadStopsAndMultipliers();
      }

      // Load stops and multipliers for current year
      async function loadStopsAndMultipliers() {
        try {
          if (typeof TransportPricing === 'undefined') {
            console.warn('TransportPricing module not loaded');
            setStopCatalog([]);
            state.monthMultipliers = {};
            return;
          }
          
          const year = Number(state.year || SOMAP_DEFAULT_YEAR);
          
          // Load stops - if none exist, it returns empty array (safe)
          const stops = await TransportPricing.loadStopsForYear(year).catch((err) => {
            console.warn('Failed to load stops:', err);
            return [];
          });
          
          // Load multipliers - if none exist, returns defaults (safe)
          const multipliers = await TransportPricing.loadYearMultipliers(year).catch((err) => {
            console.warn('Failed to load multipliers:', err);
            return TransportPricing.DEFAULT_MULTIPLIERS;
          });
          
          console.log(`‚úÖ Loaded ${stops.length} stops and multipliers for year ${year}`);
          
          setStopCatalog(stops || []);
          state.monthMultipliers = multipliers || { ...TransportPricing.DEFAULT_MULTIPLIERS };
        } catch (error) {
          console.error('‚ùå Error loading stops/multipliers:', error);
          // Fallback to empty/defaults - page should still work
          setStopCatalog([]);
          state.monthMultipliers = (typeof TransportPricing !== 'undefined' && TransportPricing.DEFAULT_MULTIPLIERS) 
            ? { ...TransportPricing.DEFAULT_MULTIPLIERS } 
            : {};
        }
      }

      // Auth and initialization
      function ensureAuth(callback) {
        firebase.auth().onAuthStateChanged((user) => {
          if (!user) {
            alertsEl.innerHTML =
              '<div class="alert red">üîí Sign in to view Transport Hub.</div>';
            return;
          }
          
          state.user = user;
          
          // Check if TransportRoles is available
          if (typeof TransportRoles === 'undefined') {
            console.warn('TransportRoles module not loaded, defaulting to admin access');
            state.role = "admin";
            alertsEl.innerHTML =
              '<div class="alert amber">‚ö†Ô∏è Permission module not loaded. Proceeding with default access.</div>';
            callback();
            return;
          }

          firebase
            .database()
            .ref(`users/${user.uid}/role`)
            .get()
            .then((snapshot) => {
              const roleRaw = snapshot.val();
              state.role = TransportRoles.normalize(roleRaw);
              
              if (!TransportRoles.canViewTransport(state.role)) {
                alertsEl.innerHTML =
                  '<div class="alert warn">‚ö†Ô∏è No transport permissions for this account. Please contact your administrator.</div>';
                return;
              }
              
              alertsEl.innerHTML = "";
              callback();
            })
            .catch((err) => {
              console.error('Error verifying permissions:', err);
              // If we can't verify permissions, default to allowing access but show a warning
              state.role = "admin"; // Default to admin role
              alertsEl.innerHTML =
                '<div class="alert amber">‚ö†Ô∏è Could not verify permissions. Proceeding with default access. If you experience issues, please refresh the page.</div>';
              // Still call callback to allow the page to load
              setTimeout(() => {
                callback();
              }, 500);
            });
        });
      }

      // Initialize
      console.log('üöå Transport Hub: Initializing...');
      
      // Render start cards immediately (no data needed)
      renderStartCards();
      console.log('‚úÖ Management cards rendered');
      
      ensureAuth(() => {
        console.log('‚úÖ Authentication verified');
        // Load critical data (this will render KPIs when ready)
        loadCriticalData().then(() => {
          console.log('‚úÖ Critical data loaded');
        }).catch(err => {
          console.error('‚ùå Critical data load failed:', err);
          renderKpis(); // Render with empty data
        });
        // Load stops and multipliers for the current year
        loadStopsAndMultipliers().then(() => {
          console.log('‚úÖ Stops and multipliers loaded');
        }).catch(err => {
          console.error('‚ùå Stops/multipliers load failed:', err);
        });
        // Preload students in background (they'll load when modal opens anyway)
        setTimeout(() => {
          loadStudentsIfNeeded().then(() => {
            console.log('‚úÖ Students preloaded');
          }).catch(err => {
            console.error('‚ùå Students preload failed:', err);
          });
        }, 1000);
      });
    </script>
  </body>
</html>










