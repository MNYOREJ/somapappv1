<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transport Allocations · Students by route</title>
    <link rel="stylesheet" href="../css/transport.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <div id="contextBar" class="bar"></div>
    <main style="padding:1.5rem; max-width:1200px; margin:0 auto;">
      <section class="card">
        <div class="flex space center">
          <h2 style="margin:0;">Student allocations</h2>
          <input id="searchInput" placeholder="Search name or admission" style="max-width:260px;" />
        </div>
        <table class="table mt-2">
          <thead>
            <tr>
              <th>Student</th>
              <th>Admission</th>
              <th>Vehicle</th>
              <th>AM Stop</th>
              <th>PM Stop</th>
            </tr>
          </thead>
          <tbody id="allocBody"></tbody>
        </table>
        <div id="emptyState" class="empty hidden"></div>
      </section>
    </main>

    <script src="../modules/transport_helpers.js"></script>
    <script src="../modules/transport_context.js"></script>
    <script>
      const allocBody = document.getElementById("allocBody");
      const emptyState = document.getElementById("emptyState");
      const searchInput = document.getElementById("searchInput");
      const state = {
        context: TransportContext.getContext(),
        allocations: [],
        unsubscribe: null,
      };

      function renderAllocations() {
        const query = searchInput.value.toLowerCase();
        const filtered = state.allocations.filter((row) => {
          if (!query) return true;
          return (
            (row.studentName || "").toLowerCase().includes(query) ||
            (row.admission || "").toLowerCase().includes(query)
          );
        });

        if (!filtered.length) {
          emptyState.textContent = `No transport students for ${state.context.year}.`;
          emptyState.classList.remove("hidden");
          allocBody.innerHTML = "";
          return;
        }
        emptyState.classList.add("hidden");
        allocBody.innerHTML = filtered
          .map(
            (row) => `
              <tr>
                <td>${row.studentName || "—"}</td>
                <td>${row.admission || row.studentId || "—"}</td>
                <td>${row.vehicleId || "—"}</td>
                <td>${row.amStop || "—"}</td>
                <td>${row.pmStop || "—"}</td>
              </tr>
            `
          )
          .join("");
      }

      function subscribeAllocations() {
        if (state.unsubscribe) state.unsubscribe();
        const ref = firebase.database().ref("transport_enrollments");
        const listener = ref.on(
          "value",
          (snapshot) => {
            const rows = [];
            snapshot.forEach((child) => {
              const value = child.val() || {};
              if (value.school && value.school !== state.context.school) return;
              if (value.year && Number(value.year) !== Number(state.context.year)) return;
              rows.push({
                id: child.key,
                studentId: value.studentId || child.key,
                admission: value.admission || value.adm || value.studentId || child.key,
                studentName: value.studentName || value.name,
                vehicleId: value.vehicleId || value.busId,
                amStop: value.amStop || value.stop || value.morningStop,
                pmStop: value.pmStop || value.afternoonStop,
              });
            });
            state.allocations = rows;
            renderAllocations();
          },
          (err) => {
            console.error(err);
            emptyState.textContent = "Failed to load allocations.";
            emptyState.classList.remove("hidden");
          }
        );
        state.unsubscribe = () => ref.off("value", listener);
      }

      searchInput.addEventListener("input", renderAllocations);

      TransportContext.attachContextSelectors(
        document.getElementById("contextBar"),
        (ctx) => {
          state.context = ctx;
          renderAllocations();
        }
      );
      subscribeAllocations();
    </script>
  </body>
</html>
