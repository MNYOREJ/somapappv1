<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transport Vehicles · Registry & Insurance</title>
    <link rel="stylesheet" href="./css/transport_dark.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <div id="contextBar" class="bar">
      <div>
        <h1>🚐 Vehicle Registry · Bwalo la Usafiri</h1>
        <small>Comprehensive fleet management and documentation</small>
      </div>
      <div class="context-selectors">
        <div class="date-time-display">
          <span class="label">Today</span>
          <span class="value" id="currentDate">—</span>
        </div>
        <div>
          <label style="margin-bottom: 0.25rem; font-size: 0.75rem;">Academic Year</label>
          <select id="yearSelect" style="min-width: 100px; padding: 0.5rem;">
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
          </select>
        </div>
        <a href="transport.html" class="btn secondary">← Back to Dashboard</a>
      </div>
    </div>

    <main style="padding:1.5rem; max-width:1400px; margin:0 auto;">
      <!-- KPI Cards Row -->
      <section class="row" id="kpiRow">
        <article class="card stat-card">
          <div class="stat-label">Loading...</div>
          <div class="stat-value">⏳</div>
        </article>
      </section>

      <!-- Alerts Section -->
      <section id="alerts" class="mt-2"></section>

      <!-- Header with Add Button -->
      <div class="flex space center mt-3">
        <h2 style="margin:0;">Vehicle Registry</h2>
        <button class="btn success" id="addVehicleBtn" type="button">+ Add Vehicle</button>
      </div>

      <!-- Vehicles Table -->
      <section class="card mt-2">
        <div style="overflow-x: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Plate</th>
                <th>Make & Model</th>
                <th>Owner</th>
                <th>Driver</th>
                <th>Capacity</th>
                <th>Routes</th>
                <th>Insurance</th>
                <th>Permit</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="vehiclesBody"></tbody>
          </table>
        </div>
        <div id="emptyState" class="empty hidden">
          No vehicles recorded for this school/year.<br />
          Tap "+ Add Vehicle" to begin.
        </div>
      </section>
    </main>

    <!-- Vehicle Modal -->
    <div id="vehicleModal" class="modal hidden">
      <div class="modal-content" style="max-width: 1200px;">
        <div class="flex space center mb-2">
          <h2 id="modalTitle" style="margin: 0;">Add Vehicle</h2>
          <button class="btn secondary" id="closeModalBtn" type="button">Close</button>
        </div>

        <div id="modalAlert" class="alert hidden"></div>

        <form id="vehicleForm" autocomplete="off">
          <div class="grid two">
            <!-- Vehicle Core Info -->
            <div class="card">
              <h3 style="margin-top: 0; color: var(--accent-primary);">🚐 Vehicle Core Information</h3>
              <label for="plateInput">Plate / Registration Number <span style="color: red;">*</span></label>
              <input id="plateInput" required placeholder="T 123 ABC" />
              
              <label class="mt-1" for="modelInput">Make & Model <span style="color: red;">*</span></label>
              <input id="modelInput" required placeholder="Toyota Hiace 2020" />
              
              <label class="mt-1" for="capacityInput">Seating Capacity <span style="color: red;">*</span></label>
              <input id="capacityInput" type="number" min="1" required placeholder="30" />
              
              <label class="mt-1" for="colorInput">Colour / Notes</label>
              <input id="colorInput" placeholder="White, Blue stripes" />
              
              <label class="mt-1" for="statusSelect">Vehicle Status <span style="color: red;">*</span></label>
              <select id="statusSelect" required>
                <option value="active">✅ Active (In Service)</option>
                <option value="maintenance">🔧 Under Maintenance</option>
                <option value="inactive">❌ Inactive</option>
              </select>
            </div>

            <!-- Ownership Details -->
            <div class="card">
              <h3 style="margin-top: 0; color: var(--accent-success);">👤 Ownership Details</h3>
              <label for="ownerNameInput">Owner Full Name <span style="color: red;">*</span></label>
              <input id="ownerNameInput" required placeholder="John Doe" />
              
              <label class="mt-1" for="ownerPhoneInput">Owner Phone Number <span style="color: red;">*</span></label>
              <input id="ownerPhoneInput" required placeholder="+255712345678" />
              
              <label class="mt-1" for="ownerNotesInput">Owner Notes / Address</label>
              <textarea id="ownerNotesInput" rows="2" placeholder="Any additional information about the owner"></textarea>
              
              <label class="mt-1" for="ownershipTypeInput">Ownership Type <span style="color: red;">*</span></label>
              <select id="ownershipTypeInput" required>
                <option value="">-- Select Ownership --</option>
                <option value="school_owned">🏫 School Owned (Not Paid)</option>
                <option value="contracted">📄 Contracted (Paid)</option>
              </select>
            </div>
          </div>

          <!-- Contract Details (shown only for contracted vehicles) -->
          <div id="contractSection" class="card mt-2" style="display: none;">
            <h3 style="margin-top: 0; color: var(--accent-warning);">💰 Payment Contract Terms</h3>
            <div class="grid two">
              <div>
                <label for="paymentFrequencyInput">Payment Frequency <span style="color: red;">*</span></label>
                <select id="paymentFrequencyInput">
                  <option value="">-- Select Frequency --</option>
                  <option value="weekly">Weekly (Kila Wiki)</option>
                  <option value="monthly">Monthly (Kila Mwezi)</option>
                  <option value="yearly">Yearly (Kila Mwaka)</option>
                </select>
              </div>
              <div>
                <label for="paymentAmountInput">Payment Amount (TZS) <span style="color: red;">*</span></label>
                <input id="paymentAmountInput" type="number" min="0" placeholder="500000" />
              </div>
            </div>
            <div class="mt-1">
              <label for="contractNotesInput">Contract Notes / Terms</label>
              <textarea id="contractNotesInput" rows="2" placeholder="Additional contract terms, conditions, or notes"></textarea>
            </div>
          </div>

          <!-- Driver Assignment -->
          <div class="card mt-2">
            <h3 style="margin-top: 0; color: var(--accent-info);">👨‍✈️ Driver Assignment</h3>
            <label for="assignedDriverSelect">Assigned Driver <span style="color: red;">*</span></label>
            <select id="assignedDriverSelect" required>
              <option value="">-- Select Driver --</option>
              <!-- Populated from workers database -->
            </select>
            <small class="muted">Drivers are loaded from Workers → Dereva entries</small>
          </div>

          <!-- Route Assignment -->
          <div class="card mt-2">
            <h3 style="margin-top: 0; color: var(--accent-primary);">🗺️ Route Assignment</h3>
            <p class="muted" style="margin: 0 0 1rem 0;">Assign one or more routes to this vehicle. Click "+ Add Route" to assign multiple routes.</p>
            <div id="routesContainer"></div>
            <button class="btn secondary mt-2" type="button" id="addRouteBtn">+ Add Route</button>
          </div>

          <!-- Insurance Details -->
          <div class="card mt-2">
            <h3 style="margin-top: 0; color: var(--accent-danger);">📋 Insurance Information</h3>
            <div class="grid two">
              <div>
                <label for="providerInput">Insurance Provider <span style="color: red;">*</span></label>
                <input id="providerInput" required placeholder="AAR Insurance" />
              </div>
              <div>
                <label for="policyInput">Policy Number <span style="color: red;">*</span></label>
                <input id="policyInput" required placeholder="POL-2025-12345" />
              </div>
              <div>
                <label for="expiryInput">Insurance Expiry Date <span style="color: red;">*</span></label>
                <input id="expiryInput" type="date" required />
              </div>
              <div>
                <label>Insurance Photo <span style="color: red;">*</span></label>
                <input id="insuranceFile" type="file" accept="image/*" capture="environment" required />
              </div>
            </div>
            <img id="insurancePreview" alt="" style="width:100%; max-height:220px; object-fit:contain; margin-top:0.5rem; display:none; border-radius: 8px;" />
          </div>

          <!-- Permits & Inspection -->
          <div class="card mt-2">
            <h3 style="margin-top: 0; color: var(--accent-warning);">✅ Permits & Inspection</h3>
            <div class="grid two">
              <div>
                <label for="permitExpiryInput">Road Permit Expiry <span style="color: red;">*</span></label>
                <input id="permitExpiryInput" type="date" required />
              </div>
              <div>
                <label>Road Permit Photo <span style="color: red;">*</span></label>
                <input id="permitFile" type="file" accept="image/*" capture="environment" required />
              </div>
              <div>
                <label for="inspectionExpiryInput">Inspection Expiry <span style="color: red;">*</span></label>
                <input id="inspectionExpiryInput" type="date" required />
              </div>
              <div>
                <label>Inspection Photo <span style="color: red;">*</span></label>
                <input id="inspectionFile" type="file" accept="image/*" capture="environment" required />
              </div>
            </div>
            <div class="grid two mt-1">
              <img id="permitPreview" alt="" style="width:100%; max-height:220px; object-fit:contain; border-radius: 8px; display:none;" />
              <img id="inspectionPreview" alt="" style="width:100%; max-height:220px; object-fit:contain; border-radius: 8px; display:none;" />
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex mt-3" style="justify-content:flex-end; gap: 1rem;">
            <button class="btn secondary" type="button" id="cancelBtn">Cancel</button>
            <button class="btn success" type="submit" id="saveVehicleBtn">💾 Save Vehicle</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Vehicle Details PDF Preview Modal -->
    <div id="pdfModal" class="modal hidden">
      <div class="modal-content" style="max-width: 900px;">
        <div class="flex space center mb-2">
          <h2 style="margin: 0;">Vehicle Details</h2>
          <div class="flex" style="gap: 0.5rem;">
            <button class="btn success" id="downloadPdfBtn">📥 Download PDF</button>
            <button class="btn secondary" id="closePdfModal">Close</button>
          </div>
        </div>
        <div id="pdfContent" style="background: white; color: black; padding: 2rem; border-radius: 8px;">
          <!-- PDF content will be generated here -->
        </div>
      </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script src="./modules/transport_roles.js"></script>
    <script src="./modules/transport_helpers.js"></script>
    <script src="./modules/transport_pricing.js"></script>
    <script>
      // Global State
      const state = {
        user: null,
        role: null,
        year: new Date().getFullYear(),
        school: "SoMAp",
        vehicles: [],
        drivers: [],
        currentId: null,
        uploads: {},
        routes: [] // Will store assigned routes
      };

      // All available routes from transport system
      const ALL_ROUTES = [
        { value: "jirani na shule", label: "Jirani na Shule (1 KM)" },
        { value: "mazengo", label: "Mazengo (1 KM)" },
        { value: "mbezi", label: "Mbezi (1 KM)" },
        { value: "msikitini", label: "Msikitini (1 KM)" },
        { value: "mlimani rc", label: "Mlimani RC (1 KM)" },
        { value: "uswahilini kanisani", label: "Uswahilini Kanisani (1 KM)" },
        { value: "international", label: "International (1 KM)" },
        { value: "kona dampo", label: "Kona Dampo (1 KM)" },
        { value: "mauwa", label: "Mauwa (1 KM)" },
        { value: "mwisho wa fensi", label: "Mwisho wa Fensi (1 KM)" },
        { value: "ghati", label: "Ghati (1 KM)" },
        { value: "mnara wa halotel", label: "Mnara wa Halotel (1 KM)" },
        { value: "sinoni", label: "Sinoni (1.5 KM)" },
        { value: "kidemi", label: "Kidemi (1.5 KM)" },
        { value: "soko mjinga", label: "Soko Mjinga (1.5 KM)" },
        { value: "mnara wa voda", label: "Mnara wa Voda (1.5 KM)" },
        { value: "mbugani kwenye lami tu", label: "Mbugani Kwenye Lami Tu (1.5 KM)" },
        { value: "glorious", label: "Glorious (2 KM)" },
        { value: "ushirika", label: "Ushirika (2 KM)" },
        { value: "tanga kona", label: "Tanga Kona (2 KM)" },
        { value: "njia mtoni", label: "Njia Mtoni (2 KM)" },
        { value: "kaburi moja", label: "Kaburi Moja (2 KM)" },
        { value: "kwa malaika", label: "Kwa Malaika (2 KM)" },
        { value: "savanna", label: "Savanna (2 KM)" },
        { value: "dampo", label: "Dampo (2 KM)" },
        { value: "darajani", label: "Darajani (2 KM)" },
        { value: "kikwete road", label: "Kikwete Road (2 KM)" },
        { value: "boma kubwa", label: "Boma Kubwa (2 KM)" },
        { value: "kiwetu pazuri", label: "Kiwetu Pazuri (2 KM)" },
        { value: "umoja road", label: "Umoja Road (2 KM)" },
        { value: "njiro ndogo", label: "Njiro Ndogo (2 KM)" },
        { value: "king david", label: "King David (2 KM)" },
        { value: "chavda", label: "Chavda (3-4 KM)" },
        { value: "matokeo", label: "Matokeo (3-4 KM)" },
        { value: "milano", label: "Milano (3-4 KM)" },
        { value: "jamhuri", label: "Jamhuri (3-4 KM)" },
        { value: "felix mrema", label: "Felix Mrema (3-4 KM)" },
        { value: "lemara", label: "Lemara (3-4 KM)" },
        { value: "bonisite", label: "Bonisite (3-4 KM)" },
        { value: "intel", label: "Intel (3-4 KM)" },
        { value: "patel", label: "Patel (3-4 KM)" },
        { value: "terrati", label: "Terrati (3-4 KM)" },
        { value: "si mbaoil", label: "Si Mbaoil (3-4 KM)" },
        { value: "mapambazuko", label: "Mapambazuko (5-6 KM)" },
        { value: "mkono wa madukani", label: "Mkono wa Madukani (5-6 KM)" },
        { value: "soweto", label: "Soweto (5-6 KM)" },
        { value: "mianzini barabarani", label: "Mianzini Barabarani (5-6 KM)" },
        { value: "eliboru jr", label: "Eliboru JR (5-6 KM)" },
        { value: "green valley", label: "Green Valley (5-6 KM)" },
        { value: "country coffee", label: "Country Coffee (5-6 KM)" },
        { value: "maua", label: "Maua (5-6 KM)" },
        { value: "pepsi", label: "Pepsi (5-6 KM)" },
        { value: "majengo", label: "Majengo (5-6 KM)" },
        { value: "sanawari", label: "Sanawari (6-10 KM)" },
        { value: "sekei", label: "Sekei (6-10 KM)" },
        { value: "shabani", label: "Shabani (6-10 KM)" },
        { value: "kimandolu", label: "Kimandolu (6-10 KM)" },
        { value: "kijenge", label: "Kijenge (6-10 KM)" },
        { value: "mkono wa shuleni", label: "Mkono wa Shuleni (6-10 KM)" },
        { value: "suye", label: "Suye (10-15 KM)" },
        { value: "moshono", label: "Moshono (10-15 KM)" },
        { value: "nado", label: "Nado (10-15 KM)" },
        { value: "mwanama reli", label: "Mwanama Reli (10-15 KM)" },
        { value: "kisongo", label: "Kisongo (10-15 KM)" },
        { value: "kiserian", label: "Kiserian (NJE YA MAENEO)" },
        { value: "chekereni", label: "Chekereni (NJE YA MAENEO)" },
        { value: "duka bovu", label: "Duka Bovu (NJE YA MAENEO)" },
        { value: "tengeru", label: "Tengeru (NJE YA MAENEO)" },
        { value: "ngulelo", label: "Ngulelo (NJE YA MAENEO)" },
        { value: "kwamrefu", label: "Kwamrefu (NJE YA MAENEO)" },
        { value: "shangarai atomic", label: "Shangarai Atomic (NJE YA MAENEO)" }
      ];

      // Elements
      const toast = document.getElementById("toast");
      const vehiclesBody = document.getElementById("vehiclesBody");
      const emptyState = document.getElementById("emptyState");
      const alertsEl = document.getElementById("alerts");
      const kpiRow = document.getElementById("kpiRow");
      const modal = document.getElementById("vehicleModal");
      const modalAlert = document.getElementById("modalAlert");
      const yearSelect = document.getElementById("yearSelect");
      const currentDateEl = document.getElementById("currentDate");

      // Utility Functions
      function showToast(message, tone = "ok") {
        toast.textContent = message;
        toast.classList.remove("hidden");
        toast.style.background = tone === "bad" ? "#dc2626" : "#10b981";
        setTimeout(() => toast.classList.add("hidden"), 3200);
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-TZ', { style: 'currency', currency: 'TZS', minimumFractionDigits: 0 }).format(amount || 0);
      }

      function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-GB');
      }

      function formatDateTime(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleString('en-GB');
      }

      // Update current date display
      function updateDateDisplay() {
        const now = new Date();
        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        currentDateEl.textContent = now.toLocaleDateString('en-US', options);
      }
      updateDateDisplay();
      setInterval(updateDateDisplay, 1000);

      // Year selection handler
      yearSelect.value = state.year;
      yearSelect.addEventListener('change', (e) => {
        state.year = parseInt(e.target.value);
        subscribeVehicles();
      });

      function chipForExpiry(dateStr) {
        if (!dateStr) {
          return '<span class="chip warn">Missing</span>';
        }
        const today = new Date();
        const expiry = new Date(dateStr);
        const diff = expiry - today;
        if (Number.isNaN(expiry.getTime())) {
          return '<span class="chip warn">Invalid date</span>';
        }
        if (diff < 0) {
          return `<span class="chip bad">EXPIRED ${formatDate(dateStr)}</span>`;
        }
        const daysRemaining = Math.ceil(diff / (1000 * 60 * 60 * 24));
        if (daysRemaining <= 30) {
          return `<span class="chip warn">Expiring ${formatDate(dateStr)}</span>`;
        }
        return `<span class="chip ok">OK ${formatDate(dateStr)}</span>`;
      }

      // Render KPIs
      function renderKpis() {
        const totalActive = state.vehicles.filter((v) => v.status === "active").length;
        const maintenance = state.vehicles.filter((v) => v.status === "maintenance").length;
        const expired = state.vehicles.filter((v) => {
          if (!v.insuranceExpiry) return false;
          return new Date(v.insuranceExpiry) < new Date();
        }).length;
        const expiringSoon = state.vehicles.filter((v) => {
          if (!v.insuranceExpiry) return false;
          const diff = new Date(v.insuranceExpiry) - new Date();
          return diff >= 0 && diff <= 30 * 24 * 60 * 60 * 1000;
        }).length;

        const cards = [
          { label: "Active Vehicles", value: totalActive, color: "success" },
          { label: "In Maintenance", value: maintenance, color: "warning" },
          { label: "Expired Insurance", value: expired, color: "danger" },
          { label: "Expiring Soon (30d)", value: expiringSoon, color: "info" },
        ];

        kpiRow.innerHTML = cards.map(card => `
          <article class="card stat-card">
            <div class="stat-label">${card.label}</div>
            <div class="stat-value" style="color: var(--accent-${card.color});">${card.value}</div>
          </article>
        `).join("");
      }

      // Render Alerts
      function renderAlerts() {
        const expired = state.vehicles.filter((v) => {
          if (!v.insuranceExpiry) return false;
          return new Date(v.insuranceExpiry) < new Date();
        });
        const expiring = state.vehicles.filter((v) => {
          if (!v.insuranceExpiry) return false;
          const diff = new Date(v.insuranceExpiry) - new Date();
          return diff >= 0 && diff <= 30 * 24 * 60 * 60 * 1000;
        });

        const alerts = [];
        if (expired.length) {
          alerts.push(
            `<div class="alert red" style="animation: pulse 2s infinite;">
              🚨 <strong>CRITICAL:</strong> ${expired.length} vehicle(s) with EXPIRED insurance: ${expired.map((v) => v.plate || v.id).join(", ")}. 
              <strong>RENEW INSURANCE IMMEDIATELY!</strong>
            </div>`
          );
        }
        if (expiring.length) {
          alerts.push(
            `<div class="alert amber">
              ⚠️ Insurance expiring within 30 days: ${expiring.map((v) => v.plate || v.id).join(", ")}.
            </div>`
          );
        }
        alertsEl.innerHTML = alerts.join("") || "";
      }

      function canEdit() {
        // Always allow editing - simplified for now
        return true;
      }

      // Render Table
      function renderTable() {
        if (!state.vehicles.length) {
          emptyState.classList.remove("hidden");
          vehiclesBody.innerHTML = "";
          return;
        }
        emptyState.classList.add("hidden");

        vehiclesBody.innerHTML = state.vehicles.map((vehicle) => {
          const driver = state.drivers.find(d => d.id === vehicle.assignedDriverUid);
          const driverName = driver ? driver.fullName : (vehicle.assignedDriverUid || '—');
          
          const routes = vehicle.assignedRoutes || [];
          const routesDisplay = routes.length > 0 
            ? routes.map(r => `<span class="chip ok" style="margin: 2px;">${r}</span>`).join(' ')
            : '—';

          const actions = [];
          actions.push(`<button class="btn secondary" data-edit="${vehicle.id}">✏️ Edit</button>`);
          actions.push(`<button class="btn info" data-pdf="${vehicle.id}">📄 PDF</button>`);
          
          return `
            <tr>
              <td style="font-weight: 600;">${vehicle.plate || "—"}</td>
              <td>${vehicle.makeModel || "—"}</td>
              <td>
                ${vehicle.ownerName || "—"}<br/>
                <small class="muted">${vehicle.ownerPhone || ""}</small>
              </td>
              <td>${driverName}</td>
              <td>${vehicle.capacity || "—"}</td>
              <td>${routesDisplay}</td>
              <td>${chipForExpiry(vehicle.insuranceExpiry)}</td>
              <td>${chipForExpiry(vehicle.roadPermitExpiry)}</td>
              <td>
                <span class="chip ${vehicle.status === "active" ? "ok" : vehicle.status === "maintenance" ? "warn" : "bad"}">
                  ${vehicle.status || "—"}
                </span>
              </td>
              <td class="table-actions">${actions.join(" ")}</td>
            </tr>
          `;
        }).join("");

        // Attach event listeners
        vehiclesBody.querySelectorAll("button[data-edit]").forEach((btn) => {
          btn.addEventListener("click", () => openModal(btn.dataset.edit));
        });
        vehiclesBody.querySelectorAll("button[data-pdf]").forEach((btn) => {
          btn.addEventListener("click", () => generatePDF(btn.dataset.pdf));
        });
      }

      // Load Drivers from Workers Database
      async function loadDrivers() {
        try {
          const workersSnap = await firebase.database().ref('workers').once('value');
          state.drivers = [];
          
          if (workersSnap.exists()) {
            workersSnap.forEach(workerSnap => {
              const worker = workerSnap.val();
              if (worker.profile && worker.profile.role === 'driver' && worker.profile.active !== false) {
                state.drivers.push({
                  id: workerSnap.key,
                  fullName: worker.profile.fullNameUpper || `${worker.profile.firstName} ${worker.profile.middleName} ${worker.profile.lastName}`,
                  phone: worker.profile.phone,
                  firstName: worker.profile.firstName,
                  middleName: worker.profile.middleName,
                  lastName: worker.profile.lastName
                });
              }
            });
          }

          // Populate driver dropdown
          const driverSelect = document.getElementById('assignedDriverSelect');
          driverSelect.innerHTML = '<option value="">-- Select Driver --</option>' +
            state.drivers.map(d => `<option value="${d.id}">${d.fullName} (${d.phone})</option>`).join('');
          
          console.log('Loaded drivers:', state.drivers.length);
        } catch (error) {
          console.error('Error loading drivers:', error);
          showToast('Failed to load drivers', 'bad');
        }
      }

      // Add Route Card
      function addRouteCard(routeValue = '') {
        const container = document.getElementById('routesContainer');
        const routeId = `route_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        const routeCard = document.createElement('div');
        routeCard.className = 'card mt-1';
        routeCard.id = routeId;
        routeCard.style.background = 'rgba(59, 130, 246, 0.05)';
        routeCard.style.border = '1px solid rgba(59, 130, 246, 0.2)';
        
        routeCard.innerHTML = `
          <div class="flex space center">
            <label style="flex: 1; margin: 0;">
              <span style="font-size: 0.875rem; font-weight: 600;">Select Route</span>
              <select class="route-select" style="margin-top: 0.5rem;" data-route-id="${routeId}">
                <option value="">-- Select Route --</option>
                ${ALL_ROUTES.map(r => `<option value="${r.value}" ${r.value === routeValue ? 'selected' : ''}>${r.label}</option>`).join('')}
              </select>
            </label>
            <button type="button" class="btn secondary" onclick="removeRouteCard('${routeId}')" style="margin-top: 1.5rem;">❌ Remove</button>
          </div>
        `;
        
        container.appendChild(routeCard);
      }

      function removeRouteCard(routeId) {
        const card = document.getElementById(routeId);
        if (card) card.remove();
      }

      // Make removeRouteCard available globally
      window.removeRouteCard = removeRouteCard;

      // Add route button handler
      document.getElementById('addRouteBtn').addEventListener('click', () => {
        addRouteCard();
      });

      // Ownership type change handler
      document.getElementById('ownershipTypeInput').addEventListener('change', (e) => {
        const contractSection = document.getElementById('contractSection');
        const paymentFrequency = document.getElementById('paymentFrequencyInput');
        const paymentAmount = document.getElementById('paymentAmountInput');
        
        if (e.target.value === 'contracted') {
          contractSection.style.display = 'block';
          paymentFrequency.required = true;
          paymentAmount.required = true;
        } else {
          contractSection.style.display = 'none';
          paymentFrequency.required = false;
          paymentAmount.required = false;
        }
      });

      // File preview handlers
      function setupFilePreview(fileInputId, previewId) {
        const fileInput = document.getElementById(fileInputId);
        const preview = document.getElementById(previewId);
        
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
            preview.src = event.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
          state.uploads[fileInputId] = file;
        });
      }

      setupFilePreview('insuranceFile', 'insurancePreview');
      setupFilePreview('permitFile', 'permitPreview');
      setupFilePreview('inspectionFile', 'inspectionPreview');

      // Upload files to Firebase Storage
      async function uploadIfNeeded(school, year, busId) {
        const uploads = {};
        const uploadPromises = [];
        
        for (const [key, file] of Object.entries(state.uploads)) {
          if (!file) continue;
          
          const storageRef = firebase.storage().ref(
            `transport/${school}/${year}/buses/${busId}/${key}-${Date.now()}-${file.name}`
          );
          
          uploadPromises.push(
            storageRef.put(file)
              .then(() => storageRef.getDownloadURL())
              .then(url => { 
                uploads[key] = url; 
                console.log(`Successfully uploaded ${key}`);
              })
              .catch(err => {
                console.error(`Failed to upload ${key}:`, err);
                // Continue even if upload fails - don't break the whole save
              })
          );
        }
        
        // Wait for all uploads (success or failure)
        await Promise.all(uploadPromises);
        return uploads;
      }

      // Reset Form
      function resetForm() {
        modalAlert.classList.add("hidden");
        modalAlert.classList.remove("red");
        modalAlert.textContent = "";
        
        const form = document.getElementById("vehicleForm");
        if (form) form.reset();
        
        document.getElementById("insurancePreview").style.display = "none";
        document.getElementById("permitPreview").style.display = "none";
        document.getElementById("inspectionPreview").style.display = "none";
        document.getElementById("contractSection").style.display = "none";
        document.getElementById("routesContainer").innerHTML = "";
        
        // Reset file input requirements for new vehicle
        document.getElementById("insuranceFile").required = true;
        document.getElementById("permitFile").required = true;
        document.getElementById("inspectionFile").required = true;
        
        // Reset save button
        const saveBtn = document.getElementById("saveVehicleBtn");
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = '💾 Save Vehicle';
        }
        
        addRouteCard(); // Add one default route card
        state.uploads = {};
        state.currentId = null;
      }

      // Open Modal
      function openModal(id = null) {
        resetForm();
        
        if (id) {
          const vehicle = state.vehicles.find((v) => v.id === id);
          if (!vehicle) return;
          
          state.currentId = id;
          document.getElementById("modalTitle").textContent = `Edit Vehicle: ${vehicle.plate}`;
          document.getElementById("plateInput").value = vehicle.plate || "";
          document.getElementById("modelInput").value = vehicle.makeModel || "";
          document.getElementById("capacityInput").value = vehicle.capacity || "";
          document.getElementById("colorInput").value = vehicle.color || "";
          document.getElementById("statusSelect").value = vehicle.status || "active";
          document.getElementById("ownerNameInput").value = vehicle.ownerName || "";
          document.getElementById("ownerPhoneInput").value = vehicle.ownerPhone || "";
          document.getElementById("ownerNotesInput").value = vehicle.ownerNotes || "";
          document.getElementById("ownershipTypeInput").value = vehicle.ownershipType || "";
          document.getElementById("assignedDriverSelect").value = vehicle.assignedDriverUid || "";
          document.getElementById("providerInput").value = vehicle.insuranceProvider || "";
          document.getElementById("policyInput").value = vehicle.insurancePolicyNo || "";
          document.getElementById("expiryInput").value = vehicle.insuranceExpiry || "";
          document.getElementById("permitExpiryInput").value = vehicle.roadPermitExpiry || "";
          document.getElementById("inspectionExpiryInput").value = vehicle.inspectionExpiry || "";

          // Contract details
          if (vehicle.ownershipType === 'contracted') {
            document.getElementById("contractSection").style.display = "block";
            document.getElementById("paymentFrequencyInput").value = vehicle.paymentFrequency || "";
            document.getElementById("paymentAmountInput").value = vehicle.paymentAmount || "";
            document.getElementById("contractNotesInput").value = vehicle.contractNotes || "";
          }

          // Routes
          document.getElementById("routesContainer").innerHTML = "";
          const routes = vehicle.assignedRoutes || [];
          if (routes.length > 0) {
            routes.forEach(route => addRouteCard(route));
          } else {
            addRouteCard();
          }

          // Images
          if (vehicle.insurancePhotoUrl) {
            document.getElementById("insurancePreview").src = vehicle.insurancePhotoUrl;
            document.getElementById("insurancePreview").style.display = "block";
            // Make file inputs optional for editing
            document.getElementById("insuranceFile").required = false;
          }
          if (vehicle.roadPermitPhotoUrl) {
            document.getElementById("permitPreview").src = vehicle.roadPermitPhotoUrl;
            document.getElementById("permitPreview").style.display = "block";
            document.getElementById("permitFile").required = false;
          }
          if (vehicle.inspectionPhotoUrl) {
            document.getElementById("inspectionPreview").src = vehicle.inspectionPhotoUrl;
            document.getElementById("inspectionPreview").style.display = "block";
            document.getElementById("inspectionFile").required = false;
          }

          if (vehicle.insuranceExpiry && new Date(vehicle.insuranceExpiry) < new Date()) {
            modalAlert.textContent = "⚠️ INSURANCE EXPIRED — RENEW INSURANCE BEFORE SERVICE.";
            modalAlert.classList.remove("hidden");
            modalAlert.classList.add("red");
          }
        } else {
          document.getElementById("modalTitle").textContent = "Add New Vehicle";
          addRouteCard(); // Add one default route card for new vehicles
        }
        
        modal.classList.remove("hidden");
      }

      function closeModal() {
        modal.classList.add("hidden");
      }

      // Event Listeners
      document.getElementById("addVehicleBtn").addEventListener("click", () => {
        openModal();
      });

      document.getElementById("closeModalBtn").addEventListener("click", closeModal);
      document.getElementById("cancelBtn").addEventListener("click", closeModal);

      // Save Vehicle
      document.getElementById("vehicleForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log('=== VEHICLE SAVE FORM SUBMITTED ===');

        // Prevent double submission
        const saveBtn = document.getElementById("saveVehicleBtn");
        if (saveBtn.disabled) {
          console.log('Button already disabled, ignoring duplicate submission');
          return;
        }
        saveBtn.disabled = true;
        saveBtn.textContent = '💾 Saving...';
        console.log('Button disabled, starting save process');

        // Collect form data
        const plate = document.getElementById("plateInput").value.trim();
        const makeModel = document.getElementById("modelInput").value.trim();
        const capacity = Number(document.getElementById("capacityInput").value);
        const color = document.getElementById("colorInput").value.trim();
        const status = document.getElementById("statusSelect").value;
        const ownerName = document.getElementById("ownerNameInput").value.trim();
        const ownerPhone = document.getElementById("ownerPhoneInput").value.trim();
        const ownerNotes = document.getElementById("ownerNotesInput").value.trim();
        const ownershipType = document.getElementById("ownershipTypeInput").value;
        const assignedDriverUid = document.getElementById("assignedDriverSelect").value;
        const insuranceProvider = document.getElementById("providerInput").value.trim();
        const insurancePolicyNo = document.getElementById("policyInput").value.trim();
        const insuranceExpiry = document.getElementById("expiryInput").value;
        const roadPermitExpiry = document.getElementById("permitExpiryInput").value;
        const inspectionExpiry = document.getElementById("inspectionExpiryInput").value;

        // Collect routes
        const routeSelects = document.querySelectorAll('.route-select');
        const assignedRoutes = Array.from(routeSelects)
          .map(select => select.value)
          .filter(value => value !== '');

        if (assignedRoutes.length === 0) {
          console.log('VALIDATION ERROR: No routes assigned');
          modalAlert.textContent = "Please assign at least one route.";
          modalAlert.classList.remove("hidden");
          saveBtn.disabled = false;
          saveBtn.textContent = '💾 Save Vehicle';
          return;
        }
        console.log('Route validation passed:', assignedRoutes);

        // Contract details
        let paymentFrequency = '';
        let paymentAmount = 0;
        let contractNotes = '';
        
        if (ownershipType === 'contracted') {
          paymentFrequency = document.getElementById("paymentFrequencyInput").value;
          paymentAmount = Number(document.getElementById("paymentAmountInput").value);
          contractNotes = document.getElementById("contractNotesInput").value.trim();
          
          if (!paymentFrequency || !paymentAmount) {
            modalAlert.textContent = "Please fill in all contract details for contracted vehicles.";
            modalAlert.classList.remove("hidden");
            saveBtn.disabled = false;
            saveBtn.textContent = '💾 Save Vehicle';
            return;
          }
        }

        // Validation
        if (!plate || !makeModel || !capacity || !ownerName || !ownerPhone || !ownershipType || !assignedDriverUid || 
            !insuranceProvider || !insurancePolicyNo || !insuranceExpiry || !roadPermitExpiry || !inspectionExpiry) {
          console.log('VALIDATION ERROR: Missing required fields');
          modalAlert.textContent = "Please fill in all required fields (marked with *).";
          modalAlert.classList.remove("hidden");
          saveBtn.disabled = false;
          saveBtn.textContent = '💾 Save Vehicle';
          return;
        }
        console.log('Field validation passed');

        // Check if user is authenticated
        if (!state.user || !state.user.uid) {
          console.log('VALIDATION ERROR: Not authenticated');
          modalAlert.textContent = "Error: Not authenticated. Please sign in again.";
          modalAlert.classList.remove("hidden");
          saveBtn.disabled = false;
          saveBtn.textContent = '💾 Save Vehicle';
          showToast('Authentication error', 'bad');
          return;
        }
        console.log('User authenticated:', state.user.uid);

        const isNew = !state.currentId;
        const dbPath = `transport/${state.school}/${state.year}/buses`;
        const ref = isNew
          ? firebase.database().ref(dbPath).push()
          : firebase.database().ref(`${dbPath}/${state.currentId}`);
        const busId = isNew ? ref.key : state.currentId;

        try {
          console.log('=== ENTERING TRY BLOCK ===');
          console.log('Starting save process for busId:', busId);
          showToast('Saving vehicle...', 'ok');
          
          // Upload files
          console.log('Uploading files...', Object.keys(state.uploads));
          const uploads = await uploadIfNeeded(state.school, state.year, busId);
          console.log('File uploads completed:', uploads);
          
          const payload = {
            plate,
            makeModel,
            capacity,
            color,
            status,
            ownerName,
            ownerPhone,
            ownerNotes,
            ownershipType,
            assignedDriverUid,
            assignedRoutes,
            insuranceProvider,
            insurancePolicyNo,
            insuranceExpiry,
            roadPermitExpiry,
            inspectionExpiry,
            insurancePhotoUrl: uploads.insuranceFile || (state.currentId ? state.vehicles.find((v) => v.id === state.currentId)?.insurancePhotoUrl || null : null),
            roadPermitPhotoUrl: uploads.permitFile || (state.currentId ? state.vehicles.find((v) => v.id === state.currentId)?.roadPermitPhotoUrl || null : null),
            inspectionPhotoUrl: uploads.inspectionFile || (state.currentId ? state.vehicles.find((v) => v.id === state.currentId)?.inspectionPhotoUrl || null : null),
            updatedAt: Date.now(),
            updatedBy: state.user.uid,
          };

          // Add contract details if contracted
          if (ownershipType === 'contracted') {
            payload.paymentFrequency = paymentFrequency;
            payload.paymentAmount = paymentAmount;
            payload.contractNotes = contractNotes;
          }

          if (isNew) {
            payload.createdAt = Date.now();
            payload.createdBy = state.user.uid;
            payload.registrationDate = new Date().toISOString();
          }

          console.log('Saving payload to Firebase...', payload);
          await ref.set(payload);
          console.log('Firebase save successful!');
          console.log('=== SAVE COMPLETED SUCCESSFULLY ===');
          showToast(`Vehicle saved successfully! ✅`, 'ok');
          closeModal();
        } catch (err) {
          console.error('=== SAVE ERROR ===', err);
          console.error(err);
          modalAlert.textContent = `Failed to save vehicle: ${err.message}`;
          modalAlert.classList.remove("hidden");
          showToast('Failed to save vehicle', 'bad');
          saveBtn.disabled = false;
          saveBtn.textContent = '💾 Save Vehicle';
        }
      });

      // Generate PDF
      function generatePDF(vehicleId) {
        const vehicle = state.vehicles.find(v => v.id === vehicleId);
        if (!vehicle) return;

        const driver = state.drivers.find(d => d.id === vehicle.assignedDriverUid);
        const driverName = driver ? driver.fullName : (vehicle.assignedDriverUid || 'Not Assigned');
        const routes = vehicle.assignedRoutes || [];

        const pdfContent = document.getElementById('pdfContent');
        pdfContent.innerHTML = `
          <div style="text-align: center; margin-bottom: 2rem;">
            <h1 style="color: #1f2937; margin: 0;">🚐 SoMAp Transport System</h1>
            <h2 style="color: #6b7280; margin: 0.5rem 0 0 0;">Vehicle Registration Details</h2>
            <p style="color: #9ca3af; margin: 0.5rem 0 0 0;">Generated on ${formatDateTime(Date.now())}</p>
          </div>

          <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="color: #059669; margin: 0 0 1rem 0; border-bottom: 2px solid #059669; padding-bottom: 0.5rem;">Vehicle Information</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 0.5rem; font-weight: 600; width: 40%;">Plate Number:</td>
                <td style="padding: 0.5rem;">${vehicle.plate || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Make & Model:</td>
                <td style="padding: 0.5rem;">${vehicle.makeModel || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Seating Capacity:</td>
                <td style="padding: 0.5rem;">${vehicle.capacity || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Colour/Notes:</td>
                <td style="padding: 0.5rem;">${vehicle.color || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Status:</td>
                <td style="padding: 0.5rem;">${vehicle.status || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Registration Date:</td>
                <td style="padding: 0.5rem;">${formatDateTime(vehicle.createdAt || vehicle.registrationDate)}</td>
              </tr>
            </table>
          </div>

          <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="color: #2563eb; margin: 0 0 1rem 0; border-bottom: 2px solid #2563eb; padding-bottom: 0.5rem;">Ownership Details</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 0.5rem; font-weight: 600; width: 40%;">Owner Name:</td>
                <td style="padding: 0.5rem;">${vehicle.ownerName || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Owner Phone:</td>
                <td style="padding: 0.5rem;">${vehicle.ownerPhone || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Ownership Type:</td>
                <td style="padding: 0.5rem;">${vehicle.ownershipType === 'school_owned' ? '🏫 School Owned' : '📄 Contracted'}</td>
              </tr>
              ${vehicle.ownershipType === 'contracted' ? `
                <tr>
                  <td style="padding: 0.5rem; font-weight: 600;">Payment Frequency:</td>
                  <td style="padding: 0.5rem;">${vehicle.paymentFrequency || 'N/A'}</td>
                </tr>
                <tr>
                  <td style="padding: 0.5rem; font-weight: 600;">Payment Amount:</td>
                  <td style="padding: 0.5rem;">${formatCurrency(vehicle.paymentAmount || 0)}</td>
                </tr>
                <tr>
                  <td style="padding: 0.5rem; font-weight: 600;">Contract Notes:</td>
                  <td style="padding: 0.5rem;">${vehicle.contractNotes || 'N/A'}</td>
                </tr>
              ` : ''}
            </table>
          </div>

          <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="color: #7c3aed; margin: 0 0 1rem 0; border-bottom: 2px solid #7c3aed; padding-bottom: 0.5rem;">Driver & Routes</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 0.5rem; font-weight: 600; width: 40%;">Assigned Driver:</td>
                <td style="padding: 0.5rem;">${driverName}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600; vertical-align: top;">Assigned Routes:</td>
                <td style="padding: 0.5rem;">${routes.length > 0 ? routes.join(', ') : 'None'}</td>
              </tr>
            </table>
          </div>

          <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem;">
            <h3 style="color: #dc2626; margin: 0 0 1rem 0; border-bottom: 2px solid #dc2626; padding-bottom: 0.5rem;">Insurance & Permits</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 0.5rem; font-weight: 600; width: 40%;">Insurance Provider:</td>
                <td style="padding: 0.5rem;">${vehicle.insuranceProvider || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Policy Number:</td>
                <td style="padding: 0.5rem;">${vehicle.insurancePolicyNo || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Insurance Expiry:</td>
                <td style="padding: 0.5rem; ${new Date(vehicle.insuranceExpiry) < new Date() ? 'color: red; font-weight: 700;' : ''}">${formatDate(vehicle.insuranceExpiry)}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Road Permit Expiry:</td>
                <td style="padding: 0.5rem; ${new Date(vehicle.roadPermitExpiry) < new Date() ? 'color: red; font-weight: 700;' : ''}">${formatDate(vehicle.roadPermitExpiry)}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Inspection Expiry:</td>
                <td style="padding: 0.5rem; ${new Date(vehicle.inspectionExpiry) < new Date() ? 'color: red; font-weight: 700;' : ''}">${formatDate(vehicle.inspectionExpiry)}</td>
              </tr>
            </table>
          </div>

          <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 0.875rem;">
            <p style="margin: 0;">SoMAp School Management System · ${state.year}</p>
            <p style="margin: 0.25rem 0 0 0;">This document is computer-generated and valid without signature</p>
          </div>
        `;

        document.getElementById('pdfModal').classList.remove('hidden');
      }

      // Download PDF
      document.getElementById('downloadPdfBtn').addEventListener('click', () => {
        const element = document.getElementById('pdfContent');
        const opt = {
          margin: 10,
          filename: `vehicle_details_${Date.now()}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
        showToast('PDF downloaded successfully!');
      });

      document.getElementById('closePdfModal').addEventListener('click', () => {
        document.getElementById('pdfModal').classList.add('hidden');
      });

      // Subscribe to Vehicles
      function subscribeVehicles() {
        const path = `transport/${state.school}/${state.year}/buses`;
        const ref = firebase.database().ref(path);
        
        ref.on("value", (snapshot) => {
          const vehicles = [];
          snapshot.forEach((child) => {
            const value = child.val() || {};
            vehicles.push({ id: child.key, ...value });
          });
          
          if (state.role === "driver") {
            state.vehicles = vehicles.filter((v) => v.assignedDriverUid === state.user.uid);
          } else {
            state.vehicles = vehicles;
          }
          
          renderKpis();
          renderAlerts();
          renderTable();
        }, (err) => {
          console.error(err);
          showToast("Failed to load vehicles", "bad");
        });
      }

      // Auth and Initialization
      function ensureAuth() {
        firebase.auth().onAuthStateChanged((user) => {
          if (!user) {
            showToast("Sign in first", "bad");
            vehiclesBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem;">Please sign in to view vehicles.</td></tr>';
            return;
          }
          
          state.user = user;
          
          firebase.database().ref(`users/${user.uid}/role`).get()
            .then((snapshot) => {
              const roleRaw = snapshot.val();
              const role = TransportRoles.normalize(roleRaw);
              state.role = role || "admin"; // Default to admin for now
              
              console.log('User role loaded:', state.role, 'Raw:', roleRaw);
              
              // Load drivers then subscribe to vehicles
              loadDrivers().then(() => {
                subscribeVehicles();
              }).catch((err) => {
                console.error('Error loading drivers:', err);
                // Continue even if drivers fail to load
                subscribeVehicles();
              });
            })
            .catch((err) => {
              console.error(err);
              showToast("Failed to verify user", "bad");
              // Still allow using the page even if role check fails
              state.role = "admin";
              loadDrivers().then(() => {
                subscribeVehicles();
              }).catch((err2) => {
                console.error('Error loading drivers:', err2);
                subscribeVehicles();
              });
            });
        });
      }

      // Initialize
      ensureAuth();
    </script>
  </body>
</html>
