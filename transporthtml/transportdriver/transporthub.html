<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Driver Transport Hub</title>
    <link rel="stylesheet" href="../../css/transport.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <div id="contextBar" class="bar"></div>
    <main style="padding:1.5rem; max-width:900px; margin:0 auto;">
      <section class="card">
        <h2>Driver hub</h2>
        <p class="muted">
          Auto-tracking runs silently within allowed windows. Make sure GPS is on.
        </p>
        <div id="vehicleInfo" class="mt-1"></div>
      </section>
      <section class="row mt-2">
        <article class="card" style="flex:1 1 260px;">
          <h2>Request Fuel</h2>
          <p class="muted">Tuma ombi la mafuta pamoja na kilomita.</p>
          <a class="btn" href="../driver/transportfuel_request.html">Open form</a>
        </article>
        <article class="card" style="flex:1 1 260px;">
          <h2>Request Maintenance</h2>
          <p class="muted">Ripoti tatizo la basi (brake, tyre, n.k.).</p>
          <a class="btn" href="../driver/transportmaintenance_request.html">Open form</a>
        </article>
      </section>
      <section class="card mt-2">
        <h2>Assigned students</h2>
        <div id="studentList" class="muted">Loading…</div>
      </section>
    </main>
    <div id="toast" class="toast hidden"></div>

    <script src="../../modules/transport_helpers.js"></script>
    <script src="../../modules/transport_context.js"></script>
    <script src="../../modules/transportauto_tracker.js" defer></script>
    <script>
      const toast = document.getElementById("toast");
      const vehicleInfo = document.getElementById("vehicleInfo");
      const studentList = document.getElementById("studentList");

      const state = {
        user: null,
        role: null,
        context: TransportContext.getContext(),
        vehicleId: null,
      };

      function showToast(message) {
        toast.textContent = message;
        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), 3200);
      }

      function ensureAuth() {
        firebase.auth().onAuthStateChanged((user) => {
          if (!user) {
            showToast("Sign in first");
            return;
          }
          state.user = user;
          firebase
            .database()
            .ref(`users/${user.uid}/role`)
            .get()
            .then((snapshot) => {
              const role = snapshot.val();
              if (role !== "driver") {
                showToast("Driver role required");
                return;
              }
              state.role = role;
              resolveVehicle();
            })
            .catch((err) => {
              console.error(err);
              showToast("Failed to verify user");
            });
        });
      }

      async function resolveVehicle() {
        const devicePath = TransportHelpers.paths.deviceVehicle(state.user.uid);
        const snapshot = await firebase.database().ref(devicePath).get();
        let vehicleId = snapshot.val();
        if (!vehicleId) {
          const local = localStorage.getItem("somap_vehicleId");
          if (local) vehicleId = local;
        }
        state.vehicleId = vehicleId || null;
        if (!state.vehicleId) {
          vehicleInfo.innerHTML =
            '<div class="alert amber">No vehicle assigned yet. Use Assign link provided by admin.</div>';
          return;
        }
        vehicleInfo.innerHTML = `Vehicle: <strong>${state.vehicleId}</strong>`;
        loadStudents();
      }

      function loadStudents() {
        firebase
          .database()
          .ref("transport_enrollments")
          .orderByChild("vehicleId")
          .equalTo(state.vehicleId)
          .on(
            "value",
            (snapshot) => {
              const lines = [];
              snapshot.forEach((child) => {
                const val = child.val();
                if (
                  val.school &&
                  val.school !== state.context.school
                )
                  return;
                if (
                  val.year &&
                  Number(val.year) !== Number(state.context.year)
                )
                  return;
                lines.push(
                  `${val.studentName || "Unknown"} · ${val.amStop || ""} / ${val.pmStop || ""}`
                );
              });
              studentList.textContent = lines.length
                ? lines.join("\n")
                : "No students allocated for this year.";
            },
            (err) => {
              console.error(err);
              studentList.textContent = "Failed to load students.";
            }
          );
      }

      TransportContext.attachContextSelectors(
        document.getElementById("contextBar"),
        () => loadStudents()
      );
      ensureAuth();
    </script>
  </body>
</html>
