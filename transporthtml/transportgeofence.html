<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transport Geofence Â· Auto-arrival beta</title>
    <link rel="stylesheet" href="../css/transport.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <div id="contextBar" class="bar"></div>
    <main style="padding:1rem;">
      <section class="card">
        <h2>Stop geofences</h2>
        <p class="muted">Preview stop radius for auto-arrival (beta). Adjust stop coordinates inside <em>Stops</em>.</p>
        <div id="map"></div>
        <div id="emptyState" class="empty hidden"></div>
      </section>
    </main>

    <script src="../modules/transport_context.js"></script>
    <script>
      let map;
      const markers = [];
      const state = {
        context: TransportContext.getContext(),
      };

      function ensureMap() {
        if (map) return;
        map = L.map("map").setView([-3.3869, 36.683], 12);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap",
        }).addTo(map);
      }

      function clearMarkers() {
        markers.forEach((m) => map.removeLayer(m));
        markers.length = 0;
      }

      function renderStops(stops) {
        const emptyState = document.getElementById("emptyState");
        if (!stops.length) {
          emptyState.textContent = `No geofence points for ${state.context.year}.`;
          emptyState.classList.remove("hidden");
          clearMarkers();
          return;
        }
        emptyState.classList.add("hidden");
        ensureMap();
        clearMarkers();
        stops.forEach((stop) => {
          if (stop.lat && stop.lng) {
            const marker = L.marker([stop.lat, stop.lng]).addTo(map);
            marker.bindPopup(`<strong>${stop.name || stop.id}</strong><br/>Radius: ${stop.radius || 80} m`);
            const circle = L.circle([stop.lat, stop.lng], {
              radius: Number(stop.radius || 80),
              color: "#2563eb",
              fillColor: "#60a5fa",
              fillOpacity: 0.15,
            }).addTo(map);
            markers.push(marker, circle);
          }
        });
        if (stops[0]?.lat && stops[0]?.lng) {
          map.setView([stops[0].lat, stops[0].lng], 13);
        }
      }

      function loadStops() {
        firebase
          .database()
          .ref(`transport/${state.context.school}/${state.context.year}/stops`)
          .once("value")
          .then((snapshot) => {
            const stops = [];
            snapshot.forEach((child) => stops.push({ id: child.key, ...(child.val() || {}) }));
            renderStops(stops);
          })
          .catch((err) => {
            console.error(err);
            const emptyState = document.getElementById("emptyState");
            emptyState.textContent = "Failed to load stops.";
            emptyState.classList.remove("hidden");
          });
      }

      TransportContext.attachContextSelectors(
        document.getElementById("contextBar"),
        (ctx) => {
          state.context = ctx;
          loadStops();
        }
      );
      loadStops();
    </script>
  </body>
</html>
