<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transport Payments ¬∑ Management & Debt Tracking</title>
    <link rel="stylesheet" href="./css/transport_dark.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <div id="contextBar" class="bar">
      <div>
        <h1>üí∞ Transport Payments & Debt Management</h1>
        <small>Comprehensive payment tracking and debt monitoring</small>
      </div>
      <div class="context-selectors">
        <div class="date-time-display">
          <span class="label">Payment Due Date</span>
          <span class="value" id="dueDate">27th of current month</span>
        </div>
        <div>
          <label style="margin-bottom: 0.25rem; font-size: 0.75rem;">Academic Year</label>
          <select id="yearSelect" data-somap-year-select data-somap-year-min="2023" data-somap-year-max="2042" style="min-width: 100px; padding: 0.5rem;">
          </select>
        </div>
        <script src="../Todashboardhtml/yearContext.js"></script>
        <a id="backButton" href="transport.html" class="btn secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <main>
      <!-- Financial Overview KPIs -->
      <section class="row">
        <article class="card stat-card">
          <div class="stat-label">Total Expected (This Month)</div>
          <div class="stat-value" id="totalExpected">‚Äî</div>
          <div class="stat-label" style="font-size: 0.75rem; margin-top: 0.5rem;" id="monthLabel"></div>
        </article>
        
        <article class="card stat-card">
          <div class="stat-label">Total Collected</div>
          <div class="stat-value" id="totalCollected" style="color: var(--accent-success);">‚Äî</div>
          <div class="stat-label" style="font-size: 0.75rem; margin-top: 0.5rem;">All transport payments</div>
        </article>
        
        <article class="card stat-card">
          <div class="stat-label">Total Transport Debt</div>
          <div class="stat-value" id="totalDebt" style="color: var(--accent-danger);">‚Äî</div>
          <div class="stat-label" style="font-size: 0.75rem; margin-top: 0.5rem;">Unpaid amounts</div>
        </article>
        
        <article class="card stat-card">
          <div class="stat-label">Total Expenses</div>
          <div class="stat-value" id="totalExpenses">‚Äî</div>
          <div class="stat-label" style="font-size: 0.75rem; margin-top: 0.5rem;">Fuel + Maintenance</div>
        </article>
        
        <article class="card stat-card">
          <div class="stat-label">Net Balance</div>
          <div class="stat-value" id="netBalance">‚Äî</div>
          <div class="stat-label" style="font-size: 0.75rem; margin-top: 0.5rem;">Collected - Expenses</div>
        </article>
      </section>

      <!-- Critical Alerts -->
      <section id="criticalAlerts" class="mt-3"></section>

      <!-- Students on Transport - Payment Tracking -->
      <section class="card mt-3">
        <div class="flex space center mb-2">
          <div>
            <h2 style="margin: 0;">Students on Transport - Payment Registry</h2>
            <small id="paymentSummary" class="muted"></small>
          </div>
          <div class="flex">
            <button class="btn secondary" onclick="toggleDebtorsOnly()">
              <span id="debtorsBtnText">Show Debtors Only</span>
            </button>
            <button class="btn success" onclick="exportToExcel()">üì• Export Excel</button>
            <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
          </div>
        </div>

        <div class="filter-bar">
          <select id="classFilter">
            <option value="">All Classes</option>
            <option>Baby Class</option>
            <option>Middle Class</option>
            <option>Pre Unit Class</option>
            <option>Class 1</option>
            <option>Class 2</option>
            <option>Class 3</option>
            <option>Class 4</option>
            <option>Class 5</option>
            <option>Class 6</option>
            <option>Class 7</option>
          </select>
          <input id="searchInput" type="text" placeholder="Search student..." style="max-width: 300px;" />
          <select id="statusFilter">
            <option value="">All Status</option>
            <option value="paid">Paid</option>
            <option value="partial">Partially Paid</option>
            <option value="unpaid">Unpaid (DEBT)</option>
          </select>
        </div>

        <div style="overflow-x: auto; margin-top: 1.5rem;">
          <table class="table" id="paymentsTable">
            <thead>
              <tr>
                <th>Admission No</th>
                <th>Full Name</th>
                <th>Class</th>
                <th>Date Registered</th>
                <th>Parent Contact</th>
                <th>School Fee Total</th>
                <th>School Fee Paid</th>
                <th>School Debt</th>
                <th>Debt Till (School)</th>
                <th>Route (Morning)</th>
                <th>Route (Evening)</th>
                <th>Monthly Transport Fee</th>
                <th>Transport Paid</th>
                <th>Transport Debt</th>
                <th>Unpaid Months</th>
                <th>Total Combined Debt</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="paymentsBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
          <div id="emptyState" class="empty hidden">No students found on transport</div>
        </div>
      </section>

      <!-- Expenses Tracking -->
      <section class="card mt-3">
        <h2>Transport Expenses Tracker</h2>
        <p class="muted mb-2">Track all transport-related expenses including fuel, maintenance, repairs, etc.</p>

        <div class="grid two" style="margin-bottom: 1.5rem;">
          <div class="card"> 
            <h3 style="margin-top: 0;">Quick Stats</h3>
            <div style="display: grid; gap: 0.75rem;">
              <div style="display: flex; justify-content: space-between;">
                <span>Fuel Expenses:</span>
                <span id="fuelExpenses" style="font-weight: 600;">‚Äî</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span>Maintenance Expenses:</span>
                <span id="maintenanceExpenses" style="font-weight: 600;">‚Äî</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span>Other Expenses:</span>
                <span id="otherExpenses" style="font-weight: 600;">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-top: 0;">Add New Expense</h3>
            <div style="display: grid; gap: 0.75rem;">
              <select id="expenseCategory">
                <option value="">Select Category</option>
                <option value="FUEL">Fuel</option>
                <option value="MAINTENANCE">Maintenance</option>
                <option value="REPAIRS">Repairs</option>
                <option value="INSURANCE">Insurance</option>
                <option value="PERMITS">Permits</option>
                <option value="SALARIES">Driver Salaries</option>
                <option value="OTHER">Other</option>
              </select>
              <input id="expenseAmount" type="number" min="1" placeholder="Amount (TZS)" />
              <input id="expenseDescription" type="text" placeholder="Description" />
              <button class="btn success" onclick="addExpense()">üíæ Add Expense</button>
            </div>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Added By</th>
              </tr>
            </thead>
            <tbody id="expensesBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- Payment History Modal -->
    <div id="historyModal" class="modal hidden">
      <div class="modal-content" style="max-width: 1200px;">
        <div class="flex space center mb-2">
          <h2 style="margin: 0;" id="historyModalTitle">Payment History</h2>
          <button class="btn secondary" onclick="closeHistoryModal()">Close</button>
        </div>
        <div style="overflow-x: auto; margin-top: 1.5rem;">
          <table class="table" id="historyTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Month</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Reference</th>
                <th>Payer Name</th>
                <th>Status</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
          <div id="historyEmpty" class="empty hidden">No payments recorded</div>
        </div>
      </div>
    </div>

    <!-- Record Payment Modal -->
    <div id="paymentModal" class="modal hidden">
      <div class="modal-content">
        <div class="flex space center mb-2">
          <h2 style="margin: 0;">Record Transport Payment</h2>
          <button class="btn secondary" onclick="closePaymentModal()">Close</button>
        </div>

        <div id="paymentAlert" class="alert hidden"></div>

        <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Student Information</h3>
          <div id="paymentStudentInfo"></div>
        </div>

        <div class="grid two">
          <div>
            <label for="paymentMonth">Payment Month</label>
            <select id="paymentMonth" required>
              <option value="">Select Month</option>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>

          <div>
            <label for="paymentAmount">Amount Paid (TZS)</label>
            <input id="paymentAmount" type="number" min="1" required />
          </div>

          <div>
            <label for="paymentMethod">Payment Method</label>
            <select id="paymentMethod">
              <option>Cash</option>
              <option>M-Pesa</option>
              <option>Airtel Money</option>
              <option>TigoPesa</option>
              <option>Bank Transfer</option>
              <option>Cheque</option>
              <option>Other</option>
            </select>
          </div>

          <div>
            <label for="paymentReference">Reference/Transaction No <span style="color: red;">*</span></label>
            <input id="paymentReference" type="text" placeholder="e.g., RFX123..." required />
          </div>

          <div>
            <label for="paymentPayerName">Payer Full Name <span style="color: red;">*</span></label>
            <input id="paymentPayerName" type="text" placeholder="Parent/Guardian name" required />
          </div>

          <div>
            <label for="paymentDate">Payment Date <span style="color: red;">*</span></label>
            <input id="paymentDate" type="date" required />
          </div>
        </div>

        <div class="mt-2">
          <label for="paymentNotes">Notes (Optional)</label>
          <textarea id="paymentNotes" rows="3" placeholder="Any additional notes..."></textarea>
        </div>

        <div class="flex mt-2" style="justify-content: flex-end; gap: 1rem;">
          <button class="btn secondary" onclick="closePaymentModal()">Cancel</button>
          <button class="btn success" onclick="savePayment()">üíæ Save Payment</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script src="./modules/transport_roles.js"></script>
    <script src="./modules/transport_context.js"></script>
    <script src="./modules/transport_helpers.js"></script>
    <script src="./modules/transport_pricing.js"></script>
    <script>
      // Global State
      const context = TransportContext.getContext();
      const state = {
        user: null,
        role: null,
        year: context.year || new Date().getFullYear(),
        month: context.month || new Date().getMonth() + 1,
        school: context.school || "socrates",
        students: {},
        transportEnrollments: {},
        financeData: {},
        transportPayments: {},
        expenses: {},
        showDebtorsOnly: false,
        currentPaymentStudentId: null,
      };

      const MONTH_NAMES = ["", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const MONTH_MULTIPLIERS = TransportPricing.MONTH_MULTIPLIERS;
      const CLASS_ORDER = ['Baby Class', 'Middle Class', 'Pre Unit Class', 'Class 1', 'Class 2', 'Class 3', 'Class 4', 'Class 5', 'Class 6', 'Class 7'];
      const BASE_YEAR = 2025;

      // Class progression helper
      function shiftClass(baseClass, deltaYears) {
        const normalized = String(baseClass || '').trim();
        const idx = CLASS_ORDER.findIndex(c => c.toLowerCase() === normalized.toLowerCase());
        if (idx < 0) return baseClass || '';
        const newIdx = idx + Number(deltaYears || 0);
        if (newIdx < 0) return 'PRE-ADMISSION';
        if (newIdx >= CLASS_ORDER.length) return 'GRADUATED';
        return CLASS_ORDER[newIdx];
      }

      // Phone normalization
      function normalizePhone(p) {
        const s = String(p || '').replace(/[\s\-()]/g, '');
        return s.replace(/(?!^\+)[^\d]/g, '');
      }

      // School prefix helper
      function currentSchoolPrefix() {
        return window.currentSchoolId ? `schools/${window.currentSchoolId}/` : '';
      }

      const toast = document.getElementById("toast");
      const yearSelect = document.getElementById("yearSelect");
      const classFilter = document.getElementById("classFilter");
      const searchInput = document.getElementById("searchInput");
      const statusFilter = document.getElementById("statusFilter");
      const paymentsBody = document.getElementById("paymentsBody");
      
      // Initialize year from context
      if (window.somapYearContext) {
        const currentYear = window.somapYearContext.getSelectedYear();
        state.year = parseInt(currentYear) || state.year;
        if (yearSelect) yearSelect.value = state.year;
      }

      // Utility Functions
      function showToast(message, tone = "ok") {
        toast.textContent = message;
        toast.classList.remove("hidden");
        toast.style.background = tone === "bad" ? "#ef4444" : "#10b981";
        setTimeout(() => toast.classList.add("hidden"), 3500);
      }

      function resolveRecorder() {
        if (state.user && state.user.email) return state.user.email;
        if (state.user && state.user.uid) return state.user.uid;
        return "unknown";
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-TZ', { style: 'currency', currency: 'TZS', minimumFractionDigits: 0 }).format(amount || 0);
      }

      function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-GB');
      }

      // Calculate school debt till
      function calculateDebtTill(student) {
        // This matches the finance.html logic
        const feePerYear = Number(student.feePerYear) || 0;
        const payments = student.payments || {};
        const totalPaid = Object.values(payments).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
        
        // Simple calculation - in real app, this would match finance.html installment logic
        const debt = Math.max(0, feePerYear - totalPaid);
        return debt > 0 ? `Inst ${Math.min(6, Math.ceil(debt / (feePerYear / 6)))}` : '‚Äî';
      }

      // Calculate base monthly fee (without month multipliers) - for display in table
      function calculateBaseMonthlyFee(amStop, pmStop) {
        const amPrice = amStop ? TransportPricing.priceForStop(amStop) : 0;
        const pmPrice = pmStop ? TransportPricing.priceForStop(pmStop) : 0;
        return amPrice + pmPrice; // Base fee without multipliers
      }

      // Calculate transport payment status
      function calculateTransportStatus(enrollment, payments) {
        const amStop = enrollment.amStop || '';
        const pmStop = enrollment.pmStop || '';
        
        // Base monthly fee (without multipliers) - for display
        const baseMonthlyFee = calculateBaseMonthlyFee(amStop, pmStop);
        
        let totalExpected = 0;
        let totalPaid = 0;
        const unpaidMonths = [];
        
        // Calculate for each month
        for (let month = 1; month <= 12; month++) {
          const monthlyExpected = TransportPricing.expectedForMonth(amStop, pmStop, month);
          totalExpected += monthlyExpected;
          
          // Handle both number and month name formats for payments
          const monthPayments = payments.filter(p => {
            if (typeof p.month === 'number') return p.month === month;
            if (typeof p.month === 'string') return MONTH_NAMES[month] === p.month;
            return false;
          });
          const monthPaid = monthPayments.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
          totalPaid += monthPaid;
          
          if (monthPaid < monthlyExpected && monthlyExpected > 0) {
            unpaidMonths.push(MONTH_NAMES[month]);
          }
        }
        
        const debt = Math.max(0, totalExpected - totalPaid);
        
        // Current month expected (with multiplier) - for KPI calculations
        const currentMonthExpected = TransportPricing.expectedForMonth(amStop, pmStop, state.month);
        
        return {
          totalExpected,
          totalPaid,
          debt,
          unpaidMonths: unpaidMonths.join(', ') || '‚Äî',
          monthlyFee: baseMonthlyFee, // Base fee for table display (e.g., 35,500)
          currentMonthExpected, // Month-specific fee with multiplier for KPIs
        };
      }

      // Render KPIs - only for admin view, not parent view
      function renderKPIs() {
        // Skip if parent view (stat cards already rendered by renderParentTransportPayment)
        const urlParams = new URLSearchParams(window.location.search);
        const studentParam = urlParams.get('student') || localStorage.getItem('parentFocusStudent');
        if (studentParam) {
          return; // Don't render KPIs in parent view
        }
        
        let totalExpected = 0;
        let totalCollected = 0;
        let totalDebt = 0;

        Object.entries(state.transportEnrollments).forEach(([studentId, enrollment]) => {
          const payments = Object.values(state.transportPayments[studentId] || {});
          const status = calculateTransportStatus(enrollment, payments);
          
          // Use currentMonthExpected for KPI (includes month multiplier)
          totalExpected += status.currentMonthExpected;
          totalCollected += status.totalPaid;
          totalDebt += status.debt;
        });

        // Calculate expenses
        const expensesArray = Object.values(state.expenses);
        const totalExpenses = expensesArray.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
        const fuelExp = expensesArray.filter(e => e.category === 'FUEL').reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
        const maintExp = expensesArray.filter(e => e.category === 'MAINTENANCE' || e.category === 'REPAIRS').reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
        const otherExp = totalExpenses - fuelExp - maintExp;

        document.getElementById('totalExpected').textContent = formatCurrency(totalExpected);
        document.getElementById('totalCollected').textContent = formatCurrency(totalCollected);
        document.getElementById('totalDebt').textContent = formatCurrency(totalDebt);
        document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
        document.getElementById('netBalance').textContent = formatCurrency(totalCollected - totalExpenses);
        document.getElementById('monthLabel').textContent = `${MONTH_NAMES[state.month]} ${state.year}`;

        document.getElementById('fuelExpenses').textContent = formatCurrency(fuelExp);
        document.getElementById('maintenanceExpenses').textContent = formatCurrency(maintExp);
        document.getElementById('otherExpenses').textContent = formatCurrency(otherExp);

        // Critical alerts for unpaid students
        const criticalDebtors = Object.entries(state.transportEnrollments)
          .filter(([studentId, enrollment]) => {
            const payments = Object.values(state.transportPayments[studentId] || {});
            const status = calculateTransportStatus(enrollment, payments);
            return status.debt > 0;
          })
          .length;

        if (criticalDebtors > 0) {
          document.getElementById('criticalAlerts').innerHTML = `
            <div class="alert red" style="animation: pulse 2s infinite;">
              <strong>‚ö†Ô∏è ALERT:</strong> ${criticalDebtors} student(s) have unpaid transport fees. 
              Payment deadline is the 27th of each month for the following month.
            </div>
          `;
        } else {
          document.getElementById('criticalAlerts').innerHTML = '';
        }
      }

      // Render payments table
      function renderPaymentsTable() {
        const filterClass = classFilter.value;
        const searchTerm = searchInput.value.toLowerCase();
        const filterStatus = statusFilter.value;
        const yearDelta = state.year - BASE_YEAR;

        const filtered = Object.entries(state.transportEnrollments).filter(([studentId, enrollment]) => {
          const student = state.students[studentId];
          if (!student) return false;

          // Calculate class for selected year
          const baseClass = student.classLevel || '';
          const shiftedClass = shiftClass(baseClass, yearDelta);
          
          // Skip if graduated (for future years)
          if (shiftedClass === 'GRADUATED' && state.year > BASE_YEAR) {
            // Only show if they have transport data for this year
            return false;
          }

          const matchesClass = !filterClass || shiftedClass === filterClass;
          const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.toLowerCase();
          const matchesSearch = !searchTerm || 
            fullName.includes(searchTerm) || 
            (student.admissionNumber || '').toLowerCase().includes(searchTerm);

          const payments = Object.values(state.transportPayments[studentId] || {});
          const status = calculateTransportStatus(enrollment, payments);
          
          let matchesStatus = true;
          if (filterStatus === 'paid') matchesStatus = status.debt === 0;
          if (filterStatus === 'partial') matchesStatus = status.debt > 0 && status.totalPaid > 0;
          if (filterStatus === 'unpaid') matchesStatus = status.totalPaid === 0;

          const matchesDebtFilter = !state.showDebtorsOnly || status.debt > 0;

          return matchesClass && matchesSearch && matchesStatus && matchesDebtFilter;
        });

        if (filtered.length === 0) {
          paymentsBody.innerHTML = '';
          document.getElementById('emptyState').classList.remove('hidden');
          document.getElementById('paymentSummary').textContent = '0 students found';
          return;
        }

        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('paymentSummary').textContent = `${filtered.length} student(s) on transport`;

        // Sort by debt (highest first)
        filtered.sort((a, b) => {
          const paymentsA = Object.values(state.transportPayments[a[0]] || {});
          const paymentsB = Object.values(state.transportPayments[b[0]] || {});
          const statusA = calculateTransportStatus(a[1], paymentsA);
          const statusB = calculateTransportStatus(b[1], paymentsB);
          return statusB.debt - statusA.debt;
        });

        paymentsBody.innerHTML = filtered.map(([studentId, enrollment]) => {
          const student = state.students[studentId];
          const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();
          
          // Calculate class for selected year
          const yearDelta = state.year - BASE_YEAR;
          const baseClass = student.classLevel || '';
          const shiftedClass = shiftClass(baseClass, yearDelta);
          
          const payments = Object.values(state.transportPayments[studentId] || {});
          const transportStatus = calculateTransportStatus(enrollment, payments);
          
          // School finance data
          const feePerYear = Number(student.feePerYear) || 0;
          const schoolPayments = student.payments || {};
          const schoolPaid = Object.values(schoolPayments).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
          const schoolDebt = Math.max(0, feePerYear - schoolPaid);
          const debtTill = calculateDebtTill(student);
          
          // Combined debt
          const combinedDebt = schoolDebt + transportStatus.debt;
          
          // Critical status - red background if has debt
          const isDebtor = transportStatus.debt > 0 || schoolDebt > 0;
          const rowClass = isDebtor ? 'style="background: rgba(239, 68, 68, 0.15); font-weight: 600;"' : '';
          
          const debtWarning = isDebtor ? '<span style="color: var(--accent-danger); font-weight: 800; font-size: 0.75rem;">‚ö†Ô∏è USIMCHUKUE ANADAIWA</span>' : '';
          
          return `
            <tr ${rowClass}>
              <td>${student.admissionNumber || 'N/A'}</td>
              <td>${fullName}${debtWarning ? '<br>' + debtWarning : ''}</td>
              <td>${shiftedClass}</td>
              <td>${formatDate(student.timestamp || student.createdAt)}</td>
              <td>${student.primaryParentContact || 'N/A'}</td>
              <td>${formatCurrency(feePerYear)}</td>
              <td>${formatCurrency(schoolPaid)}</td>
              <td style="color: ${schoolDebt > 0 ? 'var(--accent-danger)' : 'var(--accent-success)'};">
                ${formatCurrency(schoolDebt)}
              </td>
              <td>${debtTill}</td>
              <td>${enrollment.amStop || '‚Äî'}</td>
              <td>${enrollment.pmStop || '‚Äî'}</td>
              <td>${formatCurrency(transportStatus.monthlyFee)}</td>
              <td style="color: var(--accent-success);">${formatCurrency(transportStatus.totalPaid)}</td>
              <td style="color: ${transportStatus.debt > 0 ? 'var(--accent-danger)' : 'var(--accent-success)'};">
                ${formatCurrency(transportStatus.debt)}
              </td>
              <td style="font-size: 0.75rem;">${transportStatus.unpaidMonths}</td>
              <td style="color: ${combinedDebt > 0 ? 'var(--accent-danger)' : 'var(--accent-success)'}; font-weight: 700;">
                ${formatCurrency(combinedDebt)}
              </td>
              <td class="table-actions">
                <button class="btn success" onclick="openPaymentModal('${studentId}')">üíµ Pay</button>
                <button class="btn secondary" onclick="viewPaymentHistory('${studentId}')">üìã History</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Toggle debtors only
      function toggleDebtorsOnly() {
        state.showDebtorsOnly = !state.showDebtorsOnly;
        document.getElementById('debtorsBtnText').textContent = state.showDebtorsOnly ? 'Show All' : 'Show Debtors Only';
        renderPaymentsTable();
      }

      // Open payment modal
      function openPaymentModal(studentId) {
        state.currentPaymentStudentId = studentId;
        const student = state.students[studentId];
        const enrollment = state.transportEnrollments[studentId];
        
        if (!student || !enrollment) return;
        
        const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();
        const payments = Object.values(state.transportPayments[studentId] || {});
        const status = calculateTransportStatus(enrollment, payments);
        
        // Get current month's expected amount (with multiplier)
        const currentMonthAmount = status.currentMonthExpected || status.monthlyFee;
        
        document.getElementById('paymentStudentInfo').innerHTML = `
          <div style="display: grid; gap: 0.5rem; font-size: 0.875rem;">
            <div><strong>Name:</strong> ${fullName}</div>
            <div><strong>Admission No:</strong> ${student.admissionNumber}</div>
            <div><strong>Class:</strong> ${student.classLevel}</div>
            <div><strong>Base Monthly Fee:</strong> ${formatCurrency(status.monthlyFee)}</div>
            <div><strong>Current Month Fee (${MONTH_NAMES[state.month]}):</strong> ${formatCurrency(currentMonthAmount)}</div>
            <div><strong>Total Debt:</strong> <span style="color: var(--accent-danger);">${formatCurrency(status.debt)}</span></div>
            <div><strong>Unpaid Months:</strong> ${status.unpaidMonths}</div>
          </div>
        `;
        
        // Set current month as default
        document.getElementById('paymentMonth').value = state.month;
        document.getElementById('paymentAmount').value = currentMonthAmount;
        document.getElementById('paymentDate').valueAsDate = new Date();
        document.getElementById('paymentReference').value = '';
        document.getElementById('paymentPayerName').value = '';
        document.getElementById('paymentNotes').value = '';
        
        document.getElementById('paymentModal').classList.remove('hidden');
      }

      function closePaymentModal() {
        document.getElementById('paymentModal').classList.add('hidden');
        document.getElementById('paymentAlert').classList.add('hidden');
        state.currentPaymentStudentId = null;
      }

      // Save payment (enhanced: also write to canonical year path)
      async function savePayment() {
        const studentId = state.currentPaymentStudentId;
        const month = parseInt(document.getElementById('paymentMonth').value);
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        const method = document.getElementById('paymentMethod').value;
        const reference = document.getElementById('paymentReference').value.trim();
        const payerName = document.getElementById('paymentPayerName').value.trim();
        const paymentDate = document.getElementById('paymentDate').value;
        const notes = document.getElementById('paymentNotes').value.trim();
        
        // Validate all mandatory fields
        if (!month || !amount || amount <= 0 || !method || !reference || !payerName || !paymentDate) {
          showToast('Please fill in ALL required fields (Month, Amount, Method, Reference, Payer Name, Payment Date)', 'bad');
          return;
        }
        
        try {
          const student = state.students[studentId];
          const enrollment = state.transportEnrollments[studentId];
          if (!student || !enrollment) throw new Error('Student transport enrollment not found.');
          const payments = Object.values(state.transportPayments[studentId] || {});
          const status = calculateTransportStatus(enrollment, payments);
          const recorder = resolveRecorder();
          // Convert payment date to timestamp (local timezone - Africa/Nairobi)
          const paidAt = new Date(paymentDate + 'T12:00:00').getTime();
          const timestamp = Date.now();
          const pendingRef = firebase.database().ref('approvalsPending').push();
          const monthName = MONTH_NAMES[month] || `Month ${month}`;
          const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.replace(/\s+/g, ' ').trim();
          const totalRequired = Number(status.totalExpected || 0);
          const totalPaidBefore = Number(status.totalPaid || 0);
          const newBalance = Math.max(0, totalRequired - Math.min(totalRequired, totalPaidBefore + amount));

          // Also write to transport ledger as pending (for parent view and history)
          const db = firebase.database();
          const year = String(state.year);
          const prefix = window.currentSchoolId ? `schools/${window.currentSchoolId}/` : '';
          const payRef = db.ref(`${prefix}transportLedgers/${year}/${studentId}/payments`).push();
          
          const paymentData = {
            month: monthName,
            amount,
            method,
            ref: reference,
            payerName,
            paidAt,
            notes: notes || null,
            createdBy: state.user ? 'parent' : 'staff',
            createdByUid: state.user?.uid || null,
            approved: false,
            approvedBy: null,
            approvedAt: null,
            timestamp
          };
          
          await payRef.set(paymentData);

          // Canonical write: transportPayments/{year}/{studentId}/{paymentId}
          const canonical = {
            month,
            amount,
            method,
            reference,
            payerName,
            paidAt,
            notes: notes || '',
            status: 'pending',
            createdAt: timestamp
          };
          await db.ref(`transportPayments/${year}/${studentId}`).push(canonical);
          
          // Queue for approval - include payment key for matching
          const queueRef = db.ref(`${prefix}pendingApprovals/transportPayments/${payRef.key}`);
          await queueRef.set({
            year,
            studentId,
            admissionNumber: student.admissionNumber || studentId,
            studentName: fullName,
            parentPhone: student.primaryParentContact || student.primaryContact || student.guardianPhone || '--',
            paymentRef: payRef.key, // Store the ledger payment key for approval matching
            ...paymentData,
            queuedAt: timestamp
          });

          // Legacy approval queue (keep for backward compatibility)
          await pendingRef.set({
            approvalId: pendingRef.key,
            sourceModule: 'transport',
            studentAdm: student.admissionNumber || studentId,
            studentName: fullName || (student.admissionNumber || studentId),
            className: student.classLevel || '',
            parentContact: student.primaryParentContact || student.primaryContact || student.guardianPhone || '--',
            amountPaidNow: amount,
            paymentMethod: method,
            paymentReferenceCode: reference,
            payerName: payerName,
            paymentDate: paymentDate,
            datePaid: paidAt,
            recordedBy: recorder,
            status: 'pending',
            notes,
            totalRequired,
            totalPaidBefore,
            newBalanceAfterThis: newBalance,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            modulePayload: {
              studentKey: studentId,
              payment: {
                studentId,
                month,
                year: state.year,
                amount,
                method,
                reference,
                payerName,
                paidAt,
                notes,
                timestamp,
                recordedBy: recorder,
              },
              breakdown: [
                { label: 'Month', value: monthName },
                { label: 'Year', value: state.year },
                { label: 'Route', value: `${enrollment.amStop || '--'} / ${enrollment.pmStop || '--'}` },
                { label: 'Expected (Year)', value: formatCurrency(status.totalExpected) },
                { label: 'Paid Before', value: formatCurrency(status.totalPaid) },
                { label: 'Debt Before', value: formatCurrency(status.debt) },
              ],
            },
          });

          showToast('Payment pending admin approval.', 'ok');
          closePaymentModal();
          
          // Refresh based on view mode
          const studentParam = localStorage.getItem('parentFocusStudent');
          if (studentParam) {
            // Parent view - reload single student
            renderParentTransportPayment(studentParam);
          } else {
            // Admin view - reload all data
            loadAllData();
          }
        } catch (error) {
          console.error('Error saving payment:', error);
          showToast('Failed to save payment', 'bad');
        }
      }

      // View payment history - with real-time approval status
      async function viewPaymentHistory(studentId) {
        const student = state.students[studentId];
        if (!student) {
          showToast('Student not found', 'bad');
          return;
        }
        
        let payments = state.transportPayments[studentId] || {};
        
        // Handle array or object format
        if (Array.isArray(payments)) {
          payments = payments.sort((a, b) => (b.timestamp || b.paidAt || 0) - (a.timestamp || a.paidAt || 0));
        } else if (payments && typeof payments === 'object') {
          payments = Object.values(payments).sort((a, b) => (b.timestamp || b.paidAt || 0) - (a.timestamp || a.paidAt || 0));
        } else {
          payments = [];
        }
        
        // Also check pendingApprovals to get latest approval status
        const prefix = currentSchoolPrefix();
        try {
          const pendingSnap = await firebase.database().ref(`${prefix}pendingApprovals/transportPayments`).once('value');
          const pendingApprovals = pendingSnap.val() || {};
          
          // Create a map of payment keys to approval status
          const approvalMap = {};
          Object.entries(pendingApprovals).forEach(([key, approval]) => {
            if (approval && approval.studentId === studentId && approval.ref) {
              // Match by reference code for accurate matching
              approvalMap[approval.ref] = {
                approved: false,
                pending: true
              };
            }
          });
          
          // Also check approvalsHistory for approved payments
          const year = String(state.year);
          const historySnap = await firebase.database().ref(`approvalsHistory/${year}`).once('value').catch(() => ({ val: () => null }));
          const history = historySnap.val() || {};
          Object.values(history).forEach(months => {
            Object.values(months || {}).forEach(records => {
              Object.values(records || {}).forEach(record => {
                if (record && record.sourceModule === 'transport' && record.modulePayload?.studentKey === studentId) {
                  const ref = record.paymentReferenceCode || record.modulePayload?.payment?.reference;
                  if (ref) {
                    approvalMap[ref] = {
                      approved: record.finalStatus === 'approved',
                      pending: false
                    };
                  }
                }
              });
            });
          });
          
          // Update payment approval status from map
          payments = payments.map(p => {
            const ref = p.ref || p.reference;
            if (ref && approvalMap[ref]) {
              return {
                ...p,
                approved: approvalMap[ref].approved ? true : (p.approved || false)
              };
            }
            return p;
          });
        } catch (err) {
          console.warn('Error checking approval status:', err);
        }
        
        const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();
        const admissionNo = student.admissionNumber || 'N/A';
        
        // Update modal title
        document.getElementById('historyModalTitle').textContent = `Payment History - ${fullName} (${admissionNo})`;
        
        const historyBody = document.getElementById('historyBody');
        const historyEmpty = document.getElementById('historyEmpty');
        
        if (payments.length === 0) {
          historyBody.innerHTML = '';
          historyEmpty.classList.remove('hidden');
        } else {
          historyEmpty.classList.add('hidden');
          historyBody.innerHTML = payments.map(p => {
            // Check approval status more thoroughly
            const isApproved = p.approved === true || p.approved === 'true' || p.approvedAt || (p.approvedBy && !p.approvedBy.includes('pending'));
            const statusBadge = isApproved 
              ? '<span class="chip ok" style="background: rgba(16, 185, 129, 0.15); color: #86efac; border: 1px solid rgba(16, 185, 129, 0.35); padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700;">‚úÖ Approved</span>'
              : '<span class="chip warn" style="background: rgba(245, 158, 11, 0.15); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.35); padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700;">‚è≥ Pending</span>';
            
            const d = p.paidAt ? new Date(p.paidAt).toLocaleDateString('en-GB') : (p.timestamp ? new Date(p.timestamp).toLocaleDateString('en-GB') : '‚Äî');
            const monthName = typeof p.month === 'number' ? MONTH_NAMES[p.month] : (p.month || '‚Äî');
            const rowColor = isApproved ? 'style="background: rgba(16, 185, 129, 0.05);"' : 'style="background: rgba(245, 158, 11, 0.05);"';
            
            return `<tr ${rowColor}>
              <td style="font-weight: 600;">${d}</td>
              <td>${monthName}</td>
              <td style="color: var(--accent-success); font-weight: 700;">${formatCurrency(p.amount || 0)}</td>
              <td>${p.method || '‚Äî'}</td>
              <td style="font-family: monospace; font-size: 0.875rem;">${p.ref || p.reference || '‚Äî'}</td>
              <td>${p.payerName || '‚Äî'}</td>
              <td>${statusBadge}</td>
              <td style="font-size: 0.875rem; color: var(--text-secondary);">${p.notes || '‚Äî'}</td>
            </tr>`;
          }).join('');
        }
        
        document.getElementById('historyModal').classList.remove('hidden');
      }
      
      function closeHistoryModal() {
        document.getElementById('historyModal').classList.add('hidden');
      }

      // Add expense
      async function addExpense() {
        const category = document.getElementById('expenseCategory').value;
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        const description = document.getElementById('expenseDescription').value;
        
        if (!category || !amount || amount <= 0 || !description) {
          showToast('Please fill in all fields', 'bad');
          return;
        }
        
        try {
          const expense = {
            category,
            amount,
            description,
            timestamp: Date.now(),
            addedBy: state.user.uid,
            year: state.year,
          };
          
          await firebase.database().ref('transport_expenses').push(expense);
          
          showToast('Expense added successfully!');
          document.getElementById('expenseCategory').value = '';
          document.getElementById('expenseAmount').value = '';
          document.getElementById('expenseDescription').value = '';
          loadAllData();
        } catch (error) {
          console.error('Error adding expense:', error);
          showToast('Failed to add expense', 'bad');
        }
      }

      // Render expenses table
      function renderExpensesTable() {
        const expensesBody = document.getElementById('expensesBody');
        const expenses = Object.values(state.expenses)
          .filter(exp => exp.year == state.year)
          .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        
        if (expenses.length === 0) {
          expensesBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No expenses recorded</td></tr>';
          return;
        }
        
        expensesBody.innerHTML = expenses.map(exp => `
          <tr>
            <td>${formatDate(exp.timestamp)}</td>
            <td><span class="chip ${exp.category === 'FUEL' ? 'warn' : exp.category === 'MAINTENANCE' ? 'info' : 'ok'}">${exp.category}</span></td>
            <td>${exp.description}</td>
            <td>${formatCurrency(exp.amount)}</td>
            <td>${exp.addedBy || '‚Äî'}</td>
          </tr>
        `).join('');
      }

      // Export to Excel
      function exportToExcel() {
        const data = Object.entries(state.transportEnrollments).map(([studentId, enrollment]) => {
          const student = state.students[studentId];
          const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();
          
          const payments = Object.values(state.transportPayments[studentId] || {});
          const transportStatus = calculateTransportStatus(enrollment, payments);
          
          const feePerYear = Number(student.feePerYear) || 0;
          const schoolPayments = student.payments || {};
          const schoolPaid = Object.values(schoolPayments).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
          const schoolDebt = Math.max(0, feePerYear - schoolPaid);
          
          return {
            'Admission No': student.admissionNumber,
            'Full Name': fullName,
            'Class': student.classLevel,
            'Parent Contact': student.primaryParentContact,
            'School Fee Total': feePerYear,
            'School Fee Paid': schoolPaid,
            'School Debt': schoolDebt,
            'Morning Route': enrollment.amStop || '‚Äî',
            'Evening Route': enrollment.pmStop || '‚Äî',
            'Monthly Transport Fee': transportStatus.monthlyFee,
            'Transport Paid': transportStatus.totalPaid,
            'Transport Debt': transportStatus.debt,
            'Unpaid Months': transportStatus.unpaidMonths,
            'Total Combined Debt': schoolDebt + transportStatus.debt,
          };
        });
        
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Transport Payments');
        XLSX.writeFile(wb, `transport_payments_${state.year}.xlsx`);
        showToast('Export successful!');
      }

      // Load all data
      async function loadAllData() {
        try {
          const db = firebase.database();
          const year = String(state.year);
          const prefix = currentSchoolPrefix();
          
          // Load students (identity data - constant across years)
          const studentsSnap = await db.ref(`${prefix}students`).once('value');
          state.students = studentsSnap.val() || {};

          // Load transport enrollments - check legacy path first (this is what's actually being used)
          const legacyEnrollSnap = await db.ref(`${prefix}transport_enrollments`).once('value');
          const legacyEnrollments = legacyEnrollSnap.val() || {};
          state.transportEnrollments = {};
          Object.entries(legacyEnrollments).forEach(([studentId, enrollment]) => {
            if (enrollment) {
              state.transportEnrollments[studentId] = enrollment;
            }
          });
          
          // Also check new registry format for year-scoped data
          try {
            const enrollSnap = await db.ref(`${prefix}transportRegistry/${year}`).once('value');
            const registry = enrollSnap.val() || {};
            Object.entries(registry).forEach(([studentId, reg]) => {
              if (reg && reg.using) {
                // Merge with legacy or add new
                if (!state.transportEnrollments[studentId]) {
                  state.transportEnrollments[studentId] = {
                    amStop: reg.routeId || '',
                    pmStop: reg.stopName || '',
                    monthlyFee: reg.monthlyFee || 0
                  };
                }
              }
            });
          } catch (err) {
            console.warn('Could not load transportRegistry:', err);
          }

          // Load transport payments (year-scoped)
          const paymentsData = {};
          const paymentsSnap = await db.ref(`${prefix}transportLedgers/${year}`).once('value');
          const ledgers = paymentsSnap.val() || {};
          Object.entries(ledgers).forEach(([studentId, ledger]) => {
            if (ledger && ledger.payments) {
              paymentsData[studentId] = Object.values(ledger.payments);
            }
          });
          
          // Also check legacy path
          const legacyPaymentsSnap = await db.ref(`${prefix}transport_payments`).once('value');
          const legacyPayments = legacyPaymentsSnap.val() || {};
          Object.entries(legacyPayments).forEach(([studentId, payments]) => {
            if (!paymentsData[studentId]) {
              paymentsData[studentId] = Array.isArray(payments) ? payments : Object.values(payments || {});
            }
          });
          
          state.transportPayments = paymentsData;

          // Load expenses (year-scoped)
          const expensesSnap = await db.ref(`${prefix}transport_expenses`).once('value');
          const allExpenses = expensesSnap.val() || {};
          state.expenses = {};
          Object.entries(allExpenses).forEach(([key, exp]) => {
            if (exp && (exp.year == year || !exp.year)) {
              state.expenses[key] = exp;
            }
          });

          renderKPIs();
          renderPaymentsTable();
          renderExpensesTable();
        } catch (error) {
          console.error('Error loading data:', error);
          showToast('Error loading data', 'bad');
        }
      }

      function refreshData() {
        showToast('Refreshing data...');
        loadAllData();
      }

      // Event listeners
      if (yearSelect) {
        yearSelect.value = state.year;
        yearSelect.addEventListener('change', (e) => {
          state.year = parseInt(e.target.value);
          if (window.somapYearContext) {
            window.somapYearContext.setSelectedYear(String(state.year));
          }
          loadAllData();
        });
      }
      
      // Listen to year context changes
      if (window.somapYearContext) {
        window.somapYearContext.onYearChanged((year) => {
          const newYear = parseInt(year) || state.year;
          if (newYear !== state.year) {
            state.year = newYear;
            if (yearSelect) yearSelect.value = state.year;
            loadAllData();
          }
        });
      }

      classFilter.addEventListener('change', renderPaymentsTable);
      searchInput.addEventListener('input', renderPaymentsTable);
      statusFilter.addEventListener('change', renderPaymentsTable);

      // Update due date display
      const today = new Date();
      const dueDay = 27;
      const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, dueDay);
      document.getElementById('dueDate').textContent = `${dueDay}th ${MONTH_NAMES[nextMonth.getMonth() + 1]} ${nextMonth.getFullYear()}`;

      // Parent transport payment renderer - unified view with existing KPIs and table
      async function renderParentTransportPayment(studentId) {
        try {
          const y = String(state.year);
          const prefix = currentSchoolPrefix();
          
          // Ensure expenses/balance cards are hidden (already done on init, but double-check)
          const expCard = document.getElementById('totalExpenses')?.closest('.stat-card');
          const netCard = document.getElementById('netBalance')?.closest('.stat-card');
          if (expCard) expCard.style.display = 'none';
          if (netCard) netCard.style.display = 'none';
          
          // Hide expenses section completely
          const expSection = document.querySelector('section.card.mt-3:has([id="fuelExpenses"])');
          if (expSection) expSection.style.display = 'none';
          
          // Get parent phone (parents logged in via index.html with studentKey)
          const parentPhone = normalizePhone(localStorage.getItem('parentPhone') || '');
        
        // Load ONLY this specific student's data (fast!)
        // Use same data source as admin view (transportLedgers)
        const [sSnap, enrollSnap, ledSnap, legacySnap, finSnap] = await Promise.all([
          firebase.database().ref(`${prefix}students/${studentId}`).once('value'),
          firebase.database().ref(`${prefix}transport_enrollments/${studentId}`).once('value').catch(() => ({ val: () => null })),
          firebase.database().ref(`${prefix}transportLedgers/${y}/${studentId}/payments`).once('value').catch(() => ({ val: () => null })),
          firebase.database().ref(`${prefix}transport_payments/${studentId}`).once('value').catch(() => ({ val: () => null })),
          firebase.database().ref(`${prefix}finance/${y}/${studentId}/payments`).once('value').catch(() => ({ val: () => null }))
        ]);
        
        const S = sSnap.val() || {};
        const enrollment = enrollSnap.val() || {};
        let pays = ledSnap.val() || {};
        
        // Also check legacy path if no data in new path
        if (!pays || (typeof pays === 'object' && Object.keys(pays).length === 0)) {
          const legacyPays = legacySnap.val() || {};
          if (legacyPays && typeof legacyPays === 'object') {
            pays = Object.values(legacyPays);
          } else {
            pays = legacyPays;
          }
        } else {
          // New format - convert to array
          if (typeof pays === 'object' && !Array.isArray(pays)) {
            pays = Object.values(pays);
          }
        }
        
        const schoolPayments = finSnap.val() || {};
        
        // Ensure pays is an array
        if (!Array.isArray(pays)) {
          pays = pays ? [pays] : [];
        }
        
        // Verify parent owns student (but don't block if no phone match - parents already authenticated)
        const studentPhone = normalizePhone(S.motherPhone || S.parentPhone || S.primaryParentContact || '');
        if (parentPhone && parentPhone !== studentPhone) {
          alert('Access denied. This child is not linked to your account.');
          window.location.href = 'parent.html';
          return;
        }
        
        // Check if using transport
        if (!enrollment) {
          alert('This child is not using transport for the selected year.');
          window.location.href = 'parent.html';
          return;
        }
        
        // Populate state so modal functions work
        state.students[studentId] = S;
        state.transportEnrollments[studentId] = enrollment;
        state.transportPayments[studentId] = pays;
        
        // Calculate class for year
        const yearDelta = state.year - BASE_YEAR;
        const baseClass = S.classLevel || '';
        const shiftedClass = shiftClass(baseClass, yearDelta);
        
        const fullName = `${S.firstName || ''} ${S.middleName || ''} ${S.lastName || ''}`.replace(/\s+/g, ' ').trim() || '‚Äî';
        
        // Get base monthly fee (without multipliers) for display
        const amStop = enrollment.amStop || '';
        const pmStop = enrollment.pmStop || '';
        const baseMonthlyFee = calculateBaseMonthlyFee(amStop, pmStop);
        const currentMonthExpected = TransportPricing.expectedForMonth(amStop, pmStop, state.month);
        
        // Calculate debt - for parent view show all payments (approved or pending)
        // Use the same logic as calculateTransportStatus for consistency
        let totalExpected = 0;
        let totalPaid = 0;
        const unpaidMonths = [];
        
        for (let month = 1; month <= 12; month++) {
          const monthlyExpected = TransportPricing.expectedForMonth(amStop, pmStop, month);
          totalExpected += monthlyExpected;
          
          const monthPayments = pays.filter(p => {
            if (!p || !p.month) return false;
            if (typeof p.month === 'number') return p.month === month;
            if (typeof p.month === 'string') return MONTH_NAMES[month] === p.month;
            return false;
          });
          const monthPaid = monthPayments.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
          totalPaid += monthPaid;
          
          if (monthPaid < monthlyExpected && monthlyExpected > 0) {
            unpaidMonths.push(MONTH_NAMES[month]);
          }
        }
        
        const debt = Math.max(0, totalExpected - totalPaid);
        
        // Render KPIs for THIS child only - show current month expected in KPI
        // Update stat cards directly with the child's data
        const totalExpectedEl = document.getElementById('totalExpected');
        const totalCollectedEl = document.getElementById('totalCollected');
        const totalDebtEl = document.getElementById('totalDebt');
        const monthLabelEl = document.getElementById('monthLabel');
        
        if (totalExpectedEl) {
          totalExpectedEl.textContent = formatCurrency(currentMonthExpected);
          totalExpectedEl.style.opacity = '1';
        }
        if (totalCollectedEl) {
          totalCollectedEl.textContent = formatCurrency(totalPaid);
          totalCollectedEl.style.opacity = '1';
        }
        if (totalDebtEl) {
          totalDebtEl.textContent = formatCurrency(debt);
          totalDebtEl.style.opacity = '1';
        }
        if (monthLabelEl) {
          monthLabelEl.textContent = `${MONTH_NAMES[state.month]} ${state.year}`;
        }
        
        // Ensure expense/balance cards stay hidden
        const expCardFinal = document.getElementById('totalExpenses')?.closest('.stat-card');
        const netCardFinal = document.getElementById('netBalance')?.closest('.stat-card');
        if (expCardFinal) expCardFinal.style.display = 'none';
        if (netCardFinal) netCardFinal.style.display = 'none';
        
        // Calculate school fees
        const feePerYear = Number(S.feePerYear || 0);
        const schoolPaid = Object.values(schoolPayments).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
        const schoolDebt = Math.max(0, feePerYear - schoolPaid);
        const combinedDebt = schoolDebt + debt;
        
        // Render table with THIS child only (using existing table structure)
        paymentsBody.innerHTML = `
          <tr style="background: ${debt > 0 ? 'rgba(239, 68, 68, 0.15);' : 'rgba(16, 185, 129, 0.15);'} font-weight: 600;">
            <td>${S.admissionNumber || 'N/A'}</td>
            <td>${fullName}${debt > 0 ? '<br><span style="color: var(--accent-danger); font-weight: 800; font-size: 0.75rem;">‚ö†Ô∏è USIMCHUKUE ANADAIWA</span>' : ''}</td>
            <td>${shiftedClass}</td>
            <td>${formatDate(S.timestamp || S.createdAt)}</td>
            <td>${studentPhone || 'N/A'}</td>
            <td>${formatCurrency(feePerYear)}</td>
            <td>${formatCurrency(schoolPaid)}</td>
            <td style="color: ${schoolDebt > 0 ? 'var(--accent-danger)' : 'var(--accent-success)'};">${formatCurrency(schoolDebt)}</td>
            <td>${calculateDebtTill(S)}</td>
            <td>${enrollment.amStop || '‚Äî'}</td>
            <td>${enrollment.pmStop || '‚Äî'}</td>
            <td>${formatCurrency(baseMonthlyFee)}</td>
            <td style="color: var(--accent-success);">${formatCurrency(totalPaid)}</td>
            <td style="color: ${debt > 0 ? 'var(--accent-danger)' : 'var(--accent-success)'};">${formatCurrency(debt)}</td>
            <td style="font-size: 0.75rem;">${unpaidMonths.length ? unpaidMonths.join(', ') : '‚Äî'}</td>
            <td style="color: ${combinedDebt > 0 ? 'var(--accent-danger)' : 'var(--accent-success)'}; font-weight: 700;">${formatCurrency(combinedDebt)}</td>
            <td class="table-actions">
              <button class="btn success" onclick="openPaymentModal('${studentId}')">üíµ Pay</button>
              <button class="btn secondary" onclick="viewPaymentHistory('${studentId}')">üìã History</button>
            </td>
          </tr>
        `;
        
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('paymentSummary').textContent = '1 student on transport';
        
        // Hide search/filter controls
        if (classFilter) classFilter.style.display = 'none';
        if (searchInput) searchInput.style.display = 'none';
        if (statusFilter) statusFilter.style.display = 'none';
        const debtorsBtn = document.getElementById('debtorsBtnText')?.parentElement;
        if (debtorsBtn) debtorsBtn.style.display = 'none';
        } catch (error) {
          console.error('Error in renderParentTransportPayment:', error);
          showToast('Error loading student data', 'bad');
          // Still show error in stat cards
          const totalExpectedEl = document.getElementById('totalExpected');
          const totalCollectedEl = document.getElementById('totalCollected');
          const totalDebtEl = document.getElementById('totalDebt');
          if (totalExpectedEl) totalExpectedEl.textContent = 'Error';
          if (totalCollectedEl) totalCollectedEl.textContent = 'Error';
          if (totalDebtEl) totalDebtEl.textContent = 'Error';
        }
      }

      // Year-scoped single-student renderer (strict; never switch student)
      function monthName(num){ return MONTH_NAMES[num] || ''; }
      async function loadTransportContextStrict(year, studentId){
        const db = firebase.database();
        const [assignSnap, paysSnap, financeSnap, studentSnap] = await Promise.all([
          db.ref(`transportAssignments/${year}/${studentId}`).once('value'),
          db.ref(`transportPayments/${year}/${studentId}`).once('value'),
          db.ref(`financeLedgers/${year}/${studentId}/payments`).once('value'),
          db.ref(`students/${studentId}`).once('value')
        ]);
        const assign = assignSnap.val() || null;
        const payments = Object.values(paysSnap.val()||{}).map(x=>({
          month:Number(x.month)||0, amount:Number(x.amount)||0, status:x.status||'pending'
        }));
        const finance = Object.values(financeSnap.val()||{});
        const schoolFeePaid = finance.reduce((a,p)=>a+(Number(p.amount)||0),0);
        const student = studentSnap.val() || {};
        return { assign, payments, schoolFeePaid, student };
      }

      function setText(sel, txt){ const el=document.querySelector(sel); if(el) el.textContent=txt; }
      function renderIdentityStrict(S){
        const fullName = `${S.firstName||''} ${S.middleName||''} ${S.lastName||''}`.replace(/\s+/g,' ').trim();
        // Use table header summary for identity context
        document.getElementById('paymentSummary').textContent = fullName ? `Payments for ${fullName}` : '';
      }
      function renderNoDataStrict(msg){
        document.getElementById('totalExpected').textContent = '‚Äî';
        document.getElementById('totalCollected').textContent = '‚Äî';
        document.getElementById('totalDebt').textContent = '‚Äî';
        const tbody = document.getElementById('paymentsBody');
        if (tbody) tbody.innerHTML = '';
        const empty = document.getElementById('emptyState');
        if (empty) { empty.textContent = msg || 'No data'; empty.classList.remove('hidden'); }
      }

      async function renderYearScopedStudentView(studentId){
        const year = String(state.year);
        const { assign, payments, schoolFeePaid, student } = await loadTransportContextStrict(year, studentId);
        renderIdentityStrict(student);
        if (!assign || assign.status !== 'Using'){
          renderNoDataStrict(`No transport assignment for ${year}.`);
          return;
        }
        const base = Number(assign.baseMonthlyFee)||0;
        const startDate = assign.startDate || `${year}-01-01`;
        const ledger = TransportPricing.buildLedger({ year: Number(year), baseMonthlyFee: base, startDate, payments });

        const now = new Date();
        const currentMonth = (now.getFullYear()===Number(year)) ? (now.getMonth()+1) : 1;
        const dueThisMonth = TransportPricing.dueForMonth({ year:Number(year), month:currentMonth, baseMonthlyFee: base, startDate });

        document.getElementById('totalExpected').textContent = formatCurrency(Math.round(dueThisMonth));
        document.getElementById('totalCollected').textContent = formatCurrency(Math.round(ledger.totals.paid));
        document.getElementById('totalDebt').textContent = formatCurrency(Math.round(ledger.totals.balance));
        document.getElementById('monthLabel').textContent = `${MONTH_NAMES[currentMonth]} ${year}`;

        // School fee alignment
        // Note: only show value; the rest of school columns are fed from student rows
        // We will update the single-row table to reflect school fee paid from finance ledger

        const unpaid = ledger.months.filter(m=>m.status==='UNPAID'||m.status==='PARTIAL').map(m=>MONTH_NAMES[m.month]).join(', ') || '‚Äî';

        const tbody = document.getElementById('paymentsBody');
        if (tbody){
          const fullName = `${student.firstName||''} ${student.middleName||''} ${student.lastName||''}`.replace(/\s+/g,' ').trim();
          const schoolPaid = schoolFeePaid;
          const feePerYear = Number(student.feePerYear)||0;
          const schoolDebt = Math.max(0, feePerYear - schoolPaid);
          const combinedDebt = Math.max(0, schoolDebt + ledger.totals.balance);
          const rowClass = (combinedDebt>0) ? 'style="background: rgba(239, 68, 68, 0.15); font-weight: 600;"' : '';
          tbody.innerHTML = `
            <tr ${rowClass}>
              <td>${student.admissionNumber || 'N/A'}</td>
              <td>${fullName}</td>
              <td>${student.classLevel || '‚Äî'}</td>
              <td>${formatDate(student.timestamp || student.createdAt)}</td>
              <td>${student.primaryParentContact || 'N/A'}</td>
              <td>${formatCurrency(feePerYear)}</td>
              <td id="__schoolPaidCell">${formatCurrency(schoolPaid)}</td>
              <td style="color: ${schoolDebt>0?'var(--accent-danger)':'var(--accent-success)'};">${formatCurrency(schoolDebt)}</td>
              <td>‚Äî</td>
              <td>${assign.morningRouteId || '‚Äî'}</td>
              <td>${assign.eveningRouteId || '‚Äî'}</td>
              <td>${formatCurrency(base)}</td>
              <td style="color: var(--accent-success);">${formatCurrency(ledger.totals.paid)}</td>
              <td style="color: ${ledger.totals.balance>0?'var(--accent-danger)':'var(--accent-success)'};">${formatCurrency(ledger.totals.balance)}</td>
              <td style="font-size: 0.75rem;">${unpaid}</td>
              <td style="color: ${combinedDebt>0?'var(--accent-danger)':'var(--accent-success)'}; font-weight: 700;">${formatCurrency(combinedDebt)}</td>
              <td class="table-actions">
                <button class="btn success" onclick="openPaymentModal('${studentId}')">üíµ Pay</button>
                <button class="btn secondary" onclick="viewPaymentHistory('${studentId}')">üìã History</button>
              </td>
            </tr>`;
          document.getElementById('emptyState').classList.add('hidden');
          document.getElementById('paymentSummary').textContent = '1 student on transport';
        }
      }

      // Check for parent/single-student view IMMEDIATELY
      const urlParams = new URLSearchParams(window.location.search);
      const studentParam = urlParams.get('student') || localStorage.getItem('parentFocusStudent');
      const yearParam = urlParams.get('year');
      
      // Initialize year from URL or context
      if (yearParam) {
        state.year = parseInt(yearParam) || state.year;
      } else if (window.somapYearContext) {
        const currentYear = window.somapYearContext.getSelectedYear();
        if (currentYear) state.year = parseInt(currentYear) || state.year;
      }
      if (yearSelect && state.year) yearSelect.value = state.year;
      
      if (studentParam) {
        // Parent view mode - render immediately without waiting for auth
        localStorage.setItem('parentFocusStudent', studentParam);
        state.currentPaymentStudentId = studentParam;
        
        // Hide expense/balance cards IMMEDIATELY for parent view
        const expensesCard = document.getElementById('totalExpenses')?.closest('.stat-card');
        const netBalanceCard = document.getElementById('netBalance')?.closest('.stat-card');
        if (expensesCard) expensesCard.style.display = 'none';
        if (netBalanceCard) netBalanceCard.style.display = 'none';
        
        // Hide expenses section completely
        const expensesSection = document.querySelector('section.card.mt-3:has([id="fuelExpenses"])');
        if (expensesSection) expensesSection.style.display = 'none';
        
        // Change back button to go to parent.html
        const backBtn = document.getElementById('backButton');
        if (backBtn) {
          backBtn.href = '../parent.html';
          backBtn.textContent = '‚Üê Back to Parent Dashboard';
        }
        
        // Initialize stat cards with loading state to prevent flashing
        const totalExpectedEl = document.getElementById('totalExpected');
        const totalCollectedEl = document.getElementById('totalCollected');
        const totalDebtEl = document.getElementById('totalDebt');
        const monthLabelEl = document.getElementById('monthLabel');
        
        if (totalExpectedEl) totalExpectedEl.textContent = 'Loading...';
        if (totalCollectedEl) totalCollectedEl.textContent = 'Loading...';
        if (totalDebtEl) totalDebtEl.textContent = 'Loading...';
        if (monthLabelEl) monthLabelEl.textContent = '';
        
        // Load and render immediately using strict year-scoped data
        renderYearScopedStudentView(studentParam).catch(err => {
          console.error('Error rendering parent transport payment:', err);
          if (totalExpectedEl) totalExpectedEl.textContent = 'Error';
          if (totalCollectedEl) totalCollectedEl.textContent = 'Error';
          if (totalDebtEl) totalDebtEl.textContent = 'Error';
        });
      } else {
        // No student param: resolve parent context automatically
        const backBtn = document.getElementById('backButton');
        if (backBtn) { backBtn.href = '../parent.html'; backBtn.textContent = '‚Üê Back to Parent Dashboard'; }

        const tryResolveAndRender = async (user) => {
          try {
            // Try local sources first
            let sid = localStorage.getItem('parentFocusStudent')
              || localStorage.getItem('parent_student')
              || localStorage.getItem('studentKey');
            if (sid) {
              state.currentPaymentStudentId = sid;
              await renderYearScopedStudentView(sid);
              return;
            }
            // Try phone mapping to students
            const phone = (user && user.phoneNumber) ? String(user.phoneNumber).replace(/\D/g,'') : (localStorage.getItem('parentPhone')||'');
            const normPhone = phone ? phone.replace(/\D/g,'') : '';
            if (normPhone) {
              const snap = await firebase.database().ref('students').once('value');
              const all = snap.val() || {};
              const matches = Object.entries(all).filter(([k,v]) => {
                const sp = String(v?.primaryParentContact||v?.parentPhone||'').replace(/\D/g,'');
                return sp && sp.endsWith(normPhone);
              });
              if (matches.length) {
                // Prefer a child with an assignment in the selected year
                const year = String(state.year);
                let picked = null;
                for (const [kid] of matches) {
                  const a = await firebase.database().ref(`transportAssignments/${year}/${kid}`).once('value');
                  if (a.exists()) { picked = kid; break; }
                }
                if (!picked) {
                  // fallback: pick the most recently created student
                  matches.sort((a,b)=> (Number(b[1]?.timestamp||0) - Number(a[1]?.timestamp||0)));
                  picked = matches[0][0];
                }
                sid = picked;
                localStorage.setItem('parentFocusStudent', sid);
                state.currentPaymentStudentId = sid;
                await renderYearScopedStudentView(sid);
                return;
              }
            }
            // Fallback: show friendly message
            renderNoDataStrict('No child found for your account for this year.');
          } catch (e) {
            console.error('Parent resolve error', e);
            renderNoDataStrict('Unable to load transport information.');
          }
        };

        const totalExpectedEl = document.getElementById('totalExpected');
        const totalCollectedEl = document.getElementById('totalCollected');
        const totalDebtEl = document.getElementById('totalDebt');
        if (totalExpectedEl) totalExpectedEl.textContent = 'Loading...';
        if (totalCollectedEl) totalCollectedEl.textContent = 'Loading...';
        if (totalDebtEl) totalDebtEl.textContent = 'Loading...';

        // Use auth state if available, else attempt without
        const current = firebase.auth().currentUser;
        if (current) {
          tryResolveAndRender(current);
        } else {
          firebase.auth().onAuthStateChanged((user) => {
            if (!user) { tryResolveAndRender(null); return; }
            tryResolveAndRender(user);
          });
        }
      }
      
      // Listen to year changes for parent view
      if (window.somapYearContext) {
        window.somapYearContext.onYearChanged((year) => {
          const studentId = state.currentPaymentStudentId || localStorage.getItem('parentFocusStudent');
          const urlParams = new URLSearchParams(window.location.search);
          const studentParam = urlParams.get('student') || localStorage.getItem('parentFocusStudent');
          if (studentParam) {
            const newYear = parseInt(year) || state.year;
            state.year = newYear;
            renderYearScopedStudentView(studentId || studentParam);
          }
        });
      }
    </script>
  </body>
</html>
