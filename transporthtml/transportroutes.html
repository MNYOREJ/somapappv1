<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transport Routes & Pricing Management ¬∑ SoMAp</title>
  <link rel="stylesheet" href="./css/transport_dark.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  </script>
  <script>
    // Year selector constants
    const SOMAP_ALLOWED_YEARS = Array.from({length: 20}, (_,i)=>2023+i); // 2023..2042
    const SOMAP_DEFAULT_YEAR = 2025;

    // Reuse shared year context if present, else create a light fallback
    window.somapYearContext = window.somapYearContext || (function(){
      let selected = (sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR) + '';
      const listeners = new Set();
      return {
        getSelectedYear(){ return selected; },
        setSelectedYear(y){
          y = String(y);
          if (selected === y) return;
          selected = y;
          try{ sessionStorage.setItem('somap_selected_year', y); }catch{}
          listeners.forEach(fn=>{ try{ fn(y); }catch{} });
        },
        onYearChanged(fn){ if (typeof fn==='function') listeners.add(fn); }
      };
    })();
  </script>
  <script src="./modules/transport_pricing.js"></script>
</head>
<body>
  <!-- Context Bar with Year Selection -->
  <div id="contextBar" class="bar">
    <div>
      <h1>üó∫Ô∏è Routes & Pricing Management</h1>
      <small>Manage transport stops, routes, and monthly multipliers</small>
    </div>
    <div class="context-selectors">
      <div id="somapYearWrap" style="display:flex;gap:.5rem;align-items:center;">
        <label style="font-size: 0.75rem; font-weight: 600;">Academic Year</label>
        <select data-somap-year-select class="border rounded px-2 py-1 text-sm" style="min-width: 100px; padding: 0.5rem;"></select>
        <span style="font-size: 0.75rem; color: #94a3b8;">Working year: <b id="somapYearHint">--</b></span>
      </div>
      <a href="transport.html" class="btn secondary">‚Üê Back to Dashboard</a>
    </div>
  </div>

  <main>
    <!-- Stops & Base Fees Section -->
    <section class="card">
      <div class="flex space center mb-2">
        <div>
          <h2 style="margin: 0;">üöè Stops & Base Monthly Fees (<span id="yrA">‚Äî</span>)</h2>
          <p class="muted" style="margin: 0.5rem 0 0 0;">Manage transport stops and their base monthly pricing</p>
        </div>
        <div class="flex">
          <input id="stopSearch" type="text" placeholder="Search stop..." style="max-width: 200px;" />
          <button class="btn" id="bulkImportBtn" style="background: rgba(147, 51, 234, 0.2); color: #a78bfa; border: 1px solid rgba(147, 51, 234, 0.3);">üöÄ Import All Years</button>
          <button class="btn" id="migrateLegacyBtn" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3);">üì¶ Import This Year</button>
          <button class="btn success" id="addStopBtn">+ Add Stop</button>
        </div>
      </div>
      
      <div id="stopsList" class="grid two" style="margin-top: 1.5rem; gap: 1rem;">
        <!-- Populated by JavaScript -->
      </div>
      <div id="emptyStops" class="empty hidden">No stops found for this year. Click a button above to import routes.</div>
    </section>

    <!-- Monthly Multipliers Section -->
    <section class="card mt-3">
      <div class="flex space center mb-2">
        <div>
          <h2 style="margin: 0;">üìÜ Monthly Multipliers (<span id="yrB">‚Äî</span>)</h2>
          <p class="muted" style="margin: 0.5rem 0 0 0;">Base Fee √ó Multiplier = Actual Monthly Fee</p>
        </div>
        <button class="btn success" id="saveMultBtn">üíæ Save</button>
      </div>
      
      <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
        <div id="multGrid" style="display: contents;">
          <!-- Populated by JavaScript -->
        </div>
      </div>
      
      <details style="margin-top: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.15);">
        <summary style="cursor: pointer; font-size: 0.875rem; font-weight: 600; color: var(--text-primary);">‚ÑπÔ∏è How Multipliers Work</summary>
        <p style="margin: 0.75rem 0 0 0; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5;">
          <strong>Formula:</strong> Monthly Fee = Base Fee √ó Multiplier<br/>
          <strong>Example:</strong> Base TSh 20,000 √ó Jan 1.5 = TSh 30,000<br/>
          <strong>Holidays:</strong> Set to 0 for months with no payment (June, December)
        </p>
      </details>
    </section>
  </main>

  <!-- Edit Stop Modal -->
  <div id="editStopModal" class="modal hidden">
    <div class="modal-content">
      <div class="flex space center mb-2">
        <h2 style="margin: 0;" id="editStopTitle">Edit Stop</h2>
        <button class="btn secondary" id="closeEditStopModal">Close</button>
      </div>

      <div style="display: grid; gap: 1rem; margin-top: 1.5rem;">
        <div>
          <label for="editStopName">Stop Name <span style="color: red;">*</span></label>
          <input id="editStopName" type="text" placeholder="e.g., Sinoni, Dampo, etc." required />
        </div>

        <div>
          <label for="editStopFee">Base Monthly Fee (TSh) <span style="color: red;">*</span></label>
          <input id="editStopFee" type="number" min="0" step="500" placeholder="e.g., 18500" required />
        </div>

        <div>
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input id="editStopActive" type="checkbox" />
            <span>Active (students can be assigned to this stop)</span>
          </label>
        </div>
      </div>

      <div class="flex mt-2" style="justify-content: flex-end; gap: 1rem;">
        <button class="btn secondary" id="cancelEditStop">Cancel</button>
        <button class="btn success" id="saveEditStop">üíæ Save Stop</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    const db = firebase.database();
    const months = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    
    let currentEditStopId = null;
    let multInputs = {};

    const toast = document.getElementById("toast");
    const stopsList = document.getElementById("stopsList");
    const emptyStops = document.getElementById("emptyStops");
    const addStopBtn = document.getElementById("addStopBtn");
    const bulkImportBtn = document.getElementById("bulkImportBtn");
    const migrateLegacyBtn = document.getElementById("migrateLegacyBtn");
    const stopSearch = document.getElementById("stopSearch");
    const editStopModal = document.getElementById("editStopModal");
    const closeEditStopModal = document.getElementById("closeEditStopModal");
    const saveEditStop = document.getElementById("saveEditStop");
    const cancelEditStop = document.getElementById("cancelEditStop");
    const saveMultBtn = document.getElementById("saveMultBtn");

    // Legacy routes from the old hardcoded system
    const LEGACY_ROUTES = [
      { names: ['jirani na shule','mazengo','mbezi','msikitini','mlimani rc','uswahilini kanisani','international','kona dampo','mauwa','mwisho wa fensi','ghati','mnara wa halotel'], price: 17000 },
      { names: ['sinoni','kidemi','soko mjinga','mnara wa voda','mbugani kwenye lami tu'], price: 18500 },
      { names: ['glorious','ushirika','tanga kona','njia mtoni','kaburi moja','kwa malaika','savanna','dampo','darajani','kikwete road','boma kubwa','kiwetu pazuri','umoja road','njiro ndogo','king david'], price: 21000 },
      { names: ['chavda','matokeo','milano','jamhuri','felix mrema','lemara','bonisite','intel','patel','terrati','si mbaoil'], price: 24000 },
      { names: ['mapambazuko','mkono wa madukani','soweto','mianzini barabarani','eliboru jr','green valley','country coffee','maua','pepsi','majengo'], price: 25000 },
      { names: ['sanawari','sekei','shabani','kimandolu','kijenge','mkono wa shuleni'], price: 28000 },
      { names: ['suye','moshono','nado','mwanama reli','kisongo'], price: 38000 },
      { names: ['kiserian','chekereni','duka bovu','tengeru','ngulelo','kwamrefu','shangarai atomic'], price: 44000 }
    ];

    function showToast(message, tone = "ok") {
      toast.textContent = message;
      toast.classList.remove("hidden");
      toast.style.background = tone === "bad" ? "#ef4444" : "#10b981";
      setTimeout(() => toast.classList.add("hidden"), 3500);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-TZ', { style: 'currency', currency: 'TZS', minimumFractionDigits: 0 }).format(amount || 0);
    }

    // Initialize year selector
    (function initYearSel(){
      const sel = document.querySelector('[data-somap-year-select]');
      const hint = document.getElementById('somapYearHint');
      if (!sel) return;
      sel.innerHTML = SOMAP_ALLOWED_YEARS.map(y=>`<option value="${y}">${y}</option>`).join('');
      const cur = window.somapYearContext.getSelectedYear();
      sel.value = cur;
      if (hint) hint.textContent = cur;
      sel.addEventListener('change', e=>{
        const y = String(e.target.value);
        window.somapYearContext.setSelectedYear(y);
        if (hint) hint.textContent = y;
      });
    })();

    // Render main UI
    async function render(){
      const year = Number(window.somapYearContext.getSelectedYear() || SOMAP_DEFAULT_YEAR);
      document.getElementById('yrA').textContent = year;
      document.getElementById('yrB').textContent = year;

      // Load stops
      const stops = await TransportPricing.loadStopsForYear(year);
      drawStops(stops, year);

      // Load multipliers
      const mult = await TransportPricing.loadYearMultipliers(year);
      drawMultipliers(mult);
    }

    function drawStops(stops, year){
      const q = (stopSearch.value || '').toLowerCase().trim();
      
      // Remove duplicates by name (case-insensitive)
      const uniqueStops = [];
      const seenNames = new Set();
      
      stops.forEach(s => {
        const normalizedName = s.name.toLowerCase().trim();
        if (!seenNames.has(normalizedName)) {
          seenNames.add(normalizedName);
          uniqueStops.push(s);
        }
      });
      
      const filtered = !q ? uniqueStops : uniqueStops.filter(s => s.name.toLowerCase().includes(q));

      if (filtered.length === 0) {
        stopsList.innerHTML = '';
        emptyStops.classList.remove('hidden');
        return;
      }

      emptyStops.classList.add('hidden');

      // Sort stops by name
      filtered.sort((a, b) => a.name.localeCompare(b.name));

      stopsList.innerHTML = filtered.map(s => {
        const statusBadge = s.active 
          ? '<span class="chip ok" style="font-size: 0.75rem;">Active</span>'
          : '<span class="chip warn" style="font-size: 0.75rem;">Inactive</span>';
        
        return `
          <div class="card" data-id="${s.id}" style="position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
              <h3 style="margin: 0; font-size: 1.125rem;">${s.name}</h3>
              ${statusBadge}
            </div>
            <div style="font-size: 1.25rem; font-weight: 700; color: var(--accent-success); margin-bottom: 1rem;">
              ${formatCurrency(s.baseFee)}
              <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: 400;">/month</span>
            </div>
            <div class="flex" style="gap: 0.5rem;">
              <button class="btn secondary" data-act="edit" data-id="${s.id}" style="flex: 1;">‚úèÔ∏è Edit</button>
              <button class="btn" data-act="toggle" data-id="${s.id}" style="flex: 1;">
                ${s.active ? 'üö´ Deactivate' : '‚úÖ Activate'}
              </button>
              <button class="btn" data-act="del" data-id="${s.id}" style="background: rgba(239, 68, 68, 0.2); color: #f87171;">
                üóëÔ∏è
              </button>
            </div>
          </div>
        `;
      }).join('');

      // Attach event listeners
      stopsList.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const act = e.target.dataset.act;
          const id = e.target.dataset.id;
          
          if (act === 'edit') {
            const stop = filtered.find(s => s.id === id);
            if (stop) openEditStopModal(stop, year);
          } else if (act === 'toggle') {
            const stop = filtered.find(s => s.id === id);
            if (stop) await toggleStopActive(id, !stop.active, year);
          } else if (act === 'del') {
            if (confirm('Are you sure you want to delete this stop? This action cannot be undone.')) {
              await deleteStop(id, year);
            }
          }
        });
      });
    }

    function openEditStopModal(stop, year) {
      currentEditStopId = stop ? stop.id : null;
      document.getElementById('editStopTitle').textContent = stop ? 'Edit Stop' : 'Add New Stop';
      document.getElementById('editStopName').value = stop ? stop.name : '';
      document.getElementById('editStopFee').value = stop ? stop.baseFee : '';
      document.getElementById('editStopActive').checked = stop ? stop.active : true;
      editStopModal.classList.remove('hidden');
    }

    async function saveStop() {
      const name = document.getElementById('editStopName').value.trim();
      const fee = parseFloat(document.getElementById('editStopFee').value);
      const active = document.getElementById('editStopActive').checked;

      if (!name) {
        showToast('Please enter stop name', 'bad');
        return;
      }

      if (!fee || fee < 0) {
        showToast('Please enter a valid base fee', 'bad');
        return;
      }

      const year = Number(window.somapYearContext.getSelectedYear() || SOMAP_DEFAULT_YEAR);

      try {
        const stopData = {
          name,
          baseFee: fee,
          active,
          updatedAt: Date.now()
        };

        if (currentEditStopId) {
          // Update existing
          await db.ref(`transportCatalog/${year}/stops/${currentEditStopId}`).update(stopData);
          showToast('Stop updated successfully!');
        } else {
          // Create new
          const newRef = db.ref(`transportCatalog/${year}/stops`).push();
          await newRef.set({
            ...stopData,
            createdAt: Date.now()
          });
          showToast('Stop created successfully!');
        }

        editStopModal.classList.add('hidden');
        render();
      } catch (error) {
        console.error('Error saving stop:', error);
        showToast('Failed to save stop', 'bad');
      }
    }

    async function toggleStopActive(id, active, year) {
      try {
        await db.ref(`transportCatalog/${year}/stops/${id}`).update({
          active,
          updatedAt: Date.now()
        });
        showToast(`Stop ${active ? 'activated' : 'deactivated'} successfully!');
        render();
      } catch (error) {
        console.error('Error toggling stop:', error);
        showToast('Failed to update stop', 'bad');
      }
    }

    async function deleteStop(id, year) {
      try {
        await db.ref(`transportCatalog/${year}/stops/${id}`).remove();
        showToast('Stop deleted successfully!');
        render();
      } catch (error) {
        console.error('Error deleting stop:', error);
        showToast('Failed to delete stop', 'bad');
      }
    }

    function drawMultipliers(mult) {
      multInputs = {};
      const grid = document.getElementById('multGrid');
      
      grid.innerHTML = months.slice(1).map((label, idx) => {
        const m = idx + 1;
        const v = mult[m] ?? TransportPricing.DEFAULT_MULTIPLIERS[m] ?? 1.0;
        const id = 'mm_' + m;
        multInputs[m] = id;
        
        // Compact card with color coding
        const isZero = v === 0;
        const isHigh = v > 1.2;
        const bgColor = isZero ? 'rgba(239, 68, 68, 0.1)' : (isHigh ? 'rgba(16, 185, 129, 0.1)' : 'rgba(100, 116, 139, 0.05)');
        const borderColor = isZero ? 'rgba(239, 68, 68, 0.3)' : (isHigh ? 'rgba(16, 185, 129, 0.3)' : 'rgba(100, 116, 139, 0.15)');
        
        return `
          <div style="padding: 0.75rem; background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px;">
            <label style="display: block; margin-bottom: 0.35rem; font-weight: 600; font-size: 0.75rem; color: var(--text-primary);">${label}</label>
            <input id="${id}" type="number" step="0.01" min="0" value="${v}" 
                   style="width: 100%; padding: 0.4rem; font-size: 0.95rem; font-weight: 700; border: 1px solid rgba(100, 116, 139, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.5);" />
            <div style="margin-top: 0.25rem; font-size: 0.65rem; color: var(--text-muted);">
              ${v === 0 ? 'No payment' : `√ó${v}`}
            </div>
          </div>
        `;
      }).join('');
    }

    // Bulk import for ALL years (2024-2029)
    async function bulkImportAllYears() {
      const yearsToImport = [2024, 2025, 2026, 2027, 2028, 2029];
      
      if (!confirm(`üöÄ This will import 67 routes for ${yearsToImport.length} years (${yearsToImport.join(', ')}). Continue?`)) {
        return;
      }
      
      showToast('üîÑ Bulk importing for all years... Please wait', 'ok');
      console.log('Starting bulk import for years:', yearsToImport);
      
      try {
        let totalImported = 0;
        let totalSkipped = 0;
        
        for (const year of yearsToImport) {
          console.log(`\n=== Importing for year ${year} ===`);
          
          // Check existing routes
          const existingSnap = await db.ref(`transportCatalog/${year}/stops`).once('value');
          const existing = existingSnap.val() || {};
          
          for (const group of LEGACY_ROUTES) {
            for (const stopName of group.names) {
              // Check if exists
              const existingStop = Object.values(existing).find(s => 
                s.name && s.name.toLowerCase().trim() === stopName.toLowerCase().trim()
              );
              
              if (existingStop) {
                totalSkipped++;
                continue;
              }
              
              // Format name
              const formattedName = stopName
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
              
              // Save to database
              const newRef = db.ref(`transportCatalog/${year}/stops`).push();
              await newRef.set({
                name: formattedName,
                baseFee: group.price,
                active: true,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                imported: true,
                bulkImported: true
              });
              
              totalImported++;
            }
          }
          
          console.log(`Year ${year} complete`);
        }
        
        console.log(`\nBulk import complete!`);
        console.log(`Total imported: ${totalImported}`);
        console.log(`Total skipped: ${totalSkipped}`);
        
        showToast(`‚úÖ Bulk import complete! Imported ${totalImported} routes across ${yearsToImport.length} years!`);
        
        // Refresh display
        setTimeout(() => render(), 500);
      } catch (error) {
        console.error('Error in bulk import:', error);
        showToast('‚ùå Bulk import failed: ' + error.message, 'bad');
      }
    }

    // Migrate legacy routes for current year only
    async function migrateLegacyRoutes() {
      console.log('Migration started...');
      const year = Number(window.somapYearContext.getSelectedYear() || SOMAP_DEFAULT_YEAR);
      console.log('Importing for year:', year);
      
      showToast('üîÑ Importing routes for ' + year + '...', 'ok');
      
      try {
        const existingSnap = await db.ref(`transportCatalog/${year}/stops`).once('value');
        const existing = existingSnap.val() || {};
        console.log('Existing routes:', Object.keys(existing).length);
        
        if (Object.keys(existing).length > 0) {
          if (!confirm(`Year ${year} already has ${Object.keys(existing).length} routes. Add more? (Duplicates skipped)`)) {
            showToast('Import cancelled', 'bad');
            return;
          }
        }
        
        let imported = 0;
        let skipped = 0;
        
        for (const group of LEGACY_ROUTES) {
          for (const stopName of group.names) {
            const existingStop = Object.values(existing).find(s => 
              s.name && s.name.toLowerCase().trim() === stopName.toLowerCase().trim()
            );
            
            if (existingStop) {
              console.log('Skipping duplicate:', stopName);
              skipped++;
              continue;
            }
            
            const formattedName = stopName
              .split(' ')
              .map(word => word.charAt(0).toUpperCase() + word.slice(1))
              .join(' ');
            
            console.log('Importing:', formattedName, '- TSh', group.price);
            
            const newRef = db.ref(`transportCatalog/${year}/stops`).push();
            await newRef.set({
              name: formattedName,
              baseFee: group.price,
              active: true,
              createdAt: Date.now(),
              updatedAt: Date.now(),
              imported: true
            });
            
            imported++;
          }
        }
        
        console.log('Import complete. Imported:', imported, 'Skipped:', skipped);
        showToast(`‚úÖ Imported ${imported} routes for ${year}${skipped > 0 ? ` (${skipped} duplicates skipped)` : ''}!`);
        
        setTimeout(() => render(), 500);
      } catch (error) {
        console.error('Error migrating routes:', error);
        showToast('‚ùå Failed to import: ' + error.message, 'bad');
      }
    }

    // Event listeners
    addStopBtn.addEventListener('click', () => {
      const year = Number(window.somapYearContext.getSelectedYear() || SOMAP_DEFAULT_YEAR);
      openEditStopModal(null, year);
    });

    if (bulkImportBtn) {
      bulkImportBtn.addEventListener('click', bulkImportAllYears);
    }

    if (migrateLegacyBtn) {
      migrateLegacyBtn.addEventListener('click', migrateLegacyRoutes);
    }

    closeEditStopModal.addEventListener('click', () => {
      editStopModal.classList.add('hidden');
    });

    cancelEditStop.addEventListener('click', () => {
      editStopModal.classList.add('hidden');
    });

    saveEditStop.addEventListener('click', saveStop);

    stopSearch.addEventListener('input', () => {
      render();
    });

    saveMultBtn.addEventListener('click', async () => {
      const year = Number(window.somapYearContext.getSelectedYear() || SOMAP_DEFAULT_YEAR);
      const payload = {};
      
      Object.entries(multInputs).forEach(([m, id]) => {
        const v = Number(document.getElementById(id).value);
        payload[m] = Number.isFinite(v) ? v : 1.0;
      });

      try {
        await db.ref(`transportSettings/${year}/monthMultipliers`).set(payload);
        showToast('Monthly multipliers saved for ' + year);
      } catch (error) {
        console.error('Error saving multipliers:', error);
        showToast('Failed to save multipliers', 'bad');
      }
    });

    // Listen to year changes
    window.somapYearContext.onYearChanged(() => render());

    // Initial render
    document.addEventListener('DOMContentLoaded', () => render());
  </script>
</body>
</html>
