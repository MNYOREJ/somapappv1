<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lesson Notes | SoMAp Teacher Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-4w2d+Sxgpo1Jpj9V3dJbvt0mv47neVQcYcJJ2ULFuIkt6xl7V2bW77hlUjMt8uokG2ysL0ePkB2USK0lr7qC1A==" crossorigin="anonymous"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.1.1/tesseract.min.js" integrity="sha512-YFhfUg9Q1YvoplXh+ObodHj+04rcJ4DBegGngWqtXv0CBEvp13UFqjuIeUHZfw8RXrCFkjyAWkqEDurtBy17Xg==" crossorigin="anonymous"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: rgba(255, 255, 255, 0.95);
      padding: 20px;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 30% 40%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(162, 155, 254, 0.3) 0%, transparent 50%);
      animation: bgPulse 20s ease infinite;
      z-index: -1;
    }

    @keyframes bgPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 24px 32px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #fff 0%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-back {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #f093fb, #667eea);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.15);
      color: white;
    }

    .teacher-info {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .info-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .info-value {
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .controls {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .form-group select,
    .form-group input,
    .form-group textarea {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #f093fb;
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 4px rgba(240, 147, 251, 0.2);
    }

    .form-group select option {
      background: #5a67d8;
      color: white;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 120px;
      font-family: inherit;
    }

    .notes-form {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
    }

    .notes-form h3 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: white;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .notes-list {
      display: grid;
      gap: 16px;
    }

    .note-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .note-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      border-color: #f093fb;
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
      gap: 16px;
    }

    .note-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: white;
      margin-bottom: 8px;
    }

    .note-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .meta-tag {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .note-content {
      color: rgba(255, 255, 255, 0.85);
      line-height: 1.8;
      margin-top: 12px;
      white-space: pre-wrap;
    }

    .note-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 12px;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .toast {
      background: rgba(16, 185, 129, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
    }

    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast.success { background: rgba(16, 185, 129, 0.95); }
    .toast.error { background: rgba(239, 68, 68, 0.95); }
    .toast.warning { background: rgba(245, 158, 11, 0.95); }

    .hidden {
      display: none;
    }

    .classbook-panel {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 20px;
      display: grid;
      gap: 14px;
    }

    .lookup-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .lookup-actions .btn {
      padding: 10px 18px;
    }

    .topic-status {
      font-size: 0.9rem;
      display: flex;
      gap: 10px;
      align-items: center;
      color: rgba(255, 255, 255, 0.85);
    }

    .topic-status span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.16);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .topic-status span.ok {
      background: rgba(16, 185, 129, 0.22);
      color: #bbf7d0;
    }

    .topic-status span.warn {
      background: rgba(245, 158, 11, 0.25);
      color: #fde68a;
    }

    .topic-status span.err {
      background: rgba(239, 68, 68, 0.25);
      color: #fecaca;
    }

    .range-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .range-controls label {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.75);
    }

    .range-controls input {
      width: 100%;
    }

    .topic-meta {
      display: grid;
      gap: 6px;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.85);
    }

    .topic-meta strong {
      font-weight: 700;
    }

    .auto-import-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .auto-import-toolbar label {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
      background: rgba(255, 255, 255, 0.12);
      padding: 8px 12px;
      border-radius: 10px;
    }

    .auto-import-toolbar input[type="checkbox"] {
      accent-color: #f093fb;
    }

    .pdf-modal {
      position: fixed;
      inset: 0;
      background: rgba(13, 14, 35, 0.85);
      backdrop-filter: blur(12px);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }

    .pdf-modal.hidden {
      display: none;
    }

    .pdf-modal-content {
      background: #0f172a;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      width: min(960px, 100%);
      height: min(90vh, 720px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .pdf-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: rgba(15, 23, 42, 0.9);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      color: #e2e8f0;
    }

    .pdf-toolbar h4 {
      font-size: 1rem;
      font-weight: 700;
    }

    .pdf-toolbar .btn {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      border-radius: 8px;
      border: none;
      padding: 8px 16px;
    }

    .pdf-pages {
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      display: grid;
      gap: 18px;
      background: radial-gradient(circle at top, rgba(14, 22, 42, 0.75), transparent 70%);
    }

    .pdf-page {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(8, 14, 35, 0.35);
      position: relative;
      overflow: hidden;
    }

    .pdf-page canvas {
      width: 100%;
      display: block;
    }

    .pdf-page .page-tag {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(30, 64, 175, 0.82);
      color: #c7d2fe;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .pdf-pages .loading {
      color: #cbd5f5;
    }

    .homework-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 10px;
    }

    .homework-toolbar .btn {
      padding: 10px 18px;
    }

    .revision-banner {
      background: rgba(234, 179, 8, 0.28);
      border: 1px solid rgba(253, 224, 71, 0.35);
      border-radius: 12px;
      padding: 14px 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 18px;
      color: #fef08a;
      font-size: 0.95rem;
    }

    .revision-banner button {
      background: rgba(253, 224, 71, 0.18);
      color: #fef08a;
      border: 1px solid rgba(253, 224, 71, 0.35);
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    .extracted-highlight {
      background: rgba(34, 197, 94, 0.16);
      border-left: 3px solid rgba(34, 197, 94, 0.7);
      padding: 10px 12px;
      border-radius: 10px;
      margin-top: 10px;
      font-size: 0.9rem;
      line-height: 1.55;
      color: rgba(255, 255, 255, 0.85);
    }

    .extracted-preview {
      background: rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(59, 130, 246, 0.25);
      border-radius: 12px;
      padding: 12px 14px;
      max-height: 240px;
      overflow-y: auto;
      display: grid;
      gap: 12px;
    }

    .extracted-preview button {
      background: rgba(59, 130, 246, 0.18);
      color: #bfdbfe;
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 0.9rem;
      text-align: left;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .extracted-preview button.active {
      background: rgba(34, 197, 94, 0.24);
      border-color: rgba(34, 197, 94, 0.4);
      color: #dcfce7;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }

      .controls-grid,
      .form-row {
        grid-template-columns: 1fr;
      }

      .note-header {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <div class="container">
    <div class="header">
      <div>
        <h1>📄 Lesson Notes</h1>
        <p class="header-subtitle">Detailed lesson notes and teaching materials</p>
      </div>
      <a href="../workertasks.html" class="btn btn-back">
        ← Back to Dashboard
      </a>
    </div>

    <div class="teacher-info">
      <div class="info-item">
        <span class="info-label">Teacher Name</span>
        <span class="info-value" id="teacherName">Loading...</span>
      </div>
      <div class="info-item">
        <span class="info-label">Teacher Type</span>
        <span class="info-value" id="teacherType">Loading...</span>
      </div>
      <div class="info-item">
        <span class="info-label">Total Notes</span>
        <span class="info-value" id="totalNotes">0</span>
      </div>
      <div class="info-item">
        <span class="info-label">Date</span>
        <span class="info-value" id="currentDate">Loading...</span>
      </div>
    </div>

    <div class="controls">
      <div class="controls-grid">
        <div class="form-group">
          <label>Filter by Class</label>
          <select id="filterClass">
            <option value="">All Classes</option>
          </select>
        </div>
        <div class="form-group">
          <label>Filter by Subject</label>
          <select id="filterSubject">
            <option value="">All Subjects</option>
          </select>
        </div>
        <div class="form-group">
          <label>Filter by Topic</label>
          <input type="text" id="filterTopic" placeholder="Search by topic...">
        </div>
      </div>
      <button class="btn btn-primary" id="newNoteBtn">
        ✨ Create New Lesson Notes
      </button>
    </div>

    <div class="notes-form hidden" id="notesForm">
      <h3>✍️ New Lesson Notes</h3>
      <div class="revision-banner hidden" id="revisionBanner">
        <span id="revisionBannerText">This topic was already taught recently. Save as revision?</span>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button type="button" id="markRevisionBtn">Mark as Revision</button>
          <button type="button" id="dismissRevisionBtn">Dismiss</button>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Class *</label>
          <select id="noteClass" required>
            <option value="">Select Class</option>
          </select>
        </div>
        <div class="form-group">
          <label>Subject *</label>
          <select id="noteSubject" required>
            <option value="">Select Subject</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Topic / Unit *</label>
          <input type="text" id="noteTopic" placeholder="e.g., Photosynthesis" required>
        </div>
        <div class="form-group">
          <label>Sub-Topic</label>
          <input type="text" id="noteSubTopic" placeholder="e.g., Factors Affecting Photosynthesis">
        </div>
        <div class="form-group">
          <label>Term</label>
          <select id="noteTerm">
            <option value="Term 1">Term 1</option>
            <option value="Term 2">Term 2</option>
            <option value="Term 3">Term 3</option>
          </select>
        </div>
      </div>

      <div class="classbook-panel" id="classbookPanel">
        <div class="lookup-actions">
          <button class="btn btn-secondary" type="button" id="findTopicBtn">Find Topic in Classbooks</button>
          <button class="btn btn-primary" type="button" id="openPagesBtn" disabled>Open Topic Pages</button>
          <button class="btn btn-success" type="button" id="autoImportBtn" disabled>Auto Import to Lesson Development</button>
          <button class="btn btn-secondary" type="button" id="clearImportBtn" disabled>Clear Imported Text</button>
        </div>
        <div class="topic-status" id="topicStatus">
          <span class="warn">Waiting</span>
          <p id="topicStatusText">Select class, subject, and topic, then click &ldquo;Find Topic in Classbooks&rdquo;.</p>
        </div>
        <div class="topic-meta hidden" id="topicMeta">
          <div><strong>Book:</strong> <span id="topicBookTitle"></span></div>
          <div><strong>Pages:</strong> <span id="topicPages"></span></div>
          <div><strong>Keywords:</strong> <span id="topicKeywords"></span></div>
          <a class="btn btn-secondary" id="openExternalBookLink" href="#" target="_blank" rel="noopener">Open Full Book</a>
        </div>
        <div class="range-controls hidden" id="rangeControls">
          <div class="form-group">
            <label for="pageStartInput">Page Start</label>
            <input type="number" id="pageStartInput" min="1" value="1">
          </div>
          <div class="form-group">
            <label for="pageEndInput">Page End</label>
            <input type="number" id="pageEndInput" min="1" value="1">
          </div>
        </div>
        <div class="auto-import-toolbar hidden" id="autoImportToolbar">
          <button class="btn btn-success" type="button" id="importToNotesBtn">Import Range into Lesson Development</button>
          <button class="btn btn-secondary" type="button" id="previewExtractBtn">Preview Extracted Text</button>
          <button class="btn btn-secondary" type="button" id="clearExtractBtn">Clear Auto Text</button>
          <label for="enableOcrToggle">
            <input type="checkbox" id="enableOcrToggle">
            OCR scanned pages (slow)
          </label>
        </div>
        <div class="extracted-preview hidden" id="extractedPreview"></div>
      </div>

      <div class="form-group">
        <label>Key Concepts & Definitions *</label>
        <textarea id="keyConceptsNotes" placeholder="List and explain the main concepts, definitions, and terminology..." required></textarea>
      </div>

      <div class="form-group">
        <label>Detailed Content / Explanation *</label>
        <textarea id="detailedContent" placeholder="Provide detailed explanation of the topic, including examples, processes, formulas, etc." required style="min-height: 200px;"></textarea>
      </div>

      <div class="form-group">
        <label>Examples & Illustrations</label>
        <textarea id="examples" placeholder="Real-world examples, worked problems, case studies, etc."></textarea>
      </div>

      <div class="form-group">
        <label>Important Points / Key Takeaways</label>
        <textarea id="keyTakeaways" placeholder="Bullet points of the most important things students should remember..."></textarea>
      </div>

      <div class="form-group">
        <label>Diagrams & Visual Aids</label>
        <textarea id="diagrams" placeholder="Describe diagrams, charts, or visual aids to use (or URLs to images)"></textarea>
      </div>

      <div class="form-group">
        <label>Common Mistakes / Misconceptions</label>
        <textarea id="misconceptions" placeholder="Common errors students make or misconceptions to address..."></textarea>
      </div>

      <div class="form-group">
        <label>Practice Questions / Homework</label>
        <div class="homework-toolbar">
          <button class="btn btn-success" type="button" id="generateHomeworkBtn">Generate 15 Homework Questions</button>
          <button class="btn btn-secondary" type="button" id="clearHomeworkBtn">Clear Homework</button>
          <span id="homeworkSummary" style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.8);"></span>
        </div>
        <textarea id="practiceQuestions" placeholder="Generated homework will appear here. You can still edit or add your own questions." style="min-height: 160px;"></textarea>
      </div>

      <div class="form-group">
        <label>Reference Materials / Sources</label>
        <textarea id="references" placeholder="Textbook pages, websites, videos, or other resources..."></textarea>
      </div>

      <div class="form-group">
        <label>Teaching Tips / Notes for Self</label>
        <textarea id="teachingTips" placeholder="Personal reminders, things to emphasize, common student questions, etc."></textarea>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button class="btn btn-success" id="saveNoteBtn">💾 Save Lesson Notes</button>
        <button class="btn btn-secondary" id="cancelNoteBtn">Cancel</button>
      </div>
    </div>

        <div id="notesList">
      <div class="empty-state">
        <h3>No Lesson Notes Yet</h3>
        <p>Click "Create New Lesson Notes" to get started!</p>
      </div>
    </div>
  </div>

    <div class="pdf-modal hidden" id="pdfModal">
      <div class="pdf-modal-content">
        <div class="pdf-toolbar">
          <div>
            <h4 id="pdfModalTitle">Topic Pages</h4>
            <div id="pdfModalSummary" style="font-size: 0.85rem; color: rgba(224, 231, 255, 0.75);"></div>
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-success" type="button" id="appendVisibleBtn">Import These Pages</button>
            <button class="btn btn-secondary" type="button" id="closePdfBtn">Close</button>
          </div>
        </div>
        <div class="pdf-pages" id="pdfPageContainer">
          <div class="loading" id="pdfLoadingState">
            <div class="spinner" style="margin-bottom: 8px;"></div>
            Loading topic pages...
          </div>
        </div>
      </div>
    </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let workerId = null;
    let teacherConfig = null;
    let notes = {};
    let editingNoteId = null;

    const HOMEWORK_TOTAL = 15;
    const HOMEWORK_BLUEPRINT = [
      { type: 'multiple_choice', ratio: 0.10, label: 'Multiple Choice', min: 1 },
      { type: 'matching', ratio: 0.10, label: 'Matching Items', min: 1 },
      { type: 'true_false', ratio: 0.20, label: 'True or False', min: 2 },
      { type: 'passage', ratio: 0.20, label: 'Passage Question', min: 2 },
      { type: 'word_problem', ratio: 0.20, label: 'Word Problem', min: 2 },
      { type: 'reflection', ratio: 0.20, label: 'Reflection', min: 2 }
    ];

    const CLASS_AGE_LOOKUP = {
      'baby class': 3,
      'play group': 3,
      'nursery': 4,
      'kindergarten': 4,
      'pre-primary': 5,
      'pre primary': 5,
      'reception': 5,
      'class 1': 5,
      'class one': 5,
      'class 2': 6,
      'class two': 6,
      'class 3': 7,
      'class three': 7,
      'class 4': 8,
      'class four': 8,
      'class 5': 9,
      'class five': 9,
      'class 6': 10,
      'class six': 10,
      'class 7': 11,
      'class seven': 11,
      'standard 1': 7,
      'standard i': 7,
      'standard 2': 8,
      'standard 3': 9,
      'standard 4': 10,
      'standard 5': 11,
      'standard 6': 12,
      'standard 7': 13
    };

    const lessonState = {
      classbooksCache: {},
      currentBook: null,
      extractedParagraphs: [],
      selectedParagraphs: new Set(),
      paragraphIndex: {},
      previousDetailValue: null,
      autoTextSnippet: '',
      pdfDoc: null,
      pageTextCache: {},
      lastHomeworkMeta: null,
      isRevision: false,
      revisionCandidate: null
    };

    const teacherName = document.getElementById('teacherName');
    const teacherType = document.getElementById('teacherType');
    const currentDate = document.getElementById('currentDate');
    const totalNotes = document.getElementById('totalNotes');
    const filterClass = document.getElementById('filterClass');
    const filterSubject = document.getElementById('filterSubject');
    const filterTopic = document.getElementById('filterTopic');
    const newNoteBtn = document.getElementById('newNoteBtn');
    const notesForm = document.getElementById('notesForm');
    const cancelNoteBtn = document.getElementById('cancelNoteBtn');
    const saveNoteBtn = document.getElementById('saveNoteBtn');
    const notesList = document.getElementById('notesList');

    const noteClassField = document.getElementById('noteClass');
    const noteSubjectField = document.getElementById('noteSubject');
    const noteTopicField = document.getElementById('noteTopic');
    const noteSubTopicField = document.getElementById('noteSubTopic');
    const noteTermField = document.getElementById('noteTerm');
    const keyConceptsField = document.getElementById('keyConceptsNotes');
    const detailedContentField = document.getElementById('detailedContent');
    const examplesField = document.getElementById('examples');
    const keyTakeawaysField = document.getElementById('keyTakeaways');
    const diagramsField = document.getElementById('diagrams');
    const misconceptionsField = document.getElementById('misconceptions');
    const practiceQuestionsField = document.getElementById('practiceQuestions');
    const referencesField = document.getElementById('references');
    const teachingTipsField = document.getElementById('teachingTips');

    const revisionBanner = document.getElementById('revisionBanner');
    const revisionBannerText = document.getElementById('revisionBannerText');
    const markRevisionBtn = document.getElementById('markRevisionBtn');
    const dismissRevisionBtn = document.getElementById('dismissRevisionBtn');

    const findTopicBtn = document.getElementById('findTopicBtn');
    const openPagesBtn = document.getElementById('openPagesBtn');
    const autoImportBtn = document.getElementById('autoImportBtn');
    const clearImportBtn = document.getElementById('clearImportBtn');
    const topicStatus = document.getElementById('topicStatus');
    const topicStatusBadge = topicStatus ? topicStatus.querySelector('span') : null;
    const topicStatusText = document.getElementById('topicStatusText');
    const topicMeta = document.getElementById('topicMeta');
    const topicBookTitle = document.getElementById('topicBookTitle');
    const topicPages = document.getElementById('topicPages');
    const topicKeywords = document.getElementById('topicKeywords');
    const openExternalBookLink = document.getElementById('openExternalBookLink');
    const rangeControls = document.getElementById('rangeControls');
    const pageStartInput = document.getElementById('pageStartInput');
    const pageEndInput = document.getElementById('pageEndInput');
    const autoImportToolbar = document.getElementById('autoImportToolbar');
    const importedPreview = document.getElementById('extractedPreview');
    const previewExtractBtn = document.getElementById('previewExtractBtn');
    const importToNotesBtn = document.getElementById('importToNotesBtn');
    const clearExtractBtn = document.getElementById('clearExtractBtn');
    const enableOcrToggle = document.getElementById('enableOcrToggle');

    const pdfModal = document.getElementById('pdfModal');
    const pdfModalTitle = document.getElementById('pdfModalTitle');
    const pdfModalSummary = document.getElementById('pdfModalSummary');
    const pdfPageContainer = document.getElementById('pdfPageContainer');
    const pdfLoadingState = document.getElementById('pdfLoadingState');
    const appendVisibleBtn = document.getElementById('appendVisibleBtn');
    const closePdfBtn = document.getElementById('closePdfBtn');

    const generateHomeworkBtn = document.getElementById('generateHomeworkBtn');
    const clearHomeworkBtn = document.getElementById('clearHomeworkBtn');
    const homeworkSummary = document.getElementById('homeworkSummary');

        function toast(message, type = "success") {
      const container = document.getElementById('toastContainer');
      if (!container) {
        alert(message);
        return;
      }
      const toastEl = document.createElement('div');
      toastEl.className = `toast ${type}`;
      toastEl.innerHTML = `
        <span>${type === 'success' ? '[OK]' : type === 'error' ? '[X]' : '[!]'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toastEl);
      setTimeout(() => toastEl.classList.add('show'), 100);
      setTimeout(() => {
        toastEl.classList.remove('show');
        setTimeout(() => toastEl.remove(), 300);
      }, 3200);
    }

    if (currentDate) {
      currentDate.textContent = new Date().toLocaleDateString('en-US', {
        timeZone: 'Africa/Nairobi',
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    function sanitizeKey(value) {
      return String(value || '').replace(/[.#$\[\]]/g, '_');
    }

    function normalizeText(text) {
      return String(text || '').toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
    }

    function tokenize(text) {
      return normalizeText(text).split(' ').filter(Boolean);
    }

    function similarityFromSets(aSet, bSet) {
      if (!aSet.size || !bSet.size) return 0;
      let matches = 0;
      aSet.forEach(token => {
        if (bSet.has(token)) matches += 1;
      });
      return matches / Math.min(aSet.size, bSet.size);
    }

    function getAcademicYearKey() {
      let year = null;
      if (teacherConfig) {
        year = teacherConfig.currentYear || teacherConfig.academicYear || teacherConfig.year;
      }
      if (year) {
        return sanitizeKey(String(year));
      }
      return String(new Date().getFullYear());
    }

    function updateTopicStatus(level, message) {
      if (!topicStatusBadge || !topicStatusText) return;
      topicStatusBadge.classList.remove('ok', 'warn', 'err');
      topicStatusBadge.classList.add(level);
      topicStatusBadge.textContent = level === 'ok' ? 'Ready' : level === 'err' ? 'Missing' : 'Waiting';
      topicStatusText.textContent = message;
    }

    function resetClassbookUi(fullReset = false) {
      updateTopicStatus('warn', 'Select class, subject, and topic, then find a book.');
      if (topicMeta) topicMeta.classList.add('hidden');
      if (rangeControls) rangeControls.classList.add('hidden');
      if (autoImportToolbar) autoImportToolbar.classList.add('hidden');
      if (importedPreview) {
        importedPreview.classList.add('hidden');
        importedPreview.innerHTML = '';
      }
      if (openPagesBtn) openPagesBtn.disabled = true;
      if (autoImportBtn) autoImportBtn.disabled = true;
      if (importToNotesBtn) importToNotesBtn.disabled = true;
      if (previewExtractBtn) previewExtractBtn.disabled = true;
      if (clearExtractBtn) clearExtractBtn.disabled = true;
      if (clearImportBtn) clearImportBtn.disabled = true;
      if (enableOcrToggle) enableOcrToggle.checked = false;
      if (openExternalBookLink) {
        openExternalBookLink.classList.add('hidden');
        openExternalBookLink.removeAttribute('href');
      }
      lessonState.currentBook = null;
      lessonState.pageTextCache = {};
      lessonState.extractedParagraphs = [];
      lessonState.selectedParagraphs.clear();
      lessonState.paragraphIndex = {};
      lessonState.previousDetailValue = null;
      lessonState.autoTextSnippet = '';
      if (fullReset && pageStartInput && pageEndInput) {
        pageStartInput.value = '';
        pageEndInput.value = '';
      }
    }

        function scoreTopicMatch(normalizedTopic, topicEntry) {
      if (!topicEntry) return 0;
      const topicTokens = new Set(tokenize(topicEntry.name || ''));
      const queryTokens = new Set(normalizedTopic.split(' ').filter(Boolean));
      let score = similarityFromSets(queryTokens, topicTokens);
      const keywordTokens = new Set();
      if (Array.isArray(topicEntry.keywords)) {
        topicEntry.keywords.forEach(kw => tokenize(kw).forEach(token => keywordTokens.add(token)));
        if (keywordTokens.size) {
          score = Math.max(score, similarityFromSets(queryTokens, keywordTokens));
        }
      }
      if (normalizeText(topicEntry.name) === normalizedTopic) {
        score += 0.25;
      }
      return Math.min(1, score);
    }

    async function findTopicInClassbooks() {
      const className = noteClassField ? noteClassField.value.trim() : '';
      const subjectName = noteSubjectField ? noteSubjectField.value.trim() : '';
      const topicName = noteTopicField ? noteTopicField.value.trim() : '';

      if (!className || !subjectName || !topicName) {
        toast('Select class, subject, and topic before searching.', 'warning');
        updateTopicStatus('warn', 'Fill in class, subject, and topic first.');
        return;
      }

      updateTopicStatus('warn', 'Searching for a matching book...');

      const yearKey = getAcademicYearKey();
      const classKey = sanitizeKey(className).toLowerCase();
      const subjectKey = sanitizeKey(subjectName).toLowerCase();
      const cacheKey = `${yearKey}::${classKey}::${subjectKey}`;

      let bookEntry = null;

      // Try classbooksIndex first (for indexed books with topics)
      if (!lessonState.classbooksCache[cacheKey]) {
        try {
          const indexedSnap = await db.ref(`classbooksIndex/${yearKey}/${classKey}/${subjectKey}`).once('value');
          if (indexedSnap.exists()) {
            lessonState.classbooksCache[cacheKey] = indexedSnap.val();
            bookEntry = indexedSnap.val();
          }
        } catch (error) {
          console.error('Indexed book lookup error', error);
        }
      } else {
        bookEntry = lessonState.classbooksCache[cacheKey];
      }

      // Fallback to class_books structure (actual storage location)
      if (!bookEntry) {
        try {
          const encodedClass = encodeURIComponent(className);
          const classBooksSnap = await db.ref(`class_books/${encodedClass}`).once('value');
          
          if (!classBooksSnap.exists()) {
            resetClassbookUi();
            updateTopicStatus('err', 'No books found for this class. Books may need to be uploaded first.');
            toast('No books found for this class.', 'warning');
            return;
          }

          const allBooks = classBooksSnap.val() || {};
          const normalizedSubject = normalizeText(subjectName);
          
          // Find books matching the subject
          const matchingBooks = Object.entries(allBooks)
            .map(([bookId, book]) => {
              const bookSubject = normalizeText(book.subject || '');
              const score = similarityFromSets(
                new Set(normalizedSubject.split(' ').filter(Boolean)),
                new Set(bookSubject.split(' ').filter(Boolean))
              );
              return { bookId, book, score };
            })
            .filter(item => item.score > 0.3 || normalizedSubject === item.book.subject?.toLowerCase())
            .sort((a, b) => b.score - a.score);

          if (matchingBooks.length === 0) {
            resetClassbookUi();
            updateTopicStatus('err', `No ${subjectName} book found for ${className}. Books may need to be uploaded.`);
            toast(`No ${subjectName} book found for ${className}.`, 'warning');
            return;
          }

          // Use the best matching book
          const bestBook = matchingBooks[0];
          bookEntry = {
            title: bestBook.book.title || 'Classbook',
            cloudinaryUrl: bestBook.book.url || bestBook.book.cloudinaryUrl || '',
            subject: bestBook.book.subject || subjectName,
            bookId: bestBook.bookId,
            topics: [] // Topics not indexed in this structure
          };

          // Cache it for future use
          lessonState.classbooksCache[cacheKey] = bookEntry;
        } catch (error) {
          console.error('Book lookup error', error);
          updateTopicStatus('err', 'Unable to reach the books database right now.');
          toast('Book lookup failed. Please try again.', 'error');
          return;
        }
      }

      const normalizedTopic = normalizeText(topicName);
      let bestMatch = null;

      // Try to match topics if available
      if (bookEntry.topics && Array.isArray(bookEntry.topics)) {
        bestMatch = bookEntry.topics
          .map(entry => ({ topic: entry, score: scoreTopicMatch(normalizedTopic, entry) }))
          .sort((a, b) => b.score - a.score)[0];
      }

      lessonState.currentBook = {
        yearKey,
        book: bookEntry,
        topic: bestMatch && bestMatch.score >= 0.35 ? bestMatch.topic : null
      };

      const matchedTopic = lessonState.currentBook.topic;
      const startPage = matchedTopic && matchedTopic.pageStart ? Number(matchedTopic.pageStart) : 1;
      const endPage = matchedTopic && matchedTopic.pageEnd ? Number(matchedTopic.pageEnd) : startPage + 4;

      if (pageStartInput) pageStartInput.value = startPage;
      if (pageEndInput) pageEndInput.value = endPage;
      syncPageRangeLabel();

      if (topicBookTitle) topicBookTitle.textContent = bookEntry.title || 'Classbook';
      if (topicKeywords) {
        topicKeywords.textContent = matchedTopic && matchedTopic.keywords && matchedTopic.keywords.length
          ? matchedTopic.keywords.join(', ')
          : 'No keywords indexed yet';
      }
      if (topicPages) topicPages.textContent = `${startPage} to ${endPage}`;

      if (topicMeta) topicMeta.classList.remove('hidden');
      if (rangeControls) rangeControls.classList.remove('hidden');
      if (autoImportToolbar) autoImportToolbar.classList.remove('hidden');
      if (importedPreview) {
        importedPreview.classList.add('hidden');
        importedPreview.innerHTML = '';
      }

      const hasUrl = Boolean(bookEntry.cloudinaryUrl || bookEntry.url);
      if (openPagesBtn) openPagesBtn.disabled = !hasUrl;
      if (autoImportBtn) autoImportBtn.disabled = !hasUrl;
      if (importToNotesBtn) importToNotesBtn.disabled = !hasUrl;
      if (previewExtractBtn) previewExtractBtn.disabled = !hasUrl;
      if (clearExtractBtn) clearExtractBtn.disabled = false;
      if (clearImportBtn) clearImportBtn.disabled = false;

      if (openExternalBookLink) {
        if (hasUrl) {
          openExternalBookLink.classList.remove('hidden');
          openExternalBookLink.href = bookEntry.cloudinaryUrl || bookEntry.url || '';
        } else {
          openExternalBookLink.classList.add('hidden');
          openExternalBookLink.removeAttribute('href');
        }
      }
      
      if (matchedTopic) {
        updateTopicStatus('ok', `Matched "${matchedTopic.name}" on pages ${startPage}-${endPage}. Adjust if needed.`);
      } else if (hasUrl) {
        updateTopicStatus('ok', `Found "${bookEntry.title}". Topic not indexed - adjust pages manually or search the book.`);
      } else {
        updateTopicStatus('warn', 'Book found but no PDF URL available. Please check book upload.');
      }

      lessonState.pageTextCache = {};
      lessonState.previousDetailValue = null;
      lessonState.autoTextSnippet = '';
      if (lessonState.selectedParagraphs.size) {
        lessonState.selectedParagraphs.clear();
        syncDetailedContent();
      }

      checkRevisionFlag();
    }

    async function openPdfModalForRange() {
      if (!lessonState.currentBook || !lessonState.currentBook.book) {
        toast('No book selected.', 'warning');
        return;
      }
      const bookUrl = lessonState.currentBook.book.cloudinaryUrl || lessonState.currentBook.book.url;
      if (!bookUrl) {
        toast('No book URL available.', 'warning');
        return;
      }
      const pdfjs = window.pdfjsLib;
      if (!pdfjs) {
        toast('PDF reader failed to load.', 'error');
        return;
      }

      const start = parseInt(pageStartInput && pageStartInput.value ? pageStartInput.value : '1', 10) || 1;
      const end = parseInt(pageEndInput && pageEndInput.value ? pageEndInput.value : String(start), 10) || start;

      if (pdfModal) pdfModal.classList.remove('hidden');
      if (pdfModalTitle) {
        const topicLabel = lessonState.currentBook.topic && lessonState.currentBook.topic.name ? lessonState.currentBook.topic.name : (noteTopicField ? noteTopicField.value || 'Topic pages' : 'Topic pages');
        pdfModalTitle.textContent = topicLabel;
      }
      if (pdfModalSummary) {
        const bookLabel = lessonState.currentBook.book.title || 'Classbook';
        pdfModalSummary.textContent = bookLabel + ' • Pages ' + start + '-' + end;
      }
      if (pdfPageContainer) pdfPageContainer.innerHTML = '';
      if (pdfLoadingState && pdfPageContainer) {
        pdfLoadingState.classList.remove('hidden');
        pdfPageContainer.appendChild(pdfLoadingState);
      }

      try {
        const bookUrl = lessonState.currentBook.book.cloudinaryUrl || lessonState.currentBook.book.url;
        if (!lessonState.pdfDoc || lessonState.pdfDoc.__bookUrl !== bookUrl) {
          if (lessonState.pdfDoc) {
            try { lessonState.pdfDoc.destroy(); } catch (e) {}
          }
          const loadingTask = pdfjs.getDocument({
            url: bookUrl,
            withCredentials: false
          });
          lessonState.pdfDoc = await loadingTask.promise;
          lessonState.pdfDoc.__bookUrl = bookUrl;
        }

        const totalPages = lessonState.pdfDoc.numPages;
        const safeStart = Math.max(1, Math.min(start, totalPages));
        const safeEnd = Math.max(safeStart, Math.min(end, totalPages));

        if (pdfLoadingState) pdfLoadingState.classList.add('hidden');
        if (pdfPageContainer) pdfPageContainer.innerHTML = '';

        for (let pageNumber = safeStart; pageNumber <= safeEnd; pageNumber++) {
          const page = await lessonState.pdfDoc.getPage(pageNumber);
          const viewport = page.getViewport({ scale: 1.35 });
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          await page.render({ canvasContext: ctx, viewport }).promise;

          const wrapper = document.createElement('div');
          wrapper.className = 'pdf-page';
          const badge = document.createElement('div');
          badge.className = 'page-tag';
          badge.textContent = 'Page ' + pageNumber;
          wrapper.appendChild(badge);
          wrapper.appendChild(canvas);
          if (pdfPageContainer) pdfPageContainer.appendChild(wrapper);

          if (!lessonState.pageTextCache[pageNumber]) {
            const textContent = await page.getTextContent().catch(() => null);
            if (textContent && textContent.items.length) {
              lessonState.pageTextCache[pageNumber] = textContent.items
                .sort((a, b) => (a.transform[5] - b.transform[5]) || (a.transform[4] - b.transform[4]))
                .map(item => item.str)
                .join(' ')
                .replace(/\s+/g, ' ')
                .trim();
            } else {
              lessonState.pageTextCache[pageNumber] = '';
            }
          }
        }

        updateTopicStatus('ok', 'Viewer ready. Scroll through pages ' + safeStart + '-' + safeEnd + '.');
      } catch (error) {
        console.error('Error rendering PDF', error);
        if (pdfPageContainer) {
          pdfPageContainer.innerHTML = '<p style="color: #fca5a5;">Unable to open the PDF reader. Use the book link instead.</p>';
        }
        updateTopicStatus('err', 'Unable to open the PDF right now.');
      }
    }
function splitIntoParagraphs(text) {
      return text
        .replace(/\r/g, '')
        .split(/(?:\n{2,}|(?<=\.|\?|!)\s{2,})/)
        .map(part => part.trim())
        .filter(part => part.length > 30);
    }

    async function runPageOcr(page) {
      if (typeof window.Tesseract === 'undefined') return '';
      const viewport = page.getViewport({ scale: 2 });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({ canvasContext: ctx, viewport }).promise;
      const { data } = await window.Tesseract.recognize(canvas, 'eng', { logger: () => {} });
      return data && data.text ? data.text.replace(/\s+/g, ' ').trim() : '';
    }

    async function fetchParagraphsFromRange(start, end, useOcr) {
      if (!lessonState.currentBook || !lessonState.currentBook.book) {
        return [];
      }
      const bookUrl = lessonState.currentBook.book.cloudinaryUrl || lessonState.currentBook.book.url;
      if (!bookUrl) {
        return [];
      }

      const pdfjs = window.pdfjsLib;
      if (!pdfjs || !lessonState.pdfDoc) {
        return [];
      }

      const paragraphs = [];
      const useOcrFlag = useOcr === true;

      try {
        for (let pageNum = start; pageNum <= end; pageNum++) {
          if (pageNum < 1 || pageNum > lessonState.pdfDoc.numPages) continue;

          let text = lessonState.pageTextCache[pageNum];
          if (!text || useOcrFlag) {
            const page = await lessonState.pdfDoc.getPage(pageNum);
            if (useOcrFlag) {
              text = await runPageOcr(page);
            } else {
              const textContent = await page.getTextContent().catch(() => null);
              if (textContent && textContent.items.length) {
                text = textContent.items
                  .sort((a, b) => (a.transform[5] - b.transform[5]) || (a.transform[4] - b.transform[4]))
                  .map(item => item.str)
                  .join(' ')
                  .replace(/\s+/g, ' ')
                  .trim();
              } else {
                text = '';
              }
            }
            if (text && !useOcrFlag) {
              lessonState.pageTextCache[pageNum] = text;
            }
          }

          if (text) {
            const pageParagraphs = splitIntoParagraphs(text);
            pageParagraphs.forEach((para, idx) => {
              if (para && para.length > 30) {
                paragraphs.push({
                  id: `p${pageNum}_${idx}`,
                  page: pageNum,
                  text: para
                });
              }
            });
          }
        }
      } catch (error) {
        console.error('Error extracting paragraphs:', error);
      }

      return paragraphs;
    }

    function closePdfModal() {
      if (pdfModal) {
        pdfModal.classList.add('hidden');
      }
    }


    function setRevisionBanner(visible, message = '') {
      if (!revisionBanner || !revisionBannerText) return;
      if (!visible) {
        revisionBanner.classList.add('hidden');
        revisionBannerText.textContent = '';
        return;
      }
      revisionBanner.classList.remove('hidden');
      revisionBannerText.textContent = message;
    }

    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleDateString('en-US', { timeZone: 'Africa/Nairobi' });
    }

    function checkRevisionFlag() {
      if (!notes || !noteClassField || !noteSubjectField || !noteTopicField) {
        setRevisionBanner(false);
        return;
      }
      const className = noteClassField.value.trim();
      const subjectName = noteSubjectField.value.trim();
      const topicName = noteTopicField.value.trim();
      if (!className || !subjectName || !topicName) {
        setRevisionBanner(false);
        lessonState.isRevision = false;
        lessonState.revisionCandidate = null;
        return;
      }

      const normalizedTopic = normalizeText(topicName);
      const ninetyDaysAgo = Date.now() - (90 * 24 * 60 * 60 * 1000);
      let latest = null;

      Object.entries(notes).forEach(([id, note]) => {
        if (editingNoteId && id === editingNoteId) return;
        if (note.class !== className || note.subject !== subjectName) return;
        const noteTopic = normalizeText(note.topic);
        if (noteTopic === normalizedTopic || noteTopic.includes(normalizedTopic) || normalizedTopic.includes(noteTopic)) {
          const stamp = note.updatedAt || note.createdAt || 0;
          if (stamp >= ninetyDaysAgo && (!latest || stamp > latest.createdAt)) {
            latest = { id, createdAt: stamp, isRevision: !!note.isRevision };
          }
        }
      });

      if (latest) {
        lessonState.revisionCandidate = latest;
        setRevisionBanner(true, `Already taught on ${formatDate(latest.createdAt)}${latest.isRevision ? ' (saved as revision)' : ''}. Save this as revision?`);
      } else {
        lessonState.revisionCandidate = null;
        lessonState.isRevision = false;
        setRevisionBanner(false);
      }
    }

    function parseConcepts(text) {
      return String(text || '')
        .split(/\r?\n/)
        .map(line => line.trim())
        .filter(Boolean)
        .map(line => {
          const parts = line.split(/[:\-–]/);
          if (parts.length >= 2) {
            const term = parts.shift().trim();
            const description = parts.join(' ').trim();
            return { term, description };
          }
          return null;
        })
        .filter(Boolean);
    }

    function extractSentences(text) {
      return String(text || '')
        .replace(/\s+/g, ' ')
        .split(/(?<=[.!?])\s+/)
        .map(sentence => sentence.trim())
        .filter(sentence => sentence.length > 0);
    }

    function getLearnerAge(className) {
      if (!className) return 10;
      const key = className.toLowerCase().trim();
      if (CLASS_AGE_LOOKUP[key]) return CLASS_AGE_LOOKUP[key];
      const match = key.match(/\d+/);
      if (match) {
        const number = parseInt(match[0], 10);
        if (!Number.isNaN(number)) {
          if (key.includes('standard')) {
            return Math.min(13, Math.max(7, 6 + number));
          }
          return Math.min(12, Math.max(3, 4 + number));
        }
      }
      return 10;
    }

    function buildHomeworkCounts(total) {
      const counts = HOMEWORK_BLUEPRINT.map(item => ({ ...item, count: item.min }));
      let assigned = counts.reduce((sum, item) => sum + item.count, 0);
      const fractions = HOMEWORK_BLUEPRINT.map(item => ({
        type: item.type,
        fraction: item.ratio * total
      }));

      while (assigned < total) {
        fractions.sort((a, b) => b.fraction - a.fraction);
        for (const frac of fractions) {
          if (assigned >= total) break;
          const target = counts.find(item => item.type === frac.type);
          target.count += 1;
          assigned += 1;
        }
      }

      while (assigned > total) {
        const target = counts.find(item => item.count > item.min);
        if (!target) break;
        target.count -= 1;
        assigned -= 1;
      }
      return counts;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function generateGenericDistractor(topic, subjectName) {
      const baseTopic = topic || 'the lesson';
      const subject = (subjectName || '').toLowerCase();
      if (subject.includes('math')) {
        return `${baseTopic} is solved by guessing without checking.`;
      }
      if (subject.includes('science')) {
        return `${baseTopic} only happens in outer space.`;
      }
      if (subject.includes('english') || subject.includes('language')) {
        return `${baseTopic} means writing without using any words.`;
      }
      if (subject.includes('kiswahili')) {
        return `${baseTopic} ignores all new words from the story.`;
      }
      return `${baseTopic} is just for fun and has no rules.`;
    }

    function buildMultipleChoiceQuestion({ age, subjectName, topicName, conceptPairs, keywords, sentences }) {
      const pair = conceptPairs.length ? conceptPairs[Math.floor(Math.random() * conceptPairs.length)] : null;
      const promptTopic = pair ? pair.term : topicName;
      const correct = pair ? pair.description : (sentences[0] || `It is the main idea of ${topicName}.`);
      const distractors = conceptPairs.filter(p => p !== pair).map(p => p.description);
      while (distractors.length < 3) {
        distractors.push(generateGenericDistractor(promptTopic, subjectName));
      }
      const options = shuffle([correct, distractors[0], distractors[1], distractors[2]]);
      const labels = ['A', 'B', 'C', 'D'];
      const stem = age <= 6
        ? `What does ${promptTopic} help us do?`
        : `Which statement best explains ${promptTopic}?`;
      return `Multiple Choice: ${stem}\n${options.map((opt, idx) => `${labels[idx]}. ${opt}`).join('\n')}`;
    }

    function buildMatchingQuestion({ age, topicName, conceptPairs }) {
      const pairs = conceptPairs.slice(0, 4);
      while (pairs.length < 4) {
        pairs.push({
          term: `${topicName} idea ${pairs.length + 1}`,
          description: `Describe what ${topicName.toLowerCase()} idea ${pairs.length + 1} means in your own words.`
        });
      }
      const columnA = ['A', 'B', 'C', 'D'];
      const shuffledDescriptions = shuffle(pairs.map(pair => pair.description));
      const instructions = age <= 6
        ? 'Match the word with its meaning.'
        : 'Match Column A with Column B.';
      return `Matching: ${instructions}\nColumn A:\n${pairs.map((pair, idx) => `${columnA[idx]}. ${pair.term}`).join('\n')}\nColumn B:\n${shuffledDescriptions.map((desc, idx) => `${idx + 1}. ${desc}`).join('\n')}`;
    }

    function buildTrueFalseQuestion({ age, topicName, sentences, conceptPairs, keywords }) {
      let statement = sentences.length ? sentences[Math.floor(Math.random() * sentences.length)] : `This statement about ${topicName} is correct.`;
      if (statement.length < 25 && conceptPairs.length) {
        statement = `${conceptPairs[0].term} means ${conceptPairs[0].description}.`;
      }
      if (!/[.!?]$/.test(statement)) {
        statement += '.';
      }
      if (Math.random() > 0.5) {
        const words = statement.split(' ');
        if (words.length > 4) {
          const index = Math.max(1, Math.floor(words.length / 2));
          const replacement = keywords.find(word => !statement.toLowerCase().includes(word.toLowerCase()));
          if (replacement) {
            words[index] = replacement;
            statement = words.join(' ');
          } else {
            statement = statement.replace(/\bis\b/, 'is not');
          }
        } else {
          statement = statement.replace(/\bis\b/, 'is not');
        }
      }
      const prompt = age <= 6 ? 'Is this right or wrong? Say True or False.' : 'Decide whether the statement is True or False.';
      return `True or False: ${prompt}\n- ${statement}`;
    }

    function buildPassageQuestion({ age, topicName, sentences, subjectName }) {
      const baseSentences = sentences.slice(0, 3);
      if (baseSentences.length < 3) {
        while (baseSentences.length < 3) {
          baseSentences.push(`This part explains ${topicName.toLowerCase()} in a simple way.`);
        }
      }
      const passage = baseSentences.join(' ');
      const question = age <= 6
        ? `After listening to the story, tell one thing that happens in ${topicName}.`
        : `After reading the passage, answer: Why is ${topicName.toLowerCase()} important in ${subjectName.toLowerCase()}?`;
      return `Passage Question:\nPassage: ${passage}\nQuestion: ${question}`;
    }

    function buildWordProblem({ age, topicName, subjectName }) {
      const numberA = age <= 6 ? 3 + Math.floor(Math.random() * 4) : 8 + Math.floor(Math.random() * 12);
      const numberB = age <= 6 ? 2 + Math.floor(Math.random() * 3) : 5 + Math.floor(Math.random() * 10);
      const subject = (subjectName || '').toLowerCase();
      let scenario = '';
      if (subject.includes('math')) {
        scenario = `A teacher splits ${numberA * numberB} ${topicName.toLowerCase()} tasks equally among ${numberA} groups. How many tasks does each group get?`;
      } else if (subject.includes('science')) {
        scenario = `${numberA} plants were observed during a ${topicName.toLowerCase()} experiment. Each plant showed ${numberB} results. How many results were recorded in total?`;
      } else {
        scenario = `During a ${topicName.toLowerCase()} activity, ${numberA} pupils each wrote ${numberB} notes. How many notes were written altogether?`;
      }
      const extension = age <= 6
        ? 'Show your working with small drawings if you need to.'
        : 'Explain your reasoning clearly.';
      return `Word Problem: ${scenario} ${extension}`;
    }

    function buildReflectionQuestion({ age, topicName, subjectName }) {
      if (age <= 6) {
        return `Reflection: How will you use what you learned about ${topicName.toLowerCase()} at home?`;
      }
      return `Reflection: Describe a real-life situation in Tanzania where ${topicName.toLowerCase()} from ${subjectName.toLowerCase()} is useful.`;
    }

    function generateHomework() {
      if (!noteClassField || !noteSubjectField || !noteTopicField) return;
      const className = noteClassField.value;
      const subjectName = noteSubjectField.value;
      const topicName = noteTopicField.value || 'the topic';
      if (!className || !subjectName || !topicName) {
        toast('Fill in class, subject, and topic before generating homework.', 'warning');
        return;
      }
      const conceptText = keyConceptsField && keyConceptsField.value ? keyConceptsField.value : '';
      const detailText = detailedContentField && detailedContentField.value ? detailedContentField.value : '';
      const takeawayText = keyTakeawaysField && keyTakeawaysField.value ? keyTakeawaysField.value : '';

      const notesText = [conceptText, detailText, takeawayText].filter(Boolean).join(' ');
      if (!notesText.trim()) {
        toast('Add some notes or key concepts before generating homework.', 'warning');
        return;
      }

      const age = getLearnerAge(className);
      const conceptPairs = parseConcepts(conceptText);
      const sentences = extractSentences(detailText || conceptText);
      const keywords = Array.from(new Set(tokenize(notesText))).filter(word => word.length > 4).slice(0, 12);

      const counts = buildHomeworkCounts(HOMEWORK_TOTAL);
      const blocks = [];

      counts.forEach(item => {
        for (let i = 0; i < item.count; i++) {
          switch (item.type) {
            case 'multiple_choice':
              blocks.push(buildMultipleChoiceQuestion({ age, subjectName, topicName, conceptPairs, keywords, sentences }));
              break;
            case 'matching':
              blocks.push(buildMatchingQuestion({ age, topicName, conceptPairs }));
              break;
            case 'true_false':
              blocks.push(buildTrueFalseQuestion({ age, topicName, sentences, conceptPairs, keywords }));
              break;
            case 'passage':
              blocks.push(buildPassageQuestion({ age, topicName, sentences, subjectName }));
              break;
            case 'word_problem':
              blocks.push(buildWordProblem({ age, topicName, subjectName }));
              break;
            case 'reflection':
              blocks.push(buildReflectionQuestion({ age, topicName, subjectName }));
              break;
            default:
              break;
          }
        }
      });

      if (practiceQuestionsField) practiceQuestionsField.value = blocks.join('\n\n');
      if (homeworkSummary) {
        const breakdown = counts.map(c => `${c.label}: ${c.count}`).join(', ');
        homeworkSummary.textContent = `Prepared ${blocks.length} questions (${breakdown}).`;
      }
      lessonState.lastHomeworkMeta = {
        generatedAt: Date.now(),
        className,
        subjectName,
        topicName,
        counts
      };
      toast('Homework questions generated.', 'success');
    }

    function syncPageRangeLabel() {
      if (!pageStartInput || !pageEndInput || !topicPages) return;
      const start = parseInt(pageStartInput.value || '1', 10) || 1;
      const end = parseInt(pageEndInput.value || String(start), 10) || start;
      topicPages.textContent = `${start} to ${end}`;
    }

    function syncDetailedContent() {
      if (!detailedContentField) return;
      const selected = Array.from(lessonState.selectedParagraphs)
        .map(id => lessonState.paragraphIndex[id])
        .filter(Boolean)
        .sort((a, b) => {
          if (a.page !== b.page) return a.page - b.page;
          return lessonState.extractedParagraphs.findIndex(p => p.id === a.id) - 
                 lessonState.extractedParagraphs.findIndex(p => p.id === b.id);
        })
        .map(p => p.text)
        .join('\n\n');

      if (selected) {
        const current = detailedContentField.value.trim();
        if (current) {
          detailedContentField.value = current + '\n\n' + selected;
        } else {
          detailedContentField.value = selected;
        }
        lessonState.autoTextSnippet = selected;
        toast('Imported selected paragraphs into Lesson Development.', 'success');
      }
    }

    function clearExtractedText() {
      lessonState.extractedParagraphs = [];
      lessonState.selectedParagraphs.clear();
      lessonState.paragraphIndex = {};
      lessonState.autoTextSnippet = '';
      if (importedPreview) {
        importedPreview.classList.add('hidden');
        importedPreview.innerHTML = '';
      }
      if (detailedContentField && lessonState.previousDetailValue !== null) {
        detailedContentField.value = lessonState.previousDetailValue;
        lessonState.previousDetailValue = null;
      }
    }

    async function handleAutoImport(importToField) {
      if (!lessonState.currentBook || !lessonState.currentBook.book || !pageStartInput || !pageEndInput) {
        toast('Select a book and page range first.', 'warning');
        return;
      }

      const start = parseInt(pageStartInput.value || '1', 10) || 1;
      const end = parseInt(pageEndInput.value || String(start), 10) || start;
      const useOcr = enableOcrToggle && enableOcrToggle.checked;

      if (useOcr) {
        toast('OCR extraction started. This may take a while...', 'warning');
      } else {
        toast('Extracting text from pages...', 'warning');
      }

      try {
        const bookUrl = lessonState.currentBook.book.cloudinaryUrl || lessonState.currentBook.book.url;
        if (!bookUrl) {
          toast('No book URL available.', 'error');
          return;
        }
        
        if (!lessonState.pdfDoc || lessonState.pdfDoc.__bookUrl !== bookUrl) {
          const pdfjs = window.pdfjsLib;
          if (!pdfjs) {
            toast('PDF reader not available.', 'error');
            return;
          }
          if (lessonState.pdfDoc) {
            try { lessonState.pdfDoc.destroy(); } catch (e) {}
          }
          const loadingTask = pdfjs.getDocument({
            url: bookUrl,
            withCredentials: false
          });
          lessonState.pdfDoc = await loadingTask.promise;
          lessonState.pdfDoc.__bookUrl = bookUrl;
          lessonState.pageTextCache = {};
        }

        const paragraphs = await fetchParagraphsFromRange(start, end, useOcr);

        if (!paragraphs.length) {
          toast('No text found in the selected pages.', 'warning');
          return;
        }

        lessonState.extractedParagraphs = paragraphs;
        lessonState.paragraphIndex = {};
        paragraphs.forEach(p => {
          lessonState.paragraphIndex[p.id] = p;
        });

        if (importedPreview && !importToField) {
          importedPreview.innerHTML = paragraphs.map(p => `
            <button type="button" class="${lessonState.selectedParagraphs.has(p.id) ? 'active' : ''}" 
                    onclick="toggleParagraph('${p.id}')">
              <strong>Page ${p.page}:</strong> ${p.text.slice(0, 150)}${p.text.length > 150 ? '...' : ''}
            </button>
          `).join('');
          importedPreview.classList.remove('hidden');
        }

        if (importToField) {
          if (!lessonState.previousDetailValue && detailedContentField) {
            lessonState.previousDetailValue = detailedContentField.value;
          }
          lessonState.selectedParagraphs = new Set(paragraphs.map(p => p.id));
          syncDetailedContent();
        } else {
          toast(`Extracted ${paragraphs.length} paragraphs. Select which ones to import.`, 'success');
        }

      } catch (error) {
        console.error('Auto-import error:', error);
        toast('Error extracting text. Try again or use OCR for scanned pages.', 'error');
      }
    }

    window.toggleParagraph = function(paraId) {
      if (lessonState.selectedParagraphs.has(paraId)) {
        lessonState.selectedParagraphs.delete(paraId);
      } else {
        lessonState.selectedParagraphs.add(paraId);
      }
      if (importedPreview) {
        const btn = importedPreview.querySelector(`button[onclick*="${paraId}"]`);
        if (btn) {
          btn.classList.toggle('active', lessonState.selectedParagraphs.has(paraId));
        }
      }
    };

    workerId = localStorage.getItem('workerId');
    if (!workerId) {
      toast('Please login first', 'error');
      setTimeout(() => window.location.href = '../../index.html', 2000);
    } else {
      resetClassbookUi(true);
      setRevisionBanner(false);
      loadTeacherConfig();
    }

    async function loadTeacherConfig() {
      try {
        const configSnap = await db.ref(`teachers_config/${workerId}`).once('value');
        const workerSnap = await db.ref(`workers/${workerId}/profile`).once('value');
        
        if (!configSnap.exists()) {
          toast('Please complete your teacher profile setup first', 'warning');
          setTimeout(() => window.location.href = '../workertasks.html', 2000);
          return;
        }

        teacherConfig = configSnap.val();
        const profile = workerSnap.val();

        if (profile) {
          const fullName = profile.fullNameUpper || 
            [profile.firstName, profile.middleName, profile.lastName].filter(Boolean).join(' ').toUpperCase();
          if (teacherName) teacherName.textContent = fullName || 'Not Set';
        }
        
        if (teacherConfig && teacherConfig.teacherType) {
          if (teacherType) teacherType.textContent = teacherConfig.teacherType;
        }

        populateSelects();
        loadNotes();
      } catch (error) {
        console.error('Error loading config:', error);
        toast('Error loading teacher configuration', 'error');
      }
    }

    function populateSelects() {
      [filterClass, noteClassField].forEach(select => {
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
      });
      [filterSubject, noteSubjectField].forEach(select => {
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
      });

      (teacherConfig?.classes || []).forEach(className => {
        filterClass?.add(new Option(className, className));
        noteClassField?.add(new Option(className, className));
      });

      (teacherConfig?.subjects || []).forEach(subjectName => {
        filterSubject?.add(new Option(subjectName, subjectName));
        noteSubjectField?.add(new Option(subjectName, subjectName));
      });
    }

    async function loadNotes() {
      try {
        const snap = await db.ref(`lesson_notes/${workerId}`).once('value');
        notes = snap.val() || {};
        totalNotes.textContent = Object.keys(notes).length;
        renderNotes();
      } catch (error) {
        console.error('Error loading notes:', error);
        toast('Error loading notes', 'error');
      }
    }

        function renderNotes() {
      if (!notesList) return;
      const selectedClass = filterClass?.value;
      const selectedSubject = filterSubject?.value;
      const topicFilter = (filterTopic?.value || '').toLowerCase();

      const entries = Object.entries(notes).filter(([id, note]) => {
        if (selectedClass && note.class !== selectedClass) return false;
        if (selectedSubject && note.subject !== selectedSubject) return false;
        if (topicFilter && !(note.topic || '').toLowerCase().includes(topicFilter)) return false;
        return true;
      }).sort((a, b) => (b[1].createdAt || 0) - (a[1].createdAt || 0));

      if (!entries.length) {
        notesList.innerHTML = `
          <div class="empty-state">
            <h3>No Lesson Notes Found</h3>
            <p>Create your first notes or adjust your filters.</p>
          </div>
        `;
        return;
      }

      notesList.innerHTML = entries.map(([id, note]) => {
        const snippetSource = note.detailedContent || note.keyConcepts || '';
        const snippet = snippetSource.length > 200 ? `${snippetSource.slice(0, 200)}...` : (snippetSource || 'No detail captured yet.');
        const pageLabel = note.pageStart && note.pageEnd ? `<span class="meta-tag">Pages ${note.pageStart}-${note.pageEnd}</span>` : '';
        const revisionLabel = note.isRevision ? `<span class="meta-tag" style="background: rgba(236, 72, 153, 0.25);">Revision</span>` : '';
        return `
          <div class="note-card" onclick="viewNote('${id}')">
            <div class="note-header">
              <div>
                <div class="note-title">${note.topic}</div>
                <div class="note-meta">
                  <span class="meta-tag">${note.class}</span>
                  <span class="meta-tag">${note.subject}</span>
                  ${note.subTopic ? `<span class="meta-tag">${note.subTopic}</span>` : ''}
                  <span class="meta-tag">${note.term || 'Term 1'}</span>
                  ${pageLabel}
                  ${revisionLabel}
                </div>
              </div>
            </div>
            <div class="note-content" style="max-height: 120px; overflow: hidden;">
              ${snippet}
            </div>
            <div class="note-actions">
              <button class="btn btn-primary" type="button" onclick="event.stopPropagation(); viewNote('${id}')">View Full Notes</button>
              <button class="btn btn-secondary" type="button" onclick="event.stopPropagation(); editNote('${id}')">Edit</button>
              <button class="btn btn-secondary" type="button" onclick="event.stopPropagation(); deleteNote('${id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

      window.viewNote = function(noteId) {
      const note = notes[noteId];
      if (!note) return;

      const header = [
        `Class: ${note.class}`,
        `Subject: ${note.subject}`,
        `Topic: ${note.topic}`,
        `Sub-topic: ${note.subTopic || 'N/A'}`,
        `Term: ${note.term || 'N/A'}`,
        note.pageStart && note.pageEnd ? `Pages: ${note.pageStart}-${note.pageEnd}` : '',
        note.bookTitle ? `Book: ${note.bookTitle}` : '',
        note.isRevision ? 'Marked as revision: Yes' : ''
      ].filter(Boolean).join('\n');

      const body = [
        'KEY CONCEPTS:',
        note.keyConcepts || 'N/A',
        '',
        'DETAILED CONTENT:',
        note.detailedContent || 'N/A',
        '',
        'EXAMPLES:',
        note.examples || 'N/A',
        '',
        'KEY TAKEAWAYS:',
        note.keyTakeaways || 'N/A',
        '',
        'MISCONCEPTIONS:',
        note.misconceptions || 'N/A',
        '',
        'PRACTICE / HOMEWORK:',
        note.practiceQuestions || 'N/A',
        '',
        'REFERENCES:',
        note.references || 'N/A',
        '',
        'TEACHING TIPS:',
        note.teachingTips || 'N/A'
      ].join('\n');

      alert(`${header}\n\n${body}`);
    };

        window.editNote = function(noteId) {
      const note = notes[noteId];
      if (!note) return;

      editingNoteId = noteId;

      if (noteClassField) noteClassField.value = note.class || '';
      if (noteSubjectField) noteSubjectField.value = note.subject || '';
      if (noteTopicField) noteTopicField.value = note.topic || '';
      if (noteSubTopicField) noteSubTopicField.value = note.subTopic || '';
      if (noteTermField) noteTermField.value = note.term || 'Term 1';
      if (keyConceptsField) keyConceptsField.value = note.keyConcepts || '';
      if (detailedContentField) detailedContentField.value = note.detailedContent || '';
      if (examplesField) examplesField.value = note.examples || '';
      if (keyTakeawaysField) keyTakeawaysField.value = note.keyTakeaways || '';
      if (diagramsField) diagramsField.value = note.diagrams || '';
      if (misconceptionsField) misconceptionsField.value = note.misconceptions || '';
      if (practiceQuestionsField) practiceQuestionsField.value = note.practiceQuestions || '';
      if (referencesField) referencesField.value = note.references || '';
      if (teachingTipsField) teachingTipsField.value = note.teachingTips || '';

      if (homeworkSummary) homeworkSummary.textContent = '';
      lessonState.lastHomeworkMeta = note.homeworkMeta || null;
      lessonState.previousDetailValue = null;
      lessonState.autoTextSnippet = '';
      lessonState.isRevision = !!note.isRevision;
      lessonState.revisionCandidate = null;

      resetClassbookUi(true);

      if (note.pageStart && note.pageEnd && pageStartInput && pageEndInput) {
        pageStartInput.value = note.pageStart;
        pageEndInput.value = note.pageEnd;
        syncPageRangeLabel();
      }

      if (note.bookUrl || note.bookTitle) {
        lessonState.currentBook = {
          yearKey: getAcademicYearKey(),
          book: {
            title: note.bookTitle || 'Classbook',
            cloudinaryUrl: note.bookUrl
          },
          topic: note.bookTopic ? { name: note.bookTopic } : null
        };
        topicMeta?.classList.remove('hidden');
        rangeControls?.classList.remove('hidden');
        autoImportToolbar?.classList.remove('hidden');
        if (topicBookTitle) topicBookTitle.textContent = note.bookTitle || 'Classbook';
        if (topicKeywords) topicKeywords.textContent = note.matchedKeywords || 'Imported manually';
        if (topicPages && note.pageStart && note.pageEnd) topicPages.textContent = `${note.pageStart} to ${note.pageEnd}`;
        const hasUrl = Boolean(note.bookUrl);
        if (openPagesBtn) openPagesBtn.disabled = !hasUrl;
        if (autoImportBtn) autoImportBtn.disabled = !hasUrl;
        if (importToNotesBtn) importToNotesBtn.disabled = !hasUrl;
        if (previewExtractBtn) previewExtractBtn.disabled = !hasUrl;
        if (clearExtractBtn) clearExtractBtn.disabled = false;
        if (clearImportBtn) clearImportBtn.disabled = false;
        if (hasUrl && openExternalBookLink) {
          openExternalBookLink.classList.remove('hidden');
          openExternalBookLink.href = note.bookUrl;
        }
        updateTopicStatus('ok', 'Using the saved book settings for this note.');
      }

      notesForm?.classList.remove('hidden');
      notesForm?.scrollIntoView({ behavior: 'smooth' });

      checkRevisionFlag();
    };

        window.deleteNote = async function(noteId) {
      if (!confirm('Are you sure you want to delete these lesson notes?')) return;

      try {
        await db.ref(`lesson_notes/${workerId}/${noteId}`).remove();
        delete notes[noteId];
        toast('Lesson notes deleted successfully.', 'success');
        totalNotes.textContent = Object.keys(notes).length;
        renderNotes();
      } catch (error) {
        console.error('Error deleting note:', error);
        toast('Error deleting note.', 'error');
      }
    };

    if (newNoteBtn) {
      newNoteBtn.addEventListener('click', () => {
        editingNoteId = null;
        lessonState.isRevision = false;
        lessonState.revisionCandidate = null;
        lessonState.lastHomeworkMeta = null;
        lessonState.previousDetailValue = null;
        lessonState.autoTextSnippet = '';
        setRevisionBanner(false);
        resetClassbookUi(true);
        const fields = document.querySelectorAll('#notesForm input, #notesForm textarea, #notesForm select');
        fields.forEach(el => {
          const tag = el.tagName;
          if (tag === 'TEXTAREA') {
            el.value = '';
          } else if (tag === 'SELECT') {
            el.selectedIndex = 0;
          } else {
            el.value = '';
          }
        });
        if (homeworkSummary) homeworkSummary.textContent = '';
        if (notesForm) {
          notesForm.classList.remove('hidden');
          notesForm.scrollIntoView({ behavior: 'smooth' });
        }
      });
    }

    if (cancelNoteBtn) {
      cancelNoteBtn.addEventListener('click', () => {
        if (notesForm) notesForm.classList.add('hidden');
        editingNoteId = null;
        lessonState.isRevision = false;
        lessonState.revisionCandidate = null;
        setRevisionBanner(false);
        resetClassbookUi(true);
      });
    }
    if (saveNoteBtn) {
      saveNoteBtn.addEventListener('click', async () => {
      const requiredFields = [noteClassField, noteSubjectField, noteTopicField, keyConceptsField, detailedContentField];
      for (const field of requiredFields) {
        if (!field || !field.value || !field.value.trim()) {
          const label = field && field.previousElementSibling ? field.previousElementSibling.textContent : 'this field';
          toast('Please fill in: ' + label, 'warning');
          if (field) field.focus();
          return;
        }
      }

      // Auto-generate homework if empty
      let practiceQuestionsValue = practiceQuestionsField ? practiceQuestionsField.value.trim() : '';
      if (!practiceQuestionsValue) {
        const className = noteClassField ? noteClassField.value : '';
        const subjectName = noteSubjectField ? noteSubjectField.value : '';
        const topicName = noteTopicField ? noteTopicField.value : '';
        const conceptText = keyConceptsField ? keyConceptsField.value : '';
        const detailText = detailedContentField ? detailedContentField.value : '';
        const takeawayText = keyTakeawaysField ? keyTakeawaysField.value : '';
        const notesText = [conceptText, detailText, takeawayText].filter(Boolean).join(' ');
        
        if (notesText.trim() && className && subjectName && topicName) {
          const age = getLearnerAge(className);
          const conceptPairs = parseConcepts(conceptText);
          const sentences = extractSentences(detailText || conceptText);
          const keywords = Array.from(new Set(tokenize(notesText))).filter(word => word.length > 4).slice(0, 12);
          const counts = buildHomeworkCounts(HOMEWORK_TOTAL);
          const blocks = [];

          counts.forEach(item => {
            for (let i = 0; i < item.count; i++) {
              switch (item.type) {
                case 'multiple_choice':
                  blocks.push(buildMultipleChoiceQuestion({ age, subjectName, topicName, conceptPairs, keywords, sentences }));
                  break;
                case 'matching':
                  blocks.push(buildMatchingQuestion({ age, topicName, conceptPairs }));
                  break;
                case 'true_false':
                  blocks.push(buildTrueFalseQuestion({ age, topicName, sentences, conceptPairs, keywords }));
                  break;
                case 'passage':
                  blocks.push(buildPassageQuestion({ age, topicName, sentences, subjectName }));
                  break;
                case 'word_problem':
                  blocks.push(buildWordProblem({ age, topicName, subjectName }));
                  break;
                case 'reflection':
                  blocks.push(buildReflectionQuestion({ age, topicName, subjectName }));
                  break;
              }
            }
          });

          practiceQuestionsValue = blocks.join('\n\n');
          if (practiceQuestionsField) practiceQuestionsField.value = practiceQuestionsValue;
          lessonState.lastHomeworkMeta = {
            generatedAt: Date.now(),
            className,
            subjectName,
            topicName,
            counts,
            autoGenerated: true
          };
        }
      }

      const noteData = {
        class: noteClassField ? noteClassField.value : '',
        subject: noteSubjectField ? noteSubjectField.value : '',
        topic: noteTopicField ? noteTopicField.value : '',
        subTopic: noteSubTopicField ? noteSubTopicField.value : '',
        term: noteTermField ? noteTermField.value : 'Term 1',
        keyConcepts: keyConceptsField ? keyConceptsField.value : '',
        detailedContent: detailedContentField ? detailedContentField.value : '',
        examples: examplesField ? examplesField.value : '',
        keyTakeaways: keyTakeawaysField ? keyTakeawaysField.value : '',
        diagrams: diagramsField ? diagramsField.value : '',
        misconceptions: misconceptionsField ? misconceptionsField.value : '',
        practiceQuestions: practiceQuestionsValue,
        references: referencesField ? referencesField.value : '',
        teachingTips: teachingTipsField ? teachingTipsField.value : '',
        isRevision: lessonState.isRevision
      };

      const startValue = parseInt(pageStartInput && pageStartInput.value ? pageStartInput.value : '', 10);
      const endValue = parseInt(pageEndInput && pageEndInput.value ? pageEndInput.value : '', 10);
      const hasBookUrl = lessonState.currentBook && lessonState.currentBook.book && (lessonState.currentBook.book.cloudinaryUrl || lessonState.currentBook.book.url);

      if (!Number.isNaN(startValue) && !Number.isNaN(endValue) && hasBookUrl) {
        noteData.pageStart = startValue;
        noteData.pageEnd = endValue;
      } else {
        noteData.pageStart = null;
        noteData.pageEnd = null;
      }

      if (lessonState.currentBook && lessonState.currentBook.book) {
        if (lessonState.currentBook.book.title) noteData.bookTitle = lessonState.currentBook.book.title;
        const bookUrl = lessonState.currentBook.book.cloudinaryUrl || lessonState.currentBook.book.url;
        if (bookUrl) noteData.bookUrl = bookUrl;
      }
      if (lessonState.currentBook && lessonState.currentBook.topic) {
        if (lessonState.currentBook.topic.name) noteData.bookTopic = lessonState.currentBook.topic.name;
        if (Array.isArray(lessonState.currentBook.topic.keywords)) {
          noteData.matchedKeywords = lessonState.currentBook.topic.keywords.join(', ');
        }
      }
      if (lessonState.autoTextSnippet) {
        noteData.autoImportedAt = Date.now();
      }
      if (lessonState.lastHomeworkMeta) {
        noteData.homeworkMeta = lessonState.lastHomeworkMeta;
      }

      try {
        if (editingNoteId) {
          noteData.updatedAt = Date.now();
          await db.ref('lesson_notes/' + workerId + '/' + editingNoteId).update(noteData);
          notes[editingNoteId] = Object.assign({}, notes[editingNoteId], noteData);
          toast('Lesson notes updated successfully.', 'success');
        } else {
          noteData.createdAt = Date.now();
          noteData.teacherName = teacherName ? teacherName.textContent : '';
          const newRef = db.ref('lesson_notes/' + workerId).push();
          await newRef.set(noteData);
          notes[newRef.key] = noteData;
          toast('Lesson notes created successfully.', 'success');
        }

        if (totalNotes) totalNotes.textContent = String(Object.keys(notes).length);
        renderNotes();
        if (notesForm) notesForm.classList.add('hidden');
        editingNoteId = null;
        lessonState.isRevision = false;
        lessonState.revisionCandidate = null;
        lessonState.lastHomeworkMeta = null;
        lessonState.previousDetailValue = null;
        lessonState.autoTextSnippet = '';
        setRevisionBanner(false);
        resetClassbookUi(true);
      } catch (error) {
        console.error('Error saving note:', error);
        toast('Error saving lesson notes.', 'error');
      }
      });
    }
    if (filterClass) filterClass.addEventListener('change', renderNotes);
    if (filterSubject) filterSubject.addEventListener('change', renderNotes);
    if (filterTopic) filterTopic.addEventListener('input', renderNotes);

    if (findTopicBtn) findTopicBtn.addEventListener('click', findTopicInClassbooks);
    if (openPagesBtn) openPagesBtn.addEventListener('click', openPdfModalForRange);
    if (appendVisibleBtn) {
      appendVisibleBtn.addEventListener('click', () => {
        if (lessonState.extractedParagraphs.length && importedPreview) {
          lessonState.selectedParagraphs = new Set(lessonState.extractedParagraphs.map(p => p.id));
          importedPreview.querySelectorAll('button').forEach(btn => btn.classList.add('active'));
          syncDetailedContent();
          toast('Imported the current selection into Lesson Development.', 'success');
        } else {
          handleAutoImport(true);
        }
      });
    }
    if (closePdfBtn) closePdfBtn.addEventListener('click', closePdfModal);
    if (pdfModal) {
      pdfModal.addEventListener('click', event => {
        if (event.target === pdfModal) closePdfModal();
      });
    }

    if (autoImportBtn) autoImportBtn.addEventListener('click', () => handleAutoImport(true));
    if (importToNotesBtn) importToNotesBtn.addEventListener('click', () => handleAutoImport(true));
    if (previewExtractBtn) previewExtractBtn.addEventListener('click', () => handleAutoImport(false));
    if (clearExtractBtn) {
      clearExtractBtn.addEventListener('click', () => {
        clearExtractedText();
        updateTopicStatus('warn', 'Auto-import cleared. Adjust the range or import again.');
      });
    }
    if (clearImportBtn) {
      clearImportBtn.addEventListener('click', () => {
        clearExtractedText();
        updateTopicStatus('warn', 'Auto-import cleared. Adjust the range or import again.');
      });
    }

    if (pageStartInput) pageStartInput.addEventListener('change', syncPageRangeLabel);
    if (pageEndInput) pageEndInput.addEventListener('change', syncPageRangeLabel);

    if (markRevisionBtn) markRevisionBtn.addEventListener('click', () => {
      lessonState.isRevision = true;
      setRevisionBanner(false);
      toast('Marked this note as a revision.', 'success');
    });

    if (dismissRevisionBtn) dismissRevisionBtn.addEventListener('click', () => {
      lessonState.isRevision = false;
      setRevisionBanner(false);
    });

    if (noteClassField) noteClassField.addEventListener('change', () => {
      resetClassbookUi(true);
      checkRevisionFlag();
    });
    if (noteSubjectField) noteSubjectField.addEventListener('change', () => {
      resetClassbookUi(true);
      checkRevisionFlag();
    });
    if (noteTopicField) noteTopicField.addEventListener('blur', () => {
      checkRevisionFlag();
    });

    if (generateHomeworkBtn) generateHomeworkBtn.addEventListener('click', generateHomework);
    if (clearHomeworkBtn) {
      clearHomeworkBtn.addEventListener('click', () => {
        if (practiceQuestionsField) practiceQuestionsField.value = '';
        if (homeworkSummary) homeworkSummary.textContent = '';
        lessonState.lastHomeworkMeta = null;
      });
    }

  </script>
</body>
</html>















