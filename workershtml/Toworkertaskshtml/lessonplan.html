<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lesson Plans | SoMAp Teacher Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: rgba(255, 255, 255, 0.95);
      padding: 20px;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 30% 40%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(162, 155, 254, 0.3) 0%, transparent 50%);
      animation: bgPulse 20s ease infinite;
      z-index: -1;
    }

    @keyframes bgPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 24px 32px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #fff 0%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-subtitle {
      color: rgba(255, 255, 255, 0.7);
      margin-top: 4px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-back {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #f093fb, #667eea);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.15);
      color: white;
    }

    /* Info Section */
    .teacher-info {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .info-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .info-value {
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* Controls */
    .controls {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .form-group select,
    .form-group input,
    .form-group textarea {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #f093fb;
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 4px rgba(240, 147, 251, 0.2);
    }

    .form-group select option {
      background: #5a67d8;
      color: white;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    /* Lesson Plan Form */
    .lesson-form {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
    }

    .lesson-form h3 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: white;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    /* Lesson Plans List */
    .plans-list {
      display: grid;
      gap: 16px;
    }

    .plan-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .plan-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      border-color: #f093fb;
    }

    .plan-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
      gap: 16px;
    }

    .plan-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: white;
      margin-bottom: 8px;
    }

    .plan-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .meta-tag {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .plan-details {
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.6;
      margin-top: 12px;
    }

    .plan-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 12px;
    }

    .empty-state p {
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 20px;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .toast {
      background: rgba(16, 185, 129, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
    }

    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast.success { background: rgba(16, 185, 129, 0.95); }
    .toast.error { background: rgba(239, 68, 68, 0.95); }
    .toast.warning { background: rgba(245, 158, 11, 0.95); }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }

      .controls-grid,
      .form-row {
        grid-template-columns: 1fr;
      }

      .plan-header {
        flex-direction: column;
      }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div>
        <h1>üìù Lesson Plans</h1>
        <p class="header-subtitle">Create and manage your lesson plans</p>
      </div>
      <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
        <!-- Year Selector -->
        <div id="somapYearWrap" style="display:flex;gap:.5rem;align-items:center;">
          <label style="color: rgba(255,255,255,0.9); font-size: 0.85rem; font-weight: 600;">Academic Year</label>
          <select data-somap-year-select style="padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 0.9rem;"></select>
          <span style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">Working year: <b id="lpYearHint" style="color: white;">--</b></span>
        </div>
        <a href="../workertasks.html" class="btn btn-back">
          ‚Üê Back to Dashboard
        </a>
      </div>
    </div>

    <!-- Teacher Info -->
    <div class="teacher-info" id="teacherInfo">
      <div class="info-item">
        <span class="info-label">Teacher Name</span>
        <span class="info-value" id="teacherName">Loading...</span>
      </div>
      <div class="info-item">
        <span class="info-label">Teacher Type</span>
        <span class="info-value" id="teacherType">Loading...</span>
      </div>
      <div class="info-item">
        <span class="info-label">Total Plans</span>
        <span class="info-value" id="totalPlans">0</span>
      </div>
      <div class="info-item">
        <span class="info-label">Date</span>
        <span class="info-value" id="currentDate">Loading...</span>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="controls-grid">
        <div class="form-group">
          <label>Filter by Class</label>
          <select id="filterClass">
            <option value="">All Classes</option>
          </select>
        </div>
        <div class="form-group">
          <label>Filter by Subject</label>
          <select id="filterSubject">
            <option value="">All Subjects</option>
          </select>
        </div>
        <div class="form-group">
          <label>Filter by Term</label>
          <select id="filterTerm">
            <option value="">All Terms</option>
            <option value="Term 1">Term 1</option>
            <option value="Term 2">Term 2</option>
            <option value="Term 3">Term 3</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary" id="newPlanBtn">
        ‚ú® Create New Lesson Plan
      </button>
    </div>

    <!-- Lesson Plan Form (hidden by default) -->
    <div class="lesson-form hidden" id="lessonForm">
      <h3>‚úçÔ∏è New Lesson Plan</h3>
      
      <div class="form-row">
        <div class="form-group">
          <label>Class *</label>
          <select id="planClass" required>
            <option value="">Select Class</option>
          </select>
        </div>
        <div class="form-group">
          <label>Subject *</label>
          <select id="planSubject" required>
            <option value="">Select Subject</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Term *</label>
          <select id="planTerm" required>
            <option value="Term 1">Term 1</option>
            <option value="Term 2">Term 2</option>
            <option value="Term 3">Term 3</option>
          </select>
        </div>
        <div class="form-group">
          <label>Week Number *</label>
          <input type="number" id="planWeek" min="1" max="16" placeholder="e.g., 1" required>
        </div>
        <div class="form-group">
          <label>Lesson Date *</label>
          <input type="date" id="planDate" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Total Students in Class *</label>
          <input type="number" id="totalStudents" min="1" placeholder="Auto-filled from roster" readonly style="background: rgba(255,255,255,0.08); cursor: not-allowed;">
        </div>
        <div class="form-group">
          <label>Students Present Today *</label>
          <input type="number" id="studentsPresent" min="0" placeholder="Auto-filled from attendance" readonly style="background: rgba(255,255,255,0.08); cursor: not-allowed;">
        </div>
        <div class="form-group">
          <label>Duration (minutes) *</label>
          <input type="number" id="planDuration" min="30" max="180" placeholder="e.g., 45" required>
        </div>
      </div>

      <!-- Attendance Stats Cards -->
      <div id="lpCountsCard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 16px 0; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
        <div style="padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">
          <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Total Students</div>
          <div id="statTotal" style="font-size: 1.5rem; font-weight: 700; color: white;">--</div>
        </div>
        <div style="padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">
          <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Present ‚ôÇ/‚ôÄ</div>
          <div style="font-size: 1.2rem; font-weight: 600; color: white;"><b id="statPB">0</b> / <b id="statPG">0</b></div>
        </div>
        <div style="padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">
          <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Absent ‚ôÇ/‚ôÄ</div>
          <div style="font-size: 1.2rem; font-weight: 600; color: white;"><b id="statAB">0</b> / <b id="statAG">0</b></div>
        </div>
        <div style="padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">
          <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Status</div>
          <div id="statNote" style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">‚Äî</div>
        </div>
      </div>

      <!-- Hidden fields for boys/girls counts -->
      <input type="hidden" id="lpPresentBoys" value="0">
      <input type="hidden" id="lpPresentGirls" value="0">
      <input type="hidden" id="lpAbsentBoys" value="0">
      <input type="hidden" id="lpAbsentGirls" value="0">

      <div class="form-group">
        <label>Topic / Theme *</label>
        <input type="text" id="planTopic" placeholder="e.g., Addition and Subtraction" required>
      </div>

      <div class="form-group">
        <label>Learning Objectives *</label>
        <textarea id="planObjectives" placeholder="What should students learn by the end of this lesson?" required></textarea>
      </div>

      <div class="form-group">
        <label>Introduction / Set Induction *</label>
        <textarea id="planIntro" placeholder="How will you introduce the topic and capture students' attention?" required></textarea>
      </div>

      <div class="form-group">
        <label>Main Activities / Lesson Development *</label>
        <textarea id="planActivities" placeholder="Describe the main teaching and learning activities..." required></textarea>
      </div>

      <div class="form-group">
        <label>Teaching Resources / Materials</label>
        <textarea id="planResources" placeholder="Charts, textbooks, videos, manipulatives, etc."></textarea>
      </div>

      <div class="form-group">
        <label>Assessment / Evaluation Method *</label>
        <textarea id="planAssessment" placeholder="How will you assess if students understood the lesson?" required></textarea>
      </div>

      <div class="form-group">
        <label>Conclusion / Summary *</label>
        <textarea id="planConclusion" placeholder="How will you wrap up the lesson?" required></textarea>
      </div>

      <div class="form-group">
        <label>Homework / Assignment</label>
        <textarea id="planHomework" placeholder="Any homework or follow-up tasks?"></textarea>
      </div>

      <div class="form-group">
        <label>Reflection / Notes</label>
        <textarea id="planReflection" placeholder="Post-lesson reflections, what went well, areas for improvement..."></textarea>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap;">
        <button class="btn btn-success" id="savePlanBtn">üíæ Save Lesson Plan</button>
        <button class="btn btn-secondary" id="cancelPlanBtn">Cancel</button>
      </div>
    </div>

    <!-- Export Section -->
    <div class="controls">
      <h3 style="color: white; margin-bottom: 16px; font-size: 1.2rem;">üì• Export Lesson Plans</h3>
      <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
        <div class="form-group" style="flex: 1; min-width: 150px;">
          <label>From Date</label>
          <input type="date" id="lpFromDate" style="width: 100%;">
        </div>
        <div class="form-group" style="flex: 1; min-width: 150px;">
          <label>To Date</label>
          <input type="date" id="lpToDate" style="width: 100%;">
        </div>
        <div style="display: flex; gap: 8px; align-items: flex-end;">
          <button class="btn btn-secondary" id="lpExportPdf" style="background: linear-gradient(135deg, #ef4444, #dc2626);">üìÑ Export PDF</button>
          <button class="btn btn-secondary" id="lpExportCsv" style="background: linear-gradient(135deg, #10b981, #059669);">üìä Export CSV</button>
        </div>
      </div>
    </div>

    <!-- Lesson Plans List -->
    <div id="plansList">
      <div class="empty-state">
        <h3>üìö No Lesson Plans Yet</h3>
        <p>Click "Create New Lesson Plan" to get started!</p>
      </div>
    </div>
  </div>

  <!-- Export Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ========== YEAR CONTEXT & CLASS SHIFTING ==========
    const SOMAP_ALLOWED_YEARS = Array.from({length: 20}, (_,i)=>2023+i); // 2023..2042
    const SOMAP_DEFAULT_YEAR = 2025;
    const CLASS_ORDER = ['Baby Class','Middle Class','Pre Unit Class','Class 1','Class 1AB','Class 2AB','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
    
    const L = s => String(s||'').trim().toLowerCase();

    function shiftClass(baseClass, deltaYears){
      const i = CLASS_ORDER.findIndex(c => L(c)===L(baseClass));
      if (i<0) return baseClass||'';
      const j = i + Number(deltaYears||0);
      if (j < 0) return 'PRE-ADMISSION';
      if (j >= CLASS_ORDER.length) return 'GRADUATED';
      return CLASS_ORDER[j];
    }

    window.somapYearContext = window.somapYearContext || (function(){
      let selected = (sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR)+'';
      const listeners = new Set();
      return {
        getSelectedYear(){ return selected; },
        setSelectedYear(y){
          y = String(y);
          if (selected===y) return;
          selected = y;
          try{ sessionStorage.setItem('somap_selected_year', y); }catch{}
          listeners.forEach(fn=>{ try{ fn(y); }catch{} });
        },
        onYearChanged(fn){ if (typeof fn==='function') listeners.add(fn); }
      };
    })();
  </script>

  <script type="module">
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    window.db = db;

    // State
    let workerId = null;
    let teacherConfig = null;
    let lessonPlans = {};
    let editingPlanId = null;

    // UI Elements
    const teacherName = document.getElementById('teacherName');
    const teacherType = document.getElementById('teacherType');
    const currentDate = document.getElementById('currentDate');
    const totalPlans = document.getElementById('totalPlans');
    const filterClass = document.getElementById('filterClass');
    const filterSubject = document.getElementById('filterSubject');
    const filterTerm = document.getElementById('filterTerm');
    const newPlanBtn = document.getElementById('newPlanBtn');
    const lessonForm = document.getElementById('lessonForm');
    const cancelPlanBtn = document.getElementById('cancelPlanBtn');
    const savePlanBtn = document.getElementById('savePlanBtn');
    const plansList = document.getElementById('plansList');
    const planClass = document.getElementById('planClass');
    const planSubject = document.getElementById('planSubject');

    // Toast
    function toast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toastEl = document.createElement('div');
      toastEl.className = `toast ${type}`;
      toastEl.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toastEl);
      setTimeout(() => toastEl.classList.add('show'), 100);
      setTimeout(() => {
        toastEl.classList.remove('show');
        setTimeout(() => toastEl.remove(), 300);
      }, 3000);
    }

    // Initialize Date
    currentDate.textContent = new Date().toLocaleDateString('en-US', {
      timeZone: 'Africa/Nairobi',
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    // ========== YEAR SELECTOR INITIALIZATION ==========
    (function initYearSelector(){
      const sel = document.querySelector('[data-somap-year-select]');
      const hint = document.getElementById('lpYearHint');
      if (!sel) return;
      
      sel.innerHTML = SOMAP_ALLOWED_YEARS.map(y=>`<option value="${y}">${y}</option>`).join('');
      const current = window.somapYearContext.getSelectedYear();
      sel.value = current;
      if (hint) hint.textContent = current;
      
      sel.addEventListener('change', e=>{
        const y = String(e.target.value);
        window.somapYearContext.setSelectedYear(y);
        if (hint) hint.textContent = y;
        recomputeForSelection();
        loadLessonPlans();
      });
    })();

    // ========== DATA LOADERS ==========
    function yyyymmdd(dateStr){
      const d = new Date(dateStr);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}${m}${da}`;
    }

    async function getBaseMaps(year){
      const anchorY = String(SOMAP_DEFAULT_YEAR), y = String(year);
      const [studentsSnap, anchorSnap, ySnap, listSnap] = await Promise.all([
        db.ref('students').once('value'),
        db.ref(`enrollments/${anchorY}`).once('value').catch(()=>({val:()=>null})),
        db.ref(`enrollments/${y}`).once('value').catch(()=>({val:()=>null})),
        db.ref(`studentlist/${y}`).once('value').catch(()=>({val:()=>null}))
      ]);
      return {
        students: (studentsSnap && studentsSnap.val && studentsSnap.val())||{},
        enrollAnchor: (anchorSnap && anchorSnap.val && anchorSnap.val())||{},
        enrollYear: (ySnap && ySnap.val && ySnap.val())||{},
        studentlistYear: (listSnap && listSnap.val && listSnap.val())||{}
      };
    }

    function resolveClassForYear(studentId, studentRecord, enrollAnchor, enrollYear, targetYear){
      // First, try to get class directly from student record (most reliable for current year)
      const directClass = studentRecord?.classLevel || studentRecord?.className || studentRecord?.class || '';
      if (directClass && String(targetYear) === String(SOMAP_DEFAULT_YEAR)) {
        return directClass;
      }
      
      // For other years, use enrollment data with shifting
      const anchor = enrollAnchor[studentId]||{};
      const baseClass = anchor.className || anchor.classLevel || directClass || studentRecord?.classLevel || studentRecord?.className || 'Baby Class';
      const yrRec = enrollYear[studentId]||{};
      if (yrRec.className || yrRec.classLevel) return (yrRec.className || yrRec.classLevel);
      
      // Shift from anchor year
      const delta = Number(targetYear) - SOMAP_DEFAULT_YEAR;
      return shiftClass(baseClass, delta);
    }

    function countClassForYear(targetClass, maps, targetYear){
      // Try explicit studentlist/{year}/{className} first
      const yList = maps.studentlistYear?.[targetClass];
      if (yList && typeof yList === 'object' && Object.keys(yList).length > 0) {
        return Object.keys(yList).length;
      }
      
      // Count from students collection directly
      let n = 0;
      const students = maps.students || {};
      
      for(const id of Object.keys(students)){
        const studentRecord = students[id];
        if (!studentRecord || typeof studentRecord !== 'object') continue;
        
        // Get class for this year
        const cls = resolveClassForYear(id, studentRecord, maps.enrollAnchor, maps.enrollYear, targetYear);
        
        // Normalize both class names for comparison (case-insensitive, trim spaces)
        const normalizedTarget = L(targetClass);
        const normalizedClass = L(cls);
        
        if (normalizedClass === normalizedTarget) {
          n++;
        }
      }
      
      console.log(`Counted ${n} students for ${targetClass} in year ${targetYear}`);
      return n;
    }

    async function loadAttendanceCounts(year, className, dateStr, studentsMap){
      const y = String(year), cls = className.trim(), key = yyyymmdd(dateStr);
      const tryPaths = [
        `classAttendance/${y}/${cls}/${key}`,
        `attendance/class/${y}/${cls}/${key}`,
        `attendance/${y}/${cls}/${key}`,
        `classAttendance/${cls}/${key}`,
        `attendance/${cls}/${key}`,
        // Also try alternative class name formats
        `classAttendance/${y}/${cls.replace(/\s+/g, '_')}/${key}`,
        `attendance/${y}/${cls.replace(/\s+/g, '_')}/${key}`,
        `classAttendance/${cls.replace(/\s+/g, '_')}/${key}`,
        `attendance/${cls.replace(/\s+/g, '_')}/${key}`
      ];
      
      let node = null;
      let usedPath = null;
      
      for(const p of tryPaths){
        try {
          const snap = await db.ref(p).once('value');
          const val = snap && snap.val ? snap.val() : null;
          if (val && typeof val === 'object' && Object.keys(val).length > 0){ 
            node = val; 
            usedPath = p;
            console.log(`Found attendance at path: ${p}`);
            break; 
          }
        } catch(e) { 
          console.log(`Tried path ${p}, not found`);
          continue; 
        }
      }
      
      if (!node) {
        console.log(`No attendance data found for ${cls} on ${dateStr}`);
        return { present:0, absent:0, boysP:0, girlsP:0, boysA:0, girlsA:0 };
      }
      
      let pb=0, pg=0, ab=0, ag=0;
      
      for(const sid of Object.keys(node)){
        const rec = node[sid]||{};
        // Check multiple status formats
        const status = String(rec.status || rec.s || (rec.am || rec.pm || '') || '').toUpperCase().trim();
        const amStatus = String(rec.am || '').toUpperCase().trim();
        const pmStatus = String(rec.pm || '').toUpperCase().trim();
        
        // Consider present if status is P, PRESENT, 1, true, or if either AM/PM is P
        const isPresent = status==='P' || status==='PRESENT' || status==='1' || status===1 || status===true || 
                         amStatus==='P' || pmStatus==='P';
        
        // Get gender from attendance record or student record
        const genderFromAtt = String(rec.gender || rec.sex || '').toUpperCase().trim();
        const studentRecord = studentsMap[sid];
        const genderFromStudent = String(studentRecord?.gender || studentRecord?.sex || '').toUpperCase().trim();
        const gen = genderFromAtt || genderFromStudent;
        const isBoy = gen==='M' || gen==='B' || gen==='BOY' || gen==='MALE';
        
        if (isPresent){
          if(isBoy) pb++; else pg++;
        } else {
          if(isBoy) ab++; else ag++;
        }
      }
      
      console.log(`Attendance counts - Present: ${pb+pg} (‚ôÇ${pb} ‚ôÄ${pg}), Absent: ${ab+ag} (‚ôÇ${ab} ‚ôÄ${ag})`);
      
      return { present: pb+pg, absent: ab+ag, boysP:pb, girlsP:pg, boysA:ab, girlsA:ag };
    }

    // ========== AUTO-FILL LOGIC ==========
    async function recomputeForSelection(){
      const year = window.somapYearContext.getSelectedYear();
      const clsSel = document.getElementById('planClass');
      const dateInp = document.getElementById('planDate');
      const totalInp = document.getElementById('totalStudents');
      const presentInp = document.getElementById('studentsPresent');
      const pbEl = document.getElementById('lpPresentBoys'), pgEl = document.getElementById('lpPresentGirls');
      const abEl = document.getElementById('lpAbsentBoys'), agEl = document.getElementById('lpAbsentGirls');
      const statTotal = document.getElementById('statTotal'), statPB=document.getElementById('statPB'), statPG=document.getElementById('statPG'), 
            statAB=document.getElementById('statAB'), statAG=document.getElementById('statAG'), statNote=document.getElementById('statNote');

      if (!clsSel || !clsSel.value) {
        if(statNote) statNote.textContent = 'Select a class first';
        return;
      }
      
      const chosenClass = clsSel.value.trim();

      try {
        if(statNote) statNote.textContent = 'Loading student data...';
        
        const maps = await getBaseMaps(year);
        console.log('Loaded maps:', {
          studentsCount: Object.keys(maps.students || {}).length,
          enrollAnchorCount: Object.keys(maps.enrollAnchor || {}).length,
          studentlistYear: Object.keys(maps.studentlistYear || {}).length
        });
        
        if (L(chosenClass)==='graduated'){
          totalInp.value = 0;
          presentInp.value = 0;
          [pbEl,pgEl,abEl,agEl].forEach(el=>{ if(el) el.value=0; });
          if(statTotal) statTotal.textContent='0';
          if(statNote) statNote.textContent='Class is graduated in '+year;
          if(statPB) statPB.textContent='0';
          if(statPG) statPG.textContent='0';
          if(statAB) statAB.textContent='0';
          if(statAG) statAG.textContent='0';
          return;
        }

        const total = countClassForYear(chosenClass, maps, year);
        console.log(`Total students for ${chosenClass} in ${year}: ${total}`);
        
        if (totalInp){ 
          totalInp.value = total || 0; 
        }
        if (statTotal) statTotal.textContent = total || 0;

        if (dateInp && dateInp.value){
          if(statNote) statNote.textContent = 'Loading attendance data...';
          const att = await loadAttendanceCounts(year, chosenClass, dateInp.value, maps.students||{});
          console.log('Attendance data:', att);
          
          if (presentInp) presentInp.value = att.present || 0;
          if (pbEl) pbEl.value = att.boysP || 0;
          if (pgEl) pgEl.value = att.girlsP || 0;
          if (abEl) abEl.value = att.boysA || 0;
          if (agEl) agEl.value = att.girlsA || 0;
          if (statPB) statPB.textContent = att.boysP || 0;
          if (statPG) statPG.textContent = att.girlsP || 0;
          if (statAB) statAB.textContent = att.boysA || 0;
          if (statAG) statAG.textContent = att.girlsA || 0;
          if (statNote) statNote.textContent = `Auto from attendance: ${dateInp.value} (${att.present} present)`;
        } else {
          if (presentInp) presentInp.value = '';
          [pbEl,pgEl,abEl,agEl].forEach(el=>{ if(el) el.value = ''; });
          if (statPB) statPB.textContent = '0';
          if (statPG) statPG.textContent = '0';
          if (statAB) statAB.textContent = '0';
          if (statAG) statAG.textContent = '0';
          if (statNote) statNote.textContent = `Total: ${total || 0} students. Pick a Lesson Date to pull attendance.`;
        }
      } catch(error) {
        console.error('Error in recomputeForSelection:', error);
        if(statNote) statNote.textContent = 'Error loading data: ' + error.message;
      }
    }

    // Wire change listeners
    ['planClass','planDate'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', recomputeForSelection);
    });
    
    window.somapYearContext.onYearChanged(()=>recomputeForSelection());

    // Get worker ID from localStorage
    workerId = localStorage.getItem('workerId');
    if (!workerId) {
      toast('Please login first', 'error');
      setTimeout(() => window.location.href = '../../index.html', 2000);
    }

    // Load teacher config
    async function loadTeacherConfig() {
      try {
        const configSnap = await db.ref(`teachers_config/${workerId}`).once('value');
        const workerSnap = await db.ref(`workers/${workerId}/profile`).once('value');
        
        if (!configSnap.exists()) {
          toast('Please complete your teacher profile setup first', 'warning');
          setTimeout(() => window.location.href = '../workertasks.html', 2000);
          return;
        }

        teacherConfig = configSnap.val();
        const profile = workerSnap.val();

        // Update UI
        const fullName = profile.fullNameUpper || 
          [profile.firstName, profile.middleName, profile.lastName].filter(Boolean).join(' ').toUpperCase();
        teacherName.textContent = fullName;
        teacherType.textContent = teacherConfig.teacherType;

        // Populate filters and form selects
        populateSelects();

        // Load lesson plans
        loadLessonPlans();
      } catch (error) {
        console.error('Error loading config:', error);
        toast('Error loading teacher configuration', 'error');
      }
    }

    // Populate select dropdowns
    function populateSelects() {
      // Classes
      teacherConfig.classes.forEach(className => {
        const opt1 = new Option(className, className);
        const opt2 = new Option(className, className);
        filterClass.add(opt1);
        planClass.add(opt2);
      });

      // Subjects
      teacherConfig.subjects.forEach(subject => {
        const opt1 = new Option(subject, subject);
        const opt2 = new Option(subject, subject);
        filterSubject.add(opt1);
        planSubject.add(opt2);
      });
    }

    // Load lesson plans (year-aware)
    async function loadLessonPlans() {
      try {
        const year = window.somapYearContext.getSelectedYear();
        const schoolId = window.currentSchoolId || null;
        const basePath = schoolId ? `schools/${schoolId}/lessonPlans/${year}` : `lessonPlans/${year}`;
        
        // Also check legacy path for backward compatibility
        const legacySnap = await db.ref(`lesson_plans/${workerId}`).once('value').catch(()=>({val:()=>null}));
        const legacyData = legacySnap.val() || {};
        
        // Flatten legacy plans
        let legacyPlans = {};
        Object.keys(legacyData).forEach(id => {
          const plan = legacyData[id];
          if (plan && typeof plan === 'object') {
            legacyPlans[id] = { ...plan, id, year: plan.year || year };
          }
        });
        
        // Load year-based plans (nested structure: year/className/date/id)
        const snap = await db.ref(basePath).once('value').catch(()=>({val:()=>null}));
        const yearData = (snap && snap.val && snap.val()) || {};
        
        // Flatten nested structure
        let yearPlans = {};
        Object.keys(yearData).forEach(className => {
          const dates = yearData[className] || {};
          Object.keys(dates).forEach(date => {
            const ids = dates[date] || {};
            Object.keys(ids).forEach(id => {
              const plan = ids[id];
              if (plan && typeof plan === 'object') {
                yearPlans[id] = { ...plan, id, year };
              }
            });
          });
        });
        
        // Merge: prefer year-based over legacy
        lessonPlans = { ...legacyPlans, ...yearPlans };
        
        // Count plans for selected year only
        let count = 0;
        Object.values(lessonPlans).forEach(plan => {
          if (!plan.year || plan.year === year) count++;
        });
        
        totalPlans.textContent = count;
        renderPlans();
      } catch (error) {
        console.error('Error loading plans:', error);
        toast('Error loading lesson plans', 'error');
      }
    }

    // Render plans (year-aware)
    function renderPlans() {
      const year = window.somapYearContext.getSelectedYear();
      const selectedClass = filterClass.value;
      const selectedSubject = filterSubject.value;
      const selectedTerm = filterTerm.value;

      // Flatten nested structure if needed
      let allPlans = [];
      Object.keys(lessonPlans).forEach(id => {
        const plan = lessonPlans[id];
        if (plan && typeof plan === 'object') {
          allPlans.push([id, plan]);
        }
      });

      let filtered = allPlans.filter(([id, plan]) => {
        // Filter by year
        const planYear = plan.year || String(year);
        if (planYear !== String(year)) return false;
        
        // Filter by class (support both class and className)
        const planClass = plan.className || plan.class || '';
        if (selectedClass && planClass !== selectedClass) return false;
        
        // Filter by subject
        if (selectedSubject && plan.subject !== selectedSubject) return false;
        
        // Filter by term
        if (selectedTerm && plan.term !== selectedTerm) return false;
        
        return true;
      });

      // Sort by date (newest first)
      filtered.sort((a, b) => {
        const dateA = a[1].date || '';
        const dateB = b[1].date || '';
        if (dateB !== dateA) return dateB.localeCompare(dateA);
        return (b[1].createdAt || 0) - (a[1].createdAt || 0);
      });

      if (filtered.length === 0) {
        plansList.innerHTML = `
          <div class="empty-state">
            <h3>üìö No Lesson Plans Found</h3>
            <p>Create your first lesson plan or adjust your filters</p>
          </div>
        `;
        return;
      }

      plansList.innerHTML = filtered.map(([id, plan]) => {
        const planClass = plan.className || plan.class || 'N/A';
        const totalStudents = plan.totals?.totalStudents || plan.totalStudents || 0;
        const present = plan.totals?.present || plan.studentsPresent || 0;
        const duration = plan.durationMinutes || plan.duration || 0;
        
        return `
        <div class="plan-card">
          <div class="plan-header">
            <div>
              <div class="plan-title">${plan.topic || 'Untitled'}</div>
              <div class="plan-meta">
                <span class="meta-tag">üìö ${planClass}</span>
                <span class="meta-tag">üìñ ${plan.subject || 'N/A'}</span>
                <span class="meta-tag">üìÖ ${plan.term || 'N/A'} - Week ${plan.week || 'N/A'}</span>
                <span class="meta-tag">üìÜ ${plan.date || 'N/A'}</span>
              </div>
            </div>
          </div>
          <div class="plan-details">
            <p><strong>Objectives:</strong> ${(plan.objectives || '').substring(0, 150)}${(plan.objectives || '').length > 150 ? '...' : ''}</p>
            <p><strong>Students:</strong> ${present}/${totalStudents} present | <strong>Duration:</strong> ${duration} mins</p>
          </div>
          <div class="plan-actions">
            <button class="btn btn-primary" onclick="viewPlan('${id}')">üëÅÔ∏è View Full Plan</button>
            <button class="btn btn-secondary" onclick="editPlan('${id}')">‚úèÔ∏è Edit</button>
            <button class="btn btn-secondary" onclick="deletePlan('${id}')">üóëÔ∏è Delete</button>
          </div>
        </div>
      `;
      }).join('');
    }

    // View plan (full details in alert for now - you can make a modal)
    window.viewPlan = function(planId) {
      const plan = lessonPlans[planId];
      if (!plan) return;

      const planClass = plan.className || plan.class || 'N/A';
      const totalStudents = plan.totals?.totalStudents || plan.totalStudents || 0;
      const present = plan.totals?.present || plan.studentsPresent || 0;
      const duration = plan.durationMinutes || plan.duration || 0;

      const details = `
üìù LESSON PLAN

Class: ${planClass}
Subject: ${plan.subject || 'N/A'}
Term: ${plan.term || 'N/A'} - Week ${plan.week || 'N/A'}
Date: ${plan.date || 'N/A'}
Duration: ${duration} minutes
Students: ${present}/${totalStudents} present
Present Boys/Girls: ${plan.totals?.presentBoys || 0}/${plan.totals?.presentGirls || 0}
Absent Boys/Girls: ${plan.totals?.absentBoys || 0}/${plan.totals?.absentGirls || 0}

üìå TOPIC: ${plan.topic || 'N/A'}

üéØ LEARNING OBJECTIVES:
${plan.objectives || 'N/A'}

üåü INTRODUCTION:
${plan.intro || 'N/A'}

üìö MAIN ACTIVITIES:
${plan.activities || 'N/A'}

üõ†Ô∏è RESOURCES:
${plan.resources || 'N/A'}

‚úÖ ASSESSMENT:
${plan.assessment || 'N/A'}

üìù CONCLUSION:
${plan.conclusion || 'N/A'}

üìã HOMEWORK:
${plan.homework || 'N/A'}

üí≠ REFLECTION:
${plan.reflection || 'N/A'}
      `;

      alert(details);
    };

    // Edit plan
    window.editPlan = function(planId) {
      const plan = lessonPlans[planId];
      if (!plan) return;

      editingPlanId = planId;

      // Populate form
      const planClass = plan.className || plan.class || '';
      document.getElementById('planClass').value = planClass;
      document.getElementById('planSubject').value = plan.subject || '';
      document.getElementById('planTerm').value = plan.term || '';
      document.getElementById('planWeek').value = plan.week || '';
      document.getElementById('planDate').value = plan.date || '';
      document.getElementById('totalStudents').value = plan.totals?.totalStudents || plan.totalStudents || '';
      document.getElementById('studentsPresent').value = plan.totals?.present || plan.studentsPresent || '';
      document.getElementById('lpPresentBoys').value = plan.totals?.presentBoys || 0;
      document.getElementById('lpPresentGirls').value = plan.totals?.presentGirls || 0;
      document.getElementById('lpAbsentBoys').value = plan.totals?.absentBoys || 0;
      document.getElementById('lpAbsentGirls').value = plan.totals?.absentGirls || 0;
      document.getElementById('planDuration').value = plan.durationMinutes || plan.duration || '';
      document.getElementById('planTopic').value = plan.topic || '';
      document.getElementById('planObjectives').value = plan.objectives || '';
      document.getElementById('planIntro').value = plan.intro || '';
      document.getElementById('planActivities').value = plan.activities || '';
      document.getElementById('planResources').value = plan.resources || '';
      document.getElementById('planAssessment').value = plan.assessment || '';
      document.getElementById('planConclusion').value = plan.conclusion || '';
      document.getElementById('planHomework').value = plan.homework || '';
      document.getElementById('planReflection').value = plan.reflection || '';

      // Trigger recomputation to update stats
      setTimeout(() => recomputeForSelection(), 100);

      lessonForm.classList.remove('hidden');
      lessonForm.scrollIntoView({ behavior: 'smooth' });
    };

    // Delete plan (year-aware)
    window.deletePlan = async function(planId) {
      if (!confirm('Are you sure you want to delete this lesson plan?')) return;

      try {
        const plan = lessonPlans[planId];
        if (!plan) {
          toast('Plan not found', 'error');
          return;
        }

        const year = plan.year || window.somapYearContext.getSelectedYear();
        const schoolId = window.currentSchoolId || null;
        const basePath = schoolId ? `schools/${schoolId}/lessonPlans` : 'lessonPlans';
        const cls = plan.className || plan.class || '';
        const date = plan.date || '';

        if (cls && date) {
          await db.ref(`${basePath}/${year}/${cls}/${date}/${planId}`).remove();
        } else {
          // Fallback to legacy path
          await db.ref(`lesson_plans/${workerId}/${planId}`).remove();
        }

        delete lessonPlans[planId];
        toast('Lesson plan deleted successfully', 'success');
        loadLessonPlans();
      } catch (error) {
        console.error('Error deleting plan:', error);
        toast('Error deleting lesson plan', 'error');
      }
    };

    // New plan button
    newPlanBtn.addEventListener('click', () => {
      editingPlanId = null;
      document.querySelectorAll('#lessonForm input, #lessonForm textarea, #lessonForm select').forEach(el => {
        if (el.id === 'totalStudents' || el.id === 'studentsPresent') {
          // Keep readonly fields, will be auto-filled
          el.value = '';
        } else if (el.type === 'number') el.value = '';
        else if (el.type === 'date') el.value = '';
        else if (el.tagName === 'TEXTAREA') el.value = '';
        else if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else el.value = '';
      });
      
      // Reset hidden fields
      document.getElementById('lpPresentBoys').value = '0';
      document.getElementById('lpPresentGirls').value = '0';
      document.getElementById('lpAbsentBoys').value = '0';
      document.getElementById('lpAbsentGirls').value = '0';
      
      // Reset stats
      if (document.getElementById('statTotal')) document.getElementById('statTotal').textContent = '--';
      if (document.getElementById('statPB')) document.getElementById('statPB').textContent = '0';
      if (document.getElementById('statPG')) document.getElementById('statPG').textContent = '0';
      if (document.getElementById('statAB')) document.getElementById('statAB').textContent = '0';
      if (document.getElementById('statAG')) document.getElementById('statAG').textContent = '0';
      if (document.getElementById('statNote')) document.getElementById('statNote').textContent = '‚Äî';
      
      lessonForm.classList.remove('hidden');
      lessonForm.scrollIntoView({ behavior: 'smooth' });
    });

    // Cancel button
    cancelPlanBtn.addEventListener('click', () => {
      lessonForm.classList.add('hidden');
      editingPlanId = null;
    });

    // Save plan (year-aware)
    savePlanBtn.addEventListener('click', async () => {
      // Validate
      const required = ['planClass', 'planSubject', 'planTerm', 'planWeek', 'planDate', 
                       'totalStudents', 'studentsPresent', 'planDuration', 'planTopic', 
                       'planObjectives', 'planIntro', 'planActivities', 'planAssessment', 'planConclusion'];
      
      for (const id of required) {
        const el = document.getElementById(id);
        if (!el || !el.value || !String(el.value).trim()) {
          toast(`Please fill in: ${el ? el.previousElementSibling.textContent : id}`, 'warning');
          if (el) el.focus();
          return;
        }
      }

      const year = window.somapYearContext.getSelectedYear();
      const dateVal = document.getElementById('planDate').value;
      const dY = new Date(dateVal).getFullYear().toString();
      const saveYear = dY; // Use date's year for storage
      
      if (saveYear !== String(year)) {
        console.warn(`Selected year ${year} differs from date year ${saveYear}. Saving under ${saveYear}.`);
      }

      const planData = {
        className: document.getElementById('planClass').value,
        subject: document.getElementById('planSubject').value,
        term: document.getElementById('planTerm').value,
        week: document.getElementById('planWeek').value,
        date: dateVal,
        totals: {
          totalStudents: parseInt(document.getElementById('totalStudents').value),
          present: parseInt(document.getElementById('studentsPresent').value),
          presentBoys: parseInt(document.getElementById('lpPresentBoys').value || 0),
          presentGirls: parseInt(document.getElementById('lpPresentGirls').value || 0),
          absentBoys: parseInt(document.getElementById('lpAbsentBoys').value || 0),
          absentGirls: parseInt(document.getElementById('lpAbsentGirls').value || 0)
        },
        durationMinutes: parseInt(document.getElementById('planDuration').value),
        topic: document.getElementById('planTopic').value,
        objectives: document.getElementById('planObjectives').value,
        intro: document.getElementById('planIntro').value,
        activities: document.getElementById('planActivities').value,
        resources: document.getElementById('planResources').value || '',
        assessment: document.getElementById('planAssessment').value,
        conclusion: document.getElementById('planConclusion').value,
        homework: document.getElementById('planHomework').value || '',
        reflection: document.getElementById('planReflection').value || '',
        year: saveYear,
        recordedBy: teacherName.textContent || workerId,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      };

      try {
        const schoolId = window.currentSchoolId || null;
        const basePath = schoolId ? `schools/${schoolId}/lessonPlans` : 'lessonPlans';
        const cls = planData.className;
        const date = planData.date;
        
        if (editingPlanId) {
          planData.updatedAt = firebase.database.ServerValue.TIMESTAMP;
          await db.ref(`${basePath}/${saveYear}/${cls}/${date}/${editingPlanId}`).update(planData);
          toast('Lesson plan updated successfully!', 'success');
        } else {
          const recRef = db.ref(`${basePath}/${saveYear}/${cls}/${date}`).push();
          await recRef.set({ ...planData, id: recRef.key });
          toast('Lesson plan saved successfully!', 'success');
        }

        editingPlanId = null;
        lessonForm.classList.add('hidden');
        loadLessonPlans();
      } catch (error) {
        console.error('Error saving plan:', error);
        toast('Error saving lesson plan', 'error');
      }
    });

    // ========== EXPORT FUNCTIONALITY ==========
    function datesInYears(fromStr,toStr){
      const fy = new Date(fromStr).getFullYear(), ty = new Date(toStr).getFullYear();
      const ys = []; for(let y=fy; y<=ty; y++) ys.push(y.toString()); return ys;
    }

    async function fetchPlansRange(fromStr,toStr){
      const years = datesInYears(fromStr,toStr);
      const rows = [];
      const schoolId = window.currentSchoolId || null;
      const basePath = schoolId ? `schools/${schoolId}/lessonPlans` : 'lessonPlans';

      for(const y of years){
        try {
          const snap = await db.ref(`${basePath}/${y}`).once('value');
          const tree = (snap && snap.val && snap.val()) || {};
          for(const cls of Object.keys(tree)){
            const dates = tree[cls]||{};
            for(const d of Object.keys(dates)){
              if(d < fromStr || d > toStr) continue;
              const recs = dates[d]||{};
              for(const k of Object.keys(recs)){
                const r = recs[k];
                rows.push([
                  d, cls, r.subject||'', r.term||'', r.week||'',
                  r.topic||'', (r.objectives||'').slice(0,140),
                  r.totals?.totalStudents||0, r.totals?.present||0,
                  r.totals?.presentBoys||0, r.totals?.presentGirls||0,
                  r.totals?.absentBoys||0, r.totals?.absentGirls||0,
                  r.durationMinutes||'', r.recordedBy||''
                ]);
              }
            }
          }
        } catch(e) { continue; }
      }

      return rows.sort((a,b)=> a[0].localeCompare(b[0]) || a[1].localeCompare(b[1]));
    }

    document.getElementById('lpExportPdf')?.addEventListener('click', async ()=>{
      const from = document.getElementById('lpFromDate')?.value, to = document.getElementById('lpToDate')?.value;
      if(!from || !to) return toast('Pick From and To dates.', 'warning');
      
      try {
        toast('Generating PDF...', 'success');
        const data = await fetchPlansRange(from,to);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:'landscape'});
        
        doc.setFontSize(14);
        doc.text(`Lesson Plans ${from} ‚Üí ${to}`, 14, 14);
        
        doc.autoTable({
          head: [['Date','Class','Subject','Term','Week','Topic','Objectives(140)','Total','Present','P‚ôÇ','P‚ôÄ','A‚ôÇ','A‚ôÄ','Minutes','By']],
          body: data,
          startY: 20,
          styles:{fontSize:8}
        });
        
        doc.save(`lessonplans_${from}_${to}.pdf`);
        toast('PDF exported successfully!', 'success');
      } catch(error) {
        console.error('Export error:', error);
        toast('Error exporting PDF', 'error');
      }
    });

    document.getElementById('lpExportCsv')?.addEventListener('click', async ()=>{
      const from = document.getElementById('lpFromDate')?.value, to = document.getElementById('lpToDate')?.value;
      if(!from || !to) return toast('Pick From and To dates.', 'warning');
      
      try {
        toast('Generating CSV...', 'success');
        const data = await fetchPlansRange(from,to);
        const ws = XLSX.utils.aoa_to_sheet([['Date','Class','Subject','Term','Week','Topic','Objectives','Total','Present','P‚ôÇ','P‚ôÄ','A‚ôÇ','A‚ôÄ','Minutes','By'], ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'LessonPlans');
        XLSX.writeFile(wb, `lessonplans_${from}_${to}.xlsx`);
        toast('CSV exported successfully!', 'success');
      } catch(error) {
        console.error('Export error:', error);
        toast('Error exporting CSV', 'error');
      }
    });

    // Filter listeners
    filterClass.addEventListener('change', renderPlans);
    filterSubject.addEventListener('change', renderPlans);
    filterTerm.addEventListener('change', renderPlans);

    // Initialize
    loadTeacherConfig();
  </script>
</body>
</html>

