<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logbooks | SoMAp Teacher Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: rgba(255, 255, 255, 0.95);
      padding: 20px;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 30% 40%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(162, 155, 254, 0.3) 0%, transparent 50%);
      animation: bgPulse 20s ease infinite;
      z-index: -1;
    }

    @keyframes bgPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 24px 32px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #fff 0%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .year-selector-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .year-selector-wrap label {
      font-size: 0.9rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
    }

    .year-selector-wrap select {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .year-selector-wrap select option {
      background: #5a67d8;
      color: white;
    }

    .stats-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin: 16px 0;
      padding: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-card {
      padding: 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }

    .stat-card-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: white;
    }

    .form-group input[readonly] {
      background: rgba(255, 255, 255, 0.08);
      cursor: not-allowed;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-back {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #f093fb, #667eea);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.15);
      color: white;
    }

    .teacher-info {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .info-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .info-value {
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .quick-log-section {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(6, 182, 212, 0.2));
      border: 2px solid rgba(16, 185, 129, 0.5);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .quick-log-section h3 {
      font-size: 1.4rem;
      margin-bottom: 16px;
      color: white;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .form-group select,
    .form-group input,
    .form-group textarea {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #f093fb;
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 4px rgba(240, 147, 251, 0.2);
    }

    .form-group select option {
      background: #5a67d8;
      color: white;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    .controls {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .logs-list {
      display: grid;
      gap: 16px;
    }

    .log-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
    }

    .log-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      border-color: #f093fb;
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
      gap: 16px;
    }

    .log-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      margin-bottom: 8px;
    }

    .log-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .meta-tag {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .log-details {
      color: rgba(255, 255, 255, 0.85);
      line-height: 1.6;
      margin-top: 12px;
    }

    .log-details p {
      margin-bottom: 8px;
    }

    .log-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 12px;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .toast {
      background: rgba(16, 185, 129, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
    }

    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast.success { background: rgba(16, 185, 129, 0.95); }
    .toast.error { background: rgba(239, 68, 68, 0.95); }
    .toast.warning { background: rgba(245, 158, 11, 0.95); }

    .hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }

      .controls-grid,
      .form-row {
        grid-template-columns: 1fr;
      }

      .log-header {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <div class="container">
    <div class="header">
      <div>
        <h1>üìö Teaching Logbooks</h1>
        <p class="header-subtitle">Daily teaching logs and progress tracking</p>
      </div>
      <a href="../workertasks.html" class="btn btn-back">
        ‚Üê Back to Dashboard
      </a>
    </div>

    <!-- Year Selector -->
    <div class="year-selector-wrap">
      <label>Academic Year:</label>
      <select data-somap-year-select id="yearSelector"></select>
      <span style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">Working year: <b id="yearHint">2025</b></span>
    </div>

    <div class="teacher-info">
      <div class="info-item">
        <span class="info-label">Teacher Name</span>
        <span class="info-value" id="teacherName">Loading...</span>
      </div>
      <div class="info-item">
        <span class="info-label">Teacher Type</span>
        <span class="info-value" id="teacherType">Loading...</span>
      </div>
      <div class="info-item">
        <span class="info-label">Total Logs</span>
        <span class="info-value" id="totalLogs">0</span>
      </div>
      <div class="info-item">
        <span class="info-label">Today's Date</span>
        <span class="info-value" id="currentDate">Loading...</span>
      </div>
    </div>

    <!-- Quick Log Entry -->
    <div class="quick-log-section">
      <h3>‚úçÔ∏è Quick Log Entry</h3>
      
      <div class="form-row">
        <div class="form-group">
          <label>Class *</label>
          <select id="lbClass" required>
            <option value="">Select Class</option>
          </select>
        </div>
        <div class="form-group">
          <label>Subject *</label>
          <select id="lbSubject" required>
            <option value="">Select Subject</option>
          </select>
        </div>
        <div class="form-group">
          <label>Date *</label>
          <input type="date" id="lbDate" required>
        </div>
        <div class="form-group">
          <label>Period / Time *</label>
          <input type="time" id="lbTime" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Total Students in Class *</label>
          <input type="number" id="lbTotal" min="0" placeholder="Auto-filled from roster" readonly required>
        </div>
        <div class="form-group">
          <label>Students Present *</label>
          <input type="number" id="lbPresent" min="0" placeholder="Auto-filled from attendance" readonly required>
        </div>
        <div class="form-group">
          <label>Duration (minutes) *</label>
          <input type="number" id="lbDuration" min="30" max="180" placeholder="e.g., 45" required>
        </div>
      </div>

      <!-- Attendance Stats Strip -->
      <div class="stats-strip" id="lbStats">
        <div class="stat-card">
          <div class="stat-card-label">Total Students</div>
          <div class="stat-card-value" id="stTotal">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">Present</div>
          <div class="stat-card-value" id="stPresent">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">Absent</div>
          <div class="stat-card-value" id="stAbsent">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">‚ôÇ Present / Absent</div>
          <div class="stat-card-value"><b id="stPB">0</b> / <b id="stAB">0</b></div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">‚ôÄ Present / Absent</div>
          <div class="stat-card-value"><b id="stPG">0</b> / <b id="stAG">0</b></div>
        </div>
      </div>

      <!-- Hidden gender fields -->
      <input type="hidden" id="lbPresentBoys" value="0">
      <input type="hidden" id="lbPresentGirls" value="0">
      <input type="hidden" id="lbAbsentBoys" value="0">
      <input type="hidden" id="lbAbsentGirls" value="0">

      <div class="form-group">
        <label>Topic Taught *</label>
        <input type="text" id="lbTopic" placeholder="Auto-filled from lesson plan" required>
      </div>

      <div class="form-group">
        <label>Lesson Summary *</label>
        <textarea id="lbSummary" placeholder="Auto-filled from lesson plan (Activities + Resources)" required></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Homework Given</label>
          <input type="text" id="lbHomework" placeholder="Auto-filled from lesson plan">
        </div>
        <div class="form-group">
          <label>Progress / Completion (%) *</label>
          <input type="number" id="lbProgress" min="0" max="100" placeholder="e.g., 80" required>
          <small style="color: rgba(255,255,255,0.6); font-size: 0.8rem;">Required: Please fill this before saving</small>
        </div>
      </div>

      <div class="form-group">
        <label>Challenges / Issues Faced *</label>
        <textarea id="lbChallenges" placeholder="Any difficulties, disruptions, or challenges during the lesson?" required></textarea>
        <small style="color: rgba(255,255,255,0.6); font-size: 0.8rem;">Required: Please fill this before saving</small>
      </div>

      <div class="form-group">
        <label>Remarks / Observations</label>
        <textarea id="lbRemarks" placeholder="Auto-filled from lesson plan (Reflection/Notes)"></textarea>
      </div>

      <button class="btn btn-success" id="lbSave">
        üíæ Save Today's Log
      </button>
    </div>

    <!-- Filters & Export -->
    <div class="controls">
      <h4 style="margin-bottom: 16px; color: white;">Filter & Export Past Logs</h4>
      <div class="controls-grid">
        <div class="form-group">
          <label>Filter by Class</label>
          <select id="lbFilterClass">
            <option value="">All Classes</option>
          </select>
        </div>
        <div class="form-group">
          <label>Filter by Subject</label>
          <input type="text" id="lbFilterSubject" placeholder="Subject (optional)" style="width: 100%;">
        </div>
        <div class="form-group">
          <label>From Date</label>
          <input type="date" id="lbFromDate" style="width: 100%;">
        </div>
        <div class="form-group">
          <label>To Date</label>
          <input type="date" id="lbToDate" style="width: 100%;">
        </div>
      </div>
      <div style="display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap;">
        <button class="btn btn-secondary" id="lbExportPdf" style="background: linear-gradient(135deg, #ef4444, #dc2626);">üìÑ Export PDF</button>
        <button class="btn btn-secondary" id="lbExportCsv" style="background: linear-gradient(135deg, #10b981, #059669);">üìä Export CSV</button>
      </div>
    </div>

    <!-- Logs List -->
    <div id="logsList">
      <div class="empty-state">
        <h3>üìì No Logs Yet</h3>
        <p>Fill in the quick log form above to record today's lesson!</p>
      </div>
    </div>
  </div>

  <script>
    // ========== YEAR CONTEXT & CLASS SHIFTING ==========
    const SOMAP_ALLOWED_YEARS = Array.from({length: 20}, (_,i)=>2023+i); // 2023..2042
    const SOMAP_DEFAULT_YEAR = 2025;
    const CLASS_ORDER = ['Baby Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
    
    const L = s => String(s||'').trim().toLowerCase();

    function shiftClass(baseClass, deltaYears){
      const i = CLASS_ORDER.findIndex(c => L(c)===L(baseClass));
      if (i<0) return baseClass||'';
      const j = i + Number(deltaYears||0);
      if (j < 0) return 'PRE-ADMISSION';
      if (j >= CLASS_ORDER.length) return 'GRADUATED';
      return CLASS_ORDER[j];
    }

    window.somapYearContext = window.somapYearContext || (function(){
      let selected = (sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR)+'';
      const listeners = new Set();
      return {
        getSelectedYear(){ return selected; },
        setSelectedYear(y){
          y = String(y);
          if (selected===y) return;
          selected = y;
          try{ sessionStorage.setItem('somap_selected_year', y); }catch{}
          listeners.forEach(fn=>{ try{ fn(y); }catch{} });
        },
        onYearChanged(fn){ if (typeof fn==='function') listeners.add(fn); }
      };
    })();
  </script>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    window.db = db;

    // State
    let workerId = null;
    let teacherConfig = null;
    let logs = {};
    const schoolId = window.currentSchoolId || null;
    const base = (p) => schoolId ? `schools/${schoolId}/${p}` : p;

    // UI Elements
    const teacherName = document.getElementById('teacherName');
    const teacherType = document.getElementById('teacherType');
    const currentDate = document.getElementById('currentDate');
    const totalLogs = document.getElementById('totalLogs');
    const logsList = document.getElementById('logsList');
    const yearSelector = document.getElementById('yearSelector');
    const yearHint = document.getElementById('yearHint');

    function toast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toastEl = document.createElement('div');
      toastEl.className = `toast ${type}`;
      toastEl.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toastEl);
      setTimeout(() => toastEl.classList.add('show'), 100);
      setTimeout(() => {
        toastEl.classList.remove('show');
        setTimeout(() => toastEl.remove(), 300);
      }, 3000);
    }

    // Helper functions
    function yyyymmdd(dateStr) {
      const d = new Date(dateStr);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}${m}${da}`;
    }

    function currentUserEmail() {
      try {
        if (window.currentUserEmail) return window.currentUserEmail;
        const s = sessionStorage.getItem('somapUserEmail') || sessionStorage.getItem('userEmail');
        if (s) return s;
        const u = firebase?.auth?.().currentUser;
        if (u?.email) return u.email;
      } catch {}
      return 'unknown';
    }

    // Initialize year selector (after DOM ready)
    function initYearSelector() {
      if (!yearSelector) return;
      yearSelector.innerHTML = SOMAP_ALLOWED_YEARS.map(y => `<option value="${y}">${y}</option>`).join('');
      const current = window.somapYearContext.getSelectedYear();
      yearSelector.value = current;
      if (yearHint) yearHint.textContent = current;
      yearSelector.addEventListener('change', e => {
        const ny = String(e.target.value);
        window.somapYearContext.setSelectedYear(ny);
        if (yearHint) yearHint.textContent = ny;
        loadLogs();
        recomputeLogForm();
      });
    }

    // Set today's date
    const today = new Date();
    currentDate.textContent = today.toLocaleDateString('en-US', {
      timeZone: 'Africa/Nairobi',
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    // Set default date and time
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const lbDateEl = document.getElementById('lbDate');
    if (lbDateEl) lbDateEl.value = todayStr;
    const lbTimeEl = document.getElementById('lbTime');
    if (lbTimeEl) {
      lbTimeEl.value = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
    }

    workerId = localStorage.getItem('workerId');
    if (!workerId) {
      toast('Please login first', 'error');
      setTimeout(() => window.location.href = '../../index.html', 2000);
    }

    async function loadTeacherConfig() {
      try {
        const configSnap = await db.ref(`teachers_config/${workerId}`).once('value');
        const workerSnap = await db.ref(`workers/${workerId}/profile`).once('value');
        
        if (!configSnap.exists()) {
          toast('Please complete your teacher profile setup first', 'warning');
          setTimeout(() => window.location.href = '../workertasks.html', 2000);
          return;
        }

        teacherConfig = configSnap.val();
        const profile = workerSnap.val();

        const fullName = profile.fullNameUpper || 
          [profile.firstName, profile.middleName, profile.lastName].filter(Boolean).join(' ').toUpperCase();
        teacherName.textContent = fullName;
        teacherType.textContent = teacherConfig.teacherType;

        populateSelects();
        loadLogs();
      } catch (error) {
        console.error('Error loading config:', error);
        toast('Error loading teacher configuration', 'error');
      }
    }

    function populateSelects() {
      const lbClass = document.getElementById('lbClass');
      const lbSubject = document.getElementById('lbSubject');
      const lbFilterClass = document.getElementById('lbFilterClass');
      const lbFilterSubject = document.getElementById('lbFilterSubject');

      teacherConfig.classes.forEach(className => {
        if (lbFilterClass) lbFilterClass.add(new Option(className, className));
        if (lbClass) lbClass.add(new Option(className, className));
      });

      teacherConfig.subjects.forEach(subject => {
        if (lbSubject) lbSubject.add(new Option(subject, subject));
      });
    }

    // Data loading helpers
    async function getBaseMaps(year) {
      const anchorY = String(SOMAP_DEFAULT_YEAR), y = String(year);
      const [studentsSnap, anchorSnap, ySnap, listSnap] = await Promise.all([
        db.ref(base('students')).once('value'),
        db.ref(base(`enrollments/${anchorY}`)).once('value').catch(()=>({val:()=>null})),
        db.ref(base(`enrollments/${y}`)).once('value').catch(()=>({val:()=>null})),
        db.ref(base(`studentlist/${y}`)).once('value').catch(()=>({val:()=>null}))
      ]);
      return {
        y,
        students: (studentsSnap && studentsSnap.val && studentsSnap.val())||{},
        enrollAnchor: (anchorSnap && anchorSnap.val && anchorSnap.val())||{},
        enrollYear: (ySnap && ySnap.val && ySnap.val())||{},
        studentlistYear: (listSnap && listSnap.val && listSnap.val())||{}
      };
    }

    function resolveClassForYear(studentId, studentRecord, enrollAnchor, enrollYear, targetYear) {
      // First, try to get class directly from student record (most reliable for current year)
      const directClass = studentRecord?.classLevel || studentRecord?.className || studentRecord?.class || '';
      if (directClass && String(targetYear) === String(SOMAP_DEFAULT_YEAR)) {
        return directClass;
      }
      
      // For other years, use enrollment data with shifting
      const anchor = enrollAnchor[studentId] || {};
      const baseClass = anchor.className || anchor.classLevel || directClass || studentRecord?.classLevel || studentRecord?.className || 'Baby Class';
      const yrRec = enrollYear[studentId] || {};
      if (yrRec.className || yrRec.classLevel) return (yrRec.className || yrRec.classLevel);
      
      // Shift from anchor year
      const delta = Number(targetYear) - SOMAP_DEFAULT_YEAR;
      return shiftClass(baseClass, delta);
    }

    function countClassForYear(targetClass, maps, targetYear) {
      // Try explicit studentlist/{year}/{className} first
      const yList = maps.studentlistYear?.[targetClass];
      if (yList && typeof yList === 'object' && Object.keys(yList).length > 0) {
        return Object.keys(yList).length;
      }
      
      // Count from students collection directly
      let n = 0;
      const students = maps.students || {};
      
      for (const id of Object.keys(students)) {
        const studentRecord = students[id];
        if (!studentRecord || typeof studentRecord !== 'object') continue;
        
        // Get class for this year
        const cls = resolveClassForYear(id, studentRecord, maps.enrollAnchor, maps.enrollYear, targetYear);
        
        // Normalize both class names for comparison (case-insensitive, trim spaces)
        const normalizedTarget = L(targetClass);
        const normalizedClass = L(cls);
        
        if (normalizedClass === normalizedTarget) {
          n++;
        }
      }
      
      console.log(`Counted ${n} students for ${targetClass} in year ${targetYear}`);
      return n;
    }

    async function loadAttendanceCounts(year, className, dateStr, studentsMap) {
      const y = String(year), cls = className.trim(), key = yyyymmdd(dateStr);
      const tryPaths = [
        base(`classAttendance/${y}/${cls}/${key}`),
        base(`attendance/class/${y}/${cls}/${key}`),
        base(`attendance/${y}/${cls}/${key}`),
        base(`classAttendance/${cls}/${key}`),
        base(`attendance/${cls}/${key}`),
        // Also try alternative class name formats
        base(`classAttendance/${y}/${cls.replace(/\s+/g, '_')}/${key}`),
        base(`attendance/${y}/${cls.replace(/\s+/g, '_')}/${key}`),
        base(`classAttendance/${cls.replace(/\s+/g, '_')}/${key}`),
        base(`attendance/${cls.replace(/\s+/g, '_')}/${key}`)
      ];
      
      let node = null;
      let usedPath = null;
      
      for (const p of tryPaths) {
        try {
          const snap = await db.ref(p).once('value');
          const val = snap && snap.val ? snap.val() : null;
          if (val && typeof val === 'object' && Object.keys(val).length > 0) {
            node = val;
            usedPath = p;
            console.log(`Found attendance at path: ${p}`);
            break;
          }
        } catch (e) {
          console.log(`Tried path ${p}, not found`);
          continue;
        }
      }
      
      if (!node) {
        console.log(`No attendance data found for ${cls} on ${dateStr}`);
        return { present: 0, absent: 0, pb: 0, pg: 0, ab: 0, ag: 0 };
      }
      
      let pb = 0, pg = 0, ab = 0, ag = 0;
      
      for (const sid of Object.keys(node)) {
        const rec = node[sid] || {};
        // Check multiple status formats
        const status = String(rec.status || rec.s || (rec.am || rec.pm || '') || '').toUpperCase().trim();
        const amStatus = String(rec.am || '').toUpperCase().trim();
        const pmStatus = String(rec.pm || '').toUpperCase().trim();
        
        // Consider present if status is P, PRESENT, 1, true, or if either AM/PM is P
        const isPresent = status === 'P' || status === 'PRESENT' || status === '1' || status === 1 || status === true ||
                         amStatus === 'P' || pmStatus === 'P';
        
        // Get gender from attendance record or student record
        const genderFromAtt = String(rec.gender || rec.sex || '').toUpperCase().trim();
        const studentRecord = studentsMap[sid];
        const genderFromStudent = String(studentRecord?.gender || studentRecord?.sex || '').toUpperCase().trim();
        const gen = genderFromAtt || genderFromStudent;
        const isBoy = gen === 'M' || gen === 'B' || gen === 'BOY' || gen === 'MALE';
        
        if (isPresent) {
          if (isBoy) pb++;
          else pg++;
        } else {
          if (isBoy) ab++;
          else ag++;
        }
      }
      
      console.log(`Attendance counts - Present: ${pb + pg} (‚ôÇ${pb} ‚ôÄ${pg}), Absent: ${ab + ag} (‚ôÇ${ab} ‚ôÄ${ag})`);
      
      return { present: pb + pg, absent: ab + ag, pb, pg, ab, ag };
    }

    async function loadLessonPlanInjects(year, className, dateStr, subject) {
      const y = String(year), cls = className.trim(), d = dateStr;
      const tryPaths = [
        base(`lessonPlans/${y}/${cls}/${d}`),
        base(`lessonPlans/${cls}/${d}`),
        base(`lessonPlans/${y}/${cls.replace(/\s+/g, '_')}/${d}`),
        base(`lessonPlans/${cls.replace(/\s+/g, '_')}/${d}`)
      ];
      let tree = null;
      let usedPath = null;
      for (const p of tryPaths) {
        try {
          const snap = await db.ref(p).once('value');
          const v = snap && snap.val ? snap.val() : null;
          if (v && typeof v === 'object' && Object.keys(v).length > 0) {
            tree = v;
            usedPath = p;
            console.log(`Found lesson plan at path: ${p}`);
            break;
          }
        } catch (e) {
          console.log(`Tried lesson plan path ${p}, not found`);
          continue;
        }
      }
      if (!tree) {
        console.log(`No lesson plan found for ${cls}, ${subject}, ${d}`);
        return null;
      }
      const rec = Object.values(tree).find(r => L(r.subject || '') === L(subject || '')) || Object.values(tree)[0] || null;
      if (!rec) return null;
      return {
        topic: rec.topic || rec.theme || rec.mainTopic || '',
        activities: (rec.activities || rec.mainActivities || '').trim(),
        resources: (rec.resources || rec.materials || rec.teachingAids || '').trim(),
        homework: (rec.homework || rec.assignment || '').trim(),
        reflection: (rec.reflection || rec.notes || rec.remarks || '').trim()
      };
    }

    // Auto-populate form
    async function recomputeLogForm() {
      const year = window.somapYearContext.getSelectedYear();
      const cls = document.getElementById('lbClass')?.value?.trim();
      const subj = document.getElementById('lbSubject')?.value?.trim();
      const date = document.getElementById('lbDate')?.value?.trim();

      if (!cls) {
        console.log('No class selected');
        return;
      }

      try {
        console.log(`Loading data for ${cls} in year ${year}...`);
        const maps = await getBaseMaps(year);
        console.log('Loaded maps:', {
          studentsCount: Object.keys(maps.students || {}).length,
          enrollAnchorCount: Object.keys(maps.enrollAnchor || {}).length,
          studentlistYear: Object.keys(maps.studentlistYear || {}).length
        });

        if (L(cls) === 'graduated') {
          ['lbTotal','lbPresent','lbPresentBoys','lbPresentGirls','lbAbsentBoys','lbAbsentGirls'].forEach(id => {
            const el = document.getElementById(id);
            if (el) { el.value = '0'; if (el.readOnly !== undefined) el.readOnly = true; }
          });
          ['stTotal','stPresent','stAbsent','stPB','stPG','stAB','stAG'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '0';
          });
          return;
        }

        // Total students
        const total = countClassForYear(cls, maps, year);
        console.log(`Total students for ${cls} in ${year}: ${total}`);
        
        const totalEl = document.getElementById('lbTotal');
        if (totalEl) { totalEl.readOnly = true; totalEl.value = total || 0; }
        const stTotal = document.getElementById('stTotal');
        if (stTotal) stTotal.textContent = total || 0;

        // Attendance
        if (date) {
          console.log(`Loading attendance for ${cls} on ${date}...`);
          const att = await loadAttendanceCounts(year, cls, date, maps.students || {});
          console.log('Attendance data:', att);
          
          const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || 0; };
          set('lbPresent', att.present);
          set('lbPresentBoys', att.pb);
          set('lbPresentGirls', att.pg);
          set('lbAbsentBoys', att.ab);
          set('lbAbsentGirls', att.ag);

          const P = att.present, A = att.absent;
          if (document.getElementById('stPresent')) document.getElementById('stPresent').textContent = P || 0;
          if (document.getElementById('stAbsent')) document.getElementById('stAbsent').textContent = A || 0;
          if (document.getElementById('stPB')) document.getElementById('stPB').textContent = att.pb || 0;
          if (document.getElementById('stPG')) document.getElementById('stPG').textContent = att.pg || 0;
          if (document.getElementById('stAB')) document.getElementById('stAB').textContent = att.ab || 0;
          if (document.getElementById('stAG')) document.getElementById('stAG').textContent = att.ag || 0;
        } else {
          // Reset attendance fields if no date
          ['lbPresent','lbPresentBoys','lbPresentGirls','lbAbsentBoys','lbAbsentGirls'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '0';
          });
          ['stPresent','stAbsent','stPB','stPG','stAB','stAG'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '0';
          });
        }

        // Lesson plan autofill
        if (date && subj) {
          console.log(`Loading lesson plan for ${cls}, ${subj}, ${date}...`);
          const inj = await loadLessonPlanInjects(year, cls, date, subj);
          if (inj) {
            console.log('Lesson plan data found:', inj);
            const mergeSummary = [inj.activities, inj.resources].filter(Boolean).join('\n\nResources:\n');
            const topicEl = document.getElementById('lbTopic');
            if (topicEl && !topicEl.value) topicEl.value = inj.topic || '';
            const summaryEl = document.getElementById('lbSummary');
            if (summaryEl && !summaryEl.value) summaryEl.value = mergeSummary || '';
            const homeworkEl = document.getElementById('lbHomework');
            if (homeworkEl && !homeworkEl.value) homeworkEl.value = inj.homework || '';
            const remarksEl = document.getElementById('lbRemarks');
            if (remarksEl && !remarksEl.value) remarksEl.value = inj.reflection || '';
          } else {
            console.log('No lesson plan found for this class/subject/date');
          }
        }
      } catch (error) {
        console.error('Error in recomputeLogForm:', error);
        toast('Error loading data: ' + error.message, 'error');
      }
    }

    // Wire form changes
    ['lbClass','lbSubject','lbDate'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', recomputeLogForm);
    });
    window.somapYearContext.onYearChanged(() => recomputeLogForm());

    async function loadLogs() {
      try {
        const year = window.somapYearContext.getSelectedYear();
        const snap = await db.ref(base(`logbooks/${year}`)).once('value');
        logs = snap.val() || {};
        let count = 0;
        Object.values(logs).forEach(byClass => {
          if (byClass && typeof byClass === 'object') {
            Object.values(byClass).forEach(byDate => {
              if (byDate && typeof byDate === 'object') {
                count += Object.keys(byDate).length;
              }
            });
          }
        });
        totalLogs.textContent = count;
        renderLogs();
      } catch (error) {
        console.error('Error loading logs:', error);
        toast('Error loading logs', 'error');
      }
    }

    function renderLogs() {
      const year = window.somapYearContext.getSelectedYear();
      const selectedClass = document.getElementById('lbFilterClass')?.value || '';
      const selectedSubject = document.getElementById('lbFilterSubject')?.value?.trim() || '';
      
      let allLogs = [];
      Object.keys(logs).forEach(className => {
        if (selectedClass && L(className) !== L(selectedClass)) return;
        const byDate = logs[className] || {};
        Object.keys(byDate).forEach(date => {
          const byId = byDate[date] || {};
          Object.keys(byId).forEach(id => {
            const log = byId[id];
            if (selectedSubject && L(log.subject || '') !== L(selectedSubject)) return;
            allLogs.push({ year, className, date, id, ...log });
          });
        });
      });

      allLogs.sort((a, b) => {
        const dateA = new Date(a.date).getTime();
        const dateB = new Date(b.date).getTime();
        return dateB - dateA;
      });

      if (allLogs.length === 0) {
        logsList.innerHTML = `
          <div class="empty-state">
            <h3>üìì No Logs Found</h3>
            <p>Record your first log or adjust your filters</p>
          </div>
        `;
        return;
      }

      logsList.innerHTML = allLogs.map(log => {
        const dateStr = new Date(log.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        const totals = log.totals || {};
        return `
        <div class="log-card">
          <div class="log-header">
            <div>
              <div class="log-title">${log.topicTaught || 'No Topic'}</div>
              <div class="log-meta">
                <span class="meta-tag">üìö ${log.className}</span>
                <span class="meta-tag">üìñ ${log.subject || ''}</span>
                <span class="meta-tag">üìÖ ${dateStr}</span>
                <span class="meta-tag">üïê ${log.time || '--'}</span>
                <span class="meta-tag">üë• ${totals.present || 0}/${totals.totalStudents || 0}</span>
                ${log.progressCompletion ? `<span class="meta-tag">üìä ${log.progressCompletion}% Complete</span>` : ''}
              </div>
            </div>
          </div>
          <div class="log-details">
            <p><strong>üìù Summary:</strong> ${log.lessonSummary || '--'}</p>
            ${log.homeworkGiven ? `<p><strong>üìã Homework:</strong> ${log.homeworkGiven}</p>` : ''}
            ${log.challengesIssues ? `<p><strong>‚ö†Ô∏è Challenges:</strong> ${log.challengesIssues}</p>` : ''}
            ${log.remarks ? `<p><strong>üí≠ Remarks:</strong> ${log.remarks}</p>` : ''}
            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 8px;">
              Duration: ${log.durationMinutes || '--'} minutes | 
              ‚ôÇ: ${totals.presentBoys || 0}P/${totals.absentBoys || 0}A | 
              ‚ôÄ: ${totals.presentGirls || 0}P/${totals.absentGirls || 0}A
            </p>
          </div>
          <div class="log-actions">
            <button class="btn btn-secondary" onclick="deleteLog('${log.year}','${log.className}','${log.date}','${log.id}')">üóëÔ∏è Delete</button>
          </div>
        </div>
      `}).join('');
    }

    window.deleteLog = async function(year, className, date, logId) {
      if (!confirm('Are you sure you want to delete this log entry?')) return;
      try {
        await db.ref(base(`logbooks/${year}/${className}/${date}/${logId}`)).remove();
        if (logs[className] && logs[className][date] && logs[className][date][logId]) {
          delete logs[className][date][logId];
          if (Object.keys(logs[className][date]).length === 0) {
            delete logs[className][date];
          }
          if (Object.keys(logs[className]).length === 0) {
            delete logs[className];
          }
        }
        toast('Log deleted successfully', 'success');
        loadLogs();
      } catch (error) {
        console.error('Error deleting log:', error);
        toast('Error deleting log', 'error');
      }
    };

    // Save log
    document.getElementById('lbSave')?.addEventListener('click', async (e) => {
      e.preventDefault();
      const ySel = window.somapYearContext.getSelectedYear();
      const cls = document.getElementById('lbClass')?.value?.trim();
      const subj = document.getElementById('lbSubject')?.value?.trim();
      const date = document.getElementById('lbDate')?.value?.trim();
      const time = document.getElementById('lbTime')?.value?.trim();
      const total = Number(document.getElementById('lbTotal')?.value || 0);
      const present = Number(document.getElementById('lbPresent')?.value || 0);
      const pb = Number(document.getElementById('lbPresentBoys')?.value || 0);
      const pg = Number(document.getElementById('lbPresentGirls')?.value || 0);
      const ab = Number(document.getElementById('lbAbsentBoys')?.value || 0);
      const ag = Number(document.getElementById('lbAbsentGirls')?.value || 0);
      const dur = document.getElementById('lbDuration')?.value?.trim();
      const topic = document.getElementById('lbTopic')?.value?.trim();
      const summary = document.getElementById('lbSummary')?.value?.trim();
      const homework = document.getElementById('lbHomework')?.value?.trim();
      const progress = document.getElementById('lbProgress')?.value?.trim();
      const challenges = document.getElementById('lbChallenges')?.value?.trim();
      const remarks = document.getElementById('lbRemarks')?.value?.trim();

      if (!cls || !subj || !date) {
        toast('Select Class, Subject and Date.', 'warning');
        return;
      }
      if (!progress || !challenges) {
        toast('Please fill Progress / Completion (%) and Challenges / Issues before saving.', 'warning');
        return;
      }

      const dateYear = new Date(date).getFullYear().toString();
      if (dateYear !== String(ySel)) {
        console.warn(`Year mismatch: selected ${ySel}, date ${dateYear}. Saving under ${dateYear}.`);
      }

      const path = base(`logbooks/${dateYear}/${cls}/${date}`);
      const ref = db.ref(path).push();
      await ref.set({
        id: ref.key,
        className: cls,
        subject: subj,
        date,
        time,
        totals: {
          totalStudents: total,
          present,
          presentBoys: pb,
          presentGirls: pg,
          absentBoys: ab,
          absentGirls: ag
        },
        durationMinutes: dur ? Number(dur) : null,
        topicTaught: topic || '',
        lessonSummary: summary || '',
        homeworkGiven: homework || '',
        progressCompletion: progress || '',
        challengesIssues: challenges || '',
        remarks: remarks || '',
        recordedBy: currentUserEmail(),
        teacherName: teacherName.textContent,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        autoFromLessonPlan: Boolean(topic || summary || homework || remarks)
      });

      toast('Log saved successfully!', 'success');
      loadLogs();

      // Clear form (except date/time)
      document.getElementById('lbClass').value = '';
      document.getElementById('lbSubject').value = '';
      document.getElementById('lbTotal').value = '';
      document.getElementById('lbPresent').value = '';
      document.getElementById('lbPresentBoys').value = '0';
      document.getElementById('lbPresentGirls').value = '0';
      document.getElementById('lbAbsentBoys').value = '0';
      document.getElementById('lbAbsentGirls').value = '0';
      document.getElementById('lbDuration').value = '';
      document.getElementById('lbTopic').value = '';
      document.getElementById('lbSummary').value = '';
      document.getElementById('lbHomework').value = '';
      document.getElementById('lbProgress').value = '';
      document.getElementById('lbChallenges').value = '';
      document.getElementById('lbRemarks').value = '';
      ['stTotal','stPresent','stAbsent','stPB','stPG','stAB','stAG'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '0';
      });
    });

    // Export functions
    function datesToYears(fromStr, toStr) {
      const fy = new Date(fromStr).getFullYear();
      const ty = new Date(toStr).getFullYear();
      const ys = [];
      for (let y = fy; y <= ty; y++) ys.push(String(y));
      return ys;
    }

    async function fetchLogsRange(fromStr, toStr, clsFilter, subjFilter) {
      const years = datesToYears(fromStr, toStr);
      const rows = [];
      for (const y of years) {
        try {
          const snap = await db.ref(base(`logbooks/${y}`)).once('value');
          const byClass = snap.val() || {};
          for (const cls of Object.keys(byClass)) {
            if (clsFilter && L(cls) !== L(clsFilter)) continue;
            const byDate = byClass[cls] || {};
            for (const d of Object.keys(byDate)) {
              if (d < fromStr || d > toStr) continue;
              const byId = byDate[d] || {};
              for (const k of Object.keys(byId)) {
                const r = byId[k] || {};
                if (subjFilter && L(r.subject || '') !== L(subjFilter)) continue;
                rows.push({ year: y, cls, date: d, ...r });
              }
            }
          }
        } catch {}
      }
      return rows.sort((a, b) => a.date.localeCompare(b.date) || L(a.cls).localeCompare(L(b.cls)) || L(a.subject || '').localeCompare(L(b.subject || '')));
    }

    document.getElementById('lbExportPdf')?.addEventListener('click', async () => {
      const from = document.getElementById('lbFromDate')?.value;
      const to = document.getElementById('lbToDate')?.value;
      const clsF = document.getElementById('lbFilterClass')?.value || '';
      const subjF = document.getElementById('lbFilterSubject')?.value?.trim() || '';
      if (!from || !to) {
        toast('Pick From and To dates.', 'warning');
        return;
      }
      const items = await fetchLogsRange(from, to, clsF || null, subjF || null);
      if (!items.length) {
        toast('No logs found for the selected date range.', 'warning');
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
      const margin = 40, width = 595 - margin * 2, lh = 14;
      function addWrapped(text, y) {
        const lines = doc.splitTextToSize(text || '', width);
        lines.forEach(line => { doc.text(line, margin, y); y += lh; });
        return y;
      }
      let first = true;
      for (const it of items) {
        if (!first) doc.addPage();
        first = false;
        doc.setFontSize(14);
        doc.text(`Teaching Logbook ‚Äî ${it.date}`, margin, margin);
        doc.setFontSize(11);
        doc.text(`${it.cls} ¬∑ ${it.subject || ''} ¬∑ Time: ${it.time || '‚Äî'}`, margin, margin + 18);
        doc.setFontSize(10);
        let y = margin + 40;
        const T = it.totals || {};
        const stat = `Total: ${T.totalStudents || 0}  |  Present: ${T.present || 0}  |  Absent: ${(T.totalStudents || 0) - (T.present || 0)}  |  ‚ôÇ P/A: ${(T.presentBoys || 0)}/${(T.absentBoys || 0)}  |  ‚ôÄ P/A: ${(T.presentGirls || 0)}/${(T.absentGirls || 0)}`;
        y = addWrapped(stat, y + 2);
        y += 12;
        doc.setFont(undefined, 'bold');
        doc.text('Topic Taught', margin, y);
        doc.setFont(undefined, 'normal');
        y += 12;
        y = addWrapped(it.topicTaught || '‚Äî', y);
        y += 6;
        doc.setFont(undefined, 'bold');
        doc.text('Lesson Summary', margin, y);
        doc.setFont(undefined, 'normal');
        y += 12;
        y = addWrapped(it.lessonSummary || '‚Äî', y);
        y += 6;
        doc.setFont(undefined, 'bold');
        doc.text('Homework Given', margin, y);
        doc.setFont(undefined, 'normal');
        y += 12;
        y = addWrapped(it.homeworkGiven || '‚Äî', y);
        y += 6;
        doc.setFont(undefined, 'bold');
        doc.text('Progress / Completion (%)', margin, y);
        doc.setFont(undefined, 'normal');
        y += 12;
        y = addWrapped(it.progressCompletion || '‚Äî', y);
        y += 6;
        doc.setFont(undefined, 'bold');
        doc.text('Challenges / Issues Faced', margin, y);
        doc.setFont(undefined, 'normal');
        y += 12;
        y = addWrapped(it.challengesIssues || '‚Äî', y);
        y += 6;
        doc.setFont(undefined, 'bold');
        doc.text('Remarks / Observations', margin, y);
        doc.setFont(undefined, 'normal');
        y += 12;
        y = addWrapped(it.remarks || '‚Äî', y);
        doc.setFontSize(8);
        doc.text(`Recorded by: ${it.recordedBy || '‚Äî'} ¬∑ Saved: ${new Date(it.createdAt || Date.now()).toLocaleString()}`, margin, 820);
      }
      const fname = `logbooks_${from}_to_${to}.pdf`;
      doc.save(fname);
      toast('PDF exported successfully!', 'success');
    });

    document.getElementById('lbExportCsv')?.addEventListener('click', async () => {
      const from = document.getElementById('lbFromDate')?.value;
      const to = document.getElementById('lbToDate')?.value;
      const clsF = document.getElementById('lbFilterClass')?.value || '';
      const subjF = document.getElementById('lbFilterSubject')?.value?.trim() || '';
      if (!from || !to) {
        toast('Pick From and To dates.', 'warning');
        return;
      }
      const items = await fetchLogsRange(from, to, clsF || null, subjF || null);
      if (!items.length) {
        toast('No logs found for the selected date range.', 'warning');
        return;
      }
      const rows = [['Date','Class','Subject','Time','Total','Present','P‚ôÇ','P‚ôÄ','A‚ôÇ','A‚ôÄ','Minutes','Topic','Summary','Homework','Progress%','Challenges','Remarks','By']];
      items.forEach(it => {
        const t = it.totals || {};
        rows.push([
          it.date, it.cls, it.subject || '', it.time || '', t.totalStudents || 0, t.present || 0,
          t.presentBoys || 0, t.presentGirls || 0, t.absentBoys || 0, t.absentGirls || 0,
          it.durationMinutes || '', it.topicTaught || '', it.lessonSummary || '', it.homeworkGiven || '',
          it.progressCompletion || '', it.challengesIssues || '', it.remarks || '', it.recordedBy || ''
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Logbooks');
      XLSX.writeFile(wb, `logbooks_${from}_to_${to}.xlsx`);
      toast('CSV exported successfully!', 'success');
    });

    // Wire filters
    document.getElementById('lbFilterClass')?.addEventListener('change', renderLogs);
    document.getElementById('lbFilterSubject')?.addEventListener('input', renderLogs);
    window.somapYearContext.onYearChanged(() => loadLogs());

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initYearSelector();
        loadTeacherConfig();
      });
    } else {
      initYearSelector();
      loadTeacherConfig();
    }
  </script>
</body>
</html>

