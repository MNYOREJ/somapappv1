<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SoMAp • Worker Certificates</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase.js"></script>

  <!-- UI / Export libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <style>
    body{min-height:100vh;background:linear-gradient(180deg,#0f172a,#020617);color:#0f172a}
    .shell{max-width:1100px;margin:0 auto;padding:24px;color:#fff}
    .glass{background:rgba(255,255,255,.9);border:1px solid rgba(255,255,255,.45);border-radius:18px;backdrop-filter:blur(16px);color:#111827}
    .gold{background:linear-gradient(135deg,#fbbf24,#d97706);-webkit-background-clip:text;background-clip:text;color:transparent}
    .seal{width:96px;height:96px;border-radius:999px;border:4px solid #eab308;
          background:radial-gradient(circle at 30% 30%,#fde68a,#f59e0b 60%,#b45309 100%);
          box-shadow:0 10px 30px rgba(234,179,8,.35);}
    /* Offscreen canvas for export */
    #offscreen{position:fixed;left:-9999px;top:-9999px}
  </style>
</head>
<body data-page="workers-certificates">
  <main class="shell space-y-6">
    <header class="glass p-6 space-y-2">
      <div class="flex items-center justify-between">
        <div>
          <p class="uppercase tracking-[0.35em] text-xs text-slate-500">Workers</p>
          <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900">Certificate of Appreciation</h1>
          <p class="text-sm text-slate-600">Auto-filled from workers’ records — export in PNG/PDF.</p>
        </div>
        <div class="text-right">
          <label class="text-xs font-semibold">Academic Year</label>
          <select id="yearSelect" class="border rounded px-2 py-1 text-sm"></select>
          <div class="text-[11px] text-slate-500">Working year: <b id="yearHint">--</b></div>
        </div>
      </div>
      <div id="windowBanner" class="hidden mt-3 text-[13px] text-amber-700 bg-amber-50 border border-amber-300 rounded p-2">
        Certificates are available in November–December. (Admins can override with <code>?force=1</code>.)
      </div>
    </header>

    <!-- Worker mode: single card -->
    <section id="selfBox" class="glass p-6 hidden">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-lg font-semibold" id="selfName">—</div>
          <div class="text-sm text-slate-600" id="selfRole">—</div>
          <div class="text-sm text-slate-600">Phone: <span id="selfPhone">—</span></div>
        </div>
        <div class="flex gap-2">
          <button id="btnPreviewSelf" class="px-3 py-2 rounded border">Preview</button>
          <button id="btnPngSelf" class="px-3 py-2 rounded border">Download PNG</button>
          <button id="btnPdfSelf" class="px-3 py-2 rounded bg-slate-900 text-white">Download PDF</button>
        </div>
      </div>
      <div id="selfPreview" class="mt-4"></div>
    </section>

    <!-- Admin mode: list & search -->
    <section id="adminBox" class="glass p-6 hidden">
      <div class="flex items-center justify-between">
        <input id="searchBox" class="border rounded px-3 py-2 w-full max-w-md" placeholder="Search worker name / phone…" />
        <div class="flex gap-2 ml-4">
          <button id="btnGenerateAll" class="px-3 py-2 rounded border">Generate All</button>
        </div>
      </div>
      <div class="overflow-x-auto mt-4">
        <table class="w-full">
          <thead class="text-xs uppercase tracking-widest text-slate-500">
            <tr><th class="p-2 text-left">Worker</th><th class="p-2">Role</th><th class="p-2">Phone</th><th class="p-2 text-right">Actions</th></tr>
          </thead>
          <tbody id="workersTbody" class="text-sm"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Offscreen render target -->
  <div id="offscreen"></div>

  <!-- Certificate Template (cloned per render) -->
  <template id="workerCertTemplate">
    <div style="width:1120px;height:794px;padding:52px;background:linear-gradient(135deg,#fdfaf5 0%,#f7f3ec 45%,#fdfaf5 100%);border:12px solid #0f172a;border-radius:30px;position:relative;font-family:'Cinzel',serif;color:#111827;overflow:hidden;box-shadow:0 22px 55px rgba(0,0,0,0.18);">
      <!-- Decorative corners -->
      <div style="position:absolute;inset:22px;border:2px solid #eab308;border-radius:20px;pointer-events:none;"></div>
      <div style="position:absolute;inset:0; background:linear-gradient(225deg,rgba(15,118,110,0.08),transparent 38%,rgba(234,179,8,0.09)),linear-gradient(45deg,rgba(0,0,0,0.06),transparent 42%);"></div>
      <div style="position:absolute;top:-140px;left:-120px;width:380px;height:380px;background:radial-gradient(circle,rgba(16,185,129,0.12),transparent 65%);transform:rotate(-8deg);"></div>
      <div style="position:absolute;bottom:-180px;right:-160px;width:420px;height:420px;background:radial-gradient(circle,rgba(234,179,8,0.14),transparent 70%);transform:rotate(14deg);"></div>
      <div style="position:absolute;inset:30px;opacity:.05;background:url('../images/somap-logo.png.jpg') center/50% no-repeat;"></div>

      <div style="position:relative;z-index:2;height:100%;display:flex;flex-direction:column;">
        <!-- Header -->
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;align-items:center;gap:16px;">
            <div style="width:70px;height:70px;border-radius:16px;background:#fff;border:4px solid #eab308;display:grid;place-items:center;box-shadow:0 12px 28px rgba(0,0,0,0.12);overflow:hidden;">
              <img id="logoImg" src="../images/somap-logo.png.jpg" alt="Logo" style="width:100%;height:100%;object-fit:cover;">
            </div>
            <div>
              <div style="font-weight:900;letter-spacing:.22em;color:#0f172a;font-size:15px;">SOCRATES SCHOOL</div>
              <div style="margin-top:4px;font-size:14px;color:#475569;letter-spacing:.08em;">Certificate of Excellence</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:14px;">
            <div style="text-align:right;font-size:12px;color:#334155;line-height:1.5;">
              <div>PO Box 14256, Arusha</div>
              <div>+255 686 828 732 · +255 689 649 822</div>
            </div>
            <div style="width:134px;height:134px;border-radius:22px;border:5px solid #eab308;overflow:hidden;box-shadow:0 16px 30px rgba(0,0,0,0.16);background:#fff;">
              <img id="passport" crossOrigin="anonymous" src="" alt="Photo" style="width:100%;height:100%;object-fit:cover;">
            </div>
          </div>
        </div>

        <!-- Title block -->
        <div style="margin:26px 0 16px 0;text-align:center;position:relative;padding:12px 0;">
          <div style="display:inline-flex;align-items:center;gap:12px;background:linear-gradient(90deg,rgba(15,118,110,0.12),rgba(234,179,8,0.15));padding:8px 16px;border-radius:999px;border:1px solid rgba(15,118,110,0.25);">
            <span style="font-size:13px;letter-spacing:.18em;color:#0f172a;">CERTIFICATE</span>
            <span style="font-size:12px;letter-spacing:.12em;color:#0f172a;opacity:.8;">OF APPRECIATION</span>
          </div>
        </div>

        <!-- Body -->
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 60px;text-align:center;">
          <div style="font-size:15px;color:#475569;letter-spacing:.08em;margin-bottom:8px;">Socrates School Awards</div>
          <div id="fullName" style="font-size:52px;font-weight:900;margin:6px 0;letter-spacing:.05em;color:#b45309;text-transform:uppercase;">—</div>
          <div style="font-size:18px;color:#111827;margin-bottom:8px;">For outstanding service as <b id="roleText" style="color:#0f172a;">—</b> during the year <b id="yearText" style="color:#0f172a;">—</b>.</div>
          <div style="font-size:16px;color:#334155;font-style:italic;line-height:1.6;max-width:820px;">
            Your dedication, professionalism, and consistent excellence have strengthened our community and set a standard of service that inspires others.
          </div>
          <div style="margin-top:12px;font-size:14px;color:#475569;">Issued on <span id="issuedDate" style="font-weight:700;color:#0f172a;">—</span> · Phone <span id="phoneText" style="font-weight:700;color:#0f172a;">—</span></div>
        </div>

        <!-- Footer -->
        <div style="display:flex;justify-content:space-between;align-items:flex-end;padding:0 40px 6px 40px;">
          <div style="text-align:center;">
            <div style="width:220px;height:2px;background:linear-gradient(90deg,transparent,#0f172a,transparent);margin-bottom:10px;"></div>
            <div style="font-weight:700;color:#0f172a;">Head Teacher</div>
          </div>
          <div style="text-align:center;">
            <div style="width:220px;height:2px;background:linear-gradient(90deg,transparent,#0f172a,transparent);margin-bottom:10px;"></div>
            <div style="font-weight:700;color:#0f172a;">Manager</div>
          </div>
          <div style="text-align:center;">
            <div style="width:220px;height:2px;background:linear-gradient(90deg,transparent,#0f172a,transparent);margin-bottom:10px;"></div>
            <div style="font-weight:700;color:#0f172a;">Authorised</div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script src="modules/workers_certificates.js"></script>
</body>
</html>
