<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kuajiri Wafanyakazi | SoMAp</title>
  <link rel="stylesheet" href="../css/workers.css"/>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <style>
    /* Minimal notices so you don't miss errors/success */
    .notice {padding:.75rem 1rem; border-radius:.5rem; margin:.75rem 0; font-size:.95rem}
    .ok{background:#e9f7ef;color:#1a7f37;border:1px solid #a9e5bf}
    .bad{background:#fdecea;color:#b42318;border:1px solid #f8b4b4}
    .muted{opacity:.7}
    .workers-table{width:100%;border-collapse:collapse;margin-top:.75rem}
    .workers-table th,.workers-table td{border:1px solid #eee;padding:.5rem;text-align:left}
  </style>
</head>
<body>
<main>
  <header>
    <h1>Usajili wa Mfanyakazi Mpya</h1>
    <p class="workers-card__subtitle">
      Jaza kila sehemu → weka picha mbili (ID & Passport) → bonyeza “Hifadhi Mfanyakazi”.
      <span id="who" class="muted"></span>
    </p>
    <div id="notice"></div>
  </header>

  <section class="workers-flex">
    <div class="workers-card">
      <header class="workers-card__header">
        <h2>Tarehe ya Leo</h2>
        <p class="workers-card__subtitle" id="currentDate"></p>
      </header>
      <div class="workers-card__content">
        <ul>
          <li>Simu lazima iwe <strong>+2550XXXXXXXXX</strong> (0 + tarakimu 9)</li>
          <li>Majina lazima yawe <strong>MATATU</strong> (mf. JOHN DOE JUNIOR)</li>
          <li>Jukumu (role) lazima lichaguliwe</li>
        </ul>
      </div>
    </div>
  </section>

  <form id="admissionForm" class="workers-form workers-fieldset" novalidate>
    <fieldset class="workers-fieldset">
      <legend>Wasifu wa Mfanyakazi</legend>
      <label>Jina la Kwanza
        <input name="firstName" required>
      </label>
      <label>Jina la Kati
        <input name="middleName" required>
      </label>
      <label>Jina la Mwisho
        <input name="lastName" required>
      </label>
      <label>Nambari ya Simu (+2550xxxxxxxxx)
        <input name="phone" required placeholder="+2550XXXXXXXXX">
      </label>
      <label>Nchi / Country
        <select name="country">
          <option value="TZ" selected>Tanzania (TZ)</option>
          <option value="KE">Kenya (KE)</option>
          <option value="UG">Uganda (UG)</option>
        </select>
      </label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Wasiliana (Next of Kin)</legend>
      <label>Jina la Mtu wa Dharura
        <input name="nextOfKinName" required>
      </label>
      <label>Namba ya Simu ya Mtu wa Dharura
        <input name="nextOfKinPhone" required placeholder="+2550XXXXXXXXX">
      </label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Nyaraka za Utambulisho</legend>
      <label>NSSF Number
        <input name="nssfNumber" required>
      </label>
      <label>NIDA au Passport Number
        <input name="nidaOrPassport" required>
      </label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Taarifa za Familia</legend>
      <label>Jina la Baba
        <input name="fatherName" required>
      </label>
      <label>Jina la Mama
        <input name="motherName" required>
      </label>
      <label>Hali ya Ndoa
        <select name="maritalStatus" required id="maritalStatus">
          <option value="">-- Chagua --</option>
          <option value="single">Sijaoa / Sijaolewa</option>
          <option value="married">Nimeoa / Nimeolewa</option>
          <option value="other">Nyingine</option>
        </select>
      </label>
      <div id="spouseFields" style="display:none;">
        <label>Jina la Mwenza
          <input name="spouseName">
        </label>
        <label>Namba ya Mwenza
          <input name="spousePhone" placeholder="+2550XXXXXXXXX">
        </label>
      </div>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Anuani</legend>
      <label>Eneo / Mtaa / Kata
        <input name="area" required>
      </label>
      <label>Kabila / Tribe
        <input name="tribe" required>
      </label>
      <label>Kijiji cha Nyumbani
        <input name="villageHome" required>
      </label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Ajira</legend>
      <label>Jukumu / Role
        <select name="role" required id="roleSelect">
          <option value="">-- Chagua jukumu --</option>
          <option value="cook">Mpishi / Cook</option>
          <option value="guard">Mlinzi / Guard</option>
          <option value="cleaner">Msafi / Cleaner</option>
          <option value="driver">Dereva / Driver</option>
          <option value="teacher">Mwalimu / Teacher</option>
          <option value="accountant">Mhasibu / Accountant</option>
          <option value="manager">Msimamizi / Manager</option>
          <option value="academic">Mratibu wa Masomo / Academic</option>
          <option value="secretary">Katibu / Secretary</option>
          <option value="hr">Rasilimali Watu / HR</option>
          <option value="storekeeper">Ghala / Storekeeper</option>
        </select>
      </label>
      <label>Mshahara wa Msingi (TZS)
        <input name="baseSalary" type="number" min="0" required>
      </label>
      <label>Hali ya kazi
        <select name="active">
          <option value="true" selected>Hai (Active)</option>
          <option value="false">Imesimama</option>
        </select>
      </label>
      <label>Maelezo ya Afya (hiari)
        <textarea name="medicalConditions" placeholder="Magonjwa sugu / maelezo ya daktari"></textarea>
      </label>
      <label>Uthibitisho wa Afya (PDF / picha, hiari)
        <input type="file" name="medicalProof" accept=".pdf,image/*">
      </label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Faili za LAZIMA</legend>
      <label>Picha ya Kitambulisho (ID photo)
        <input type="file" name="idPhoto" accept="image/*" required>
      </label>
      <label>Picha ya Passport
        <input type="file" name="passportPhoto" accept="image/*" required>
      </label>

      <!-- Role-specific docs will be injected here if you want later -->
      <div id="roleDocs"></div>
    </fieldset>

    <div class="workers-card__actions">
      <button class="workers-btn" type="submit">Hifadhi Mfanyakazi</button>
      <button class="workers-btn secondary" type="reset">Futa & Anza upya</button>
    </div>
  </form>

  <section>
    <h2 class="workers-section-title">Wafanyakazi Walio Sajiliwa</h2>
    <div id="workerTable"></div>
  </section>
</main>

<script>
  /* ---------- Firebase config (one place) ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
    authDomain: "somaptestt.firebaseapp.com",
    databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
    projectId: "somaptestt",
    storageBucket: "somaptestt.appspot.com",
    messagingSenderId: "105526245138",
    appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  /* ---------- Tiny helpers ---------- */
  const $ = (id)=>document.getElementById(id);
  const notice = (msg, ok=false)=>{
    $('notice').innerHTML = `<div class="notice ${ok?'ok':'bad'}">${msg}</div>`;
  };
  const clearNotice = ()=>$('notice').innerHTML='';
  const todayStr = new Date().toLocaleString('sw-TZ',{timeZone:'Africa/Nairobi',weekday:'long',year:'numeric',month:'long',day:'numeric'});
  $('currentDate').textContent = todayStr;

  function isTZWorkerPhone(p){ return /^\+2550\d{9}$/.test(String(p||'').trim()); }
  function normalizeThreeNames(s){
    const t = String(s||'').replace(/\s+/g,' ').trim().toUpperCase().split(' ');
    if (t.length!==3) throw new Error('Majina lazima yawe MATATU (mf. JOHN DOE JUNIOR)');
    return t.join(' ');
  }
  async function sha256Hex(str){
    try{
      if (crypto?.subtle) {
        const buf = new TextEncoder().encode(str);
        const hash = await crypto.subtle.digest('SHA-256', buf);
        return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }
    }catch(_){}
    // Fallback lightweight hash (not cryptographic) if subtle not available
    let h=2166136261>>>0;
    for (let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h+= (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24); }
    return (h>>>0).toString(16);
  }
  function getExt(file){
    const n = file?.name||''; const m=n.match(/\.([a-z0-9]+)$/i);
    if (m) return m[1]; if (!file?.type) return 'dat';
    if (file.type==='application/pdf') return 'pdf';
    if (file.type.startsWith('image/')) return file.type.split('/')[1];
    return 'dat';
  }
  async function uploadOrBlank(file, path){
    if (!file || !file.size) return '';
    try{
      const ref = firebase.storage().ref().child(path);
      await ref.put(file, file.type?{contentType:file.type}:undefined);
      return await ref.getDownloadURL();
    }catch(err){
      console.warn('Storage upload failed for', path, err);
      notice('🔔 Faili zimehifadhiwa bila picha (Storage imekataa / haipatikani). Unaweza kuongeza picha baadaye.', false);
      return '';
    }
  }

  /* ---------- Auth (anonymous) & diagnostics ---------- */
  firebase.auth().onAuthStateChanged(async (u)=>{
    if (!u) { await firebase.auth().signInAnonymously().catch(e=>notice('Auth error: '+e.message)); return; }
    $('who').textContent = ` (UID: ${u.uid})`;
    loadWorkers(); // initial table
  });

  /* ---------- Spouse toggle ---------- */
  $('maritalStatus').addEventListener('change', e=>{
    $('spouseFields').style.display = e.target.value==='married' ? 'grid' : 'none';
  });

  /* ---------- Form submit ---------- */
  document.getElementById('admissionForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    clearNotice();

    const fd = new FormData(e.currentTarget);

    // Basic required fields
    const firstName = (fd.get('firstName')||'').trim();
    const middleName= (fd.get('middleName')||'').trim();
    const lastName  = (fd.get('lastName')||'').trim();
    const phone     = (fd.get('phone')||'').trim();
    const role      = (fd.get('role')||'').trim();

    let fullNameUpper;
    try { fullNameUpper = normalizeThreeNames(`${firstName} ${middleName} ${lastName}`); }
    catch(ex){ return notice(ex.message); }

    if (!isTZWorkerPhone(phone)) return notice('Simu lazima iwe kama +2550XXXXXXXXX');
    if (!role) return notice('Chagua jukumu (Role)');

    // Mandatory photos
    const idPhoto = fd.get('idPhoto');
    const passportPhoto = fd.get('passportPhoto');
    if (!idPhoto?.size || !passportPhoto?.size) return notice('Weka Picha ya Kitambulisho na Picha ya Passport');

    try{
      const workerId = firebase.database().ref('workers').push().key;
      const basePath = `workers/${workerId}`;

      // Try uploads (non-blocking; blanks if Storage refuses)
      const idPhotoUrl = await uploadOrBlank(idPhoto, `${basePath}/idPhoto-${Date.now()}.${getExt(idPhoto)}`);
      const passportPhotoUrl = await uploadOrBlank(passportPhoto, `${basePath}/passport-${Date.now()}.${getExt(passportPhoto)}`);

      let medicalProofUrl = '';
      const medicalProof = fd.get('medicalProof');
      if (medicalProof?.size){
        medicalProofUrl = await uploadOrBlank(medicalProof, `${basePath}/medical-${Date.now()}.${getExt(medicalProof)}`);
      }

      // Build profile
      const profile = {
        firstName, middleName, lastName, fullNameUpper,
        phone,
        country:(fd.get('country')||'TZ').trim(),
        nextOfKinName:(fd.get('nextOfKinName')||'').trim(),
        nextOfKinPhone:(fd.get('nextOfKinPhone')||'').trim(),
        nssfNumber:(fd.get('nssfNumber')||'').trim(),
        nidaOrPassport:(fd.get('nidaOrPassport')||'').trim(),
        fatherName:(fd.get('fatherName')||'').trim(),
        motherName:(fd.get('motherName')||'').trim(),
        maritalStatus:(fd.get('maritalStatus')||'').trim(),
        spouseName:(fd.get('spouseName')||'').trim(),
        spousePhone:(fd.get('spousePhone')||'').trim(),
        area:(fd.get('area')||'').trim(),
        tribe:(fd.get('tribe')||'').trim(),
        villageHome:(fd.get('villageHome')||'').trim(),
        role,
        baseSalary:Number(fd.get('baseSalary')||0),
        active:(fd.get('active')||'true')!=='false',
        medicalConditions:(fd.get('medicalConditions')||'').trim(),
        createdBy: firebase.auth().currentUser?.uid || '',
        admissionDate: Date.now()
      };

      const payload = {
        profile,
        docs: { idPhotoUrl, passportPhotoUrl, medicalProofUrl },
        contract: {
          language: (['driver','cook','cleaner','guard'].includes(role)?'sw':'en'),
          templateKey: role, accepted:false, acceptedTs:0, contractPdfUrl:''
        }
      };

      // Save record (RTDB rules are open in your project)
      await firebase.database().ref(`workers/${workerId}`).set(payload);

      // Index for workers_login
      const loginKey = await sha256Hex(`${fullNameUpper}|${phone}`);
      await firebase.database().ref(`workers_index_by_loginKey/${loginKey}`).set({ workerId });

      notice('Mfanyakazi amesajiliwa kikamilifu ✅', true);
      e.currentTarget.reset();
      $('spouseFields').style.display = 'none';
      loadWorkers();

    }catch(err){
      console.error(err);
      notice('Imeshindikana kuhifadhi: ' + (err?.message || err), false);
    }
  });

  /* ---------- Load table ---------- */
  async function loadWorkers(){
    try{
      const snap = await firebase.database().ref('workers').orderByChild('profile/fullNameUpper').get();
      const rows=[];
      snap.forEach(ch=>{
        const v=ch.val()||{};
        rows.push({
          name: v.profile?.fullNameUpper||'',
          role: v.profile?.role||'',
          phone: v.profile?.phone||'',
          baseSalary: v.profile?.baseSalary||0,
          active: v.profile?.active!==false
        });
      });
      const el = $('workerTable');
      const tbl = document.createElement('table'); tbl.className='workers-table';
      tbl.innerHTML = `
        <thead><tr>
          <th>Jina Kamili</th><th>Jukumu</th><th>Simu</th><th>Mshahara (TZS)</th><th>Hali</th>
        </tr></thead><tbody></tbody>`;
      const tb = tbl.querySelector('tbody');
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.role}</td>
          <td>${r.phone}</td>
          <td>${Number(r.baseSalary||0).toLocaleString('sw-TZ')}</td>
          <td>${r.active?'Active':'Inactive'}</td>`;
        tb.appendChild(tr);
      });
      el.innerHTML=''; el.appendChild(tbl);
    }catch(e){
      console.error('Load workers error:', e);
      notice('Imeshindikana kupakia orodha ya wafanyakazi: ' + (e?.message||e));
    }
  }
</script>
</body>
</html>
