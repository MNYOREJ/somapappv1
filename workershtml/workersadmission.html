<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kuajiri Wafanyakazi | SoMAp</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase/firebase-config.js"></script>
</head>
<body>
  <main>
    <header>
      <h1>Usajili wa Mfanyakazi Mpya</h1>
      <p class="workers-card__subtitle">
        Taarifa zote ni LAZIMA (isipokuwa za hiari). Jaza kwa usahihi ili kukamilisha kumbukumbu, mkataba na kitambulisho.
      </p>
    </header>

    <section class="workers-flex">
      <div class="workers-card">
        <header class="workers-card__header">
          <h2>Tarehe ya Leo</h2>
          <p class="workers-card__subtitle" id="currentDate"></p>
        </header>
        <div class="workers-card__content">
          <p>
            Mfumo huu unahakikisha mpishi, mlinzi, msafi, dereva na timu nzima wanapata mikataba, vitambulisho na sheria zao mara moja.
          </p>
          <ul>
            <li>Mkataba (Kiswahili au Kiingereza kulingana na jukumu)</li>
            <li>Vitambulisho vya kazi vyenye picha na nembo ya shule</li>
            <li>Kanuni na masharti ya kazi</li>
          </ul>
        </div>
      </div>
      <div class="workers-card">
        <header class="workers-card__header">
          <h2>Kanuni Muhimu</h2>
        </header>
        <div class="workers-card__content">
          <p>
            Namba ya simu ni lazima ianze na <strong>+2550</strong> kisha tarakimu 9. Majina matatu kwa MKATO (mfano JOHN DOE JUNIOR).
          </p>
          <p>
            Mpishi yeyote lazima apate sheria na makubaliano kwa Kiswahili. Walinzi na wasafi pia. Walimu, wahasibu na wasimamizi hupata Kiingereza.
          </p>
        </div>
      </div>
    </section>

    <form id="admissionForm" class="workers-form workers-fieldset">
      <fieldset class="workers-fieldset">
        <legend>Wasifu wa Mfanyakazi</legend>
        <label>Jina la Kwanza / First Name
          <input name="firstName" required>
        </label>
        <label>Jina la Kati / Middle Name
          <input name="middleName" required>
        </label>
        <label>Jina la Mwisho / Last Name
          <input name="lastName" required>
        </label>
        <label>Nambari ya Simu (+2550xxxxxxxxx)
          <input name="phone" required placeholder="+2550XXXXXXXXX">
        </label>
        <label>Nchi / Country
          <select name="country">
            <option value="TZ" selected>Tanzania (TZ)</option>
            <option value="KE">Kenya (KE)</option>
            <option value="UG">Uganda (UG)</option>
          </select>
        </label>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Wasiliana (Next of Kin)</legend>
        <label>Jina la Mtu wa Dh emergency
          <input name="nextOfKinName" required>
        </label>
        <label>Namba ya Simu ya Mtu wa Dh emergency
          <input name="nextOfKinPhone" required placeholder="+2550XXXXXXXXX">
        </label>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Nyaraka za Utambulisho</legend>
        <label>NSSF Number
          <input name="nssfNumber" required>
        </label>
        <label>NIDA au Passport Number
          <input name="nidaOrPassport" required>
        </label>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Taarifa za Familia</legend>
        <label>Jina la Baba
          <input name="fatherName" required>
        </label>
        <label>Jina la Mama
          <input name="motherName" required>
        </label>
        <label>Hali ya Ndoa
          <select name="maritalStatus" required>
            <option value="">-- Chagua --</option>
            <option value="single">Sijaoa / Sijaolewa</option>
            <option value="married">Nimeoa / Nimeolewa</option>
            <option value="other">Nyingine</option>
          </select>
        </label>
        <div id="spouseFields" style="display:none;">
          <label>Jina la Mwenza
            <input name="spouseName">
          </label>
          <label>Namba ya Mwenza
            <input name="spousePhone" placeholder="+2550XXXXXXXXX">
          </label>
        </div>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Anuani</legend>
        <label>Eneo / Mtaa / Kata
          <input name="area" required>
        </label>
        <label>Kabila / Tribe
          <input name="tribe" required>
        </label>
        <label>Kijiji cha Nyumbani
          <input name="villageHome" required>
        </label>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Ajira</legend>
        <label>Jukumu / Role
          <select name="role" required id="roleSelect">
            <option value="">-- Chagua jukumu --</option>
            <option value="cook">Mpishi / Cook</option>
            <option value="guard">Mlinzi / Guard</option>
            <option value="cleaner">Msafi / Cleaner</option>
            <option value="driver">Dereva / Driver</option>
            <option value="teacher">Mwalimu / Teacher</option>
            <option value="accountant">Mhasibu / Accountant</option>
            <option value="manager">Msimamizi / Manager</option>
            <option value="academic">Mratibu wa Masomo / Academic</option>
            <option value="secretary">Katibu / Secretary</option>
            <option value="hr">Rasilimali Watu / HR</option>
            <option value="storekeeper">Ghala / Storekeeper</option>
          </select>
        </label>
        <label>Mshahara wa Msingi (TZS)
          <input name="baseSalary" type="number" min="0" required>
        </label>
        <label>Hali ya kazi
          <select name="active">
            <option value="true" selected>Hai (Active)</option>
            <option value="false">Imesimama</option>
          </select>
        </label>
        <label>Maelezo ya Afya (hiari)
          <textarea name="medicalConditions" placeholder="Magonjwa sugu / maelezo ya daktari"></textarea>
        </label>
        <label>Uthibitisho wa Afya (PDF / picha, hiari)
          <input type="file" name="medicalProof" accept=".pdf,image/*">
        </label>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Faili za LAZIMA</legend>
        <label>Picha ya Kitambulisho (ID photo)
          <input type="file" name="idPhoto" accept="image/*" required>
        </label>
        <label>Picha ya Passport
          <input type="file" name="passportPhoto" accept="image/*" required>
        </label>
        <div id="roleDocs"></div>
      </fieldset>

      <div class="workers-card__actions">
        <button class="workers-btn" type="submit">Hifadhi Mfanyakazi</button>
        <button class="workers-btn secondary" type="reset">Futa & Anza upya</button>
      </div>
    </form>

    <section>
      <h2 class="workers-section-title">Wafanyakazi Walio Sajiliwa</h2>
      <div id="workerTable"></div>
    </section>
  </main>

  <script type="module">
    import { ensureAnonymousAuth, dbRefs, sha256Hex, localTs, toast } from '../modules/workers_helpers.js';
    import { normalizeThreeNames, validateAdmissionPayload, isTZWorkerPhone, ROLE_DOC_REQUIREMENTS } from '../modules/workers_validation.js';
    import { uploadFileToStorage, renderTable } from '../modules/workers_ui.js';
    import { defaultContractLanguage, templateKeyForRole } from '../modules/workers_contracts.js';

    const form = document.getElementById('admissionForm');
    const roleDocsContainer = document.getElementById('roleDocs');
    const workerTable = document.getElementById('workerTable');
    const roleSelect = document.getElementById('roleSelect');
    const spouseFields = document.getElementById('spouseFields');
    const dateLabel = document.getElementById('currentDate');

    const DOC_LABELS = {
      cv: 'CV (PDF)',
      formFourCert: 'Cheti cha Kidato cha Nne',
      roleCert: 'Cheti cha Jukumu',
      villageLetter: 'Barua ya Kijiji',
      medicalProof: 'Uthibitisho wa Afya'
    };

    dateLabel.textContent = new Date().toLocaleString('sw-TZ', {
      timeZone: 'Africa/Nairobi',
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    ensureAnonymousAuth().then(checkAdmin).then(loadWorkers);

    roleSelect.addEventListener('change', renderRoleDocs);
    form.addEventListener('change', evt => {
      if (evt.target.name === 'maritalStatus') {
        spouseFields.style.display = evt.target.value === 'married' ? 'grid' : 'none';
      }
    });
    form.addEventListener('submit', handleSubmit);

    async function checkAdmin(user) {
      const uid = user.uid;
      const adminSnap = await firebase.database().ref(`admins/${uid}`).once('value');
      if (!adminSnap.exists() || adminSnap.val() !== true) {
        toast('Hakuna ruhusa ya kuajiri. Wasiliana na msimamizi.', 'error');
        window.location.href = '../index.html';
        throw new Error('Not admin');
      }
      return uid;
    }

    function renderRoleDocs() {
      roleDocsContainer.innerHTML = '';
      const role = roleSelect.value;
      const requirements = ROLE_DOC_REQUIREMENTS[role] || [];

      requirements.forEach(key => {
        const wrapper = document.createElement('label');
        wrapper.textContent = DOC_LABELS[key] || key;
        const input = document.createElement('input');
        input.type = 'file';
        input.name = key;
        input.required = true;
        input.accept = key === 'cv' || key === 'formFourCert' ? '.pdf' : '.pdf,image/*';
        wrapper.appendChild(input);
        roleDocsContainer.appendChild(wrapper);
      });
    }

    async function handleSubmit(event) {
      event.preventDefault();
      const formData = new FormData(form);
      const rawProfile = Object.fromEntries(formData.entries());
      const profile = { ...rawProfile };
      ['idPhoto', 'passportPhoto', 'medicalProof', 'cv', 'formFourCert', 'roleCert', 'villageLetter'].forEach(key => {
        delete profile[key];
      });
      ['firstName', 'middleName', 'lastName', 'nextOfKinName', 'fatherName', 'motherName', 'spouseName', 'area', 'tribe', 'villageHome', 'country', 'role', 'nssfNumber', 'nidaOrPassport', 'maritalStatus'].forEach(field => {
        if (profile[field]) {
          profile[field] = String(profile[field]).trim();
        }
      });
      profile.baseSalary = Number(profile.baseSalary || 0);
      profile.createdBy = firebase.auth().currentUser.uid;
      profile.admissionDate = localTs();
      profile.active = profile.active !== 'false';
      profile.fullNameUpper = normalizeThreeNames(`${profile.firstName} ${profile.middleName} ${profile.lastName}`);
      profile.phone = profile.phone.trim();
      profile.nextOfKinPhone = profile.nextOfKinPhone.trim();
      if (profile.spousePhone) profile.spousePhone = profile.spousePhone.trim();

      const docs = {
        idPhoto: formData.get('idPhoto'),
        passportPhoto: formData.get('passportPhoto'),
        medicalProof: formData.get('medicalProof')
      };

      Object.keys(ROLE_DOC_REQUIREMENTS).forEach(role => {
        ROLE_DOC_REQUIREMENTS[role].forEach(docKey => {
          docs[docKey] = formData.get(docKey);
        });
      });

      const errors = validateAdmissionPayload({ profile, docs });
      if (errors.length) {
        toast(errors.join(', '), 'error');
        return;
      }

      try {
        const workerId = firebase.database().ref('workers').push().key;
        const loginKey = await sha256Hex(`${profile.fullNameUpper}|${profile.phone}`);
        const storageBase = `workers/${workerId}`;
        const uploads = {};

        uploads.idPhotoUrl = await uploadFileToStorage(docs.idPhoto, `${storageBase}/idPhoto-${Date.now()}.jpg`);
        uploads.passportPhotoUrl = await uploadFileToStorage(docs.passportPhoto, `${storageBase}/passport-${Date.now()}.jpg`);
        if (docs.medicalProof && docs.medicalProof.size) {
          uploads.medicalProofUrl = await uploadFileToStorage(docs.medicalProof, `${storageBase}/medical-${Date.now()}.${getExtension(docs.medicalProof)}`);
        }

        const roleDocs = ROLE_DOC_REQUIREMENTS[profile.role] || [];
        for (const key of roleDocs) {
          const file = docs[key];
          if (file && file.size) {
            uploads[`${mapDocKey(key)}Url`] = await uploadFileToStorage(file, `${storageBase}/${key}-${Date.now()}.${getExtension(file)}`);
          }
        }

        const contractLanguage = defaultContractLanguage(profile.role);
        const contractTemplateKey = templateKeyForRole(profile.role);

        const payload = {
          profile,
          docs: {
            idPhotoUrl: uploads.idPhotoUrl || '',
            passportPhotoUrl: uploads.passportPhotoUrl || '',
            cvPdfUrl: uploads.cvPdfUrl || '',
            formFourCertUrl: uploads.formFourCertUrl || '',
            roleCertUrl: uploads.roleCertUrl || '',
            villageLetterUrl: uploads.villageLetterUrl || '',
            medicalProofUrl: uploads.medicalProofUrl || ''
          },
          contract: {
            language: contractLanguage,
            templateKey: contractTemplateKey,
            accepted: false,
            acceptedTs: 0,
            contractPdfUrl: ''
          }
        };

        await firebase.database().ref(`workers/${workerId}`).set(payload);
        await firebase.database().ref(`workers_index_by_loginKey/${loginKey}`).set({ workerId });
        toast('Mfanyakazi amesajiliwa kikamilifu ðŸŽ‰', 'success');
        form.reset();
        renderRoleDocs();
        loadWorkers();
      } catch (error) {
        console.error(error);
        toast(error.message || 'Imeshindikana kuhifadhi', 'error');
      }
    }

    function mapDocKey(key) {
      switch (key) {
        case 'cv':
          return 'cvPdf';
        case 'formFourCert':
          return 'formFourCert';
        case 'roleCert':
          return 'roleCert';
        case 'villageLetter':
          return 'villageLetter';
        default:
          return key;
      }
    }

    function getExtension(file) {
      const name = file.name || '';
      const match = name.match(/\.([a-zA-Z0-9]+)$/);
      if (match) return match[1];
      if (file.type === 'application/pdf') return 'pdf';
      if (file.type.startsWith('image/')) return file.type.split('/')[1];
      return 'dat';
    }

    async function loadWorkers() {
      const snap = await firebase.database().ref('workers').orderByChild('profile/fullNameUpper').once('value');
      const workers = [];
      snap.forEach(child => {
        const data = child.val() || {};
        workers.push({
          id: child.key,
          name: data.profile?.fullNameUpper || '',
          role: data.profile?.role || '',
          phone: data.profile?.phone || '',
          baseSalary: data.profile?.baseSalary || 0,
          active: data.profile?.active !== false
        });
      });

      renderTable(workerTable, {
        columns: [
          { label: 'Jina Kamili', field: 'name' },
          { label: 'Jukumu', field: 'role' },
          { label: 'Simu', field: 'phone' },
          {
            label: 'Mshahara (TZS)',
            value: row => Number(row.baseSalary || 0).toLocaleString('sw-TZ')
          },
          {
            label: 'Hali',
            value: row => row.active ? 'Active' : 'Inactive'
          }
        ],
        rows: workers
      });
    }
  </script>
</body>
</html>


