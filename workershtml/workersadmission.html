<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kuajiri Wafanyakazi | SoMAp</title>
  <link rel="stylesheet" href="../css/workers.css">

  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <!-- IMPORTANT: do NOT include firebase-config.js as a classic script if it uses `export` -->
</head>
<body>
  <main>
    <header>
      <h1>Usajili wa Mfanyakazi Mpya</h1>
      <p class="workers-card__subtitle">
        Taarifa zote ni LAZIMA (isipokuwa za hiari). Jaza kwa usahihi ili kukamilisha kumbukumbu, mkataba na kitambulisho.
      </p>
    </header>

    <section class="workers-flex">
      <div class="workers-card">
        <header class="workers-card__header">
          <h2>Tarehe ya Leo</h2>
          <p class="workers-card__subtitle" id="currentDate"></p>
        </header>
        <div class="workers-card__content">
          <p>
            Mfumo huu unahakikisha mpishi, mlinzi, msafi, dereva na timu nzima wanapata mikataba, vitambulisho na sheria zao mara moja.
          </p>
          <ul>
            <li>Mkataba (Kiswahili au Kiingereza kulingana na jukumu)</li>
            <li>Vitambulisho vya kazi vyenye picha na nembo ya shule</li>
            <li>Kanuni na masharti ya kazi</li>
          </ul>
        </div>
      </div>
      <div class="workers-card">
        <header class="workers-card__header">
          <h2>Kanuni Muhimu</h2>
        </header>
        <div class="workers-card__content">
          <p>
            Namba ya simu ni lazima ianze na <strong>+2550</strong> kisha tarakimu 9. Majina matatu kwa MKATO (mfano JOHN DOE JUNIOR).
          </p>
          <p>
            Mpishi yeyote lazima apate sheria na makubaliano kwa Kiswahili. Walinzi na wasafi pia. Walimu, wahasibu na wasimamizi hupata Kiingereza.
          </p>
        </div>
      </div>
    </section>

    <form id="admissionForm" class="workers-form workers-fieldset" novalidate>
      <fieldset class="workers-fieldset">
        <legend>Wasifu wa Mfanyakazi</legend>
        <label>Jina la Kwanza / First Name
          <input name="firstName" required>
        </label>
        <label>Jina la Kati / Middle Name
          <input name="middleName" required>
        </label>
        <label>Jina la Mwisho / Last Name
          <input name="lastName" required>
        </label>
        <label>Nambari ya Simu (+2550xxxxxxxxx)
          <input name="phone" required placeholder="+2550XXXXXXXXX">
        </label>
        <label>Nchi / Country
          <select name="country">
            <option value="TZ" selected>Tanzania (TZ)</option>
            <option value="KE">Kenya (KE)</option>
            <option value="UG">Uganda (UG)</option>
          </select>
        </label>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Wasiliana (Next of Kin)</legend>
        <label>Jina la Mtu wa Dharura
          <input name="nextOfKinName" required>
        </label>
        <label>Namba ya Simu ya Mtu wa Dharura
          <input name="nextOfKinPhone" required placeholder="+2550XXXXXXXXX">
        </label>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Nyaraka za Utambulisho</legend>
        <label>NSSF Number
          <input name="nssfNumber" required>
        </label>
        <label>NIDA au Passport Number
          <input name="nidaOrPassport" required>
        </label>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Taarifa za Familia</legend>
        <label>Jina la Baba
          <input name="fatherName" required>
        </label>
        <label>Jina la Mama
          <input name="motherName" required>
        </label>
        <label>Hali ya Ndoa
          <select name="maritalStatus" required>
            <option value="">-- Chagua --</option>
            <option value="single">Sijaoa / Sijaolewa</option>
            <option value="married">Nimeoa / Nimeolewa</option>
            <option value="other">Nyingine</option>
          </select>
        </label>
        <div id="spouseFields" style="display:none;">
          <label>Jina la Mwenza
            <input name="spouseName">
          </label>
          <label>Namba ya Mwenza
            <input name="spousePhone" placeholder="+2550XXXXXXXXX">
          </label>
        </div>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Anuani</legend>
        <label>Eneo / Mtaa / Kata
          <input name="area" required>
        </label>
        <label>Kabila / Tribe
          <input name="tribe" required>
        </label>
        <label>Kijiji cha Nyumbani
          <input name="villageHome" required>
        </label>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Ajira</legend>
        <label>Jukumu / Role
          <select name="role" required id="roleSelect">
            <option value="">-- Chagua jukumu --</option>
            <option value="cook">Mpishi / Cook</option>
            <option value="guard">Mlinzi / Guard</option>
            <option value="cleaner">Msafi / Cleaner</option>
            <option value="driver">Dereva / Driver</option>
            <option value="teacher">Mwalimu / Teacher</option>
            <option value="accountant">Mhasibu / Accountant</option>
            <option value="manager">Msimamizi / Manager</option>
            <option value="academic">Mratibu wa Masomo / Academic</option>
            <option value="secretary">Katibu / Secretary</option>
            <option value="hr">Rasilimali Watu / HR</option>
            <option value="storekeeper">Ghala / Storekeeper</option>
          </select>
        </label>
        <label>Mshahara wa Msingi (TZS)
          <input name="baseSalary" type="number" min="0" required>
        </label>
        <label>Hali ya kazi
          <select name="active">
            <option value="true" selected>Hai (Active)</option>
            <option value="false">Imesimama</option>
          </select>
        </label>
        <label>Maelezo ya Afya (hiari)
          <textarea name="medicalConditions" placeholder="Magonjwa sugu / maelezo ya daktari"></textarea>
        </label>
        <label>Uthibitisho wa Afya (PDF / picha, hiari)
          <input type="file" name="medicalProof" accept=".pdf,image/*">
        </label>
      </fieldset>

      <fieldset class="workers-fieldset">
        <legend>Faili za LAZIMA</legend>
        <label>Picha ya Kitambulisho (ID photo)
          <input type="file" name="idPhoto" accept="image/*" required>
        </label>
        <label>Picha ya Passport
          <input type="file" name="passportPhoto" accept="image/*" required>
        </label>
        <div id="roleDocs"></div>
      </fieldset>

      <div class="workers-card__actions">
        <button class="workers-btn" type="submit">Hifadhi Mfanyakazi</button>
        <button class="workers-btn secondary" type="reset">Futa & Anza upya</button>
      </div>
    </form>

    <section>
      <h2 class="workers-section-title">Wafanyakazi Walio Sajiliwa</h2>
      <div id="workerTable"></div>
    </section>
  </main>

  <script type="module">
    /***** 1) Correct imports (paths are from workershtml/) *****/
    import { firebaseConfig } from './firebase/firebase-config.js';           // FIXED path
    import { ensureAnonymousAuth, sha256Hex, localTs, toast } from './modules/workers_helpers.js';   // FIXED path
    import { normalizeThreeNames, validateAdmissionPayload, ROLE_DOC_REQUIREMENTS } from './modules/workers_validation.js'; // FIXED path
    import { uploadFileToStorage, renderTable } from './modules/workers_ui.js';  // FIXED path
    import { defaultContractLanguage, templateKeyForRole } from './modules/workers_contracts.js';     // FIXED path

    // 2) Initialize Firebase (critical)
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    // 3) DOM refs
    const form = document.getElementById('admissionForm');
    const roleDocsContainer = document.getElementById('roleDocs');
    const workerTable = document.getElementById('workerTable');
    const roleSelect = document.getElementById('roleSelect');
    const spouseFields = document.getElementById('spouseFields');
    const dateLabel = document.getElementById('currentDate');

    const DOC_LABELS = {
      cv: 'CV (PDF)',
      formFourCert: 'Cheti cha Kidato cha Nne (PDF)',
      roleCert: 'Cheti cha Jukumu (PDF/IMG)',
      villageLetter: 'Barua ya Kijiji (PDF/IMG)',
      medicalProof: 'Uthibitisho wa Afya'
    };

    // 4) Today label
    dateLabel.textContent = new Date().toLocaleString('sw-TZ', {
      timeZone: 'Africa/Nairobi', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    // 5) Auth & admin check, then load workers
    try {
      const user = await ensureAnonymousAuth();
      const uid = user?.uid;
      if (!uid) throw new Error('Auth failed');

      const adminSnap = await firebase.database().ref(`admins/${uid}`).get();
      if (!adminSnap.exists() || adminSnap.val() !== true) {
        toast('Hakuna ruhusa ya kuajiri. Ongeza UID hii kwenye admins/ kisha jaribu tena.', 'error');
        console.warn('Your current UID is not admin:', uid);
        // redirect if you want:
        // window.location.href = '../index.html';
      } else {
        await loadWorkers();
      }
    } catch (e) {
      console.error(e);
      toast(e.message || 'Hitilafu ya uhalalishaji', 'error');
    }

    // 6) Events
    roleSelect.addEventListener('change', renderRoleDocs);
    form.addEventListener('change', (evt) => {
      if (evt.target.name === 'maritalStatus') {
        spouseFields.style.display = evt.target.value === 'married' ? 'grid' : 'none';
      }
    });
    form.addEventListener('submit', handleSubmit);

    // Render initial role docs section (empty until role chosen)
    renderRoleDocs();

    function renderRoleDocs() {
      roleDocsContainer.innerHTML = '';
      const role = roleSelect.value;
      const requirements = ROLE_DOC_REQUIREMENTS[role] || [];
      requirements.forEach((key) => {
        const wrapper = document.createElement('label');
        wrapper.textContent = DOC_LABELS[key] || key;
        const input = document.createElement('input');
        input.type = 'file';
        input.name = key;
        input.required = true;
        input.accept = (key === 'cv' || key === 'formFourCert') ? '.pdf' : '.pdf,image/*';
        wrapper.appendChild(input);
        roleDocsContainer.appendChild(wrapper);
      });
    }

    async function handleSubmit(event) {
      event.preventDefault();

      // Let the browser show built-in errors for required inputs if any
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const formData = new FormData(form);

      const profile = {
        firstName: (formData.get('firstName') || '').trim(),
        middleName: (formData.get('middleName') || '').trim(),
        lastName: (formData.get('lastName') || '').trim(),
        phone: (formData.get('phone') || '').trim(),
        country: (formData.get('country') || 'TZ').trim(),
        nextOfKinName: (formData.get('nextOfKinName') || '').trim(),
        nextOfKinPhone: (formData.get('nextOfKinPhone') || '').trim(),
        nssfNumber: (formData.get('nssfNumber') || '').trim(),
        nidaOrPassport: (formData.get('nidaOrPassport') || '').trim(),
        fatherName: (formData.get('fatherName') || '').trim(),
        motherName: (formData.get('motherName') || '').trim(),
        maritalStatus: (formData.get('maritalStatus') || '').trim(),
        spouseName: (formData.get('spouseName') || '').trim(),
        spousePhone: (formData.get('spousePhone') || '').trim(),
        area: (formData.get('area') || '').trim(),
        tribe: (formData.get('tribe') || '').trim(),
        villageHome: (formData.get('villageHome') || '').trim(),
        role: (formData.get('role') || '').trim(),
        baseSalary: Number(formData.get('baseSalary') || 0),
        active: (formData.get('active') || 'true') !== 'false',
        medicalConditions: (formData.get('medicalConditions') || '').trim(),
        createdBy: firebase.auth().currentUser?.uid || '',
        admissionDate: localTs()
      };

      // Enforce three-names and +2550… here as well (validation module also checks)
      try {
        profile.fullNameUpper = normalizeThreeNames(`${profile.firstName} ${profile.middleName} ${profile.lastName}`);
      } catch (e) {
        toast('Majina lazima yawe MATATU na yaandikwe kwa usahihi', 'error');
        return;
      }

      // Collect required files
      const baseDocs = {
        idPhoto: formData.get('idPhoto'),
        passportPhoto: formData.get('passportPhoto'),
        medicalProof: formData.get('medicalProof')
      };

      // Only the selected role’s required docs
      const roleDocs = {};
      const reqs = ROLE_DOC_REQUIREMENTS[profile.role] || [];
      for (const key of reqs) {
        roleDocs[key] = formData.get(key);
      }

      // Validate payload (fields + files)
      const errors = validateAdmissionPayload({ profile, docs: { ...baseDocs, ...roleDocs } });
      if (errors.length) {
        toast(errors.join(', '), 'error');
        return;
      }

      try {
        const workerId = firebase.database().ref('workers').push().key;
        const loginKey = await sha256Hex(`${profile.fullNameUpper}|${profile.phone}`);
        const storageBase = `workers/${workerId}`;
        const uploads = {};

        // Upload mandatory photos
        uploads.idPhotoUrl = await uploadFileToStorage(baseDocs.idPhoto, `${storageBase}/idPhoto-${Date.now()}.jpg`);
        uploads.passportPhotoUrl = await uploadFileToStorage(baseDocs.passportPhoto, `${storageBase}/passport-${Date.now()}.jpg`);

        // Optional medical proof
        if (baseDocs.medicalProof && baseDocs.medicalProof.size) {
          uploads.medicalProofUrl = await uploadFileToStorage(
            baseDocs.medicalProof,
            `${storageBase}/medical-${Date.now()}.${getExtension(baseDocs.medicalProof)}`
          );
        }

        // Upload role-specific docs
        for (const key of reqs) {
          const file = roleDocs[key];
          if (file && file.size) {
            const urlKey = mapDocKey(key) + 'Url';
            uploads[urlKey] = await uploadFileToStorage(
              file,
              `${storageBase}/${key}-${Date.now()}.${getExtension(file)}`
            );
          }
        }

        // Contract defaults
        const contractLanguage = defaultContractLanguage(profile.role);
        const contractTemplateKey = templateKeyForRole(profile.role);

        const payload = {
          profile,
          docs: {
            idPhotoUrl: uploads.idPhotoUrl || '',
            passportPhotoUrl: uploads.passportPhotoUrl || '',
            cvPdfUrl: uploads.cvPdfUrl || '',
            formFourCertUrl: uploads.formFourCertUrl || '',
            roleCertUrl: uploads.roleCertUrl || '',
            villageLetterUrl: uploads.villageLetterUrl || '',
            medicalProofUrl: uploads.medicalProofUrl || ''
          },
          contract: {
            language: contractLanguage,
            templateKey: contractTemplateKey,
            accepted: false,
            acceptedTs: 0,
            contractPdfUrl: ''
          }
        };

        // Write to RTDB (requires your current UID to be /admins/{uid}=true)
        await firebase.database().ref(`workers/${workerId}`).set(payload);
        await firebase.database().ref(`workers_index_by_loginKey/${loginKey}`).set({ workerId });

        toast('Mfanyakazi amesajiliwa kikamilifu 🎉', 'success');
        form.reset();
        renderRoleDocs();
        loadWorkers();
      } catch (error) {
        console.error('Save error:', error);
        toast(error?.message || 'Imeshindikana kuhifadhi (angalia rules / admins / storage)', 'error');
      }
    }

    function mapDocKey(key) {
      switch (key) {
        case 'cv': return 'cvPdf';
        case 'formFourCert': return 'formFourCert';
        case 'roleCert': return 'roleCert';
        case 'villageLetter': return 'villageLetter';
        default: return key;
      }
    }

    function getExtension(file) {
      const name = file?.name || '';
      const m = name.match(/\.([a-zA-Z0-9]+)$/);
      if (m) return m[1];
      if (!file?.type) return 'dat';
      if (file.type === 'application/pdf') return 'pdf';
      if (file.type.startsWith('image/')) return file.type.split('/')[1];
      return 'dat';
    }

    async function loadWorkers() {
      try {
        const snap = await firebase.database().ref('workers').orderByChild('profile/fullNameUpper').get();
        const workers = [];
        snap.forEach((child) => {
          const data = child.val() || {};
          workers.push({
            id: child.key,
            name: data.profile?.fullNameUpper || '',
            role: data.profile?.role || '',
            phone: data.profile?.phone || '',
            baseSalary: data.profile?.baseSalary || 0,
            active: data.profile?.active !== false
          });
        });

        renderTable(workerTable, {
          columns: [
            { label: 'Jina Kamili', field: 'name' },
            { label: 'Jukumu', field: 'role' },
            { label: 'Simu', field: 'phone' },
            { label: 'Mshahara (TZS)', value: (row) => Number(row.baseSalary || 0).toLocaleString('sw-TZ') },
            { label: 'Hali', value: (row) => (row.active ? 'Active' : 'Inactive') }
          ],
          rows: workers
        });
      } catch (e) {
        console.error('Load workers error:', e);
        toast('Imeshindikana kupakia orodha ya wafanyakazi', 'error');
      }
    }
  </script>
</body>
</html>
