<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kuajiri Wafanyakazi | SoMAp</title>
  <link rel="stylesheet" href="../css/workers.css"/>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    .workers-table{width:100%;border-collapse:collapse}
    .workers-table th,.workers-table td{border:1px solid #ddd;padding:.5rem;font-size:.95rem}
    .workers-table th{background:#fafafa;text-align:left}
    .workers-card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:8px 0;background:#fff}
    .workers-card__header h2{margin:0 0 4px 0}
    .workers-card__subtitle{color:#6b7280;margin:.25rem 0 0 0}
    .workers-card__actions{display:flex;gap:.5rem;margin-top:12px}
    .workers-btn{padding:.6rem 1rem;border:0;border-radius:10px;background:#111827;color:#fff;cursor:pointer}
    .workers-btn.secondary{background:#6b7280}
    .workers-form{display:grid;gap:16px}
    .workers-fieldset{display:grid;gap:8px;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .workers-flex{display:grid;gap:12px}
    label{display:grid;gap:6px}
    input,select,textarea{padding:.6rem;border:1px solid #d1d5db;border-radius:10px}
  </style>
</head>
<body>
<main>
  <header>
    <h1>Usajili wa Mfanyakazi Mpya</h1>
    <p class="workers-card__subtitle">
      Jaza kila sehemu → weka picha mbili (ID & Passport) → bonyeza “Hifadhi Mfanyakazi”.
    </p>
  </header>

  <section class="workers-flex">
    <div class="workers-card">
      <header class="workers-card__header">
        <h2>Tarehe ya Leo</h2>
        <p class="workers-card__subtitle" id="currentDate"></p>
      </header>
      <div class="workers-card__content">
        <ul>
          <li>Simu lazima iwe kama <strong>+2550XXXXXXXXX</strong> (tarakimu 9 baada ya 0)</li>
          <li>Majina lazima yawe <strong>MATATU</strong> (mf. JOHN DOE JUNIOR)</li>
          <li>Chagua jukumu (role)</li>
        </ul>
      </div>
    </div>
  </section>

  <form id="admissionForm" class="workers-form workers-fieldset" novalidate>
    <fieldset class="workers-fieldset">
      <legend>Wasifu wa Mfanyakazi</legend>
      <label>Jina la Kwanza <input name="firstName" required></label>
      <label>Jina la Kati   <input name="middleName" required></label>
      <label>Jina la Mwisho <input name="lastName" required></label>
      <label>Nambari ya Simu (+2550xxxxxxxxx) <input name="phone" required placeholder="+2550XXXXXXXXX"></label>
      <label>Nchi / Country
        <select name="country">
          <option value="TZ" selected>Tanzania (TZ)</option>
          <option value="KE">Kenya (KE)</option>
          <option value="UG">Uganda (UG)</option>
        </select>
      </label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Wasiliana (Next of Kin)</legend>
      <label>Jina la Mtu wa Dharura <input name="nextOfKinName" required></label>
      <label>Namba ya Simu ya Mtu wa Dharura <input name="nextOfKinPhone" required placeholder="+2550XXXXXXXXX"></label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Nyaraka za Utambulisho</legend>
      <label>NSSF Number <input name="nssfNumber" required></label>
      <label>NIDA au Passport Number <input name="nidaOrPassport" required></label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Taarifa za Familia</legend>
      <label>Jina la Baba <input name="fatherName" required></label>
      <label>Jina la Mama <input name="motherName" required></label>
      <label>Hali ya Ndoa
        <select name="maritalStatus" required id="maritalStatus">
          <option value="">-- Chagua --</option>
          <option value="single">Sijaoa / Sijaolewa</option>
          <option value="married">Nimeoa / Nimeolewa</option>
          <option value="other">Nyingine</option>
        </select>
      </label>
      <div id="spouseFields" style="display:none;">
        <label>Jina la Mwenza <input name="spouseName"></label>
        <label>Namba ya Mwenza <input name="spousePhone" placeholder="+2550XXXXXXXXX"></label>
      </div>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Anuani</legend>
      <label>Eneo / Mtaa / Kata <input name="area" required></label>
      <label>Kabila / Tribe <input name="tribe" required></label>
      <label>Kijiji cha Nyumbani <input name="villageHome" required></label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Ajira</legend>
      <label>Jukumu / Role
        <select name="role" required id="roleSelect">
          <option value="">-- Chagua jukumu --</option>
          <option value="cook">Mpishi / Cook</option>
          <option value="guard">Mlinzi / Guard</option>
          <option value="cleaner">Msafi / Cleaner</option>
          <option value="driver">Dereva / Driver</option>
          <option value="teacher">Mwalimu / Teacher</option>
          <option value="accountant">Mhasibu / Accountant</option>
          <option value="manager">Msimamizi / Manager</option>
          <option value="academic">Mratibu wa Masomo / Academic</option>
          <option value="secretary">Katibu / Secretary</option>
          <option value="hr">Rasilimali Watu / HR</option>
          <option value="storekeeper">Ghala / Storekeeper</option>
        </select>
      </label>
      <label>Mshahara wa Msingi (TZS) <input name="baseSalary" type="number" min="0" required></label>
      <label>Hali ya kazi
        <select name="active">
          <option value="true" selected>Hai (Active)</option>
          <option value="false">Imesimama</option>
        </select>
      </label>
      <label>Maelezo ya Afya (hiari) <textarea name="medicalConditions" placeholder="Magonjwa sugu / maelezo ya daktari"></textarea></label>
      <label>Uthibitisho wa Afya (PDF / picha, hiari) <input type="file" name="medicalProof" accept=".pdf,image/*"></label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Faili za LAZIMA</legend>
      <label>Picha ya Kitambulisho (ID photo) <input type="file" name="idPhoto" accept="image/*" required></label>
      <label>Picha ya Passport <input type="file" name="passportPhoto" accept="image/*" required></label>
      <div id="roleDocs"></div>
    </fieldset>

    <div class="workers-card__actions">
      <button class="workers-btn" type="submit">Hifadhi Mfanyakazi</button>
      <button class="workers-btn secondary" type="reset">Futa & Anza upya</button>
    </div>
  </form>

  <section>
    <h2 class="workers-section-title">Wafanyakazi Walio Sajiliwa</h2>
    <div id="workerTable"></div>
  </section>
</main>

<script type="module">
  /* ---------- Firebase init (no auth required) ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
    authDomain: "somaptestt.firebaseapp.com",
    databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
    projectId: "somaptestt",
    storageBucket: "somaptestt.appspot.com",
    messagingSenderId: "105526245138",
    appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /* ---------- Cloudinary (edit in DevTools if needed) ---------- */
  const CLD_CLOUD_NAME    = localStorage.getItem('cloud_name')    || 'dg7vnrkgd';
  const CLD_UPLOAD_PRESET = localStorage.getItem('upload_preset') || 'books_unsigned';
  const CLD_FOLDER        = 'somapappv1/workers';

  /* ---------- Small helpers ---------- */
  const $ = (id)=>document.getElementById(id);
  $('currentDate').textContent =
    new Date().toLocaleString('sw-TZ',{timeZone:'Africa/Nairobi',weekday:'long',year:'numeric',month:'long',day:'numeric'});

  const ROLE_DOC_REQUIREMENTS = {
    teacher:['cv','formFourCert'],
    accountant:['cv'],
    manager:['cv'],
    academic:['cv'],
    driver:['roleCert'],
    cook:['roleCert','villageLetter'],
    cleaner:['villageLetter'],
    guard:['villageLetter'],
    storekeeper:['roleCert'],
    hr:['cv'],
    secretary:['cv']
  };
  const DOC_LABELS = {
    cv:'CV (PDF)',
    formFourCert:'Cheti cha Kidato cha Nne (PDF)',
    roleCert:'Cheti cha Jukumu / Leseni (PDF/IMG)',
    villageLetter:'Barua ya Kijiji (PDF/IMG)'
  };
  function renderRoleDocs(){
    const c = $('roleDocs'); c.innerHTML = '';
    const role = $('roleSelect').value;
    (ROLE_DOC_REQUIREMENTS[role]||[]).forEach(key=>{
      const lab = document.createElement('label');
      lab.textContent = DOC_LABELS[key] || key;
      const inp = document.createElement('input');
      inp.type = 'file'; inp.name = key; inp.required = true;
      inp.accept = (key==='cv' || key==='formFourCert')?'.pdf':'.pdf,image/*';
      lab.appendChild(inp); c.appendChild(lab);
    });
  }
  $('roleSelect').addEventListener('change', renderRoleDocs);
  renderRoleDocs();

  function isTZWorkerPhone(p){ return /^\+2550\d{9}$/.test(String(p||'').trim()); }
  function normalizeThreeNames(s){
    const t = String(s||'').replace(/\s+/g,' ').trim().toUpperCase().split(' ');
    if (t.length!==3) throw new Error('Majina lazima yawe MATATU (mf. JOHN DOE JUNIOR)');
    return t.join(' ');
  }
  async function sha256Hex(str){
    const buf = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function cldUpload(file, publicIdHint='file'){
    if (!file || !file.size) throw new Error('Chagua faili kwanza');
    const isImage = (file.type||'').startsWith('image/');
    const resource = isImage ? 'image' : 'raw';
    const url = `https://api.cloudinary.com/v1_1/${CLD_CLOUD_NAME}/${resource}/upload`;
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLD_UPLOAD_PRESET);
    fd.append('folder', CLD_FOLDER);
    fd.append('public_id', String(publicIdHint).replace(/[^a-z0-9_\-]/gi, '_'));
    const res = await fetch(url, { method:'POST', body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error?.message || 'Cloudinary upload failed');
    return data.secure_url;
  }

  /* ---------- Nicer empty-state + table render ---------- */
  function renderWorkersTable(rows){
    const el = $('workerTable');
    el.innerHTML = '';
    if (!rows.length) {
      const empty = document.createElement('div');
      empty.style.padding = '12px';
      empty.style.background = '#f3f4f6';
      empty.style.border = '1px solid #e5e7eb';
      empty.style.borderRadius = '10px';
      empty.textContent = 'Hakuna wafanyakazi waliopatikana (bado).';
      el.appendChild(empty);
      return;
    }
    const tbl = document.createElement('table'); tbl.className='workers-table';
    tbl.innerHTML = `
      <thead><tr>
        <th>Jina Kamili</th><th>Jukumu</th><th>Simu</th><th>Mshahara (TZS)</th><th>Hali</th>
      </tr></thead><tbody></tbody>`;
    const tb = tbl.querySelector('tbody');
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.name}</td>
        <td>${r.role}</td>
        <td>${r.phone}</td>
        <td>${Number(r.baseSalary||0).toLocaleString('sw-TZ')}</td>
        <td>${r.active?'Active':'Inactive'}</td>`;
      tb.appendChild(tr);
    });
    el.appendChild(tbl);
  }

  async function loadWorkers(){
    try{
      const snap = await db.ref('workers').get();    // <- no orderByChild (works even if field missing)
      const rows=[];
      (snap && snap.forEach) && snap.forEach(ch=>{
        const v=ch.val()||{};
        rows.push({
          name: v.profile?.fullNameUpper||'',
          role: v.profile?.role||'',
          phone: v.profile?.phone||'',
          baseSalary: v.profile?.baseSalary||0,
          active: v.profile?.active!==false
        });
      });
      // Sort client-side by name to look nice
      rows.sort((a,b)=>a.name.localeCompare(b.name,'sw-TZ'));
      renderWorkersTable(rows);
    }catch(e){
      console.error('Load workers error:', e);
      renderWorkersTable([]);
    }
  }
  loadWorkers();

  /* ---------- Save handler (Cloudinary + RTDB) ---------- */
  document.getElementById('admissionForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.currentTarget);

    // Basics + validations
    const firstName = (fd.get('firstName')||'').trim();
    const middleName= (fd.get('middleName')||'').trim();
    const lastName  = (fd.get('lastName')||'').trim();
    const phone     = (fd.get('phone')||'').trim();
    const role      = (fd.get('role')||'').trim();

    let fullNameUpper;
    try { fullNameUpper = normalizeThreeNames(`${firstName} ${middleName} ${lastName}`); }
    catch(err){ return alert(err.message); }

    if (!isTZWorkerPhone(phone)) return alert('Simu lazima iwe kama +2550XXXXXXXXX');
    if (!role) return alert('Chagua jukumu (Role)');

    // Required photos
    const idPhoto = fd.get('idPhoto');
    const passportPhoto = fd.get('passportPhoto');
    if (!idPhoto?.size || !passportPhoto?.size) return alert('Weka Picha ya Kitambulisho na Picha ya Passport');

    // Role required docs
    for (const k of (ROLE_DOC_REQUIREMENTS[role]||[])){
      const f=fd.get(k);
      if (!f?.size) return alert(`Faili ya lazima: ${DOC_LABELS[k]||k}`);
    }

    try{
      // ONE workerId for everything
      const workerId = db.ref('workers').push().key;
      const baseHint = `w_${workerId}_${Date.now()}`;

      // Uploads to Cloudinary
      const idPhotoUrl       = await cldUpload(idPhoto,       `${baseHint}_id`);
      const passportPhotoUrl = await cldUpload(passportPhoto, `${baseHint}_passport`);

      let medicalProofUrl = '';
      const medicalProof = fd.get('medicalProof');
      if (medicalProof?.size) medicalProofUrl = await cldUpload(medicalProof, `${baseHint}_medical`);

      const extra = {};
      for (const k of (ROLE_DOC_REQUIREMENTS[role]||[])){
        const f=fd.get(k);
        extra[ (k==='cv'?'cvPdf':k) + 'Url' ] = await cldUpload(f, `${baseHint}_${k}`);
      }

      const profile = {
        firstName, middleName, lastName, fullNameUpper,
        phone,
        country:(fd.get('country')||'TZ').trim(),
        nextOfKinName:(fd.get('nextOfKinName')||'').trim(),
        nextOfKinPhone:(fd.get('nextOfKinPhone')||'').trim(),
        nssfNumber:(fd.get('nssfNumber')||'').trim(),
        nidaOrPassport:(fd.get('nidaOrPassport')||'').trim(),
        fatherName:(fd.get('fatherName')||'').trim(),
        motherName:(fd.get('motherName')||'').trim(),
        maritalStatus:(fd.get('maritalStatus')||'').trim(),
        spouseName:(fd.get('spouseName')||'').trim(),
        spousePhone:(fd.get('spousePhone')||'').trim(),
        area:(fd.get('area')||'').trim(),
        tribe:(fd.get('tribe')||'').trim(),
        villageHome:(fd.get('villageHome')||'').trim(),
        role,
        baseSalary:Number(fd.get('baseSalary')||0),
        active:(fd.get('active')||'true')!=='false',
        medicalConditions:(fd.get('medicalConditions')||'').trim(),
        createdBy: '',  // no auth required
        admissionDate: Date.now()
      };

      const payload = {
        profile,
        docs: { idPhotoUrl, passportPhotoUrl, medicalProofUrl, ...extra },
        contract: {
          language: (['driver','cook','cleaner','guard'].includes(role)?'sw':'en'),
          templateKey: role,
          accepted:false, acceptedTs:0, contractPdfUrl:''
        }
      };

      const loginKey = await sha256Hex(`${fullNameUpper}|${phone}`);
      await db.ref(`workers/${workerId}`).set(payload);
      await db.ref(`workers_index_by_loginKey/${loginKey}`).set({ workerId });

      alert('Mfanyakazi amesajiliwa kikamilifu ✅');
      e.currentTarget.reset();
      renderRoleDocs();
      loadWorkers();
    }catch(err){
      console.error(err);
      alert('Imeshindikana kuhifadhi. Angalia Cloudinary preset / intaneti / RTDB path.');
    }
  });
</script>
</body>
</html>
