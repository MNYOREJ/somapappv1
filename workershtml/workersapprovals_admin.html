<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Approvals Center</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase/firebase-config.js"></script>
</head>
<body>
  <main>
    <header>
      <h1>Approvals | Uthibitisho</h1>
      <p class="workers-card__subtitle">
        Angalia ripoti zilizofanyiwa flag (jikoni, ulinzi, usafi, ghala, likizo). Thibitisha au kataa, weka kumbukumbu ya nidhamu.
      </p>
    </header>

    <section class="workers-card">
      <header class="workers-card__header">
        <h2>Queue ya Leo</h2>
      </header>
      <div class="workers-card__content">
        <ul id="approvalList"></ul>
      </div>
    </section>
  </main>

  <script type="module">
    import {
      ensureAnonymousAuth,
      toast,
      dbRefs,
      localTs
    } from '../modules/workers_helpers.js';
    import { applyPenalty } from '../modules/workers_penalties.js';

    const list = document.getElementById('approvalList');

    ensureAnonymousAuth()
      .then(checkAdmin)
      .then(loadQueue)
      .catch(err => {
        toast(err.message || 'Error', 'error');
        window.location.href = '../index.html';
      });

    async function checkAdmin(user) {
      const snap = await firebase.database().ref(`admins/${user.uid}`).once('value');
      if (!snap.exists() || snap.val() !== true) {
        toast('Huna ruhusa ya approvals.', 'error');
        window.location.href = '../index.html';
        throw new Error('Not admin');
      }
    }

    async function loadQueue() {
      const snap = await dbRefs.approvalsQueue().once('value');
      if (!snap.exists()) {
        list.innerHTML = '<li>Hakuna items zilizo pending.</li>';
        return;
      }
      const approvals = snap.val();
      list.innerHTML = '';
      Object.entries(approvals)
        .filter(([, value]) => value.status === 'pending')
        .forEach(([id, value]) => {
          const li = document.createElement('li');
          li.className = 'workers-fieldset';
          li.innerHTML = `
            <strong>${value.type}</strong>
            <p>Worker: ${value.workerId || 'N/A'}</p>
            <p>Maelezo: ${value.note || value.explanation || ''}</p>
          `;
          if (value.photoUrl) {
            const link = document.createElement('a');
            link.href = value.photoUrl;
            link.textContent = 'Ona Picha';
            link.target = '_blank';
            li.appendChild(link);
          }
          const accept = document.createElement('button');
          accept.className = 'workers-btn';
          accept.textContent = 'Thibitisha';
          accept.addEventListener('click', () => resolveApproval(id, value, 'approved'));
          const reject = document.createElement('button');
          reject.className = 'workers-btn danger';
          reject.textContent = 'Kataa';
          reject.addEventListener('click', () => resolveApproval(id, value, 'rejected'));
          li.appendChild(accept);
          li.appendChild(reject);
          list.appendChild(li);
        });

      if (!list.children.length) {
        list.innerHTML = '<li>Hakuna items zilizo pending.</li>';
      }
    }

    async function resolveApproval(id, value, status) {
      const note = prompt('Maelezo kwa rekodi?', value.note || '');
      await dbRefs.approvalsQueue().child(id).update({
        status,
        reviewNote: note || '',
        reviewedTs: localTs(),
        reviewerUid: firebase.auth().currentUser.uid
      });

      if (status === 'rejected' && value.workerId) {
        const confirmPenalty = confirm('Je, ungependa kuweka faini kwa mfanyakazi huyu?');
        if (confirmPenalty) {
          const baseSnapshot = await dbRefs.workerProfile(value.workerId).once('value');
          const base = baseSnapshot.val()?.baseSalary || 0;
          await applyPenalty({
            workerId: value.workerId,
            kind: 'manual',
            baseSalary: base,
            refPath: `/approvals/${id}`,
            rulePercent: 0.001,
            forceCharge: true,
            metadata: {
              reviewNote: note || '',
              approvalId: id
            }
          });
        }
      }
      toast(`Approval ${status}.`, status === 'approved' ? 'success' : 'warning');
      loadQueue();
    }
  </script>
</body>
</html>


