<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mkataba | Contract</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      console.log('✅ Firebase initialized');
    }
    
    // Global toast function for early errors
    window.showToast = (message, type = 'info') => {
      const container = document.getElementById('toastContainer') || document.body;
      const toastEl = document.createElement('div');
      toastEl.className = `toast ${type}`;
      toastEl.textContent = message;
      container.appendChild(toastEl);
      
      setTimeout(() => toastEl.classList.add('show'), 100);
      setTimeout(() => {
        toastEl.classList.remove('show');
        setTimeout(() => toastEl.remove(), 300);
      }, 3000);
    };
  </script>
  
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --secondary: #7c3aed;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray: #64748b;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--dark);
      line-height: 1.6;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }

    header h1 {
      margin: 0 0 8px 0;
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header p {
      margin: 0;
      color: var(--gray);
      font-size: 1.125rem;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .card-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .card-title {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
    }

    .card-subtitle {
      margin: 0;
      color: var(--gray);
      font-size: 0.875rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .stat-card.success {
      background: linear-gradient(135deg, var(--success), #059669);
    }

    .stat-card.warning {
      background: linear-gradient(135deg, var(--warning), #d97706);
    }

    .stat-card.info {
      background: linear-gradient(135deg, var(--info), #0891b2);
    }

    .stat-label {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
    }

    .salary-breakdown {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
    }

    .salary-breakdown h3 {
      margin: 0 0 16px 0;
      color: var(--success);
      font-size: 1.25rem;
      font-weight: 700;
    }

    .salary-table {
      width: 100%;
      border-collapse: collapse;
    }

    .salary-table td {
      padding: 12px;
      border: 1px solid #d1fae5;
    }

    .salary-table tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.5);
    }

    .salary-table .total-row {
      background: rgba(79, 70, 229, 0.15) !important;
      border: 2px solid var(--primary);
    }

    .salary-table .total-row td {
      font-weight: 700;
      font-size: 1.125rem;
      color: var(--primary);
      padding: 16px 12px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      margin: 8px 8px 8px 0;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
    }

    .btn-secondary {
      background: var(--gray);
      color: white;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-accepted {
      background: #dcfce7;
      color: #166534;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .signature-upload {
      margin: 24px 0;
      padding: 20px;
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(124, 58, 237, 0.05));
      border-radius: 12px;
      border: 2px dashed var(--border);
    }

    .signature-upload.has-signature {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05));
    }

    .signature-preview {
      margin-top: 16px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      display: inline-block;
    }

    .signature-preview img {
      max-width: 300px;
      max-height: 120px;
      border: 1px solid var(--border);
      padding: 8px;
      border-radius: 4px;
    }

    .contract-viewer {
      background: white;
      border-radius: 12px;
      padding: 32px;
      margin: 24px 0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      max-height: 600px;
      overflow-y: auto;
    }

    .language-selector {
      display: flex;
      gap: 12px;
      margin: 16px 0;
      padding: 16px;
      background: rgba(79, 70, 229, 0.05);
      border-radius: 12px;
    }

    .language-selector button {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      background: white;
      color: var(--dark);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .language-selector button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .language-selector button:hover:not(.active) {
      border-color: var(--primary);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      padding: 16px 24px;
      background: var(--dark);
      color: white;
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transform: translateX(120%);
      transition: all 0.3s ease;
      pointer-events: auto;
      max-width: 400px;
      word-wrap: break-word;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.info {
      background: var(--info);
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      overflow: hidden;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: -9999px;
    }

    @media (max-width: 768px) {
      main {
        padding: 16px;
      }
      
      header h1 {
        font-size: 2rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>📄 Mkataba | Contract</h1>
      <p class="card-subtitle">
        Soma vizuri. Ukikubali, PDF itawekwa na kuonekana kwenye akaunti yako.<br>
        Read carefully. Once accepted, PDF will be saved and available in your account.
      </p>
    </header>

    <!-- Worker Details -->
    <div class="glass-card">
      <div class="card-header">
        <h2 class="card-title">Taarifa ya Mfanyakazi | Worker Details</h2>
        <p class="card-subtitle" id="statusLabel"></p>
      </div>
      
      <div class="stats-grid" id="workerStats">
        <div class="stat-card info">
          <div class="stat-label">Jina Kamili | Full Name</div>
          <div class="stat-value" id="statName">—</div>
        </div>
        <div class="stat-card info">
          <div class="stat-label">Jukumu | Role</div>
          <div class="stat-value" id="statRole">—</div>
        </div>
        <div class="stat-card info">
          <div class="stat-label">Simu | Phone</div>
          <div class="stat-value" id="statPhone">—</div>
        </div>
      </div>
    </div>

    <!-- Salary Breakdown -->
    <div class="glass-card">
      <div class="card-header">
        <h2 class="card-title">💰 Muhtasari wa Mshahara | Salary Breakdown</h2>
        <p class="card-subtitle">Breakdown of salary, NSSF contributions, and net salary</p>
      </div>
      
      <div class="salary-breakdown">
        <h3>📊 Salary Structure</h3>
        <table class="salary-table">
          <tbody id="salaryBreakdownTable">
            <tr><td colspan="2" style="text-align: center; padding: 20px; color: var(--gray);">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Language Selector & Contract Viewer -->
    <div class="glass-card">
      <div class="card-header">
        <h2 class="card-title">📋 Mkataba | Employment Contract</h2>
        <p class="card-subtitle">Choose language and review your contract</p>
      </div>

      <div class="language-selector">
        <button id="langEn" class="active">🇬🇧 English</button>
        <button id="langSw">🇹🇿 Kiswahili</button>
      </div>

      <div class="contract-viewer" id="contractViewer">
        <p style="text-align: center; color: var(--gray);">Loading contract...</p>
      </div>
    </div>

    <!-- Signature Upload (Only if not accepted) -->
    <div class="glass-card" id="signatureSection" style="display: none;">
      <div class="card-header">
        <h2 class="card-title">✍️ Sahihi | Signature</h2>
        <p class="card-subtitle">Upload your handwritten signature to digitally sign this contract</p>
      </div>

      <div class="signature-upload" id="signatureUploadArea">
        <div class="file-input-wrapper">
          <button class="btn btn-primary" onclick="document.getElementById('signatureInput').click()">
            📁 Chagua Picha ya Sahihi | Choose Signature Image
          </button>
          <input type="file" id="signatureInput" accept="image/*">
        </div>
        <p style="margin: 8px 0 0; color: var(--gray); font-size: 0.875rem;">
          Accepted formats: JPG, PNG (Max 2MB)
        </p>
      </div>

      <div class="signature-preview" id="signaturePreview" style="display: none;"></div>
    </div>

    <!-- Actions -->
    <div class="glass-card">
      <div class="card-header">
        <h2 class="card-title">⚡ Hatua | Actions</h2>
      </div>

      <div id="actions">
        <p style="text-align: center; color: var(--gray);">Loading...</p>
      </div>
    </div>
  </main>

  <!-- Toast Notification Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script type="module">
    console.log('🚀 Contract page module loading...');
    
    // CRITICAL: Prevent index.html auth listeners from clearing localStorage
    sessionStorage.setItem('workerDashboardActive', 'true');
    
    import {
      defaultContractLanguage, 
      templateKeyForRole, 
      generateContractPdf,
      calculateSalaryBreakdown,
      buildContractHtml
    } from './modules/workers_contracts.js';

    console.log('✅ Modules imported successfully');

    const db = firebase.database();
    let workerId = null;
    let workerProfile = null;
    let contract = null;
    let selectedLanguage = 'en';
    let signatureFile = null;

    // Start loading immediately - no auth check needed since index.html already handled it
    init();

    async function init() {
      try {
        console.log('🔍 Getting worker ID from localStorage...');
        console.log('📦 localStorage contents:', {
          workerId: localStorage.getItem('workerId'),
          role: localStorage.getItem('role'),
          fullNameUpper: localStorage.getItem('fullNameUpper')
        });
        
        // Get workerId directly from localStorage (same as workersdashboard.html)
        workerId = localStorage.getItem('workerId');
        console.log('Worker ID:', workerId);
        
      if (!workerId) {
          console.error('❌ No workerId in localStorage');
          showToast('Ingia tena. | Please sign in again.', 'error');
          setTimeout(() => window.location.href = '../index.html', 3000);
        return;
      }

        console.log('📡 Fetching worker profile from /workers/' + workerId);
        const snap = await db.ref(`workers/${workerId}`).once('value');
        
      if (!snap.exists()) {
          console.error('❌ Worker profile not found for ID:', workerId);
          showToast('Profile haipo. | Profile not found.', 'error');
        return;
      }
        
      const data = snap.val();
        console.log('✅ Worker data loaded:', data);
        
      workerProfile = data.profile;
      contract = data.contract || {};
        
        console.log('Profile:', workerProfile);
        console.log('Contract:', contract);
        
        selectedLanguage = contract.language || defaultContractLanguage(workerProfile.role);
        console.log('Selected language:', selectedLanguage);
        
      render();
        setupEventListeners();
        
        console.log('✅ Page rendered successfully');
      } catch (err) {
        console.error('❌ Error in init():', err);
        showToast('Kosa limejitokeza | An error occurred: ' + err.message, 'error');
      }
    }

    function render() {
      renderWorkerDetails();
      renderSalaryBreakdown();
      renderContract();
      renderActions();
    }

    function renderWorkerDetails() {
      const fullName = workerProfile.fullNameUpper || `${workerProfile.firstName} ${workerProfile.lastName}`.toUpperCase();
      const role = workerProfile.role || '—';
      const phone = workerProfile.phone || '—';

      document.getElementById('statName').textContent = fullName;
      document.getElementById('statRole').textContent = role;
      document.getElementById('statPhone').textContent = phone;

      // Status
      const statusLabel = document.getElementById('statusLabel');
      if (contract.accepted) {
        statusLabel.innerHTML = `<span class="status-badge status-accepted">✅ Ulikubali | Accepted on ${new Date(contract.acceptedTs).toLocaleString('sw-TZ')}</span>`;
      } else {
        statusLabel.innerHTML = `<span class="status-badge status-pending">⏳ Bado haujakubali | Not yet accepted</span>`;
      }
    }

    function renderSalaryBreakdown() {
      const breakdown = calculateSalaryBreakdown(workerProfile.baseSalary || 0);
      const table = document.getElementById('salaryBreakdownTable');
      
      table.innerHTML = `
        <tr>
          <td><strong>Mshahara wa Msingi (Jumla) | Base Salary (Total)</strong></td>
          <td style="text-align: right; font-weight: 700; color: var(--success);">TZS ${Number(breakdown.baseSalary).toLocaleString('en-US')}</td>
        </tr>
        <tr>
          <td style="padding-left: 24px;">→ Mshahara (Kazi) | Salary (Role)</td>
          <td style="text-align: right;">TZS ${Number(breakdown.salary).toLocaleString('en-US')}</td>
        </tr>
        <tr>
          <td style="padding-left: 24px;">→ Nyingine (Wajibu) | Other (Responsibilities)</td>
          <td style="text-align: right;">TZS ${Number(breakdown.other).toLocaleString('en-US')}</td>
        </tr>
        <tr style="background: rgba(239, 68, 68, 0.1);">
          <td colspan="2" style="font-weight: 600; color: var(--danger);"><strong>NSSF Deductions (from Salary only)</strong></td>
        </tr>
        <tr>
          <td style="padding-left: 24px;">→ Michango ya Mfanyakazi (10%) | Employee Contribution</td>
          <td style="text-align: right; color: var(--danger);">- TZS ${Number(breakdown.nssfEmployee).toLocaleString('en-US')}</td>
        </tr>
        <tr>
          <td style="padding-left: 24px;">→ Michango ya Mwajiri (10%) | Employer Contribution</td>
          <td style="text-align: right; color: var(--success);">+ TZS ${Number(breakdown.nssfEmployer).toLocaleString('en-US')}</td>
        </tr>
        <tr>
          <td style="padding-left: 24px;">→ Jumla ya NSSF | Total NSSF Monthly</td>
          <td style="text-align: right; font-weight: 600;">TZS ${Number(breakdown.nssfTotal).toLocaleString('en-US')}</td>
        </tr>
        <tr class="total-row">
          <td><strong>MSHAHARA SAFI (Baada ya NSSF) | NET SALARY (After NSSF)</strong></td>
          <td style="text-align: right;">TZS ${Number(breakdown.netSalary).toLocaleString('en-US')}</td>
        </tr>
      `;
    }

    function renderContract() {
      const html = buildContractHtml(workerProfile, { 
        language: selectedLanguage, 
        signatureUrl: contract.signatureUrl || '' 
      });
      document.getElementById('contractViewer').innerHTML = html;
    }

    function renderActions() {
      const actions = document.getElementById('actions');
      const signatureSection = document.getElementById('signatureSection');

      if (contract.accepted) {
        // Already accepted - show download button
        signatureSection.style.display = 'none';
        actions.innerHTML = `
          <a href="${contract.contractPdfUrl}" target="_blank" class="btn btn-success">
            📥 Pakua PDF | Download Contract PDF
          </a>
          <a href="workersdashboard.html" class="btn btn-secondary">
            🏠 Rudi Nyumbani | Back to Dashboard
          </a>
        `;
      } else {
        // Not accepted - show signature upload and accept button
        signatureSection.style.display = 'block';
        actions.innerHTML = `
          <button class="btn btn-primary" id="acceptBtn" disabled>
            ✅ Nakubali / I Agree & Sign Contract
          </button>
          <a href="workersdashboard.html" class="btn btn-secondary">
            ← Rudi | Go Back
          </a>
          <p style="margin: 16px 0 0; color: var(--gray); font-size: 0.875rem;">
            ⚠️ Lazima upakue picha ya sahihi kwanza | You must upload your signature first
          </p>
        `;
      }
    }

    function setupEventListeners() {
      // Language selector
      document.getElementById('langEn').addEventListener('click', () => {
        selectedLanguage = 'en';
        document.getElementById('langEn').classList.add('active');
        document.getElementById('langSw').classList.remove('active');
        renderContract();
      });

      document.getElementById('langSw').addEventListener('click', () => {
        selectedLanguage = 'sw';
        document.getElementById('langSw').classList.add('active');
        document.getElementById('langEn').classList.remove('active');
        renderContract();
      });

      // Signature upload
      const signatureInput = document.getElementById('signatureInput');
      if (signatureInput) {
        signatureInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            if (file.size > 2 * 1024 * 1024) {
              toast('Picha kubwa sana! Lazima chini ya 2MB | File too large! Must be under 2MB', 'error');
              return;
            }
            signatureFile = file;
            previewSignature(file);
            
            // Enable accept button
            const acceptBtn = document.getElementById('acceptBtn');
            if (acceptBtn) {
              acceptBtn.disabled = false;
              acceptBtn.onclick = acceptContract;
            }
          }
        });
      }

      // Set initial language button
      if (selectedLanguage === 'sw') {
        document.getElementById('langSw').classList.add('active');
        document.getElementById('langEn').classList.remove('active');
      }
    }

    function previewSignature(file) {
      const preview = document.getElementById('signaturePreview');
      const uploadArea = document.getElementById('signatureUploadArea');
      
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.innerHTML = `
          <p style="margin: 0 0 8px; font-weight: 600; color: var(--success);">✅ Sahihi imechaguliwa | Signature selected:</p>
          <img src="${e.target.result}" alt="Signature" style="max-width: 300px; max-height: 120px; border: 1px solid var(--border); padding: 8px; border-radius: 4px;">
        `;
        preview.style.display = 'block';
        uploadArea.classList.add('has-signature');
      };
      reader.readAsDataURL(file);
    }

    async function acceptContract() {
      if (!signatureFile) {
        showToast('Chagua picha ya sahihi kwanza! | Please select signature image first!', 'error');
        return;
      }

      const btn = document.getElementById('acceptBtn');
      btn.disabled = true;
      
      try {
        // Step 1: Upload signature
        btn.innerHTML = '<span class="loading-spinner"></span> 1/3: Inapakia sahihi... | Uploading signature...';
        showToast('📤 Step 1/3: Uploading signature...', 'info');
        
        const url = await generateContractPdf(workerId, workerProfile, {
          language: selectedLanguage,
          templateKey: templateKeyForRole(workerProfile.role),
          signatureFile: signatureFile,
          onProgress: (step, message) => {
            btn.innerHTML = `<span class="loading-spinner"></span> ${step}: ${message}`;
            showToast(message, 'info');
          }
        });

        // Final step: Update database
        btn.innerHTML = '<span class="loading-spinner"></span> Inahifadhi... | Saving...';
        await db.ref(`workers/${workerId}/contract`).update({
          accepted: true,
          acceptedTs: Date.now(),
          contractPdfUrl: url,
          language: selectedLanguage
        });

        contract = {
          ...contract,
          accepted: true,
          acceptedTs: Date.now(),
          contractPdfUrl: url,
          language: selectedLanguage
        };

        showToast('✅ Hongera! Mkataba umehifadhiwa. | Contract saved successfully!', 'success');
        
        setTimeout(() => {
        render();
        }, 1000);

      } catch (err) {
        console.error('❌ Contract generation error:', err);
        showToast(err.message || 'Imeshindikana | Failed to generate contract', 'error');
        btn.disabled = false;
        btn.innerHTML = '✅ Nakubali / I Agree & Sign Contract';
      }
    }
  </script>
</body>
</html>
