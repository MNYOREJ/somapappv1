<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mpishi | Kitchen Hub</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase/firebase-config.js"></script>
</head>
<body>
  <main>
    <header>
      <h1>Jikoni - Kitchen Control</h1>
      <p class="workers-card__subtitle">
        Kila siku rekodi idadi ya wanafunzi, menyu, matumizi ya chakula, na hesabu ya vifaa. Ukikosa kujaza hadi saa 18:00 utapata onyo nyekundu na makato.
      </p>
    </header>

    <section class="workers-card">
      <header class="workers-card__header">
        <h2>Takwimu za Leo</h2>
        <p class="workers-card__subtitle">Wanafunzi, wavulana/wasichana kwa darasa, waliopo, waliokosa, wapya, wafanyakazi.</p>
      </header>
      <div class="workers-card__content">
        <div id="statsTable"></div>
      </div>
    </section>

    <section class="workers-card" style="margin-top:24px;">
      <header class="workers-card__header">
        <h2>Ripoti ya Chakula ya Leo</h2>
        <p id="reportStatus" class="workers-card__subtitle"></p>
      </header>
      <div class="workers-card__content workers-form">
        <label>Waliohudhuria Breakfast (07:20-10:20)
          <input type="number" id="breakfastPax" min="0">
        </label>
        <label>Waliohudhuria Lunch (12:30-14:00)
          <input type="number" id="lunchPax" min="0">
        </label>
        <label>Menyu (Breakfast)
          <textarea id="menuBreakfast" placeholder="Uji, mandazi..."></textarea>
        </label>
        <label>Menyu (Lunch)
          <textarea id="menuLunch" placeholder="Wali, Maharage..."></textarea>
        </label>

        <fieldset class="workers-fieldset">
          <legend>Matumizi ya Mahitaji (kg / l)</legend>
          <div class="workers-grid">
            <div>
              <label>Sugar Issued (kg)
                <input type="number" step="0.01" id="issuedSugar">
              </label>
              <label>Sugar Used (kg)
                <input type="number" step="0.01" id="usedSugar">
              </label>
            </div>
            <div>
              <label>Oil Issued (l)
                <input type="number" step="0.01" id="issuedOil">
              </label>
              <label>Oil Used (l)
                <input type="number" step="0.01" id="usedOil">
              </label>
            </div>
          </div>
          <p id="expectedUsage" class="workers-card__subtitle"></p>
        </fieldset>

        <fieldset class="workers-fieldset">
          <legend>Vifaa vya Jikoni (ingia idadi halisi leo)</legend>
          <div class="workers-card__content">
            <table class="workers-table" id="utensilTable">
              <thead>
                <tr>
                  <th>Kifaa</th>
                  <th>Kipo (leo)</th>
                  <th>Kimeharibika</th>
                  <th>Kimepotea</th>
                  <th>Mahali Kinahifadhiwa</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </fieldset>

        <label>Malalamiko / Grievances
          <textarea id="grievance" placeholder="Eleza changamoto za leo jikoni..."></textarea>
        </label>

        <div class="workers-card__actions">
          <button id="saveReport" class="workers-btn">Hifadhi Ripoti</button>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import {
      ensureAnonymousAuth,
      getLinkedWorkerId,
      dbRefs,
      todayYMD,
      localTs,
      toast
    } from '../modules/workers_helpers.js';
    import {
      computeCookProjection,
      saveCookDailyReport,
      flagInventoryMismatch,
      loadPolicies
    } from '../modules/workers_inventory.js';
    import { applyPenalty } from '../modules/workers_penalties.js';

    const statsTableContainer = document.getElementById('statsTable');
    const reportStatus = document.getElementById('reportStatus');
    const breakfastInput = document.getElementById('breakfastPax');
    const lunchInput = document.getElementById('lunchPax');
    const menuBreakfast = document.getElementById('menuBreakfast');
    const menuLunch = document.getElementById('menuLunch');
    const issuedSugar = document.getElementById('issuedSugar');
    const usedSugar = document.getElementById('usedSugar');
    const issuedOil = document.getElementById('issuedOil');
    const usedOil = document.getElementById('usedOil');
    const expectedUsageLabel = document.getElementById('expectedUsage');
    const utensilTableBody = document.querySelector('#utensilTable tbody');
    const grievanceEl = document.getElementById('grievance');
    const saveBtn = document.getElementById('saveReport');

    const utensilList = [
      { key: 'plates', label: 'Plates / Sahani' },
      { key: 'cups', label: 'Vikombe / Cups' },
      { key: 'saucepan', label: 'Sufuria / Saucepan' },
      { key: 'buckets', label: 'Ndoo / Buckets' },
      { key: 'spoons', label: 'Vijiko / Spoons' },
      { key: 'thermos', label: 'Thermos' },
      { key: 'rolling', label: 'Mti wa kupikia / Rolling Spoon' },
      { key: 'knives', label: 'Visu / Knives' },
      { key: 'others', label: 'Vifaa vingine (andika)' }
    ];

    let workerId = null;
    let workerProfile = null;
    let todayKey = todayYMD();
    let policies = null;
    let existingReport = null;
    let yesterdayUtensils = {};

    ensureAnonymousAuth()
      .then(init)
      .catch(err => {
        toast(err.message || 'Error', 'error');
        window.location.href = '../index.html';
      });

    async function init() {
      workerId = await getLinkedWorkerId();
      if (!workerId) {
        toast('Ingia tena.', 'error');
        window.location.href = '../index.html';
        return;
      }
      const workerSnap = await dbRefs.worker(workerId).once('value');
      workerProfile = workerSnap.val().profile;
      if (workerProfile.role !== 'cook') {
        const adminSnap = await firebase.database().ref(`admins/${firebase.auth().currentUser.uid}`).once('value');
        if (!adminSnap.exists()) {
          toast('Ukurasa huu ni kwa wapishi tu.', 'error');
          window.location.href = '../index.html';
          return;
        }
      }
      policies = await loadPolicies();
      renderUtensilInputs();
      await Promise.all([renderStats(), loadExistingReport(), loadYesterdayUtensils()]);
      setupAutoPenaltyCheck();
      breakfastInput.addEventListener('input', updateExpectedUsage);
      lunchInput.addEventListener('input', updateExpectedUsage);
      saveBtn.addEventListener('click', saveReport);
      updateExpectedUsage();
    }

    function renderUtensilInputs() {
      utensilTableBody.innerHTML = '';
      utensilList.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.label}</td>
          <td><input type="number" min="0" data-key="${item.key}" data-field="available"></td>
          <td><input type="number" min="0" data-key="${item.key}" data-field="destroyed"></td>
          <td><input type="number" min="0" data-key="${item.key}" data-field="lost"></td>
          <td><input type="text" data-key="${item.key}" data-field="location" placeholder="Mahali vinahifadhiwa"></td>
        `;
        utensilTableBody.appendChild(tr);
      });
    }

    async function renderStats() {
      const [studentsSnap, attendanceSnap, workersSnap] = await Promise.all([
        firebase.database().ref('students').once('value'),
        firebase.database().ref(`attendance_students/${todayKey}`).once('value').catch(() => null),
        firebase.database().ref('workers').once('value')
      ]);
      const students = studentsSnap.val() || {};
      const attendance = attendanceSnap?.val() || {};
      const workers = workersSnap.val() || {};

      const classes = {};
      const newCutoff = Date.now() - (7 * 24 * 60 * 60 * 1000);
      Object.values(students).forEach(child => {
        const className = child.class || 'Unknown';
        classes[className] = classes[className] || { registered: { total: 0, boys: 0, girls: 0 }, present: { total: 0, boys: 0, girls: 0 }, newcomers: 0 };
        classes[className].registered.total += 1;
        if (child.gender === 'M') classes[className].registered.boys += 1;
        if (child.gender === 'F') classes[className].registered.girls += 1;
        if (child.createdTs && child.createdTs >= newCutoff) {
          classes[className].newcomers += 1;
        }
        const presentRecord = attendance[className]?.[child.id] || attendance[child.id];
        if (presentRecord?.present === true) {
          classes[className].present.total += 1;
          if (child.gender === 'M') classes[className].present.boys += 1;
          if (child.gender === 'F') classes[className].present.girls += 1;
        }
      });

      let totalWorkers = 0;
      Object.values(workers).forEach(profileNode => {
        if (profileNode.profile?.active !== false) totalWorkers += 1;
      });

      const table = document.createElement('table');
      table.className = 'workers-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th>Darasa</th>
            <th>Waliosajiliwa (B/G/T)</th>
            <th>Waliohudhuria (B/G/T)</th>
            <th>Waliokosa</th>
            <th>Wapya (7d)</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');
      Object.entries(classes).forEach(([className, data]) => {
        const absent = data.registered.total - data.present.total;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${className}</td>
          <td>${data.registered.boys}/${data.registered.girls}/${data.registered.total}</td>
          <td>${data.present.boys}/${data.present.girls}/${data.present.total}</td>
          <td>${absent}</td>
          <td>${data.newcomers}</td>
        `;
        tbody.appendChild(tr);
      });

      const summary = document.createElement('p');
      const totals = Object.values(classes).reduce((acc, c) => {
        acc.registered += c.registered.total;
        acc.present += c.present.total;
        acc.absent += (c.registered.total - c.present.total);
        acc.newcomers += c.newcomers;
        return acc;
      }, { registered: 0, present: 0, absent: 0, newcomers: 0 });
      summary.textContent = `Jumla: Wanafunzi ${totals.registered}, Waliopo ${totals.present}, Waliokosa ${totals.absent}, Wapya ${totals.newcomers}, Wafanyakazi ${totalWorkers}`;

      statsTableContainer.innerHTML = '';
      statsTableContainer.appendChild(summary);
      statsTableContainer.appendChild(table);
    }

    async function loadExistingReport() {
      const snap = await dbRefs.rolesCookDaily(todayKey).child(workerId).once('value');
      if (!snap.exists()) {
        reportStatus.textContent = 'Bado hujatoa ripoti leo.';
        return;
      }
      existingReport = snap.val();
      reportStatus.textContent = `Ripoti imehifadhiwa ${new Date(existingReport.updatedTs).toLocaleTimeString('sw-TZ')}`;
      breakfastInput.value = existingReport.headcount?.breakfast || '';
      lunchInput.value = existingReport.headcount?.lunch || '';
      menuBreakfast.value = (existingReport.menu?.breakfast || []).join(', ');
      menuLunch.value = (existingReport.menu?.lunch || []).join(', ');
      issuedSugar.value = existingReport.issued?.sugar_kg || '';
      usedSugar.value = existingReport.used?.sugar_kg || '';
      issuedOil.value = existingReport.issued?.oil_l || '';
      usedOil.value = existingReport.used?.oil_l || '';
      grievanceEl.value = existingReport.grievance || '';
      fillUtensils(existingReport.utensils || {});
      updateExpectedUsage();
    }

    async function loadYesterdayUtensils() {
      const previousDate = new Date(todayKey);
      previousDate.setDate(previousDate.getDate() - 1);
      const yKey = previousDate.toISOString().slice(0, 10);
      const snap = await dbRefs.rolesCookDaily(yKey).child(workerId).child('utensils').once('value');
      yesterdayUtensils = snap.val() || {};
    }

    function fillUtensils(data) {
      utensilTableBody.querySelectorAll('input').forEach(input => {
        const key = input.dataset.key;
        const field = input.dataset.field;
        input.value = data?.[key]?.[field] ?? '';
      });
    }

    function collectUtensils() {
      const result = {};
      utensilTableBody.querySelectorAll('input').forEach(input => {
        const key = input.dataset.key;
        const field = input.dataset.field;
        result[key] = result[key] || {};
        if (input.type === 'number') {
          result[key][field] = Number(input.value || 0);
        } else {
          result[key][field] = input.value.trim();
        }
      });
      return result;
    }

    function updateExpectedUsage() {
      const breakfast = Number(breakfastInput.value || 0);
      const lunch = Number(lunchInput.value || 0);
      computeCookProjection({ breakfastPax: breakfast, lunchPax: lunch })
        .then(expected => {
          expectedUsageLabel.textContent = `Inatarajiwa: Sukari ${expected.sugar_kg} kg - Mafuta ${expected.oil_l} l`;
        });
    }

    async function saveReport() {
      const breakfast = Number(breakfastInput.value || 0);
      const lunch = Number(lunchInput.value || 0);
      if (!breakfast && !lunch) {
        toast('Weka walioshiriki angalau mlo mmoja.', 'warning');
        return;
      }
      const expected = await computeCookProjection({ breakfastPax: breakfast, lunchPax: lunch });
      const issued = {
        sugar_kg: Number(issuedSugar.value || 0),
        oil_l: Number(issuedOil.value || 0)
      };
      const used = {
        sugar_kg: Number(usedSugar.value || 0),
        oil_l: Number(usedOil.value || 0)
      };
      const headcount = {
        breakfast,
        lunch
      };
      const menu = {
        breakfast: menuBreakfast.value.split(',').map(x => x.trim()).filter(Boolean),
        lunch: menuLunch.value.split(',').map(x => x.trim()).filter(Boolean)
      };
      const utensils = collectUtensils();
      const variance = {
        sugar: used.sugar_kg - expected.sugar_kg,
        oil: used.oil_l - expected.oil_l
      };
      const varianceFlag = Math.abs(variance.sugar) > 0.5 || Math.abs(variance.oil) > 0.5;
      const status = varianceFlag ? 'flagged' : 'pending';

      const utensilChanges = detectUtensilChanges(utensils);
      if (utensilChanges.changed && !utensilChanges.explanationProvided) {
        toast('Weka maelezo mahali kinahifadhiwa kwa vifaa vilivyobadilika.', 'warning');
        return;
      }

      await saveCookDailyReport({
        dateKey: todayKey,
        workerId,
        headcount,
        menu,
        expected,
        issued,
        used,
        photos: [],
        status,
        utensils,
        grievance: grievanceEl.value.trim(),
        penaltyLogged: existingReport?.penaltyLogged || false
      });

      if (Math.abs(variance.sugar) > 0.5) {
        await flagInventoryMismatch({
          dateKey: todayKey,
          item: 'sugar_kg',
          previousCount: expected.sugar_kg,
          newCount: used.sugar_kg,
          explanation: 'Matumizi ya sukari hayalingani na matarajio.',
          workerId
        });
      }
      if (Math.abs(variance.oil) > 0.5) {
        await flagInventoryMismatch({
          dateKey: todayKey,
          item: 'oil_l',
          previousCount: expected.oil_l,
          newCount: used.oil_l,
          explanation: 'Matumizi ya mafuta hayalingani na matarajio.',
          workerId
        });
      }

      reportStatus.textContent = `Ripoti imehifadhiwa ${new Date().toLocaleTimeString('sw-TZ')}`;
      toast('Ripoti ya jikoni imehifadhiwa.', 'success');
    }

    function detectUtensilChanges(current) {
      let changed = false;
      let explanationProvided = true;
      utensilList.forEach(item => {
        const prev = yesterdayUtensils[item.key] || {};
        const curr = current[item.key] || {};
        if ((prev.available || 0) !== (curr.available || 0)) {
          changed = true;
          if (!curr.location) explanationProvided = false;
        }
      });
      return { changed, explanationProvided };
    }

    async function setupAutoPenaltyCheck() {
      const now = new Date();
      const hour = now.getHours();
      if (existingReport?.penaltyLogged || hour < 18) {
        return;
      }
      await applyPenalty({
        workerId,
        kind: 'todo',
        baseSalary: workerProfile.baseSalary,
        refPath: `/roles/cook/daily/${todayKey}/${workerId}`,
        rulePercent: policies.penalties?.taskMiss?.percent || 0.001
      });
      await dbRefs.rolesCookDaily(todayKey).child(workerId).update({ penaltyLogged: true });
      toast('Onyo: Hukujaza ripoti kwa wakati. Faini imewekwa.', 'warning');
    }
  </script>
</body>
</html>


