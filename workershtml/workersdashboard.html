<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp Workers Hub</title>

  <!-- Your shared CSS -->
  <link rel="stylesheet" href="../css/workers.css">

  <!-- Firebase (compat v9.6.10) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase/firebase-config.js"></script>

  <style>
    /* ====== DARK GLASS UI (adds on top of workers.css) ====== */
    :root{
      --bg:#0b1020; --ink:#e5e7eb; --muted:#a0a7ba;
      --glass:rgba(255,255,255,.06); --border:rgba(255,255,255,.16);
      --accent:#7c8aff; --accent2:#35d1e2;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1f276a 0%, transparent 60%),
        radial-gradient(1000px 700px at 100% 0%, #0a6aa6 0%, transparent 55%),
        linear-gradient(180deg, #0b1020 0%, #0b1020 100%);
      overflow-y:auto;
    }
    main{max-width:1200px;margin:0 auto;padding:18px}
    .appbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;border-radius:16px;
      background:var(--glass); backdrop-filter: blur(16px);
      border:1px solid var(--border);
      box-shadow:0 10px 50px rgba(0,0,0,.35);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{
      width:44px;height:44px;border-radius:12px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      display:grid;place-items:center;font-weight:900;color:#0b1020;
    }
    .brand h1{margin:0;font-size:1.1rem;letter-spacing:.3px}
    .brand .sub{margin-top:3px;font-size:.88rem;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border); background:var(--glass);
      color:var(--ink); border-radius:12px; padding:10px 14px; cursor:pointer;
      backdrop-filter: blur(10px);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .btn:hover{transform:translateY(-1px); border-color:#7c8affaa}
    .btn.primary{background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#0b1020; border:0}
    .glass{
      background:var(--glass); border:1px solid var(--border); backdrop-filter: blur(16px);
      border-radius:16px; padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.35);
    }
    .hero{display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:center}
    .avatar{
      width:56px;height:56px;border-radius:14px;overflow:hidden;border:1px solid var(--border);
      background:radial-gradient(circle at 30% 20%, #233062, #11152a);
      display:grid;place-items:center;font-weight:800;
    }
    .hello{font-size:.92rem;color:var(--muted)}
    .name{font-size:1.24rem;font-weight:800;letter-spacing:.3px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;font-size:.82rem;
      background:rgba(255,255,255,.08); border:1px solid var(--border);
      padding:6px 10px; border-radius:999px; color:var(--ink)
    }
    .chip.ok{border-color:#22c55e55}
    .chip.bad{border-color:#ef444455}
    .chip.warn{border-color:#f59e0b55}

    .grid{display:grid;gap:14px;margin-top:16px}
    @media(min-width:760px){ .grid.kpi{grid-template-columns:repeat(3,1fr)} .grid.links{grid-template-columns:repeat(3,1fr)} }
    @media(min-width:1060px){ .grid.kpi{grid-template-columns:repeat(6,1fr)} .grid.links{grid-template-columns:repeat(4,1fr)} }

    .kpi{display:flex;flex-direction:column;gap:8px;min-height:120px;transition: transform .12s ease, box-shadow .12s ease;}
    .kpi:hover{transform:translateY(-2px); box-shadow:0 18px 60px rgba(0,0,0,.45)}
    .kpi h3{margin:0;font-size:.92rem;color:var(--muted);font-weight:600}
    .kpi .val{font-size:2rem;font-weight:900;letter-spacing:.4px}
    .kpi.ok .val{color:var(--ok)} .kpi.warn .val{color:var(--warn)} .kpi.bad .val{color:var(--bad)}

    .section-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:18px}
    .links .tile{
      display:flex;flex-direction:column;min-height:140px;gap:8px;position:relative;overflow:hidden;
      background: radial-gradient(500px 200px at -20% -30%, rgba(124,138,255,.25), transparent 70%), var(--glass);
      border:1px solid var(--border); backdrop-filter: blur(16px);
      border-radius:16px; padding:14px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .15s ease;
    }
    .links .tile:hover{transform:translateY(-2px); box-shadow:0 18px 60px rgba(0,0,0,.45); border-color:#7c8affaa}
    .links h4{margin:0;font-size:1.02rem}
    .links p{margin:0;color:var(--muted);font-size:.9rem}
    .links a{margin-top:auto;align-self:flex-start}
    #toast{position:fixed;right:14px;bottom:14px;display:none;z-index:9999}
    #toast.show{display:block;animation:fadein .18s ease-out}
    #toast .t{background:rgba(3,7,18,.96);color:#fff;padding:10px 12px;border-radius:10px;margin-top:8px;box-shadow:0 16px 50px rgba(2,6,23,.45);font-size:.92rem}
    @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <main>
    <!-- APP BAR -->
    <div class="appbar">
      <div class="brand">
        <div class="logo">So</div>
        <div>
          <h1>SoMAp · Workers Hub</h1>
          <div class="sub" id="schoolClock">Africa/Nairobi</div>
        </div>
      </div>
      <div class="actions">
        <button id="refreshDashboard" class="btn">Refresh | Onyesha upya</button>
        <button id="signOut" class="btn">Sign Out</button>
      </div>
    </div>

    <!-- HERO -->
    <section class="glass" style="margin-top:16px">
      <div class="hero">
        <div class="avatar" id="userAvatar">👤</div>
        <div>
          <div class="hello">Karibu | Welcome</div>
          <div class="name" id="workerGreeting">—</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <span id="roleChip" class="chip">Role: —</span>
            <span id="todayChip" class="chip ok">Leo: —</span>
          </div>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid kpi" id="kpiGrid"></section>

    <!-- LINKS -->
    <section class="section-head">
      <h2 style="margin:0">Quick Links · Njia za Haraka</h2>
      <div class="chip">Tap to open · Bofya kufungua</div>
    </section>
    <section class="grid links" id="quickLinks"></section>
  </main>

  <div id="toast"></div>

  <script type="module">
    import {
      ensureAnonymousAuth,
      getLinkedWorkerId,
      dbRefs,
      todayYMD,
      yyyymm,
      toast
    } from '../modules/workers_helpers.js';
    import { createCard } from '../modules/workers_ui.js';

    // ===== Small helpers for local clock =====
    function tzParts(){
      const d = new Date();
      const optD = { timeZone:'Africa/Nairobi', year:'numeric', month:'2-digit', day:'2-digit' };
      const optT = { timeZone:'Africa/Nairobi', hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' };
      const [day,mon,yr] = new Intl.DateTimeFormat('en-GB', optD).format(d).split('/');
      const tim = new Intl.DateTimeFormat('en-GB', optT).format(d);
      return { yr, mon, day, tim };
    }
    function after0720(){ return tzParts().tim.slice(0,5) >= '07:20'; }
    setInterval(()=>{
      const p = tzParts();
      document.getElementById('schoolClock').textContent = `Africa/Nairobi · ${p.yr}-${p.mon}-${p.day} ${p.tim}`;
      document.getElementById('todayChip').textContent = `Leo: ${p.yr}-${p.mon}-${p.day}`;
    }, 1000);

    // ===== Firebase handles (already initialized by firebase-config.js) =====
    const db = firebase.database();
    const auth = firebase.auth();

    // ===== UI refs =====
    const kpiGrid    = document.getElementById('kpiGrid');
    const quickLinks = document.getElementById('quickLinks');
    const greetingEl = document.getElementById('workerGreeting');
    const roleChip   = document.getElementById('roleChip');

    document.getElementById('refreshDashboard').addEventListener('click', () => loadDashboard(true));
    document.getElementById('signOut').addEventListener('click', async ()=>{
      try { await auth.signOut(); } catch(e){}
      localStorage.removeItem('workerId');
      localStorage.removeItem('role');
      location.href = '../index.html';
    });

    async function isAdmin(uid) {
      if (!uid) return false;
      const snap = await firebase.database().ref('admins/' + uid).once('value'); // ✅ fixed path/string
      return snap.exists() && snap.val() === true;
    }

    async function loadDashboard(force = false) {
      try {
        const authUser = await ensureAnonymousAuth(); // keep your working flow
        const workerId = await getLinkedWorkerId();
        if (!workerId) {
          toast('Worker device is not linked. Tafadhali ingia tena.', 'error');
          window.location.href = '../index.html';
          return;
        }

        const workerSnap = await dbRefs.worker(workerId).once('value');
        if (!workerSnap.exists()) {
          toast('Profile missing. Wasiliana na HR.', 'error');
          window.location.href = '../index.html';
          return;
        }

        const worker  = workerSnap.val();
        const profile = worker.profile || {};
        const role    = String(profile.role || '').toLowerCase();

        // Greeting + chips
        greetingEl.textContent = `${profile.fullNameUpper || ''} — ${role ? role.toUpperCase() : 'WORKER'}`;
        roleChip.textContent   = `Role: ${role || '—'}`;
        if (worker?.docs?.idPhotoUrl) {
          document.getElementById('userAvatar').innerHTML =
            `<img src="${worker.docs.idPhotoUrl}" alt="ID" style="width:100%;height:100%;object-fit:cover;border-radius:14px"/>`;
        } else {
          const initials = (profile.firstName||'?').slice(0,1) + (profile.lastName||'?').slice(0,1);
          document.getElementById('userAvatar').textContent = initials.toUpperCase();
        }

        await renderKpis();
        renderQuickLinks({ role, isAdmin: await isAdmin(authUser.uid) });

      } catch (error) {
        console.error(error);
        toast(error.message || 'Failed to load dashboard', 'error');
      }
    }

    async function renderKpis() {
      kpiGrid.innerHTML = '';

      const today    = todayYMD();
      const monthKey = yyyymm(new Date());  // keep your working helper usage

      // Wide reads (wrapped with .catch so no crash on restricted rules)
      const workersPromise   = firebase.database().ref('workers').once('value');
      const attendancePromise= firebase.database().ref('attendance').once('value');
      const studentsPromise  = firebase.database().ref('students').once('value');
      const leavePromise     = firebase.database().ref('leave_requests').once('value');

      const [workersSnap, attendanceSnap, studentsSnap, leaveSnap] = await Promise.all([
        workersPromise.catch(() => null),
        attendancePromise.catch(() => null),
        studentsPromise.catch(() => null),
        leavePromise.catch(() => null)
      ]);

      const workers = workersSnap?.val() || {};
      const activeWorkers = Object.values(workers).filter(w => w?.profile?.active !== false).length;

      const lateCount   = computeLateCount(attendanceSnap?.val() || {}, today, monthKey);
      const sickToday   = computeSickToday(leaveSnap?.val() || {}, today);
      const studentsAgg = computeStudents(studentsSnap?.val() || {});

      const kpis = [
        { label: 'Active Workers | Wafanyakazi',  value: activeWorkers,            cls: activeWorkers ? 'ok':'warn' },
        { label: 'Sick Today | Wagonjwa Leo',     value: sickToday,                cls: sickToday ? 'warn':'ok' },
        { label: 'Late After 07:20 | Wamechelewa',value: lateCount,                cls: lateCount ? 'bad':'ok' },
        { label: 'Students | Wanafunzi',          value: studentsAgg.totalStudents,cls: 'ok' },
        { label: 'Boys | Wavulana',               value: studentsAgg.totalBoys,    cls: '' },
        { label: 'Girls | Wasichana',             value: studentsAgg.totalGirls,   cls: '' }
      ];

      kpis.forEach(kpi => {
        const card = document.createElement('div');
        card.className = `glass kpi ${kpi.cls||''}`;
        card.innerHTML = `<h3>${kpi.label}</h3><div class="val">${kpi.value ?? 0}</div>`;
        kpiGrid.appendChild(card);
      });
    }

    function computeLateCount(attendanceRoot, today, monthKey) {
      let count = 0;
      const dayKey = today.replace(/-/g, '');
      Object.values(attendanceRoot || {}).forEach(workerData => {
        const monthData = workerData?.[monthKey];
        if (!monthData) return;
        const record = monthData?.[dayKey];
        // Count as "late after 07:20" only when past 07:20
        if (after0720() && (!record || record.lateMinutes > 0 || !record.checkInTs)) {
          count += 1;
        }
      });
      return count;
    }

    function computeSickToday(leaveRoot, today) {
      let total = 0;
      Object.values(leaveRoot || {}).forEach(workerLeaves => {
        Object.values(workerLeaves || {}).forEach(request => {
          if (request?.type === 'sick' && request?.status === 'approved') {
            if (today >= request.startYmd && today <= request.endYmd) total += 1;
          }
        });
      });
      return total;
    }

    function computeStudents(studentsRoot) {
      let totalStudents = 0, totalBoys = 0, totalGirls = 0;
      Object.values(studentsRoot || {}).forEach(child => {
        totalStudents += 1;
        if (child.gender === 'M') totalBoys += 1;
        if (child.gender === 'F') totalGirls += 1;
      });
      return { totalStudents, totalBoys, totalGirls };
    }

    function renderQuickLinks({ role, isAdmin }) {
      quickLinks.innerHTML = '';

      const cards = [
        { key:'attendance', roles:['all'], title:'Attendance | Mahudhurio', sub:'Check-in, GPS, photos', href:'workersattendance.html' },
        { key:'tasks',      roles:['all'], title:'Tasks | Kazi',           sub:'Assignments & SLA 8h', href:'workertasks.html' },
        { key:'leaves',     roles:['all'], title:'Leave | Likizo',         sub:'Omba na fuatilia',     href:'workersleaves.html' },
        { key:'salary',     roles:['all'], title:'Salary | Mshahara',      sub:'Penalties, payslip',   href:'workerssalary.html' },
        { key:'contracts',  roles:['all'], title:'Contract | Mkataba',     sub:'Review & accept',      href:'workerscontracts.html' },

        { key:'cooks',   roles:['cook'],        title:'Kitchen | Bwalo',       sub:'Menu, headcount, variances', href:'workerscooks.html' },
        { key:'guard',   roles:['guard'],       title:'Security | Ulinzi',     sub:'Handover & assets',           href:'workersmlinzi.html' },
        { key:'cleaner', roles:['cleaner'],     title:'Cleaning | Usafi',      sub:'Checklist & supplies',        href:'workersmsafi.html' },
        { key:'store',   roles:['storekeeper'], title:'Storekeeper | Ghala',   sub:'Ledger & stock',              href:'workersstorekeeper.html' },
        { key:'transport', roles:['driver'],    title:'Transport | Usafiri',   sub:'Safari & ratiba',             href:'../transport.html' },

        { key:'admission',   roles:['admin','hr','manager'],                  title:'Admission | Kuajiri',        sub:'Register & docs',          href:'workersadmission.html' },
        { key:'payroll',     roles:['admin','hr','manager','accountant'],     title:'Payroll | Malipo',           sub:'NSSF, slips, finalize',    href:'workerspayroll_admin.html' },
        { key:'nssf',        roles:['admin','hr','accountant'],               title:'NSSF | Michango',            sub:'Rates & receipts',         href:'workersnssf.html' },
        { key:'approvals',   roles:['admin','hr','manager'],                  title:'Approvals | Uthibitisho',    sub:'Flags & incidents',        href:'workersapprovals_admin.html' },
        { key:'performance', roles:['admin','hr','manager'],                  title:'Performance | Utendaji',     sub:'Ranking & best',           href:'workersperformance.html' },
        { key:'ids',         roles:['admin','hr','manager'],                  title:'Worker IDs | Vitambulisho',  sub:'Generate & distribute',    href:'workersgenerateid.html' }
      ];

      const allow = new Set(['all', role]);
      if (isAdmin) allow.add('admin');
      if (['hr','manager','accountant'].includes(role)) allow.add(role);

      cards
        .filter(c => c.roles.some(r => allow.has(r)))
        .forEach(c => {
          // Using your createCard helper (works with your modules)
          const el = createCard({
            title: c.title,
            subtitle: c.sub,
            body: `<a class="btn primary" href="${c.href}">Open | Fungua</a>`
          });
          // Fallback if createCard returns HTML string
          if (typeof el === 'string') {
            const wrap = document.createElement('div');
            wrap.className = 'tile';
            wrap.innerHTML = el;
            quickLinks.appendChild(wrap);
          } else {
            el.classList?.add('tile'); // give our glass tile look
            quickLinks.appendChild(el);
          }
        });
    }

    // Boot
    loadDashboard();
  </script>
</body>
</html>
