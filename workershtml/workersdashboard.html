<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp · Workers Hub</title>

  <!-- Shared CSS -->
  <link rel="stylesheet" href="../css/workers.css">

  <!-- Firebase (compat v9.6.10) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase/firebase-config.js"></script>

  <style>
    /* ===== DARK GLASS UI ===== */
    :root{
      --bg:#0b1020; --ink:#e5e7eb; --muted:#a0a7ba;
      --glass:rgba(255,255,255,.06); --border:rgba(255,255,255,.16);
      --accent:#7c8aff; --accent2:#35d1e2;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --chip:rgba(255,255,255,.10);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1f276a 0%, transparent 60%),
        radial-gradient(1000px 700px at 100% 0%, #0a6aa6 0%, transparent 55%),
        linear-gradient(180deg, #0b1020 0%, #0b1020 100%);
    }
    main{max-width:1200px;margin:0 auto;padding:18px}

    .appbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;border-radius:16px;background:var(--glass);backdrop-filter:blur(16px);
      border:1px solid var(--border);box-shadow:0 10px 50px rgba(0,0,0,.35);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{
      width:44px;height:44px;border-radius:12px;flex:0 0 44px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      display:grid;place-items:center;font-weight:900;color:#0b1020;
    }
    .brand h1{margin:0;font-size:1.1rem}
    .brand .sub{margin-top:3px;font-size:.86rem;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);background:var(--glass);color:var(--ink);
      border-radius:12px;padding:10px 14px;cursor:pointer;backdrop-filter:blur(10px);
      transition:transform .08s ease,border-color .15s ease,background .15s ease;
    }
    .btn:hover{transform:translateY(-1px);border-color:#7c8affaa}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1020;border:0}

    .glass{background:var(--glass);border:1px solid var(--border);backdrop-filter:blur(16px);
      border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .hero{display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:14px;overflow:hidden;border:1px solid var(--border);
      background:radial-gradient(circle at 30% 20%,#233062,#11152a);display:grid;place-items:center;font-weight:800}
    .hello{font-size:.92rem;color:var(--muted)}
    .name{font-size:1.24rem;font-weight:800}
    .chip{display:inline-flex;align-items:center;gap:8px;font-size:.82rem;background:var(--chip);
      border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .chip.ok{border-color:#22c55e55}.chip.bad{border-color:#ef444455}.chip.warn{border-color:#f59e0b55}

    .grid{display:grid;gap:14px;margin-top:16px}
    @media(min-width:760px){.grid.kpi{grid-template-columns:repeat(3,1fr)}.grid.links{grid-template-columns:repeat(3,1fr)}}
    @media(min-width:1060px){.grid.kpi{grid-template-columns:repeat(6,1fr)}.grid.links{grid-template-columns:repeat(4,1fr)}}

    .kpi{display:flex;flex-direction:column;gap:8px;min-height:120px;transition:transform .12s ease,box-shadow .12s ease}
    .kpi:hover{transform:translateY(-2px);box-shadow:0 18px 60px rgba(0,0,0,.45)}
    .kpi h3{margin:0;font-size:.92rem;color:var(--muted);font-weight:600}
    .kpi .val{font-size:2rem;font-weight:900}
    .kpi.ok .val{color:var(--ok)} .kpi.warn .val{color:var(--warn)} .kpi.bad .val{color:var(--bad)}

    .section-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:18px}
    .links .tile{
      display:flex;flex-direction:column;min-height:140px;gap:8px;overflow:hidden;
      background:radial-gradient(500px 200px at -20% -30%,rgba(124,138,255,.25),transparent 70%),var(--glass);
      border:1px solid var(--border);backdrop-filter:blur(16px);border-radius:16px;padding:14px;
      transition:transform .12s ease,box-shadow .12s ease,border-color .15s ease;
    }
    .links .tile:hover{transform:translateY(-2px);box-shadow:0 18px 60px rgba(0,0,0,.45);border-color:#7c8affaa}
    .links h4{margin:0;font-size:1.02rem}.links p{margin:0;color:var(--muted);font-size:.9rem}
    .links a{margin-top:auto;align-self:flex-start}

    .table-wrap{overflow:auto}
    table.brief{width:100%;border-collapse:collapse}
    .brief th,.brief td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:.92rem}
    .brief thead th{position:sticky;top:0;background:rgba(15,23,42,.85);backdrop-filter:blur(10px);z-index:1}
    .brief tr:hover td{background:rgba(255,255,255,.04)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.06);font-size:.8rem}

    #toast{position:fixed;right:14px;bottom:14px;display:none;z-index:9999}
    #toast.show{display:block;animation:fadein .18s ease-out}
    #toast .t{background:rgba(3,7,18,.96);color:#fff;padding:10px 12px;border-radius:10px;margin-top:8px;box-shadow:0 16px 50px rgba(2,6,23,.45);font-size:.92rem}
    @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    .empty{padding:10px 12px;border:1px dashed var(--border);border-radius:12px;background:rgba(255,255,255,.04);color:var(--muted)}
  </style>
</head>
<body>
  <main>
    <!-- APP BAR -->
    <div class="appbar">
      <div class="brand">
        <div class="logo">So</div>
        <div>
          <h1 style="margin:0">SoMAp · Workers Hub</h1>
          <div class="sub" id="schoolClock">Africa/Nairobi</div>
        </div>
      </div>
      <div class="actions">
        <button id="refreshBtn" class="btn">Refresh | Onyesha upya</button>
        <button id="signOutBtn" class="btn">Sign Out</button>
      </div>
    </div>

    <!-- HERO -->
    <section class="glass" style="margin-top:16px">
      <div class="hero">
        <div class="avatar" id="userAvatar">👤</div>
        <div>
          <div class="hello">Karibu | Welcome</div>
          <div class="name" id="helloName">—</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <span id="roleChip" class="chip">Role: —</span>
            <span id="todayChip" class="chip ok">Leo: —</span>
            <span id="statusChip" class="chip">Status: —</span>
          </div>
        </div>
      </div>
    </section>

    <!-- YOUR RESPONSIBILITY (ALWAYS SHOWN) -->
    <section class="glass" id="myRoleSection" style="margin-top:16px;display:none">
      <div class="section-head" style="margin:0 0 8px 0">
        <h2 style="margin:0">Your Responsibility · Jukumu Lako</h2>
        <span class="chip">Bofya uanze kazi</span>
      </div>
      <div class="grid links" id="myRoleGrid"></div>
    </section>

    <!-- PERSONAL KPIs -->
    <section class="grid kpi" id="selfKpis">
      <div class="glass kpi" id="kpiCheck"><h3>Today · Leo (Check-in)</h3><div class="val">—</div></div>
      <div class="glass kpi" id="kpiLates"><h3>Month Lates · Spoti Mwezi</h3><div class="val">—</div></div>
      <div class="glass kpi" id="kpiTasks"><h3>Tasks Pending · Kazi Zinasubiri</h3><div class="val">—</div></div>
      <div class="glass kpi" id="kpiOverdue"><h3>Overdue Tasks · Kazi Zimechelewa</h3><div class="val">—</div></div>
      <div class="glass kpi" id="kpiLeave"><h3>Leave Today · Likizo Leo</h3><div class="val">—</div></div>
      <div class="glass kpi" id="kpiPenalties"><h3>Penalties (TZS) · Makato</h3><div class="val">—</div></div>
    </section>

    <!-- SCHOOL SNAPSHOT -->
    <section class="glass" id="schoolSnapshot" style="margin-top:16px">
      <div class="section-head" style="margin:0 0 8px 0">
        <h2 style="margin:0">School Snapshot · Muhtasari wa Shule</h2>
        <span class="chip">Hakuna pesa hapa · No money</span>
      </div>
      <div class="grid kpi" id="schoolKpiGrid"></div>
    </section>

    <!-- CLASS BREAKDOWN -->
    <section class="glass" id="classBreakdown" style="margin-top:16px">
      <div class="section-head" style="margin:0 0 8px 0">
        <h2 style="margin:0">Class Breakdown · Muhtasari kwa Darasa</h2>
        <span class="chip">Wanafunzi · Boys/Girls · Present</span>
      </div>
      <div id="classTableWrap" class="table-wrap">
        <div class="empty" id="classTableEmpty">Loading…</div>
      </div>
    </section>

    <!-- QUICK LINKS -->
    <section class="section-head">
      <h2 style="margin:0">Quick Links · Njia za Haraka</h2>
      <div class="chip">Tap to open · Bofya kufungua</div>
    </section>
    <section class="grid links" id="linksGrid"></section>
  </main>

  <div id="toast"></div>

  <!-- ===== keep your working helpers ===== -->
  <script type="module">
    import {
      ensureAnonymousAuth,
      getLinkedWorkerId,
      dbRefs,
      todayYMD,
      yyyymm,
      toast
    } from '../modules/workers_helpers.js';
    import { createCard } from '../modules/workers_ui.js';

    /* ---- Clock ---- */
    function tzParts(){
      const d = new Date();
      const optD={timeZone:'Africa/Nairobi',year:'numeric',month:'2-digit',day:'2-digit'};
      const optT={timeZone:'Africa/Nairobi',hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'};
      const [day,mon,yr]=new Intl.DateTimeFormat('en-GB',optD).format(d).split('/');
      const tim=new Intl.DateTimeFormat('en-GB',optT).format(d);
      return {yr,mon,day,tim};
    }
    function after0720(){ return tzParts().tim.slice(0,5) >= '07:20'; }
    setInterval(()=>{
      const p=tzParts();
      document.getElementById('schoolClock').textContent=`Africa/Nairobi · ${p.yr}-${p.mon}-${p.day} ${p.tim}`;
      document.getElementById('todayChip').textContent=`Leo: ${p.yr}-${p.mon}-${p.day}`;
    },1000);

    /* ---- Firebase ---- */
    const db = firebase.database();
    const auth = firebase.auth();

    /* ---- UI ---- */
    const greetEl   = document.getElementById('helloName');
    const roleChip  = document.getElementById('roleChip');
    const statusChp = document.getElementById('statusChip');
    const linksGrid = document.getElementById('linksGrid');
    const myRoleSection = document.getElementById('myRoleSection');
    const myRoleGrid    = document.getElementById('myRoleGrid');
    const schoolKpi = document.getElementById('schoolKpiGrid');
    const classWrap = document.getElementById('classTableWrap');

    document.getElementById('refreshBtn').addEventListener('click', ()=> loadDashboard(true));
    document.getElementById('signOutBtn').addEventListener('click', async ()=>{
      try{ await auth.signOut(); }catch(e){}
      localStorage.removeItem('workerId'); localStorage.removeItem('role');
      location.href = '../index.html';
    });

    async function isAdmin(uid){
      if (!uid) return false;
      const snap = await db.ref(`admins/${uid}`).once('value').catch(()=>null);
      return !!(snap && snap.exists() && snap.val()===true);
    }

    /* ---- MAIN ---- */
    async function loadDashboard(){
      try{
        const authUser = await ensureAnonymousAuth(); // your working flow
        const workerId = await getLinkedWorkerId();
        if (!workerId){ toast('Device not linked. Tafadhali ingia tena.', 'error'); location.href='../index.html'; return; }

        const wSnap = await dbRefs.worker(workerId).once('value');
        if (!wSnap.exists()){ toast('Profile missing. Wasiliana na HR.', 'error'); location.href='../index.html'; return; }

        const worker = wSnap.val()||{};
        const p = worker.profile||{};
        const fullName = p.fullNameUpper || [p.firstName,p.middleName,p.lastName].filter(Boolean).join(' ').toUpperCase() || '—';
        let role = String(p.role||'').trim().toLowerCase();
        if (!role) { role = localStorage.getItem('role') || ''; }
        localStorage.setItem('role', role);

        // HERO
        greetEl.textContent = `${fullName} — ${role ? role.toUpperCase() : 'WORKER'}`;
        roleChip.textContent = `Role: ${role || '—'}`;
        statusChp.textContent = (p.active===false) ? 'Status: Inactive' : 'Status: Active';
        statusChp.classList.remove('ok','bad'); statusChp.classList.add(p.active===false?'bad':'ok');
        if (worker?.docs?.idPhotoUrl){
          document.getElementById('userAvatar').innerHTML =
            `<img src="${worker.docs.idPhotoUrl}" alt="ID" style="width:100%;height:100%;object-fit:cover;border-radius:14px"/>`;
        }else{
          const initials = (p.firstName||'?').slice(0,1) + (p.lastName||'?').slice(0,1);
          document.getElementById('userAvatar').textContent = initials.toUpperCase();
        }

        // Always show the specific responsibility card FIRST
        renderMyRoleCard(role);

        // Personal KPIs
        await renderSelfKpis(workerId);

        // Snapshot + class breakdown (best effort)
        await renderSchoolSnapshot();
        await renderClassBreakdown();

        // Quick Links (role-aware)
        renderLinks(role, await isAdmin(authUser.uid));

      }catch(err){
        console.error(err);
        toast(err.message || 'Failed to load dashboard', 'error');
      }
    }

    /* ---- Your Responsibility Card ---- */
    function renderMyRoleCard(role){
      const map = {
        cook:        { title:'Kitchen · Bwalo',    sub:'Pax, menu, variances', href:'workerscooks.html' },
        guard:       { title:'Security · Ulinzi',  sub:'Handover & assets',    href:'workersmlinzi.html' },
        cleaner:     { title:'Cleaning · Usafi',   sub:'Checklist & supplies', href:'workersmsafi.html' },
        storekeeper: { title:'Storekeeper · Ghala',sub:'Ledger & stock',       href:'workersstorekeeper.html' },
        driver:      { title:'Transport · Usafiri',sub:'Safari & ratiba',      href:'../transport.html' },
        teacher:     { title:'Tasks · Kazi',       sub:'Daily duties',         href:'workertasks.html' },
        accountant:  { title:'Payroll · Malipo',   sub:'NSSF & payslips',      href:'workerspayroll_admin.html' },
        manager:     { title:'Approvals · Uthibitisho', sub:'Flags & incidents', href:'workersapprovals_admin.html' },
        hr:          { title:'Admission · Kuajiri', sub:'Register & docs',     href:'workersadmission.html' },
        academic:    { title:'Performance · Utendaji', sub:'Ranking & best',   href:'workersperformance.html' },
        admin:       { title:'Admin · Msimamizi',  sub:'All controls',         href:'workersapprovals_admin.html' }
      };
      const cfg = map[role];
      myRoleGrid.innerHTML = '';
      if (!cfg){ myRoleSection.style.display='none'; return; }
      myRoleSection.style.display = 'block';

      // Try your createCard; fall back to inline tile
      const el = createCard({
        title: cfg.title,
        subtitle: cfg.sub,
        body: `<a class="btn primary" href="${cfg.href}">Open | Fungua</a>`
      });
      const wrap = document.createElement('div');
      wrap.className='tile';
      if (typeof el === 'string'){
        wrap.innerHTML = `<h4>${cfg.title}</h4><p>${cfg.sub}</p><a class="btn primary" href="${cfg.href}">Open | Fungua</a>`;
      }else{
        el.classList?.add('tile'); wrap.appendChild(el);
      }
      myRoleGrid.appendChild(wrap);
    }

    /* ---- Personal KPIs ---- */
    async function renderSelfKpis(workerId){
      const ymd = todayYMD(); const mm = yyyymm(new Date()); const dayKey = ymd.replace(/-/g,'');
      const [attSnap, taskSnap, leaveSnap, penSnap] = await Promise.all([
        db.ref(`attendance/${workerId}/${mm}`).once('value').catch(()=>null),
        db.ref(`tasks/${workerId}/${dayKey}`).once('value').catch(()=>null),
        db.ref(`leave_requests/${workerId}`).once('value').catch(()=>null),
        db.ref(`penalties_ledger/${workerId}/${mm}`).once('value').catch(()=>null),
      ]);

      const kpiCheck = document.getElementById('kpiCheck');
      const kpiLates = document.getElementById('kpiLates');
      const kpiTasks = document.getElementById('kpiTasks');
      const kpiOver  = document.getElementById('kpiOverdue');
      const kpiLeave = document.getElementById('kpiLeave');
      const kpiPens  = document.getElementById('kpiPenalties');

      const rec = attSnap?.val()?.[dayKey] || null;
      const checked = !!(rec && rec.checkInTs);
      const lateMin = Number(rec?.lateMinutes||0);
      kpiCheck.className='glass kpi ' + (checked?(lateMin>0?'warn':'ok'):'bad');
      kpiCheck.querySelector('.val').textContent = checked ? (lateMin>0?`Late ${lateMin}m`:'Checked in') : (after0720()?'Not in 07:20+':'Not yet');

      let lates=0; Object.values(attSnap?.val()||{}).forEach(v=>{ if (v && Number(v.lateMinutes||0)>0) lates++; });
      kpiLates.className='glass kpi ' + (lates?'warn':'ok'); kpiLates.querySelector('.val').textContent=lates;

      let pending=0, overdue=0, now=Date.now();
      Object.values(taskSnap?.val()||{}).forEach(t=>{
        if (!t) return; const done=Number(t.completedTs||0)>0;
        if (!done){ pending++; if (t.dueTs && now>t.dueTs) overdue++; }
      });
      kpiTasks.className='glass kpi ' + (pending?'warn':'ok'); kpiTasks.querySelector('.val').textContent=pending;
      kpiOver.className='glass kpi ' + (overdue?'bad':'ok');   kpiOver.querySelector('.val').textContent=overdue;

      let leaveToday='None';
      Object.values(leaveSnap?.val()||{}).forEach(req=>{
        if (req?.status==='approved' && ymd>=req.startYmd && ymd<=req.endYmd) leaveToday=(req.type||'leave').toUpperCase();
      });
      kpiLeave.className='glass kpi ' + (leaveToday==='None'?'ok':'warn'); kpiLeave.querySelector('.val').textContent=leaveToday;

      let penTotal=0; Object.values(penSnap?.val()||{}).forEach(e=> penTotal+=Number(e?.amountTZS||0));
      kpiPens.className='glass kpi ' + (penTotal?'bad':'ok'); kpiPens.querySelector('.val').textContent=penTotal.toLocaleString('sw-TZ');
    }

    /* ---- School Snapshot ---- */
    async function renderSchoolSnapshot(){
      schoolKpi.innerHTML='';
      const ymd = todayYMD(); const mm = yyyymm(new Date()); const dayKey = ymd.replace(/-/g,'');

      const [wSnap, sSnap, lSnap, aSnap] = await Promise.all([
        db.ref('workers').once('value').catch(()=>null),
        db.ref('students').once('value').catch(()=>null),
        db.ref('leave_requests').once('value').catch(()=>null),
        db.ref('attendance').once('value').catch(()=>null),
      ]);

      const add = (label,val,cls='')=>{
        if (val===null || val===undefined) return;
        const div=document.createElement('div');
        div.className=`glass kpi ${cls}`; div.innerHTML=`<h3>${label}</h3><div class="val">${val}</div>`;
        schoolKpi.appendChild(div);
      };

      if (wSnap && wSnap.exists()){
        const workers=wSnap.val()||{};
        const activeWorkers=Object.values(workers).filter(w=>w?.profile?.active!==false).length;
        add('Active Workers · Wafanyakazi', activeWorkers, 'ok');

        let checked=0, late=0;
        if (aSnap && aSnap.exists()){
          const attendance=aSnap.val()||{};
          Object.values(attendance).forEach(byMonth=>{
            const rec=byMonth?.[mm]?.[dayKey];
            if (rec?.checkInTs) checked++;
            if (Number(rec?.lateMinutes||0)>0) late++;
          });
          add('Checked-in Today · Walioingia Leo', checked);
          add('Late Today · Wamechelewa Leo', late, late?'warn':'ok');
          if (after0720()) add('Not Checked-in 07:20+ · Hawajaingia', Math.max(activeWorkers-checked,0), (activeWorkers-checked)?'bad':'ok');
        }
      }

      if (sSnap && sSnap.exists()){
        const students=sSnap.val()||{};
        let total=0,boys=0,girls=0;
        Object.values(students).forEach(st=>{ total++; if (st?.gender==='M') boys++; if (st?.gender==='F') girls++; });
        add('Students · Wanafunzi', total, 'ok');
        add('Boys · Wavulana', boys);
        add('Girls · Wasichana', girls);
      }

      if (lSnap && lSnap.exists()){
        let sickToday=0;
        Object.values(lSnap.val()||{}).forEach(wLeaves=>{
          Object.values(wLeaves||{}).forEach(req=>{
            if (req?.type==='sick' && req?.status==='approved' && ymd>=req.startYmd && ymd<=req.endYmd) sickToday++;
          });
        });
        add('Sick Today · Wagonjwa Leo', sickToday, sickToday?'warn':'ok');
      }
    }

    /* ---- Class Breakdown ---- */
    async function renderClassBreakdown(){
      classWrap.innerHTML='';
      const table=document.createElement('table'); table.className='brief';
      table.innerHTML=`
        <thead><tr>
          <th>Class · Darasa</th><th>Total</th><th>Boys</th><th>Girls</th><th>Present Today</th><th>Newcomers (30d)</th>
        </tr></thead><tbody id="classTbody"></tbody>`;
      const tbody=table.querySelector('#classTbody');

      const sSnap = await db.ref('students').once('value').catch(()=>null);
      if (!sSnap || !sSnap.exists()){ const div=document.createElement('div'); div.className='empty'; div.textContent='No student data (rules or empty).'; classWrap.appendChild(div); return; }
      const students=sSnap.val()||{};

      const ymd=todayYMD(), mm=yyyymm(new Date()), dayKey=ymd.replace(/-/g,'');
      let stAttend=null;
      for (const pth of [`attendance_students/${mm}/${dayKey}`,`students_attendance/${mm}/${dayKey}`,`studentsAttendance/${mm}/${dayKey}`]){
        const shot=await db.ref(pth).once('value').catch(()=>null);
        if (shot && shot.exists()){ stAttend=shot.val(); break; }
      }

      const now=Date.now(), THIRTY=30*24*60*60*1000, byClass={};
      for (const [sid,s] of Object.entries(students)){
        const clazz=s.class||s.classLevel||'—';
        if (!byClass[clazz]) byClass[clazz]={total:0,boys:0,girls:0,present:0,newcomers:0};
        byClass[clazz].total++; if (s.gender==='M') byClass[clazz].boys++; if (s.gender==='F') byClass[clazz].girls++;
        if (stAttend && stAttend[sid]){ const rec=stAttend[sid]; const present=(rec===true)||!!rec.present||!!rec.checkInTs; if (present) byClass[clazz].present++; }
        const ts=Number(s.admissionDate||s.registeredTs||s.createdTs||0); if (ts&&(now-ts)<=THIRTY) byClass[clazz].newcomers++;
      }

      Object.keys(byClass).sort((a,b)=>a.localeCompare(b,'en')).forEach(cn=>{
        const r=byClass[cn]; const tr=document.createElement('tr');
        tr.innerHTML=`<td><span class="badge">${cn}</span></td><td>${r.total}</td><td>${r.boys}</td><td>${r.girls}</td><td>${stAttend? r.present:'—'}</td><td>${r.newcomers}</td>`;
        tbody.appendChild(tr);
      });

      classWrap.appendChild(table);
    }

    /* ---- Quick Links (role-aware) ---- */
    function renderLinks(role, admin){
      linksGrid.innerHTML='';
      const cards=[
        {key:'attendance',roles:['all'],title:'Attendance | Mahudhurio',sub:'Check-in, GPS, photos',href:'workersattendance.html'},
        {key:'tasks',roles:['all'],title:'Tasks | Kazi',sub:'Assignments & SLA 8h',href:'workertasks.html'},
        {key:'leaves',roles:['all'],title:'Leave | Likizo',sub:'Omba na fuatilia',href:'workersleaves.html'},
        {key:'salary',roles:['all'],title:'Salary | Mshahara',sub:'Penalties, payslip',href:'workerssalary.html'},
        {key:'contracts',roles:['all'],title:'Contract | Mkataba',sub:'Review & accept',href:'workerscontracts.html'},

        {key:'cook',roles:['cook'],title:'Kitchen | Bwalo',sub:'Pax, menu, variances',href:'workerscooks.html'},
        {key:'guard',roles:['guard'],title:'Security | Ulinzi',sub:'Handover & assets',href:'workersmlinzi.html'},
        {key:'cleaner',roles:['cleaner'],title:'Cleaning | Usafi',sub:'Checklist & supplies',href:'workersmsafi.html'},
        {key:'store',roles:['storekeeper'],title:'Storekeeper | Ghala',sub:'Ledger & stock',href:'workersstorekeeper.html'},
        {key:'driver',roles:['driver'],title:'Transport | Usafiri',sub:'Safari & ratiba',href:'../transport.html'},

        {key:'admission',roles:['admin','hr','manager'],title:'Admission | Kuajiri',sub:'Register & docs',href:'workersadmission.html'},
        {key:'payroll',roles:['admin','hr','manager','accountant'],title:'Payroll | Malipo',sub:'NSSF, slips, finalize',href:'workerspayroll_admin.html'},
        {key:'nssf',roles:['admin','hr','accountant'],title:'NSSF | Michango',sub:'Rates & receipts',href:'workersnssf.html'},
        {key:'approvals',roles:['admin','hr','manager'],title:'Approvals | Uthibitisho',sub:'Flags & incidents',href:'workersapprovals_admin.html'},
        {key:'performance',roles:['admin','hr','manager'],title:'Performance | Utendaji',sub:'Ranking & best',href:'workersperformance.html'},
        {key:'ids',roles:['admin','hr','manager'],title:'Worker IDs | Vitambulisho',sub:'Generate & distribute',href:'workersgenerateid.html'}
      ];

      const allow=new Set(['all', role]);
      if (admin) allow.add('admin');
      if (['hr','manager','accountant'].includes(role)) allow.add(role);

      // Put the role-specific card first in Quick Links too (but won't duplicate the MyRole section)
      const ordered=[];
      cards.forEach(c=>{ if (c.roles.includes(role)) ordered.push(c); });
      cards.forEach(c=>{ if (c.roles.some(r=>allow.has(r)) && !ordered.find(x=>x.key===c.key)) ordered.push(c); });

      ordered.forEach(c=>{
        const el=createCard({title:c.title,subtitle:c.sub,body:`<a class="btn primary" href="${c.href}">Open | Fungua</a>`});
        const wrap=document.createElement('div'); wrap.className='tile';
        if (typeof el==='string'){ wrap.innerHTML=`<h4>${c.title}</h4><p>${c.sub}</p><a class="btn primary" href="${c.href}">Open | Fungua</a>`; }
        else { el.classList?.add('tile'); wrap.appendChild(el); }
        linksGrid.appendChild(wrap);
      });
    }

    // GO
    loadDashboard();
  </script>
</body>
</html>
