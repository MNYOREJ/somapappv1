<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp · Workers Hub</title>

  <link rel="stylesheet" href="../css/workers.css">

  <!-- Firebase (compat v9.6.10) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase/firebase-config.js"></script>

  <style>
    /* ====== DARK GLASS STYLE ====== */
    :root{
      --bg:#0b1020; --ink:#e5e7eb; --muted:#a0a7ba;
      --glass:rgba(255,255,255,.06); --border:rgba(255,255,255,.15);
      --accent:#7c8aff; --accent2:#35d1e2;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1f276a 0%, transparent 60%),
        radial-gradient(1000px 700px at 100% 0%, #0a6aa6 0%, transparent 55%),
        linear-gradient(180deg, #0b1020 0%, #0b1020 100%);
      overflow-y:auto;
    }
    main{max-width:1200px;margin:0 auto;padding:18px}
    .appbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;border-radius:16px;
      background:var(--glass); backdrop-filter: blur(16px);
      border:1px solid var(--border);
      box-shadow:0 10px 50px rgba(0,0,0,.35);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{
      width:44px;height:44px;border-radius:12px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      display:grid;place-items:center;font-weight:900;color:#10142a;
    }
    .brand h1{margin:0;font-size:1.1rem;letter-spacing:.3px}
    .brand .sub{margin-top:3px;font-size:.88rem;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border); background:var(--glass);
      color:var(--ink); border-radius:12px; padding:10px 14px; cursor:pointer;
      backdrop-filter: blur(10px);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .btn:hover{transform:translateY(-1px); border-color:#7c8affaa}
    .btn.primary{background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#0b1020; border:0}
    .grid{display:grid;gap:14px;margin-top:16px}
    @media(min-width:760px){ .grid.kpi{grid-template-columns:repeat(3,1fr)} .grid.links{grid-template-columns:repeat(3,1fr)} }
    @media(min-width:1060px){ .grid.kpi{grid-template-columns:repeat(6,1fr)} .grid.links{grid-template-columns:repeat(4,1fr)} }

    .glass{
      background:var(--glass); border:1px solid var(--border); backdrop-filter: blur(16px);
      border-radius:16px; padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.35);
    }
    .hero{
      display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:center;
    }
    .avatar{
      width:56px;height:56px;border-radius:14px;overflow:hidden;border:1px solid var(--border);
      background:radial-gradient(circle at 30% 20%, #233062, #11152a); display:grid;place-items:center;font-weight:800;
    }
    .hero .hello{font-size:.92rem;color:var(--muted)}
    .hero .name{font-size:1.25rem;font-weight:800;letter-spacing:.3px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;font-size:.82rem;
      background:rgba(255,255,255,.08); border:1px solid var(--border);
      padding:6px 10px; border-radius:999px; color:var(--ink)
    }
    .chip.ok{border-color:#22c55e55}
    .chip.bad{border-color:#ef444455}
    .chip.warn{border-color:#f59e0b55}

    .kpi{
      display:flex;flex-direction:column;gap:8px;min-height:120px;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .kpi:hover{transform:translateY(-2px); box-shadow:0 18px 60px rgba(0,0,0,.45)}
    .kpi h3{margin:0;font-size:.92rem;color:var(--muted);font-weight:600}
    .kpi .val{font-size:2rem;font-weight:900;letter-spacing:.4px}
    .kpi.ok .val{color:var(--ok)} .kpi.warn .val{color:var(--warn)} .kpi.bad .val{color:var(--bad)}

    .section-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:18px}
    .links .tile{
      display:flex;flex-direction:column;min-height:140px;gap:8px;position:relative;overflow:hidden;
      background:
        radial-gradient(500px 200px at -20% -30%, rgba(124,138,255,.25), transparent 70%),
        var(--glass);
      border:1px solid var(--border); backdrop-filter: blur(16px);
      border-radius:16px; padding:14px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .15s ease;
    }
    .links .tile:hover{transform:translateY(-2px); box-shadow:0 18px 60px rgba(0,0,0,.45); border-color:#7c8affaa}
    .links h4{margin:0;font-size:1.02rem}
    .links p{margin:0;color:var(--muted);font-size:.9rem}
    .links a{margin-top:auto;align-self:flex-start}

    .errorbar{margin-top:12px;display:none}
    .errorbar.show{display:block;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);color:#fecaca;padding:10px 12px;border-radius:10px}

    #toast{position:fixed;right:14px;bottom:14px;display:none;z-index:9999}
    #toast.show{display:block;animation:fadein .18s ease-out}
    #toast .t{background:rgba(3,7,18,.96);color:#fff;padding:10px 12px;border-radius:10px;margin-top:8px;box-shadow:0 16px 50px rgba(2,6,23,.45);font-size:.92rem}
    @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <main>
    <!-- APP BAR -->
    <div class="appbar">
      <div class="brand">
        <div class="logo">So</div>
        <div>
          <h1>SoMAp · Workers Hub</h1>
          <div class="sub" id="schoolClock">Africa/Nairobi</div>
        </div>
      </div>
      <div class="actions">
        <button id="refreshBtn" class="btn">Refresh | Onyesha upya</button>
        <button id="signOutBtn" class="btn">Sign Out</button>
      </div>
    </div>

    <!-- HERO / WELCOME -->
    <section class="glass" style="margin-top:16px">
      <div class="hero">
        <div class="avatar" id="userAvatar">👤</div>
        <div>
          <div class="hello">Karibu | Welcome</div>
          <div class="name" id="helloName">—</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <span id="roleChip" class="chip">Role: —</span>
            <span id="todayChip" class="chip ok">Leo: —</span>
          </div>
        </div>
      </div>
    </section>

    <!-- PERSONAL KPIs (always visible) -->
    <section class="grid kpi">
      <div class="glass kpi" id="kpiCheck"><h3>Today · Leo (Check-in)</h3><div class="val">—</div></div>
      <div class="glass kpi" id="kpiLates"><h3>Month Lates · Spoti Mwezi</h3><div class="val">—</div></div>
      <div class="glass kpi" id="kpiTasks"><h3>Tasks Pending · Kazi Zinasubiri</h3><div class="val">—</div></div>
      <div class="glass kpi" id="kpiOverdue"><h3>Overdue Tasks · Kazi Zimechelewa</h3><div class="val">—</div></div>
      <div class="glass kpi" id="kpiLeave"><h3>Leave Today · Likizo Leo</h3><div class="val">—</div></div>
      <div class="glass kpi" id="kpiPenalties"><h3>Penalties (TZS) · Makato</h3><div class="val">—</div></div>
    </section>

    <!-- QUICK LINKS -->
    <section class="section-head">
      <h2 style="margin:0">Quick Links · Njia za Haraka</h2>
      <div class="chip" id="linksHint">Bofya kufungua | Tap to open</div>
    </section>
    <section class="grid links" id="linksGrid"></section>

    <!-- ADMIN KPIs (only if admin) -->
    <section id="adminBlock" class="glass" style="margin-top:18px; display:none;">
      <div class="section-head" style="margin:0 0 10px 0">
        <h2 style="margin:0">School Snapshot · Muhtasari wa Shule (Admin)</h2>
        <span class="chip">Admins only</span>
      </div>
      <div class="grid kpi" id="adminKpiGrid"></div>
    </section>

    <div id="errorbar" class="errorbar"></div>
  </main>

  <div id="toast"></div>

  <script>
    /* ===== Firebase init (no anonymous sign-in here) ===== */
    (function initFirebase(){
      const fallback = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
      };
      const cfg = window.firebaseConfig || fallback;
      if (!firebase.apps.length) firebase.initializeApp(cfg);
    })();

    const db = firebase.database();
    const auth = firebase.auth();

    const $ = s => document.querySelector(s);

    function toast(msg, type='info'){
      const wrap = $('#toast');
      const div = document.createElement('div');
      div.className = 't';
      div.textContent = msg;
      if (type==='error') div.style.background = 'rgba(239,68,68,.96)';
      if (type==='ok') div.style.background = 'rgba(16,185,129,.96)';
      wrap.appendChild(div);
      wrap.classList.add('show');
      setTimeout(()=>{ div.remove(); if(!wrap.children.length) wrap.classList.remove('show'); }, 3500);
    }

    function showError(text){
      const eb = $('#errorbar');
      eb.textContent = text;
      eb.classList.add('show');
    }
    function clearError(){ const eb=$('#errorbar'); eb.classList.remove('show'); eb.textContent=''; }

    function tzParts(){
      const d = new Date();
      const optD = { timeZone:'Africa/Nairobi', year:'numeric', month:'2-digit', day:'2-digit' };
      const optT = { timeZone:'Africa/Nairobi', hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' };
      const [day,mon,yr] = new Intl.DateTimeFormat('en-GB', optD).format(d).split('/');
      const tim = new Intl.DateTimeFormat('en-GB', optT).format(d);
      return { yr, mon, day, tim };
    }
    function todayYMD(){ const {yr,mon,day} = tzParts(); return `${yr}-${mon}-${day}`; }
    function yyyymm(){ const {yr,mon} = tzParts(); return `${yr}${mon}`; }
    function after0720(){ return tzParts().tim.slice(0,5) >= '07:20'; }

    // Live clock in appbar
    setInterval(()=>{
      const p = tzParts();
      $('#schoolClock').textContent = `Africa/Nairobi · ${p.yr}-${p.mon}-${p.day} ${p.tim}`;
      $('#todayChip').textContent = `Leo: ${p.yr}-${p.mon}-${p.day}`;
    }, 1000);

    $('#signOutBtn').addEventListener('click', async ()=>{
      try{ await auth.signOut(); }catch(e){}
      localStorage.removeItem('workerId');
      localStorage.removeItem('role');
      location.href = '../index.html';
    });
    $('#refreshBtn').addEventListener('click', ()=> loadDashboard(true));

    // Wait for an auth user created at index.html (Google or anon there).
    function waitForAuth(ms=4000){
      return new Promise((resolve,reject)=>{
        let settled=false;
        const stop = auth.onAuthStateChanged(u=>{ if(!settled){ settled=true; stop(); resolve(u); }});
        setTimeout(()=>{ if(!settled){ stop(); resolve(null); }}, ms);
      });
    }

    async function loadDashboard(){
      clearError();

      // 1) Must have a mapped workerId from index.html
      const workerId = localStorage.getItem('workerId');
      if (!workerId){
        showError('Hakuna session ya mfanyakazi. Tafadhali ingia tena kwenye ukurasa mkuu.');
        setTimeout(()=> location.href = '../index.html', 1100);
        return;
      }

      // 2) Must have an auth user (created at index.html). We do NOT call signInAnonymously here.
      const u = await waitForAuth();
      if (!u){
        showError('Hakuna akaunti ya kuisoma data. Tafadhali ingia tena kwenye ukurasa mkuu.');
        setTimeout(()=> location.href = '../index.html', 1100);
        return;
      }

      // 3) (Optional) sanity: devices/{uid}/workerId should match localStorage
      try{
        const mapSnap = await db.ref(`devices/${u.uid}/workerId`).once('value');
        if (!mapSnap.exists() || mapSnap.val() !== workerId){
          // If mismatch, rely on your index flow to rebuild it; send them back cleanly.
          showError('Kifaa hakijaunganishwa ipasavyo. Tafadhali ingia tena.');
          setTimeout(()=> location.href = '../index.html', 1100);
          return;
        }
      }catch(e){ /* ignore soft errors; continue read */ }

      // 4) Read current worker profile (allowed by rules via the device mapping)
      const wSnap = await db.ref(`workers/${workerId}`).once('value');
      if (!wSnap.exists()){
        showError('Wasifu wa mfanyakazi haujapatikana. Wasiliana na HR.');
        return;
      }
      const worker = wSnap.val() || {};
      const p = worker.profile || {};
      const role = String(p.role||'').toLowerCase();

      // Header/hero info
      $('#helloName').textContent = p.fullNameUpper || '—';
      $('#roleChip').textContent = `Role: ${role || '—'}`;
      if (worker?.docs?.idPhotoUrl){
        $('#userAvatar').innerHTML = `<img src="${worker.docs.idPhotoUrl}" alt="ID" style="width:100%;height:100%;object-fit:cover"/>`;
      }else{
        const badge = (p.firstName||'?').slice(0,1) + (p.lastName||'?').slice(0,1);
        $('#userAvatar').textContent = badge.toUpperCase();
      }

      // Personal KPIs
      await renderSelfKPIs(workerId);

      // Links grid (role-aware)
      renderLinks(role, await isAdmin(u.uid));

      // Admin KPIs only if admin
      if (await isAdmin(u.uid)) await renderAdminKPIs();
    }

    async function isAdmin(uid){
      if (!uid) return false;
      const snap = await db.ref(`admins/${uid}`).once('value');
      return snap.exists() && snap.val() === true;
    }

    async function renderSelfKPIs(workerId){
      const ymd = todayYMD();
      const mm = yyyymm();
      const dayKey = ymd.replace(/-/g, '');

      const [attSnap, taskSnap, leaveSnap, penSnap] = await Promise.all([
        db.ref(`attendance/${workerId}/${mm}`).once('value').catch(()=>null),
        db.ref(`tasks/${workerId}/${dayKey}`).once('value').catch(()=>null),
        db.ref(`leave_requests/${workerId}`).once('value').catch(()=>null),
        db.ref(`penalties_ledger/${workerId}/${mm}`).once('value').catch(()=>null),
      ]);

      // Check-in
      const rec = attSnap?.val()?.[dayKey] || null;
      const checked = !!(rec && rec.checkInTs);
      const lateMin = Number(rec?.lateMinutes || 0);
      const checkTile = $('#kpiCheck');
      checkTile.classList.remove('ok','warn','bad');
      if (checked){
        checkTile.classList.add(lateMin>0?'warn':'ok');
        checkTile.querySelector('.val').textContent = lateMin>0 ? `Late ${lateMin}m` : 'Checked in';
      }else{
        const msg = after0720() ? 'Not in 07:20+' : 'Not yet';
        checkTile.classList.add('bad');
        checkTile.querySelector('.val').textContent = msg;
      }

      // Lates this month
      let lates=0;
      Object.values(attSnap?.val()||{}).forEach(v=>{ if (v && Number(v.lateMinutes||0)>0) lates++; });
      const lt = $('#kpiLates'); lt.classList.remove('ok','warn'); lt.classList.add(lates?'warn':'ok');
      lt.querySelector('.val').textContent = lates;

      // Tasks pending & overdue today
      let pending=0, overdue=0, now=Date.now();
      Object.values(taskSnap?.val()||{}).forEach(t=>{
        if (!t) return;
        const done = Number(t.completedTs||0) > 0;
        if (!done){
          pending++;
          if (t.dueTs && now > t.dueTs) overdue++;
        }
      });
      const tp = $('#kpiTasks'); tp.classList.remove('ok','warn'); tp.classList.add(pending?'warn':'ok');
      tp.querySelector('.val').textContent = pending;
      const to = $('#kpiOverdue'); to.classList.remove('ok','bad'); to.classList.add(overdue?'bad':'ok');
      to.querySelector('.val').textContent = overdue;

      // Leave today
      let leaveToday = 'None';
      Object.values(leaveSnap?.val()||{}).forEach(req=>{
        if (req?.status==='approved' && ymd >= req.startYmd && ymd <= req.endYmd) leaveToday = (req.type||'leave').toUpperCase();
      });
      const lv = $('#kpiLeave'); lv.classList.remove('ok','warn'); lv.classList.add(leaveToday==='None'?'ok':'warn');
      lv.querySelector('.val').textContent = leaveToday;

      // Penalties this month
      let penTotal=0;
      Object.values(penSnap?.val()||{}).forEach(e=> penTotal += Number(e?.amountTZS||0));
      const pk = $('#kpiPenalties'); pk.classList.remove('ok','bad'); pk.classList.add(penTotal?'bad':'ok');
      pk.querySelector('.val').textContent = penTotal.toLocaleString('sw-TZ');
    }

    function renderLinks(role, isAdmin){
      const grid = $('#linksGrid');
      grid.innerHTML = '';

      const cards = [
        { key:'attendance', roles:['all'], title:'Attendance | Mahudhurio', sub:'Check-in, GPS, photos', href:'workersattendance.html' },
        { key:'tasks', roles:['all'], title:'Tasks | Kazi', sub:'Assignments & 8h SLA', href:'workertasks.html' },
        { key:'leaves', roles:['all'], title:'Leave | Likizo', sub:'Omba na fuatilia', href:'workersleaves.html' },
        { key:'salary', roles:['all'], title:'Salary | Mshahara', sub:'Makato & payslip', href:'workerssalary.html' },
        { key:'contracts', roles:['all'], title:'Contract | Mkataba', sub:'Review & accept', href:'workerscontracts.html' },

        { key:'cook', roles:['cook'], title:'Kitchen | Bwalo', sub:'Pax, menu, variances', href:'workerscooks.html' },
        { key:'guard', roles:['guard'], title:'Security | Ulinzi', sub:'Handover & assets', href:'workersmlinzi.html' },
        { key:'cleaner', roles:['cleaner'], title:'Cleaning | Usafi', sub:'Checklist & supplies', href:'workersmsafi.html' },
        { key:'store', roles:['storekeeper'], title:'Storekeeper | Ghala', sub:'Ledger & stock', href:'workersstorekeeper.html' },
        { key:'transport', roles:['driver'], title:'Transport | Usafiri', sub:'Safari & ratiba', href:'../transport.html' },

        { key:'admission', roles:['admin','hr','manager'], title:'Admission | Kuajiri', sub:'Register & docs', href:'workersadmission.html' },
        { key:'payroll', roles:['admin','hr','manager','accountant'], title:'Payroll | Malipo', sub:'NSSF, slips, finalize', href:'workerspayroll_admin.html' },
        { key:'nssf', roles:['admin','hr','accountant'], title:'NSSF | Michango', sub:'Rates & receipts', href:'workersnssf.html' },
        { key:'approvals', roles:['admin','hr','manager'], title:'Approvals | Uthibitisho', sub:'Flags & incidents', href:'workersapprovals_admin.html' },
        { key:'performance', roles:['admin','hr','manager'], title:'Performance | Utendaji', sub:'Ranking & best', href:'workersperformance.html' },
        { key:'ids', roles:['admin','hr','manager'], title:'Worker IDs | Vitambulisho', sub:'Generate & distribute', href:'workersgenerateid.html' }
      ];

      const allow = new Set(['all', role]);
      if (isAdmin) allow.add('admin');
      if (['hr','manager','accountant'].includes(role)) allow.add(role);

      cards
        .filter(c => c.roles.some(r => allow.has(r)))
        .forEach(c=>{
          const tile = document.createElement('div');
          tile.className = 'tile';
          tile.innerHTML = `
            <h4>${c.title}</h4>
            <p>${c.sub}</p>
            <a class="btn primary" href="${c.href}">Open · Fungua</a>
          `;
          grid.appendChild(tile);
        });
    }

    async function renderAdminKPIs(){
      $('#adminBlock').style.display = 'block';
      const grid = $('#adminKpiGrid');
      grid.innerHTML = '';

      const ymd = todayYMD(), mm = yyyymm(), dayKey = ymd.replace(/-/g,'');

      const [wSnap, sSnap, lSnap, aSnap] = await Promise.all([
        db.ref('workers').once('value').catch(()=>null),
        db.ref('students').once('value').catch(()=>null),
        db.ref('leave_requests').once('value').catch(()=>null),
        db.ref('attendance').once('value').catch(()=>null),
      ]);

      const workers = wSnap?.val() || {};
      const activeWorkers = Object.values(workers).filter(w=>w?.profile?.active!==false).length;

      let totalStudents=0, boys=0, girls=0;
      Object.values(sSnap?.val()||{}).forEach(st=>{
        totalStudents++;
        if (st.gender==='M') boys++;
        if (st.gender==='F') girls++;
      });

      let sickToday=0;
      Object.values(lSnap?.val()||{}).forEach(workerLeaves=>{
        Object.values(workerLeaves||{}).forEach(req=>{
          if (req?.type==='sick' && req?.status==='approved' && ymd>=req.startYmd && ymd<=req.endYmd) sickToday++;
        });
      });

      let checked=0, late=0;
      Object.values(aSnap?.val()||{}).forEach(byMonth=>{
        const rec = byMonth?.[mm]?.[dayKey];
        if (rec?.checkInTs) checked++;
        if (Number(rec?.lateMinutes||0)>0) late++;
      });

      const add = (label, val, cls='')=>{
        const div = document.createElement('div');
        div.className = `glass kpi ${cls}`;
        div.innerHTML = `<h3>${label}</h3><div class="val">${val}</div>`;
        grid.appendChild(div);
      };
      add('Active Workers · Wafanyakazi', activeWorkers, 'ok');
      add('Checked-in Today · Walioingia Leo', checked);
      add('Late Today · Wamechelewa Leo', late, late?'warn':'ok');
      if (after0720()) add('Not Checked-in 07:20+ · Hawajaingia', Math.max(activeWorkers-checked,0), (activeWorkers-checked)?'bad':'ok');
      add('Students · Wanafunzi', totalStudents);
      add('Boys · Wavulana', boys);
      add('Girls · Wasichana', girls);
      add('Sick Today · Wagonjwa Leo', sickToday, sickToday?'warn':'ok');
    }

    // Boot
    loadDashboard();
  </script>
</body>
</html>
