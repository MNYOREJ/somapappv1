<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp Workers Hub</title>

  <link rel="stylesheet" href="../css/workers.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase/firebase-config.js"></script>

  <style>
    :root{
      --ink:#0f172a; --sub:#64748b; --muted:#94a3b8;
      --bg:#f8fafc; --card:#ffffff; --line:#e2e8f0;
      --accent:#4f46e5; --accent-2:#06b6d4; --ok:#10b981;
      --warn:#f59e0b; --bad:#ef4444; --chip:#f1f5f9;
    }
    body{margin:0;background:linear-gradient(135deg,#007bff,#6610f2);font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    main{max-width:1180px;margin-inline:auto;padding:18px}
    header.appbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;border-radius:16px;background:linear-gradient(135deg,#fff,#eef2ff);
      color:#111; box-shadow:0 10px 30px rgba(0,0,0,.08)
    }
    .idline{color:var(--sub);font-size:.95rem}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:10px 14px;background:#111827;color:#fff;cursor:pointer}
    .btn.alt{background:#334155}
    .btn.line{background:transparent;border:1px solid var(--line);color:#111}
    .grid{display:grid;gap:14px;margin-top:16px}
    @media(min-width:720px){ .grid.kpi{grid-template-columns:repeat(3,1fr)} .grid.links{grid-template-columns:repeat(3,1fr)} }
    @media(min-width:1040px){ .grid.kpi{grid-template-columns:repeat(6,1fr)} .grid.links{grid-template-columns:repeat(4,1fr)} }
    .kpi{
      background:var(--card);border:1px solid var(--line);border-radius:14px;
      padding:14px;display:flex;flex-direction:column;gap:8px;min-height:120px;
      box-shadow:0 8px 20px rgba(10,16,28,.06)
    }
    .kpi h3{margin:0;font-size:.92rem;color:var(--sub);font-weight:600}
    .kpi .val{font-size:1.9rem;font-weight:800;color:#0b1120}
    .kpi.ok .val{color:var(--ok)} .kpi.bad .val{color:var(--bad)} .kpi.warn .val{color:var(--warn)}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;
      box-shadow:0 8px 20px rgba(10,16,28,.06);display:flex;flex-direction:column;gap:8px
    }
    .link-tile{
      display:flex;flex-direction:column;gap:6px;border-radius:16px;border:1px solid var(--line);
      background:linear-gradient(135deg,#ffffff,#f8fafc);padding:14px;min-height:130px
    }
    .link-tile h4{margin:0;font-size:1.02rem;color:#0b1120}
    .link-tile p{margin:0;color:var(--sub);font-size:.9rem}
    .link-tile a{margin-top:auto;align-self:flex-start}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border-radius:999px;padding:6px 10px;font-size:.82rem;color:#0b1120}
    .chip.ok{background:rgba(16,185,129,.12)} .chip.bad{background:rgba(239,68,68,.12)} .chip.warn{background:rgba(245,158,11,.12)}
    #toast{position:fixed;right:14px;bottom:14px;display:none;z-index:9999}
    #toast.show{display:block;animation:fadein .2s ease-out}
    #toast .t{background:rgba(15,23,42,.96);color:#fff;padding:10px 12px;border-radius:10px;margin-top:8px;box-shadow:0 10px 30px rgba(2,6,23,.3);font-size:.92rem}
    @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .errorbar{margin-top:12px;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:10px 12px;border-radius:10px;display:none}
  </style>
</head>
<body>
  <main>
    <header class="appbar">
      <div>
        <h1 style="margin:0 0 4px 0;">SoMAp Workers Hub</h1>
        <div id="greet" class="idline">Karibu | Welcome</div>
      </div>
      <div class="actions">
        <button id="refreshBtn" class="btn alt">Refresh</button>
        <button id="signOutBtn" class="btn line">Sign Out</button>
      </div>
    </header>

    <div id="errorbar" class="errorbar"></div>

    <!-- KPIs -->
    <section class="grid kpi" id="kpiGrid" aria-live="polite"></section>

    <!-- Links -->
    <section class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0;font-size:1.15rem">Quick Links | Njia za Haraka</h2>
        <span id="roleChip" class="chip">Role: …</span>
      </div>
      <div class="grid links" id="linksGrid" style="margin-top:12px"></div>
    </section>
  </main>

  <div id="toast"></div>

  <script>
    // ---------- Firebase init ----------
    (function initFirebase(){
      const fallback = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
      };
      const cfg = window.firebaseConfig || fallback;
      if (!firebase.apps.length) firebase.initializeApp(cfg);
    })();

    const db = firebase.database();
    const auth = firebase.auth();

    const $ = sel => document.querySelector(sel);

    function toast(msg, type='info'){
      const wrap = $('#toast');
      const div = document.createElement('div');
      div.className = 't';
      div.textContent = msg;
      if (type==='error') div.style.background = 'rgba(239,68,68,.96)';
      if (type==='ok') div.style.background = 'rgba(16,185,129,.96)';
      wrap.appendChild(div);
      wrap.classList.add('show');
      setTimeout(()=>{ div.remove(); if(!wrap.children.length) wrap.classList.remove('show'); }, 4000);
    }

    function showErrorBar(text){
      const eb = $('#errorbar');
      eb.textContent = text;
      eb.style.display = 'block';
    }
    function clearErrorBar(){
      const eb = $('#errorbar');
      eb.style.display = 'none';
      eb.textContent = '';
    }

    function tzNowParts(){
      const optsD = { timeZone:'Africa/Nairobi', year:'numeric', month:'2-digit', day:'2-digit' };
      const optsT = { timeZone:'Africa/Nairobi', hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' };
      const [d,m,y] = new Intl.DateTimeFormat('en-GB', optsD).format(new Date()).split('/');
      const t = new Intl.DateTimeFormat('en-GB', optsT).format(new Date());
      return { y, m, d, t }; // t = HH:MM:SS
    }
    function todayYMD(){ const {y,m,d} = tzNowParts(); return `${y}-${m}-${d}`; }
    function yyyymm(){ const {y,m} = tzNowParts(); return `${y}${m}`; }
    function isAfter0720(){ return tzNowParts().t.slice(0,5) >= '07:20'; }

    async function ensureAnon(){
      if (auth.currentUser) return auth.currentUser;
      try {
        const { user } = await auth.signInAnonymously();
        return user;
      } catch (e){
        // Friendly message (no raw Firebase text)
        showErrorBar('Anonymous sign-in is disabled. Enable it in Firebase → Authentication → Sign-in method → Anonymous.');
        throw e;
      }
    }

    async function getLinkedWorkerId(){
      const local = localStorage.getItem('workerId');
      if (local) return local;
      const u = await ensureAnon();
      const snap = await db.ref(`devices/${u.uid}/workerId`).once('value');
      if (snap.exists()){
        const wid = snap.val();
        localStorage.setItem('workerId', wid);
        return wid;
      }
      return null;
    }

    async function isAdmin(uid){
      if (!uid) return false;
      const snap = await db.ref(`admins/${uid}`).once('value');
      return snap.exists() && snap.val() === true;
    }

    $('#signOutBtn').addEventListener('click', async ()=>{
      try{ await auth.signOut(); }catch(e){}
      localStorage.removeItem('workerId');
      localStorage.removeItem('role');
      location.href = '../index.html';
    });
    $('#refreshBtn').addEventListener('click', ()=> loadDashboard(true));

    async function loadDashboard(){
      clearErrorBar();
      try{
        const user = await ensureAnon();
        const workerId = await getLinkedWorkerId();
        if (!workerId){
          showErrorBar('This device is not linked to a worker. Please login again on the home page.');
          setTimeout(()=> location.href = '../index.html', 1200);
          return;
        }

        // Profile (own)
        const wSnap = await db.ref(`workers/${workerId}`).once('value');
        if (!wSnap.exists()){
          showErrorBar('Worker profile missing. Contact HR.');
          setTimeout(()=> location.href = '../index.html', 1200);
          return;
        }
        const worker = wSnap.val() || {};
        const p = worker.profile || {};
        const role = String(p.role||'').toLowerCase();
        localStorage.setItem('role', role);

        $('#greet').textContent = `${p.fullNameUpper || ''} · ${role ? role.toUpperCase() : 'WORKER'}`;
        $('#roleChip').textContent = `Role: ${role || '—'}`;

        // KPIs for THIS worker only (always allowed by rules)
        await renderWorkerKPIs(workerId);

        // If admin, also show global KPIs
        const adminFlag = await isAdmin(auth.currentUser?.uid);
        renderLinks(role, adminFlag);
        if (adminFlag) await renderGlobalKPIs(); // adds more tiles at the end
      }catch(err){
        console.error(err);
        if (!$('#errorbar').textContent) showErrorBar('Failed to load dashboard. Check internet and Firebase settings.');
      }
    }

    async function renderWorkerKPIs(workerId){
      const grid = $('#kpiGrid');
      grid.innerHTML = '';

      const ymd = todayYMD();
      const yyyymmKey = yyyymm();
      const dayKey = ymd.replace(/-/g,'');

      // read only this worker's trees
      const [attSnap, tasksSnap, leavesSnap, penSnap] = await Promise.all([
        db.ref(`attendance/${workerId}/${yyyymmKey}`).once('value').catch(()=>null),
        db.ref(`tasks/${workerId}/${dayKey}`).once('value').catch(()=>null),
        db.ref(`leave_requests/${workerId}`).once('value').catch(()=>null),
        db.ref(`penalties_ledger/${workerId}/${yyyymmKey}`).once('value').catch(()=>null),
      ]);

      // Today check-in + late
      const todayRec = attSnap?.val()?.[dayKey] || null;
      const checkedIn = !!(todayRec && todayRec.checkInTs);
      const lateMin = Number(todayRec?.lateMinutes || 0);

      // Lates this month
      let latesMonth = 0;
      const monthObj = attSnap?.val() || {};
      Object.values(monthObj).forEach(rec=>{
        if (rec && Number(rec.lateMinutes||0) > 0) latesMonth += 1;
      });

      // Tasks today: pending / overdue
      let pending = 0, overdue = 0;
      const now = Date.now();
      const tasks = tasksSnap?.val() || {};
      Object.values(tasks).forEach(t=>{
        if (!t) return;
        const done = Number(t.completedTs||0) > 0;
        if (!done){
          pending += 1;
          if (Number(t.dueTs||0) && now > t.dueTs) overdue += 1;
        }
      });

      // Leaves today
      let myLeaveToday = 'None';
      const leaves = leavesSnap?.val() || {};
      Object.values(leaves).forEach(req=>{
        if (!req) return;
        if (req.status === 'approved' && ymd >= req.startYmd && ymd <= req.endYmd){
          myLeaveToday = (req.type||'leave').toUpperCase();
        }
      });

      // Penalties this month
      let penCount=0, penTotal=0;
      const pens = penSnap?.val() || {};
      Object.values(pens).forEach(entry=>{
        if (!entry) return;
        penCount += 1;
        penTotal += Number(entry.amountTZS||0);
      });

      const tiles = [
        {label:'Today | Leo (Check-in)', val: checkedIn ? (lateMin>0?`Late ${lateMin}m`:'Checked in') : (isAfter0720()?'Not in 07:20+':'Not yet'), cls: checkedIn?(lateMin>0?'warn':'ok'):'bad'},
        {label:'Month Lates | Spoti Mwezi', val: latesMonth, cls: latesMonth? 'warn':'ok'},
        {label:'Tasks Pending | Kazi Zinasubiri', val: pending, cls: pending? 'warn':'ok'},
        {label:'Overdue Tasks | Kazi Zimechelewa', val: overdue, cls: overdue? 'bad':'ok'},
        {label:'Leave Today | Likizo Leo', val: myLeaveToday, cls: myLeaveToday==='None'?'ok':'warn'},
        {label:'Penalties (TZS) | Makato', val: penTotal.toLocaleString('sw-TZ'), cls: penTotal? 'bad':'ok'}
      ];

      tiles.forEach(t=>{
        const div = document.createElement('div');
        div.className = `kpi ${t.cls||''}`;
        div.innerHTML = `<h3>${t.label}</h3><div class="val">${t.val ?? 0}</div>`;
        grid.appendChild(div);
      });
    }

    async function renderGlobalKPIs(){
      // These require wide reads; we only add them for admins
      const grid = $('#kpiGrid');

      const ymd = todayYMD();
      const monthKey = yyyymm();
      const dayKey = ymd.replace(/-/g,'');

      const [wSnap, sSnap, lSnap, aSnap] = await Promise.all([
        db.ref('workers').once('value').catch(()=>null),
        db.ref('students').once('value').catch(()=>null),
        db.ref('leave_requests').once('value').catch(()=>null),
        db.ref('attendance').once('value').catch(()=>null),
      ]);

      const workers = wSnap?.val() || {};
      const activeWorkers = Object.values(workers).filter(w => w?.profile?.active !== false).length;

      let totalStudents=0, totalBoys=0, totalGirls=0;
      const students = sSnap?.val() || {};
      Object.values(students).forEach(st=>{
        totalStudents += 1;
        if (st.gender === 'M') totalBoys += 1;
        if (st.gender === 'F') totalGirls += 1;
      });

      let sickToday = 0;
      const leaves = lSnap?.val() || {};
      Object.values(leaves).forEach(workerLeaves=>{
        Object.values(workerLeaves||{}).forEach(req=>{
          if (req?.type==='sick' && req?.status==='approved' && ymd >= req.startYmd && ymd <= req.endYmd) sickToday+=1;
        });
      });

      let checkedInToday = 0, lateToday = 0;
      const attendance = aSnap?.val() || {};
      Object.values(attendance).forEach(byMonth=>{
        const rec = byMonth?.[monthKey]?.[dayKey];
        if (rec?.checkInTs) checkedInToday += 1;
        if (Number(rec?.lateMinutes||0)>0) lateToday += 1;
      });

      const add = (label, val, cls='')=>{
        const div = document.createElement('div');
        div.className = `kpi ${cls}`;
        div.innerHTML = `<h3>${label}</h3><div class="val">${val}</div>`;
        grid.appendChild(div);
      };

      add('Active Workers | Wafanyakazi', activeWorkers, 'ok');
      add('Checked-in Today | Walioingia Leo', checkedInToday);
      add('Late Today | Wamechelewa Leo', lateToday, lateToday?'bad':'ok');
      if (isAfter0720()) add('Not Checked-in 07:20+ | Hawajaingia', Math.max(activeWorkers-checkedInToday,0), (activeWorkers-checkedInToday)?'warn':'ok');
      add('Students | Wanafunzi', totalStudents);
      add('Boys | Wavulana', totalBoys);
      add('Girls | Wasichana', totalGirls);
      add('Sick Today | Wagonjwa Leo', sickToday, sickToday?'warn':'ok');
    }

    function renderLinks(role, isAdmin){
      const grid = $('#linksGrid');
      grid.innerHTML = '';

      const cards = [
        {key:'attendance', roles:['all'], title:'Attendance | Mahudhurio', sub:'Check-in, GPS, photos', href:'workersattendance.html'},
        {key:'tasks', roles:['all'], title:'Tasks | Kazi', sub:'Assignments & 8h SLA', href:'workertasks.html'},
        {key:'leaves', roles:['all'], title:'Leave | Likizo', sub:'Omba na fuatilia', href:'workersleaves.html'},
        {key:'salary', roles:['all'], title:'Salary | Mshahara', sub:'Makato & payslip', href:'workerssalary.html'},
        {key:'contracts', roles:['all'], title:'Contract | Mkataba', sub:'Review & accept', href:'workerscontracts.html'},

        {key:'cook', roles:['cook'], title:'Kitchen | Bwalo', sub:'Menu, headcount, variances', href:'workerscooks.html'},
        {key:'guard', roles:['guard'], title:'Security | Ulinzi', sub:'Handover & assets', href:'workersmlinzi.html'},
        {key:'cleaner', roles:['cleaner'], title:'Cleaning | Usafi', sub:'Checklist & supplies', href:'workersmsafi.html'},
        {key:'store', roles:['storekeeper'], title:'Storekeeper | Ghala', sub:'Ledger & stock', href:'workersstorekeeper.html'},
        {key:'transport', roles:['driver'], title:'Transport | Usafiri', sub:'Safari & ratiba', href:'../transport.html'},

        {key:'admission', roles:['admin','hr','manager'], title:'Admission | Kuajiri', sub:'Register & docs', href:'workersadmission.html'},
        {key:'payroll', roles:['admin','hr','manager','accountant'], title:'Payroll | Malipo', sub:'NSSF, slips, finalize', href:'workerspayroll_admin.html'},
        {key:'nssf', roles:['admin','hr','accountant'], title:'NSSF | Michango', sub:'Rates & receipts', href:'workersnssf.html'},
        {key:'approvals', roles:['admin','hr','manager'], title:'Approvals | Uthibitisho', sub:'Flags & incidents', href:'workersapprovals_admin.html'},
        {key:'performance', roles:['admin','hr','manager'], title:'Performance | Utendaji', sub:'Ranking & best', href:'workersperformance.html'},
        {key:'ids', roles:['admin','hr','manager'], title:'Worker IDs | Vitambulisho', sub:'Generate & distribute', href:'workersgenerateid.html'}
      ];

      const allow = new Set(['all', role]);
      if (isAdmin) allow.add('admin');
      if (['hr','manager','accountant'].includes(role)) allow.add(role);

      cards
        .filter(c => c.roles.some(r => allow.has(r)))
        .forEach(c => {
          const tile = document.createElement('div');
          tile.className = 'link-tile';
          tile.innerHTML = `
            <h4>${c.title}</h4>
            <p>${c.sub}</p>
            <a class="btn alt" href="${c.href}">Open | Fungua</a>
          `;
          grid.appendChild(tile);
        });
    }

    loadDashboard();
  </script>
</body>
</html>
