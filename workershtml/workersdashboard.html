<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp · Workers Hub</title>

  <!-- Shared CSS -->
  <link rel="stylesheet" href="./css/workers.css">

  <!-- Firebase (compat v9.6.10) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>

  <style>
    /* =========================
       MODERN WORKERS DASHBOARD
       ========================= */
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --secondary: #7c3aed;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray: #64748b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--dark);
      line-height: 1.6;
    }

    .dashboard-container {
      min-height: 100vh;
      padding: 20px;
    }

    .dashboard-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .brand-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: var(--shadow);
    }

    .brand-info h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
    }

    .brand-info p {
      margin: 4px 0 0 0;
      color: var(--gray);
      font-size: 0.875rem;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.125rem;
      border: 3px solid white;
      box-shadow: var(--shadow);
    }

    .user-info {
      text-align: right;
    }

    .user-name {
      font-weight: 600;
      color: var(--dark);
      margin: 0;
    }

    .user-role {
      color: var(--gray);
      font-size: 0.875rem;
      margin: 2px 0 0 0;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--gray);
      color: white;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .dashboard-grid {
      display: grid;
      gap: 24px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .card-header {
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--dark);
      margin: 0 0 8px 0;
    }

    .card-subtitle {
      color: var(--gray);
      font-size: 0.875rem;
      margin: 0;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: var(--shadow);
    }

    .kpi-card.warning {
      background: linear-gradient(135deg, var(--warning), #d97706);
    }

    .kpi-card.danger {
      background: linear-gradient(135deg, var(--danger), #dc2626);
    }

    .kpi-card.success {
      background: linear-gradient(135deg, var(--success), #059669);
    }

    .kpi-label {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .kpi-value {
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
    }

    .role-card {
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.1));
      border: 3px solid var(--primary);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      min-height: 280px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .role-card.disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-color: #e2e8f0;
    }
    
    .role-card.enabled {
      cursor: pointer;
      transform: scale(1.02);
      box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.2);
    }
    
    .role-card.enabled:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 30px -5px rgba(0, 0, 0, 0.3);
    }
    
    .role-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .role-card:hover {
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(124, 58, 237, 0.2));
      transform: translateY(-2px);
      text-decoration: none;
      color: inherit;
    }

    .role-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .role-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--dark);
      margin: 0 0 8px 0;
    }

    .role-description {
      color: var(--gray);
      font-size: 0.875rem;
      margin: 0 0 16px 0;
    }

    .quick-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .link-card {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }

    .link-card:hover {
      background: rgba(255, 255, 255, 1);
      border-color: var(--primary);
      transform: translateY(-2px);
      text-decoration: none;
      color: inherit;
    }

    .link-icon {
      font-size: 2rem;
      margin-bottom: 12px;
      color: var(--primary);
    }

    .link-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--dark);
      margin: 0 0 8px 0;
    }

    .link-description {
      color: var(--gray);
      font-size: 0.875rem;
      margin: 0;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-active {
      background: #dcfce7;
      color: #166534;
    }

    .status-inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .toast {
      background: var(--dark);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 8px;
      box-shadow: var(--shadow-lg);
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
    }

    .loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .loading::after {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .dashboard-container {
        padding: 16px;
      }
      
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-section {
        align-self: flex-end;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .kpi-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- HEADER -->
    <div class="dashboard-header">
      <div class="header-content">
        <div class="brand-section">
          <div class="logo">So</div>
          <div class="brand-info">
            <h1>SoMAp · Workers Hub</h1>
            <p id="schoolClock">Africa/Nairobi</p>
          </div>
        </div>
          <div class="user-section">
            <div class="user-info">
              <div class="user-name" id="helloName">Loading...</div>
              <div class="user-role" id="roleChip">Role: -</div>
            </div>
            <div class="user-avatar" id="userAvatar">??</div>
          </div>
          <div class="action-buttons year-selector" style="display:flex;flex-direction:column;gap:4px;min-width:160px;">
            <label for="workersYearSelect" style="font-size:0.65rem;text-transform:uppercase;letter-spacing:0.18em;color:#4b5563;font-weight:600;">Academic Year</label>
            <select
              id="workersYearSelect"
              data-somap-year-select
              style="border-radius:8px;border:1px solid rgba(79,70,229,0.25);padding:0.45rem 0.6rem;font-weight:600;color:#4338ca;background:rgba(255,255,255,0.9);"
            >
            </select>
          </div>
          <div class="action-buttons">
            <button id="refreshBtn" class="btn btn-primary">?? Refresh</button>
            <button id="signOutBtn" class="btn btn-secondary">?? Sign Out</button>
          </div>
      </div>
    </div>

    <!-- SCHOOL STATISTICS -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">School Statistics · Takwimu za Shule</h2>
        <p class="card-subtitle">Current school overview and attendance</p>
      </div>
      <div class="kpi-grid" id="schoolStatsGrid">
        <div class="kpi-card success">
          <div class="kpi-label">Total Workers</div>
          <div class="kpi-value" id="totalWorkers">—</div>
        </div>
        <div class="kpi-card success">
          <div class="kpi-label">Total Students</div>
          <div class="kpi-value" id="totalStudents">—</div>
        </div>
        <div class="kpi-card success">
          <div class="kpi-label">Workers Present</div>
          <div class="kpi-value" id="workersPresent">—</div>
        </div>
        <div class="kpi-card success">
          <div class="kpi-label">Students Present</div>
          <div class="kpi-value" id="studentsPresent">—</div>
        </div>
        <div class="kpi-card warning">
          <div class="kpi-label">Workers Absent</div>
          <div class="kpi-value" id="workersAbsent">—</div>
        </div>
        <div class="kpi-card warning">
          <div class="kpi-label">Students Absent</div>
          <div class="kpi-value" id="studentsAbsent">—</div>
        </div>
      </div>
    </div>

    <!-- ROLE-SPECIFIC HUBS -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Work Hubs · Bwalo la Kazi</h2>
        <p class="card-subtitle">Access your specialized work area based on your role</p>
      </div>
      <div class="dashboard-grid" id="hubsGrid">
        <!-- Hub cards will be dynamically generated based on role -->
      </div>
    </div>

    <!-- PERSONAL KPIs -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Your Performance · Utendaji Wako</h2>
        <p class="card-subtitle">Today's status and monthly overview</p>
      </div>
      <div class="kpi-grid" id="selfKpis">
        <div class="kpi-card" id="kpiCheck">
          <div class="kpi-label">Today Check-in</div>
          <div class="kpi-value">—</div>
        </div>
        <div class="kpi-card" id="kpiLates">
          <div class="kpi-label">Month Lates</div>
          <div class="kpi-value">—</div>
        </div>
        <div class="kpi-card" id="kpiTasks">
          <div class="kpi-label">Pending Tasks</div>
          <div class="kpi-value">—</div>
        </div>
        <div class="kpi-card" id="kpiOverdue">
          <div class="kpi-label">Overdue Tasks</div>
          <div class="kpi-value">—</div>
        </div>
        <div class="kpi-card" id="kpiLeave">
          <div class="kpi-label">Leave Today</div>
          <div class="kpi-value">—</div>
        </div>
        <div class="kpi-card" id="kpiPenalties">
          <div class="kpi-label">Penalties (TZS)</div>
          <div class="kpi-value">—</div>
        </div>
      </div>
    </div>

    <!-- SCHOOL OVERVIEW -->
    <div class="card" id="schoolSnapshot">
      <div class="card-header">
        <h2 class="card-title">School Overview · Muhtasari wa Shule</h2>
        <p class="card-subtitle">Current school statistics</p>
      </div>
      <div class="kpi-grid" id="schoolKpiGrid"></div>
    </div>

    <!-- QUICK LINKS -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Quick Links · Njia za Haraka</h2>
        <p class="card-subtitle">Access your tools and features</p>
      </div>
      <div class="quick-links" id="linksGrid"></div>
    </div>
  </div>

  <!-- TOAST NOTIFICATIONS -->
  <div class="toast-container" id="toast"></div>

  <!-- ===== MODERN WORKERS DASHBOARD SCRIPT ===== -->
  <script type="module">
    // Prevent index.html auth listeners from interfering
    sessionStorage.setItem('workerDashboardActive', 'true');
    
    // Simple date helper functions (no external dependencies)
    function todayYMD() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    
    function yyyymm(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      return `${y}${m}`;
    }
    
    console.log('? Date helper functions loaded');

    /* ==============================
       CLOCK (Africa/Nairobi)
       ============================== */
    function tzParts(){
      const d = new Date();
      const optD={timeZone:'Africa/Nairobi',year:'numeric',month:'2-digit',day:'2-digit'};
      const optT={timeZone:'Africa/Nairobi',hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'};
      const [day,mon,yr]=new Intl.DateTimeFormat('en-GB',optD).format(d).split('/');
      const tim=new Intl.DateTimeFormat('en-GB',optT).format(d);
      return {yr,mon,day,tim};
    }
    function after0720(){ return tzParts().tim.slice(0,5) >= '07:20'; }
    setInterval(()=>{
      const p=tzParts();
      document.getElementById('schoolClock').textContent=`Africa/Nairobi · ${p.yr}-${p.mon}-${p.day} ${p.tim}`;
    },1000);

    /* ==============================
       FIREBASE HANDLES
       ============================== */
    const db = firebase.database();
    
    /* ==============================
       UI REFS
    ============================== */
    const greetEl   = document.getElementById('helloName');
    const roleChip  = document.getElementById('roleChip');
    const hubsGrid = document.getElementById('hubsGrid');
    const linksGrid = document.getElementById('linksGrid');
    const schoolKpi = document.getElementById('schoolKpiGrid');

    document.getElementById('refreshBtn').addEventListener('click', ()=> loadDashboard(true));
    document.getElementById('signOutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('workerId');
      localStorage.removeItem('role');
      localStorage.removeItem('fullNameUpper');
      location.href = '../index.html';
    });

    /* ==========================================================
       WORKER ID RESOLUTION (Compatible with index.html login)
       ========================================================== */
    async function getWorkerIdSafe(){
      // 1) Check localStorage first (set by index.html worker login)
      const wid = localStorage.getItem('workerId');
      if (wid) {
        console.log('? Worker ID found in localStorage:', wid);
        return wid;
      }

      // 2) If not in localStorage, user hasn't logged in via index.html
      console.log('? No worker ID in localStorage');
      return null;
    }

    /* ==============================
       MAIN LOADER
       ============================== */
    async function loadDashboard(){
      try{
        console.log('?? Starting dashboard load...');
        console.log('?? localStorage contents:', {
          workerId: localStorage.getItem('workerId'),
          role: localStorage.getItem('role'),
          fullNameUpper: localStorage.getItem('fullNameUpper')
        });

        const workerId = await getWorkerIdSafe();
        if (!workerId){
          console.error('? No workerId found in localStorage');
          showToast('Not signed in. Redirecting to login...', 'error');
          setTimeout(()=> location.href='../index.html', 3000);
          return;
        }

        console.log('?? Loading worker profile for ID:', workerId);
        console.log('?? Fetching from path: /workers/' + workerId);

        // Profile - use direct db reference instead of dbRefs helper
        const wSnap = await db.ref(`workers/${workerId}`).once('value').catch((err)=>{
          console.error('? Error fetching worker profile:', err);
          console.error('Error details:', err.message, err.code);
          return null;
        });
        
        console.log('?? Snapshot received:', {
          exists: wSnap?.exists(),
          hasVal: !!wSnap?.val(),
          keys: wSnap?.exists() ? Object.keys(wSnap.val() || {}) : []
        });

        if (!wSnap || !wSnap.exists()){
          console.error('? Worker profile not found for ID:', workerId);
          console.error('?? This usually means the workerId in localStorage doesn\'t match any record in /workers/');
          console.error('?? DEBUGGING INFO:');
          console.error('   - Check if this ID exists in Firebase: /workers/' + workerId);
          console.error('   - Check /workers_index_by_loginKey/ for your login hash');
          console.error('   - The workerId field in the index should match an actual worker ID');
          
          showToast('Worker profile not found. Check console for workerId: ' + workerId, 'error');
          
          // Show alert with the workerId for debugging
          alert(`DEBUGGING: Worker ID "${workerId}" not found in database.\n\nPlease check Firebase:\n1. Go to /workers/ and look for this ID\n2. If not found, check /workers_index_by_loginKey/\n3. Make sure the workerId field matches an actual worker ID`);
          return;
        }

        console.log('? Worker profile loaded successfully');

        const worker = wSnap.val()||{};
        const p = worker.profile||{};

        // Full name + avatar
        const fullNameUpper = p.fullNameUpper || [p.firstName,p.middleName,p.lastName].filter(Boolean).join(' ').toUpperCase() || '—';
        localStorage.setItem('fullNameUpper', fullNameUpper);
        greetEl.textContent = fullNameUpper;

        if (worker?.docs?.idPhotoUrl){
          document.getElementById('userAvatar').innerHTML =
            `<img src="${worker.docs.idPhotoUrl}" alt="ID" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>`;
        }else{
          const initials = (p.firstName||'?').slice(0,1) + (p.lastName||'?').slice(0,1);
          document.getElementById('userAvatar').textContent = initials.toUpperCase();
        }

        // Role detection (robust) - ENHANCED VERSION
        console.log('=== ROLE DETECTION DEBUG ===');
        console.log('Full worker object:', worker);
        console.log('Profile object:', p);
        console.log('Profile role field:', p.role);
        console.log('Worker role field:', worker.role);
        
        let role = '';
        
        // Try multiple ways to get the role
        if (p.role) {
          role = String(p.role).trim().toLowerCase();
          console.log('? Role found in profile.role:', role);
        } else if (worker.role) {
          role = String(worker.role).trim().toLowerCase();
          console.log('? Role found in worker.role:', role);
        } else if (p.jobTitle) {
          role = String(p.jobTitle).trim().toLowerCase();
          console.log('? Role found in profile.jobTitle:', role);
        } else if (p.position) {
          role = String(p.position).trim().toLowerCase();
          console.log('? Role found in profile.position:', role);
        } else {
          role = String(localStorage.getItem('role')||'').trim().toLowerCase();
          console.log('?? Using localStorage role:', role);
        }
        
        // If still no role, check if we can find it in the worker data structure
        if (!role) {
          console.log('?? Searching for role in worker data...');
          const workerStr = JSON.stringify(worker).toLowerCase();
          if (workerStr.includes('cook') || workerStr.includes('mpishi')) {
            role = 'cook';
            console.log('? Found "cook/mpishi" in worker data, setting role to cook');
          } else if (workerStr.includes('guard') || workerStr.includes('mlinzi')) {
            role = 'guard';
            console.log('? Found "guard/mlinzi" in worker data, setting role to guard');
          } else if (workerStr.includes('cleaner') || workerStr.includes('msafi')) {
            role = 'cleaner';
            console.log('? Found "cleaner/msafi" in worker data, setting role to cleaner');
          }
        }
        
        // Normalize Swahili role names to English (keep original for display)
        const roleNormalization = {
          'mpishi': 'cook',
          'mlinzi': 'guard',
          'msafi': 'cleaner',
          'dereva': 'driver'
        };
        
        const displayRole = role; // Keep for display
        if (roleNormalization[role]) {
          role = roleNormalization[role];
          console.log(`?? Normalized role from "${displayRole}" to "${role}"`);
        }
        
        // FINAL FALLBACK - No default, show all hubs as disabled if no role
        if (!role || role === 'undefined') {
          role = 'unknown';
          console.log('?? NO ROLE FOUND - User will see all hubs as disabled');
        }
        
        localStorage.setItem('role', role);
        roleChip.textContent = `Role: ${displayRole || role}`;
        console.log('?? FINAL ROLE SET TO:', role);

        // Status
        const active = (p.active!==false);

        // Render role-based hubs
        console.log('Calling renderRoleHubs with role:', role);
        renderRoleHubs(role);

        // Personal KPIs (reads only own trees -> allowed by rules)
        await renderSelfKpis(workerId);

        // Load school statistics
        await renderSchoolStatistics();
        
        // Best-effort global tiles (hide if locked by rules)
        await renderSchoolSnapshot();

        // Quick Links (role-aware) - admin detection based on role
        const admin = (role === 'admin' || role === 'hr' || role === 'manager');
        renderLinks(role, admin);

      }catch(err){
        console.error(err);
        showToast(err.message || 'Failed to load dashboard', 'error');
      }
    }

    /* ==============================
       TOAST NOTIFICATIONS
       ============================== */
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      
      const container = document.getElementById('toast');
      container.appendChild(toast);
      
      // Show toast
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Hide and remove toast
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    /* ==============================
       ROLE-BASED HUBS SYSTEM
    ============================== */
    function renderRoleHubs(role){
      console.log('?? renderRoleHubs called with role:', role);
      console.log('?? hubsGrid element:', document.getElementById('hubsGrid'));
      
      const hubMap = {
        cook:        { 
          title:'COOKS HUB · Bwalo la Wapishi',      
          sub:'Manage daily kitchen operations, food reports, and inventory',        
          href:'workerscooks.html',
          icon:'??',
          color:'#f59e0b',
          roles: ['cook', 'mpishi']
        },
        guard:       { 
          title:'MLINZI HUB · Bwalo la Walinzi',    
          sub:'Monitor security, handover procedures, and asset management',           
          href:'workersmlinzi.html',
          icon:'???',
          color:'#ef4444',
          roles: ['guard', 'mlinzi']
        },
        cleaner:     { 
          title:'MSAFI HUB · Bwalo la Wasafi',     
          sub:'Daily cleaning checklist and supply management',        
          href:'workersmsafi.html',
          icon:'??',
          color:'#10b981',
          roles: ['cleaner', 'msafi']
        },
        storekeeper: { 
          title:'STORE HUB · Bwalo la Ghala',  
          sub:'Inventory management and stock tracking',              
          href:'workersstorekeeper.html',
          icon:'??',
          color:'#8b5cf6',
          roles: ['storekeeper']
        },
        driver:      { 
          title:'TRANSPORT HUB · Bwalo la Usafiri',  
          sub:'Vehicle management and route planning',             
          href:'../transporthtml/transportdriver/transporthub.html',
          icon:'??',
          color:'#06b6d4',
          roles: ['driver']
        },
        teacher:     { 
          title:'TASKS HUB · Bwalo la Kazi',         
          sub:'Daily teaching tasks and assignments',                
          href:'workertasks.html',
          icon:'??',
          color:'#3b82f6',
          roles: ['teacher']
        },
        accountant:  { 
          title:'PAYROLL HUB · Bwalo la Malipo',     
          sub:'Salary processing and financial management',             
          href:'workerspayroll_admin.html',
          icon:'??',
          color:'#10b981',
          roles: ['accountant', 'admin', 'hr', 'manager']
        },
        manager:     { 
          title:'APPROVALS HUB · Bwalo la Uthibitisho', 
          sub:'Review and approve requests and incidents',       
          href:'workersapprovals_admin.html',
          icon:'?',
          color:'#f59e0b',
          roles: ['manager', 'admin', 'hr']
        },
        hr:          { 
          title:'ADMISSION HUB · Bwalo la Kuajiri',  
          sub:'Employee registration and documentation',             
          href:'workersadmission.html',
          icon:'??',
          color:'#8b5cf6',
          roles: ['hr', 'admin', 'manager']
        },
        academic:    { 
          title:'PERFORMANCE HUB · Bwalo la Utendaji', 
          sub:'Performance tracking and analytics',           
          href:'workersperformance.html',
          icon:'??',
          color:'#3b82f6',
          roles: ['academic', 'admin', 'hr', 'manager']
        },
        admin:       { 
          title:'ADMIN HUB · Bwalo la Msimamizi',    
          sub:'System administration and controls',                
          href:'workersapprovals_admin.html',
          icon:'??',
          color:'#6b7280',
          roles: ['admin']
        }
      };

      const hubsGrid = document.getElementById('hubsGrid');
      if (!hubsGrid) {
        console.error('? hubsGrid element not found!');
        return;
      }
      
      console.log('?? Clearing hubsGrid...');
      hubsGrid.innerHTML = '';
      
      console.log('?? Rendering hub cards for role:', role);
      // Show all hub cards but make only the user's role clickable
      Object.entries(hubMap).forEach(([key, hub]) => {
        console.log(`?? Processing hub: ${key} - ${hub.title}`);
        const hubCard = document.createElement('div');
        hubCard.className = 'role-card';
        
        // Check if user can access this hub
        const canAccess = hub.roles.includes(role);
        console.log(`?? Hub ${key}: canAccess=${canAccess}, userRole=${role}, hubRoles=${hub.roles.join(',')}`);
        
        if (canAccess) {
          console.log(`? User can access ${key} hub`);
          // User's role - make it clickable and highlighted
          hubCard.classList.add('enabled');
          hubCard.style.borderColor = hub.color;
          hubCard.style.background = `linear-gradient(135deg, ${hub.color}15, ${hub.color}25)`;
          
          hubCard.innerHTML = `
            <div class="role-icon" style="color: ${hub.color}; font-size: 4rem; margin-bottom: 20px;">${hub.icon}</div>
            <div class="role-title" style="font-size: 1.5rem; font-weight: 700; color: ${hub.color}; margin-bottom: 12px;">${hub.title}</div>
            <div class="role-description" style="font-size: 1rem; margin-bottom: 24px;">${hub.sub}</div>
            <a href="${hub.href}" class="btn btn-primary" style="background: ${hub.color}; padding: 12px 24px; font-size: 1rem; font-weight: 600;">
              ?? Open Hub · Fungua
            </a>
          `;
          
          hubCard.addEventListener('click', () => {
            window.location.href = hub.href;
          });
        } else {
          console.log(`?? User cannot access ${key} hub - showing as disabled`);
          // Other roles - show but disabled
          hubCard.classList.add('disabled');
          
          hubCard.innerHTML = `
            <div class="role-icon" style="color: #94a3b8; font-size: 4rem; margin-bottom: 20px;">${hub.icon}</div>
            <div class="role-title" style="font-size: 1.5rem; font-weight: 700; color: #64748b; margin-bottom: 12px;">${hub.title}</div>
            <div class="role-description" style="font-size: 1rem; margin-bottom: 24px; color: #94a3b8;">Access restricted to ${hub.roles.join(', ')} only</div>
            <div class="btn btn-secondary" style="background: #94a3b8; padding: 12px 24px; font-size: 1rem; font-weight: 600; cursor: not-allowed;">
              ?? Access Restricted
            </div>
          `;
        }
        
        console.log(`?? Appending ${key} hub card to grid`);
        hubsGrid.appendChild(hubCard);
      });
      
      console.log(`? Rendered ${Object.keys(hubMap).length} hub cards for role: ${role}`);
    }

    /* ==============================
       SCHOOL STATISTICS
    ============================== */
    async function renderSchoolStatistics(){
      try {
        console.log('?? Loading school statistics...');
        const ymd = todayYMD();
        const mm = yyyymm(new Date());
        const dayKey = ymd.replace(/-/g,'');

        console.log('?? Date info:', { ymd, mm, dayKey });

        const [workersSnap, studentsSnap, attendanceSnap, studentAttendanceSnap] = await Promise.all([
          db.ref('workers').once('value').catch(e => { console.error('Workers fetch error:', e); return null; }),
          db.ref('students').once('value').catch(e => { console.error('Students fetch error:', e); return null; }),
          db.ref('attendance').once('value').catch(e => { console.error('Attendance fetch error:', e); return null; }),
          db.ref(`attendance_students/${dayKey}`).once('value').catch(e => { console.error('Student attendance fetch error:', e); return null; })
        ]);

        console.log('?? Database snapshots:', {
          workers: workersSnap?.exists(),
          students: studentsSnap?.exists(),
          attendance: attendanceSnap?.exists(),
          studentAttendance: studentAttendanceSnap?.exists()
        });

        // Total workers
        const workers = workersSnap?.val() || {};
        const totalWorkers = Object.values(workers).filter(w => w?.profile?.active !== false).length;
        console.log('?? Total workers:', totalWorkers);
        document.getElementById('totalWorkers').textContent = totalWorkers;

        // Total students
        const students = studentsSnap?.val() || {};
        const totalStudents = Object.keys(students).length;
        console.log('?? Total students:', totalStudents);
        document.getElementById('totalStudents').textContent = totalStudents;

        // Workers present today
        let workersPresent = 0;
        let workersAbsent = 0;
        if (attendanceSnap?.exists()) {
          const attendance = attendanceSnap.val() || {};
          console.log('?? Attendance data structure:', Object.keys(attendance));
          Object.values(attendance).forEach(byMonth => {
            if (byMonth && typeof byMonth === 'object') {
              const rec = byMonth[mm]?.[dayKey];
              if (rec?.checkInTs) workersPresent++;
            }
          });
          workersAbsent = totalWorkers - workersPresent;
        }
        console.log('?? Workers present:', workersPresent, 'absent:', workersAbsent);
        document.getElementById('workersPresent').textContent = workersPresent;
        document.getElementById('workersAbsent').textContent = workersAbsent;

        // Students present today
        let studentsPresent = 0;
        let studentsAbsent = 0;
        if (studentAttendanceSnap?.exists()) {
          const studentAttendance = studentAttendanceSnap.val() || {};
          console.log('?? Student attendance data:', Object.keys(studentAttendance));
          Object.values(studentAttendance).forEach(classAttendance => {
            if (typeof classAttendance === 'object') {
              Object.values(classAttendance).forEach(record => {
                if (record?.present === true) studentsPresent++;
              });
            }
          });
          studentsAbsent = totalStudents - studentsPresent;
        }
        console.log('?? Students present:', studentsPresent, 'absent:', studentsAbsent);
        document.getElementById('studentsPresent').textContent = studentsPresent;
        document.getElementById('studentsAbsent').textContent = studentsAbsent;

        // Update card colors based on attendance
        const workersPresentEl = document.getElementById('workersPresent').parentElement;
        const workersAbsentEl = document.getElementById('workersAbsent').parentElement;
        const studentsPresentEl = document.getElementById('studentsPresent').parentElement;
        const studentsAbsentEl = document.getElementById('studentsAbsent').parentElement;

        workersPresentEl.className = `kpi-card ${workersPresent > 0 ? 'success' : 'danger'}`;
        workersAbsentEl.className = `kpi-card ${workersAbsent > 0 ? 'warning' : 'success'}`;
        studentsPresentEl.className = `kpi-card ${studentsPresent > 0 ? 'success' : 'danger'}`;
        studentsAbsentEl.className = `kpi-card ${studentsAbsent > 0 ? 'warning' : 'success'}`;

        console.log('? School statistics loaded successfully');

      } catch (error) {
        console.error('? Error loading school statistics:', error);
        showToast('Failed to load school statistics: ' + error.message, 'error');
        
        // Fallback: Show placeholder data
        console.log('?? Showing fallback data...');
        document.getElementById('totalWorkers').textContent = 'Loading...';
        document.getElementById('totalStudents').textContent = 'Loading...';
        document.getElementById('workersPresent').textContent = 'Loading...';
        document.getElementById('studentsPresent').textContent = 'Loading...';
        document.getElementById('workersAbsent').textContent = 'Loading...';
        document.getElementById('studentsAbsent').textContent = 'Loading...';
      }
    }

    /* ==============================
       PERSONAL KPIs (OWN TREES)
    ============================== */
    async function renderSelfKpis(workerId){
      const ymd = todayYMD(); const mm = yyyymm(new Date()); const dayKey = ymd.replace(/-/g,'');

      const [attSnap, taskSnap, leaveSnap, penSnap] = await Promise.all([
        db.ref(`attendance/${workerId}/${mm}`).once('value').catch(()=>null),
        db.ref(`tasks/${workerId}/${dayKey}`).once('value').catch(()=>null),
        db.ref(`leave_requests/${workerId}`).once('value').catch(()=>null),
        db.ref(`penalties_ledger/${workerId}/${mm}`).once('value').catch(()=>null),
      ]);

      const kpiCheck = document.getElementById('kpiCheck');
      const kpiLates = document.getElementById('kpiLates');
      const kpiTasks = document.getElementById('kpiTasks');
      const kpiOver  = document.getElementById('kpiOverdue');
      const kpiLeave = document.getElementById('kpiLeave');
      const kpiPens  = document.getElementById('kpiPenalties');

      // Check-in
      const rec = attSnap?.val()?.[dayKey] || null;
      const checked = !!(rec && rec.checkInTs);
      const lateMin = Number(rec?.lateMinutes||0);
      
      kpiCheck.className = 'kpi-card ' + (checked?(lateMin>0?'warning':'success'):'danger');
      kpiCheck.querySelector('.kpi-value').textContent = checked ? (lateMin>0?`Late ${lateMin}m`:'Checked in') : (after0720()?'Not in 07:20+':'Not yet');

      // Lates this month
      let lates=0; Object.values(attSnap?.val()||{}).forEach(v=>{ if (v && Number(v.lateMinutes||0)>0) lates++; });
      kpiLates.className = 'kpi-card ' + (lates?'warning':'success'); 
      kpiLates.querySelector('.kpi-value').textContent = lates;

      // Tasks today
      let pending=0, overdue=0, now=Date.now();
      Object.values(taskSnap?.val()||{}).forEach(t=>{
        if (!t) return; const done=Number(t.completedTs||0)>0;
        if (!done){ pending++; if (t.dueTs && now>t.dueTs) overdue++; }
      });
      kpiTasks.className = 'kpi-card ' + (pending?'warning':'success'); 
      kpiTasks.querySelector('.kpi-value').textContent = pending;
      kpiOver.className = 'kpi-card ' + (overdue?'danger':'success');   
      kpiOver.querySelector('.kpi-value').textContent = overdue;

      // Leave today
      let leaveToday='None';
      Object.values(leaveSnap?.val()||{}).forEach(req=>{
        if (req?.status==='approved' && ymd>=req.startYmd && ymd<=req.endYmd) leaveToday=(req.type||'leave').toUpperCase();
      });
      kpiLeave.className = 'kpi-card ' + (leaveToday==='None'?'success':'warning'); 
      kpiLeave.querySelector('.kpi-value').textContent = leaveToday;

      // Penalties
      let penTotal=0; Object.values(penSnap?.val()||{}).forEach(e=> penTotal+=Number(e?.amountTZS||0));
      kpiPens.className = 'kpi-card ' + (penTotal?'danger':'success'); 
      kpiPens.querySelector('.kpi-value').textContent = penTotal.toLocaleString('sw-TZ');
    }

    /* ==============================
       SCHOOL SNAPSHOT (BEST-EFFORT)
       ============================== */
    async function renderSchoolSnapshot(){
      schoolKpi.innerHTML='';
      const ymd = todayYMD(); const mm = yyyymm(new Date()); const dayKey = ymd.replace(/-/g,'');

      const [wSnap, sSnap, lSnap, aSnap] = await Promise.all([
        db.ref('workers').once('value').catch(()=>null),
        db.ref('students').once('value').catch(()=>null),
        db.ref('leave_requests').once('value').catch(()=>null),
        db.ref('attendance').once('value').catch(()=>null),
      ]);

      const add = (label,val,cls='')=>{
        if (val===null || val===undefined) return;
        const div=document.createElement('div');
        div.className=`kpi-card ${cls}`; 
        div.innerHTML=`<div class="kpi-label">${label}</div><div class="kpi-value">${val}</div>`;
        schoolKpi.appendChild(div);
      };

      if (wSnap && wSnap.exists()){
        const workers=wSnap.val()||{};
        const activeWorkers=Object.values(workers).filter(w=>w?.profile?.active!==false).length;
        add('Active Workers', activeWorkers, 'success');

        let checked=0, late=0;
        if (aSnap && aSnap.exists()){
          const attendance=aSnap.val()||{};
          Object.values(attendance).forEach(byMonth=>{
            const rec=byMonth?.[mm]?.[dayKey];
            if (rec?.checkInTs) checked++;
            if (Number(rec?.lateMinutes||0)>0) late++;
          });
          add('Checked-in Today', checked, 'success');
          add('Late Today', late, late?'warning':'success');
          if (after0720()) add('Not Checked-in 07:20+', Math.max(activeWorkers-checked,0), (activeWorkers-checked)?'danger':'success');
        }
      }

      if (sSnap && sSnap.exists()){
        const students=sSnap.val()||{};
        let total=0,boys=0,girls=0;
        Object.values(students).forEach(st=>{ total++; if (st?.gender==='M') boys++; if (st?.gender==='F') girls++; });
        add('Total Students', total, 'success');
        add('Boys', boys);
        add('Girls', girls);
      }

      if (lSnap && lSnap.exists()){
        let sickToday=0;
        Object.values(lSnap.val()||{}).forEach(wLeaves=>{
          Object.values(wLeaves||{}).forEach(req=>{
            if (req?.type==='sick' && req?.status==='approved' && ymd>=req.startYmd && ymd<=req.endYmd) sickToday++;
          });
        });
        add('Sick Today', sickToday, sickToday?'warning':'success');
      }
    }

    /* ==============================
       QUICK LINKS (ROLE-AWARE)
       ============================== */
    function renderLinks(role, admin){
      linksGrid.innerHTML='';
      const linkCards=[
        {key:'attendance',roles:['all'],title:'Attendance',sub:'Check-in, GPS, photos',href:'workersattendance.html',icon:'??'},
        {key:'tasks',roles:['all'],title:'Tasks',sub:'Assignments & SLA 8h',href:'workertasks.html',icon:'??'},
        {key:'leaves',roles:['all'],title:'Leave',sub:'Request and track leave',href:'workersleaves.html',icon:'???'},
        {key:'salary',roles:['all'],title:'Salary',sub:'View payslips and penalties',href:'workerssalary.html',icon:'??'},
        {key:'contracts',roles:['all'],title:'Contract',sub:'Review and accept contracts',href:'workerscontracts.html',icon:'??'},

        {key:'cook',roles:['cook','mpishi'],title:'Kitchen Hub',sub:'Daily kitchen operations',href:'workerscooks.html',icon:'??'},
        {key:'guard',roles:['guard','mlinzi'],title:'Security Hub',sub:'Security monitoring',href:'workersmlinzi.html',icon:'???'},
        {key:'cleaner',roles:['cleaner','msafi'],title:'Cleaning Hub',sub:'Cleaning checklist',href:'workersmsafi.html',icon:'??'},
        {key:'store',roles:['storekeeper'],title:'Store Hub',sub:'Inventory management',href:'workersstorekeeper.html',icon:'??'},
        {key:'driver',roles:['driver'],title:'Transport Hub',sub:'Vehicle management',href:'../transporthtml/transportdriver/transporthub.html',icon:'🚗'},

        {key:'admission',roles:['admin','hr','manager'],title:'Admission',sub:'Employee registration',href:'workersadmission.html',icon:'??'},
        {key:'payroll',roles:['admin','hr','manager','accountant'],title:'Payroll',sub:'Salary processing',href:'workerspayroll_admin.html',icon:'??'},
        {key:'nssf',roles:['admin','hr','accountant'],title:'NSSF',sub:'Social security',href:'workersnssf.html',icon:'???'},
        {key:'approvals',roles:['admin','hr','manager'],title:'Approvals',sub:'Review requests',href:'workersapprovals_admin.html',icon:'?'},
        {key:'performance',roles:['admin','hr','manager'],title:'Performance',sub:'Performance tracking',href:'workersperformance.html',icon:'??'},
        {key:'ids',roles:['admin','hr','manager'],title:'Worker IDs',sub:'Generate IDs',href:'workersgenerateid.html',icon:'??'}
      ];

      const allow=new Set(['all', role]);
      if (admin) allow.add('admin');
      if (['hr','manager','accountant'].includes(role)) allow.add(role);

      // Filter and order cards
      const ordered=[];
      linkCards.forEach(c=>{ if (c.roles.includes(role)) ordered.push(c); });
      linkCards.forEach(c=>{ if (c.roles.some(r=>allow.has(r)) && !ordered.find(x=>x.key===c.key)) ordered.push(c); });

      ordered.forEach(c=>{
        const linkCard = document.createElement('a');
        linkCard.className = 'link-card';
        linkCard.href = c.href;
        linkCard.innerHTML = `
          <div class="link-icon">${c.icon}</div>
          <div class="link-title">${c.title}</div>
          <div class="link-description">${c.sub}</div>
        `;
        linksGrid.appendChild(linkCard);
      });
    }

    /* ==============================
       BOOT
    ============================== */
    loadDashboard();
  </script>
</body>
</html>
