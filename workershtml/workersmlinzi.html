<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ulinzi - Handover</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase/firebase-config.js"></script>
</head>
<body>
  <main>
    <header>
      <h1>Ulinzi | Shift Handover</h1>
      <p class="workers-card__subtitle">
        Ingia na utoke kwa picha + GPS. Linganisha mali na baseline. Ukiwa na upungufu, rekodi tukio mara moja.
      </p>
    </header>

    <section class="workers-card">
      <header class="workers-card__header">
        <h2>Shift ya Leo</h2>
        <p id="handoverStatus" class="workers-card__subtitle"></p>
      </header>
      <div class="workers-card__content workers-form">
        <label>Aina ya shift
          <select id="shiftType">
            <option value="morning">Morning</option>
            <option value="evening">Evening</option>
            <option value="night">Night</option>
          </select>
        </label>
        <label>Picha ya Kuingia
          <input type="file" id="handoverInPhoto" accept="image/*" capture="environment">
        </label>
        <button id="handoverInBtn" class="workers-btn">Ingia (Check-In)</button>
        <label>Picha ya Kutoka
          <input type="file" id="handoverOutPhoto" accept="image/*" capture="environment">
        </label>
        <button id="handoverOutBtn" class="workers-btn secondary">Toka (Check-Out)</button>
      </div>
    </section>

    <section class="workers-card" style="margin-top:24px;">
      <header class="workers-card__header">
        <h2>Hesabu ya Mali</h2>
        <p class="workers-card__subtitle">Linganisha na baseline. Toa maelezo ukiona upungufu au ziada.</p>
      </header>
      <div class="workers-card__content">
        <table class="workers-table" id="assetTable">
          <thead>
            <tr>
              <th>Mali</th>
              <th>Baseline</th>
              <th>Leo</th>
              <th>Tofauti</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <label>Maelezo / Incidents
          <textarea id="incidentNotes" placeholder="Eleza tukio / upungufu..."></textarea>
        </label>
        <label>Picha ya Tukio (hiari)
          <input type="file" id="incidentPhoto" accept="image/*">
        </label>
        <button id="saveAssets" class="workers-btn danger">Hifadhi Hesabu</button>
      </div>
    </section>
  </main>

  <script type="module">
    import {
      ensureAnonymousAuth,
      getLinkedWorkerId,
      dbRefs,
      todayYMD,
      localTs,
      inGeofence,
      toast
    } from '../modules/workers_helpers.js';
    import { uploadFileToStorage } from '../modules/workers_ui.js';

    const shiftSelect = document.getElementById('shiftType');
    const handoverStatus = document.getElementById('handoverStatus');
    const inPhotoInput = document.getElementById('handoverInPhoto');
    const outPhotoInput = document.getElementById('handoverOutPhoto');
    const inBtn = document.getElementById('handoverInBtn');
    const outBtn = document.getElementById('handoverOutBtn');
    const assetTableBody = document.querySelector('#assetTable tbody');
    const incidentNotes = document.getElementById('incidentNotes');
    const incidentPhoto = document.getElementById('incidentPhoto');
    const saveAssetsBtn = document.getElementById('saveAssets');

    let assetsBaseline = {};
    let workerId = null;
    let workerProfile = null;
    let todayKey = todayYMD();
    let settings = null;
    let currentShiftId = null;
    let handoverData = null;

    ensureAnonymousAuth()
      .then(init)
      .catch(err => {
        toast(err.message || 'Error', 'error');
        window.location.href = '../index.html';
      });

    async function init() {
      workerId = await getLinkedWorkerId();
      if (!workerId) {
        toast('Ingia tena.', 'error');
        window.location.href = '../index.html';
        return;
      }
      const workerSnap = await dbRefs.worker(workerId).once('value');
      workerProfile = workerSnap.val().profile;
      if (workerProfile.role !== 'guard') {
        const adminSnap = await firebase.database().ref(`admins/${firebase.auth().currentUser.uid}`).once('value');
        if (!adminSnap.exists()) {
          toast('Ukurasa huu ni kwa walinzi tu.', 'error');
          window.location.href = '../index.html';
          return;
        }
      }
      settings = (await dbRefs.settings().once('value')).val() || {};
      assetsBaseline = await fetch('../modules/assets_baseline.json').then(res => res.json());
      renderAssetInputs();
      await loadHandover();
      inBtn.addEventListener('click', () => recordHandover('in'));
      outBtn.addEventListener('click', () => recordHandover('out'));
      saveAssetsBtn.addEventListener('click', saveAssets);
      shiftSelect.addEventListener('change', loadHandover);
    }

    function renderAssetInputs() {
      assetTableBody.innerHTML = '';
      Object.entries(assetsBaseline).forEach(([asset, baseline]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${asset}</td>
          <td>${baseline}</td>
          <td><input type="number" min="0" data-asset="${asset}" value="${baseline}"></td>
          <td class="variance">0</td>
        `;
        assetTableBody.appendChild(tr);
      });
      assetTableBody.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', updateVariance);
      });
    }

    function updateVariance(event) {
      const input = event.target;
      const asset = input.dataset.asset;
      const val = Number(input.value || 0);
      const baseline = assetsBaseline[asset] || 0;
      const diff = val - baseline;
      input.closest('tr').querySelector('.variance').textContent = diff;
    }

    async function loadHandover() {
      const shift = shiftSelect.value;
      currentShiftId = shift;
      const ref = dbRefs.rolesGuardHandover(todayKey).child(shift);
      const snap = await ref.once('value');
      if (!snap.exists()) {
        handoverData = null;
        handoverStatus.textContent = 'Hakuna rekodi bado.';
        renderAssetInputs();
        return;
      }
      handoverData = snap.val();
      handoverStatus.textContent = `Imesasishwa ${new Date(handoverData.updatedTs || localTs()).toLocaleTimeString('sw-TZ')}`;
      if (handoverData.counts) {
        assetTableBody.querySelectorAll('input').forEach(input => {
          const asset = input.dataset.asset;
          input.value = handoverData.counts[asset] ?? assetsBaseline[asset] ?? 0;
          updateVariance({ target: input });
        });
      }
      if (handoverData.diff) {
        assetTableBody.querySelectorAll('tr').forEach(tr => {
          const asset = tr.querySelector('input').dataset.asset;
          const varianceCell = tr.querySelector('.variance');
          if (handoverData.diff[asset] !== undefined) {
            varianceCell.textContent = handoverData.diff[asset];
          }
        });
      }
      incidentNotes.value = handoverData.incidentNote || '';
    }

    async function recordHandover(kind) {
      const photoInput = kind === 'in' ? inPhotoInput : outPhotoInput;
      if (!photoInput.files.length) {
        toast('Chagua au piga picha.', 'warning');
        return;
      }
      const geo = await getLocation();
      if (!geo) {
        toast('GPS inahitajika.', 'error');
        return;
      }
      const geofence = settings.geofence || {};
      if (!inGeofence(geo.lat, geo.lng, geofence, geofence.radius_m || 350)) {
        toast('Uko nje ya eneo la shule.', 'error');
        return;
      }
      const timestamp = localTs();
      const storagePath = `guard/${workerId}/${todayKey}-${currentShiftId}-${kind}-${Date.now()}.jpg`;
      const photoUrl = await uploadFileToStorage(photoInput.files[0], storagePath);
      const ref = dbRefs.rolesGuardHandover(todayKey).child(currentShiftId);
      await ref.child(kind === 'in' ? 'in' : 'out').set({
        guardUid: workerId,
        ts: timestamp,
        gps: [geo.lat, geo.lng],
        photoUrl
      });
      await ref.update({ updatedTs: timestamp });
      photoInput.value = '';
      toast(kind === 'in' ? 'Shift imeanza.' : 'Shift imekamilika.', 'success');
      loadHandover();
    }

    async function saveAssets() {
      const counts = {};
      let hasDiff = false;
      const diff = {};
      assetTableBody.querySelectorAll('input').forEach(input => {
        const asset = input.dataset.asset;
        const value = Number(input.value || 0);
        counts[asset] = value;
        const baseline = assetsBaseline[asset] || 0;
        const variance = value - baseline;
        diff[asset] = variance;
        if (variance !== 0) hasDiff = true;
      });

      const ref = dbRefs.rolesGuardHandover(todayKey).child(currentShiftId);
      const payload = {
        counts,
        diff,
        incidentNote: incidentNotes.value.trim(),
        status: hasDiff ? 'flagged' : 'ok',
        approverUid: '',
        updatedTs: localTs()
      };
      if (hasDiff) {
        await ref.child('incidents').push({
          type: 'asset',
          note: incidentNotes.value.trim() || 'Tofauti ya mali.',
          photoUrl: incidentPhoto.files[0]
            ? await uploadFileToStorage(incidentPhoto.files[0], `guard/${workerId}/${todayKey}-${currentShiftId}-incident-${Date.now()}.jpg`)
            : ''
        });
      }
      await ref.update(payload);
      toast('Hesabu imehifadhiwa.', hasDiff ? 'warning' : 'success');
      loadHandover();
    }

    function getLocation() {
      return new Promise(resolve => {
        if (!navigator.geolocation) {
          resolve(null);
          return;
        }
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          () => resolve(null),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });
    }
  </script>
</body>
</html>


